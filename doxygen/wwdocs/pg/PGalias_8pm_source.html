<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PG: PGalias.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>PGalias.pm</h1><a href="PGalias_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright Â© 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: pg/lib/PGalias.pm,v 1.6 2010/05/15 18:41:23 gage Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a><a class="code" href="classPGresource.html">00014</a> <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>PGresource;
<a name="l00018"></a>00018 use strict;
<a name="l00019"></a>00019 use Exporter;
<a name="l00020"></a>00020 use <a class="code" href="classPGcore.html">PGcore</a>;
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 sub <span class="keyword">new</span> {
<a name="l00023"></a>00023     my $class = shift;  
<a name="l00024"></a>00024     my $self = {
<a name="l00025"></a>00025         type        =&gt;  <span class="stringliteral">&#39;png&#39;</span>, # gif eps pdf html pg (macro: pl) (applets: java js fla geogebra (ggb) )
<a name="l00026"></a>00026         parent_file =&gt; <span class="stringliteral">&#39;&#39;</span>,  # file <span class="keywordtype">id</span> <span class="keywordflow">for</span> the file requesting the resource
<a name="l00027"></a>00027         <a class="code" href="classPGresource.html#a72bcc876405c6053eb03eaeee7111008">path</a>        =&gt;  { content =&gt; undef,       # file <a class="code" href="classPGresource.html#a72bcc876405c6053eb03eaeee7111008">path</a> to resource
<a name="l00028"></a>00028                           is_complete=&gt;0,
<a name="l00029"></a>00029                           is_accessible =&gt; 0,
<a name="l00030"></a>00030                         },
<a name="l00031"></a>00031         <a class="code" href="classPGresource.html#a01e0165ea55b5b98d7339274bfbc09be">uri</a>         =&gt;  { content =&gt; undef,       # usually url <a class="code" href="classPGresource.html#a72bcc876405c6053eb03eaeee7111008">path</a> to resource
<a name="l00032"></a>00032                           is_complete=&gt;0,
<a name="l00033"></a>00033                           is_accessible =&gt; 0,
<a name="l00034"></a>00034                         },
<a name="l00035"></a>00035         return_uri  =&gt;  <span class="stringliteral">&#39;&#39;</span>,
<a name="l00036"></a>00036         recorded_uri =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00037"></a>00037         convert      =&gt; { needed  =&gt; 0,
<a name="l00038"></a>00038                           from_type =&gt; undef,
<a name="l00039"></a>00039                           from_path =&gt; undef,
<a name="l00040"></a>00040                           to_type   =&gt; undef,
<a name="l00041"></a>00041                           to_path   =&gt; undef,
<a name="l00042"></a>00042                         },
<a name="l00043"></a>00043         copy_link   =&gt;  { type =&gt; undef,  # copy or link or orig (original file, no copy or link needed)
<a name="l00044"></a>00044                           link_to_path =&gt; undef,   # the <a class="code" href="classPGresource.html#a72bcc876405c6053eb03eaeee7111008">path</a> of the alias 
<a name="l00045"></a>00045                           copy_to_path =&gt; undef,   # the <a class="code" href="classPGresource.html#a72bcc876405c6053eb03eaeee7111008">path</a> of the duplicate file
<a name="l00046"></a>00046                         },
<a name="l00047"></a>00047         cache_info  =&gt;  {},
<a name="l00048"></a>00048         unique_id   =&gt;  undef, 
<a name="l00049"></a>00049     };
<a name="l00050"></a>00050     bless $self, $class;
<a name="l00051"></a>00051 <span class="preprocessor">    # $self-&gt;initialize;</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">    # $self-&gt;check_parameters;</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>    <span class="keywordflow">return</span> $self;
<a name="l00054"></a>00054 }
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 sub <a class="code" href="classPGresource.html#a01e0165ea55b5b98d7339274bfbc09be">uri</a> {
<a name="l00057"></a>00057     my $self = shift;
<a name="l00058"></a>00058     my $uri = shift;
<a name="l00059"></a>00059     $self-&gt;{<a class="code" href="classPGresource.html#a01e0165ea55b5b98d7339274bfbc09be">uri</a>}-&gt;{content}=$uri <span class="keywordflow">if</span> $uri;
<a name="l00060"></a>00060     $self-&gt;{uri}-&gt;{content};
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 sub path {
<a name="l00063"></a>00063     my $self = shift;
<a name="l00064"></a>00064     my $url = shift;
<a name="l00065"></a>00065     $self-&gt;{path}-&gt;{content}=$url <span class="keywordflow">if</span> $url;
<a name="l00066"></a>00066     $self-&gt;{path}-&gt;{content};
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 <span class="keyword">package </span>PGalias;
<a name="l00069"></a>00069 use strict;
<a name="l00070"></a>00070 use Exporter;
<a name="l00071"></a>00071 use UUID::Tiny  <span class="stringliteral">&#39;:std&#39;</span>;
<a name="l00072"></a>00072 use <a class="code" href="classPGcore.html">PGcore</a>;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 our @ISA =  qw ( <a class="code" href="classPGcore.html">PGcore</a>  );  # look up features in <a class="code" href="classPGcore.html">PGcore</a> -- in <span class="keyword">this</span> <span class="keywordflow">case</span> we want the environment.
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 =head2 
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="preprocessor"># new </span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#   Create one alias object per question (and per PGcore object)</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="preprocessor">#   Check that information is intact</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#   Construct unique id stub seeds -- the id stub seed is for this PGalias object which is </span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#        attached to all the resource files (except equations) for this question.</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span><span class="preprocessor">#   Keep list of external links</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span>
<a name="l00085"></a>00085 =cut
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 sub <span class="keyword">new</span> {
<a name="l00088"></a>00088     my $class = shift;  
<a name="l00089"></a>00089     my $envir = shift;  #pointer to environment hash
<a name="l00090"></a>00090     my %options = @_;
<a name="l00091"></a>00091     warn <span class="stringliteral">&quot;PGlias must be called with an environment&quot;</span> unless ref($envir) eq &#39;HASH&#39;;
<a name="l00092"></a>00092     my $self = {
<a name="l00093"></a>00093         envir       =&gt;  $envir,
<a name="l00094"></a>00094         search_list  =&gt;  [{url=&gt;<span class="stringliteral">&#39;foo&#39;</span>,dir=&gt;<span class="charliteral">&#39;.&#39;</span>}],   # <span class="keywordflow">for</span> subclasses -&gt; list of url/directories to search
<a name="l00095"></a>00095         resource_list =&gt; {},
<a name="l00096"></a>00096         %options,
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     };
<a name="l00099"></a>00099     bless $self, $class;
<a name="l00100"></a>00100     $self-&gt;initialize;
<a name="l00101"></a>00101     $self-&gt;check_parameters;
<a name="l00102"></a>00102     <span class="keywordflow">return</span> $self;
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 sub <a class="code" href="classPGalias.html#a082e2067f46ca5300f11384ce99a2f20">add_resource</a> {
<a name="l00107"></a>00107     my $self = shift;
<a name="l00108"></a>00108     my ($aux_file_id,$resource) =@_;
<a name="l00109"></a>00109     <span class="keywordflow">if</span> ( ref($resource) =~/<a class="code" href="classPGresource.html">PGresource</a>/ ) {
<a name="l00110"></a>00110         $self-&gt;{resource_list}-&gt;{$aux_file_id} = $resource;
<a name="l00111"></a>00111     } <span class="keywordflow">else</span> {
<a name="l00112"></a>00112         $self-&gt;warning_message(<span class="stringliteral">&quot;$aux_file_id does not refer to a a valid resource $resource&quot;</span>);
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 sub get_resource {
<a name="l00116"></a>00116     my $self = shift;
<a name="l00117"></a>00117     my $aux_file_id =shift;
<a name="l00118"></a>00118     $self-&gt;{resource_list}-&gt;{$aux_file_id};
<a name="l00119"></a>00119 }
<a name="l00120"></a>00120 <span class="preprocessor"># methods</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span><span class="preprocessor">#     make_alias   -- outputs url and does what needs to be done</span>
<a name="l00122"></a><a class="code" href="classPGalias.html">00122</a> <span class="preprocessor"></span><span class="preprocessor">#     normalize paths (remove extra precursors to the path)</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span><span class="preprocessor">#     search directories for item</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span><span class="preprocessor">#     make_links   -- in those cases where links need to be made</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="preprocessor">#     create_files  -- e.g. when printing hardcopy</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span><span class="preprocessor">#     dispatcher -- decides what needs to be done based on displayMode and file type</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span><span class="preprocessor">#     alias_for_html</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span><span class="preprocessor">#     alias_for_image_in_html   image includes gif, png, jpg, swf, svg, flv?? ogg??, js</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span><span class="preprocessor">#     alias_for_image_in_tex </span>
<a name="l00130"></a>00130 <span class="preprocessor"></span>
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 sub initialize {
<a name="l00133"></a>00133     my $self = shift;
<a name="l00134"></a>00134     my $envir = $self-&gt;{envir};
<a name="l00135"></a>00135 <span class="preprocessor">    # warn &quot;envir-- &quot;, join(&quot; &quot;, %$envir);</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span>    $self-&gt;{fileName}            = $envir-&gt;{probFileName};
<a name="l00137"></a>00137     $self-&gt;{htmlDirectory}       = $envir-&gt;{htmlDirectory};
<a name="l00138"></a>00138     $self-&gt;{htmlURL}             = $envir-&gt;{htmlURL};
<a name="l00139"></a>00139     $self-&gt;{tempDirectory}       = $envir-&gt;{tempDirectory};
<a name="l00140"></a>00140     $self-&gt;{templateDirectory}   = $envir-&gt;{templateDirectory};
<a name="l00141"></a>00141     $self-&gt;{tempURL}             = $envir-&gt;{tempURL};
<a name="l00142"></a>00142     $self-&gt;{studentLogin}        = $envir-&gt;{studentLogin};
<a name="l00143"></a>00143     $self-&gt;{psvn}                = $envir-&gt;{psvn};
<a name="l00144"></a>00144     $self-&gt;{setNumber}           = $envir-&gt;{setNumber};
<a name="l00145"></a>00145     $self-&gt;{probNum}             = $envir-&gt;{probNum};
<a name="l00146"></a>00146     $self-&gt;{displayMode}         = $envir-&gt;{displayMode};
<a name="l00147"></a>00147     $self-&gt;{externalGif2EpsPath} = $envir-&gt;{externalGif2EpsPath};
<a name="l00148"></a>00148     $self-&gt;{externalPng2EpsPath} = $envir-&gt;{externalPng2EpsPath};
<a name="l00149"></a>00149     $self-&gt;{courseID}            = $envir-&gt;{courseName};    
<a name="l00150"></a>00150     
<a name="l00151"></a>00151     $self-&gt;{appletPath} = $self-&gt;{envir}-&gt;{pgDirectories}-&gt;{appletPath};
<a name="l00152"></a>00152 <span class="preprocessor">    #</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span><span class="preprocessor">    #  Find auxiliary files even when the main file is in tempates/tmpEdit</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>    $self-&gt;{fileName} =~ s!(^|/)tmpEdit/!$1!;
<a name="l00156"></a>00156     
<a name="l00157"></a>00157     $self-&gt;{ext}      = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     my $uniqIDseed = join(<span class="stringliteral">&quot;-&quot;</span>,   
<a name="l00160"></a>00160                                $self-&gt;{studentLogin},
<a name="l00161"></a>00161                                $self-&gt;{psvn},
<a name="l00162"></a>00162                                $self-&gt;{courseID},
<a name="l00163"></a>00163                                <span class="stringliteral">&#39;set&#39;</span>.$self-&gt;{setNumber},
<a name="l00164"></a>00164                                <span class="stringliteral">&#39;prob&#39;</span>.$self-&gt;{probNum},
<a name="l00165"></a>00165     );
<a name="l00166"></a>00166 
<a name="l00167"></a>00167 <span class="preprocessor">##################################</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span><span class="preprocessor"># Cached vs. uncached uuid&#39;s -- or should the uuid be unique to each file/psvn/login, but always the same?</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span><span class="preprocessor"># If every uuid is uniqu then the same file will be linked to multiple times and it will be important</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span><span class="preprocessor"># to use asynchronous garbage cleanup to remove all links that won&#39;t be used again</span>
<a name="l00171"></a>00171 <span class="preprocessor"></span><span class="preprocessor"># If one tries to reuse links then one can get duplicates, for example if many files using the same name</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span><span class="preprocessor"># (prob3.pg) appear in a list of library problems. </span>
<a name="l00173"></a>00173 <span class="preprocessor"></span><span class="preprocessor">###################################</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span>
<a name="l00175"></a>00175 <span class="preprocessor">##########################</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span><span class="preprocessor"># create an ID which is unique to the student and context for the problem</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="preprocessor">##########################</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>    my $uniqIDstub = create_uuid_as_string(UUID_V3, UUID_NS_URL, $uniqIDseed);
<a name="l00179"></a>00179     $self-&gt;{uniqIDstub} = $uniqIDstub;         
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183 sub check_parameters {
<a name="l00184"></a>00184     my $self = shift;
<a name="l00185"></a>00185 
<a name="l00186"></a>00186 <span class="preprocessor">    # problem specific data</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>    warn <span class="stringliteral">&quot;The path to the current problem file template is not defined.&quot;</span>     unless $self-&gt;{fileName};
<a name="l00188"></a>00188     warn <span class="stringliteral">&quot;The current studentLogin is not defined &quot;</span>                          unless $self-&gt;{studentLogin};
<a name="l00189"></a>00189     warn <span class="stringliteral">&quot;The current problem set number is not defined&quot;</span>                     <span class="keywordflow">if</span> $self-&gt;{setNumber} eq <span class="stringliteral">&quot;&quot;</span>; # allow <span class="keywordflow">for</span> sets equal to 0
<a name="l00190"></a>00190     warn <span class="stringliteral">&quot;The current problem number is not defined&quot;</span>                         <span class="keywordflow">if</span> $self-&gt;{probNum} eq <span class="stringliteral">&quot;&quot;</span>;
<a name="l00191"></a>00191     warn <span class="stringliteral">&quot;The current problem set version number (psvn) is not defined&quot;</span>      unless defined($self-&gt;{psvn});
<a name="l00192"></a>00192     warn <span class="stringliteral">&quot;The displayMode is not defined&quot;</span>                                    unless $self-&gt;{displayMode};
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 <span class="preprocessor">    # required macros</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The macro &amp;surePathToTmpFile can&#39;t be found&quot;                    unless defined(&amp;{$self-&gt;surePathToTmpFile()} );</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The macro &amp;convertPath can&#39;t be found&quot;                          unless defined(&amp;{$self-&gt;convertPath()});</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The macro &amp;directoryFromPath can&#39;t be found&quot;                    unless defined(&amp;{$self-&gt;directoryFromPath()});</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span><span class="preprocessor">#    warn $self-&gt;surePathToTmpFile(&quot;foo&quot;);</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span><span class="preprocessor">    # warn &quot;The webwork server does not have permission to execute the gif2eps script at  ${externalGif2EpsPath}.&quot; unless ( -x &quot;${externalGif2EpsPath}&quot; );</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span><span class="preprocessor">    # warn &quot;The webwork server does not have permission to execute the png2eps script at ${externalPng2EpsPath}.&quot; unless ( -x &quot;${externalPng2EpsPath}&quot; );</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>
<a name="l00202"></a>00202 <span class="preprocessor">    # required directory addresses (and URL address)</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>    warn <span class="stringliteral">&quot;htmlDirectory is not defined.&quot;</span> unless $self-&gt;{htmlDirectory};
<a name="l00204"></a>00204     warn <span class="stringliteral">&quot;htmlURL is not defined.&quot;</span> unless $self-&gt;{htmlURL};
<a name="l00205"></a>00205     warn <span class="stringliteral">&quot;tempURL is not defined.&quot;</span> unless $self-&gt;{tempURL};
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 sub make_alias {
<a name="l00209"></a>00209     my $self = shift;       
<a name="l00210"></a>00210 <span class="preprocessor">    # input is a path to the original auxiliary file</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span>    my $aux_file_id = shift @_;
<a name="l00212"></a>00212 <span class="preprocessor">    # warn &quot;aux_file_id = $aux_file_id&quot;;</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span>
<a name="l00214"></a>00214     $self-&gt;warning_message( <span class="stringliteral">&quot;Empty string used as input into the function alias&quot;</span>) unless $aux_file_id;
<a name="l00215"></a>00215     
<a name="l00216"></a>00216     my $envir               = $self-&gt;{envir}; 
<a name="l00217"></a>00217     my $displayMode         = $self-&gt;{displayMode}; 
<a name="l00218"></a>00218     my $fileName            = $self-&gt;{fileName};    # name of .pg file
<a name="l00219"></a>00219     my $envir               = $self-&gt;{envir};
<a name="l00220"></a>00220     my $htmlDirectory       = $self-&gt;{htmlDirectory};
<a name="l00221"></a>00221     my $htmlURL             = $self-&gt;{htmlURL};
<a name="l00222"></a>00222     my $tempDirectory       = $self-&gt;{tempDirectory};
<a name="l00223"></a>00223     my $tempURL             = $self-&gt;{tempURL};
<a name="l00224"></a>00224     my $studentLogin        = $self-&gt;{studentLogin};
<a name="l00225"></a>00225     my $psvn                = $self-&gt;{psvn};
<a name="l00226"></a>00226     my $setNumber           = $self-&gt;{setNumber};
<a name="l00227"></a>00227     my $probNum             = $self-&gt;{probNum};
<a name="l00228"></a>00228     my $externalGif2EpsPath = $self-&gt;{externalGif2EpsPath};
<a name="l00229"></a>00229     my $externalPng2EpsPath = $self-&gt;{externalPng2EpsPath}; 
<a name="l00230"></a>00230     my $templateDirectory   = $self-&gt;{templateDirectory};
<a name="l00231"></a>00231     
<a name="l00232"></a>00232 <span class="preprocessor">    # $adr_output is a url in HTML and Latex2HTML modes</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span><span class="preprocessor">    # and a complete path in TEX mode.</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span>    my $adr_output;
<a name="l00235"></a>00235     my $ext;
<a name="l00236"></a>00236     
<a name="l00237"></a>00237 <span class="preprocessor">####################################################################### </span>
<a name="l00238"></a>00238 <span class="preprocessor"></span><span class="preprocessor">    # determine file type</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span><span class="preprocessor">    # determine display mode</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span><span class="preprocessor">    # dispatch  </span>
<a name="l00241"></a>00241 <span class="preprocessor"></span><span class="preprocessor">#######################################################################</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span><span class="preprocessor">    # determine extension, if there is one</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span><span class="preprocessor">    # if extension exists, strip and use the value for $ext</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span><span class="preprocessor">    # files without extensions are considered to be picture files:</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span>
<a name="l00246"></a>00246 
<a name="l00247"></a>00247     <span class="keywordflow">if</span> ($aux_file_id =~ s/\.([^\.]*)$<span class="comment">// ) {</span>
<a name="l00248"></a>00248         $ext = $1;
<a name="l00249"></a>00249     } <span class="keywordflow">else</span> {
<a name="l00250"></a>00250         $self-&gt;warning_message( <span class="stringliteral">&quot;This file name $aux_file_id did not have an extension.&lt;BR&gt; &quot;</span> .
<a name="l00251"></a>00251              <span class="stringliteral">&quot;Every file name used as an argument to alias must have an extension.&lt;BR&gt; &quot;</span> .
<a name="l00252"></a>00252              <span class="stringliteral">&quot;The permissable extensions are .gif, .png, and .html .&lt;BR&gt;&quot;</span>);
<a name="l00253"></a>00253         $ext  = <span class="stringliteral">&quot;gif&quot;</span>;
<a name="l00254"></a>00254         <span class="keywordflow">return</span> undef;
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="preprocessor">    # in order to facilitate maintenance of this macro the routines for handling</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="preprocessor">    # different file types are defined separately.  This involves some redundancy</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span><span class="preprocessor">    # in the code but it makes it easier to define special handling for a new file</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span><span class="preprocessor">    # type, (but harder to change the behavior for all of the file types at once</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span><span class="preprocessor">    # (sigh)  ).</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span>    
<a name="l00264"></a>00264 <span class="preprocessor">    ###################################################################</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor">    # This section checks to see if a resource has already been made (in this problem) for </span>
<a name="l00266"></a>00266 <span class="preprocessor"></span><span class="preprocessor">    # this particular aux_file_id.</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span><span class="preprocessor">    # If so, we simply return the appropriate uri for the file.</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span><span class="preprocessor">    # The displayMode will be the same throughout the processing of the .pg file</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span><span class="preprocessor">    # This effectively cache&#39;s auxiliary files within a single PG question.</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">    ###################################################################</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span>    unless ( defined $self-&gt;get_resource($aux_file_id) ) {
<a name="l00272"></a>00272         $self-&gt;add_resource($aux_file_id, <a class="code" href="classPGresource.html">PGresource</a>-&gt;new());
<a name="l00273"></a>00273 <span class="preprocessor">        #warn &quot;adding new resource_object $aux_file_id&quot;;</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
<a name="l00275"></a>00275 <span class="preprocessor">        #warn &quot;found existing resource_object $aux_file_id&quot;;</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span>        <span class="keywordflow">return</span> $self-&gt;get_resource($aux_file_id)-&gt;uri() ; 
<a name="l00277"></a>00277     }
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 <span class="preprocessor">    #warn &quot;next line\n\n&quot;;</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span><span class="preprocessor">    #warn &quot;resource list contains &quot;, %{ $self-&gt;{resource_list} };</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="preprocessor">    ###################################################################</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span>    
<a name="l00283"></a>00283     <span class="keywordflow">if</span> ($ext eq <span class="stringliteral">&#39;html&#39;</span>) {
<a name="l00284"></a>00284        $adr_output = $self-&gt;alias_for_html($aux_file_id)
<a name="l00285"></a>00285     } elsif ($ext eq <span class="stringliteral">&#39;gif&#39;</span>) {
<a name="l00286"></a>00286         <span class="keywordflow">if</span> ( $displayMode eq <span class="stringliteral">&#39;HTML_MathJax&#39;</span>||
<a name="l00287"></a>00287              $displayMode eq <span class="stringliteral">&#39;HTML_dpng&#39;</span>||
<a name="l00288"></a>00288              $displayMode eq <span class="stringliteral">&#39;HTML&#39;</span> ||
<a name="l00289"></a>00289              $displayMode eq <span class="stringliteral">&#39;HTML_tth&#39;</span>||
<a name="l00290"></a>00290              $displayMode eq <span class="stringliteral">&#39;HTML_asciimath&#39;</span>||
<a name="l00291"></a>00291              $displayMode eq <span class="stringliteral">&#39;HTML_LaTeXMathML&#39;</span>||
<a name="l00292"></a>00292              $displayMode eq <span class="stringliteral">&#39;HTML_jsMath&#39;</span>||
<a name="l00293"></a>00293              $displayMode eq <span class="stringliteral">&#39;HTML_img&#39;</span>) {
<a name="l00294"></a>00294 <span class="preprocessor">            ################################################################################</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span><span class="preprocessor">            # .gif FILES in HTML; HTML_tth; HTML_dpng; HTML_img; and Latex2HTML modes</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span><span class="preprocessor">            ################################################################################</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>            $adr_output=$self-&gt;alias_for_gif_in_html_mode($aux_file_id);
<a name="l00298"></a>00298         
<a name="l00299"></a>00299         } elsif ($displayMode eq <span class="stringliteral">&#39;TeX&#39;</span>) {
<a name="l00300"></a>00300 <span class="preprocessor">            ################################################################################</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span><span class="preprocessor">            # .gif FILES in TeX mode</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span><span class="preprocessor">            ################################################################################</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span>            $adr_output=$self-&gt;alias_for_gif_in_tex_mode($aux_file_id);
<a name="l00304"></a>00304         
<a name="l00305"></a>00305         } <span class="keywordflow">else</span> {
<a name="l00306"></a>00306             die <span class="stringliteral">&quot;Error in alias: dangerousMacros.pl: unrecognizable displayMode = $displayMode&quot;</span>;
<a name="l00307"></a>00307         }
<a name="l00308"></a>00308     } elsif ($ext eq <span class="stringliteral">&#39;png&#39;</span>) {
<a name="l00309"></a>00309         <span class="keywordflow">if</span> ( $displayMode eq <span class="stringliteral">&#39;HTML_MathJax&#39;</span>||
<a name="l00310"></a>00310              $displayMode eq <span class="stringliteral">&#39;HTML_dpng&#39;</span>||
<a name="l00311"></a>00311              $displayMode eq <span class="stringliteral">&#39;HTML&#39;</span> ||
<a name="l00312"></a>00312              $displayMode eq <span class="stringliteral">&#39;HTML_tth&#39;</span>||
<a name="l00313"></a>00313              $displayMode eq <span class="stringliteral">&#39;HTML_asciimath&#39;</span>||
<a name="l00314"></a>00314              $displayMode eq <span class="stringliteral">&#39;HTML_LaTeXMathML&#39;</span>||
<a name="l00315"></a>00315              $displayMode eq <span class="stringliteral">&#39;HTML_jsMath&#39;</span>||
<a name="l00316"></a>00316              $displayMode eq <span class="stringliteral">&#39;HTML_img&#39;</span> )  {
<a name="l00317"></a>00317             $adr_output = $self-&gt;alias_for_png_in_html_mode($aux_file_id);
<a name="l00318"></a>00318         } elsif ($displayMode eq <span class="stringliteral">&#39;TeX&#39;</span>) {
<a name="l00319"></a>00319             $adr_output = $self-&gt;alias_for_png_in_tex_mode($aux_file_id);
<a name="l00320"></a>00320         
<a name="l00321"></a>00321         } <span class="keywordflow">else</span> {
<a name="l00322"></a>00322             warn  <span class="stringliteral">&quot;Error in alias: dangerousMacros.pl&quot;</span>,<span class="stringliteral">&quot;unrecognizable displayMode = $displayMode&quot;</span>,<span class="stringliteral">&quot;&quot;</span>;
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324     } <span class="keywordflow">else</span> { # $ext is not recognized
<a name="l00325"></a>00325 <span class="preprocessor">        ################################################################################</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span><span class="preprocessor">        # FILES  with unrecognized file extensions in any display modes</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span><span class="preprocessor">        ################################################################################</span>
<a name="l00328"></a>00328 <span class="preprocessor"></span>
<a name="l00329"></a>00329         warn <span class="stringliteral">&quot;Error in the macro alias. Alias does not understand how to process files with extension $ext.  (Path ot problem file is  $fileName) &quot;</span>;
<a name="l00330"></a>00330     }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     warn <span class="stringliteral">&quot;The macro alias was unable to form a URL for some auxiliary file used in this problem.&quot;</span> unless $adr_output;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="preprocessor">    # $adr_output is a url in HTML  modes</span>
<a name="l00335"></a>00335 <span class="preprocessor"></span><span class="preprocessor">    # and a complete path in TEX mode.</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span>    <span class="keywordflow">return</span> $adr_output;
<a name="l00337"></a>00337 }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 
<a name="l00341"></a>00341 sub alias_for_html {
<a name="l00342"></a>00342     my $self = shift;
<a name="l00343"></a>00343     my $aux_file_id = shift;
<a name="l00344"></a>00344     
<a name="l00345"></a>00345 <span class="preprocessor">    #######################</span>
<a name="l00346"></a>00346 <span class="preprocessor"></span><span class="preprocessor">    #   gather needed data  </span>
<a name="l00347"></a>00347 <span class="preprocessor"></span><span class="preprocessor">    #######################</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span>    my $envir               = $self-&gt;{envir}; 
<a name="l00349"></a>00349     my $fileName            = $self-&gt;{fileName};  #FIXME: <span class="keyword">this</span> is really filePath to <a class="code" href="classWeBWorK_1_1PG.html">PG</a> problem ??rename to filePath
<a name="l00350"></a>00350     my $htmlDirectory       = $self-&gt;{htmlDirectory};
<a name="l00351"></a>00351     my $htmlURL             = $self-&gt;{htmlURL};
<a name="l00352"></a>00352     my $tempDirectory       = $self-&gt;{tempDirectory};
<a name="l00353"></a>00353     my $tempURL             = $self-&gt;{tempURL};
<a name="l00354"></a>00354     my $studentLogin        = $self-&gt;{studentLogin};
<a name="l00355"></a>00355     my $psvn                = $self-&gt;{psvn};
<a name="l00356"></a>00356     my $setNumber           = $self-&gt;{setNumber};
<a name="l00357"></a>00357     my $probNum             = $self-&gt;{probNum};
<a name="l00358"></a>00358     my $displayMode         = $self-&gt;{displayMode};
<a name="l00359"></a>00359     my $externalGif2EpsPath = $self-&gt;{externalGif2EpsPath};
<a name="l00360"></a>00360     my $externalPng2EpsPath = $self-&gt;{externalPng2EpsPath};     
<a name="l00361"></a>00361     my $templateDirectory   = $self-&gt;{templateDirectory};
<a name="l00362"></a>00362 
<a name="l00363"></a>00363 <span class="preprocessor">    #######################</span>
<a name="l00364"></a>00364 <span class="preprocessor"></span><span class="preprocessor">    # update resource object</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span>    my $resource_object = $self-&gt;get_resource($aux_file_id);
<a name="l00366"></a>00366 <span class="preprocessor">    # $self-&gt;warning_message( &quot;\nresource for $aux_file_id is &quot;, ref($resource_object), $resource_object );</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span>    $resource_object-&gt;{type}=<span class="stringliteral">&#39;html&#39;</span>;
<a name="l00368"></a>00368     $resource_object-&gt;{parent_file}=$fileName;
<a name="l00369"></a>00369     
<a name="l00370"></a>00370    
<a name="l00371"></a>00371 <span class="preprocessor">    # $resource_uri is a url in HTML  modes</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span><span class="preprocessor">    # and a complete path in TEX mode.</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span>    
<a name="l00374"></a>00374 <span class="preprocessor">    # Find a complete path to the auxiliary file by searching for it in the appropriate</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span><span class="preprocessor">    # libraries.  </span>
<a name="l00376"></a>00376 <span class="preprocessor"></span><span class="preprocessor">    # Store the result in auxiliary_uri</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span>
<a name="l00378"></a>00378 <span class="preprocessor">##############################################</span>
<a name="l00379"></a>00379 <span class="preprocessor"></span><span class="preprocessor"># Find complete path to the original files</span>
<a name="l00380"></a>00380 <span class="preprocessor"></span><span class="preprocessor">##############################################</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>    my ($resource_uri, $htmlFileSource, );
<a name="l00382"></a>00382     my $ext   =   <span class="stringliteral">&quot;html&quot;</span>;
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 <span class="preprocessor"># not yet completely implemented</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span><span class="preprocessor"># current implementation accepts only the course html directory, the file containing the .pg file </span>
<a name="l00386"></a>00386 <span class="preprocessor"></span><span class="preprocessor"># and the temp directory as places to look for html files</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span>
<a name="l00388"></a>00388 <span class="preprocessor"># No additional action is needed for auxiliary files in the</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span><span class="preprocessor"># ${Global::htmlDirectory} subtree.</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $aux_file_id =~ m|^$tempDirectory| ) {
<a name="l00391"></a>00391         $resource_uri = $aux_file_id,
<a name="l00392"></a>00392         $htmlFileSource = $aux_file_id;
<a name="l00393"></a>00393         $resource_uri =~ s|$tempDirectory|$tempURL/|,
<a name="l00394"></a>00394         $resource_uri .= <span class="stringliteral">&quot;.$ext&quot;</span>,
<a name="l00395"></a>00395         $resource_object-&gt;path($htmlFileSource);
<a name="l00396"></a>00396         $resource_object-&gt;uri($resource_uri);
<a name="l00397"></a>00397         $resource_object-&gt;{copy_link}-&gt;{type} = <span class="stringliteral">&#39;orig&#39;</span>;
<a name="l00398"></a>00398         $resource_object-&gt;{path}-&gt;{is_complete}=1;
<a name="l00399"></a>00399     } elsif ($aux_file_id =~ m|^$htmlDirectory| ) {
<a name="l00400"></a>00400         $resource_uri = $aux_file_id,
<a name="l00401"></a>00401         $htmlFileSource = $aux_file_id;
<a name="l00402"></a>00402         $resource_uri =~ s|$htmlDirectory|$htmlURL|,
<a name="l00403"></a>00403         $resource_uri .= <span class="stringliteral">&quot;.$ext&quot;</span>,
<a name="l00404"></a>00404         $resource_object-&gt;path($htmlFileSource);
<a name="l00405"></a>00405         $resource_object-&gt;uri($resource_uri);
<a name="l00406"></a>00406         $resource_object-&gt;{copy_link}-&gt;{type} = <span class="stringliteral">&#39;orig&#39;</span>;
<a name="l00407"></a>00407         $resource_object-&gt;{path}-&gt;{is_complete}=1;
<a name="l00408"></a>00408     } <span class="keywordflow">else</span> {
<a name="l00409"></a>00409 <span class="preprocessor">        # HTML files not in the htmlDirectory are assumed under live under the</span>
<a name="l00410"></a>00410 <span class="preprocessor"></span><span class="preprocessor">        # templateDirectory in the same directory as the problem.</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span><span class="preprocessor">        # Create an alias file (link) in the directory html/tmp/html which</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span><span class="preprocessor">        # points to the original file and return the URL of this alias.</span>
<a name="l00413"></a>00413 <span class="preprocessor"></span><span class="preprocessor">        # ---  Create all of the subdirectories of html/tmp/html which are needed</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span><span class="preprocessor">        # --- using sure file to path.  This gives too much information away.</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span><span class="preprocessor">        # use a uniquID instead.</span>
<a name="l00416"></a>00416 <span class="preprocessor"></span>    
<a name="l00417"></a>00417 <span class="preprocessor">        # $fileName is obtained from environment and</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span><span class="preprocessor">        # is the path to the .pg file</span>
<a name="l00419"></a>00419 <span class="preprocessor"></span><span class="preprocessor">        # it gives the  relative path to the current PG problem from the template directory</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span>        my $directoryPath = $self-&gt;directoryFromPath($fileName);
<a name="l00421"></a>00421         $htmlFileSource = $self-&gt;convertPath(<span class="stringliteral">&quot;$templateDirectory${directoryPath}$aux_file_id.html&quot;</span>);
<a name="l00422"></a>00422         $htmlFileSource = <span class="stringliteral">&quot;$templateDirectory${directoryPath}$aux_file_id.html&quot;</span>;
<a name="l00423"></a>00423         $resource_object-&gt;path($htmlFileSource);
<a name="l00424"></a>00424         $resource_object-&gt;{copy_link}-&gt;{type} = <span class="stringliteral">&#39;link&#39;</span>;
<a name="l00425"></a>00425         $resource_object-&gt;{path}-&gt;{is_complete}=1;
<a name="l00426"></a>00426 <span class="preprocessor">        # notice the resource uri is not yet defined -- we have to make the link first</span>
<a name="l00427"></a>00427 <span class="preprocessor"></span>    }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 <span class="preprocessor"># Create a unique id which depends on the parent fileName and path to the resource file</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span><span class="preprocessor"># The uniqueID  also depends on the student, the course name and  the psvn through the uniqeID stub, because </span>
<a name="l00431"></a>00431 <span class="preprocessor"></span><span class="preprocessor"># if the problem is recreated the specific file linked to might change.</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span><span class="preprocessor"># You  also want students linked to the same file to NOT be aware of that fact.</span>
<a name="l00433"></a>00433 <span class="preprocessor"></span>
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     my $uniqIDseed = $resource_object-&gt;path() . $resource_object-&gt;{parent_file}.$self-&gt;{psvn};
<a name="l00436"></a>00436     $resource_object-&gt;{uniqID} = $self-&gt;{uniqIDstub} .
<a name="l00437"></a>00437           <span class="stringliteral">&#39;___&#39;</span>. create_uuid_as_string( UUID_V3, UUID_NS_URL, $uniqIDseed );
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 <span class="preprocessor">##############################################</span>
<a name="l00441"></a>00441 <span class="preprocessor"></span><span class="preprocessor"># Create links, between private directories such as myCourse/template</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span><span class="preprocessor"># and public directories (such as   wwtmp/courseName or myCourse/html</span>
<a name="l00443"></a>00443 <span class="preprocessor"></span><span class="preprocessor"># The location of the links depends on the type and location of the file</span>
<a name="l00444"></a>00444 <span class="preprocessor"></span><span class="preprocessor">##############################################</span>
<a name="l00445"></a>00445 <span class="preprocessor"></span>
<a name="l00446"></a>00446     <span class="keywordflow">if</span> ( $resource_object-&gt;{copy_link}-&gt;{type} eq <span class="stringliteral">&#39;link&#39;</span>) {
<a name="l00447"></a>00447         my $uniqID = $resource_object-&gt;{uniqID};
<a name="l00448"></a>00448         my $link = <span class="stringliteral">&quot;html/$uniqID.$ext&quot;</span>;
<a name="l00449"></a>00449         my $resource_uri = <span class="stringliteral">&quot;${tempURL}$link&quot;</span>; #FIXME -- insure that the slash is at the end of $tempURL
<a name="l00450"></a>00450         my $linkPath = $self-&gt;surePathToTmpFile($link);
<a name="l00451"></a>00451         
<a name="l00452"></a>00452         <span class="keywordflow">if</span> (-e $htmlFileSource) {
<a name="l00453"></a>00453             <span class="keywordflow">if</span> (-e $linkPath) {
<a name="l00454"></a>00454                 unlink($linkPath) || warn <span class="stringliteral">&quot;Unable to unlink alias file at |$linkPath|&quot;</span>;
<a name="l00455"></a>00455 <span class="preprocessor">                # destroy the old link.</span>
<a name="l00456"></a>00456 <span class="preprocessor"></span>            }
<a name="l00457"></a>00457             <span class="keywordflow">if</span> (symlink( $htmlFileSource, $linkPath)) {
<a name="l00458"></a>00458                 $resource_object-&gt;{path}-&gt;{is_accessible}=1;
<a name="l00459"></a>00459                 $resource_object-&gt;{copy_link}-&gt;{link_to_path}= $linkPath;
<a name="l00460"></a>00460                 $resource_object-&gt;uri($resource_uri);
<a name="l00461"></a>00461             } <span class="keywordflow">else</span> {
<a name="l00462"></a>00462                 $self-&gt;warning_message( <span class="stringliteral">&quot;The macro alias cannot create a link from |$linkPath|  to |$htmlFileSource| &lt;BR&gt;&quot;</span>) ;
<a name="l00463"></a>00463             }
<a name="l00464"></a>00464         } <span class="keywordflow">else</span> {
<a name="l00465"></a>00465             $self-&gt;warning_message(<span class="stringliteral">&quot;The macro alias cannot find an HTML file at: |$htmlFileSource|&quot;</span>);
<a name="l00466"></a>00466             $resource_object-&gt;{path}-&gt;{is_accessible}=0;
<a name="l00467"></a>00467 <span class="preprocessor">            # we should delete the resource object in this case?</span>
<a name="l00468"></a>00468 <span class="preprocessor"></span>        }
<a name="l00469"></a>00469         $resource_object-&gt;uri();  # <span class="keywordflow">return</span> the uri of the resource
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471 }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 sub alias_for_gif_in_html_mode {
<a name="l00475"></a>00475     my $self = shift;
<a name="l00476"></a>00476     my $aux_file_id = shift;
<a name="l00477"></a>00477 <span class="preprocessor">#    warn &quot;entering alias_for_gif_in_html_mode $aux_file_id&quot;;</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span>    
<a name="l00479"></a>00479     my $envir               = $self-&gt;{envir};   
<a name="l00480"></a>00480     my $fileName            = $self-&gt;{fileName};
<a name="l00481"></a>00481     my $htmlDirectory       = $envir-&gt;{htmlDirectory};
<a name="l00482"></a>00482     my $htmlURL             = $envir-&gt;{htmlURL};
<a name="l00483"></a>00483     my $tempDirectory       = $envir-&gt;{tempDirectory};
<a name="l00484"></a>00484     my $tempURL             = $envir-&gt;{tempURL};
<a name="l00485"></a>00485     my $studentLogin        = $envir-&gt;{studentLogin};
<a name="l00486"></a>00486     my $psvn          = $envir-&gt;{psvn};
<a name="l00487"></a>00487     my $setNumber           = $envir-&gt;{setNumber};
<a name="l00488"></a>00488     my $probNum             = $envir-&gt;{probNum};
<a name="l00489"></a>00489     my $displayMode         = $envir-&gt;{displayMode};
<a name="l00490"></a>00490     my $externalGif2EpsPath = $envir-&gt;{externalGif2EpsPath};
<a name="l00491"></a>00491     my $externalPng2EpsPath = $envir-&gt;{externalPng2EpsPath};
<a name="l00492"></a>00492     
<a name="l00493"></a>00493     my $templateDirectory   = $self-&gt;{templateDirectory};
<a name="l00494"></a>00494     
<a name="l00495"></a>00495     
<a name="l00496"></a>00496 <span class="preprocessor">    # $adr_output is a url in HTML and Latex2HTML modes</span>
<a name="l00497"></a>00497 <span class="preprocessor"></span><span class="preprocessor">    # and a complete path in TEX mode.</span>
<a name="l00498"></a>00498 <span class="preprocessor"></span>    my $adr_output;
<a name="l00499"></a>00499     my $ext                 = <span class="stringliteral">&quot;gif&quot;</span>;
<a name="l00500"></a>00500     
<a name="l00501"></a>00501 <span class="preprocessor">            ################################################################################</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span><span class="preprocessor">            # .gif FILES in HTML, HTML_tth, HTML_dpng, HTML_img, and Latex2HTML modes</span>
<a name="l00503"></a>00503 <span class="preprocessor"></span><span class="preprocessor">            ################################################################################</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>
<a name="l00505"></a>00505 <span class="preprocessor">            #warn &quot;tempDirectory is $tempDirectory&quot;;</span>
<a name="l00506"></a>00506 <span class="preprocessor"></span><span class="preprocessor">            #warn &quot;file Path for auxiliary file is $aux_file_id&quot;;</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span>
<a name="l00508"></a>00508 <span class="preprocessor">            # No changes are made for auxiliary files in the htmlDirectory or in the tempDirectory subtree.</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $aux_file_id =~ m|^$tempDirectory| ) {
<a name="l00510"></a>00510                 $adr_output = $aux_file_id;
<a name="l00511"></a>00511                 $adr_output =~ s|$tempDirectory|$tempURL|;
<a name="l00512"></a>00512                 $adr_output .= <span class="stringliteral">&quot;.$ext&quot;</span>;
<a name="l00513"></a>00513 <span class="preprocessor">                #warn &quot;adress out is $adr_output&quot;,</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span>            } elsif ($aux_file_id =~ m|^$htmlDirectory| ) {
<a name="l00515"></a>00515                 $adr_output = $aux_file_id;
<a name="l00516"></a>00516                 $adr_output =~ s|$htmlDirectory|$htmlURL|;
<a name="l00517"></a>00517                 $adr_output .= <span class="stringliteral">&quot;.$ext&quot;</span>;
<a name="l00518"></a>00518             } <span class="keywordflow">else</span> {
<a name="l00519"></a>00519 <span class="preprocessor">                # files not in the htmlDirectory sub tree are assumed to live under the templateDirectory</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span><span class="preprocessor">                # subtree in the same directory as the problem.</span>
<a name="l00521"></a>00521 <span class="preprocessor"></span>
<a name="l00522"></a>00522 <span class="preprocessor">                # For a gif file the alias macro creates an alias under the html/images directory</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span><span class="preprocessor">                # which points to the gif file in the problem directory.</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span><span class="preprocessor">                # All of the subdirectories of html/tmp/gif which are needed are also created.</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span><span class="preprocessor">          #warn &quot;fileName is $fileName   $self&quot;;</span>
<a name="l00526"></a>00526 <span class="preprocessor"></span>                my $filePath = ( $self-&gt;directoryFromPath($fileName) );
<a name="l00527"></a>00527 <span class="preprocessor">          #warn &quot;filePath is $filePath&quot;;</span>
<a name="l00528"></a>00528 <span class="preprocessor"></span><span class="preprocessor">                # $fileName is obtained from environment for PGeval</span>
<a name="l00529"></a>00529 <span class="preprocessor"></span><span class="preprocessor">                # it gives the full path to the current problem</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span>                my $gifSourceFile = $self-&gt;convertPath(<span class="stringliteral">&quot;$templateDirectory${filePath}$aux_file_id.gif&quot;</span>);
<a name="l00531"></a>00531 <span class="preprocessor">                #my $link = &quot;gif/$studentLogin-$psvn-set$setNumber-prob$probNum-$aux_file_id.$ext&quot;;</span>
<a name="l00532"></a>00532 <span class="preprocessor"></span><span class="preprocessor">           #warn &quot;fileName is $fileName filePath is $filePath gifSourceFile is $gifSourceFile&quot;;</span>
<a name="l00533"></a>00533 <span class="preprocessor"></span>
<a name="l00534"></a>00534 <span class="preprocessor">                #  Make file names work in Library Browser when the images in several</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span><span class="preprocessor">                #  files have the same names.</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span>                my $libFix = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00537"></a>00537                 <span class="keywordflow">if</span> ($setNumber eq <span class="stringliteral">&quot;Undefined_Set&quot;</span>) {
<a name="l00538"></a>00538                   $libFix = $fileName;
<a name="l00539"></a>00539                   $libFix =~ s!.*/!!, $libFix =~ s!\.pg(\..*)?$!!;
<a name="l00540"></a>00540                   $libFix =~ s![^a-zA-Z0-9._-]!!g;
<a name="l00541"></a>00541                   $libFix .= <span class="charliteral">&#39;-&#39;</span>;
<a name="l00542"></a>00542                 }
<a name="l00543"></a>00543 
<a name="l00544"></a>00544 <span class="preprocessor">                # my $link = &quot;gif/$setNumber-prob$probNum-$libFix$aux_file_id.$ext&quot;;</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span>                my $uniqIDstub = $self-&gt;{uniqIDstub};
<a name="l00546"></a>00546                 my $link = <span class="stringliteral">&quot;gif/${uniqIDstub}-$aux_file_id.$ext&quot;</span>;
<a name="l00547"></a>00547                 my $linkPath = $self-&gt;surePathToTmpFile($link);
<a name="l00548"></a>00548                 $adr_output = <span class="stringliteral">&quot;${tempURL}$link&quot;</span>;
<a name="l00549"></a>00549 <span class="preprocessor">                #warn &quot;linkPath is $linkPath&quot;;</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span><span class="preprocessor">                #warn &quot;adr_output is $adr_output&quot;;</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (-e $gifSourceFile) {
<a name="l00552"></a>00552                     <span class="keywordflow">if</span> (-e $linkPath) {
<a name="l00553"></a>00553                         unlink($linkPath) || warn <span class="stringliteral">&quot;Unable to unlink old alias file at $linkPath&quot;</span>;
<a name="l00554"></a>00554                     }
<a name="l00555"></a>00555                     symlink($gifSourceFile, $linkPath)
<a name="l00556"></a>00556                         || warn <span class="stringliteral">&quot;The macro alias cannot create a link from |$linkPath|  to |$gifSourceFile| &lt;BR&gt;&quot;</span> ;
<a name="l00557"></a>00557                 } <span class="keywordflow">else</span> {
<a name="l00558"></a>00558                     warn(<span class="stringliteral">&quot;The macro alias cannot find a GIF file at: |$gifSourceFile|&quot;</span>);
<a name="l00559"></a>00559                 }
<a name="l00560"></a>00560             }
<a name="l00561"></a>00561         $adr_output;
<a name="l00562"></a>00562 }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 sub alias_for_gif_in_tex_mode {
<a name="l00565"></a>00565     my $self = shift;
<a name="l00566"></a>00566     my $aux_file_id = shift;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     my $envir               = $self-&gt;{envir};   my $fileName            = $envir-&gt;{fileName};
<a name="l00569"></a>00569     my $htmlDirectory       = $envir-&gt;{htmlDirectory};
<a name="l00570"></a>00570     my $htmlURL             = $envir-&gt;{htmlURL};
<a name="l00571"></a>00571     my $tempDirectory       = $envir-&gt;{tempDirectory};
<a name="l00572"></a>00572     my $tempURL             = $envir-&gt;{tempURL};
<a name="l00573"></a>00573     my $studentLogin        = $envir-&gt;{studentLogin};
<a name="l00574"></a>00574     my $psvn          = $envir-&gt;{psvn};
<a name="l00575"></a>00575     my $setNumber           = $envir-&gt;{setNumber};
<a name="l00576"></a>00576     my $probNum             = $envir-&gt;{probNum};
<a name="l00577"></a>00577     my $displayMode         = $envir-&gt;{displayMode};
<a name="l00578"></a>00578     my $externalGif2EpsPath = $envir-&gt;{externalGif2EpsPath};
<a name="l00579"></a>00579     my $externalPng2EpsPath = $envir-&gt;{externalPng2EpsPath};
<a name="l00580"></a>00580     
<a name="l00581"></a>00581     my $templateDirectory   = $self-&gt;{templateDirectory};
<a name="l00582"></a>00582     
<a name="l00583"></a>00583     
<a name="l00584"></a>00584 <span class="preprocessor">    # $adr_output is a url in HTML and Latex2HTML modes</span>
<a name="l00585"></a>00585 <span class="preprocessor"></span><span class="preprocessor">    # and a complete path in TEX mode.</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span>    my $adr_output;
<a name="l00587"></a>00587     my $ext                 = <span class="stringliteral">&quot;gif&quot;</span>;
<a name="l00588"></a>00588 <span class="preprocessor">            ################################################################################</span>
<a name="l00589"></a>00589 <span class="preprocessor"></span><span class="preprocessor">            # .gif FILES in TeX mode</span>
<a name="l00590"></a>00590 <span class="preprocessor"></span><span class="preprocessor">            ################################################################################</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span>
<a name="l00592"></a>00592                 $setNumber =~ s/\./_/g;  ## extra dots confuse latex<span class="stringliteral">&#39;s graphics package</span>
<a name="l00593"></a>00593 <span class="stringliteral">            if ($envir-&gt;{texDisposition} eq &quot;pdf&quot;) {</span>
<a name="l00594"></a>00594 <span class="stringliteral">                # We&#39;</span>re going to create PDF files with our TeX (<span class="keyword">using</span> pdflatex); so we
<a name="l00595"></a>00595 <span class="preprocessor">                # need images in PNG format.</span>
<a name="l00596"></a>00596 <span class="preprocessor"></span>
<a name="l00597"></a>00597                 my $gifFilePath;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599                 <span class="keywordflow">if</span> ($aux_file_id =~ m/^$htmlDirectory/ or $aux_file_id =~ m/^$tempDirectory/) {
<a name="l00600"></a>00600 <span class="preprocessor">                    # we&#39;ve got a full pathname to a file</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span>                    $gifFilePath = <span class="stringliteral">&quot;$aux_file_id.gif&quot;</span>;
<a name="l00602"></a>00602                 } <span class="keywordflow">else</span> {
<a name="l00603"></a>00603 <span class="preprocessor">                    # we assume the file is in the same directory as the problem source file</span>
<a name="l00604"></a>00604 <span class="preprocessor"></span>                    my $dir = $self-&gt;directoryFromPath($fileName);
<a name="l00605"></a>00605                     $gifFilePath = <span class="stringliteral">&quot;$templateDirectory${dir}$aux_file_id.gif&quot;</span>;
<a name="l00606"></a>00606                 }
<a name="l00607"></a>00607 
<a name="l00608"></a>00608                 my $gifFileName = $self-&gt;fileFromPath($gifFilePath);
<a name="l00609"></a>00609                 $gifFileName =~ /^(.*)\.gif$/;
<a name="l00610"></a>00610                     my $pngFilePath = $self-&gt;surePathToTmpFile(<span class="stringliteral">&quot;${tempDirectory}png/$setNumber-$probNum-$1.png&quot;</span>);
<a name="l00611"></a>00611                 my $command = $envir-&gt;{externalGif2PngPath};
<a name="l00612"></a>00612                 my $returnCode = system <span class="stringliteral">&quot;cat $gifFilePath | $command &gt; $pngFilePath&quot;</span>;
<a name="l00613"></a>00613 <span class="preprocessor">            #warn &quot;FILE path $pngFilePath  exists =&quot;, -e $pngFilePath;</span>
<a name="l00614"></a>00614 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ($returnCode or not -e $pngFilePath) {
<a name="l00615"></a>00615                     warn <span class="stringliteral">&quot;returnCode $returnCode: failed to convert $gifFilePath to $pngFilePath using gif-&gt;png with $command: $!&quot;</span>;
<a name="l00616"></a>00616                 }
<a name="l00617"></a>00617 
<a name="l00618"></a>00618                 $adr_output = $pngFilePath;
<a name="l00619"></a>00619             } <span class="keywordflow">else</span> {
<a name="l00620"></a>00620 <span class="preprocessor">                # Since we&#39;re not creating PDF files; we&#39;re probably just using a plain</span>
<a name="l00621"></a>00621 <span class="preprocessor"></span><span class="preprocessor">                # vanilla latex. Hence; we need EPS images.</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span>
<a name="l00623"></a>00623 <span class="preprocessor">                ################################################################################</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span><span class="preprocessor">                # This is statement used below is system dependent.</span>
<a name="l00625"></a>00625 <span class="preprocessor"></span><span class="preprocessor">                # Notice that the range of colors is restricted when converting to postscript to keep the files small</span>
<a name="l00626"></a>00626 <span class="preprocessor"></span><span class="preprocessor">                # &quot;cat $gifSourceFile  | /usr/math/bin/giftopnm | /usr/math/bin/pnmtops -noturn &gt; $adr_output&quot;</span>
<a name="l00627"></a>00627 <span class="preprocessor"></span><span class="preprocessor">                # &quot;cat $gifSourceFile  | /usr/math/bin/giftopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn &gt; $adr_output&quot;</span>
<a name="l00628"></a>00628 <span class="preprocessor"></span><span class="preprocessor">                ################################################################################</span>
<a name="l00629"></a>00629 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ($aux_file_id =~  m|^$htmlDirectory|  or $aux_file_id =~  m|^$tempDirectory|)  {
<a name="l00630"></a>00630 <span class="preprocessor">                    # To serve an eps file copy an eps version of the gif file to the subdirectory of eps/</span>
<a name="l00631"></a>00631 <span class="preprocessor"></span>                    my $linkPath = $self-&gt;directoryFromPath($fileName);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633                     my $gifSourceFile = <span class="stringliteral">&quot;$aux_file_id.gif&quot;</span>;
<a name="l00634"></a>00634                     my $gifFileName = $self-&gt;fileFromPath($gifSourceFile);
<a name="l00635"></a>00635                     $adr_output = $self-&gt;surePathToTmpFile(<span class="stringliteral">&quot;$tempDirectory/eps/$studentLogin-$psvn-$gifFileName.eps&quot;</span>) ;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637                     <span class="keywordflow">if</span> (-e $gifSourceFile) {
<a name="l00638"></a>00638 <span class="preprocessor">                        #system(&quot;cat $gifSourceFile  | /usr/math/bin/giftopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn&gt;$adr_output&quot;)</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span>                        system(<span class="stringliteral">&quot;cat $gifSourceFile | ${externalGif2EpsPath} &gt; $adr_output&quot;</span> )
<a name="l00640"></a>00640                             &amp;&amp; die <span class="stringliteral">&quot;Unable to create eps file:\n |$adr_output| from file\n |$gifSourceFile|\n in problem $probNum &quot;</span> .
<a name="l00641"></a>00641                                    <span class="stringliteral">&quot;using the system dependent script\n |${externalGif2EpsPath}| \n&quot;</span>;
<a name="l00642"></a>00642                     } <span class="keywordflow">else</span> {
<a name="l00643"></a>00643                         die <span class="stringliteral">&quot;|$gifSourceFile| cannot be found.  Problem number: |$probNum|&quot;</span>;
<a name="l00644"></a>00644                     }
<a name="l00645"></a>00645                 } <span class="keywordflow">else</span> {
<a name="l00646"></a>00646 <span class="preprocessor">                    # To serve an eps file copy an eps version of the gif file to  a subdirectory of eps/</span>
<a name="l00647"></a>00647 <span class="preprocessor"></span>                    my $filePath = $self-&gt;directoryFromPath($fileName);
<a name="l00648"></a>00648                     my $gifSourceFile = <span class="stringliteral">&quot;${templateDirectory}${filePath}$aux_file_id.gif&quot;</span>;
<a name="l00649"></a>00649 <span class="preprocessor">                    #print &quot;content-type: text/plain \n\nfileName = $fileName and aux_file_id =$aux_file_id&lt;BR&gt;&quot;;</span>
<a name="l00650"></a>00650 <span class="preprocessor"></span>                    $adr_output = $self-&gt;surePathToTmpFile(<span class="stringliteral">&quot;eps/$studentLogin-$psvn-set$setNumber-prob$probNum-$aux_file_id.eps&quot;</span>);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652                     <span class="keywordflow">if</span> (-e $gifSourceFile) {
<a name="l00653"></a>00653 <span class="preprocessor">                        #system(&quot;cat $gifSourceFile  | /usr/math/bin/giftopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn&gt;$adr_output&quot;) &amp;&amp;</span>
<a name="l00654"></a>00654 <span class="preprocessor"></span><span class="preprocessor">                        #warn &quot;Unable to create eps file: |$adr_output|\n from file\n |$gifSourceFile|\n in problem $probNum&quot;;</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span><span class="preprocessor">                        #warn &quot;Help ${:externalGif2EpsPath}&quot; unless -x &quot;${main::externalGif2EpsPath}&quot;;</span>
<a name="l00656"></a>00656 <span class="preprocessor"></span>                        system(<span class="stringliteral">&quot;cat $gifSourceFile | ${externalGif2EpsPath} &gt; $adr_output&quot;</span> )
<a name="l00657"></a>00657                             &amp;&amp; die <span class="stringliteral">&quot;Unable to create eps file:\n |$adr_output| from file\n |$gifSourceFile|\n in problem $probNum &quot;</span> .
<a name="l00658"></a>00658                                    <span class="stringliteral">&quot;using the system dependent commands \n |${externalGif2EpsPath}| \n &quot;</span>;
<a name="l00659"></a>00659                     }  <span class="keywordflow">else</span> {
<a name="l00660"></a>00660                         die <span class="stringliteral">&quot;|$gifSourceFile| cannot be found.  Problem number: |$probNum|&quot;</span>;
<a name="l00661"></a>00661                     }
<a name="l00662"></a>00662                 }
<a name="l00663"></a>00663             }
<a name="l00664"></a>00664     $adr_output;
<a name="l00665"></a>00665 
<a name="l00666"></a>00666 } 
<a name="l00667"></a>00667 sub alias_for_png_in_html_mode {
<a name="l00668"></a>00668     my $self = shift;
<a name="l00669"></a>00669     my $aux_file_id = shift;
<a name="l00670"></a>00670 
<a name="l00671"></a>00671     my $envir               = $self-&gt;{envir};   my $fileName            = $envir-&gt;{fileName};
<a name="l00672"></a>00672     my $htmlDirectory       = $envir-&gt;{htmlDirectory};
<a name="l00673"></a>00673     my $htmlURL             = $envir-&gt;{htmlURL};
<a name="l00674"></a>00674     my $tempDirectory       = $envir-&gt;{tempDirectory};
<a name="l00675"></a>00675     my $tempURL             = $envir-&gt;{tempURL};
<a name="l00676"></a>00676     my $studentLogin        = $envir-&gt;{studentLogin};
<a name="l00677"></a>00677     my $psvn          = $envir-&gt;{psvn};
<a name="l00678"></a>00678     my $setNumber           = $envir-&gt;{setNumber};
<a name="l00679"></a>00679     my $probNum             = $envir-&gt;{probNum};
<a name="l00680"></a>00680     my $displayMode         = $envir-&gt;{displayMode};
<a name="l00681"></a>00681     my $externalGif2EpsPath = $envir-&gt;{externalGif2EpsPath};
<a name="l00682"></a>00682     my $externalPng2EpsPath = $envir-&gt;{externalPng2EpsPath};
<a name="l00683"></a>00683      
<a name="l00684"></a>00684     my $templateDirectory   = $self-&gt;{templateDirectory};
<a name="l00685"></a>00685     
<a name="l00686"></a>00686    
<a name="l00687"></a>00687 <span class="preprocessor">    # $adr_output is a url in HTML and Latex2HTML modes</span>
<a name="l00688"></a>00688 <span class="preprocessor"></span><span class="preprocessor">    # and a complete path in TEX mode.</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span>    my $adr_output;
<a name="l00690"></a>00690     my $ext                 = <span class="stringliteral">&quot;png&quot;</span>;
<a name="l00691"></a>00691 <span class="preprocessor">            ################################################################################</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span><span class="preprocessor">            # .png FILES in HTML; HTML_tth; HTML_dpng; HTML_img; etc. and Latex2HTML modes</span>
<a name="l00693"></a>00693 <span class="preprocessor"></span><span class="preprocessor">            ################################################################################</span>
<a name="l00694"></a>00694 <span class="preprocessor"></span>
<a name="l00695"></a>00695 <span class="preprocessor">            #warn &quot;tempDirectory is $tempDirectory&quot;;</span>
<a name="l00696"></a>00696 <span class="preprocessor"></span><span class="preprocessor">            #warn &quot;file Path for auxiliary file is $aux_file_id&quot;;</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>
<a name="l00698"></a>00698 <span class="preprocessor">            # No changes are made for auxiliary files in the htmlDirectory or in the tempDirectory subtree.</span>
<a name="l00699"></a>00699 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $aux_file_id =~ m|^$tempDirectory| ) {
<a name="l00700"></a>00700             $adr_output = $aux_file_id;
<a name="l00701"></a>00701                 $adr_output =~ s|$tempDirectory|$tempURL|;
<a name="l00702"></a>00702                 $adr_output .= <span class="stringliteral">&quot;.$ext&quot;</span>;
<a name="l00703"></a>00703 <span class="preprocessor">                #warn &quot;adress out is $adr_output&quot;;</span>
<a name="l00704"></a>00704 <span class="preprocessor"></span>            } elsif ($aux_file_id =~ m|^$htmlDirectory| ) {
<a name="l00705"></a>00705                 $adr_output = $aux_file_id;
<a name="l00706"></a>00706                 $adr_output =~ s|$htmlDirectory|$htmlURL|;
<a name="l00707"></a>00707                 $adr_output .= <span class="stringliteral">&quot;.$ext&quot;</span>;
<a name="l00708"></a>00708             } <span class="keywordflow">else</span> {
<a name="l00709"></a>00709 <span class="preprocessor">                # files not in the htmlDirectory sub tree are assumed to live under the templateDirectory</span>
<a name="l00710"></a>00710 <span class="preprocessor"></span><span class="preprocessor">                # subtree in the same directory as the problem.</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span>
<a name="l00712"></a>00712 <span class="preprocessor">                # For a png file the alias macro creates an alias under the html/images directory</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span><span class="preprocessor">                # which points to the png file in the problem directory.</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span><span class="preprocessor">                # All of the subdirectories of html/tmp/gif which are needed are also created.</span>
<a name="l00715"></a>00715 <span class="preprocessor"></span>                my $filePath = $self-&gt;directoryFromPath($fileName);
<a name="l00716"></a>00716 
<a name="l00717"></a>00717 <span class="preprocessor">                # $fileName is obtained from environment for PGeval</span>
<a name="l00718"></a>00718 <span class="preprocessor"></span><span class="preprocessor">                # it gives the full path to the current problem</span>
<a name="l00719"></a>00719 <span class="preprocessor"></span>                my $pngSourceFile = $self-&gt;convertPath(<span class="stringliteral">&quot;$templateDirectory${filePath}$aux_file_id.png&quot;</span>);
<a name="l00720"></a>00720                 my $uniqIDstub = $self-&gt;{uniqIDstub};
<a name="l00721"></a>00721                 my $link = <span class="stringliteral">&quot;gif/${uniqIDstub}-$aux_file_id.$ext&quot;</span>;
<a name="l00722"></a>00722                 my $linkPath = $self-&gt;surePathToTmpFile($link);
<a name="l00723"></a>00723                 $adr_output = <span class="stringliteral">&quot;${tempURL}$link&quot;</span>;
<a name="l00724"></a>00724 <span class="preprocessor">                #warn &quot;linkPath is $linkPath&quot;;</span>
<a name="l00725"></a>00725 <span class="preprocessor"></span><span class="preprocessor">                #warn &quot;adr_output is $adr_output&quot;;</span>
<a name="l00726"></a>00726 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (-e $pngSourceFile) {
<a name="l00727"></a>00727                     <span class="keywordflow">if</span> (-e $linkPath) {
<a name="l00728"></a>00728                         unlink($linkPath) || warn <span class="stringliteral">&quot;Unable to unlink old alias file at $linkPath&quot;</span>;
<a name="l00729"></a>00729                     }
<a name="l00730"></a>00730                     symlink($pngSourceFile, $linkPath)
<a name="l00731"></a>00731                     || warn <span class="stringliteral">&quot;The macro alias cannot create a link from |$linkPath|  to |$pngSourceFile| &lt;BR&gt;&quot;</span> ;
<a name="l00732"></a>00732                 } <span class="keywordflow">else</span> {
<a name="l00733"></a>00733                     warn(<span class="stringliteral">&quot;The macro alias cannot find a PNG file at: |$pngSourceFile|&quot;</span>);
<a name="l00734"></a>00734                 }
<a name="l00735"></a>00735             }
<a name="l00736"></a>00736     $adr_output;
<a name="l00737"></a>00737 
<a name="l00738"></a>00738 }
<a name="l00739"></a>00739 
<a name="l00740"></a>00740 sub alias_for_png_in_tex_mode {
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     my $self = shift;
<a name="l00743"></a>00743     my $aux_file_id = shift;
<a name="l00744"></a>00744 
<a name="l00745"></a>00745     my $envir               = $self-&gt;{envir};   my $fileName            = $envir-&gt;{fileName};
<a name="l00746"></a>00746     my $htmlDirectory       = $envir-&gt;{htmlDirectory};
<a name="l00747"></a>00747     my $htmlURL             = $envir-&gt;{htmlURL};
<a name="l00748"></a>00748     my $tempDirectory       = $envir-&gt;{tempDirectory};
<a name="l00749"></a>00749     my $tempURL             = $envir-&gt;{tempURL};
<a name="l00750"></a>00750     my $studentLogin        = $envir-&gt;{studentLogin};
<a name="l00751"></a>00751     my $psvn          = $envir-&gt;{psvn};
<a name="l00752"></a>00752     my $setNumber           = $envir-&gt;{setNumber};
<a name="l00753"></a>00753     my $probNum             = $envir-&gt;{probNum};
<a name="l00754"></a>00754     my $displayMode         = $envir-&gt;{displayMode};
<a name="l00755"></a>00755     my $externalGif2EpsPath = $envir-&gt;{externalGif2EpsPath};
<a name="l00756"></a>00756     my $externalPng2EpsPath = $envir-&gt;{externalPng2EpsPath};
<a name="l00757"></a>00757      
<a name="l00758"></a>00758     my $templateDirectory   = $self-&gt;{templateDirectory};
<a name="l00759"></a>00759     
<a name="l00760"></a>00760    
<a name="l00761"></a>00761 <span class="preprocessor">    # $adr_output is a url in HTML and Latex2HTML modes</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span><span class="preprocessor">    # and a complete path in TEX mode.</span>
<a name="l00763"></a>00763 <span class="preprocessor"></span>    my $adr_output;
<a name="l00764"></a>00764     my $ext                 = <span class="stringliteral">&quot;png&quot;</span>;          
<a name="l00765"></a>00765 <span class="preprocessor">            ################################################################################</span>
<a name="l00766"></a>00766 <span class="preprocessor"></span><span class="preprocessor">            # .png FILES in TeX mode</span>
<a name="l00767"></a>00767 <span class="preprocessor"></span><span class="preprocessor">            ################################################################################</span>
<a name="l00768"></a>00768 <span class="preprocessor"></span>
<a name="l00769"></a>00769                 $setNumber =~ s/\./_/g;  ## extra dots confuse latex<span class="stringliteral">&#39;s graphics package</span>
<a name="l00770"></a>00770 <span class="stringliteral">            if ($envir-&gt;{texDisposition} eq &quot;pdf&quot;) {</span>
<a name="l00771"></a>00771 <span class="stringliteral">                # We&#39;</span>re going to create PDF files with our TeX (<span class="keyword">using</span> pdflatex); so we
<a name="l00772"></a>00772 <span class="preprocessor">                # need images in PNG format. what luck! they&#39;re already in PDF format!</span>
<a name="l00773"></a>00773 <span class="preprocessor"></span>
<a name="l00774"></a>00774                 my $pngFilePath;
<a name="l00775"></a>00775 
<a name="l00776"></a>00776                 <span class="keywordflow">if</span> ($aux_file_id =~ m/^$htmlDirectory/ or $aux_file_id =~ m/^$tempDirectory/) {
<a name="l00777"></a>00777 <span class="preprocessor">                    # we&#39;ve got a full pathname to a file</span>
<a name="l00778"></a>00778 <span class="preprocessor"></span>                    $pngFilePath = <span class="stringliteral">&quot;$aux_file_id.png&quot;</span>;
<a name="l00779"></a>00779                 } <span class="keywordflow">else</span> {
<a name="l00780"></a>00780 <span class="preprocessor">                    # we assume the file is in the same directory as the problem source file</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>                    my $dir = $self-&gt;directoryFromPath($fileName);
<a name="l00782"></a>00782                     $pngFilePath = <span class="stringliteral">&quot;$templateDirectory${dir}$aux_file_id.png&quot;</span>;
<a name="l00783"></a>00783                 }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785                 $adr_output = $pngFilePath;
<a name="l00786"></a>00786             } <span class="keywordflow">else</span> {
<a name="l00787"></a>00787 <span class="preprocessor">                # Since we&#39;re not creating PDF files; we&#39;re probably just using a plain</span>
<a name="l00788"></a>00788 <span class="preprocessor"></span><span class="preprocessor">                # vanilla latex. Hence; we need EPS images.</span>
<a name="l00789"></a>00789 <span class="preprocessor"></span>
<a name="l00790"></a>00790 <span class="preprocessor">                ################################################################################</span>
<a name="l00791"></a>00791 <span class="preprocessor"></span><span class="preprocessor">                # This is statement used below is system dependent.</span>
<a name="l00792"></a>00792 <span class="preprocessor"></span><span class="preprocessor">                # Notice that the range of colors is restricted when converting to postscript to keep the files small</span>
<a name="l00793"></a>00793 <span class="preprocessor"></span><span class="preprocessor">                # &quot;cat $pngSourceFile  | /usr/math/bin/pngtopnm | /usr/math/bin/pnmtops -noturn &gt; $adr_output&quot;</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span><span class="preprocessor">                # &quot;cat $pngSourceFile  | /usr/math/bin/pngtopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn &gt; $adr_output&quot;</span>
<a name="l00795"></a>00795 <span class="preprocessor"></span><span class="preprocessor">                ################################################################################</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span>
<a name="l00797"></a>00797                 <span class="keywordflow">if</span> ($aux_file_id =~  m|^$htmlDirectory|  or $aux_file_id =~  m|^$tempDirectory|)  {
<a name="l00798"></a>00798 <span class="preprocessor">                    # To serve an eps file copy an eps version of the png file to the subdirectory of eps/</span>
<a name="l00799"></a>00799 <span class="preprocessor"></span>                    my $linkPath = $self-&gt;directoryFromPath($fileName);
<a name="l00800"></a>00800 
<a name="l00801"></a>00801                     my $pngSourceFile = <span class="stringliteral">&quot;$aux_file_id.png&quot;</span>;
<a name="l00802"></a>00802                     my $pngFileName = fileFromPath($pngSourceFile);
<a name="l00803"></a>00803                     $adr_output = $self-&gt;surePathToTmpFile(<span class="stringliteral">&quot;$tempDirectory/eps/$studentLogin-$psvn-$pngFileName.eps&quot;</span>) ;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805                     <span class="keywordflow">if</span> (-e $pngSourceFile) {
<a name="l00806"></a>00806 <span class="preprocessor">                        #system(&quot;cat $pngSourceFile  | /usr/math/bin/pngtopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn&gt;$adr_output&quot;)</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span>                        system(<span class="stringliteral">&quot;cat $pngSourceFile | ${externalPng2EpsPath} &gt; $adr_output&quot;</span> )
<a name="l00808"></a>00808                             &amp;&amp; die <span class="stringliteral">&quot;Unable to create eps file:\n |$adr_output| from file\n |$pngSourceFile|\n in problem $probNum &quot;</span> .
<a name="l00809"></a>00809                                    <span class="stringliteral">&quot;using the system dependent commands\n |${externalPng2EpsPath}| \n&quot;</span>;
<a name="l00810"></a>00810                     } <span class="keywordflow">else</span> {
<a name="l00811"></a>00811                         die <span class="stringliteral">&quot;|$pngSourceFile| cannot be found.  Problem number: |$probNum|&quot;</span>;
<a name="l00812"></a>00812                     }
<a name="l00813"></a>00813                 } <span class="keywordflow">else</span> {
<a name="l00814"></a>00814 <span class="preprocessor">                    # To serve an eps file copy an eps version of the png file to  a subdirectory of eps/</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span>                    my $filePath = $self-&gt;directoryFromPath($fileName);
<a name="l00816"></a>00816                     my $pngSourceFile = <span class="stringliteral">&quot;${templateDirectory}${filePath}$aux_file_id.png&quot;</span>;
<a name="l00817"></a>00817 <span class="preprocessor">                    #print &quot;content-type: text/plain \n\nfileName = $fileName and aux_file_id =$aux_file_id&lt;BR&gt;&quot;;</span>
<a name="l00818"></a>00818 <span class="preprocessor"></span>                    $adr_output = $self-&gt;surePathToTmpFile(<span class="stringliteral">&quot;eps/$studentLogin-$psvn-set$setNumber-prob$probNum-$aux_file_id.eps&quot;</span>) ;
<a name="l00819"></a>00819                     <span class="keywordflow">if</span> (-e $pngSourceFile) {
<a name="l00820"></a>00820 <span class="preprocessor">                        #system(&quot;cat $pngSourceFile  | /usr/math/bin/pngtopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn&gt;$adr_output&quot;) &amp;&amp;</span>
<a name="l00821"></a>00821 <span class="preprocessor"></span><span class="preprocessor">                        #warn &quot;Unable to create eps file: |$adr_output|\n from file\n |$pngSourceFile|\n in problem $probNum&quot;;</span>
<a name="l00822"></a>00822 <span class="preprocessor"></span><span class="preprocessor">                        #warn &quot;Help ${externalPng2EpsPath}&quot; unless -x &quot;${externalPng2EpsPath}&quot;;</span>
<a name="l00823"></a>00823 <span class="preprocessor"></span>                        system(<span class="stringliteral">&quot;cat $pngSourceFile | ${externalPng2EpsPath} &gt; $adr_output&quot;</span> )
<a name="l00824"></a>00824                             &amp;&amp; die <span class="stringliteral">&quot;Unable to create eps file:\n |$adr_output| from file\n |$pngSourceFile|\n in problem $probNum &quot;</span> .
<a name="l00825"></a>00825                                    <span class="stringliteral">&quot;using the system dependent commands\n |${externalPng2EpsPath}| \n &quot;</span>;
<a name="l00826"></a>00826                     } <span class="keywordflow">else</span> {
<a name="l00827"></a>00827                         die <span class="stringliteral">&quot;|$pngSourceFile| cannot be found.  Problem number: |$probNum|&quot;</span>;
<a name="l00828"></a>00828                     }
<a name="l00829"></a>00829                 }
<a name="l00830"></a>00830             }
<a name="l00831"></a>00831     $adr_output;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833 }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835 <span class="preprocessor">################################################</span>
<a name="l00836"></a>00836 <span class="preprocessor"></span>
<a name="l00837"></a>00837 <span class="preprocessor"># More resource search macros</span>
<a name="l00838"></a>00838 <span class="preprocessor"></span>
<a name="l00839"></a>00839 <span class="preprocessor">################################################</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span>
<a name="l00841"></a>00841 <span class="preprocessor">#</span>
<a name="l00842"></a>00842 <span class="preprocessor"></span><span class="preprocessor">#  Look for a macro file in the directories specified in the macros path</span>
<a name="l00843"></a>00843 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00844"></a>00844 <span class="preprocessor"></span>
<a name="l00845"></a>00845 <span class="preprocessor"># ^variable my $macrosPath</span>
<a name="l00846"></a>00846 <span class="preprocessor"></span>our ($macrosPath,
<a name="l00847"></a>00847     # ^variable my $pwd
<a name="l00848"></a>00848     $pwd,
<a name="l00849"></a>00849     # ^variable my $appletPath
<a name="l00850"></a>00850     $appletPath,
<a name="l00851"></a>00851     # ^variable my $server_root_url
<a name="l00852"></a>00852     $server_root_url,
<a name="l00853"></a>00853     # ^variable my $templateDirectory
<a name="l00854"></a>00854     $templateDirectory,
<a name="l00855"></a>00855     # ^variable my $scriptDirectory
<a name="l00856"></a>00856     $scriptDirectory,
<a name="l00857"></a>00857     # ^variable my $externalTTHPath
<a name="l00858"></a>00858     $externalTTHPath,
<a name="l00859"></a>00859     );
<a name="l00860"></a>00860 
<a name="l00861"></a>00861 <span class="preprocessor"># ^function findMacroFile</span>
<a name="l00862"></a>00862 <span class="preprocessor"></span><span class="preprocessor"># ^uses $macrosPath</span>
<a name="l00863"></a>00863 <span class="preprocessor"></span><span class="preprocessor"># ^uses $pwd</span>
<a name="l00864"></a>00864 <span class="preprocessor"></span>sub findMacroFile {
<a name="l00865"></a>00865     my $self   = shift;
<a name="l00866"></a>00866   my $fileName = shift;
<a name="l00867"></a>00867   my $filePath;
<a name="l00868"></a>00868   <span class="keywordflow">foreach</span> my $dir (@{$macrosPath}) {
<a name="l00869"></a>00869     $filePath = <span class="stringliteral">&quot;$dir/$fileName&quot;</span>;
<a name="l00870"></a>00870     $filePath =~ s!^\.\.?/!$pwd/!;
<a name="l00871"></a>00871     <span class="keywordflow">return</span> $filePath <span class="keywordflow">if</span> (-r $filePath);
<a name="l00872"></a>00872   }
<a name="l00873"></a>00873   <span class="keywordflow">return</span>;  # no file found
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 <span class="preprocessor"># ^function check_url</span>
<a name="l00877"></a>00877 <span class="preprocessor"></span><span class="preprocessor"># ^uses %envir</span>
<a name="l00878"></a>00878 <span class="preprocessor"></span>sub check_url {
<a name="l00879"></a>00879     my $self = shift;
<a name="l00880"></a>00880     my $url  = shift;
<a name="l00881"></a>00881     my $OK_CONSTANT = <span class="stringliteral">&quot;200 OK&quot;</span>;
<a name="l00882"></a>00882     <span class="keywordflow">return</span> undef <span class="keywordflow">if</span> $url =~ /;/;   # make sure we can<span class="stringliteral">&#39;t get a second command in the url</span>
<a name="l00883"></a>00883 <span class="stringliteral">    #FIXME -- check for other exploits of the system call</span>
<a name="l00884"></a>00884 <span class="stringliteral">    #FIXME -- ALARM feature so that the response cannot be held up for too long.</span>
<a name="l00885"></a>00885 <span class="stringliteral">    #FIXME doesn&#39;</span>t seem to work with relative addresses.
<a name="l00886"></a>00886     #FIXME  Can we <span class="keyword">get</span> the machine name of the server?
<a name="l00887"></a>00887 
<a name="l00888"></a>00888      my $check_url_command = $self-&gt;{envir}-&gt;{externalCheckUrl};
<a name="l00889"></a>00889      my $response = `$check_url_command $url`; 
<a name="l00890"></a>00890     <span class="keywordflow">return</span> ($response =~ /^$OK_CONSTANT/) ? 1 : 0; 
<a name="l00891"></a>00891 }
<a name="l00892"></a>00892 
<a name="l00893"></a>00893 <span class="preprocessor"># ^variable our %appletCodebaseLocations</span>
<a name="l00894"></a>00894 <span class="preprocessor"></span>
<a name="l00895"></a>00895 <span class="preprocessor"># ^function findAppletCodebase</span>
<a name="l00896"></a>00896 <span class="preprocessor"></span><span class="preprocessor"># ^uses %appletCodebaseLocations</span>
<a name="l00897"></a>00897 <span class="preprocessor"></span><span class="preprocessor"># ^uses $appletPath</span>
<a name="l00898"></a>00898 <span class="preprocessor"></span><span class="preprocessor"># ^uses $server_root_url</span>
<a name="l00899"></a>00899 <span class="preprocessor"></span><span class="preprocessor"># ^uses check_url</span>
<a name="l00900"></a>00900 <span class="preprocessor"></span>
<a name="l00901"></a>00901 our %appletCodebaseLocations = ();   # cache <span class="keywordflow">for</span> found applets (lasts until the child exits
<a name="l00902"></a>00902 sub findAppletCodebase {
<a name="l00903"></a>00903     my $self     = shift;
<a name="l00904"></a>00904     my $fileName = shift;  # probably the name of a jar file
<a name="l00905"></a>00905     $server_root_url=$self-&gt;envir(<span class="stringliteral">&quot;server_root_url&quot;</span>);
<a name="l00906"></a>00906 <span class="preprocessor">    #check cache first</span>
<a name="l00907"></a>00907 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (defined($appletCodebaseLocations{$fileName})  
<a name="l00908"></a>00908           and $appletCodebaseLocations{$fileName} =~/\S/  )
<a name="l00909"></a>00909     {
<a name="l00910"></a>00910         <span class="keywordflow">return</span> $appletCodebaseLocations{$fileName}; # <span class="keywordflow">return</span> <span class="keywordflow">if</span> found in cache
<a name="l00911"></a>00911     }
<a name="l00912"></a>00912     my $appletPath = $self-&gt;{appletPath};
<a name="l00913"></a>00913     <span class="keywordflow">foreach</span> my $appletLocation (@{$appletPath}) {
<a name="l00914"></a>00914         <span class="keywordflow">if</span> ($appletLocation =~ m|^/|) {
<a name="l00915"></a>00915             $appletLocation = <span class="stringliteral">&quot;$server_root_url$appletLocation&quot;</span>;
<a name="l00916"></a>00916         }
<a name="l00917"></a>00917         my $url = <span class="stringliteral">&quot;$appletLocation/$fileName&quot;</span>;
<a name="l00918"></a>00918 
<a name="l00919"></a>00919         <span class="keywordflow">if</span> ($self-&gt;check_url($url)) {
<a name="l00920"></a>00920                 $appletCodebaseLocations{$fileName} = $appletLocation; #update cache
<a name="l00921"></a>00921             <span class="keywordflow">return</span> $appletLocation   # <span class="keywordflow">return</span> codebase part of url
<a name="l00922"></a>00922         }
<a name="l00923"></a>00923     }
<a name="l00924"></a>00924     warn <span class="stringliteral">&quot;findAppletCodebase Error: $fileName not found after searching &quot;</span>. join(<span class="stringliteral">&quot;,  &quot;</span>, @{$appletPath} );
<a name="l00925"></a>00925     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00926"></a>00926 }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:54:55 2012 for PG by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
