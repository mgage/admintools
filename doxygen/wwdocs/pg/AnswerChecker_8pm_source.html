<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PG: AnswerChecker.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>AnswerChecker.pm</h1><a href="AnswerChecker_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 =head1 DESCRIPTION
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="preprocessor"> #############################################################</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"> #</span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"> #  Implements the -&gt;cmp method for Value objects.</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"> #  Otherwise known as MathObjects.  This produces</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"> #  an answer checker appropriate for the type of object.</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"> #  Additional options can be passed to the cmp method to</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"> #  modify its action.</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"> #</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"> #   Usage:  $num = Real(3.45); # Real can be replaced by any other MathObject</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"> #           ANS($num-&gt;cmp(compareOptionName =&gt; compareOptionValue, ... ))</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"> #</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor"> #  The individual Value packages are modified below to add the</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor"> #  needed methods.</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="preprocessor"> #</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span><span class="preprocessor"> #############################################################</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span>
<a name="l00020"></a>00020 =cut
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="keyword">package </span>Value;
<a name="l00023"></a>00023 use <a class="code" href="classPGcore.html">PGcore</a>;
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor">#</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#  Context can add default values to the answer checkers by class;</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>$Value::defaultContext-&gt;{cmpDefaults} = {};
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 =head5 $mathObject-&gt;cmp_defaults()
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#  Internal use.</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#  Set default flags for the answer checker in this object</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#       showTypeWarnings         =&gt; 1</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#       showEqualErrors          =&gt; 1</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#       ignoreStrings            =&gt; 1</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#       studentsMustReduceUnions =&gt; 1</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#       showUnionReduceWarnings  =&gt; 1</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 =cut
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 sub cmp_defaults {(
<a name="l00044"></a>00044   showTypeWarnings =&gt; 1,
<a name="l00045"></a>00045   showEqualErrors  =&gt; 1,
<a name="l00046"></a>00046   ignoreStrings    =&gt; 1,
<a name="l00047"></a>00047   studentsMustReduceUnions =&gt; 1,
<a name="l00048"></a><a class="code" href="classValue.html">00048</a>   showUnionReduceWarnings =&gt; 1,
<a name="l00049"></a>00049 )}
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 #
<a name="l00053"></a>00053 #  Special <a class="code" href="classValue_1_1Context.html">Context</a> flags to be <span class="keyword">set</span> <span class="keywordflow">for</span> the student answer
<a name="l00054"></a>00054 #
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 sub cmp_contextFlags {
<a name="l00057"></a>00057   my $self = shift; my $ans = shift;
<a name="l00058"></a>00058   <span class="keywordflow">return</span> (
<a name="l00059"></a>00059     StringifyAsTeX =&gt; 0,                 # reset <span class="keyword">this</span>, just in <span class="keywordflow">case</span>.
<a name="l00060"></a>00060     no_parameters =&gt; 1,                  # don<span class="stringliteral">&#39;t let students enter parameters</span>
<a name="l00061"></a>00061 <span class="stringliteral">    showExtraParens =&gt; 2,                # make student answer painfully unambiguous</span>
<a name="l00062"></a>00062 <span class="stringliteral">    reduceConstants =&gt; 0,                # don&#39;</span>t combine student constants
<a name="l00063"></a>00063     reduceConstantFunctions =&gt; 0,        # don<span class="stringliteral">&#39;t reduce constant functions</span>
<a name="l00064"></a>00064 <span class="stringliteral">    ($ans-&gt;{studentsMustReduceUnions} ?</span>
<a name="l00065"></a>00065 <span class="stringliteral">      (reduceUnions =&gt; 0, reduceSets =&gt; 0,</span>
<a name="l00066"></a>00066 <span class="stringliteral">       reduceUnionsForComparison =&gt; $ans-&gt;{showUnionReduceWarnings},</span>
<a name="l00067"></a>00067 <span class="stringliteral">       reduceSetsForComparison =&gt; $ans-&gt;{showUnionReduceWarnings}) :</span>
<a name="l00068"></a>00068 <span class="stringliteral">      (reduceUnions =&gt; 1, reduceSets =&gt; 1,</span>
<a name="l00069"></a>00069 <span class="stringliteral">       reduceUnionsForComparison =&gt; 1, reduceSetsForComparison =&gt; 1)),</span>
<a name="l00070"></a>00070 <span class="stringliteral">    ($ans-&gt;{requireParenMatch}? (): ignoreEndpointTypes =&gt; 1),  # for Intervals</span>
<a name="l00071"></a>00071 <span class="stringliteral">  );</span>
<a name="l00072"></a>00072 <span class="stringliteral">}</span>
<a name="l00073"></a>00073 <span class="stringliteral"></span>
<a name="l00074"></a>00074 <span class="stringliteral"></span>
<a name="l00075"></a>00075 <span class="stringliteral">#</span>
<a name="l00076"></a>00076 <span class="stringliteral">#  Create an answer checker for the given type of object</span>
<a name="l00077"></a>00077 <span class="stringliteral">#</span>
<a name="l00078"></a>00078 <span class="stringliteral"></span>
<a name="l00079"></a>00079 <span class="stringliteral">sub cmp {</span>
<a name="l00080"></a>00080 <span class="stringliteral">  my $self = shift;</span>
<a name="l00081"></a>00081 <span class="stringliteral">  my $ans = new AnswerEvaluator;</span>
<a name="l00082"></a>00082 <span class="stringliteral">  my $correct = preformat($self-&gt;{correct_ans});</span>
<a name="l00083"></a>00083 <span class="stringliteral">  $correct = $self-&gt;correct_ans unless defined($correct);</span>
<a name="l00084"></a>00084 <span class="stringliteral">  $self-&gt;{context} = Value-&gt;context unless defined($self-&gt;{context});</span>
<a name="l00085"></a>00085 <span class="stringliteral">  $ans-&gt;ans_hash(</span>
<a name="l00086"></a>00086 <span class="stringliteral">    type =&gt; &quot;Value (&quot;.$self-&gt;class.&quot;)&quot;,</span>
<a name="l00087"></a>00087 <span class="stringliteral">    correct_ans =&gt; $correct,</span>
<a name="l00088"></a>00088 <span class="stringliteral">    correct_value =&gt; $self,</span>
<a name="l00089"></a>00089 <span class="stringliteral">    $self-&gt;cmp_defaults(@_),</span>
<a name="l00090"></a>00090 <span class="stringliteral">    %{$self-&gt;{context}{cmpDefaults}{$self-&gt;class} || {}},  # context-specified defaults</span>
<a name="l00091"></a>00091 <span class="stringliteral">    @_,</span>
<a name="l00092"></a>00092 <span class="stringliteral">  );</span>
<a name="l00093"></a>00093 <span class="stringliteral">  $ans-&gt;{debug} = $ans-&gt;{rh_ans}{debug};</span>
<a name="l00094"></a>00094 <span class="stringliteral">  $ans-&gt;install_evaluator(sub {</span>
<a name="l00095"></a>00095 <span class="stringliteral">     my $ans = shift;</span>
<a name="l00096"></a>00096 <span class="stringliteral">     $ans-&gt;{_filter_name} = &quot;MathObjects answer checker&quot;;</span>
<a name="l00097"></a>00097 <span class="stringliteral">     $ans-&gt;{correct_value}-&gt;cmp_parse($ans);</span>
<a name="l00098"></a>00098 <span class="stringliteral">  });</span>
<a name="l00099"></a>00099 <span class="stringliteral">  $ans-&gt;install_pre_filter(&#39;</span>erase<span class="stringliteral">&#39;) if $self-&gt;{ans_name}; # don&#39;</span>t <span class="keywordflow">do</span> blank check <span class="keywordflow">if</span> answer_array
<a name="l00100"></a>00100   $self-&gt;cmp_diagnostics($ans);
<a name="l00101"></a>00101   <span class="keywordflow">return</span> $ans;
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 sub correct_ans {preformat(shift-&gt;string)}
<a name="l00105"></a>00105 sub cmp_diagnostics {}
<a name="l00106"></a>00106 
<a name="l00107"></a>00107 <span class="preprocessor">#</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span><span class="preprocessor">#  Parse the student answer and compute its value,</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span><span class="preprocessor">#    produce the preview strings, and then compare the</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span><span class="preprocessor">#    student and professor&#39;s answers for equality.</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>sub cmp_parse {
<a name="l00113"></a>00113   my $self = shift; my $ans = shift;
<a name="l00114"></a>00114 <span class="preprocessor">  #</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span><span class="preprocessor">  #  Do some setup</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span><span class="preprocessor">  #</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>  my $current = <a class="code" href="classValue.html">Value</a>-&gt;context; # save it <span class="keywordflow">for</span> later
<a name="l00118"></a>00118   my $context = $ans-&gt;{correct_value}{<a class="code" href="classcontext.html">context</a>} || $current;
<a name="l00119"></a>00119   <a class="code" href="classParser_1_1Context.html">Parser::Context</a>-&gt;current(undef,$context); # change to correct answser<span class="stringliteral">&#39;s context</span>
<a name="l00120"></a>00120 <span class="stringliteral">  my $flags = contextSet($context,$self-&gt;cmp_contextFlags($ans)); # save old context flags</span>
<a name="l00121"></a>00121 <span class="stringliteral">  my $inputs = $self-&gt;getPG(&#39;</span>$inputs_ref<span class="stringliteral">&#39;);</span>
<a name="l00122"></a>00122 <span class="stringliteral">  $ans-&gt;{isPreview} = $inputs-&gt;{previewAnswers} || ($inputs-&gt;{action} =~ m/^Preview/);</span>
<a name="l00123"></a>00123 <span class="stringliteral">  $ans-&gt;{cmp_class} = $self-&gt;cmp_class($ans) unless $ans-&gt;{cmp_class};</span>
<a name="l00124"></a>00124 <span class="stringliteral">  $ans-&gt;{error_message} = $ans-&gt;{ans_message} = &#39;</span><span class="stringliteral">&#39;; # clear any old messages</span>
<a name="l00125"></a>00125 <span class="stringliteral">  $ans-&gt;{preview_latex_string} = $ans-&gt;{preview_text_string} = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00126"></a>00126 <span class="stringliteral">  $context-&gt;clearError();</span>
<a name="l00127"></a>00127 <span class="stringliteral">  $context-&gt;{answerHash} = $ans; # values here can override context flags</span>
<a name="l00128"></a>00128 <span class="stringliteral"></span>
<a name="l00129"></a>00129 <span class="stringliteral">  #</span>
<a name="l00130"></a>00130 <span class="stringliteral">  #  Parse and evaluate the student answer</span>
<a name="l00131"></a>00131 <span class="stringliteral">  #</span>
<a name="l00132"></a>00132 <span class="stringliteral">  $ans-&gt;score(0);  # assume failure</span>
<a name="l00133"></a>00133 <span class="stringliteral">  $ans-&gt;{student_value} = $ans-&gt;{student_formula} = Parser::Formula($ans-&gt;{student_ans});</span>
<a name="l00134"></a>00134 <span class="stringliteral">  $ans-&gt;{student_value} = Parser::Evaluate($ans-&gt;{student_formula})</span>
<a name="l00135"></a>00135 <span class="stringliteral">    if defined($ans-&gt;{student_formula}) &amp;&amp; $ans-&gt;{student_formula}-&gt;isConstant;</span>
<a name="l00136"></a>00136 <span class="stringliteral"></span>
<a name="l00137"></a>00137 <span class="stringliteral">  #</span>
<a name="l00138"></a>00138 <span class="stringliteral">  #  If it parsed OK, save the output forms and check if it is correct</span>
<a name="l00139"></a>00139 <span class="stringliteral">  #   otherwise report an error</span>
<a name="l00140"></a>00140 <span class="stringliteral">  #</span>
<a name="l00141"></a>00141 <span class="stringliteral">  if (defined $ans-&gt;{student_value}) {</span>
<a name="l00142"></a>00142 <span class="stringliteral">    $ans-&gt;{student_value} = $self-&gt;Package(&quot;Formula&quot;)-&gt;new($ans-&gt;{student_value})</span>
<a name="l00143"></a>00143 <span class="stringliteral">       unless Value::isValue($ans-&gt;{student_value});</span>
<a name="l00144"></a>00144 <span class="stringliteral">    $ans-&gt;{student_value}{isStudent} = 1;</span>
<a name="l00145"></a>00145 <span class="stringliteral">    $ans-&gt;{preview_latex_string} = $ans-&gt;{student_formula}-&gt;TeX;</span>
<a name="l00146"></a>00146 <span class="stringliteral">    $ans-&gt;{preview_text_string}  = preformat($ans-&gt;{student_formula}-&gt;string);</span>
<a name="l00147"></a>00147 <span class="stringliteral">    #FIXME</span>
<a name="l00148"></a>00148 <span class="stringliteral">    # Kludge to calculate a latex representation of the correct answer string</span>
<a name="l00149"></a>00149 <span class="stringliteral">    # It would be better to calculate this when the MathObject is created.</span>
<a name="l00150"></a>00150 <span class="stringliteral">    # the attempt to calculate the latex version may fail because the </span>
<a name="l00151"></a>00151 <span class="stringliteral">    # context has changed since the creation of the original MathObject.</span>
<a name="l00152"></a>00152 <span class="stringliteral">    # In that case the {correct_ans_latex_string} will be blank.</span>
<a name="l00153"></a>00153 <span class="stringliteral">    # We could try to reset that context temporarily, but a better fix would</span>
<a name="l00154"></a>00154 <span class="stringliteral">    # be to consistently create latex_string versions of the correct answer</span>
<a name="l00155"></a>00155 <span class="stringliteral">    # when the math object is created.</span>
<a name="l00156"></a>00156 <span class="stringliteral">#     if ($ans-&gt;{correct_value} ) {</span>
<a name="l00157"></a>00157 <span class="stringliteral">#       $ans-&gt;{correct_ans_latex_string} = $ans-&gt;{correct_value}-&gt;TeX; # answer is a MathObject</span>
<a name="l00158"></a>00158 <span class="stringliteral">#     } else {  # case where there is no math object</span>
<a name="l00159"></a>00159 <span class="stringliteral">#       my $mathobject = Parser::Formula($ans-&gt;{correct_ans});</span>
<a name="l00160"></a>00160 <span class="stringliteral">#       $ans-&gt;{correct_ans_latex_string} = ($mathobject)? $mathobject-&gt;TeX : &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00161"></a>00161 <span class="stringliteral">#     }</span>
<a name="l00162"></a>00162 <span class="stringliteral">    unless (PGcore::not_null($ans-&gt;{correct_ans_latex_string}) ) { # don&#39;</span>t alter the latex <span class="keywordtype">string</span> <span class="keywordflow">if</span> it<span class="stringliteral">&#39;s defined</span>
<a name="l00163"></a>00163 <span class="stringliteral">        my $mathobject = Parser::Formula($ans-&gt;{correct_ans});</span>
<a name="l00164"></a>00164 <span class="stringliteral">        if ($mathobject) {</span>
<a name="l00165"></a>00165 <span class="stringliteral">            $ans-&gt;{correct_ans_latex_string} = $mathobject-&gt;TeX;</span>
<a name="l00166"></a>00166 <span class="stringliteral">        } elsif( $ans-&gt;{correct_value} ) {</span>
<a name="l00167"></a>00167 <span class="stringliteral">            $ans-&gt;{correct_ans_latex_string} = $ans-&gt;{correct_value}-&gt;TeX; # answer is a MathObject</span>
<a name="l00168"></a>00168 <span class="stringliteral">        } else {</span>
<a name="l00169"></a>00169 <span class="stringliteral">            $ans-&gt;{correct_ans_latex_string}=&#39;</span><span class="stringliteral">&#39;; </span>
<a name="l00170"></a>00170 <span class="stringliteral">        }</span>
<a name="l00171"></a>00171 <span class="stringliteral">    }</span>
<a name="l00172"></a>00172 <span class="stringliteral">    #</span>
<a name="l00173"></a>00173 <span class="stringliteral">    #  Get the string for the student answer</span>
<a name="l00174"></a>00174 <span class="stringliteral">    #</span>
<a name="l00175"></a>00175 <span class="stringliteral">    for ($self-&gt;getFlag(&#39;</span>formatStudentAnswer<span class="stringliteral">&#39;)) {</span>
<a name="l00176"></a>00176 <span class="stringliteral">      /evaluated/i  and do {$ans-&gt;{student_ans} = preformat($ans-&gt;{student_value}-&gt;string); last};</span>
<a name="l00177"></a>00177 <span class="stringliteral">      /parsed/i     and do {$ans-&gt;{student_ans} = $ans-&gt;{preview_text_string}; last};</span>
<a name="l00178"></a>00178 <span class="stringliteral">      /reduced/i    and do {</span>
<a name="l00179"></a>00179 <span class="stringliteral">    my $oldFlags = contextSet($context,reduceConstants=&gt;1,reduceConstantFunctions=&gt;0);</span>
<a name="l00180"></a>00180 <span class="stringliteral">    $ans-&gt;{student_ans} = preformat($ans-&gt;{student_formula}-&gt;substitute()-&gt;string);</span>
<a name="l00181"></a>00181 <span class="stringliteral">    contextSet($context,%{$oldFags}); last;</span>
<a name="l00182"></a>00182 <span class="stringliteral">      };</span>
<a name="l00183"></a>00183 <span class="stringliteral">      warn &quot;Unkown student answer format |$ans-&gt;{formatStudentAnswer}|&quot;;</span>
<a name="l00184"></a>00184 <span class="stringliteral">    }</span>
<a name="l00185"></a>00185 <span class="stringliteral">    if ($self-&gt;cmp_collect($ans)) {</span>
<a name="l00186"></a>00186 <span class="stringliteral">      $self-&gt;cmp_preprocess($ans);</span>
<a name="l00187"></a>00187 <span class="stringliteral">      $self-&gt;cmp_equal($ans);</span>
<a name="l00188"></a>00188 <span class="stringliteral">      $self-&gt;cmp_postprocess($ans) if !$ans-&gt;{error_message} &amp;&amp; !$ans-&gt;{typeError};</span>
<a name="l00189"></a>00189 <span class="stringliteral">      $self-&gt;cmp_diagnostics($ans);</span>
<a name="l00190"></a>00190 <span class="stringliteral">    }</span>
<a name="l00191"></a>00191 <span class="stringliteral">  } else {</span>
<a name="l00192"></a>00192 <span class="stringliteral">    $self-&gt;cmp_collect($ans);</span>
<a name="l00193"></a>00193 <span class="stringliteral">    $self-&gt;cmp_error($ans);</span>
<a name="l00194"></a>00194 <span class="stringliteral">  }</span>
<a name="l00195"></a>00195 <span class="stringliteral">  $context-&gt;{answerHash} = undef;</span>
<a name="l00196"></a>00196 <span class="stringliteral">  contextSet($context,%{$flags});            # restore context values</span>
<a name="l00197"></a>00197 <span class="stringliteral">  Parser::Context-&gt;current(undef,$current);  # put back the old context</span>
<a name="l00198"></a>00198 <span class="stringliteral">  return $ans;</span>
<a name="l00199"></a>00199 <span class="stringliteral">}</span>
<a name="l00200"></a>00200 <span class="stringliteral"></span>
<a name="l00201"></a>00201 <span class="stringliteral">#</span>
<a name="l00202"></a>00202 <span class="stringliteral">#  Check if the object has an answer array and collect the results</span>
<a name="l00203"></a>00203 <span class="stringliteral">#  Build the combined student answer and set the preview values</span>
<a name="l00204"></a>00204 <span class="stringliteral">#</span>
<a name="l00205"></a>00205 <span class="stringliteral">sub cmp_collect {</span>
<a name="l00206"></a>00206 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l00207"></a>00207 <span class="stringliteral">  return 1 unless $self-&gt;{ans_name};</span>
<a name="l00208"></a>00208 <span class="stringliteral">  $ans-&gt;{preview_latex_string} = $ans-&gt;{preview_text_string} = &quot;&quot;;</span>
<a name="l00209"></a>00209 <span class="stringliteral">  my $OK = $self-&gt;ans_collect($ans);</span>
<a name="l00210"></a>00210 <span class="stringliteral">  $ans-&gt;{student_ans} = $self-&gt;format_matrix($ans-&gt;{student_formula},@{$self-&gt;{format_options}},tth_delims=&gt;1);</span>
<a name="l00211"></a>00211 <span class="stringliteral">  return 0 unless $OK;</span>
<a name="l00212"></a>00212 <span class="stringliteral">  my $array = $ans-&gt;{student_formula};</span>
<a name="l00213"></a>00213 <span class="stringliteral">  if ($self-&gt;{ColumnVector}) {</span>
<a name="l00214"></a>00214 <span class="stringliteral">    my @V = (); foreach my $x (@{$array}) {push(@V,$x-&gt;[0])}</span>
<a name="l00215"></a>00215 <span class="stringliteral">    $array = [@V];</span>
<a name="l00216"></a>00216 <span class="stringliteral">  } elsif (scalar(@{$array}) == 1) {$array = $array-&gt;[0]}</span>
<a name="l00217"></a>00217 <span class="stringliteral">  my $type = $self;</span>
<a name="l00218"></a>00218 <span class="stringliteral">  $type = $self-&gt;Package($self-&gt;{tree}-&gt;type) if $self-&gt;isFormula;</span>
<a name="l00219"></a>00219 <span class="stringliteral">  $ans-&gt;{student_formula} = eval {$type-&gt;new($array)-&gt;with(ColumnVector=&gt;$self-&gt;{ColumnVector})};</span>
<a name="l00220"></a>00220 <span class="stringliteral">  if (!defined($ans-&gt;{student_formula}) || $self-&gt;context-&gt;{error}{flag})</span>
<a name="l00221"></a>00221 <span class="stringliteral">    {Parser::reportEvalError($@); $self-&gt;cmp_error($ans); return 0}</span>
<a name="l00222"></a>00222 <span class="stringliteral">  $ans-&gt;{student_value} = $ans-&gt;{student_formula};</span>
<a name="l00223"></a>00223 <span class="stringliteral">  $ans-&gt;{preview_text_string} = $ans-&gt;{student_ans};</span>
<a name="l00224"></a>00224 <span class="stringliteral">  $ans-&gt;{preview_latex_string} = $ans-&gt;{student_formula}-&gt;TeX;</span>
<a name="l00225"></a>00225 <span class="stringliteral">  if (Value::isFormula($ans-&gt;{student_formula}) &amp;&amp; $ans-&gt;{student_formula}-&gt;isConstant) {</span>
<a name="l00226"></a>00226 <span class="stringliteral">    $ans-&gt;{student_value} = Parser::Evaluate($ans-&gt;{student_formula});</span>
<a name="l00227"></a>00227 <span class="stringliteral">    return 0 unless $ans-&gt;{student_value};</span>
<a name="l00228"></a>00228 <span class="stringliteral">  }</span>
<a name="l00229"></a>00229 <span class="stringliteral">  return 1;</span>
<a name="l00230"></a>00230 <span class="stringliteral">}</span>
<a name="l00231"></a>00231 <span class="stringliteral"></span>
<a name="l00232"></a>00232 <span class="stringliteral">#</span>
<a name="l00233"></a>00233 <span class="stringliteral">#  Check if the parsed student answer equals the professor&#39;</span>s answer
<a name="l00234"></a>00234 <span class="preprocessor">#</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>sub cmp_equal {
<a name="l00236"></a>00236   my $self = shift; my $ans = shift;
<a name="l00237"></a>00237   my $correct = $ans-&gt;{correct_value};
<a name="l00238"></a>00238   my $student = $ans-&gt;{student_value};
<a name="l00239"></a>00239   <span class="keywordflow">if</span> ($correct-&gt;typeMatch($student,$ans)) {
<a name="l00240"></a>00240     $self-&gt;context-&gt;clearError();
<a name="l00241"></a>00241     my $equal = $correct-&gt;cmp_compare($student,$ans);
<a name="l00242"></a>00242     <span class="keywordflow">if</span> ($self-&gt;context-&gt;{error}{flag} != $CMP_MESSAGE &amp;&amp;
<a name="l00243"></a>00243         (defined($equal) || !$ans-&gt;{showEqualErrors})) {$ans-&gt;score(1) <span class="keywordflow">if</span> $equal; <span class="keywordflow">return</span>}
<a name="l00244"></a>00244     $self-&gt;cmp_error($ans);
<a name="l00245"></a>00245   } <span class="keywordflow">else</span> {
<a name="l00246"></a>00246     <span class="keywordflow">return</span> <span class="keywordflow">if</span> $ans-&gt;{ignoreStrings} &amp;&amp; (!<a class="code" href="classValue.html#a43e6b7aa1e386a5a9056190d0ac3cbb3">Value::isValue</a>($student) || $student-&gt;type eq <span class="stringliteral">&#39;String&#39;</span>);
<a name="l00247"></a>00247     $ans-&gt;{typeError} = 1;
<a name="l00248"></a>00248     $ans-&gt;{ans_message} = $ans-&gt;{error_message} =
<a name="l00249"></a>00249       <span class="stringliteral">&quot;Your answer isn&#39;t &quot;</span>.lc($ans-&gt;{cmp_class}).<span class="stringliteral">&quot;\n&quot;</span>.
<a name="l00250"></a>00250         <span class="stringliteral">&quot;(it looks like &quot;</span>.lc($student-&gt;showClass).<span class="stringliteral">&quot;)&quot;</span>
<a name="l00251"></a>00251        <span class="keywordflow">if</span> !$ans-&gt;{isPreview} &amp;&amp; $ans-&gt;{showTypeWarnings} &amp;&amp; !$ans-&gt;{error_message};
<a name="l00252"></a>00252   }
<a name="l00253"></a>00253 }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255 <span class="preprocessor">#</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span><span class="preprocessor">#  Perform the comparison, either using the checker supplied</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">#  by the answer evaluator, or the overloaded == operator.</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>
<a name="l00260"></a>00260 our $CMP_ERROR = 2;   # a fatal error was detected
<a name="l00261"></a>00261 our $CMP_WARNING = 3; # a warning was produced
<a name="l00262"></a>00262 our $CMP_MESSAGE = 4; # an message should be reported <span class="keywordflow">for</span> <span class="keyword">this</span> check
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 sub cmp_compare {
<a name="l00265"></a>00265   my $self = shift; my $other = shift; my $ans = shift; my $nth = shift || <span class="stringliteral">&#39;&#39;</span>;
<a name="l00266"></a>00266   my $context = (<a class="code" href="classValue.html#a43e6b7aa1e386a5a9056190d0ac3cbb3">Value::isValue</a>($self) ? $self-&gt;context : <a class="code" href="classValue.html">Value</a>-&gt;context);
<a name="l00267"></a>00267   <span class="keywordflow">return</span> eval {$self == $other} unless ref($ans-&gt;{checker}) eq <span class="stringliteral">&#39;CODE&#39;</span>;
<a name="l00268"></a>00268   my @equal = eval {&amp;{$ans-&gt;{checker}}($self,$other,$ans,$nth,@_)};
<a name="l00269"></a>00269   <span class="keywordflow">if</span> (!defined($equal) &amp;&amp; $@ ne <span class="stringliteral">&#39;&#39;</span> &amp;&amp; (!$context-&gt;{error}{flag} || $ans-&gt;{showAllErrors})) {
<a name="l00270"></a>00270     $nth = <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> ref($nth) eq &#39;<a class="code" href="classAnswerHash.html">AnswerHash</a>&#39;;
<a name="l00271"></a>00271     $context-&gt;setError([&quot;&lt;I&gt;An error occurred while checking your$nth answer:&lt;/I&gt;\n&quot;.
<a name="l00272"></a>00272       &#39;&lt;DIV STYLE=&quot;margin-left:1em&quot;&gt;%s&lt;/DIV&gt;&#39;,$@],&#39;&#39;,undef,undef,$CMP_ERROR);
<a name="l00273"></a>00273     warn &quot;Please inform your instructor that an error occurred while checking your answer&quot;;
<a name="l00274"></a>00274   }
<a name="l00275"></a>00275   return (wantarray ? @equal : $equal[0]);
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 sub cmp_list_compare {<a class="code" href="classValue_1_1List.html#a333c29345c87a65dd568f481b6d89135">Value::List::cmp_list_compare</a>(@_)}
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="preprocessor">#</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="preprocessor">#  Check if types are compatible for equality check</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span>sub typeMatch {
<a name="l00284"></a>00284   my $self = shift;  my $other = shift;
<a name="l00285"></a>00285   <span class="keywordflow">return</span> 1 unless ref($other);
<a name="l00286"></a>00286   $self-&gt;type eq $other-&gt;type &amp;&amp; !$other-&gt;isFormula;
<a name="l00287"></a>00287 }
<a name="l00288"></a>00288 
<a name="l00289"></a>00289 <span class="preprocessor">#</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span><span class="preprocessor">#  Class name for cmp error messages</span>
<a name="l00291"></a>00291 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span>sub cmp_class {
<a name="l00293"></a>00293   my $self = shift; my $ans = shift;
<a name="l00294"></a>00294   my $class = $self-&gt;showClass; $class =~ s/Real <span class="comment">//;</span>
<a name="l00295"></a>00295   <span class="keywordflow">return</span> $class <span class="keywordflow">if</span> $class =~ m/Formula/;
<a name="l00296"></a>00296   <span class="keywordflow">return</span> <span class="stringliteral">&quot;an Interval, Set or Union&quot;</span> <span class="keywordflow">if</span> $self-&gt;isSetOfReals;
<a name="l00297"></a>00297   <span class="keywordflow">return</span> $class;
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 <span class="preprocessor">#</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span><span class="preprocessor">#  Student answer evaluation failed.</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span><span class="preprocessor">#  Report the error, with formatting, if possible.</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00304"></a>00304 <span class="preprocessor"></span>sub cmp_error {
<a name="l00305"></a>00305   my $self = shift; my $ans = shift;
<a name="l00306"></a>00306   my $error = $self-&gt;context-&gt;{error};
<a name="l00307"></a>00307   my $message = $error-&gt;{message};
<a name="l00308"></a>00308   <span class="keywordflow">if</span> ($error-&gt;{pos}) {
<a name="l00309"></a>00309     my $string = $error-&gt;{<span class="keywordtype">string</span>};
<a name="l00310"></a>00310     my ($s,$e) = @{$error-&gt;{pos}};
<a name="l00311"></a>00311     $message =~ s/; see.*<span class="comment">//;  # remove the position from the message</span>
<a name="l00312"></a>00312     $ans-&gt;{student_ans} =
<a name="l00313"></a>00313        protectHTML(substr($string,0,$s)) .
<a name="l00314"></a>00314        <span class="stringliteral">&#39;&lt;SPAN CLASS=&quot;parsehilight&quot;&gt;&#39;</span> .
<a name="l00315"></a>00315          protectHTML(substr($string,$s,$e-$s)) .
<a name="l00316"></a>00316        <span class="stringliteral">&#39;&lt;/SPAN&gt;&#39;</span> .
<a name="l00317"></a>00317        protectHTML(substr($string,$e));
<a name="l00318"></a>00318   }
<a name="l00319"></a>00319   $self-&gt;cmp_Error($ans,$message);
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <span class="preprocessor">#</span>
<a name="l00323"></a>00323 <span class="preprocessor"></span><span class="preprocessor">#  Set the error message</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span>sub cmp_Error {
<a name="l00326"></a>00326   my $self = shift; my $ans = shift;
<a name="l00327"></a>00327   <span class="keywordflow">return</span> unless scalar(@_) &gt; 0;
<a name="l00328"></a>00328   $ans-&gt;score(0);
<a name="l00329"></a>00329   $ans-&gt;{ans_message} = $ans-&gt;{error_message} = join(<span class="stringliteral">&quot;\n&quot;</span>,@_);
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 <span class="preprocessor">#</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span><span class="preprocessor">#  Force a message into the results message column and die</span>
<a name="l00334"></a>00334 <span class="preprocessor"></span><span class="preprocessor">#  (To be used when overriding Parser classes that need</span>
<a name="l00335"></a>00335 <span class="preprocessor"></span><span class="preprocessor">#  to report errors to the student but can&#39;t do it in</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span><span class="preprocessor">#  the overridden == since errors are trapped.)</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span>sub cmp_Message {
<a name="l00339"></a>00339   my $message = shift; my $context = <a class="code" href="classValue.html">Value</a>-&gt;context;
<a name="l00340"></a>00340   $message = [$message,@_] <span class="keywordflow">if</span> scalar(@_) &gt; 0;
<a name="l00341"></a>00341   $context-&gt;setError($message,<span class="stringliteral">&#39;&#39;</span>,undef,undef,$CMP_MESSAGE);
<a name="l00342"></a>00342   $message = $context-&gt;{error}{message};
<a name="l00343"></a>00343   die $message . traceback() if $context-&gt;flags(&#39;showTraceback&#39;);
<a name="l00344"></a>00344   die $message . getCaller();
<a name="l00345"></a>00345 }
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 <span class="preprocessor">#</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span><span class="preprocessor">#  filled in by sub-classes</span>
<a name="l00349"></a>00349 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>sub cmp_preprocess {}
<a name="l00351"></a>00351 sub cmp_postprocess {}
<a name="l00352"></a>00352 
<a name="l00353"></a>00353 <span class="preprocessor">#</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span><span class="preprocessor">#  Check for unreduced reduced Unions and Sets</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00356"></a>00356 <span class="preprocessor"></span>sub cmp_checkUnionReduce {
<a name="l00357"></a>00357   my $self = shift; my $student = shift; my $ans = shift; my $nth = shift || <span class="stringliteral">&#39;&#39;</span>;
<a name="l00358"></a>00358   <span class="keywordflow">return</span> unless $ans-&gt;{studentsMustReduceUnions} &amp;&amp;
<a name="l00359"></a>00359                 $ans-&gt;{showUnionReduceWarnings} &amp;&amp;
<a name="l00360"></a>00360                 !$ans-&gt;{isPreview} &amp;&amp; !<a class="code" href="classValue.html#afa346ffc3c989970326e02766a63523a">Value::isFormula</a>($student);
<a name="l00361"></a>00361   <span class="keywordflow">return</span> unless $student-&gt;isSetOfReals;
<a name="l00362"></a>00362   my ($result,$error) = $student-&gt;isReduced;
<a name="l00363"></a>00363   <span class="keywordflow">return</span> unless $error;
<a name="l00364"></a>00364   <span class="keywordflow">return</span> {
<a name="l00365"></a>00365     <span class="stringliteral">&quot;overlaps&quot;</span> =&gt; <span class="stringliteral">&quot;Your$nth union contains overlapping intervals&quot;</span>,
<a name="l00366"></a>00366     <span class="stringliteral">&quot;overlaps in sets&quot;</span> =&gt; <span class="stringliteral">&quot;Your$nth union contains sets and intervals that overlap&quot;</span>,
<a name="l00367"></a>00367     <span class="stringliteral">&quot;uncombined intervals&quot;</span> =&gt; <span class="stringliteral">&quot;Your$nth union can be simplified by combining intervals&quot;</span>,
<a name="l00368"></a>00368     <span class="stringliteral">&quot;uncombined sets&quot;</span> =&gt; <span class="stringliteral">&quot;Your$nth union can be simplified by combining some sets&quot;</span>,
<a name="l00369"></a>00369     <span class="stringliteral">&quot;repeated elements in set&quot;</span> =&gt; <span class="stringliteral">&quot;Your$nth union contains sets with repeated elements&quot;</span>,
<a name="l00370"></a>00370     <span class="stringliteral">&quot;repeated elements&quot;</span> =&gt; <span class="stringliteral">&quot;Your$nth set should have no repeated elements&quot;</span>,
<a name="l00371"></a>00371   }-&gt;{$error};
<a name="l00372"></a>00372 }
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 <span class="preprocessor">#</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span><span class="preprocessor">#  create answer rules of various types</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span>sub ans_rule {shift; pgCall(<span class="stringliteral">&#39;ans_rule&#39;</span>,@_)}
<a name="l00378"></a>00378 sub named_ans_rule {shift; pgCall(<span class="stringliteral">&#39;NAMED_ANS_RULE&#39;</span>,@_)}
<a name="l00379"></a>00379 sub named_ans_rule_extension {shift; pgCall(<span class="stringliteral">&#39;NAMED_ANS_RULE_EXTENSION&#39;</span>,@_)}
<a name="l00380"></a>00380 sub ans_array {shift-&gt;ans_rule(@_)};
<a name="l00381"></a>00381 sub named_ans_array {shift-&gt;named_ans_rule(@_)};
<a name="l00382"></a>00382 sub named_ans_array_extension {shift-&gt;named_ans_rule_extension(@_)};
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 sub pgCall {my $call = shift; &amp;{<a class="code" href="classWeBWorK_1_1PG_1_1Translator.html#a887f17730aa20cca0b4ab1a30d2ddc1c">WeBWorK::PG::Translator::PG_restricted_eval</a>(<span class="charliteral">&#39;\&amp;&#39;</span>.$call)}(@_)}
<a name="l00385"></a>00385 sub pgRef {<a class="code" href="classWeBWorK_1_1PG_1_1Translator.html#a887f17730aa20cca0b4ab1a30d2ddc1c">WeBWorK::PG::Translator::PG_restricted_eval</a>(<span class="charliteral">&#39;\&amp;&#39;</span>.shift)}
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 our $answerPrefix = <span class="stringliteral">&quot;MaTrIx&quot;</span>;
<a name="l00388"></a>00388 
<a name="l00389"></a>00389 <span class="preprocessor">#</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span><span class="preprocessor">#  Lay out a matrix of answer rules</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span>sub ans_matrix {
<a name="l00393"></a>00393   my $self = shift;
<a name="l00394"></a>00394   my ($extend,$name,$rows,$cols,$size,$open,$close,$sep) = @_;
<a name="l00395"></a>00395 <span class="preprocessor">  #my $named_extension = pgRef(&#39;NAMED_ANS_RULE_EXTENSION&#39;);</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span>  my $named_extension = pgRef(<span class="stringliteral">&#39;NAMED_ANS_ARRAY_EXTENSION&#39;</span>);
<a name="l00397"></a>00397   my $new_name = sub {@_}; # pgRef(<span class="stringliteral">&#39;RECORD_EXTRA_ANSWERS&#39;</span>);
<a name="l00398"></a>00398   my $HTML = <span class="stringliteral">&quot;&quot;</span>; my $ename = $name;
<a name="l00399"></a>00399   <span class="keywordflow">if</span> ($name eq <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00400"></a>00400 <span class="preprocessor">    #my $n = pgCall(&#39;inc_ans_rule_count&#39;);</span>
<a name="l00401"></a>00401 <span class="preprocessor"></span>    $name = pgCall(<span class="stringliteral">&#39;NEW_ANS_NAME&#39;</span>,$n);
<a name="l00402"></a>00402 <span class="preprocessor">    #$name = pgCall(&#39;NEW_ARRAY_NAME&#39;,$n);</span>
<a name="l00403"></a>00403 <span class="preprocessor"></span>    $ename = <span class="stringliteral">&quot;${answerPrefix}_${name}_&quot;</span>;
<a name="l00404"></a>00404   }
<a name="l00405"></a>00405   $self-&gt;{ans_name} = $ename;
<a name="l00406"></a>00406   $self-&gt;{ans_rows} = $rows;
<a name="l00407"></a>00407   $self-&gt;{ans_cols} = $cols;
<a name="l00408"></a>00408   my @array = ();
<a name="l00409"></a>00409   <span class="keywordflow">foreach</span> my $i (0..$rows-1) {
<a name="l00410"></a>00410     my @row = ();
<a name="l00411"></a>00411     <span class="keywordflow">foreach</span> my $j (0..$cols-1) {
<a name="l00412"></a>00412       <span class="keywordflow">if</span> ($i == 0 &amp;&amp; $j == 0) {
<a name="l00413"></a>00413          <span class="keywordflow">if</span> ($extend) {
<a name="l00414"></a>00414             push(@row,&amp;$named_extension(&amp;$new_name($name),$size,ans_label=&gt;$name));
<a name="l00415"></a>00415 <span class="preprocessor">            #push(@row,&amp;$named_extension(&amp;$new_name($name),$size))</span>
<a name="l00416"></a>00416 <span class="preprocessor"></span>         }<span class="keywordflow">else</span> {
<a name="l00417"></a>00417             push(@row,pgCall(<span class="stringliteral">&#39;NAMED_ANS_RULE&#39;</span>,$name,$size))
<a name="l00418"></a>00418          }
<a name="l00419"></a>00419       } <span class="keywordflow">else</span> {
<a name="l00420"></a>00420         push(@row,&amp;$named_extension(&amp;$new_name(ANS_NAME($ename,$i,$j)),$size,ans_label=&gt;$name));
<a name="l00421"></a>00421 <span class="preprocessor">        #push(@row,&amp;$named_extension(&amp;$new_name(ANS_NAME($ename,$i,$j)),$size,ans_label=&gt;$name));</span>
<a name="l00422"></a>00422 <span class="preprocessor"></span>      }
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424     push(@array,[@row]);
<a name="l00425"></a>00425   }
<a name="l00426"></a>00426   $self-&gt;format_matrix([@array],open=&gt;$open,close=&gt;$close,sep=&gt;$sep);
<a name="l00427"></a>00427 }
<a name="l00428"></a>00428 
<a name="l00429"></a>00429 sub ANS_NAME {
<a name="l00430"></a>00430   my ($name,$i,$j) = @_;
<a name="l00431"></a>00431   $name.<span class="charliteral">&#39;_&#39;</span>.$i.<span class="charliteral">&#39;_&#39;</span>.$j;
<a name="l00432"></a>00432 }
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 <span class="preprocessor">#</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span><span class="preprocessor">#  Lay out an arbitrary matrix</span>
<a name="l00437"></a>00437 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>sub format_matrix {
<a name="l00439"></a>00439   my $self = shift; my $array = shift;
<a name="l00440"></a>00440   my $displayMode = $self-&gt;getPG(<span class="stringliteral">&#39;$displayMode&#39;</span>);
<a name="l00441"></a>00441   $array = [$array] unless ref($array-&gt;[0]) eq <span class="stringliteral">&#39;ARRAY&#39;</span>;
<a name="l00442"></a>00442   <span class="keywordflow">return</span> $self-&gt;format_matrix_tex($array,@_) <span class="keywordflow">if</span> ($displayMode eq <span class="stringliteral">&#39;TeX&#39;</span>);
<a name="l00443"></a>00443   <span class="keywordflow">return</span> $self-&gt;format_matrix_HTML($array,@_);
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 sub format_matrix_tex {
<a name="l00447"></a>00447   my $self = shift; my $array = shift;
<a name="l00448"></a>00448   my %options = (open=&gt;<span class="charliteral">&#39;.&#39;</span>,close=&gt;<span class="charliteral">&#39;.&#39;</span>,sep=&gt;<span class="stringliteral">&#39;&#39;</span>,@_);
<a name="l00449"></a>00449   $self-&gt;{format_options} = [%options] unless $self-&gt;{format_options};
<a name="l00450"></a>00450   my ($open,$close,$sep) = ($options{open},$options{close},$options{sep});
<a name="l00451"></a>00451   my ($rows,$cols) = (scalar(@{$array}),scalar(@{$array-&gt;[0]}));
<a name="l00452"></a>00452   my $tex = <span class="stringliteral">&quot;&quot;</span>; my @rows = ();
<a name="l00453"></a>00453   $open = <span class="charliteral">&#39;\\&#39;</span>.$open <span class="keywordflow">if</span> $open =~ m/[{}]/; $close = <span class="charliteral">&#39;\\&#39;</span>.$close <span class="keywordflow">if</span> $close =~ m/[{}]/;
<a name="l00454"></a>00454   $tex .= <span class="stringliteral">&#39;\(\left&#39;</span>.$open;
<a name="l00455"></a>00455   $tex .= <span class="stringliteral">&#39;\setlength{\arraycolsep}{2pt}&#39;</span>, $sep = <span class="charliteral">&#39;\,&#39;</span>.$sep <span class="keywordflow">if</span> $sep;
<a name="l00456"></a>00456   $tex .= <span class="stringliteral">&#39;\begin{array}{&#39;</span>.(<span class="charliteral">&#39;c&#39;</span>x$cols).<span class="charliteral">&#39;}&#39;</span>;
<a name="l00457"></a>00457   <span class="keywordflow">foreach</span> my $i (0..$rows-1) {push(@rows,join($sep.<span class="charliteral">&#39;&amp;&#39;</span>,@{$array-&gt;[$i]}))}
<a name="l00458"></a>00458   $tex .= join(<span class="stringliteral">&#39;\cr&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>,@rows);
<a name="l00459"></a>00459   $tex .= <span class="stringliteral">&#39;\end{array}\right&#39;</span>.$close.<span class="charliteral">&#39;\)&#39;</span>;
<a name="l00460"></a>00460   <span class="keywordflow">return</span> $tex;
<a name="l00461"></a>00461 }
<a name="l00462"></a>00462 
<a name="l00463"></a>00463 sub format_matrix_HTML {
<a name="l00464"></a>00464   my $self = shift; my $array = shift;
<a name="l00465"></a>00465   my %options = (open=&gt;<span class="stringliteral">&#39;&#39;</span>,close=&gt;<span class="stringliteral">&#39;&#39;</span>,sep=&gt;<span class="stringliteral">&#39;&#39;</span>,tth_delims=&gt;0,@_);
<a name="l00466"></a>00466   $self-&gt;{format_options} = [%options] unless $self-&gt;{format_options};
<a name="l00467"></a>00467   my ($open,$close,$sep) = ($options{open},$options{close},$options{sep});
<a name="l00468"></a>00468   my ($rows,$cols) = (scalar(@{$array}),scalar(@{$array-&gt;[0]}));
<a name="l00469"></a>00469   my $HTML = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00470"></a>00470   <span class="keywordflow">if</span> ($sep) {$sep = <span class="stringliteral">&#39;&lt;/TD&gt;&lt;TD STYLE=&quot;padding: 0px 1px&quot;&gt;&#39;</span>.$sep.<span class="stringliteral">&#39;&lt;/TD&gt;&lt;TD&gt;&#39;</span>}
<a name="l00471"></a>00471        <span class="keywordflow">else</span> {$sep = <span class="stringliteral">&#39;&lt;/TD&gt;&lt;TD WIDTH=&quot;8px&quot;&gt;&lt;/TD&gt;&lt;TD&gt;&#39;</span>}
<a name="l00472"></a>00472   <span class="keywordflow">foreach</span> my $i (0..$rows-1) {
<a name="l00473"></a>00473     $HTML .= <span class="stringliteral">&#39;&lt;TR&gt;&lt;TD HEIGHT=&quot;6px&quot;&gt;&lt;/TD&gt;&lt;/TR&gt;&#39;</span> <span class="keywordflow">if</span> $i;
<a name="l00474"></a>00474     $HTML .= <span class="stringliteral">&#39;&lt;TR ALIGN=&quot;MIDDLE&quot;&gt;&lt;TD&gt;&#39;</span>.join($sep,EVALUATE(@{$array-&gt;[$i]})).<span class="stringliteral">&#39;&lt;/TD&gt;&lt;/TR&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00475"></a>00475   }
<a name="l00476"></a>00476   $open = $self-&gt;format_delimiter($open,$rows,$options{tth_delims});
<a name="l00477"></a>00477   $close = $self-&gt;format_delimiter($close,$rows,$options{tth_delims});
<a name="l00478"></a>00478   <span class="keywordflow">if</span> ($open ne <span class="stringliteral">&#39;&#39;</span> || $close ne <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00479"></a>00479     $HTML = <span class="stringliteral">&#39;&lt;TR ALIGN=&quot;MIDDLE&quot;&gt;&#39;</span>
<a name="l00480"></a>00480           . <span class="stringliteral">&#39;&lt;TD&gt;&#39;</span>.$open.<span class="stringliteral">&#39;&lt;/TD&gt;&#39;</span>
<a name="l00481"></a>00481           . <span class="stringliteral">&#39;&lt;TD WIDTH=&quot;2&quot;&gt;&lt;/TD&gt;&#39;</span>
<a name="l00482"></a>00482           . <span class="stringliteral">&#39;&lt;TD&gt;&lt;TABLE BORDER=&quot;0&quot; CELLSPACING=&quot;0&quot; CELLPADDING=&quot;0&quot; CLASS=&quot;ArrayLayout&quot;&gt;&#39;</span>
<a name="l00483"></a>00483           .   $HTML
<a name="l00484"></a>00484           . <span class="stringliteral">&#39;&lt;/TABLE&gt;&lt;/TD&gt;&#39;</span>
<a name="l00485"></a>00485           . <span class="stringliteral">&#39;&lt;TD WIDTH=&quot;4&quot;&gt;&lt;/TD&gt;&#39;</span>
<a name="l00486"></a>00486           . <span class="stringliteral">&#39;&lt;TD&gt;&#39;</span>.$close.<span class="stringliteral">&#39;&lt;/TD&gt;&#39;</span>
<a name="l00487"></a>00487           . <span class="stringliteral">&#39;&lt;/TR&gt;&#39;</span>.<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00488"></a>00488   }
<a name="l00489"></a>00489   <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;TABLE BORDER=&quot;0&quot; CELLSPACING=&quot;0&quot; CELLPADDING=&quot;0&quot; CLASS=&quot;ArrayLayout&quot;&#39;</span>
<a name="l00490"></a>00490           . <span class="stringliteral">&#39; STYLE=&quot;display:inline;vertical-align:-&#39;</span>.(1.1*$rows-.6).<span class="stringliteral">&#39;em&quot;&gt;&#39;</span>
<a name="l00491"></a>00491           . $HTML
<a name="l00492"></a>00492           . <span class="stringliteral">&#39;&lt;/TABLE&gt;&#39;</span>;
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 sub EVALUATE {map {(<a class="code" href="classValue.html#afa346ffc3c989970326e02766a63523a">Value::isFormula</a>($_) &amp;&amp; $_-&gt;isConstant? $_-&gt;eval: $_)} @_}
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 sub VERBATIM {
<a name="l00498"></a>00498   my $string = shift;
<a name="l00499"></a>00499   my $displayMode = <a class="code" href="classValue.html">Value</a>-&gt;getPG(<span class="stringliteral">&#39;$displayMode&#39;</span>);
<a name="l00500"></a>00500   $string = <span class="stringliteral">&#39;\end{verbatim}&#39;</span>.$string.<span class="stringliteral">&#39;\begin{verbatim}&#39;</span> <span class="keywordflow">if</span> $displayMode eq <span class="stringliteral">&#39;TeX&#39;</span>;
<a name="l00501"></a>00501   <span class="keywordflow">return</span> $string;
<a name="l00502"></a>00502 }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 <span class="preprocessor">#</span>
<a name="l00505"></a>00505 <span class="preprocessor"></span><span class="preprocessor">#  Create a tall delimiter to match the line height</span>
<a name="l00506"></a>00506 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span>sub format_delimiter {
<a name="l00508"></a>00508   my $self = shift; my $delim = shift; my $rows = shift; my $tth = shift;
<a name="l00509"></a>00509   <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span> <span class="keywordflow">if</span> $delim eq <span class="stringliteral">&#39;&#39;</span> || $delim eq <span class="charliteral">&#39;.&#39;</span>;
<a name="l00510"></a>00510   my $displayMode = $self-&gt;getPG(<span class="stringliteral">&#39;$displayMode&#39;</span>);
<a name="l00511"></a>00511   <span class="keywordflow">return</span> $self-&gt;format_delimiter_tth($delim,$rows,$tth)
<a name="l00512"></a>00512     <span class="keywordflow">if</span> $tth || $displayMode eq <span class="stringliteral">&#39;HTML_tth&#39;</span> || $displayMode !~ m/^HTML_/;
<a name="l00513"></a>00513   my $rule = <span class="stringliteral">&#39;\vrule width 0pt height &#39;</span>.(.8*$rows).<span class="stringliteral">&#39;em depth 0pt&#39;</span>;
<a name="l00514"></a>00514   $rule = <span class="stringliteral">&#39;\Rule{0pt}{&#39;</span>.(.8*$rows).<span class="stringliteral">&#39;em}{0pt}&#39;</span> <span class="keywordflow">if</span> $displayMode eq <span class="stringliteral">&#39;HTML_MathJax&#39;</span>;
<a name="l00515"></a>00515   $rule = <span class="stringliteral">&#39;\rule 0pt &#39;</span>.(.8*$rows).<span class="stringliteral">&#39;em 0pt&#39;</span> <span class="keywordflow">if</span> $displayMode eq <span class="stringliteral">&#39;HTML_jsMath&#39;</span>;
<a name="l00516"></a>00516   $delim = <span class="charliteral">&#39;\\&#39;</span>.$delim <span class="keywordflow">if</span> $delim eq <span class="charliteral">&#39;{&#39;</span> || $delim eq <span class="charliteral">&#39;}&#39;</span>;
<a name="l00517"></a>00517   <span class="keywordflow">return</span> <span class="stringliteral">&#39;\(\left&#39;</span>.$delim.$rule.<span class="stringliteral">&#39;\right.\)&#39;</span>;
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="preprocessor">#</span>
<a name="l00521"></a>00521 <span class="preprocessor"></span><span class="preprocessor">#  Data for tth delimiters [top,mid,bot,rep]</span>
<a name="l00522"></a>00522 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span>$tth_family = <span class="stringliteral">&quot;symbol&quot;</span>;
<a name="l00524"></a>00524 my %tth_delim = (
<a name="l00525"></a>00525   <span class="charliteral">&#39;[&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x23A1;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23A3;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23A2;&#39;</span>],
<a name="l00526"></a>00526   <span class="charliteral">&#39;]&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x23A4;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23A6;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23A5;&#39;</span>],
<a name="l00527"></a>00527   <span class="charliteral">&#39;(&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x239B;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&amp;#x239D;&#39;</span>,<span class="stringliteral">&#39;&amp;#x239C;&#39;</span>],
<a name="l00528"></a>00528   <span class="charliteral">&#39;)&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x239E;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23A0;&#39;</span>,<span class="stringliteral">&#39;&amp;#x239F;&#39;</span>],
<a name="l00529"></a>00529   <span class="charliteral">&#39;{&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x23A7;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23A8;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23A9;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23AA;&#39;</span>],
<a name="l00530"></a>00530   <span class="charliteral">&#39;}&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x23AB;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23AC;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23AD;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23AA;&#39;</span>],
<a name="l00531"></a>00531   <span class="charliteral">&#39;|&#39;</span> =&gt; [<span class="charliteral">&#39;|&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="charliteral">&#39;|&#39;</span>,<span class="charliteral">&#39;|&#39;</span>],
<a name="l00532"></a>00532   <span class="charliteral">&#39;&lt;&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x27E8;&#39;</span>],
<a name="l00533"></a>00533   <span class="charliteral">&#39;&gt;&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x27E9;&#39;</span>],
<a name="l00534"></a>00534   <span class="stringliteral">&#39;\lgroup&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x23A7;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23A9;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23AA;&#39;</span>],
<a name="l00535"></a>00535   <span class="stringliteral">&#39;\rgroup&#39;</span> =&gt; [<span class="stringliteral">&#39;&amp;#x23AB;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23AD;&#39;</span>,<span class="stringliteral">&#39;&amp;#x23AA;&#39;</span>],
<a name="l00536"></a>00536 );
<a name="l00537"></a>00537 
<a name="l00538"></a>00538 <span class="preprocessor">#</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span><span class="preprocessor">#  Make delimiters as stacks of characters</span>
<a name="l00540"></a>00540 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span>sub format_delimiter_tth {
<a name="l00542"></a>00542   my $self = shift;
<a name="l00543"></a>00543   my $delim = shift; my $rows = shift; my $tth = shift;
<a name="l00544"></a>00544   <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span> <span class="keywordflow">if</span> $delim eq <span class="stringliteral">&#39;&#39;</span> || !defined($tth_delim{$delim});
<a name="l00545"></a>00545   my $c = $delim; $delim = $tth_delim{$delim};
<a name="l00546"></a>00546   $c = $delim-&gt;[0] <span class="keywordflow">if</span> scalar(@{$delim}) == 1;
<a name="l00547"></a>00547   my $size = ($tth? <span class="stringliteral">&quot;&quot;</span>: <span class="stringliteral">&quot;font-size:175%; &quot;</span>);
<a name="l00548"></a>00548   <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;SPAN STYLE=&quot;font-family: &#39;</span>.$tth_family.<span class="stringliteral">&#39;; &#39;</span>.$size.<span class="stringliteral">&#39;margin:0px 2px&quot;&gt;&#39;</span>.$c.<span class="stringliteral">&#39;&lt;/SPAN&gt;&#39;</span>
<a name="l00549"></a>00549     <span class="keywordflow">if</span> $rows == 1 || scalar(@{$delim}) == 1;
<a name="l00550"></a>00550   my $HTML = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00551"></a>00551   <span class="keywordflow">if</span> ($delim-&gt;[1] eq <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00552"></a>00552     $HTML = join(<span class="stringliteral">&#39;&lt;BR&gt;&#39;</span>,$delim-&gt;[0],($delim-&gt;[3])x(2*($rows-1)),$delim-&gt;[2]);
<a name="l00553"></a>00553   } <span class="keywordflow">else</span> {
<a name="l00554"></a>00554     $HTML = join(<span class="stringliteral">&#39;&lt;BR&gt;&#39;</span>,$delim-&gt;[0],($delim-&gt;[3])x($rows-1),
<a name="l00555"></a>00555                 $delim-&gt;[1],($delim-&gt;[3])x($rows-1),
<a name="l00556"></a>00556                 $delim-&gt;[2]);
<a name="l00557"></a>00557   }
<a name="l00558"></a>00558   <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;DIV STYLE=&quot;font-family: &#39;</span>.$tth_family.<span class="stringliteral">&#39;; line-height:90%; margin: 0px 2px&quot;&gt;&#39;</span>.$HTML.<span class="stringliteral">&#39;&lt;/DIV&gt;&#39;</span>;
<a name="l00559"></a>00559 }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 <span class="preprocessor">#</span>
<a name="l00563"></a>00563 <span class="preprocessor"></span><span class="preprocessor">#  Look up the values of the answer array entries, and check them</span>
<a name="l00564"></a>00564 <span class="preprocessor"></span><span class="preprocessor">#  for syntax and other errors.  Build the student answer</span>
<a name="l00565"></a>00565 <span class="preprocessor"></span><span class="preprocessor">#  based on these, and keep track of error messages.</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00567"></a>00567 <span class="preprocessor"></span>
<a name="l00568"></a>00568 my @ans_cmp_defaults = (showCoodinateHints =&gt; 0, checker =&gt; sub {0});
<a name="l00569"></a>00569 
<a name="l00570"></a>00570 sub ans_collect {
<a name="l00571"></a>00571   my $self = shift; my $ans = shift;
<a name="l00572"></a>00572   my $inputs = $self-&gt;getPG(<span class="stringliteral">&#39;$inputs_ref&#39;</span>);
<a name="l00573"></a>00573   my $blank = ($self-&gt;getPG(<span class="stringliteral">&#39;$displayMode&#39;</span>) eq <span class="stringliteral">&#39;TeX&#39;</span>) ? <span class="stringliteral">&#39;\_\_&#39;</span> : <span class="stringliteral">&#39;__&#39;</span>;
<a name="l00574"></a>00574   my ($rows,$cols) = ($self-&gt;{ans_rows},$self-&gt;{ans_cols});
<a name="l00575"></a>00575   my @array = (); my $data = [$self-&gt;value]; my $errors = []; my $OK = 1;
<a name="l00576"></a>00576   <span class="keywordflow">if</span> ($self-&gt;{ColumnVector}) {<span class="keywordflow">foreach</span> my $x (@{$data}) {$x = [$x]}}
<a name="l00577"></a>00577   $data = [$data] unless ref($data-&gt;[0]) eq &#39;ARRAY&#39;;
<a name="l00578"></a>00578   foreach my $i (0..$rows-1) {
<a name="l00579"></a>00579     my @row = (); my $entry;
<a name="l00580"></a>00580     <span class="keywordflow">foreach</span> my $j (0..$cols-1) {
<a name="l00581"></a>00581       <span class="keywordflow">if</span> ($i || $j) {
<a name="l00582"></a>00582     $entry = $inputs-&gt;{ANS_NAME($self-&gt;{ans_name},$i,$j)};
<a name="l00583"></a>00583       } <span class="keywordflow">else</span> {
<a name="l00584"></a>00584     $entry = $ans-&gt;{original_student_ans};
<a name="l00585"></a>00585     $ans-&gt;{student_formula} = $ans-&gt;{student_value} = undef unless $entry =~ m/\S/;
<a name="l00586"></a>00586       }
<a name="l00587"></a>00587       my $result = $data-&gt;[$i][$j]-&gt;cmp(@ans_cmp_defaults)-&gt;evaluate($entry);
<a name="l00588"></a>00588       $OK &amp;= entryCheck($result,$blank);
<a name="l00589"></a>00589       push(@row,$result-&gt;{student_formula});
<a name="l00590"></a>00590       entryMessage($result-&gt;{ans_message},$errors,$i,$j,$rows,$cols);
<a name="l00591"></a>00591     }
<a name="l00592"></a>00592     push(@array,[@row]);
<a name="l00593"></a>00593   }
<a name="l00594"></a>00594   $ans-&gt;{student_formula} = [@array];
<a name="l00595"></a>00595   $ans-&gt;{ans_message} = $ans-&gt;{error_message} = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00596"></a>00596   <span class="keywordflow">if</span> (scalar(@{$errors})) {
<a name="l00597"></a>00597     $ans-&gt;{ans_message} = $ans-&gt;{error_message} = 
<a name="l00598"></a>00598       <span class="stringliteral">&#39;&lt;TABLE BORDER=&quot;0&quot; CELLSPACING=&quot;0&quot; CELLPADDING=&quot;0&quot; CLASS=&quot;ArrayLayout&quot;&gt;&#39;</span>.
<a name="l00599"></a>00599       join(<span class="stringliteral">&#39;&lt;TR&gt;&lt;TD HEIGHT=&quot;4&quot;&gt;&lt;/TD&gt;&lt;/TR&gt;&#39;</span>,@{$errors}).
<a name="l00600"></a>00600       <span class="stringliteral">&#39;&lt;/TABLE&gt;&#39;</span>;
<a name="l00601"></a>00601     $OK = 0;
<a name="l00602"></a>00602   }
<a name="l00603"></a>00603   <span class="keywordflow">return</span> $OK;
<a name="l00604"></a>00604 }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606 sub entryMessage {
<a name="l00607"></a>00607   my $message = shift; <span class="keywordflow">return</span> unless $message;
<a name="l00608"></a>00608   my ($errors,$i,$j,$rows,$cols) = @_; $i++; $j++;
<a name="l00609"></a>00609   my $title;
<a name="l00610"></a>00610   <span class="keywordflow">if</span> ($rows == 1) {$title = <span class="stringliteral">&quot;In entry $j&quot;</span>}
<a name="l00611"></a>00611   elsif ($cols == 1) {$title = <span class="stringliteral">&quot;In entry $i&quot;</span>}
<a name="l00612"></a>00612   <span class="keywordflow">else</span> {$title = <span class="stringliteral">&quot;In entry ($i,$j)&quot;</span>}
<a name="l00613"></a>00613   push(@{$errors},<span class="stringliteral">&quot;&lt;TR VALIGN=\&quot;TOP\&quot;&gt;&lt;TD NOWRAP STYLE=\&quot;text-align:right; border:0px\&quot;&gt;&lt;I&gt;$title&lt;/I&gt;:&amp;nbsp;&lt;/TD&gt;&quot;</span>.
<a name="l00614"></a>00614                   <span class="stringliteral">&quot;&lt;TD STYLE=\&quot;text-align:left; border:0px\&quot;&gt;$message&lt;/TD&gt;&lt;/TR&gt;&quot;</span>);
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 sub entryCheck {
<a name="l00618"></a>00618   my $ans = shift; my $blank = shift;
<a name="l00619"></a>00619   <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> defined($ans-&gt;{student_value});
<a name="l00620"></a>00620   <span class="keywordflow">if</span> (!defined($ans-&gt;{student_formula})) {
<a name="l00621"></a>00621     $ans-&gt;{student_formula} = $ans-&gt;{student_ans};
<a name="l00622"></a>00622     $ans-&gt;{student_formula} = $blank unless $ans-&gt;{student_formula};
<a name="l00623"></a>00623   }
<a name="l00624"></a>00624   <span class="keywordflow">return</span> 0
<a name="l00625"></a>00625 }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627 
<a name="l00628"></a>00628 <span class="preprocessor">#</span>
<a name="l00629"></a>00629 <span class="preprocessor"></span><span class="preprocessor">#  Get and Set values in context</span>
<a name="l00630"></a>00630 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00631"></a>00631 <span class="preprocessor"></span>sub contextSet {
<a name="l00632"></a>00632   my $context = shift; my %<span class="keyword">set</span> = (@_);
<a name="l00633"></a>00633   my $flags = $context-&gt;{flags}; my $get = {};
<a name="l00634"></a>00634   <span class="keywordflow">foreach</span> my $id (keys %<span class="keyword">set</span>) {$get-&gt;{$id} = $flags-&gt;{$id}; $flags-&gt;{$id} = $set{$id}}
<a name="l00635"></a>00635   <span class="keywordflow">return</span> $get;
<a name="l00636"></a>00636 }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638 <span class="preprocessor">#</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span><span class="preprocessor">#  Quote HTML characters</span>
<a name="l00640"></a>00640 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00641"></a>00641 <span class="preprocessor"></span>sub protectHTML {
<a name="l00642"></a>00642   my $string = shift;
<a name="l00643"></a>00643   <span class="keywordflow">return</span> unless defined($string);
<a name="l00644"></a>00644   <span class="keywordflow">return</span> $string <span class="keywordflow">if</span> eval (<span class="stringliteral">&#39;$main::displayMode&#39;</span>) eq &#39;TeX&#39;;
<a name="l00645"></a>00645   $string =~ s/&amp;/\&amp;amp;/g;
<a name="l00646"></a>00646   $string =~ s/&lt;/\&amp;lt;/g;
<a name="l00647"></a>00647   $string =~ s/&gt;/\&amp;gt;/g;
<a name="l00648"></a>00648   $string;
<a name="l00649"></a>00649 }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651 <span class="preprocessor">#</span>
<a name="l00652"></a>00652 <span class="preprocessor"></span><span class="preprocessor">#  Convert newlines to &lt;BR&gt;</span>
<a name="l00653"></a>00653 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00654"></a>00654 <span class="preprocessor"></span>sub preformat {
<a name="l00655"></a>00655   my $string = protectHTML(shift);
<a name="l00656"></a>00656   $string =~ s!\n!&lt;br /&gt;!g unless eval(<span class="stringliteral">&#39;$main::displayMode&#39;</span>) eq &#39;TeX&#39;;
<a name="l00657"></a>00657   $string;
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 <span class="preprocessor">#</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span><span class="preprocessor">#  names for numbers</span>
<a name="l00662"></a>00662 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00663"></a>00663 <span class="preprocessor"></span>sub NameForNumber {
<a name="l00664"></a>00664   my $self = shift; my $n = shift;
<a name="l00665"></a>00665   my $name =  (<span class="stringliteral">&#39;zeroth&#39;</span>,<span class="stringliteral">&#39;first&#39;</span>,<span class="stringliteral">&#39;second&#39;</span>,<span class="stringliteral">&#39;third&#39;</span>,<span class="stringliteral">&#39;fourth&#39;</span>,<span class="stringliteral">&#39;fifth&#39;</span>,
<a name="l00666"></a>00666                <span class="stringliteral">&#39;sixth&#39;</span>,<span class="stringliteral">&#39;seventh&#39;</span>,<span class="stringliteral">&#39;eighth&#39;</span>,<span class="stringliteral">&#39;ninth&#39;</span>,<span class="stringliteral">&#39;tenth&#39;</span>)[$n];
<a name="l00667"></a>00667   $name = <span class="stringliteral">&quot;$n-th&quot;</span> <span class="keywordflow">if</span> ($n &gt; 10);
<a name="l00668"></a>00668   <span class="keywordflow">return</span> $name;
<a name="l00669"></a>00669 }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 <span class="preprocessor">#</span>
<a name="l00672"></a>00672 <span class="preprocessor"></span><span class="preprocessor">#  Get a value from the safe compartment</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00674"></a>00674 <span class="preprocessor"></span>sub getPG {
<a name="l00675"></a>00675   my $self = shift;
<a name="l00676"></a>00676 <span class="preprocessor">#  (WeBWorK::PG::Translator::PG_restricted_eval(shift))[0];</span>
<a name="l00677"></a>00677 <span class="preprocessor"></span>  eval (<span class="stringliteral">&#39;package main; &#39;</span>.shift);  # faster
<a name="l00678"></a>00678 }
<a name="l00679"></a>00679 
<a name="l00680"></a>00680 <span class="preprocessor">#############################################################</span>
<a name="l00681"></a>00681 <span class="preprocessor"></span><span class="preprocessor">#############################################################</span>
<a name="l00682"></a>00682 <span class="preprocessor"></span>
<a name="l00683"></a>00683 =head3 <a class="code" href="classValue_1_1Real.html">Value::Real</a>
<a name="l00684"></a>00684 
<a name="l00685"></a>00685     Usage <a class="code" href="PGstringevaluators_8pl.html#a33aa1133c9196fed55af79d192977ed3">ANS</a>( Real(3.56)-&gt;cmp() )
<a name="l00686"></a>00686         Compares response to a real value using &#39;fuzzy&#39; comparison
<a name="l00687"></a>00687         compareOptions and default values:
<a name="l00688"></a>00688               showTypeWarnings =&gt; 1,
<a name="l00689"></a>00689               showEqualErrors  =&gt; 1,
<a name="l00690"></a>00690               ignoreStrings    =&gt; 1,
<a name="l00691"></a>00691 
<a name="l00692"></a>00692 =cut
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 
<a name="l00695"></a>00695 package <a class="code" href="classValue.html">Value</a>::Real;
<a name="l00696"></a>00696 
<a name="l00697"></a>00697 sub cmp_defaults {(
<a name="l00698"></a>00698   shift-&gt;SUPER::cmp_defaults(@_),
<a name="l00699"></a>00699   ignoreInfinity =&gt; 1,
<a name="l00700"></a>00700 )}
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 sub typeMatch {
<a name="l00703"></a>00703   my $self = shift; my $other = shift; my $ans = shift;
<a name="l00704"></a>00704   <span class="keywordflow">return</span> 1 unless ref($other);
<a name="l00705"></a>00705   <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> <a class="code" href="classValue.html#afa346ffc3c989970326e02766a63523a">Value::isFormula</a>($other);
<a name="l00706"></a>00706   <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> $other-&gt;type eq <span class="stringliteral">&#39;Infinity&#39;</span> &amp;&amp; $ans-&gt;{ignoreInfinity};
<a name="l00707"></a>00707   $self-&gt;type eq $other-&gt;type;
<a name="l00708"></a>00708 }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710 <span class="preprocessor">#############################################################</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span>
<a name="l00712"></a>00712 <span class="keyword">package </span>Value::Infinity;
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 sub cmp_class {<span class="stringliteral">&#39;a Number&#39;</span>};
<a name="l00715"></a>00715 
<a name="l00716"></a>00716 sub typeMatch {
<a name="l00717"></a>00717   my $self = shift; my $other = shift; my $ans = shift;
<a name="l00718"></a>00718   <span class="keywordflow">return</span> 1 unless ref($other);
<a name="l00719"></a>00719   <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> <a class="code" href="classValue.html#afa346ffc3c989970326e02766a63523a">Value::isFormula</a>($other);
<a name="l00720"></a>00720   <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> $other-&gt;type eq <span class="stringliteral">&#39;Number&#39;</span>;
<a name="l00721"></a>00721   $self-&gt;type eq $other-&gt;type;
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00724"></a>00724 <span class="preprocessor">#############################################################</span>
<a name="l00725"></a>00725 <span class="preprocessor"></span>
<a name="l00726"></a>00726 =head3 <a class="code" href="classValue_1_1String.html">Value::String</a>
<a name="l00727"></a>00727 
<a name="l00728"></a>00728     Usage:  $s = String(<span class="stringliteral">&quot;pole&quot;</span>);
<a name="l00729"></a>00729         <a class="code" href="PGstringevaluators_8pl.html#a33aa1133c9196fed55af79d192977ed3">ANS</a>($s-&gt;cmp(typeMatch =&gt; <a class="code" href="classComplex.html">Complex</a>(<span class="stringliteral">&quot;4+i&quot;</span>)));
<a name="l00730"></a>00730 <span class="preprocessor">            # compare to response &#39;pole&#39;, don&#39;t complain about complex number responses.</span>
<a name="l00731"></a>00731 <span class="preprocessor"></span>
<a name="l00732"></a>00732         compareOptions and <span class="keywordflow">default</span> values:
<a name="l00733"></a>00733           showTypeWarnings =&gt; 1,
<a name="l00734"></a>00734           showEqualErrors  =&gt; 1,
<a name="l00735"></a>00735           ignoreStrings    =&gt; 1   # don<span class="stringliteral">&#39;t complain about string-valued responses</span>
<a name="l00736"></a>00736 <span class="stringliteral">          typeMatch        =&gt; &#39;</span><a class="code" href="classValue_1_1Real.html">Value::Real</a><span class="stringliteral">&#39;</span>
<a name="l00737"></a>00737 <span class="stringliteral"></span>
<a name="l00738"></a>00738 <span class="stringliteral">    Initial and final spaces are ignored when comparing strings.</span>
<a name="l00739"></a>00739 <span class="stringliteral"></span>
<a name="l00740"></a>00740 <span class="stringliteral">=cut</span>
<a name="l00741"></a>00741 <span class="stringliteral"></span>
<a name="l00742"></a>00742 <span class="stringliteral">package Value::String;</span>
<a name="l00743"></a>00743 <span class="stringliteral"></span>
<a name="l00744"></a>00744 <span class="stringliteral">sub cmp_defaults {(</span>
<a name="l00745"></a>00745 <span class="stringliteral">  Value::Real-&gt;cmp_defaults(@_),</span>
<a name="l00746"></a>00746 <span class="stringliteral">  typeMatch =&gt; &#39;</span><a class="code" href="classValue_1_1Real.html">Value::Real</a><span class="stringliteral">&#39;,</span>
<a name="l00747"></a>00747 <span class="stringliteral">)}</span>
<a name="l00748"></a>00748 <span class="stringliteral"></span>
<a name="l00749"></a>00749 <span class="stringliteral">sub cmp_class {</span>
<a name="l00750"></a>00750 <span class="stringliteral">  my $self = shift; my $ans = shift; my $typeMatch = $ans-&gt;{typeMatch};</span>
<a name="l00751"></a>00751 <span class="stringliteral">  return &#39;</span>a Word<span class="stringliteral">&#39; if !Value::isValue($typeMatch) || $typeMatch-&gt;classMatch(&#39;</span>String<span class="stringliteral">&#39;);</span>
<a name="l00752"></a>00752 <span class="stringliteral">  return $typeMatch-&gt;cmp_class;</span>
<a name="l00753"></a>00753 <span class="stringliteral">};</span>
<a name="l00754"></a>00754 <span class="stringliteral"></span>
<a name="l00755"></a>00755 <span class="stringliteral">sub typeMatch {</span>
<a name="l00756"></a>00756 <span class="stringliteral">  my $self = shift; my $other = shift; my $ans = shift;</span>
<a name="l00757"></a>00757 <span class="stringliteral">  my $typeMatch = $ans-&gt;{typeMatch};</span>
<a name="l00758"></a>00758 <span class="stringliteral">  return &amp;$typeMatch($other,$ans) if ref($typeMatch) eq &#39;</span>CODE<span class="stringliteral">&#39;;</span>
<a name="l00759"></a>00759 <span class="stringliteral">  return 1 if !Value::isValue($typeMatch) || $typeMatch-&gt;classMatch(&#39;</span>String<span class="stringliteral">&#39;) ||</span>
<a name="l00760"></a>00760 <span class="stringliteral">                 $self-&gt;type eq $other-&gt;type;</span>
<a name="l00761"></a>00761 <span class="stringliteral">  return $typeMatch-&gt;typeMatch($other,$ans);</span>
<a name="l00762"></a>00762 <span class="stringliteral">}</span>
<a name="l00763"></a>00763 <span class="stringliteral"></span>
<a name="l00764"></a>00764 <span class="stringliteral">#</span>
<a name="l00765"></a>00765 <span class="stringliteral">#  Remove the blank-check prefilter when the string is empty,</span>
<a name="l00766"></a>00766 <span class="stringliteral">#  and add a filter that removes leading and trailing whitespace.</span>
<a name="l00767"></a>00767 <span class="stringliteral">#</span>
<a name="l00768"></a>00768 <span class="stringliteral">sub cmp {</span>
<a name="l00769"></a>00769 <span class="stringliteral">  my $self = shift;</span>
<a name="l00770"></a>00770 <span class="stringliteral">  my $cmp = $self-&gt;SUPER::cmp(@_);</span>
<a name="l00771"></a>00771 <span class="stringliteral">  if ($self-&gt;value =~ m/^\s*$/) {</span>
<a name="l00772"></a>00772 <span class="stringliteral">    $cmp-&gt;install_pre_filter(&#39;</span>erase<span class="stringliteral">&#39;);</span>
<a name="l00773"></a>00773 <span class="stringliteral">    $cmp-&gt;install_pre_filter(sub {</span>
<a name="l00774"></a>00774 <span class="stringliteral">      my $ans = shift;</span>
<a name="l00775"></a>00775 <span class="stringliteral">      $ans-&gt;{student_ans} =~ s/^\s+//g;</span>
<a name="l00776"></a>00776 <span class="stringliteral">      $ans-&gt;{student_ans} =~ s/\s+$//g;</span>
<a name="l00777"></a>00777 <span class="stringliteral">      return $ans;</span>
<a name="l00778"></a>00778 <span class="stringliteral">    });</span>
<a name="l00779"></a>00779 <span class="stringliteral">  }</span>
<a name="l00780"></a>00780 <span class="stringliteral">  return $cmp;</span>
<a name="l00781"></a>00781 <span class="stringliteral">}</span>
<a name="l00782"></a>00782 <span class="stringliteral"></span>
<a name="l00783"></a>00783 <span class="stringliteral">#############################################################</span>
<a name="l00784"></a>00784 <span class="stringliteral"></span>
<a name="l00785"></a>00785 <span class="stringliteral">=head3 Value::Point</span>
<a name="l00786"></a>00786 <span class="stringliteral"></span>
<a name="l00787"></a>00787 <span class="stringliteral">    Usage: $pt = Point(&quot;(3,6)&quot;); # preferred</span>
<a name="l00788"></a>00788 <span class="stringliteral">           or $pt = Point(3,6);</span>
<a name="l00789"></a>00789 <span class="stringliteral">           or $pt = Point([3,6]);</span>
<a name="l00790"></a>00790 <span class="stringliteral">           ANS($pt-&gt;cmp());</span>
<a name="l00791"></a>00791 <span class="stringliteral"></span>
<a name="l00792"></a>00792 <span class="stringliteral">        compareOptions:</span>
<a name="l00793"></a>00793 <span class="stringliteral">          showTypeWarnings =&gt; 1,   # warns if student response is of incorrect type</span>
<a name="l00794"></a>00794 <span class="stringliteral">          showEqualErrors  =&gt; 1,</span>
<a name="l00795"></a>00795 <span class="stringliteral">          ignoreStrings    =&gt; 1,</span>
<a name="l00796"></a>00796 <span class="stringliteral">          showDimensionHints =&gt; 1, # reports incorrect number of coordinates</span>
<a name="l00797"></a>00797 <span class="stringliteral">          showCoordinateHints =&gt;1, # flags individual coordinates that are incorrect</span>
<a name="l00798"></a>00798 <span class="stringliteral"></span>
<a name="l00799"></a>00799 <span class="stringliteral">=cut</span>
<a name="l00800"></a>00800 <span class="stringliteral"></span>
<a name="l00801"></a>00801 <span class="stringliteral">package Value::Point;</span>
<a name="l00802"></a>00802 <span class="stringliteral"></span>
<a name="l00803"></a>00803 <span class="stringliteral">sub cmp_defaults {(</span>
<a name="l00804"></a>00804 <span class="stringliteral">  shift-&gt;SUPER::cmp_defaults(@_),</span>
<a name="l00805"></a>00805 <span class="stringliteral">  showDimensionHints =&gt; 1,</span>
<a name="l00806"></a>00806 <span class="stringliteral">  showCoordinateHints =&gt; 1,</span>
<a name="l00807"></a>00807 <span class="stringliteral">)}</span>
<a name="l00808"></a>00808 <span class="stringliteral"></span>
<a name="l00809"></a>00809 <span class="stringliteral">sub typeMatch {</span>
<a name="l00810"></a>00810 <span class="stringliteral">  my $self = shift; my $other = shift; my $ans = shift;</span>
<a name="l00811"></a>00811 <span class="stringliteral">  return ref($other) &amp;&amp; $other-&gt;type eq &#39;</span>Point<span class="stringliteral">&#39; &amp;&amp; !$other-&gt;isFormula;</span>
<a name="l00812"></a>00812 <span class="stringliteral">}</span>
<a name="l00813"></a>00813 <span class="stringliteral"></span>
<a name="l00814"></a>00814 <span class="stringliteral">#</span>
<a name="l00815"></a>00815 <span class="stringliteral">#  Check for dimension mismatch and incorrect coordinates</span>
<a name="l00816"></a>00816 <span class="stringliteral">#</span>
<a name="l00817"></a>00817 <span class="stringliteral">sub cmp_postprocess {</span>
<a name="l00818"></a>00818 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l00819"></a>00819 <span class="stringliteral">  return unless $ans-&gt;{score} == 0 &amp;&amp; !$ans-&gt;{isPreview};</span>
<a name="l00820"></a>00820 <span class="stringliteral">  my $student = $ans-&gt;{student_value};</span>
<a name="l00821"></a>00821 <span class="stringliteral">  return if $ans-&gt;{ignoreStrings} &amp;&amp; (!Value::isValue($student) || $student-&gt;type eq &#39;</span>String<span class="stringliteral">&#39;);</span>
<a name="l00822"></a>00822 <span class="stringliteral">  if ($ans-&gt;{showDimensionHints} &amp;&amp; $self-&gt;length != $student-&gt;length) {</span>
<a name="l00823"></a>00823 <span class="stringliteral">    $self-&gt;cmp_Error($ans,&quot;The number of coordinates is incorrect&quot;); return;</span>
<a name="l00824"></a>00824 <span class="stringliteral">  }</span>
<a name="l00825"></a>00825 <span class="stringliteral">  if ($ans-&gt;{showCoordinateHints}) {</span>
<a name="l00826"></a>00826 <span class="stringliteral">    my @errors;</span>
<a name="l00827"></a>00827 <span class="stringliteral">    foreach my $i (1..$self-&gt;length) {</span>
<a name="l00828"></a>00828 <span class="stringliteral">      push(@errors,&quot;The &quot;.$self-&gt;NameForNumber($i).&quot; coordinate is incorrect&quot;)</span>
<a name="l00829"></a>00829 <span class="stringliteral">    if ($self-&gt;{data}[$i-1] != $student-&gt;{data}[$i-1]);</span>
<a name="l00830"></a>00830 <span class="stringliteral">    }</span>
<a name="l00831"></a>00831 <span class="stringliteral">    $self-&gt;cmp_Error($ans,@errors); return;</span>
<a name="l00832"></a>00832 <span class="stringliteral">  }</span>
<a name="l00833"></a>00833 <span class="stringliteral">}</span>
<a name="l00834"></a>00834 <span class="stringliteral"></span>
<a name="l00835"></a>00835 <span class="stringliteral">sub correct_ans {</span>
<a name="l00836"></a>00836 <span class="stringliteral">  my $self = shift;</span>
<a name="l00837"></a>00837 <span class="stringliteral">  return $self-&gt;SUPER::correct_ans unless $self-&gt;{ans_name};</span>
<a name="l00838"></a>00838 <span class="stringliteral">  Value::VERBATIM($self-&gt;format_matrix([[@{$self-&gt;{data}}]],@{$self-&gt;{format_options}},tth_delims=&gt;1));</span>
<a name="l00839"></a>00839 <span class="stringliteral">}</span>
<a name="l00840"></a>00840 <span class="stringliteral"></span>
<a name="l00841"></a>00841 <span class="stringliteral">sub ANS_MATRIX {</span>
<a name="l00842"></a>00842 <span class="stringliteral">  my $self = shift;</span>
<a name="l00843"></a>00843 <span class="stringliteral">  my $extend = shift; my $name = shift;</span>
<a name="l00844"></a>00844 <span class="stringliteral">  my $size = shift || 5;</span>
<a name="l00845"></a>00845 <span class="stringliteral">  my $def = $self-&gt;context-&gt;lists-&gt;get(&#39;</span>Point<span class="stringliteral">&#39;);</span>
<a name="l00846"></a>00846 <span class="stringliteral">  my $open = $self-&gt;{open} || $def-&gt;{open}; my $close = $self-&gt;{close} || $def-&gt;{close};</span>
<a name="l00847"></a>00847 <span class="stringliteral">  $self-&gt;ans_matrix($extend,$name,1,$self-&gt;length,$size,$open,$close,&#39;</span>,<span class="stringliteral">&#39;);</span>
<a name="l00848"></a>00848 <span class="stringliteral">}</span>
<a name="l00849"></a>00849 <span class="stringliteral"></span>
<a name="l00850"></a>00850 <span class="stringliteral">sub ans_array {my $self = shift; $self-&gt;ANS_MATRIX(0,&#39;</span><span class="stringliteral">&#39;,@_)}</span>
<a name="l00851"></a>00851 <span class="stringliteral">sub named_ans_array {my $self = shift; $self-&gt;ANS_MATRIX(0,@_)}</span>
<a name="l00852"></a>00852 <span class="stringliteral">sub named_ans_array_extension {my $self = shift; $self-&gt;ANS_MATRIX(1,@_)}</span>
<a name="l00853"></a>00853 <span class="stringliteral"></span>
<a name="l00854"></a>00854 <span class="stringliteral">#############################################################</span>
<a name="l00855"></a>00855 <span class="stringliteral"></span>
<a name="l00856"></a>00856 <span class="stringliteral">=head3 Value::Vector</span>
<a name="l00857"></a>00857 <span class="stringliteral"></span>
<a name="l00858"></a>00858 <span class="stringliteral">    Usage:  $vec = Vector(&quot;&lt;3,6,7&gt;&quot;);</span>
<a name="l00859"></a>00859 <span class="stringliteral">            or $vec = Vector(3,6,7);</span>
<a name="l00860"></a>00860 <span class="stringliteral">            or $vec = Vector([3,6,7]);</span>
<a name="l00861"></a>00861 <span class="stringliteral">            ANS($vec-&gt;cmp());</span>
<a name="l00862"></a>00862 <span class="stringliteral"></span>
<a name="l00863"></a>00863 <span class="stringliteral">        compareOptions:</span>
<a name="l00864"></a>00864 <span class="stringliteral">          showTypeWarnings    =&gt; 1,   # warns if student response is of incorrect type</span>
<a name="l00865"></a>00865 <span class="stringliteral">          showEqualErrors     =&gt; 1,</span>
<a name="l00866"></a>00866 <span class="stringliteral">          ignoreStrings       =&gt; 1,</span>
<a name="l00867"></a>00867 <span class="stringliteral">          showDimensionHints  =&gt; 1, # reports incorrect number of coordinates</span>
<a name="l00868"></a>00868 <span class="stringliteral">          showCoordinateHints =&gt; 1, # flags individual coordinates which are incorrect</span>
<a name="l00869"></a>00869 <span class="stringliteral">          promotePoints       =&gt; 0, # allow students to enter vectors as points (3,5,6)</span>
<a name="l00870"></a>00870 <span class="stringliteral">          parallel            =&gt; 1, # response is correct if it is parallel to correct answer</span>
<a name="l00871"></a>00871 <span class="stringliteral">          sameDirection       =&gt; 1, # response is correct if it has same orientation as correct answer</span>
<a name="l00872"></a>00872 <span class="stringliteral">                                    #  (only has an effect when parallel =&gt; 1 is specified)</span>
<a name="l00873"></a>00873 <span class="stringliteral"></span>
<a name="l00874"></a>00874 <span class="stringliteral"></span>
<a name="l00875"></a>00875 <span class="stringliteral">=cut</span>
<a name="l00876"></a>00876 <span class="stringliteral"></span>
<a name="l00877"></a>00877 <span class="stringliteral">package Value::Vector;</span>
<a name="l00878"></a>00878 <span class="stringliteral"></span>
<a name="l00879"></a>00879 <span class="stringliteral">sub cmp_defaults {(</span>
<a name="l00880"></a>00880 <span class="stringliteral">  shift-&gt;SUPER::cmp_defaults(@_),</span>
<a name="l00881"></a>00881 <span class="stringliteral">  showDimensionHints =&gt; 1,</span>
<a name="l00882"></a>00882 <span class="stringliteral">  showCoordinateHints =&gt; 1,</span>
<a name="l00883"></a>00883 <span class="stringliteral">  promotePoints =&gt; 0,</span>
<a name="l00884"></a>00884 <span class="stringliteral">  parallel =&gt; 0,</span>
<a name="l00885"></a>00885 <span class="stringliteral">  sameDirection =&gt; 0,</span>
<a name="l00886"></a>00886 <span class="stringliteral">)}</span>
<a name="l00887"></a>00887 <span class="stringliteral"></span>
<a name="l00888"></a>00888 <span class="stringliteral">sub typeMatch {</span>
<a name="l00889"></a>00889 <span class="stringliteral">  my $self = shift; my $other = shift; my $ans = shift;</span>
<a name="l00890"></a>00890 <span class="stringliteral">  return 0 unless ref($other) &amp;&amp; !$other-&gt;isFormula;</span>
<a name="l00891"></a>00891 <span class="stringliteral">  return $other-&gt;type eq &#39;</span>Vector<span class="stringliteral">&#39; ||</span>
<a name="l00892"></a>00892 <span class="stringliteral">     ($ans-&gt;{promotePoints} &amp;&amp; $other-&gt;type eq &#39;</span>Point<span class="stringliteral">&#39;);</span>
<a name="l00893"></a>00893 <span class="stringliteral">}</span>
<a name="l00894"></a>00894 <span class="stringliteral"></span>
<a name="l00895"></a>00895 <span class="stringliteral">#</span>
<a name="l00896"></a>00896 <span class="stringliteral">#  check for dimension mismatch</span>
<a name="l00897"></a>00897 <span class="stringliteral">#        for parallel vectors, and</span>
<a name="l00898"></a>00898 <span class="stringliteral">#        for incorrect coordinates</span>
<a name="l00899"></a>00899 <span class="stringliteral">#</span>
<a name="l00900"></a>00900 <span class="stringliteral">sub cmp_postprocess {</span>
<a name="l00901"></a>00901 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l00902"></a>00902 <span class="stringliteral">  return unless $ans-&gt;{score} == 0 &amp;&amp; !$ans-&gt;{isPreview};</span>
<a name="l00903"></a>00903 <span class="stringliteral">  my $student = $ans-&gt;{student_value};</span>
<a name="l00904"></a>00904 <span class="stringliteral">  return if $ans-&gt;{ignoreStrings} &amp;&amp; (!Value::isValue($student) || $student-&gt;type eq &#39;</span>String<span class="stringliteral">&#39;);</span>
<a name="l00905"></a>00905 <span class="stringliteral">  if ($self-&gt;length != $student-&gt;length) {</span>
<a name="l00906"></a>00906 <span class="stringliteral">    ($self,$student) = $self-&gt;cmp_pad($student);</span>
<a name="l00907"></a>00907 <span class="stringliteral">    if ($ans-&gt;{showDimensionHints} &amp;&amp; $self-&gt;length != $student-&gt;length) {</span>
<a name="l00908"></a>00908 <span class="stringliteral">      $self-&gt;cmp_Error($ans,&quot;The number of coordinates is incorrect&quot;); return;</span>
<a name="l00909"></a>00909 <span class="stringliteral">    }</span>
<a name="l00910"></a>00910 <span class="stringliteral">  }</span>
<a name="l00911"></a>00911 <span class="stringliteral">  if ($ans-&gt;{parallel} &amp;&amp; !$student-&gt;isFormula &amp;&amp; !$student-&gt;classMatch(&#39;</span>String<span class="stringliteral">&#39;) &amp;&amp;</span>
<a name="l00912"></a>00912 <span class="stringliteral">      $self-&gt;isParallel($student,$ans-&gt;{sameDirection})) {</span>
<a name="l00913"></a>00913 <span class="stringliteral">    $ans-&gt;score(1); return;</span>
<a name="l00914"></a>00914 <span class="stringliteral">  }</span>
<a name="l00915"></a>00915 <span class="stringliteral">  if ($ans-&gt;{showCoordinateHints} &amp;&amp; !$ans-&gt;{parallel}) {</span>
<a name="l00916"></a>00916 <span class="stringliteral">    my @errors;</span>
<a name="l00917"></a>00917 <span class="stringliteral">    foreach my $i (1..$self-&gt;length) {</span>
<a name="l00918"></a>00918 <span class="stringliteral">      push(@errors,&quot;The &quot;.$self-&gt;NameForNumber($i).&quot; coordinate is incorrect&quot;)</span>
<a name="l00919"></a>00919 <span class="stringliteral">    if ($self-&gt;{data}[$i-1] != $student-&gt;{data}[$i-1]);</span>
<a name="l00920"></a>00920 <span class="stringliteral">    }</span>
<a name="l00921"></a>00921 <span class="stringliteral">    $self-&gt;cmp_Error($ans,@errors); return;</span>
<a name="l00922"></a>00922 <span class="stringliteral">  }</span>
<a name="l00923"></a>00923 <span class="stringliteral">}</span>
<a name="l00924"></a>00924 <span class="stringliteral"></span>
<a name="l00925"></a>00925 <span class="stringliteral">#</span>
<a name="l00926"></a>00926 <span class="stringliteral">#  Pad the student or correct answer if either is in ijk notation</span>
<a name="l00927"></a>00927 <span class="stringliteral">#  and they are not the same dimension.  Only add zeros when the other one</span>
<a name="l00928"></a>00928 <span class="stringliteral">#  also has zeros in those places.</span>
<a name="l00929"></a>00929 <span class="stringliteral">#</span>
<a name="l00930"></a>00930 <span class="stringliteral">sub cmp_pad {</span>
<a name="l00931"></a>00931 <span class="stringliteral">  my $self = shift; my $student = shift;</span>
<a name="l00932"></a>00932 <span class="stringliteral">  if (($self-&gt;getFlag(&quot;ijk&quot;) || $student-&gt;getFlag(&quot;ijk&quot;)) &amp;&amp; $self-&gt;getFlag(&quot;ijkAnyDimension&quot;)) {</span>
<a name="l00933"></a>00933 <span class="stringliteral">    $self = $self-&gt;copy; $student = $student-&gt;copy;</span>
<a name="l00934"></a>00934 <span class="stringliteral">    while ($self-&gt;length &gt; $student-&gt;length &amp;&amp; $self-&gt;{data}[$student-&gt;length] == 0)</span>
<a name="l00935"></a>00935 <span class="stringliteral">      {push(@{$student-&gt;{data}},Value::Real-&gt;new(0))}</span>
<a name="l00936"></a>00936 <span class="stringliteral">    while ($self-&gt;length &lt; $student-&gt;length &amp;&amp; $student-&gt;{data}[$self-&gt;length] == 0)</span>
<a name="l00937"></a>00937 <span class="stringliteral">      {push(@{$self-&gt;{data}},Value::Real-&gt;new(0))}</span>
<a name="l00938"></a>00938 <span class="stringliteral">  }</span>
<a name="l00939"></a>00939 <span class="stringliteral">  return ($self,$student);</span>
<a name="l00940"></a>00940 <span class="stringliteral">}</span>
<a name="l00941"></a>00941 <span class="stringliteral"></span>
<a name="l00942"></a>00942 <span class="stringliteral">sub correct_ans {</span>
<a name="l00943"></a>00943 <span class="stringliteral">  my $self = shift;</span>
<a name="l00944"></a>00944 <span class="stringliteral">  return $self-&gt;SUPER::correct_ans unless $self-&gt;{ans_name};</span>
<a name="l00945"></a>00945 <span class="stringliteral">  return Value::VERBATIM($self-&gt;format_matrix([[$self-&gt;value]],@{$self-&gt;{format_options}},tth_delims=&gt;1))</span>
<a name="l00946"></a>00946 <span class="stringliteral">    unless $self-&gt;{ColumnVector};</span>
<a name="l00947"></a>00947 <span class="stringliteral">  my @array = (); foreach my $x ($self-&gt;value) {push(@array,[$x])}</span>
<a name="l00948"></a>00948 <span class="stringliteral">  return Value::VERBATIM($self-&gt;format_matrix([@array],@{$self-&gt;{format_options}},tth_delims=&gt;1));</span>
<a name="l00949"></a>00949 <span class="stringliteral">}</span>
<a name="l00950"></a>00950 <span class="stringliteral"></span>
<a name="l00951"></a>00951 <span class="stringliteral">sub ANS_MATRIX {</span>
<a name="l00952"></a>00952 <span class="stringliteral">  my $self = shift;</span>
<a name="l00953"></a>00953 <span class="stringliteral">  my $extend = shift; my $name = shift;</span>
<a name="l00954"></a>00954 <span class="stringliteral">  my $size = shift || 5; my ($def,$open,$close);</span>
<a name="l00955"></a>00955 <span class="stringliteral">  $def = $self-&gt;context-&gt;lists-&gt;get(&#39;</span><a class="code" href="classMatrix.html">Matrix</a><span class="stringliteral">&#39;);</span>
<a name="l00956"></a>00956 <span class="stringliteral">  $open = $self-&gt;{open} || $def-&gt;{open}; $close = $self-&gt;{close} || $def-&gt;{close};</span>
<a name="l00957"></a>00957 <span class="stringliteral">  return $self-&gt;ans_matrix($extend,$name,$self-&gt;length,1,$size,$open,$close)</span>
<a name="l00958"></a>00958 <span class="stringliteral">    if ($self-&gt;{ColumnVector});</span>
<a name="l00959"></a>00959 <span class="stringliteral">  $def = $self-&gt;context-&gt;lists-&gt;get(&#39;</span>Vector<span class="stringliteral">&#39;);</span>
<a name="l00960"></a>00960 <span class="stringliteral">  $open = $self-&gt;{open} || $def-&gt;{open}; $close = $self-&gt;{close} || $def-&gt;{close};</span>
<a name="l00961"></a>00961 <span class="stringliteral">  $self-&gt;ans_matrix($extend,$name,1,$self-&gt;length,$size,$open,$close,&#39;</span>,<span class="stringliteral">&#39;);</span>
<a name="l00962"></a>00962 <span class="stringliteral">}</span>
<a name="l00963"></a>00963 <span class="stringliteral"></span>
<a name="l00964"></a>00964 <span class="stringliteral">sub ans_array {my $self = shift; $self-&gt;ANS_MATRIX(0,&#39;</span><span class="stringliteral">&#39;,@_)}</span>
<a name="l00965"></a>00965 <span class="stringliteral">sub named_ans_array {my $self = shift; $self-&gt;ANS_MATRIX(0,@_)}</span>
<a name="l00966"></a>00966 <span class="stringliteral">sub named_ans_array_extension {my $self = shift; $self-&gt;ANS_MATRIX(1,@_)}</span>
<a name="l00967"></a>00967 <span class="stringliteral"></span>
<a name="l00968"></a>00968 <span class="stringliteral"></span>
<a name="l00969"></a>00969 <span class="stringliteral">#############################################################</span>
<a name="l00970"></a>00970 <span class="stringliteral"></span>
<a name="l00971"></a>00971 <span class="stringliteral">=head3 Value::Matrix</span>
<a name="l00972"></a>00972 <span class="stringliteral"></span>
<a name="l00973"></a>00973 <span class="stringliteral">    Usage   $ma = Matrix([[3,6],[2,5]]) or $ma =Matrix([3,6],[2,5])</span>
<a name="l00974"></a>00974 <span class="stringliteral">            ANS($ma-&gt;cmp());</span>
<a name="l00975"></a>00975 <span class="stringliteral"></span>
<a name="l00976"></a>00976 <span class="stringliteral">        compareOptions:</span>
<a name="l00977"></a>00977 <span class="stringliteral"></span>
<a name="l00978"></a>00978 <span class="stringliteral">          showTypeWarnings    =&gt; 1, # warns if student response is of incorrect type</span>
<a name="l00979"></a>00979 <span class="stringliteral">          showEqualErrors     =&gt; 1, # reports messages that occur during element comparisons</span>
<a name="l00980"></a>00980 <span class="stringliteral">          ignoreStrings       =&gt; 1,</span>
<a name="l00981"></a>00981 <span class="stringliteral">          showDimensionHints  =&gt; 1, # reports incorrect number of coordinates</span>
<a name="l00982"></a>00982 <span class="stringliteral">          showCoordinateHints =&gt; 1, # flags individual coordinates which are incorrect</span>
<a name="l00983"></a>00983 <span class="stringliteral"></span>
<a name="l00984"></a>00984 <span class="stringliteral"></span>
<a name="l00985"></a>00985 <span class="stringliteral">=cut</span>
<a name="l00986"></a>00986 <span class="stringliteral"></span>
<a name="l00987"></a>00987 <span class="stringliteral">package Value::Matrix;</span>
<a name="l00988"></a>00988 <span class="stringliteral"></span>
<a name="l00989"></a>00989 <span class="stringliteral">sub cmp_defaults {(</span>
<a name="l00990"></a>00990 <span class="stringliteral">  shift-&gt;SUPER::cmp_defaults(@_),</span>
<a name="l00991"></a>00991 <span class="stringliteral">  showDimensionHints =&gt; 1,</span>
<a name="l00992"></a>00992 <span class="stringliteral">  showEqualErrors =&gt; 0,</span>
<a name="l00993"></a>00993 <span class="stringliteral">)}</span>
<a name="l00994"></a>00994 <span class="stringliteral"></span>
<a name="l00995"></a>00995 <span class="stringliteral">sub typeMatch {</span>
<a name="l00996"></a>00996 <span class="stringliteral">  my $self = shift; my $other = shift; my $ans = shift;</span>
<a name="l00997"></a>00997 <span class="stringliteral">  return 0 unless ref($other) &amp;&amp; !$other-&gt;isFormula;</span>
<a name="l00998"></a>00998 <span class="stringliteral">  return $other-&gt;type eq &#39;</span><a class="code" href="classMatrix.html">Matrix</a><span class="stringliteral">&#39; ||</span>
<a name="l00999"></a>00999 <span class="stringliteral">    ($other-&gt;type =~ m/^(Point|list)$/ &amp;&amp;</span>
<a name="l01000"></a>01000 <span class="stringliteral">     $other-&gt;{open}.$other-&gt;{close} eq $self-&gt;{open}.$self-&gt;{close});</span>
<a name="l01001"></a>01001 <span class="stringliteral">}</span>
<a name="l01002"></a>01002 <span class="stringliteral"></span>
<a name="l01003"></a>01003 <span class="stringliteral">sub cmp_preprocess {</span>
<a name="l01004"></a>01004 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l01005"></a>01005 <span class="stringliteral">  my $student = $ans-&gt;{student_value};</span>
<a name="l01006"></a>01006 <span class="stringliteral">  return if $student-&gt;type ne &#39;</span><a class="code" href="classMatrix.html">Matrix</a><span class="stringliteral">&#39;;</span>
<a name="l01007"></a>01007 <span class="stringliteral">  my @d1 = $self-&gt;dimensions; my @d2 = $student-&gt;dimensions;</span>
<a name="l01008"></a>01008 <span class="stringliteral">  $ans-&gt;{student_value} = $student-&gt;make([$student-&gt;value])</span>
<a name="l01009"></a>01009 <span class="stringliteral">    if (scalar(@d2) == 1 &amp;&amp; scalar(@d1) == 2);</span>
<a name="l01010"></a>01010 <span class="stringliteral">}</span>
<a name="l01011"></a>01011 <span class="stringliteral"></span>
<a name="l01012"></a>01012 <span class="stringliteral">sub cmp_postprocess {</span>
<a name="l01013"></a>01013 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l01014"></a>01014 <span class="stringliteral">  return unless $ans-&gt;{score} == 0 &amp;&amp;</span>
<a name="l01015"></a>01015 <span class="stringliteral">    !$ans-&gt;{isPreview} &amp;&amp; $ans-&gt;{showDimensionHints};</span>
<a name="l01016"></a>01016 <span class="stringliteral">  my $student = $ans-&gt;{student_value};</span>
<a name="l01017"></a>01017 <span class="stringliteral">  return if $ans-&gt;{ignoreStrings} &amp;&amp; (!Value::isValue($student) || $student-&gt;type eq &#39;</span>String<span class="stringliteral">&#39;);</span>
<a name="l01018"></a>01018 <span class="stringliteral">  my @d1 = $self-&gt;dimensions; my @d2 = $student-&gt;dimensions;</span>
<a name="l01019"></a>01019 <span class="stringliteral">  if (scalar(@d1) != scalar(@d2)) {</span>
<a name="l01020"></a>01020 <span class="stringliteral">    $self-&gt;cmp_Error($ans,&quot;Matrix dimension is not correct&quot;);</span>
<a name="l01021"></a>01021 <span class="stringliteral">    return;</span>
<a name="l01022"></a>01022 <span class="stringliteral">  } else {</span>
<a name="l01023"></a>01023 <span class="stringliteral">    foreach my $i (0..scalar(@d1)-1) {</span>
<a name="l01024"></a>01024 <span class="stringliteral">      if ($d1[$i] != $d2[$i]) {</span>
<a name="l01025"></a>01025 <span class="stringliteral">    $self-&gt;cmp_Error($ans,&quot;Matrix dimension is not correct&quot;);</span>
<a name="l01026"></a>01026 <span class="stringliteral">    return;</span>
<a name="l01027"></a>01027 <span class="stringliteral">      }</span>
<a name="l01028"></a>01028 <span class="stringliteral">    }</span>
<a name="l01029"></a>01029 <span class="stringliteral">  }</span>
<a name="l01030"></a>01030 <span class="stringliteral">}</span>
<a name="l01031"></a>01031 <span class="stringliteral"></span>
<a name="l01032"></a>01032 <span class="stringliteral">sub correct_ans {</span>
<a name="l01033"></a>01033 <span class="stringliteral">  my $self = shift;</span>
<a name="l01034"></a>01034 <span class="stringliteral">  return $self-&gt;SUPER::correct_ans unless $self-&gt;{ans_name};</span>
<a name="l01035"></a>01035 <span class="stringliteral">  my @array = $self-&gt;value; @array = ([@array]) if $self-&gt;isRow;</span>
<a name="l01036"></a>01036 <span class="stringliteral">  Value::VERBATIM($self-&gt;format_matrix([$self-&gt;value],@{$self-&gt;{format_options}},tth_delims=&gt;1));</span>
<a name="l01037"></a>01037 <span class="stringliteral">}</span>
<a name="l01038"></a>01038 <span class="stringliteral"></span>
<a name="l01039"></a>01039 <span class="stringliteral">sub ANS_MATRIX {</span>
<a name="l01040"></a>01040 <span class="stringliteral">  my $self = shift;</span>
<a name="l01041"></a>01041 <span class="stringliteral">  my $extend = shift; my $name = shift;</span>
<a name="l01042"></a>01042 <span class="stringliteral">  my $size = shift || 5;</span>
<a name="l01043"></a>01043 <span class="stringliteral">  my $def = $self-&gt;context-&gt;lists-&gt;get(&#39;</span><a class="code" href="classMatrix.html">Matrix</a><span class="stringliteral">&#39;);</span>
<a name="l01044"></a>01044 <span class="stringliteral">  my $open = $self-&gt;{open} || $def-&gt;{open}; my $close = $self-&gt;{close} || $def-&gt;{close};</span>
<a name="l01045"></a>01045 <span class="stringliteral">  my @d = $self-&gt;dimensions;</span>
<a name="l01046"></a>01046 <span class="stringliteral">  Value::Error(&quot;Can&#39;</span>t create ans_array <span class="keywordflow">for</span> %d-dimensional matrix<span class="stringliteral">&quot;,scalar(@d))</span>
<a name="l01047"></a>01047 <span class="stringliteral">    if (scalar(@d) &gt; 2);</span>
<a name="l01048"></a>01048 <span class="stringliteral">  @d = (1,@d) if (scalar(@d) == 1);</span>
<a name="l01049"></a>01049 <span class="stringliteral">  $self-&gt;ans_matrix($extend,$name,@d,$size,$open,$close,&#39;&#39;);</span>
<a name="l01050"></a>01050 <span class="stringliteral">}</span>
<a name="l01051"></a>01051 <span class="stringliteral"></span>
<a name="l01052"></a>01052 <span class="stringliteral">sub ans_array {my $self = shift; $self-&gt;ANS_MATRIX(0,&#39;&#39;,@_)}</span>
<a name="l01053"></a>01053 <span class="stringliteral">sub named_ans_array {my $self = shift; $self-&gt;ANS_MATRIX(0,@_)}</span>
<a name="l01054"></a>01054 <span class="stringliteral">sub named_ans_array_extension {my $self = shift; $self-&gt;ANS_MATRIX(1,@_)}</span>
<a name="l01055"></a>01055 <span class="stringliteral"></span>
<a name="l01056"></a>01056 <span class="stringliteral">#############################################################</span>
<a name="l01057"></a>01057 <span class="stringliteral"></span>
<a name="l01058"></a>01058 <span class="stringliteral">=head3   Value::Interval</span>
<a name="l01059"></a>01059 <span class="stringliteral"></span>
<a name="l01060"></a>01060 <span class="stringliteral">    Usage:    $interval = Interval(&quot;</span>(1,2]<span class="stringliteral">&quot;);</span>
<a name="l01061"></a>01061 <span class="stringliteral">              or $interval = Interval(&#39;(&#39;,1,2,&#39;]&#39;);</span>
<a name="l01062"></a>01062 <span class="stringliteral">              ANS($inteval-&gt;cmp);</span>
<a name="l01063"></a>01063 <span class="stringliteral"></span>
<a name="l01064"></a>01064 <span class="stringliteral">          compareOptions and defaults:</span>
<a name="l01065"></a>01065 <span class="stringliteral">            showTypeWarnings  =&gt; 1,</span>
<a name="l01066"></a>01066 <span class="stringliteral">            showEqualErrors   =&gt; 1,</span>
<a name="l01067"></a>01067 <span class="stringliteral">            ignoreStrings     =&gt; 1,</span>
<a name="l01068"></a>01068 <span class="stringliteral">            showEndpointHints =&gt; 1, # show hints about which end point values are correct</span>
<a name="l01069"></a>01069 <span class="stringliteral">            showEndTypeHints  =&gt; 1, # show hints about endpoint types</span>
<a name="l01070"></a>01070 <span class="stringliteral">            requireParenMatch =&gt; 1,</span>
<a name="l01071"></a>01071 <span class="stringliteral"></span>
<a name="l01072"></a>01072 <span class="stringliteral"></span>
<a name="l01073"></a>01073 <span class="stringliteral">=cut</span>
<a name="l01074"></a>01074 <span class="stringliteral"></span>
<a name="l01075"></a>01075 <span class="stringliteral">package Value::Interval;</span>
<a name="l01076"></a>01076 <span class="stringliteral"></span>
<a name="l01077"></a>01077 <span class="stringliteral">sub cmp_defaults {(</span>
<a name="l01078"></a>01078 <span class="stringliteral">  shift-&gt;SUPER::cmp_defaults(@_),</span>
<a name="l01079"></a>01079 <span class="stringliteral">  showEndpointHints =&gt; 1,</span>
<a name="l01080"></a>01080 <span class="stringliteral">  showEndTypeHints =&gt; 1,</span>
<a name="l01081"></a>01081 <span class="stringliteral">  requireParenMatch =&gt; 1,</span>
<a name="l01082"></a>01082 <span class="stringliteral">)}</span>
<a name="l01083"></a>01083 <span class="stringliteral"></span>
<a name="l01084"></a>01084 <span class="stringliteral">sub typeMatch {</span>
<a name="l01085"></a>01085 <span class="stringliteral">  my $self = shift; my $other = shift;</span>
<a name="l01086"></a>01086 <span class="stringliteral">  return 0 if !Value::isValue($other) || $other-&gt;isFormula;</span>
<a name="l01087"></a>01087 <span class="stringliteral">  return $other-&gt;canBeInUnion;</span>
<a name="l01088"></a>01088 <span class="stringliteral">}</span>
<a name="l01089"></a>01089 <span class="stringliteral"></span>
<a name="l01090"></a>01090 <span class="stringliteral">#</span>
<a name="l01091"></a>01091 <span class="stringliteral">#  Check for unreduced sets and unions</span>
<a name="l01092"></a>01092 <span class="stringliteral">#</span>
<a name="l01093"></a>01093 <span class="stringliteral">sub cmp_compare {</span>
<a name="l01094"></a>01094 <span class="stringliteral">  my $self = shift; my $student = shift; my $ans = shift;</span>
<a name="l01095"></a>01095 <span class="stringliteral">  my $error = $self-&gt;cmp_checkUnionReduce($student,$ans,@_);</span>
<a name="l01096"></a>01096 <span class="stringliteral">  if ($error) {$self-&gt;context-&gt;setError($error,&#39;&#39;,undef,undef,$CMP_WARNING); return}</span>
<a name="l01097"></a>01097 <span class="stringliteral">  $self-&gt;SUPER::cmp_compare($student,$ans,@_);</span>
<a name="l01098"></a>01098 <span class="stringliteral">}</span>
<a name="l01099"></a>01099 <span class="stringliteral"></span>
<a name="l01100"></a>01100 <span class="stringliteral">#</span>
<a name="l01101"></a>01101 <span class="stringliteral">#  Check for wrong enpoints and wrong type of endpoints</span>
<a name="l01102"></a>01102 <span class="stringliteral">#</span>
<a name="l01103"></a>01103 <span class="stringliteral">sub cmp_postprocess {</span>
<a name="l01104"></a>01104 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l01105"></a>01105 <span class="stringliteral">  return unless $ans-&gt;{score} == 0 &amp;&amp; !$ans-&gt;{isPreview};</span>
<a name="l01106"></a>01106 <span class="stringliteral">  my $other = $ans-&gt;{student_value};</span>
<a name="l01107"></a>01107 <span class="stringliteral">  return if $ans-&gt;{ignoreStrings} &amp;&amp; (!Value::isValue($other) || $other-&gt;type eq &#39;String&#39;);</span>
<a name="l01108"></a>01108 <span class="stringliteral">  return unless $other-&gt;classMatch(&#39;Interval&#39;);</span>
<a name="l01109"></a>01109 <span class="stringliteral">  my @errors;</span>
<a name="l01110"></a>01110 <span class="stringliteral">  if ($ans-&gt;{showEndpointHints}) {</span>
<a name="l01111"></a>01111 <span class="stringliteral">    push(@errors,&quot;</span>Your left endpoint is incorrect<span class="stringliteral">&quot;)</span>
<a name="l01112"></a>01112 <span class="stringliteral">      if ($self-&gt;{data}[0] != $other-&gt;{data}[0]);</span>
<a name="l01113"></a>01113 <span class="stringliteral">    push(@errors,&quot;</span>Your right endpoint is incorrect<span class="stringliteral">&quot;)</span>
<a name="l01114"></a>01114 <span class="stringliteral">      if ($self-&gt;{data}[1] != $other-&gt;{data}[1]);</span>
<a name="l01115"></a>01115 <span class="stringliteral">  }</span>
<a name="l01116"></a>01116 <span class="stringliteral">  if (scalar(@errors) == 0 &amp;&amp; $ans-&gt;{showEndTypeHints} &amp;&amp; $ans-&gt;{requireParenMatch}) {</span>
<a name="l01117"></a>01117 <span class="stringliteral">    push(@errors,&quot;</span>The type of interval is incorrect<span class="stringliteral">&quot;)</span>
<a name="l01118"></a>01118 <span class="stringliteral">      if ($self-&gt;{open}.$self-&gt;{close} ne $other-&gt;{open}.$other-&gt;{close});</span>
<a name="l01119"></a>01119 <span class="stringliteral">  }</span>
<a name="l01120"></a>01120 <span class="stringliteral">  $self-&gt;cmp_Error($ans,@errors);</span>
<a name="l01121"></a>01121 <span class="stringliteral">}</span>
<a name="l01122"></a>01122 <span class="stringliteral"></span>
<a name="l01123"></a>01123 <span class="stringliteral">#############################################################</span>
<a name="l01124"></a>01124 <span class="stringliteral"></span>
<a name="l01125"></a>01125 <span class="stringliteral">=head3 Value::Set</span>
<a name="l01126"></a>01126 <span class="stringliteral"></span>
<a name="l01127"></a>01127 <span class="stringliteral">    Usage:   $set = Set(5,6,&#39;a&#39;, &#39;b&#39;)</span>
<a name="l01128"></a>01128 <span class="stringliteral">          or $set = Set(&quot;</span>{5, 6, a, b}<span class="stringliteral">&quot;)</span>
<a name="l01129"></a>01129 <span class="stringliteral"></span>
<a name="l01130"></a>01130 <span class="stringliteral">          The object is a finite set of real numbers. It can be used with Union and</span>
<a name="l01131"></a>01131 <span class="stringliteral">          Interval.</span>
<a name="l01132"></a>01132 <span class="stringliteral"></span>
<a name="l01133"></a>01133 <span class="stringliteral">    Examples:  Interval(&quot;</span>(-inf,inf)<span class="stringliteral">&quot;) - Set(0)</span>
<a name="l01134"></a>01134 <span class="stringliteral">               Compute(&quot;</span>R-{0}<span class="stringliteral">&quot;)   # in Interval context: Context(&quot;</span>Interval<span class="stringliteral">&quot;);</span>
<a name="l01135"></a>01135 <span class="stringliteral"></span>
<a name="l01136"></a>01136 <span class="stringliteral">=cut</span>
<a name="l01137"></a>01137 <span class="stringliteral"></span>
<a name="l01138"></a>01138 <span class="stringliteral">package Value::Set;</span>
<a name="l01139"></a>01139 <span class="stringliteral"></span>
<a name="l01140"></a>01140 <span class="stringliteral">sub typeMatch {</span>
<a name="l01141"></a>01141 <span class="stringliteral">  my $self = shift; my $other = shift;</span>
<a name="l01142"></a>01142 <span class="stringliteral">  return 0 if !Value::isValue($other) || $other-&gt;isFormula;</span>
<a name="l01143"></a>01143 <span class="stringliteral">  return $other-&gt;canBeInUnion;</span>
<a name="l01144"></a>01144 <span class="stringliteral">}</span>
<a name="l01145"></a>01145 <span class="stringliteral"></span>
<a name="l01146"></a>01146 <span class="stringliteral">#</span>
<a name="l01147"></a>01147 <span class="stringliteral">#  Use the List checker for sets, in order to get</span>
<a name="l01148"></a>01148 <span class="stringliteral">#  partial credit.  Set the various types for error</span>
<a name="l01149"></a>01149 <span class="stringliteral">#  messages.</span>
<a name="l01150"></a>01150 <span class="stringliteral">#</span>
<a name="l01151"></a>01151 <span class="stringliteral">sub cmp_defaults {(</span>
<a name="l01152"></a>01152 <span class="stringliteral">  Value::List::cmp_defaults(@_),</span>
<a name="l01153"></a>01153 <span class="stringliteral">  typeMatch =&gt; &#39;Value::Real&#39;,</span>
<a name="l01154"></a>01154 <span class="stringliteral">  list_type =&gt; &#39;a set&#39;,</span>
<a name="l01155"></a>01155 <span class="stringliteral">  entry_type =&gt; &#39;a number&#39;,</span>
<a name="l01156"></a>01156 <span class="stringliteral">  removeParens =&gt; 0,</span>
<a name="l01157"></a>01157 <span class="stringliteral">  showParenHints =&gt; 1,</span>
<a name="l01158"></a>01158 <span class="stringliteral">  implicitList =&gt; 0,</span>
<a name="l01159"></a>01159 <span class="stringliteral">)}</span>
<a name="l01160"></a>01160 <span class="stringliteral"></span>
<a name="l01161"></a>01161 <span class="stringliteral">#</span>
<a name="l01162"></a>01162 <span class="stringliteral">#  Use the list checker if the student answer is a set</span>
<a name="l01163"></a>01163 <span class="stringliteral">#    otherwise use the standard compare (to get better</span>
<a name="l01164"></a>01164 <span class="stringliteral">#    error messages).</span>
<a name="l01165"></a>01165 <span class="stringliteral">#</span>
<a name="l01166"></a>01166 <span class="stringliteral">sub cmp_equal {</span>
<a name="l01167"></a>01167 <span class="stringliteral">  my ($self,$ans) = @_;</span>
<a name="l01168"></a>01168 <span class="stringliteral">  return $self-&gt;SUPER::cmp_equal($ans) unless $ans-&gt;{student_value}-&gt;type eq &#39;Set&#39;;</span>
<a name="l01169"></a>01169 <span class="stringliteral">  my $error = $self-&gt;cmp_checkUnionReduce($ans-&gt;{student_value},$ans);</span>
<a name="l01170"></a>01170 <span class="stringliteral">  if ($error) {$self-&gt;cmp_Error($ans,$error); return}</span>
<a name="l01171"></a>01171 <span class="stringliteral">  return Value::List::cmp_equal(@_);</span>
<a name="l01172"></a>01172 <span class="stringliteral">}</span>
<a name="l01173"></a>01173 <span class="stringliteral"></span>
<a name="l01174"></a>01174 <span class="stringliteral">#</span>
<a name="l01175"></a>01175 <span class="stringliteral">#  Check for unreduced sets and unions</span>
<a name="l01176"></a>01176 <span class="stringliteral">#</span>
<a name="l01177"></a>01177 <span class="stringliteral">sub cmp_compare {</span>
<a name="l01178"></a>01178 <span class="stringliteral">  my $self = shift; my $student = shift; my $ans = shift;</span>
<a name="l01179"></a>01179 <span class="stringliteral">  my $error = $self-&gt;cmp_checkUnionReduce($student,$ans,@_);</span>
<a name="l01180"></a>01180 <span class="stringliteral">  if ($error) {$self-&gt;context-&gt;setError($error,&#39;&#39;,undef,undef,$CMP_WARNING); return}</span>
<a name="l01181"></a>01181 <span class="stringliteral">  $self-&gt;SUPER::cmp_compare($student,$ans,@_);</span>
<a name="l01182"></a>01182 <span class="stringliteral">}</span>
<a name="l01183"></a>01183 <span class="stringliteral"></span>
<a name="l01184"></a>01184 <span class="stringliteral">#############################################################</span>
<a name="l01185"></a>01185 <span class="stringliteral"></span>
<a name="l01186"></a>01186 <span class="stringliteral">=head3 Value::Union</span>
<a name="l01187"></a>01187 <span class="stringliteral"></span>
<a name="l01188"></a>01188 <span class="stringliteral">    Usage: $union = Union(&quot;</span>[4,5] U [6,7]<span class="stringliteral">&quot;);</span>
<a name="l01189"></a>01189 <span class="stringliteral">           or $union = Union(Interval(&quot;</span>[4,5]<span class="stringliteral">&quot;,Interval(&quot;</span>[6,7]<span class="stringliteral">&quot;));</span>
<a name="l01190"></a>01190 <span class="stringliteral">           ANS($union-&gt;cmp());</span>
<a name="l01191"></a>01191 <span class="stringliteral"></span>
<a name="l01192"></a>01192 <span class="stringliteral"></span>
<a name="l01193"></a>01193 <span class="stringliteral">=cut</span>
<a name="l01194"></a>01194 <span class="stringliteral"></span>
<a name="l01195"></a>01195 <span class="stringliteral">package Value::Union;</span>
<a name="l01196"></a>01196 <span class="stringliteral"></span>
<a name="l01197"></a>01197 <span class="stringliteral">sub typeMatch {</span>
<a name="l01198"></a>01198 <span class="stringliteral">  my $self = shift; my $other = shift;</span>
<a name="l01199"></a>01199 <span class="stringliteral">  return 0 unless ref($other) &amp;&amp; !$other-&gt;isFormula;</span>
<a name="l01200"></a>01200 <span class="stringliteral">  return $other-&gt;length == 2 &amp;&amp;</span>
<a name="l01201"></a>01201 <span class="stringliteral">         ($other-&gt;{open} eq &#39;(&#39; || $other-&gt;{open} eq &#39;[&#39;) &amp;&amp;</span>
<a name="l01202"></a>01202 <span class="stringliteral">         ($other-&gt;{close} eq &#39;)&#39; || $other-&gt;{close} eq &#39;]&#39;)</span>
<a name="l01203"></a>01203 <span class="stringliteral">       if $other-&gt;type =~ m/^(Point|List)$/;</span>
<a name="l01204"></a>01204 <span class="stringliteral">  $other-&gt;isSetOfReals;</span>
<a name="l01205"></a>01205 <span class="stringliteral">}</span>
<a name="l01206"></a>01206 <span class="stringliteral"></span>
<a name="l01207"></a>01207 <span class="stringliteral">#</span>
<a name="l01208"></a>01208 <span class="stringliteral">#  Use the List checker for unions, in order to get</span>
<a name="l01209"></a>01209 <span class="stringliteral">#  partial credit.  Set the various types for error</span>
<a name="l01210"></a>01210 <span class="stringliteral">#  messages.</span>
<a name="l01211"></a>01211 <span class="stringliteral">#</span>
<a name="l01212"></a>01212 <span class="stringliteral">my $typeMatchInterval = Value::Interval-&gt;make(0,1);</span>
<a name="l01213"></a>01213 <span class="stringliteral">sub cmp_defaults {(</span>
<a name="l01214"></a>01214 <span class="stringliteral">  Value::List::cmp_defaults(@_),</span>
<a name="l01215"></a>01215 <span class="stringliteral">  typeMatch =&gt; $typeMatchInterval,</span>
<a name="l01216"></a>01216 <span class="stringliteral">  list_type =&gt; &#39;an interval, set or union&#39;,</span>
<a name="l01217"></a>01217 <span class="stringliteral">  short_type =&gt; &#39;a union&#39;,</span>
<a name="l01218"></a>01218 <span class="stringliteral">  entry_type =&gt; &#39;an interval or set&#39;,</span>
<a name="l01219"></a>01219 <span class="stringliteral">)}</span>
<a name="l01220"></a>01220 <span class="stringliteral"></span>
<a name="l01221"></a>01221 <span class="stringliteral">sub cmp_equal {</span>
<a name="l01222"></a>01222 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l01223"></a>01223 <span class="stringliteral">  my $error = $self-&gt;cmp_checkUnionReduce($ans-&gt;{student_value},$ans);</span>
<a name="l01224"></a>01224 <span class="stringliteral">  if ($error) {$self-&gt;cmp_Error($ans,$error); return}</span>
<a name="l01225"></a>01225 <span class="stringliteral">  Value::List::cmp_equal($self,$ans);</span>
<a name="l01226"></a>01226 <span class="stringliteral">}</span>
<a name="l01227"></a>01227 <span class="stringliteral"></span>
<a name="l01228"></a>01228 <span class="stringliteral">#</span>
<a name="l01229"></a><a class="code" href="classValue_1_1Real.html">01229</a> <span class="stringliteral">#  Check for unreduced sets and unions</span>
<a name="l01230"></a>01230 <span class="stringliteral">#</span>
<a name="l01231"></a>01231 <span class="stringliteral">sub cmp_compare {</span>
<a name="l01232"></a>01232 <span class="stringliteral">  my $self = shift; my $student = shift; my $ans = shift;</span>
<a name="l01233"></a>01233 <span class="stringliteral">  my $error = $self-&gt;cmp_checkUnionReduce($student,$ans,@_);</span>
<a name="l01234"></a>01234 <span class="stringliteral">  if ($error) {$self-&gt;context-&gt;setError($error,&#39;&#39;,undef,undef,$CMP_WARNING); return}</span>
<a name="l01235"></a>01235 <span class="stringliteral">  $self-&gt;SUPER::cmp_compare($student,$ans,@_);</span>
<a name="l01236"></a>01236 <span class="stringliteral">}</span>
<a name="l01237"></a>01237 <span class="stringliteral"></span>
<a name="l01238"></a>01238 <span class="stringliteral">#############################################################</span>
<a name="l01239"></a>01239 <span class="stringliteral"></span>
<a name="l01240"></a>01240 <span class="stringliteral">=head3 Value::List</span>
<a name="l01241"></a>01241 <span class="stringliteral"></span>
<a name="l01242"></a>01242 <span class="stringliteral">    Usage:  $lst = List(&quot;</span>1, x, &lt;4,5,6&gt;<span class="stringliteral">&quot;); # list of a real, a formula and a vector.</span>
<a name="l01243"></a>01243 <span class="stringliteral">            or $lst = List(Real(1), Formula(&quot;</span>x<span class="stringliteral">&quot;), Vector(4,5,6));</span>
<a name="l01244"></a>01244 <span class="stringliteral">            ANS($lst-&gt;cmp(showHints=&gt;1));</span>
<a name="l01245"></a>01245 <span class="stringliteral"></span>
<a name="l01246"></a>01246 <span class="stringliteral">        compareOptions and defaults:</span>
<a name="l01247"></a>01247 <span class="stringliteral">            showTypeWarnings =&gt; 1,</span>
<a name="l01248"></a>01248 <span class="stringliteral">            showEqualErrors  =&gt; 1,         # show errors produced when checking equality of entries</span>
<a name="l01249"></a>01249 <span class="stringliteral">            ignoreStrings    =&gt; 1,         # don&#39;t show type warnings for strings</span>
<a name="l01250"></a>01250 <span class="stringliteral">            studentsMustReduceUnions =&gt; 1,</span>
<a name="l01251"></a>01251 <span class="stringliteral">            showUnionReduceWarnings =&gt; 1,</span>
<a name="l01252"></a>01252 <span class="stringliteral">            showHints =&gt; undef,            # automatically set to 1 if $showPartialCorrectAnswers == 1</span>
<a name="l01253"></a>01253 <span class="stringliteral">            showLengthHints =&gt; undef,      # automatically set to 1 if $showPartialCorrectAnswers == 1</span>
<a name="l01254"></a>01254 <span class="stringliteral">            showParenHints =&gt; undef,       # automatically set to 1 if $showPartialCorrectAnswers == 1</span>
<a name="l01255"></a>01255 <span class="stringliteral">            partialCredit =&gt; undef,        # automatically set to 1 if $showPartialCorrectAnswers == 1</span>
<a name="l01256"></a>01256 <span class="stringliteral">            ordered =&gt; 0,                  # 1 = must be in same order as correct answer</span>
<a name="l01257"></a>01257 <span class="stringliteral">            entry_type =&gt; undef,           # determined from first entry</span>
<a name="l01258"></a>01258 <span class="stringliteral">            list_type =&gt; undef,            # determined automatically</span>
<a name="l01259"></a>01259 <span class="stringliteral">            typeMatch =&gt; $element,         # used for type checking the entries</span>
<a name="l01260"></a>01260 <span class="stringliteral">            firstElement =&gt; $element,</span>
<a name="l01261"></a>01261 <span class="stringliteral">            extra =&gt; undef,                # used to check syntax of incorrect answers</span>
<a name="l01262"></a>01262 <span class="stringliteral">            requireParenMatch =&gt; 1,        # student parens must match correct parens</span>
<a name="l01263"></a>01263 <span class="stringliteral">            removeParens =&gt; 1,             # remove outermost parens, if any</span>
<a name="l01264"></a>01264 <span class="stringliteral">            implicitList =&gt; 1,             # force single answers to be lists (even if they ARE lists)</span>
<a name="l01265"></a>01265 <span class="stringliteral"></span>
<a name="l01266"></a>01266 <span class="stringliteral"></span>
<a name="l01267"></a>01267 <span class="stringliteral">=cut</span>
<a name="l01268"></a>01268 <span class="stringliteral"></span>
<a name="l01269"></a>01269 <span class="stringliteral">package Value::List;</span>
<a name="l01270"></a>01270 <span class="stringliteral"></span>
<a name="l01271"></a>01271 <span class="stringliteral">sub cmp_defaults {</span>
<a name="l01272"></a>01272 <span class="stringliteral">  my $self = shift;</span>
<a name="l01273"></a>01273 <span class="stringliteral">  my %options = (@_);</span>
<a name="l01274"></a>01274 <span class="stringliteral">  my $element = Value::makeValue($self-&gt;{data}[0],context=&gt;$self-&gt;context);</span>
<a name="l01275"></a>01275 <span class="stringliteral">  $element = $self-&gt;Package(&quot;</span><a class="code" href="classValue_1_1Formula.html">Formula</a><span class="stringliteral">&quot;)-&gt;new($element) unless Value::isValue($element);</span>
<a name="l01276"></a>01276 <span class="stringliteral">  return (</span>
<a name="l01277"></a>01277 <span class="stringliteral">    Value::Real-&gt;cmp_defaults(@_),</span>
<a name="l01278"></a>01278 <span class="stringliteral">    showHints =&gt; undef,</span>
<a name="l01279"></a>01279 <span class="stringliteral">    showLengthHints =&gt; undef,</span>
<a name="l01280"></a>01280 <span class="stringliteral">    showParenHints =&gt; undef,</span>
<a name="l01281"></a>01281 <span class="stringliteral">    partialCredit =&gt; undef,</span>
<a name="l01282"></a>01282 <span class="stringliteral">    ordered =&gt; 0,</span>
<a name="l01283"></a>01283 <span class="stringliteral">    entry_type =&gt; undef,</span>
<a name="l01284"></a>01284 <span class="stringliteral">    list_type =&gt; undef,</span>
<a name="l01285"></a>01285 <span class="stringliteral">    typeMatch =&gt; $element,</span>
<a name="l01286"></a>01286 <span class="stringliteral">    firstElement =&gt; $element,</span>
<a name="l01287"></a>01287 <span class="stringliteral">    extra =&gt; undef,</span>
<a name="l01288"></a>01288 <span class="stringliteral">    requireParenMatch =&gt; 1,</span>
<a name="l01289"></a>01289 <span class="stringliteral">    removeParens =&gt; 1,</span>
<a name="l01290"></a>01290 <span class="stringliteral">    implicitList =&gt; 1,</span>
<a name="l01291"></a>01291 <span class="stringliteral">  );</span>
<a name="l01292"></a>01292 <span class="stringliteral">}</span>
<a name="l01293"></a>01293 <span class="stringliteral"></span>
<a name="l01294"></a><a class="code" href="classValue_1_1Infinity.html">01294</a> <span class="stringliteral">#</span>
<a name="l01295"></a>01295 <span class="stringliteral">#  Match anything but formulas</span>
<a name="l01296"></a>01296 <span class="stringliteral">#</span>
<a name="l01297"></a>01297 <span class="stringliteral">sub typeMatch {return !ref($other) || !$other-&gt;isFormula}</span>
<a name="l01298"></a>01298 <span class="stringliteral"></span>
<a name="l01299"></a>01299 <span class="stringliteral">#</span>
<a name="l01300"></a>01300 <span class="stringliteral">#  Handle removal of outermost parens in correct answer.</span>
<a name="l01301"></a>01301 <span class="stringliteral">#</span>
<a name="l01302"></a>01302 <span class="stringliteral">sub cmp {</span>
<a name="l01303"></a>01303 <span class="stringliteral">  my $self = shift;</span>
<a name="l01304"></a>01304 <span class="stringliteral">  my %params = @_;</span>
<a name="l01305"></a>01305 <span class="stringliteral">  my $cmp = $self-&gt;SUPER::cmp(@_);</span>
<a name="l01306"></a>01306 <span class="stringliteral">  if ($cmp-&gt;{rh_ans}{removeParens}) {</span>
<a name="l01307"></a>01307 <span class="stringliteral">    $self-&gt;{open} = $self-&gt;{close} = &#39;&#39;;</span>
<a name="l01308"></a>01308 <span class="stringliteral">    $cmp-&gt;ans_hash(correct_ans =&gt; $self-&gt;stringify)</span>
<a name="l01309"></a>01309 <span class="stringliteral">      unless defined($self-&gt;{correct_ans}) || defined($params{correct_ans});</span>
<a name="l01310"></a>01310 <span class="stringliteral">  }</span>
<a name="l01311"></a>01311 <span class="stringliteral">  return $cmp;</span>
<a name="l01312"></a>01312 <span class="stringliteral">}</span>
<a name="l01313"></a>01313 <span class="stringliteral"></span>
<a name="l01314"></a>01314 <span class="stringliteral">sub cmp_equal {</span>
<a name="l01315"></a>01315 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l01316"></a>01316 <span class="stringliteral">  $ans-&gt;{showPartialCorrectAnswers} = $self-&gt;getPG(&#39;$showPartialCorrectAnswers&#39;);</span>
<a name="l01317"></a>01317 <span class="stringliteral"></span>
<a name="l01318"></a>01318 <span class="stringliteral">  #</span>
<a name="l01319"></a>01319 <span class="stringliteral">  #  get the paramaters</span>
<a name="l01320"></a>01320 <span class="stringliteral">  #</span>
<a name="l01321"></a>01321 <span class="stringliteral">  my $showHints         = getOption($ans,&#39;showHints&#39;);</span>
<a name="l01322"></a>01322 <span class="stringliteral">  my $showLengthHints   = getOption($ans,&#39;showLengthHints&#39;);</span>
<a name="l01323"></a>01323 <span class="stringliteral">  my $showParenHints    = getOption($ans,&#39;showParenHints&#39;);</span>
<a name="l01324"></a>01324 <span class="stringliteral">  my $partialCredit     = getOption($ans,&#39;partialCredit&#39;);</span>
<a name="l01325"></a>01325 <span class="stringliteral">  my $requireParenMatch = $ans-&gt;{requireParenMatch};</span>
<a name="l01326"></a>01326 <span class="stringliteral">  my $implicitList      = $ans-&gt;{implicitList};</span>
<a name="l01327"></a>01327 <span class="stringliteral">  my $typeMatch         = $ans-&gt;{typeMatch};</span>
<a name="l01328"></a>01328 <span class="stringliteral">  my $value             = $ans-&gt;{entry_type};</span>
<a name="l01329"></a>01329 <span class="stringliteral">  my $ltype             = $ans-&gt;{list_type} || lc($self-&gt;type);</span>
<a name="l01330"></a>01330 <span class="stringliteral">  my $stype             = $ans-&gt;{short_type} || $ltype;</span>
<a name="l01331"></a>01331 <span class="stringliteral"></span>
<a name="l01332"></a>01332 <span class="stringliteral">  $value = (Value::isValue($typeMatch)? lc($typeMatch-&gt;cmp_class): &#39;a value&#39;)</span>
<a name="l01333"></a>01333 <span class="stringliteral">    unless defined($value);</span>
<a name="l01334"></a>01334 <span class="stringliteral">  $value =~ s/(real|complex) //; $ans-&gt;{cmp_class} = $value;</span>
<a name="l01335"></a>01335 <span class="stringliteral">  $value =~ s/^an? //; $value = &#39;formula&#39; if $value =~ m/formula/;</span>
<a name="l01336"></a>01336 <span class="stringliteral">  $ltype =~ s/^an? //; $stype =~ s/^an? //;</span>
<a name="l01337"></a>01337 <span class="stringliteral">  $showHints = $showLengthHints = 0 if $ans-&gt;{isPreview};</span>
<a name="l01338"></a>01338 <span class="stringliteral"></span>
<a name="l01339"></a>01339 <span class="stringliteral">  #</span>
<a name="l01340"></a>01340 <span class="stringliteral">  #  Get the lists of correct and student answers</span>
<a name="l01341"></a>01341 <span class="stringliteral">  #   (split formulas that return lists or unions)</span>
<a name="l01342"></a>01342 <span class="stringliteral">  #</span>
<a name="l01343"></a>01343 <span class="stringliteral">  my @correct = (); my ($cOpen,$cClose);</span>
<a name="l01344"></a>01344 <span class="stringliteral">  if (!$self-&gt;isFormula) {</span>
<a name="l01345"></a>01345 <span class="stringliteral">    @correct = $self-&gt;value;</span>
<a name="l01346"></a>01346 <span class="stringliteral">    $cOpen = $ans-&gt;{correct_value}{open}; $cClose = $ans-&gt;{correct_value}{close};</span>
<a name="l01347"></a>01347 <span class="stringliteral">  } else {</span>
<a name="l01348"></a>01348 <span class="stringliteral">    @correct = Value::List-&gt;splitFormula($self,$ans);</span>
<a name="l01349"></a>01349 <span class="stringliteral">    $cOpen = $self-&gt;{tree}{open}; $cClose = $self-&gt;{tree}{close};</span>
<a name="l01350"></a>01350 <span class="stringliteral">  }</span>
<a name="l01351"></a>01351 <span class="stringliteral">  my $student = $ans-&gt;{student_value}; my @student = ($student);</span>
<a name="l01352"></a>01352 <span class="stringliteral">  my ($sOpen,$sClose) = (&#39;&#39;,&#39;&#39;);</span>
<a name="l01353"></a>01353 <span class="stringliteral">  if (Value::isFormula($student) &amp;&amp; $student-&gt;type eq $self-&gt;type) {</span>
<a name="l01354"></a>01354 <span class="stringliteral">    if ($implicitList &amp;&amp; $student-&gt;{tree}{open} ne &#39;&#39;) {</span>
<a name="l01355"></a>01355 <span class="stringliteral">      @student = ($student);</span>
<a name="l01356"></a><a class="code" href="classValue_1_1String.html">01356</a> <span class="stringliteral">    } else {</span>
<a name="l01357"></a>01357 <span class="stringliteral">      @student = Value::List-&gt;splitFormula($student,$ans);</span>
<a name="l01358"></a>01358 <span class="stringliteral">      $sOpen = $student-&gt;{tree}{open}; $sClose = $student-&gt;{tree}{close};</span>
<a name="l01359"></a>01359 <span class="stringliteral">    }</span>
<a name="l01360"></a>01360 <span class="stringliteral">  } elsif (!$student-&gt;isFormula &amp;&amp; $student-&gt;classMatch($self-&gt;type)) {</span>
<a name="l01361"></a>01361 <span class="stringliteral">    if ($implicitList &amp;&amp; $student-&gt;{open} ne &#39;&#39;) {</span>
<a name="l01362"></a>01362 <span class="stringliteral">      @student = ($student);</span>
<a name="l01363"></a>01363 <span class="stringliteral">    } else {</span>
<a name="l01364"></a>01364 <span class="stringliteral">      @student = @{$student-&gt;{data}};</span>
<a name="l01365"></a>01365 <span class="stringliteral">      $sOpen = $student-&gt;{open}; $sClose = $student-&gt;{close};</span>
<a name="l01366"></a>01366 <span class="stringliteral">    }</span>
<a name="l01367"></a>01367 <span class="stringliteral">  }</span>
<a name="l01368"></a>01368 <span class="stringliteral">  return if $ans-&gt;{split_error};</span>
<a name="l01369"></a>01369 <span class="stringliteral">  foreach my $x (@correct) {$x-&gt;{equation} = $self};</span>
<a name="l01370"></a>01370 <span class="stringliteral">  foreach my $x (@student) {$x-&gt;{equation} = $self};</span>
<a name="l01371"></a>01371 <span class="stringliteral">  #</span>
<a name="l01372"></a>01372 <span class="stringliteral">  #  Check for parenthesis match</span>
<a name="l01373"></a>01373 <span class="stringliteral">  #</span>
<a name="l01374"></a>01374 <span class="stringliteral">  if ($requireParenMatch &amp;&amp; ($sOpen ne $cOpen || $sClose ne $cClose)) {</span>
<a name="l01375"></a>01375 <span class="stringliteral">    if ($showParenHints &amp;&amp; !($ans-&gt;{ignoreStrings} &amp;&amp; $student-&gt;type eq &#39;String&#39;)) {</span>
<a name="l01376"></a>01376 <span class="stringliteral">      my $message = &quot;</span>The parentheses <span class="keywordflow">for</span> your $ltype <span class="stringliteral">&quot;;</span>
<a name="l01377"></a>01377 <span class="stringliteral">      if (($cOpen || $cClose) &amp;&amp; ($sOpen || $sClose))</span>
<a name="l01378"></a>01378 <span class="stringliteral">                                {$message .= &quot;</span>are of the wrong type<span class="stringliteral">&quot;}</span>
<a name="l01379"></a>01379 <span class="stringliteral">      elsif ($sOpen || $sClose) {$message .= &quot;</span>should be removed<span class="stringliteral">&quot;}</span>
<a name="l01380"></a>01380 <span class="stringliteral">      else                      {$message .= &quot;</span>seem to be missing<span class="stringliteral">&quot;}</span>
<a name="l01381"></a>01381 <span class="stringliteral">      $self-&gt;cmp_Error($ans,$message) unless $ans-&gt;{isPreview};</span>
<a name="l01382"></a>01382 <span class="stringliteral">    }</span>
<a name="l01383"></a>01383 <span class="stringliteral">    return;</span>
<a name="l01384"></a>01384 <span class="stringliteral">  }</span>
<a name="l01385"></a>01385 <span class="stringliteral"></span>
<a name="l01386"></a>01386 <span class="stringliteral">  #</span>
<a name="l01387"></a>01387 <span class="stringliteral">  #  Determine the maximum score</span>
<a name="l01388"></a>01388 <span class="stringliteral">  #</span>
<a name="l01389"></a>01389 <span class="stringliteral">  my $M = scalar(@correct);</span>
<a name="l01390"></a>01390 <span class="stringliteral">  my $m = scalar(@student);</span>
<a name="l01391"></a>01391 <span class="stringliteral">  my $maxscore = ($m &gt; $M)? $m : $M;</span>
<a name="l01392"></a>01392 <span class="stringliteral"></span>
<a name="l01393"></a>01393 <span class="stringliteral">  #</span>
<a name="l01394"></a>01394 <span class="stringliteral">  #  Compare the two lists</span>
<a name="l01395"></a>01395 <span class="stringliteral">  #  (Handle errors in user-supplied functions)</span>
<a name="l01396"></a>01396 <span class="stringliteral">  #</span>
<a name="l01397"></a>01397 <span class="stringliteral">  my ($score,@errors);</span>
<a name="l01398"></a>01398 <span class="stringliteral">  if (ref($ans-&gt;{list_checker}) eq &#39;CODE&#39;) {</span>
<a name="l01399"></a>01399 <span class="stringliteral">    eval {($score,@errors) = &amp;{$ans-&gt;{list_checker}}([@correct],[@student],$ans,$value)};</span>
<a name="l01400"></a>01400 <span class="stringliteral">    if (!defined($score)) {</span>
<a name="l01401"></a>01401 <span class="stringliteral">      die $@ if $@ ne &#39;&#39; &amp;&amp; $self-&gt;{context}{error}{flag} == 0;</span>
<a name="l01402"></a>01402 <span class="stringliteral">      $self-&gt;cmp_error($ans) if $self-&gt;{context}{error}{flag};</span>
<a name="l01403"></a>01403 <span class="stringliteral">    }</span>
<a name="l01404"></a>01404 <span class="stringliteral">  } else {</span>
<a name="l01405"></a>01405 <span class="stringliteral">    ($score,@errors) = $self-&gt;cmp_list_compare([@correct],[@student],$ans,$value);</span>
<a name="l01406"></a>01406 <span class="stringliteral">  }</span>
<a name="l01407"></a>01407 <span class="stringliteral">  return unless defined($score);</span>
<a name="l01408"></a>01408 <span class="stringliteral"></span>
<a name="l01409"></a>01409 <span class="stringliteral">  #</span>
<a name="l01410"></a>01410 <span class="stringliteral">  #  Give hints about extra or missing answers</span>
<a name="l01411"></a>01411 <span class="stringliteral">  #</span>
<a name="l01412"></a>01412 <span class="stringliteral">  if ($showLengthHints) {</span>
<a name="l01413"></a>01413 <span class="stringliteral">    $value =~ s/( or|,) /s$1 /g; # fix &quot;</span>interval or <span class="keyword">union</span><span class="stringliteral">&quot;</span>
<a name="l01414"></a>01414 <span class="stringliteral">    push(@errors,&quot;</span>There should be more ${value}s in your $stype<span class="stringliteral">&quot;)</span>
<a name="l01415"></a>01415 <span class="stringliteral">      if ($score &lt; $maxscore &amp;&amp; $score == $m);</span>
<a name="l01416"></a>01416 <span class="stringliteral">    push(@errors,&quot;</span>There should be fewer ${value}s in your $stype<span class="stringliteral">&quot;)</span>
<a name="l01417"></a>01417 <span class="stringliteral">      if ($score &lt; $maxscore &amp;&amp; $score == $M &amp;&amp; !$showHints);</span>
<a name="l01418"></a>01418 <span class="stringliteral">  }</span>
<a name="l01419"></a>01419 <span class="stringliteral"></span>
<a name="l01420"></a>01420 <span class="stringliteral">  #</span>
<a name="l01421"></a>01421 <span class="stringliteral">  #  If all the entries are in error, don&#39;t give individual messages</span>
<a name="l01422"></a>01422 <span class="stringliteral">  #</span>
<a name="l01423"></a>01423 <span class="stringliteral">  if ($score == 0) {</span>
<a name="l01424"></a>01424 <span class="stringliteral">    my $i = 0;</span>
<a name="l01425"></a>01425 <span class="stringliteral">    while ($i &lt;= $#errors) {</span>
<a name="l01426"></a>01426 <span class="stringliteral">      if ($errors[$i++] =~ m/^Your .* is incorrect$/)</span>
<a name="l01427"></a>01427 <span class="stringliteral">        {splice(@errors,--$i,1)}</span>
<a name="l01428"></a>01428 <span class="stringliteral">    }</span>
<a name="l01429"></a>01429 <span class="stringliteral">  }</span>
<a name="l01430"></a>01430 <span class="stringliteral"></span>
<a name="l01431"></a>01431 <span class="stringliteral">  #</span>
<a name="l01432"></a>01432 <span class="stringliteral">  #  Finalize the score</span>
<a name="l01433"></a>01433 <span class="stringliteral">  #</span>
<a name="l01434"></a>01434 <span class="stringliteral">  $score = 0 if ($score != $maxscore &amp;&amp; !$partialCredit);</span>
<a name="l01435"></a>01435 <span class="stringliteral">  $ans-&gt;score($score/$maxscore);</span>
<a name="l01436"></a>01436 <span class="stringliteral">  push(@errors,&quot;</span>Score = $ans-&gt;{score}<span class="stringliteral">&quot;) if $ans-&gt;{debug};</span>
<a name="l01437"></a>01437 <span class="stringliteral">  my $error = join(&quot;</span>\n<span class="stringliteral">&quot;,@errors); $error =~ s!&lt;/DIV&gt;\n!&lt;/DIV&gt;!g;</span>
<a name="l01438"></a>01438 <span class="stringliteral">  $ans-&gt;{error_message} = $ans-&gt;{ans_message} = $error;</span>
<a name="l01439"></a>01439 <span class="stringliteral">}</span>
<a name="l01440"></a>01440 <span class="stringliteral"></span>
<a name="l01441"></a>01441 <span class="stringliteral">#</span>
<a name="l01442"></a>01442 <span class="stringliteral">#  Compare the contents of the list to see of they are equal</span>
<a name="l01443"></a>01443 <span class="stringliteral">#</span>
<a name="l01444"></a>01444 <span class="stringliteral">sub cmp_list_compare {</span>
<a name="l01445"></a>01445 <span class="stringliteral">  my $self = shift; my $context = $self-&gt;context;</span>
<a name="l01446"></a>01446 <span class="stringliteral">  my $correct = shift; my $student = shift; my $ans = shift; my $value = shift;</span>
<a name="l01447"></a>01447 <span class="stringliteral">  my @correct = @{$correct}; my @student = @{$student}; my $m = scalar(@student);</span>
<a name="l01448"></a>01448 <span class="stringliteral">  my $ordered = $ans-&gt;{ordered};</span>
<a name="l01449"></a>01449 <span class="stringliteral">  my $showTypeWarnings = $ans-&gt;{showTypeWarnings} &amp;&amp; !$ans-&gt;{isPreview};</span>
<a name="l01450"></a>01450 <span class="stringliteral">  my $typeMatch = $ans-&gt;{typeMatch};</span>
<a name="l01451"></a>01451 <span class="stringliteral">  my $extra = defined($ans-&gt;{extra}) ? $ans-&gt;{extra} :</span>
<a name="l01452"></a>01452 <span class="stringliteral">              (Value::isValue($typeMatch) ? $typeMatch: $ans-&gt;{firstElement});</span>
<a name="l01453"></a>01453 <span class="stringliteral">  $extra = $self-&gt;Package(&quot;</span><a class="code" href="classList.html">List</a><span class="stringliteral">&quot;)-&gt;new() unless defined($extra);</span>
<a name="l01454"></a>01454 <span class="stringliteral">  my $showHints = getOption($ans,&#39;showHints&#39;) &amp;&amp; !$ans-&gt;{isPreview};</span>
<a name="l01455"></a>01455 <span class="stringliteral">  my $error = $context-&gt;{error};</span>
<a name="l01456"></a>01456 <span class="stringliteral">  my $score = 0; my @errors; my $i = 0;</span>
<a name="l01457"></a>01457 <span class="stringliteral"></span>
<a name="l01458"></a>01458 <span class="stringliteral">  #</span>
<a name="l01459"></a>01459 <span class="stringliteral">  #  Check for empty lists</span>
<a name="l01460"></a>01460 <span class="stringliteral">  #</span>
<a name="l01461"></a>01461 <span class="stringliteral">  if (scalar(@correct) == 0) {$ans-&gt;score($m == 0); return}</span>
<a name="l01462"></a>01462 <span class="stringliteral"></span>
<a name="l01463"></a>01463 <span class="stringliteral">  #</span>
<a name="l01464"></a>01464 <span class="stringliteral">  #  Loop through student answers looking for correct ones</span>
<a name="l01465"></a>01465 <span class="stringliteral">  #</span>
<a name="l01466"></a>01466 <span class="stringliteral">  ENTRY: foreach my $entry (@student) {</span>
<a name="l01467"></a>01467 <span class="stringliteral">    $i++; $context-&gt;clearError;</span>
<a name="l01468"></a>01468 <span class="stringliteral">    $entry = Value::makeValue($entry,$context);</span>
<a name="l01469"></a>01469 <span class="stringliteral">    $entry = $self-&gt;Package(&quot;</span>Formula<span class="stringliteral">&quot;)-&gt;new($entry) if !Value::isValue($entry);</span>
<a name="l01470"></a>01470 <span class="stringliteral"></span>
<a name="l01471"></a>01471 <span class="stringliteral">    #</span>
<a name="l01472"></a>01472 <span class="stringliteral">    #  Some words differ if there is only one entry in the student&#39;s list</span>
<a name="l01473"></a>01473 <span class="stringliteral">    #</span>
<a name="l01474"></a>01474 <span class="stringliteral">    my $nth = &#39;&#39;; my $answer = &#39;answer&#39;;</span>
<a name="l01475"></a>01475 <span class="stringliteral">    my $class = $ans-&gt;{list_type} || $ans-&gt;{cmp_class};</span>
<a name="l01476"></a>01476 <span class="stringliteral">    if ($m &gt; 1) {</span>
<a name="l01477"></a><a class="code" href="classValue_1_1Point.html">01477</a> <span class="stringliteral">      $nth = &#39; &#39;.$self-&gt;NameForNumber($i);</span>
<a name="l01478"></a>01478 <span class="stringliteral">      $class = $ans-&gt;{cmp_class};</span>
<a name="l01479"></a>01479 <span class="stringliteral">      $answer = &#39;value&#39;;</span>
<a name="l01480"></a>01480 <span class="stringliteral">    }</span>
<a name="l01481"></a>01481 <span class="stringliteral"></span>
<a name="l01482"></a>01482 <span class="stringliteral">    #</span>
<a name="l01483"></a>01483 <span class="stringliteral">    #  See if the entry matches the correct answer</span>
<a name="l01484"></a>01484 <span class="stringliteral">    #  and perform syntax checking if not</span>
<a name="l01485"></a>01485 <span class="stringliteral">    #</span>
<a name="l01486"></a>01486 <span class="stringliteral">    if ($ordered) {</span>
<a name="l01487"></a>01487 <span class="stringliteral">      if (scalar(@correct)) {</span>
<a name="l01488"></a>01488 <span class="stringliteral">    if (shift(@correct)-&gt;cmp_compare($entry,$ans,$nth,$value)) {$score++; next ENTRY}</span>
<a name="l01489"></a>01489 <span class="stringliteral">      } else {</span>
<a name="l01490"></a>01490 <span class="stringliteral">    # do syntax check</span>
<a name="l01491"></a>01491 <span class="stringliteral">    if (ref($extra) eq &#39;CODE&#39;) {&amp;$extra($entry,$ans,$nth,$value)}</span>
<a name="l01492"></a>01492 <span class="stringliteral">      else {$extra-&gt;cmp_compare($entry,$ans,$nth,$value)}</span>
<a name="l01493"></a>01493 <span class="stringliteral">      }</span>
<a name="l01494"></a>01494 <span class="stringliteral">      if ($error-&gt;{flag} == $CMP_ERROR) {$self-&gt;cmp_error($ans); return}</span>
<a name="l01495"></a>01495 <span class="stringliteral">    } else {</span>
<a name="l01496"></a>01496 <span class="stringliteral">      foreach my $k (0..$#correct) {</span>
<a name="l01497"></a>01497 <span class="stringliteral">    if ($correct[$k]-&gt;cmp_compare($entry,$ans,$nth,$value)) {</span>
<a name="l01498"></a>01498 <span class="stringliteral">      splice(@correct,$k,1);</span>
<a name="l01499"></a>01499 <span class="stringliteral">      $score++; next ENTRY;</span>
<a name="l01500"></a>01500 <span class="stringliteral">    }</span>
<a name="l01501"></a>01501 <span class="stringliteral">    if ($error-&gt;{flag} == $CMP_ERROR) {$self-&gt;cmp_error($ans); return}</span>
<a name="l01502"></a>01502 <span class="stringliteral">      }</span>
<a name="l01503"></a>01503 <span class="stringliteral">      $context-&gt;clearError;</span>
<a name="l01504"></a>01504 <span class="stringliteral">      # do syntax check</span>
<a name="l01505"></a>01505 <span class="stringliteral">      if (ref($extra) eq &#39;CODE&#39;) {&amp;$extra($entry,$ans,$nth,$value)}</span>
<a name="l01506"></a>01506 <span class="stringliteral">        else {$extra-&gt;cmp_compare($entry,$ans,$nth,$value)}</span>
<a name="l01507"></a>01507 <span class="stringliteral">    }</span>
<a name="l01508"></a>01508 <span class="stringliteral">    #</span>
<a name="l01509"></a>01509 <span class="stringliteral">    #  Give messages about incorrect answers</span>
<a name="l01510"></a>01510 <span class="stringliteral">    #</span>
<a name="l01511"></a>01511 <span class="stringliteral">    my $match = (ref($typeMatch) eq &#39;CODE&#39;)? &amp;$typeMatch($entry,$ans) :</span>
<a name="l01512"></a>01512 <span class="stringliteral">                                             $typeMatch-&gt;typeMatch($entry,$ans);</span>
<a name="l01513"></a>01513 <span class="stringliteral">    if ($showTypeWarnings &amp;&amp; !$match &amp;&amp;</span>
<a name="l01514"></a>01514 <span class="stringliteral">    !($ans-&gt;{ignoreStrings} &amp;&amp; $entry-&gt;classMatch(&#39;String&#39;))) {</span>
<a name="l01515"></a>01515 <span class="stringliteral">      push(@errors,&quot;</span>Your$nth $answer isn<span class="stringliteral">&#39;t &quot;.lc($class).</span>
<a name="l01516"></a>01516 <span class="stringliteral">       &quot; (it looks like &quot;.lc($entry-&gt;showClass).&quot;)&quot;);</span>
<a name="l01517"></a>01517 <span class="stringliteral">    } elsif ($error-&gt;{flag} &amp;&amp; $ans-&gt;{showEqualErrors}) {</span>
<a name="l01518"></a>01518 <span class="stringliteral">      my $message = $error-&gt;{message}; $message =~ s/\s+$//;</span>
<a name="l01519"></a>01519 <span class="stringliteral">      if ($m &gt; 1 &amp;&amp; $error-&gt;{flag} != $CMP_WARNING) {</span>
<a name="l01520"></a>01520 <span class="stringliteral">        push(@errors,&quot;&lt;SMALL&gt;There is a problem with your$nth $value:&lt;/SMALL&gt;&quot;,</span>
<a name="l01521"></a>01521 <span class="stringliteral">                 &#39;</span>&lt;DIV STYLE=<span class="stringliteral">&quot;margin-left:1em&quot;</span>&gt;<span class="stringliteral">&#39;.$message.&#39;</span>&lt;/DIV&gt;<span class="stringliteral">&#39;);</span>
<a name="l01522"></a>01522 <span class="stringliteral">      } else {push(@errors,$message)}</span>
<a name="l01523"></a>01523 <span class="stringliteral">    } elsif ($showHints &amp;&amp; $m &gt; 1) {</span>
<a name="l01524"></a>01524 <span class="stringliteral">      push(@errors,&quot;Your$nth $value is incorrect&quot;);</span>
<a name="l01525"></a>01525 <span class="stringliteral">    }</span>
<a name="l01526"></a>01526 <span class="stringliteral">  }</span>
<a name="l01527"></a>01527 <span class="stringliteral"></span>
<a name="l01528"></a>01528 <span class="stringliteral">  #</span>
<a name="l01529"></a>01529 <span class="stringliteral">  #  Return the score and errors</span>
<a name="l01530"></a>01530 <span class="stringliteral">  #</span>
<a name="l01531"></a>01531 <span class="stringliteral">  return ($score,@errors);</span>
<a name="l01532"></a>01532 <span class="stringliteral">}</span>
<a name="l01533"></a>01533 <span class="stringliteral"></span>
<a name="l01534"></a>01534 <span class="stringliteral"></span>
<a name="l01535"></a>01535 <span class="stringliteral"></span>
<a name="l01536"></a>01536 <span class="stringliteral">#</span>
<a name="l01537"></a>01537 <span class="stringliteral">#  Split a formula that is a list or union into a</span>
<a name="l01538"></a>01538 <span class="stringliteral">#    list of formulas (or Value objects).</span>
<a name="l01539"></a>01539 <span class="stringliteral">#</span>
<a name="l01540"></a>01540 <span class="stringliteral">sub splitFormula {</span>
<a name="l01541"></a>01541 <span class="stringliteral">  my $self = shift; my $formula = shift; my $ans = shift;</span>
<a name="l01542"></a>01542 <span class="stringliteral">  my @formula; my @entries;</span>
<a name="l01543"></a>01543 <span class="stringliteral">  if ($formula-&gt;type eq &#39;</span><a class="code" href="classValue_1_1Union.html">Union</a><span class="stringliteral">&#39;) {@entries = $formula-&gt;{tree}-&gt;makeUnion}</span>
<a name="l01544"></a>01544 <span class="stringliteral">    else {@entries = @{$formula-&gt;{tree}{coords}}}</span>
<a name="l01545"></a>01545 <span class="stringliteral">  foreach my $entry (@entries) {</span>
<a name="l01546"></a>01546 <span class="stringliteral">    my $v = Parser::Formula($entry);</span>
<a name="l01547"></a>01547 <span class="stringliteral">       $v = Parser::Evaluate($v) if (defined($v) &amp;&amp; $v-&gt;isConstant);</span>
<a name="l01548"></a>01548 <span class="stringliteral">    if (!defined($v)) {$ans-&gt;{split_error} = 1; $self-&gt;cmp_error($ans); return}</span>
<a name="l01549"></a>01549 <span class="stringliteral">    $v-&gt;{equation} = $self;</span>
<a name="l01550"></a>01550 <span class="stringliteral">    push(@formula,$v);</span>
<a name="l01551"></a>01551 <span class="stringliteral">  }</span>
<a name="l01552"></a>01552 <span class="stringliteral">  return @formula;</span>
<a name="l01553"></a>01553 <span class="stringliteral">}</span>
<a name="l01554"></a>01554 <span class="stringliteral"></span>
<a name="l01555"></a>01555 <span class="stringliteral">#  Override for List ?</span>
<a name="l01556"></a>01556 <span class="stringliteral">#  Return the value if it is defined, otherwise use a default</span>
<a name="l01557"></a>01557 <span class="stringliteral">#</span>
<a name="l01558"></a>01558 <span class="stringliteral">sub getOption {</span>
<a name="l01559"></a>01559 <span class="stringliteral">  my $ans = shift; my $name = shift;</span>
<a name="l01560"></a>01560 <span class="stringliteral">  my $value = $ans-&gt;{$name};</span>
<a name="l01561"></a>01561 <span class="stringliteral">  return $value if defined($value);</span>
<a name="l01562"></a>01562 <span class="stringliteral">  return $ans-&gt;{showPartialCorrectAnswers};</span>
<a name="l01563"></a>01563 <span class="stringliteral">}</span>
<a name="l01564"></a>01564 <span class="stringliteral"></span>
<a name="l01565"></a>01565 <span class="stringliteral">#############################################################</span>
<a name="l01566"></a>01566 <span class="stringliteral"></span>
<a name="l01567"></a>01567 <span class="stringliteral">=head3  Value::Formula</span>
<a name="l01568"></a>01568 <span class="stringliteral"></span>
<a name="l01569"></a>01569 <span class="stringliteral">    Usage: $fun = Formula(&quot;x^2-x+1&quot;);</span>
<a name="l01570"></a>01570 <span class="stringliteral">           $set = Formula(&quot;[-1, x) U (x, 2]&quot;);</span>
<a name="l01571"></a>01571 <span class="stringliteral"></span>
<a name="l01572"></a>01572 <span class="stringliteral">    A formula can have any of the other math object types as its range.</span>
<a name="l01573"></a>01573 <span class="stringliteral">        Union, List, Number (Complex or Real),</span>
<a name="l01574"></a>01574 <span class="stringliteral"></span>
<a name="l01575"></a>01575 <span class="stringliteral"></span>
<a name="l01576"></a>01576 <span class="stringliteral">=cut</span>
<a name="l01577"></a>01577 <span class="stringliteral"></span>
<a name="l01578"></a>01578 <span class="stringliteral">package Value::Formula;</span>
<a name="l01579"></a>01579 <span class="stringliteral"></span>
<a name="l01580"></a>01580 <span class="stringliteral">sub cmp_defaults {</span>
<a name="l01581"></a>01581 <span class="stringliteral">  my $self = shift;</span>
<a name="l01582"></a>01582 <span class="stringliteral"></span>
<a name="l01583"></a>01583 <span class="stringliteral">  return (</span>
<a name="l01584"></a>01584 <span class="stringliteral">    Value::Union::cmp_defaults($self,@_),</span>
<a name="l01585"></a>01585 <span class="stringliteral">    typeMatch =&gt; $self-&gt;Package(&quot;Formula&quot;)-&gt;new(&quot;(1,2]&quot;),</span>
<a name="l01586"></a>01586 <span class="stringliteral">    showDomainErrors =&gt; 1,</span>
<a name="l01587"></a>01587 <span class="stringliteral">  ) if $self-&gt;type eq &#39;</span><a class="code" href="classValue_1_1Union.html">Union</a><span class="stringliteral">&#39;;</span>
<a name="l01588"></a>01588 <span class="stringliteral"></span>
<a name="l01589"></a>01589 <span class="stringliteral">  my $type = $self-&gt;type;</span>
<a name="l01590"></a>01590 <span class="stringliteral">  $type = ($self-&gt;isComplex)? &#39;</span><a class="code" href="classValue_1_1Complex.html">Complex</a><span class="stringliteral">&#39;: &#39;</span>Real<span class="stringliteral">&#39; if $type eq &#39;</span>Number<span class="stringliteral">&#39;;</span>
<a name="l01591"></a>01591 <span class="stringliteral">  $type = $self-&gt;Package($type).&#39;</span>::<span class="stringliteral">&#39;;</span>
<a name="l01592"></a>01592 <span class="stringliteral"></span>
<a name="l01593"></a>01593 <span class="stringliteral">  return (</span>
<a name="l01594"></a>01594 <span class="stringliteral">    &amp;{$type.&#39;</span>cmp_defaults<span class="stringliteral">&#39;}($self,@_),</span>
<a name="l01595"></a>01595 <span class="stringliteral">    upToConstant =&gt; 0,</span>
<a name="l01596"></a>01596 <span class="stringliteral">    showDomainErrors =&gt; 1,</span>
<a name="l01597"></a>01597 <span class="stringliteral">#  ) if defined(%$type) &amp;&amp; $self-&gt;type ne &#39;</span><a class="code" href="classValue_1_1List.html">List</a><span class="stringliteral">&#39;; #causes errors in newest perl</span>
<a name="l01598"></a>01598 <span class="stringliteral">#   ) if ( ref($type)=~/HASH/ ) &amp;&amp; $self-&gt;type ne &#39;</span><a class="code" href="classValue_1_1List.html">List</a><span class="stringliteral">&#39;; # does NOT work --causes FortLewis error</span>
<a name="l01599"></a>01599 <span class="stringliteral">   ) if %$type &amp;&amp; $self-&gt;type ne &#39;</span><a class="code" href="classValue_1_1List.html">List</a><span class="stringliteral">&#39;;   </span>
<a name="l01600"></a>01600 <span class="stringliteral">  my $element;</span>
<a name="l01601"></a>01601 <span class="stringliteral">  if ($self-&gt;{tree}-&gt;class eq &#39;</span><a class="code" href="classValue_1_1List.html">List</a><span class="stringliteral">&#39;) {$element = $self-&gt;Package(&quot;Formula&quot;)-&gt;new($self-&gt;{tree}{coords}[0])}</span>
<a name="l01602"></a>01602 <span class="stringliteral">    else {$element = $self-&gt;Package(&quot;Formula&quot;)-&gt;new(($self-&gt;createRandomPoints(1))[1]-&gt;[0]{data}[0])}</span>
<a name="l01603"></a>01603 <span class="stringliteral">  return (</span>
<a name="l01604"></a>01604 <span class="stringliteral">    Value::List::cmp_defaults($self,@_),</span>
<a name="l01605"></a>01605 <span class="stringliteral">    removeParens =&gt; $self-&gt;{autoFormula},</span>
<a name="l01606"></a>01606 <span class="stringliteral">    typeMatch =&gt; $element,</span>
<a name="l01607"></a>01607 <span class="stringliteral">    showDomainErrors =&gt; 1,</span>
<a name="l01608"></a>01608 <span class="stringliteral">  );</span>
<a name="l01609"></a>01609 <span class="stringliteral">}</span>
<a name="l01610"></a>01610 <span class="stringliteral"></span>
<a name="l01611"></a>01611 <span class="stringliteral">#</span>
<a name="l01612"></a>01612 <span class="stringliteral">#  Get the types from the values of the formulas</span>
<a name="l01613"></a>01613 <span class="stringliteral">#     and compare those.</span>
<a name="l01614"></a>01614 <span class="stringliteral">#</span>
<a name="l01615"></a>01615 <span class="stringliteral">sub typeMatch {</span>
<a name="l01616"></a>01616 <span class="stringliteral">  my $self = shift; my $other = shift; my $ans = shift;</span>
<a name="l01617"></a>01617 <span class="stringliteral">  return 1 if $self-&gt;type eq $other-&gt;type;</span>
<a name="l01618"></a>01618 <span class="stringliteral">  my $typeMatch = $self-&gt;getTypicalValue($self);</span>
<a name="l01619"></a>01619 <span class="stringliteral">  $other = $self-&gt;getTypicalValue($other,1) if Value::isFormula($other);</span>
<a name="l01620"></a>01620 <span class="stringliteral">  return 1 unless defined($other); # can&#39;</span>t really tell, so don<span class="stringliteral">&#39;t report type mismatch</span>
<a name="l01621"></a>01621 <span class="stringliteral">  return 1 if $typeMatch-&gt;classMatch(&#39;</span><a class="code" href="classValue_1_1String.html">String</a><span class="stringliteral">&#39;) &amp;&amp; Value::isFormula($ans-&gt;{typeMatch});  # avoid infinite loop</span>
<a name="l01622"></a>01622 <span class="stringliteral">  $typeMatch-&gt;typeMatch($other,$ans);</span>
<a name="l01623"></a>01623 <span class="stringliteral">}</span>
<a name="l01624"></a>01624 <span class="stringliteral"></span>
<a name="l01625"></a>01625 <span class="stringliteral">#</span>
<a name="l01626"></a>01626 <span class="stringliteral">#  Create a value from the formula (so we know the output type)</span>
<a name="l01627"></a>01627 <span class="stringliteral">#</span>
<a name="l01628"></a>01628 <span class="stringliteral">sub getTypicalValue {</span>
<a name="l01629"></a>01629 <span class="stringliteral">  my $self = shift; my $f = shift; my $noError = shift;</span>
<a name="l01630"></a>01630 <span class="stringliteral">  return $f-&gt;{test_values}[0] if $f-&gt;{test_values};</span>
<a name="l01631"></a>01631 <span class="stringliteral">  my $points = $f-&gt;{test_points} || $self-&gt;{test_points};</span>
<a name="l01632"></a>01632 <span class="stringliteral">  return ($f-&gt;createPointValues($points)||[])-&gt;[0] if $points;</span>
<a name="l01633"></a>01633 <span class="stringliteral">  return ((($f-&gt;createRandomPoints(1,undef,$noError))[1])||[])-&gt;[0];</span>
<a name="l01634"></a>01634 <span class="stringliteral">}</span>
<a name="l01635"></a>01635 <span class="stringliteral"></span>
<a name="l01636"></a>01636 <span class="stringliteral">#</span>
<a name="l01637"></a>01637 <span class="stringliteral">#  Handle removal of outermost parens in a list.</span>
<a name="l01638"></a>01638 <span class="stringliteral">#  Evaluate answer, if the eval option is used.</span>
<a name="l01639"></a>01639 <span class="stringliteral">#  Handle the UpToConstant option.</span>
<a name="l01640"></a>01640 <span class="stringliteral">#</span>
<a name="l01641"></a>01641 <span class="stringliteral">sub cmp {</span>
<a name="l01642"></a>01642 <span class="stringliteral">  my $self = shift;</span>
<a name="l01643"></a>01643 <span class="stringliteral">  my $cmp = $self-&gt;SUPER::cmp(@_);</span>
<a name="l01644"></a>01644 <span class="stringliteral">  if ($cmp-&gt;{rh_ans}{removeParens} &amp;&amp; $self-&gt;type eq &#39;</span><a class="code" href="classValue_1_1List.html">List</a><span class="stringliteral">&#39;) {</span>
<a name="l01645"></a>01645 <span class="stringliteral">    $self-&gt;{tree}{open} = $self-&gt;{tree}{close} = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l01646"></a>01646 <span class="stringliteral">    $cmp-&gt;ans_hash(correct_ans =&gt; $self-&gt;stringify)</span>
<a name="l01647"></a>01647 <span class="stringliteral">      unless defined($self-&gt;{correct_ans});</span>
<a name="l01648"></a>01648 <span class="stringliteral">  }</span>
<a name="l01649"></a>01649 <span class="stringliteral">  if ($cmp-&gt;{rh_ans}{eval} &amp;&amp; $self-&gt;isConstant) {</span>
<a name="l01650"></a>01650 <span class="stringliteral">    $cmp-&gt;ans_hash(correct_value =&gt; $self-&gt;eval);</span>
<a name="l01651"></a>01651 <span class="stringliteral">    return $cmp;</span>
<a name="l01652"></a>01652 <span class="stringliteral">  }</span>
<a name="l01653"></a>01653 <span class="stringliteral">  if ($cmp-&gt;{rh_ans}{upToConstant}) {</span>
<a name="l01654"></a>01654 <span class="stringliteral">    my $current = Parser::Context-&gt;current();</span>
<a name="l01655"></a>01655 <span class="stringliteral">    my $context = $self-&gt;{context} = $self-&gt;{context}-&gt;copy;</span>
<a name="l01656"></a>01656 <span class="stringliteral">    Parser::Context-&gt;current(undef,$context);</span>
<a name="l01657"></a>01657 <span class="stringliteral">    $context-&gt;variables-&gt;add(&#39;</span>C0<span class="stringliteral">&#39; =&gt; &#39;</span>Parameter<span class="stringliteral">&#39;);</span>
<a name="l01658"></a>01658 <span class="stringliteral">    my $f = $self-&gt;Package(&quot;Formula&quot;)-&gt;new(&#39;</span>C0<span class="stringliteral">&#39;)+$self;</span>
<a name="l01659"></a>01659 <span class="stringliteral">    for (&#39;</span>limits<span class="charliteral">&#39;,&#39;</span>test_points<span class="charliteral">&#39;,&#39;</span>test_values<span class="charliteral">&#39;,&#39;</span>num_points<span class="charliteral">&#39;,&#39;</span>granularity<span class="charliteral">&#39;,&#39;</span>resolution<span class="stringliteral">&#39;,</span>
<a name="l01660"></a>01660 <span class="stringliteral">     &#39;</span>checkUndefinedPoints<span class="charliteral">&#39;,&#39;</span>max_undefined<span class="stringliteral">&#39;)</span>
<a name="l01661"></a>01661 <span class="stringliteral">      {$f-&gt;{$_} = $self-&gt;{$_} if defined($self-&gt;{$_})}</span>
<a name="l01662"></a>01662 <span class="stringliteral">    $cmp-&gt;ans_hash(correct_value =&gt; $f);</span>
<a name="l01663"></a>01663 <span class="stringliteral">    Parser::Context-&gt;current(undef,$current);</span>
<a name="l01664"></a>01664 <span class="stringliteral">  }</span>
<a name="l01665"></a>01665 <span class="stringliteral">  $cmp-&gt;install_pre_filter(\&amp;Value::Formula::cmp_call_filter,&quot;cmp_prefilter&quot;);</span>
<a name="l01666"></a>01666 <span class="stringliteral">  $cmp-&gt;install_post_filter(\&amp;Value::Formula::cmp_call_filter,&quot;cmp_postfilter&quot;);</span>
<a name="l01667"></a>01667 <span class="stringliteral">  return $cmp;</span>
<a name="l01668"></a><a class="code" href="classValue_1_1Vector.html">01668</a> <span class="stringliteral">}</span>
<a name="l01669"></a>01669 <span class="stringliteral"></span>
<a name="l01670"></a>01670 <span class="stringliteral">sub cmp_call_filter {</span>
<a name="l01671"></a>01671 <span class="stringliteral">  my $ans = shift; my $method = shift;</span>
<a name="l01672"></a>01672 <span class="stringliteral">  return $ans-&gt;{correct_value}-&gt;$method($ans,@_);</span>
<a name="l01673"></a>01673 <span class="stringliteral">}</span>
<a name="l01674"></a>01674 <span class="stringliteral"></span>
<a name="l01675"></a>01675 <span class="stringliteral">sub cmp_prefilter {</span>
<a name="l01676"></a>01676 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l01677"></a>01677 <span class="stringliteral">  $ans-&gt;{_filter_name} = &quot;fetch_previous_answer&quot;;</span>
<a name="l01678"></a>01678 <span class="stringliteral">  $ans-&gt;{prev_ans} = undef;</span>
<a name="l01679"></a>01679 <span class="stringliteral">  if (defined($ans-&gt;{ans_label})) {</span>
<a name="l01680"></a>01680 <span class="stringliteral">    my $label = &quot;previous_&quot;.$ans-&gt;{ans_label};</span>
<a name="l01681"></a>01681 <span class="stringliteral">    my $inputs = $self-&gt;getPG(&#39;</span>$inputs_ref<span class="stringliteral">&#39;);</span>
<a name="l01682"></a>01682 <span class="stringliteral">    if (defined $inputs-&gt;{$label} and $inputs-&gt;{$label} =~ /\S/) {</span>
<a name="l01683"></a>01683 <span class="stringliteral">      $ans-&gt;{prev_ans} = $inputs-&gt;{$label};</span>
<a name="l01684"></a>01684 <span class="stringliteral">      #FIXME -- previous answer item is not always being updated in inputs_ref (which comes from formField)</span>
<a name="l01685"></a>01685 <span class="stringliteral">    }</span>
<a name="l01686"></a>01686 <span class="stringliteral">  }</span>
<a name="l01687"></a>01687 <span class="stringliteral">  return $ans;</span>
<a name="l01688"></a>01688 <span class="stringliteral">}</span>
<a name="l01689"></a>01689 <span class="stringliteral"></span>
<a name="l01690"></a>01690 <span class="stringliteral">sub cmp_postfilter {</span>
<a name="l01691"></a>01691 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l01692"></a>01692 <span class="stringliteral">  $ans-&gt;{_filter_name} = &quot;produce_equivalence_message&quot;;</span>
<a name="l01693"></a>01693 <span class="stringliteral">  return $ans if $ans-&gt;{ans_message}; # don&#39;</span>t overwrite other messages
<a name="l01694"></a>01694   <span class="keywordflow">return</span> $ans unless defined($ans-&gt;{prev_ans}); # <span class="keywordflow">if</span> prefilters are erased, don<span class="stringliteral">&#39;t do this check</span>
<a name="l01695"></a>01695 <span class="stringliteral">  my $context = $self-&gt;context;</span>
<a name="l01696"></a>01696 <span class="stringliteral">  $ans-&gt;{prev_formula} = Parser::Formula($context,$ans-&gt;{prev_ans});</span>
<a name="l01697"></a>01697 <span class="stringliteral">  if (defined($ans-&gt;{prev_formula}) &amp;&amp; defined($ans-&gt;{student_formula})) {</span>
<a name="l01698"></a>01698 <span class="stringliteral">    my $prev = eval {$self-&gt;promote($ans-&gt;{prev_formula})-&gt;inherit($self)}; # inherit limits, etc.</span>
<a name="l01699"></a>01699 <span class="stringliteral">    break unless defined($prev);</span>
<a name="l01700"></a>01700 <span class="stringliteral">    $context-&gt;{answerHash} = $ans; # values here can override context flags</span>
<a name="l01701"></a>01701 <span class="stringliteral">    $ans-&gt;{prev_equals_current} = Value::cmp_compare($prev,$ans-&gt;{student_formula},$ans);</span>
<a name="l01702"></a>01702 <span class="stringliteral">    $context-&gt;{answerHash} = undef;</span>
<a name="l01703"></a>01703 <span class="stringliteral">    if (   !$ans-&gt;{isPreview}                                 # not preview mode</span>
<a name="l01704"></a>01704 <span class="stringliteral">    and $ans-&gt;{prev_equals_current}                       # equivalent</span>
<a name="l01705"></a>01705 <span class="stringliteral">    and $ans-&gt;{prev_ans} ne $ans-&gt;{original_student_ans}) # but not identical</span>
<a name="l01706"></a>01706 <span class="stringliteral">      {$ans-&gt;{ans_message} = &quot;This answer is equivalent to the one you just submitted.&quot;}</span>
<a name="l01707"></a>01707 <span class="stringliteral">  }</span>
<a name="l01708"></a>01708 <span class="stringliteral">  return $ans;</span>
<a name="l01709"></a>01709 <span class="stringliteral">}</span>
<a name="l01710"></a>01710 <span class="stringliteral"></span>
<a name="l01711"></a>01711 <span class="stringliteral"></span>
<a name="l01712"></a>01712 <span class="stringliteral">sub cmp_equal {</span>
<a name="l01713"></a>01713 <span class="stringliteral">  my $self = shift; my $ans = shift;</span>
<a name="l01714"></a>01714 <span class="stringliteral">  #</span>
<a name="l01715"></a>01715 <span class="stringliteral">  #  Get the problem&#39;</span>s seed
<a name="l01716"></a>01716 <span class="preprocessor">  #</span>
<a name="l01717"></a>01717 <span class="preprocessor"></span>  $self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;flags-&gt;set(
<a name="l01718"></a>01718     random_seed =&gt; $self-&gt;getPG(<span class="stringliteral">&#39;$PG_original_problemSeed&#39;</span>)
<a name="l01719"></a>01719   );
<a name="l01720"></a>01720 
<a name="l01721"></a>01721 <span class="preprocessor">  #</span>
<a name="l01722"></a>01722 <span class="preprocessor"></span><span class="preprocessor">  #  Use the list checker if the formula is a list or union</span>
<a name="l01723"></a>01723 <span class="preprocessor"></span><span class="preprocessor">  #    Otherwise use the normal checker</span>
<a name="l01724"></a>01724 <span class="preprocessor"></span><span class="preprocessor">  #</span>
<a name="l01725"></a>01725 <span class="preprocessor"></span>  <span class="keywordflow">if</span> ($self-&gt;type =~ m/^(<a class="code" href="classList.html">List</a>|Union|Set)$/) {
<a name="l01726"></a>01726     <a class="code" href="classValue_1_1List.html#a6092a81a76f15a76b7a0bf0f96b3cb6d">Value::List::cmp_equal</a>($self,$ans);
<a name="l01727"></a>01727   } <span class="keywordflow">else</span> {
<a name="l01728"></a>01728     $self-&gt;SUPER::cmp_equal($ans);
<a name="l01729"></a>01729   }
<a name="l01730"></a>01730 }
<a name="l01731"></a>01731 
<a name="l01732"></a>01732 sub cmp_postprocess {
<a name="l01733"></a>01733   my $self = shift; my $ans = shift;
<a name="l01734"></a>01734   <span class="keywordflow">return</span> unless $ans-&gt;{score} == 0;
<a name="l01735"></a>01735   $self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;clearError;
<a name="l01736"></a>01736   eval {$ans-&gt;{student_formula}-&gt;reduce} <span class="keywordflow">if</span> defined($ans-&gt;{student_formula}); # check <span class="keywordflow">for</span> bad function calls
<a name="l01737"></a>01737   $self-&gt;cmp_error($ans) <span class="keywordflow">if</span> $self-&gt;{<a class="code" href="classcontext.html">context</a>}{error}{flag};                    #  and report the error
<a name="l01738"></a>01738   <span class="keywordflow">return</span> <span class="keywordflow">if</span> $ans-&gt;{ans_message} || $ans-&gt;{isPreview};
<a name="l01739"></a>01739   <span class="keywordflow">if</span> ($self-&gt;{domainMismatch} &amp;&amp; $ans-&gt;{showDomainErrors}) {
<a name="l01740"></a>01740     $self-&gt;cmp_Error($ans,<span class="stringliteral">&quot;The domain of your function doesn&#39;t match that of the correct answer&quot;</span>);
<a name="l01741"></a>01741     <span class="keywordflow">return</span>;
<a name="l01742"></a>01742   }
<a name="l01743"></a>01743   <span class="keywordflow">return</span> <span class="keywordflow">if</span> !$ans-&gt;{showDimensionHints};
<a name="l01744"></a>01744   my $other = $ans-&gt;{student_value};
<a name="l01745"></a>01745   <span class="keywordflow">return</span> <span class="keywordflow">if</span> $ans-&gt;{ignoreStrings} &amp;&amp; (!<a class="code" href="classValue.html#a43e6b7aa1e386a5a9056190d0ac3cbb3">Value::isValue</a>($other) || $other-&gt;type eq <span class="stringliteral">&#39;String&#39;</span>);
<a name="l01746"></a>01746   <span class="keywordflow">return</span> unless $other-&gt;type =~ m/^(Point|Vector|<a class="code" href="classMatrix.html">Matrix</a>)$/;
<a name="l01747"></a>01747   <span class="keywordflow">return</span> unless $self-&gt;type  =~ m/^(Point|Vector|<a class="code" href="classMatrix.html">Matrix</a>)$/;
<a name="l01748"></a>01748   <span class="keywordflow">return</span> <span class="keywordflow">if</span> <a class="code" href="classParser_1_1Item.html#ab2aca365840f554d7a59aff1044d6976">Parser::Item::typeMatch</a>($self-&gt;typeRef,$other-&gt;typeRef);
<a name="l01749"></a>01749   $self-&gt;cmp_Error($ans,<span class="stringliteral">&quot;The dimension of your result is incorrect&quot;</span>);
<a name="l01750"></a>01750 }
<a name="l01751"></a>01751 
<a name="l01752"></a>01752 <span class="preprocessor">#</span>
<a name="l01753"></a>01753 <span class="preprocessor"></span><span class="preprocessor">#  Diagnostics for Formulas</span>
<a name="l01754"></a>01754 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01755"></a>01755 <span class="preprocessor"></span>sub cmp_diagnostics {
<a name="l01756"></a>01756   my $self = shift;  my $ans = shift;
<a name="l01757"></a>01757   my $isEvaluator = (ref($ans) =~ /Evaluator/)? 1: 0;
<a name="l01758"></a>01758   my $hash = $isEvaluator? $ans-&gt;rh_ans : $ans;
<a name="l01759"></a>01759   my $diagnostics = $self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;diagnostics-&gt;merge(<span class="stringliteral">&quot;formulas&quot;</span>,$self,$hash);
<a name="l01760"></a>01760   my $formulas = $diagnostics-&gt;{formulas};
<a name="l01761"></a>01761   <span class="keywordflow">return</span> unless $formulas-&gt;{show};
<a name="l01762"></a>01762 
<a name="l01763"></a>01763   my $output = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01764"></a>01764   <span class="keywordflow">if</span> ($isEvaluator) {
<a name="l01765"></a>01765 <span class="preprocessor">    #</span>
<a name="l01766"></a>01766 <span class="preprocessor"></span><span class="preprocessor">    #  The tests to be performed when the answer checker is created</span>
<a name="l01767"></a>01767 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01768"></a>01768 <span class="preprocessor"></span>    $self-&gt;getPG(<span class="stringliteral">&#39;loadMacros(&quot;PGgraphmacros.pl&quot;)&#39;</span>);
<a name="l01769"></a>01769     my ($inputs) = $self-&gt;getPG(<span class="stringliteral">&#39;$inputs_ref&#39;</span>);
<a name="l01770"></a>01770     my $process = $inputs-&gt;{checkAnswers} || $inputs-&gt;{previewAnswers} || $inputs-&gt;{submitAnswers};
<a name="l01771"></a>01771     <span class="keywordflow">if</span> ($formulas-&gt;{checkNumericStability} &amp;&amp; !$process) {
<a name="l01772"></a>01772 <span class="preprocessor">      ### still needs to be written</span>
<a name="l01773"></a>01773 <span class="preprocessor"></span>    }
<a name="l01774"></a>01774   } <span class="keywordflow">else</span> {
<a name="l01775"></a>01775 <span class="preprocessor">    #</span>
<a name="l01776"></a>01776 <span class="preprocessor"></span><span class="preprocessor">    #  The checks to be performed when an answer is submitted</span>
<a name="l01777"></a>01777 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01778"></a>01778 <span class="preprocessor"></span>    my $student = $ans-&gt;{student_formula};
<a name="l01779"></a>01779 <span class="preprocessor">    #</span>
<a name="l01780"></a>01780 <span class="preprocessor"></span><span class="preprocessor">    #  Get the test points</span>
<a name="l01781"></a>01781 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01782"></a>01782 <span class="preprocessor"></span>    my @names = $self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;variables-&gt;names;
<a name="l01783"></a>01783     my $vx = (keys(%{$self-&gt;{variables}}))[0];
<a name="l01784"></a>01784     my $vi = 0; <span class="keywordflow">while</span> ($names[$vi] ne $vx) {$vi++}
<a name="l01785"></a>01785     my $points = [map {$_-&gt;[$vi]} @{$self-&gt;{test_points}}];
<a name="l01786"></a>01786     my @params = $self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;variables-&gt;parameters;
<a name="l01787"></a>01787        @names = $self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;variables-&gt;variables;
<a name="l01788"></a>01788 
<a name="l01789"></a>01789 <span class="preprocessor">    #</span>
<a name="l01790"></a>01790 <span class="preprocessor"></span><span class="preprocessor">    #  The graphs of the functions and errors</span>
<a name="l01791"></a>01791 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01792"></a>01792 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($formulas-&gt;{showGraphs}) {
<a name="l01793"></a>01793       my @G = ();
<a name="l01794"></a>01794       <span class="keywordflow">if</span> ($formulas-&gt;{combineGraphs}) {
<a name="l01795"></a>01795     push(@G,$self-&gt;cmp_graph($diagnostics,[$student,$self],
<a name="l01796"></a>01796                  title=&gt;<span class="stringliteral">&#39;Student Answer (red)&lt;BR&gt;Correct Answer (green)&lt;BR&gt;&#39;</span>,
<a name="l01797"></a>01797                  points=&gt;$points,showDomain=&gt;1));
<a name="l01798"></a>01798       } <span class="keywordflow">else</span> {
<a name="l01799"></a>01799     push(@G,$self-&gt;cmp_graph($diagnostics,$self,title=&gt;<span class="stringliteral">&#39;Correct Answer&#39;</span>));
<a name="l01800"></a>01800     push(@G,$self-&gt;cmp_graph($diagnostics,$student,title=&gt;<span class="stringliteral">&#39;Student Answer&#39;</span>));
<a name="l01801"></a>01801       }
<a name="l01802"></a>01802       my $cutoff = $self-&gt;Package(<span class="stringliteral">&quot;Formula&quot;</span>)-&gt;new($self-&gt;getFlag(<span class="stringliteral">&#39;tolerance&#39;</span>));
<a name="l01803"></a>01803       <span class="keywordflow">if</span> ($formulas-&gt;{graphAbsoluteErrors}) {
<a name="l01804"></a>01804     push(@G,$self-&gt;cmp_graph($diagnostics,[abs($self-$student),$cutoff],
<a name="l01805"></a>01805                  clip=&gt;$formulas-&gt;{clipAbsoluteError},
<a name="l01806"></a>01806                  title=&gt;<span class="stringliteral">&#39;Absolute Error&#39;</span>,points=&gt;$points));
<a name="l01807"></a>01807       }
<a name="l01808"></a>01808       <span class="keywordflow">if</span> ($formulas-&gt;{graphRelativeErrors}) {
<a name="l01809"></a>01809     push(@G,$self-&gt;cmp_graph($diagnostics,[abs(($self-$student)/$self),$cutoff],
<a name="l01810"></a>01810                  clip=&gt;$formulas-&gt;{clipRelativeError},
<a name="l01811"></a>01811                  title=&gt;<span class="stringliteral">&#39;Relative Error&#39;</span>,points=&gt;$points));
<a name="l01812"></a>01812       }
<a name="l01813"></a>01813       $output .= <span class="stringliteral">&#39;&lt;TABLE BORDER=&quot;0&quot; CELLSPACING=&quot;0&quot; CELLPADDING=&quot;0&quot;&gt;&#39;</span>
<a name="l01814"></a>01814     . <span class="stringliteral">&#39;&lt;TR VALIGN=&quot;TOP&quot;&gt;&#39;</span>.join(<span class="stringliteral">&#39;&lt;TD WIDTH=&quot;20&quot;&gt;&lt;/TD&gt;&#39;</span>,@G).<span class="stringliteral">&#39;&lt;/TR&gt;&lt;/TABLE&gt;&#39;</span>;
<a name="l01815"></a>01815     }
<a name="l01816"></a>01816 
<a name="l01817"></a>01817 <span class="preprocessor">    #</span>
<a name="l01818"></a>01818 <span class="preprocessor"></span><span class="preprocessor">    #  The adaptive parameters</span>
<a name="l01819"></a>01819 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01820"></a>01820 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($formulas-&gt;{showParameters} &amp;&amp; scalar(@params) &gt; 0) {
<a name="l01821"></a>01821       $output .= <span class="stringliteral">&#39;&lt;HR&gt;&lt;TABLE BORDER=&quot;0&quot; CELLSPACING=&quot;0&quot; CELLPADDING=&quot;0&quot;&gt;&lt;TR&gt;&lt;TD&gt;Adaptive Parameters:&lt;BR&gt;&#39;</span>;
<a name="l01822"></a>01822       $output .= join(<span class="stringliteral">&quot;&lt;BR&gt;&quot;</span>,map {<span class="stringliteral">&quot;&amp;nbsp;&amp;nbsp;$params[$_]: &quot;</span>.$self-&gt;{parameters}[$_]} (0..$#params));
<a name="l01823"></a>01823       $output .= <span class="stringliteral">&#39;&lt;/TD&gt;&lt;/TR&gt;&lt;/TABLE&gt;&#39;</span>;
<a name="l01824"></a>01824     }
<a name="l01825"></a>01825 
<a name="l01826"></a>01826 <span class="preprocessor">    #</span>
<a name="l01827"></a>01827 <span class="preprocessor"></span><span class="preprocessor">    #  The test points and values</span>
<a name="l01828"></a>01828 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01829"></a>01829 <span class="preprocessor"></span>    my @rows = (); my $colsep = <span class="stringliteral">&#39;&lt;/TD&gt;&lt;TD WIDTH=&quot;20&quot;&gt;&lt;/TD&gt;&lt;TD ALIGN=&quot;RIGHT&quot;&gt;&#39;</span>;
<a name="l01830"></a>01830     my @P = (map {(scalar(@{$_}) == 1)? $_-&gt;[0]: $self-&gt;Package(<span class="stringliteral">&quot;Point&quot;</span>)-&gt;make(@{$_})} @{$self-&gt;{test_points}});
<a name="l01831"></a>01831     my @i = sort {$P[$a] &lt;=&gt; $P[$b]} (0..$#P);
<a name="l01832"></a>01832     <span class="keywordflow">foreach</span> $p (@P) {<span class="keywordflow">if</span> (<a class="code" href="classValue.html#a43e6b7aa1e386a5a9056190d0ac3cbb3">Value::isValue</a>($p) &amp;&amp; $p-&gt;length &gt; 2) {$p = $p-&gt;string; $p =~ s|,|,&lt;br /&gt;|g}}
<a name="l01833"></a>01833     my $zeroLevelTol = $self-&gt;{<a class="code" href="classcontext.html">context</a>}{flags}{zeroLevelTol};
<a name="l01834"></a>01834     $self-&gt;{<a class="code" href="classcontext.html">context</a>}{flags}{zeroLevelTol} = 0; # always show full resolution in the tables below
<a name="l01835"></a>01835     my $names = join(<span class="charliteral">&#39;,&#39;</span>,@names); $names = <span class="charliteral">&#39;(&#39;</span>.$names.<span class="charliteral">&#39;)&#39;</span> <span class="keywordflow">if</span> scalar(@names) &gt; 1;
<a name="l01836"></a>01836 
<a name="l01837"></a>01837     $student-&gt;createPointValues($self-&gt;{test_points},0,1,1) unless $student-&gt;{test_values};
<a name="l01838"></a>01838 
<a name="l01839"></a>01839     my $cv = $self-&gt;{test_values};
<a name="l01840"></a>01840     my $sv = $student-&gt;{test_values};
<a name="l01841"></a>01841     my $av = $self-&gt;{test_adapt} || $cv;
<a name="l01842"></a>01842 
<a name="l01843"></a>01843     <span class="keywordflow">if</span> ($formulas-&gt;{showTestPoints}) {
<a name="l01844"></a>01844       my @p = (<span class="stringliteral">&quot;$names:&quot;</span>, (map {$P[$i[$_]]} (0..$#P)));
<a name="l01845"></a>01845       push(@rows,<span class="stringliteral">&#39;&lt;TR&gt;&lt;TD ALIGN=&quot;RIGHT&quot;&gt;&#39;</span>.join($colsep,@p).<span class="stringliteral">&#39;&lt;/TD&gt;&lt;/TR&gt;&#39;</span>);
<a name="l01846"></a>01846       push(@rows,<span class="stringliteral">&#39;&lt;TR&gt;&lt;TD ALIGN=&quot;RIGHT&quot;&gt;&#39;</span>.join($colsep,(<span class="stringliteral">&quot;&lt;HR&gt;&quot;</span>)x scalar(@p)).<span class="stringliteral">&#39;&lt;/TD&gt;&lt;/TR&gt;&#39;</span>);
<a name="l01847"></a>01847       push(@rows,<span class="stringliteral">&#39;&lt;TR&gt;&lt;TD ALIGN=&quot;RIGHT&quot;&gt;&#39;</span>
<a name="l01848"></a>01848        .join($colsep,($av == $cv)? <span class="stringliteral">&quot;Correct Answer:&quot;</span> : <span class="stringliteral">&quot;Adapted Answer:&quot;</span>,
<a name="l01849"></a>01849          map {<a class="code" href="classValue.html#a6dca6c242402a7860ea097c0e052b243">Value::isNumber</a>($av-&gt;[$i[$_]])? $av-&gt;[$i[$_]]: <span class="stringliteral">&quot;undefined&quot;</span>} (0..$#P))
<a name="l01850"></a>01850        .<span class="stringliteral">&#39;&lt;/TD&gt;&lt;/TR&gt;&#39;</span>);
<a name="l01851"></a>01851       push(@rows,<span class="stringliteral">&#39;&lt;TR&gt;&lt;TD ALIGN=&quot;RIGHT&quot;&gt;&#39;</span>
<a name="l01852"></a>01852        .join($colsep,<span class="stringliteral">&quot;Student Answer:&quot;</span>,
<a name="l01853"></a>01853          map {<a class="code" href="classValue.html#a6dca6c242402a7860ea097c0e052b243">Value::isNumber</a>($sv-&gt;[$i[$_]])? $sv-&gt;[$i[$_]]: <span class="stringliteral">&quot;undefined&quot;</span>} (0..$#P))
<a name="l01854"></a>01854        .<span class="stringliteral">&#39;&lt;/TD&gt;&lt;/TR&gt;&#39;</span>);
<a name="l01855"></a>01855     }
<a name="l01856"></a>01856 <span class="preprocessor">    #</span>
<a name="l01857"></a>01857 <span class="preprocessor"></span><span class="preprocessor">    #  The absolute errors (colored by whether they are ok or too big)</span>
<a name="l01858"></a>01858 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01859"></a>01859 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($formulas-&gt;{showAbsoluteErrors}) {
<a name="l01860"></a>01860       my @p = (<span class="stringliteral">&quot;Absolute Error:&quot;</span>);
<a name="l01861"></a>01861       my $tolerance = $self-&gt;getFlag(<span class="stringliteral">&#39;tolerance&#39;</span>);
<a name="l01862"></a>01862       my $tolType = $self-&gt;getFlag(<span class="stringliteral">&#39;tolType&#39;</span>); my $error;
<a name="l01863"></a>01863       <span class="keywordflow">foreach</span> my $j (0..$#P) {
<a name="l01864"></a>01864     <span class="keywordflow">if</span> (<a class="code" href="classValue.html#a6dca6c242402a7860ea097c0e052b243">Value::isNumber</a>($sv-&gt;[$i[$j]])) {
<a name="l01865"></a>01865       $error = abs($av-&gt;[$i[$j]] - $sv-&gt;[$i[$j]]);
<a name="l01866"></a>01866       $error = <span class="stringliteral">&#39;&lt;SPAN STYLE=&quot;color:#&#39;</span>.($error-&gt;value&lt;$tolerance ? <span class="stringliteral">&#39;00AA00&#39;</span>: <span class="stringliteral">&#39;AA0000&#39;</span>).<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$error.<span class="stringliteral">&#39;&lt;/SPAN&gt;&#39;</span>
<a name="l01867"></a>01867         <span class="keywordflow">if</span> $tolType eq <span class="stringliteral">&#39;absolute&#39;</span>;
<a name="l01868"></a>01868     } <span class="keywordflow">else</span> {$error = <span class="stringliteral">&quot;---&quot;</span>}
<a name="l01869"></a>01869     push(@p,$error);
<a name="l01870"></a>01870       }
<a name="l01871"></a>01871       push(@rows,<span class="stringliteral">&#39;&lt;TR&gt;&lt;TD ALIGN=&quot;RIGHT&quot;&gt;&#39;</span>.join($colsep,@p).<span class="stringliteral">&#39;&lt;/TD&gt;&lt;/TR&gt;&#39;</span>);
<a name="l01872"></a>01872     }
<a name="l01873"></a>01873 <span class="preprocessor">    #</span>
<a name="l01874"></a>01874 <span class="preprocessor"></span><span class="preprocessor">    #  The relative errors (colored by whether they are OK or too big)</span>
<a name="l01875"></a>01875 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01876"></a>01876 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($formulas-&gt;{showRelativeErrors}) {
<a name="l01877"></a>01877       my @p = (<span class="stringliteral">&quot;Relative Error:&quot;</span>);
<a name="l01878"></a>01878       my $tolerance = $self-&gt;getFlag(<span class="stringliteral">&#39;tolerance&#39;</span>); my $tol;
<a name="l01879"></a>01879       my $tolType = $self-&gt;getFlag(<span class="stringliteral">&#39;tolType&#39;</span>); my $error;
<a name="l01880"></a>01880       my $zeroLevel = $self-&gt;getFlag(<span class="stringliteral">&#39;zeroLevel&#39;</span>);
<a name="l01881"></a>01881       <span class="keywordflow">foreach</span> my $j (0..$#P) {
<a name="l01882"></a>01882     <span class="keywordflow">if</span> (<a class="code" href="classValue.html#a6dca6c242402a7860ea097c0e052b243">Value::isNumber</a>($sv-&gt;[$i[$j]])) {
<a name="l01883"></a>01883       my $c = $av-&gt;[$i[$j]]; my $s = $sv-&gt;[$i[$j]];
<a name="l01884"></a>01884       <span class="keywordflow">if</span> (abs($cv-&gt;[$i[$j]]-&gt;value) &lt; $zeroLevel || abs($s-&gt;value) &lt; $zeroLevel)
<a name="l01885"></a>01885             {$error = abs($c-$s); $tol = $zeroLevelTol} <span class="keywordflow">else</span>
<a name="l01886"></a>01886             {$error = abs(($c-$s)/($c||1E-10)); $tol = $tolerance}
<a name="l01887"></a>01887       $error = <span class="stringliteral">&#39;&lt;SPAN STYLE=&quot;color:#&#39;</span>.($error &lt; $tol ? <span class="stringliteral">&#39;00AA00&#39;</span>: <span class="stringliteral">&#39;AA0000&#39;</span>).<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$error.<span class="stringliteral">&#39;&lt;/SPAN&gt;&#39;</span>
<a name="l01888"></a>01888         <span class="keywordflow">if</span> $tolType eq <span class="stringliteral">&#39;relative&#39;</span>;
<a name="l01889"></a>01889     } <span class="keywordflow">else</span> {$error = <span class="stringliteral">&quot;---&quot;</span>}
<a name="l01890"></a>01890     push(@p,$error);
<a name="l01891"></a>01891       }
<a name="l01892"></a>01892       push(@rows,<span class="stringliteral">&#39;&lt;TR&gt;&lt;TD ALIGN=&quot;RIGHT&quot;&gt;&#39;</span>.join($colsep,@p).<span class="stringliteral">&#39;&lt;/TD&gt;&lt;/TR&gt;&#39;</span>);
<a name="l01893"></a>01893     }
<a name="l01894"></a>01894     $self-&gt;{<a class="code" href="classcontext.html">context</a>}{flags}{zeroLevelTol} = $zeroLevelTol;
<a name="l01895"></a>01895 <span class="preprocessor">    #</span>
<a name="l01896"></a>01896 <span class="preprocessor"></span><span class="preprocessor">    #  Put the data into a table</span>
<a name="l01897"></a>01897 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01898"></a>01898 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (scalar(@rows)) {
<a name="l01899"></a>01899       $output .= <span class="stringliteral">&#39;&lt;p&gt;&lt;HR&gt;&lt;p&gt;&lt;TABLE BORDER=&quot;0&quot; CELLSPACING=&quot;0&quot; CELLPADDING=&quot;0&quot;&gt;&#39;</span>
<a name="l01900"></a>01900     . join(<span class="stringliteral">&#39;&lt;TR&gt;&lt;TD HEIGHT=&quot;3&quot;&gt;&lt;/TD&gt;&#39;</span>,@rows)
<a name="l01901"></a>01901     . <span class="stringliteral">&#39;&lt;/TABLE&gt;&#39;</span>;
<a name="l01902"></a>01902     }
<a name="l01903"></a>01903   }
<a name="l01904"></a>01904 <span class="preprocessor">  #</span>
<a name="l01905"></a>01905 <span class="preprocessor"></span><span class="preprocessor">  #  Put all the diagnostic output into a frame</span>
<a name="l01906"></a><a class="code" href="classValue_1_1Matrix.html">01906</a> <span class="preprocessor"></span><span class="preprocessor">  #</span>
<a name="l01907"></a>01907 <span class="preprocessor"></span>  <span class="keywordflow">return</span> unless $output;
<a name="l01908"></a>01908   $output 
<a name="l01909"></a>01909     = <span class="stringliteral">&#39;&lt;TABLE BORDER=&quot;1&quot; CELLSPACING=&quot;2&quot; CELLPADDING=&quot;20&quot; BGCOLOR=&quot;#F0F0F0&quot;&gt;&#39;</span>
<a name="l01910"></a>01910     . <span class="stringliteral">&#39;&lt;TR&gt;&lt;TD ALIGN=&quot;LEFT&quot;&gt;&lt;B&gt;Diagnostics for &#39;</span>.$self-&gt;string .<span class="stringliteral">&#39;:&lt;/B&gt;&#39;</span>
<a name="l01911"></a>01911     . <span class="stringliteral">&#39;&lt;P&gt;&lt;CENTER&gt;&#39;</span> . $output . <span class="stringliteral">&#39;&lt;/CENTER&gt;&lt;/TD&gt;&lt;/TR&gt;&lt;/TABLE&gt;&lt;P&gt;&#39;</span>;
<a name="l01912"></a>01912   warn $output;
<a name="l01913"></a>01913 }
<a name="l01914"></a>01914 
<a name="l01915"></a>01915 <span class="preprocessor">#</span>
<a name="l01916"></a>01916 <span class="preprocessor"></span><span class="preprocessor">#  Draw a graph from a given Formula object</span>
<a name="l01917"></a>01917 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01918"></a>01918 <span class="preprocessor"></span>sub cmp_graph {
<a name="l01919"></a>01919   my $self = shift; my $diagnostics = shift;
<a name="l01920"></a>01920   my $F1 = shift; my $F2; ($F1,$F2) = @{$F1} <span class="keywordflow">if</span> (ref($F1) eq <span class="stringliteral">&#39;ARRAY&#39;</span>);
<a name="l01921"></a>01921 <span class="preprocessor">  #</span>
<a name="l01922"></a>01922 <span class="preprocessor"></span><span class="preprocessor">  #  Get the various options</span>
<a name="l01923"></a>01923 <span class="preprocessor"></span><span class="preprocessor">  #</span>
<a name="l01924"></a>01924 <span class="preprocessor"></span>  my %options = (title=&gt;<span class="stringliteral">&#39;&#39;</span>,points=&gt;[],@_);
<a name="l01925"></a>01925   my $graphs = $diagnostics-&gt;{graphs};
<a name="l01926"></a>01926   my $limits = $graphs-&gt;{limits}; $limits = $self-&gt;getFlag(<span class="stringliteral">&#39;limits&#39;</span>,[-2,2]) unless $limits;
<a name="l01927"></a>01927   $limits = $limits-&gt;[0] <span class="keywordflow">while</span> ref($limits) eq &#39;ARRAY&#39; &amp;&amp; ref($limits-&gt;[0]) eq &#39;ARRAY&#39;;
<a name="l01928"></a>01928   my $size = $graphs-&gt;{size}; $size = [$size,$size] unless ref($size) eq &#39;ARRAY&#39;;
<a name="l01929"></a>01929   my $steps = $graphs-&gt;{divisions};
<a name="l01930"></a>01930   my $points = $options{points}; my $clip = $options{clip};
<a name="l01931"></a>01931   my ($my,$My) = (0,0); my ($mx,$Mx) = @{$limits};
<a name="l01932"></a>01932   my $dx = ($Mx-$mx)/$steps; my $f; my $y;
<a name="l01933"></a>01933 
<a name="l01934"></a>01934   my @pnames = $self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;variables-&gt;parameters;
<a name="l01935"></a>01935   my @pvalues = ($self-&gt;{parameters} ? @{$self-&gt;{parameters}} : (0) x scalar(@pnames));
<a name="l01936"></a>01936   my $x = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01937"></a>01937 
<a name="l01938"></a>01938 <span class="preprocessor">  #</span>
<a name="l01939"></a>01939 <span class="preprocessor"></span><span class="preprocessor">  #  Find the max and min values of the function</span>
<a name="l01940"></a>01940 <span class="preprocessor"></span><span class="preprocessor">  #</span>
<a name="l01941"></a>01941 <span class="preprocessor"></span>  <span class="keywordflow">foreach</span> $f ($F1,$F2) {
<a name="l01942"></a>01942     next unless defined($f);
<a name="l01943"></a>01943     <span class="keywordflow">foreach</span> my $v (keys(%{$f-&gt;{variables}})) {
<a name="l01944"></a>01944       <span class="keywordflow">if</span> ($v ne $x &amp;&amp; !$f-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;variables-&gt;get($v)-&gt;{parameter}) {
<a name="l01945"></a>01945     <span class="keywordflow">if</span> ($x) {
<a name="l01946"></a>01946       warn <span class="stringliteral">&quot;Only formulas with one variable can be graphed&quot;</span> unless $self-&gt;{graphWarning};
<a name="l01947"></a>01947       $self-&gt;{graphWarning} = 1;
<a name="l01948"></a>01948       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01949"></a>01949     }
<a name="l01950"></a>01950     $x = $v;
<a name="l01951"></a>01951       }
<a name="l01952"></a>01952     }
<a name="l01953"></a>01953     unless ($f-&gt;typeRef-&gt;{length} == 1) {
<a name="l01954"></a>01954       warn <span class="stringliteral">&quot;Only real-valued functions can be graphed&quot;</span> unless $self-&gt;{graphWarning};
<a name="l01955"></a>01955       $self-&gt;{graphWarning} = 1;
<a name="l01956"></a>01956       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01957"></a>01957     }
<a name="l01958"></a>01958     unless ($f-&gt;typeRef-&gt;{length} == 1) {
<a name="l01959"></a>01959       warn <span class="stringliteral">&quot;Only real-valued functions can be graphed&quot;</span>;
<a name="l01960"></a>01960       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01961"></a>01961     }
<a name="l01962"></a>01962     <span class="keywordflow">if</span> ($f-&gt;isConstant) {
<a name="l01963"></a>01963       $y = $f-&gt;eval;
<a name="l01964"></a>01964       $my = $y <span class="keywordflow">if</span> $y &lt; $my; $My = $y if $y &gt; $My;
<a name="l01965"></a>01965     } <span class="keywordflow">else</span> {
<a name="l01966"></a>01966       my $F = $f-&gt;perlFunction(undef,[$x,@pnames]);
<a name="l01967"></a>01967       <span class="keywordflow">foreach</span> my $i (0..$steps-1) {
<a name="l01968"></a>01968         $y = eval {&amp;{$F}($mx+$i*$dx,@pvalues)};
<a name="l01969"></a>01969     next unless defined($y) &amp;&amp; <a class="code" href="classValue.html#a6dca6c242402a7860ea097c0e052b243">Value::isNumber</a>($y);
<a name="l01970"></a>01970         $my = $y <span class="keywordflow">if</span> $y &lt; $my; $My = $y if $y &gt; $My;
<a name="l01971"></a>01971       }
<a name="l01972"></a>01972     }
<a name="l01973"></a>01973   }
<a name="l01974"></a>01974   $My = 1 <span class="keywordflow">if</span> abs($My - $my) &lt; 1E-5;
<a name="l01975"></a>01975   $my *= 1.1; $My *= 1.1;
<a name="l01976"></a>01976   <span class="keywordflow">if</span> ($clip) {
<a name="l01977"></a>01977     $my = -$clip <span class="keywordflow">if</span> $my &lt; -$clip;
<a name="l01978"></a>01978     $My = $clip <span class="keywordflow">if</span> $My &gt; $clip;
<a name="l01979"></a>01979   }
<a name="l01980"></a>01980   $my = -$My/10 <span class="keywordflow">if</span> $my &gt; -$My/10; $My = -$my/10 <span class="keywordflow">if</span> $My &lt; -$my/10;
<a name="l01981"></a>01981   my $a = $self-&gt;Package(<span class="stringliteral">&quot;Real&quot;</span>)-&gt;new(($My-$my)/($Mx-$mx));
<a name="l01982"></a>01982 
<a name="l01983"></a>01983 <span class="preprocessor">  #</span>
<a name="l01984"></a>01984 <span class="preprocessor"></span><span class="preprocessor">  #  Create the graph itself, with suitable title</span>
<a name="l01985"></a>01985 <span class="preprocessor"></span><span class="preprocessor">  #</span>
<a name="l01986"></a>01986 <span class="preprocessor"></span>  my $grf = $self-&gt;getPG(<span class="stringliteral">&#39;$_grf_ = {n =&gt; 0}&#39;</span>);
<a name="l01987"></a>01987   $grf-&gt;{Goptions} = [
<a name="l01988"></a>01988      $mx,$my,$Mx,$My,
<a name="l01989"></a>01989      axes =&gt; $graphs-&gt;{axes},
<a name="l01990"></a>01990      grid =&gt; $graphs-&gt;{grid},
<a name="l01991"></a>01991      size =&gt; $size,
<a name="l01992"></a>01992   ];
<a name="l01993"></a>01993   $grf-&gt;{params} = {
<a name="l01994"></a>01994     names =&gt; [$x,@pnames],
<a name="l01995"></a>01995     values =&gt; {map {$pnames[$_] =&gt; $pvalues[$_]} (0..scalar(@pnames)-1)},
<a name="l01996"></a>01996   };
<a name="l01997"></a>01997   $grf-&gt;{G} = $self-&gt;getPG(<span class="stringliteral">&#39;init_graph(@{$_grf_-&gt;{Goptions}})&#39;</span>);
<a name="l01998"></a>01998   $grf-&gt;{G}-&gt;imageName($grf-&gt;{G}-&gt;imageName.<span class="charliteral">&#39;-&#39;</span>.time()); # avoid browser cache
<a name="l01999"></a>01999   $self-&gt;cmp_graph_function($grf,$F2,<span class="stringliteral">&quot;green&quot;</span>,$steps,$points) <span class="keywordflow">if</span> defined($F2);
<a name="l02000"></a>02000   $self-&gt;cmp_graph_function($grf,$F1,<span class="stringliteral">&quot;red&quot;</span>,$steps,$points);
<a name="l02001"></a>02001   my $image = $self-&gt;getPG(<span class="stringliteral">&#39;alias(insertGraph($_grf_-&gt;{G}))&#39;</span>);
<a name="l02002"></a>02002   $image = <span class="stringliteral">&#39;&lt;IMG SRC=&quot;&#39;</span>.$image.<span class="stringliteral">&#39;&quot; WIDTH=&quot;&#39;</span>.$size-&gt;[0].<span class="stringliteral">&#39;&quot; HEIGHT=&quot;&#39;</span>.$size-&gt;[1].<span class="stringliteral">&#39;&quot; BORDER=&quot;0&quot; STYLE=&quot;margin-bottom:5px&quot;&gt;&#39;</span>;
<a name="l02003"></a>02003   my $title = $options{title}; $title .= <span class="stringliteral">&#39;&lt;DIV STYLE=&quot;margin-top:5px&quot;&gt;&lt;/DIV&gt;&#39;</span> <span class="keywordflow">if</span> $title;
<a name="l02004"></a>02004   $title .= <span class="stringliteral">&quot;&lt;SMALL&gt;Domain: [$mx,$Mx]&lt;/SMALL&gt;&lt;BR&gt;&quot;</span> <span class="keywordflow">if</span> $options{showDomain};
<a name="l02005"></a>02005   $title .= <span class="stringliteral">&quot;&lt;SMALL&gt;Range: [$my,$My]&lt;BR&gt;Aspect ratio: $a:1&lt;/SMALL&gt;&quot;</span>;
<a name="l02006"></a>02006   <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;TD ALIGN=&quot;CENTER&quot; VALIGN=&quot;TOP&quot; NOWRAP&gt;&#39;</span>.$image.<span class="stringliteral">&#39;&lt;BR&gt;&#39;</span>.$title.<span class="stringliteral">&#39;&lt;/TD&gt;&#39;</span>;
<a name="l02007"></a>02007 }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009 <span class="preprocessor">#</span>
<a name="l02010"></a>02010 <span class="preprocessor"></span><span class="preprocessor">#  Add a function to a graph object, and plot the points</span>
<a name="l02011"></a>02011 <span class="preprocessor"></span><span class="preprocessor">#  that are used to test the function</span>
<a name="l02012"></a>02012 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l02013"></a>02013 <span class="preprocessor"></span>sub cmp_graph_function {
<a name="l02014"></a>02014   my $self = shift; my $grf = shift; my $F = shift;
<a name="l02015"></a>02015   my $color = shift; my $steps = shift; my $points = shift;
<a name="l02016"></a>02016   $grf-&gt;{n}++; my $Fn = <span class="stringliteral">&quot;F&quot;</span>.$grf-&gt;{n}; $grf-&gt;{$Fn} = $F; my $f;
<a name="l02017"></a>02017   <span class="keywordflow">if</span> ($F-&gt;isConstant) {
<a name="l02018"></a>02018     my $y = $F-&gt;eval;
<a name="l02019"></a>02019     $f = $self-&gt;getPG(<span class="stringliteral">&#39;new Fun(sub {&#39;</span>.$y.<span class="stringliteral">&#39;},$_grf_-&gt;{G})&#39;</span>);
<a name="l02020"></a>02020   } <span class="keywordflow">else</span> {
<a name="l02021"></a>02021     my $X = $grf-&gt;{params}{names}[0];
<a name="l02022"></a>02022     $f = $self-&gt;getPG(<span class="stringliteral">&#39;new Fun(sub {Parser::Evaluate($_grf_-&gt;{&#39;</span>.$Fn.<span class="stringliteral">&#39;},&#39;</span>
<a name="l02023"></a>02023            .$X.<span class="stringliteral">&#39;=&gt;shift,%{$_grf_-&gt;{params}{values}})},$_grf_-&gt;{G})&#39;</span>);
<a name="l02024"></a>02024     <span class="keywordflow">foreach</span> my $x (@{$points}) {
<a name="l02025"></a>02025       my $y = <a class="code" href="classParser.html#a25690085ad4a6d0a78c8dd5ee84c18a5">Parser::Evaluate</a>($F,($X)=&gt;$x,%{$grf-&gt;{params}{values}});
<a name="l02026"></a>02026       next unless defined($y) &amp;&amp; <a class="code" href="classValue.html#a6dca6c242402a7860ea097c0e052b243">Value::isNumber</a>($y);
<a name="l02027"></a>02027       $grf-&gt;{x} = $x; $grf-&gt;{<span class="charliteral">&#39;y&#39;</span>} = $y;
<a name="l02028"></a>02028       my $C = $self-&gt;getPG(<span class="stringliteral">&#39;new Circle($_grf_-&gt;{x},$_grf_-&gt;{y},4,&quot;&#39;</span>.$color.<span class="stringliteral">&#39;&quot;,&quot;&#39;</span>.$color.<span class="stringliteral">&#39;&quot;)&#39;</span>);
<a name="l02029"></a>02029       $grf-&gt;{G}-&gt;stamps($C);
<a name="l02030"></a>02030     }
<a name="l02031"></a>02031   }
<a name="l02032"></a>02032   $f-&gt;color($color); $f-&gt;weight(2); $f-&gt;steps($steps);
<a name="l02033"></a>02033 }
<a name="l02034"></a>02034 
<a name="l02035"></a>02035 <span class="preprocessor">#</span>
<a name="l02036"></a>02036 <span class="preprocessor"></span><span class="preprocessor">#  If an answer array was used, get the data from the</span>
<a name="l02037"></a>02037 <span class="preprocessor"></span><span class="preprocessor">#  Matrix, Vector or Point, and format the array of</span>
<a name="l02038"></a>02038 <span class="preprocessor"></span><span class="preprocessor">#  data using the original parameter</span>
<a name="l02039"></a>02039 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l02040"></a>02040 <span class="preprocessor"></span>sub correct_ans {
<a name="l02041"></a>02041   my $self = shift;
<a name="l02042"></a>02042   <span class="keywordflow">return</span> $self-&gt;SUPER::correct_ans unless $self-&gt;{ans_name};
<a name="l02043"></a>02043   my @array = ();
<a name="l02044"></a>02044   <span class="keywordflow">if</span> ($self-&gt;{tree}-&gt;type eq <span class="stringliteral">&#39;Matrix&#39;</span>) {
<a name="l02045"></a>02045     <span class="keywordflow">foreach</span> my $row (@{$self-&gt;{tree}{coords}}) {
<a name="l02046"></a>02046       my @row = ();
<a name="l02047"></a>02047       <span class="keywordflow">foreach</span> my $x (@{$row-&gt;coords}) {push(@row,$x-&gt;string)}
<a name="l02048"></a>02048       push(@array,[@row]);
<a name="l02049"></a>02049     }
<a name="l02050"></a>02050   } <span class="keywordflow">else</span> {
<a name="l02051"></a>02051     <span class="keywordflow">foreach</span> my $x (@{$self-&gt;{tree}{coords}}) {push(@array,$x-&gt;string)}
<a name="l02052"></a>02052     <span class="keywordflow">if</span> ($self-&gt;{tree}{ColumnVector}) {<span class="keywordflow">foreach</span> my $x (@array) {$x = [$x]}}
<a name="l02053"></a>02053       <span class="keywordflow">else</span> {@array = [@array]}
<a name="l02054"></a>02054   }
<a name="l02055"></a>02055   <a class="code" href="classValue.html#ad68f66fffac03a06e502e920e63289ac">Value::VERBATIM</a>($self-&gt;format_matrix([@array],@{$self-&gt;{format_options}},tth_delims=&gt;1));
<a name="l02056"></a>02056 }
<a name="l02057"></a>02057 
<a name="l02058"></a>02058 <span class="preprocessor">#</span>
<a name="l02059"></a>02059 <span class="preprocessor"></span><span class="preprocessor">#  Get the size of the array and create the appropriate answer array</span>
<a name="l02060"></a>02060 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l02061"></a>02061 <span class="preprocessor"></span>sub ANS_MATRIX {
<a name="l02062"></a>02062   my $self = shift;
<a name="l02063"></a>02063   my $extend = shift; my $name = shift;
<a name="l02064"></a>02064   my $size = shift || 5; my $type = $self-&gt;type; 
<a name="l02065"></a>02065   my $cols = $self-&gt;length; my $rows = 1; my $sep = <span class="charliteral">&#39;,&#39;</span>;
<a name="l02066"></a>02066   <span class="keywordflow">if</span> ($type eq <span class="stringliteral">&#39;Matrix&#39;</span>) {
<a name="l02067"></a>02067     $sep = <span class="stringliteral">&#39;&#39;</span>; $rows = $cols; $cols = $self-&gt;{tree}-&gt;typeRef-&gt;{entryType}{length};
<a name="l02068"></a>02068   }
<a name="l02069"></a>02069   <span class="keywordflow">if</span> ($self-&gt;{tree}{ColumnVector}) {
<a name="l02070"></a>02070     $sep = <span class="stringliteral">&quot;&quot;</span>; $type = <span class="stringliteral">&quot;Matrix&quot;</span>;
<a name="l02071"></a>02071     my $tmp = $rows; $rows = $cols; $cols = $tmp;
<a name="l02072"></a>02072     $self-&gt;{ColumnVector} = 1;
<a name="l02073"></a>02073   }
<a name="l02074"></a>02074   my $def = $self-&gt;context-&gt;lists-&gt;get($type);
<a name="l02075"></a>02075   my $open = $self-&gt;{open} || $self-&gt;{tree}{open} || $def-&gt;{open};
<a name="l02076"></a>02076   my $close = $self-&gt;{close} || $self-&gt;{tree}{close} || $def-&gt;{close};
<a name="l02077"></a>02077   $self-&gt;ans_matrix($extend,$name,$rows,$cols,$size,$open,$close,$sep);
<a name="l02078"></a>02078 }
<a name="l02079"></a>02079 
<a name="l02080"></a>02080 sub ans_array {
<a name="l02081"></a>02081   my $self = shift;
<a name="l02082"></a>02082   <span class="keywordflow">return</span> $self-&gt;SUPER::ans_array(@_) unless $self-&gt;array_OK;
<a name="l02083"></a>02083   $self-&gt;ANS_MATRIX(0,<span class="stringliteral">&#39;&#39;</span>,@_);
<a name="l02084"></a>02084 }
<a name="l02085"></a>02085 sub named_ans_array {
<a name="l02086"></a>02086   my $self = shift;
<a name="l02087"></a>02087   <span class="keywordflow">return</span> $self-&gt;SUPER::named_ans_array(@_) unless $self-&gt;array_OK;
<a name="l02088"></a>02088   $self-&gt;ANS_MATRIX(0,@_);
<a name="l02089"></a>02089 }
<a name="l02090"></a>02090 sub named_ans_array_extension {
<a name="l02091"></a>02091   my $self = shift;
<a name="l02092"></a>02092   <span class="keywordflow">return</span> $self-&gt;SUPER::named_ans_array_extension(@_) unless $self-&gt;array_OK;
<a name="l02093"></a>02093   $self-&gt;ANS_MATRIX(1,@_);
<a name="l02094"></a>02094 }
<a name="l02095"></a>02095 
<a name="l02096"></a>02096 sub array_OK {
<a name="l02097"></a>02097   my $self = shift; my $tree = $self-&gt;{tree};
<a name="l02098"></a>02098   <span class="keywordflow">return</span> $tree-&gt;type =~ m/^(Point|Vector|<a class="code" href="classMatrix.html">Matrix</a>)$/ &amp;&amp; $tree-&gt;class eq <span class="stringliteral">&#39;List&#39;</span>;
<a name="l02099"></a>02099 }
<a name="l02100"></a>02100 
<a name="l02101"></a>02101 <span class="preprocessor">#</span>
<a name="l02102"></a>02102 <span class="preprocessor"></span><span class="preprocessor">#  Get an array of values from a Matrix, Vector or Point</span>
<a name="l02103"></a>02103 <span class="preprocessor"></span><span class="preprocessor">#  (this needs to be made more general)</span>
<a name="l02104"></a>02104 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l02105"></a>02105 <span class="preprocessor"></span>sub value {
<a name="l02106"></a>02106   my $self = shift;
<a name="l02107"></a>02107   <span class="keywordflow">return</span> $self unless defined $self-&gt;{tree}{coords};
<a name="l02108"></a>02108   my $context = $self-&gt;context;
<a name="l02109"></a>02109   my @array = ();
<a name="l02110"></a>02110   <span class="keywordflow">if</span> ($self-&gt;{tree}-&gt;type eq <span class="stringliteral">&#39;Matrix&#39;</span>) {
<a name="l02111"></a>02111     <span class="keywordflow">foreach</span> my $row (@{$self-&gt;{tree}-&gt;coords}) {
<a name="l02112"></a>02112       my @row = ();
<a name="l02113"></a>02113       <span class="keywordflow">foreach</span> my $x (@{$row-&gt;coords}) {push(@row,$context-&gt;Package(<span class="stringliteral">&quot;Formula&quot;</span>)-&gt;new($context,$x))}
<a name="l02114"></a>02114       push(@array,[@row]);
<a name="l02115"></a>02115     }
<a name="l02116"></a>02116   } <span class="keywordflow">else</span> {
<a name="l02117"></a>02117     <span class="keywordflow">foreach</span> my $x (@{$self-&gt;{tree}-&gt;coords}) {
<a name="l02118"></a>02118       push(@array,$context-&gt;Package(<span class="stringliteral">&quot;Formula&quot;</span>)-&gt;new($context,$x));
<a name="l02119"></a>02119     }
<a name="l02120"></a>02120   }
<a name="l02121"></a>02121   <span class="keywordflow">return</span> @array;
<a name="l02122"></a>02122 }
<a name="l02123"></a>02123 
<a name="l02124"></a>02124 <span class="preprocessor">#############################################################</span>
<a name="l02125"></a>02125 <span class="preprocessor"></span>
<a name="l02126"></a>02126 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:54:54 2012 for PG by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
