<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PG: WeBWorK::PG::ImageGenerator Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="namespaceWeBWorK.html">WeBWorK</a>::<a class="el" href="namespaceWeBWorK_1_1PG.html">PG</a>::<a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html">ImageGenerator</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::PG::ImageGenerator Class Reference</h1><!-- doxytag: class="WeBWorK::PG::ImageGenerator" --><!-- doxytag: inherits="WeBWorK::PG" --><div class="dynheader">
Inheritance diagram for WeBWorK::PG::ImageGenerator:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1PG_1_1ImageGenerator__inherit__graph.png" border="0" usemap="#WeBWorK_1_1PG_1_1ImageGenerator_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1PG_1_1ImageGenerator_inherit__map" id="WeBWorK_1_1PG_1_1ImageGenerator_inherit__map">
<area shape="rect" href="classWeBWorK_1_1PG.html" title="WeBWorK::PG" alt="" coords="56,5,165,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::PG::ImageGenerator:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1PG_1_1ImageGenerator__coll__graph.png" border="0" usemap="#WeBWorK_1_1PG_1_1ImageGenerator_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1PG_1_1ImageGenerator_coll__map" id="WeBWorK_1_1PG_1_1ImageGenerator_coll__map">
<area shape="rect" href="classWeBWorK_1_1PG.html" title="WeBWorK::PG" alt="" coords="56,5,165,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1PG_1_1ImageGenerator-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a72ce9aff1f6463f8477fca553d57b2e8">readFile</a> ($)()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#abd267263d29d08dfc8a4c161c9d0424d">add</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a2ac0c93370fdae43ed1a5762597fe522">addToTeXPreamble</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a98691afa5e444f97c1e0f1b02639952c">makeTempDirectory</a> ($$)()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a2724c99fc6febac69eee3f3e7b72a725">fix_markers</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#aadf27cb8f9606f9daba2601587378676">update_depth_cache</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a6334febe2af35a18c1a4d590b903ceb0">refresh</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a1482df5bf2aa5dee0848426c5e8ee71b">removeTempDirectory</a> ($)()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a2c38cd9b9694ceaa72d6800b099da625">new</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#ab01e8a47b689aa7c7107464ad4752422">readDirectory</a> ($)()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a8c9b4298c062bee342e2f73161b6da83">render</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html">WeBWorK::PG::ImageGenerator</a> - create an object for holding bits of math for LaTeX, and then to process them all at once.</p>
<h2><a class="anchor" id="SYNPOSIS">
SYNPOSIS</a></h2>
<p>FIXME: add this</p>
<h2><a class="anchor" id="CONFIGURATION_VARIABLES">
CONFIGURATION VARIABLES</a></h2>
<ul>
<li>
<p class="startli"><a class="anchor" id="item__DvipngArgs"></a><b>$DvipngArgs</b> </p>
<p class="endli">Arguments to pass to dvipng.  </p>
</li>
</ul>
<p>If true, don't delete temporary files. </p>
<p>TeX to prepend to equations to be processed. </p>
<p>TeX to append to equations to be processed.</p>
<h2><a class="anchor" id="METHODS">
METHODS</a></h2>
<ul>
<li>
<p class="startli"><a class="anchor" id="item_new"></a><b>new</b> </p>
<p>Returns a new <a class="el" href="classWeBWorK_1_1PG_1_1ImageGenerator.html">ImageGenerator</a> object. </p>
<div class="fragment"><pre class="fragment">\%options
</pre></div><p> must contain the following entries: </p>
<pre> tempDir  =&gt; directory in which to create temporary processing directory
 latex    =&gt; path to latex binary
 dvipng   =&gt; path to dvipng binary
 useCache =&gt; boolean, whether to use global image cache</pre><p></p>
<p>If </p>
<div class="fragment"><pre class="fragment">useCache
</pre></div><p> is false, </p>
<div class="fragment"><pre class="fragment">\%options
</pre></div><p> must also contain the following entries: </p>
<pre> dir	  =&gt; directory for resulting files
 url	  =&gt; url to directory for resulting files
 basename =&gt; base name for image files (i.e. "eqn-$psvn-$probNum")</pre><p></p>
<p>If </p>
<div class="fragment"><pre class="fragment">useCache
</pre></div><p> is true, </p>
<div class="fragment"><pre class="fragment">\%options
</pre></div><p> must also contain the following entries: </p>
<pre> cacheDir =&gt; directory for resulting files
 cacheURL =&gt; url to cacheDir
 cacheDB  =&gt; path to cache database file</pre><p></p>
<p>Options may also contain: </p>
<pre> dvipng_align    =&gt; vertical alignment option (a string to use like baseline, or 'mysql')
 dvipng_depth_db =&gt; database connection information for a "depths database"
 useMarkers      =&gt; if you want to have the dvipng images vertically aligned, this involves adding markers</pre><p class="endli"></p>
</li>
</ul>
<p>Adds the string as part of the TeX preamble for all equations in the problem. For example $rh_envir-&gt;{imagegen}-&gt;addToTeXPreamble("\\newcommand{\\myVec}[\#1]{\\vec{\#1}} "); </p>
<p>Will define a question wide style for interpreting \( \myVec{v} \) </p>
<p>If this statement is placed in <a class="el" href="PGcourse_8pl.html">PGcourse.pl</a> then the backslashes must be doubled since it is a .pl file not a .pg file </p>
<p>Forces every equation picture to be recalculated. Useful for debugging. $rh_envir-&gt;{imagegen}-&gt;refresh(1); </p>
<p>Adds the equation in </p>
<div class="fragment"><pre class="fragment">$string
</pre></div><p> to the object. </p>
<div class="fragment"><pre class="fragment">$mode
</pre></div><p> can be "display" or "inline". If not specified, "inline" is assumed. Returns the proper HTML tag for displaying the image. </p>
<p>Uses LaTeX and dvipng to render the equations stored in the object. </p>
<p>The option </p>
<div class="fragment"><pre class="fragment">body_text
</pre></div><p> is a reference to the text of the problem's text. After rendering the images and figuring out their depths, we go through and fix the tags of the images to get the vertical alignment right. If it is left out, then we skip that step. </p>
<p>If the key "mtime" in </p>
<div class="fragment"><pre class="fragment">\%options
</pre></div><p> is given, its value will be interpreted as a unix date and compared with the modification date on any existing copy of the first image to be generated. It is recommended that the modification time of the source file from which the equations originate be used for this value. If the key "refresh" in </p>
<div class="fragment"><pre class="fragment">\%options
</pre></div><p> is true, images will be regenerated regardless of when they were last modified. If neither option is supplied, "refresh" is assumed. </p>
<p>NOTE: It's not clear to me that mtime has been implemented -- MEG - 2011/06 </p>

<p>Definition at line <a class="el" href="ImageGenerator_8pm_source.html#l00127">127</a> of file <a class="el" href="ImageGenerator_8pm_source.html">ImageGenerator.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="abd267263d29d08dfc8a4c161c9d0424d"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::add" ref="abd267263d29d08dfc8a4c161c9d0424d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::add </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-add' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-add-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-add-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-add-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in add: 71</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#abd267263d29d08dfc8a4c161c9d0424d">add</a> {
    my ($self, $string, $mode) = @_;
    
    my $names    = $self-&gt;{names};
    my $strings  = $self-&gt;{strings};
    my $dir      = $self-&gt;{dir};
    my $url      = $self-&gt;{url};
    my $basename = $self-&gt;{basename};
    my $useCache = $self-&gt;{useCache};
    my $depths  = $self-&gt;{depths};
    
<span class="preprocessor">    # if the string came in with delimiters, chop them off and set the mode</span>
<span class="preprocessor"></span><span class="preprocessor">    # based on whether they were \[ .. \] or \( ... \). this means that if</span>
<span class="preprocessor"></span><span class="preprocessor">    # the string has delimiters, the mode *argument* is ignored.</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ($string =~ s/^\\\[(.*)\\\]$/$1/s) {
        $mode = <span class="stringliteral">&quot;display&quot;</span>;
    } elsif ($string =~ s/^\\\((.*)\\\)$/$1/s) {
        $mode = <span class="stringliteral">&quot;inline&quot;</span>;
    }
<span class="preprocessor">    # otherwise, leave the string and the mode alone.</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    # assume that a bare string with no mode specified is inline</span>
<span class="preprocessor"></span>    $mode ||= <span class="stringliteral">&quot;inline&quot;</span>;
    
<span class="preprocessor">    # now that we know what mode we&#39;re dealing with, we can generate a &quot;real&quot;</span>
<span class="preprocessor"></span><span class="preprocessor">    # string to pass to latex</span>
<span class="preprocessor"></span>    my $realString = ($mode eq <span class="stringliteral">&quot;display&quot;</span>)
        ? <span class="stringliteral">&#39;\(\displaystyle{&#39;</span> . $string . <span class="stringliteral">&#39;}\)&#39;</span>
        : <span class="charliteral">&#39;\(&#39;</span> . $string . <span class="charliteral">&#39;\)&#39;</span>;
    
<span class="preprocessor">    # alignment tag could be a fixed default</span>
<span class="preprocessor"></span>    my ($imageNum, $aligntag) = (0, qq|align=<span class="stringliteral">&quot;$self-&gt;{dvipng_align}&quot;</span>|);
<span class="preprocessor">    # if the default is for variable heights, the default should be meaningful</span>
<span class="preprocessor"></span><span class="preprocessor">    # in an answer preview, $self-&gt;{dvipng_align} might be &#39;mysql&#39;, but we still</span>
<span class="preprocessor"></span><span class="preprocessor">        # use a static alignment</span>
<span class="preprocessor"></span>    $aligntag = <span class="stringliteral">&#39;align=&quot;baseline&quot;&#39;</span> <span class="keywordflow">if</span> ($self-&gt;{dvipng_align} eq <span class="stringliteral">&#39;mysql&#39;</span>);

<span class="preprocessor">    # determine what the image&#39;s &quot;number&quot; is</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span>($useCache) {
        $imageNum = $self-&gt;{equationCache}-&gt;lookup($realString);
        $aligntag = <span class="stringliteral">&#39;MaRkEr&#39;</span>.$imageNum <span class="keywordflow">if</span> $self-&gt;{useMarkers};
        $depths-&gt;{<span class="stringliteral">&quot;$imageNum&quot;</span>} = <span class="stringliteral">&#39;none&#39;</span> <span class="keywordflow">if</span> ($self-&gt;{dvipng_align} eq <span class="stringliteral">&#39;mysql&#39;</span>);
<span class="preprocessor">        # insert a slash after 2 characters</span>
<span class="preprocessor"></span><span class="preprocessor">        # this effectively divides the images into 16^2 = 256 subdirectories</span>
<span class="preprocessor"></span>        substr($imageNum,2,0) = <span class="charliteral">&#39;/&#39;</span>;
    } <span class="keywordflow">else</span> {
        $imageNum = @$strings + 1;
    }
    
<span class="preprocessor">    # We are banking on the fact that if useCache is true, then basename is empty.</span>
<span class="preprocessor"></span><span class="preprocessor">    # Maybe we should simplify and drop support for useCache =0 and having a basename.</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # get the full file name of the image</span>
<span class="preprocessor"></span>    my $imageName = ($basename)
        ? <span class="stringliteral">&quot;$basename.$imageNum.png&quot;</span>
        : <span class="stringliteral">&quot;$imageNum.png&quot;</span>;
    
<span class="preprocessor">    # store the full file name of the image, and the &quot;real&quot; tex string to the object</span>
<span class="preprocessor"></span>    push @$names, $imageName;
    push @$strings, $realString;
<span class="preprocessor">    #warn &quot;ImageGenerator: added string $realString with name $imageName\n&quot;;</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    # ... and the full URL.</span>
<span class="preprocessor"></span>    my $imageURL = <span class="stringliteral">&quot;$url/$imageName&quot;</span>;
    
    my $imageTag  = ($mode eq <span class="stringliteral">&quot;display&quot;</span>)
        ? <span class="stringliteral">&quot;&lt;div align=\&quot;center\&quot;&gt;&lt;img src=\&quot;$imageURL\&quot; $aligntag alt=\&quot;$string\&quot;&gt;&lt;/div&gt;&quot;</span>
        : <span class="stringliteral">&quot;&lt;img src=\&quot;$imageURL\&quot; $aligntag alt=\&quot;$string\&quot;&gt;&quot;</span>;

    <span class="keywordflow">return</span> $imageTag;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2ac0c93370fdae43ed1a5762597fe522"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::addToTeXPreamble" ref="a2ac0c93370fdae43ed1a5762597fe522" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::addToTeXPreamble </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-addToTeXPreamble' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-addToTeXPreamble-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-addToTeXPreamble-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-addToTeXPreamble-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in addToTeXPreamble: 6</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a2ac0c93370fdae43ed1a5762597fe522">addToTeXPreamble</a> {
    my $self  = shift;
    my $str   = shift;
    $self-&gt;{texPreambleAdditions} = $str <span class="keywordflow">if</span> defined $str;
    $self-&gt;{texPreambleAdditions};
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2724c99fc6febac69eee3f3e7b72a725"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::fix_markers" ref="a2724c99fc6febac69eee3f3e7b72a725" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::fix_markers </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-fix_markers' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-fix_markers-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-fix_markers-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-fix_markers-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in fix_markers: 13</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a2724c99fc6febac69eee3f3e7b72a725">fix_markers</a> {
    my $self = shift;
    my %depths = %{$self-&gt;{depths}};
    <span class="keywordflow">for</span> my $depthkey (keys %depths) {
        <span class="keywordflow">if</span>($depths{$depthkey} eq <span class="stringliteral">&#39;none&#39;</span>) { # we never found its depth :(
            ${ $self-&gt;{body_text} } =~ s/MaRkEr$depthkey/align=<span class="stringliteral">&quot;ABSMIDDLE&quot;</span>/g;
        } <span class="keywordflow">else</span> {
            my $ndepth = 0 - $depths{$depthkey};
            ${ $self-&gt;{body_text} } =~ s/MaRkEr$depthkey/style=<span class="stringliteral">&quot;vertical-align:${ndepth}px&quot;</span>/g;
        }
    }
    <span class="keywordflow">return</span>();
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a98691afa5e444f97c1e0f1b02639952c"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::makeTempDirectory" ref="a98691afa5e444f97c1e0f1b02639952c" args="($$)()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::makeTempDirectory </td>
          <td>(</td>
          <td class="paramtype">$$&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-makeTempDirectory($$)' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-makeTempDirectory($$)-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-makeTempDirectory($$)-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-makeTempDirectory($$)-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in makeTempDirectory($$): 19</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a98691afa5e444f97c1e0f1b02639952c">makeTempDirectory</a>($$) {
    my ($parent, $basename) = @_;
<span class="preprocessor">    # Loop until we&#39;re able to create a directory, or it fails for some</span>
<span class="preprocessor"></span><span class="preprocessor">    # reason other than there already being something there.</span>
<span class="preprocessor"></span>    my $triesRemaining = MKDIR_ATTEMPTS;
    my ($fullPath, $success);
    <span class="keywordflow">do</span> {
        my $suffix = join <span class="stringliteral">&quot;&quot;</span>, map { (<span class="charliteral">&#39;A&#39;</span>..<span class="charliteral">&#39;Z&#39;</span>,<span class="charliteral">&#39;a&#39;</span>..<span class="charliteral">&#39;z&#39;</span>,<span class="charliteral">&#39;0&#39;</span>..<span class="charliteral">&#39;9&#39;</span>)[<span class="keywordtype">int</span> rand 62] } 1 .. 8;
        $fullPath = <span class="stringliteral">&quot;$parent/$basename.$suffix&quot;</span>;
        $success = mkdir $fullPath;
    } until ($success or not $!{EEXIST});
    unless ($success) {
        my $msg = <span class="stringliteral">&#39;&#39;</span>;
        $msg    .=  <span class="stringliteral">&quot;Server does not have write access to the directory $parent&quot;</span> unless -w $parent;
        die <span class="stringliteral">&quot;$msg\r\nFailed to create directory $fullPath:\r\n $!&quot;</span>
    }

    <span class="keywordflow">return</span> $fullPath;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2c38cd9b9694ceaa72d6800b099da625"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::new" ref="a2c38cd9b9694ceaa72d6800b099da625" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::new </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-new' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-new-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-new-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-new-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in new: 25</span>
<span class="preprocessor"></span>sub <span class="keyword">new</span> {
    my ($invocant, %options) = @_;
    my $class = ref $invocant || $invocant;
    my $self = {
        names   =&gt; [],
        strings =&gt; [],
        texPreambleAdditions =&gt; undef,
        depths =&gt; {},
        %options,
    };

<span class="preprocessor">    # set some values</span>
<span class="preprocessor"></span>    $self-&gt;{dvipng_align} = <span class="stringliteral">&#39;absmiddle&#39;</span> unless defined($self-&gt;{dvipng_align});
    $self-&gt;{store_depths} = 1 <span class="keywordflow">if</span> ($self-&gt;{dvipng_align} eq <span class="stringliteral">&#39;mysql&#39;</span>);
    $self-&gt;{useMarkers} = $self-&gt;{useMarkers} || 0;
    
    <span class="keywordflow">if</span> ($self-&gt;{useCache}) {
        $self-&gt;{dir} = $self-&gt;{cacheDir};
        $self-&gt;{url} = $self-&gt;{cacheURL};
        $self-&gt;{basename} = <span class="stringliteral">&quot;&quot;</span>;
        $self-&gt;{equationCache} = <a class="code" href="classWeBWorK_1_1EquationCache.html">WeBWorK::EquationCache</a>-&gt;new(cacheDB =&gt; $self-&gt;{cacheDB});
    }
    
    bless $self, $class;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ab01e8a47b689aa7c7107464ad4752422"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::readDirectory" ref="ab01e8a47b689aa7c7107464ad4752422" args="($)()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::readDirectory </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-readDirectory($)' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-readDirectory($)-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-readDirectory($)-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-readDirectory($)-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in readDirectory($): 8</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#ab01e8a47b689aa7c7107464ad4752422">readDirectory</a>($) {
    my $dirName = shift;
    opendir my $dh, $dirName
        or die <span class="stringliteral">&quot;Failed to read directory $dirName: $!&quot;</span>;
    my @result = readdir $dh;
    close $dh;
    <span class="keywordflow">return</span> @result;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a72ce9aff1f6463f8477fca553d57b2e8"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::readFile" ref="a72ce9aff1f6463f8477fca553d57b2e8" args="($)()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::readFile </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-readFile($)' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-readFile($)-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-readFile($)-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-readFile($)-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in readFile($): 10</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a72ce9aff1f6463f8477fca553d57b2e8">readFile</a>($) {
    my $filename = shift;
    my $contents = <span class="stringliteral">&#39;&#39;</span>;
    local(*FILEH);
    open FILEH,  <span class="stringliteral">&quot;&lt;$filename&quot;</span> or die <span class="stringliteral">&quot;Unable to read $filename&quot;</span>;
    local($/) = undef;
    $contents = &lt;FILEH&gt;;
    close(FILEH);
    <span class="keywordflow">return</span>($contents);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a6334febe2af35a18c1a4d590b903ceb0"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::refresh" ref="a6334febe2af35a18c1a4d590b903ceb0" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::refresh </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-refresh' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-refresh-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-refresh-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-refresh-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in refresh: 6</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a6334febe2af35a18c1a4d590b903ceb0">refresh</a> {
    my $self  = shift;
    my $in   = shift;
    $self-&gt;{<a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a6334febe2af35a18c1a4d590b903ceb0">refresh</a>} = $in <span class="keywordflow">if</span> defined($in);
    $self-&gt;{<a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a6334febe2af35a18c1a4d590b903ceb0">refresh</a>};
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a1482df5bf2aa5dee0848426c5e8ee71b"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::removeTempDirectory" ref="a1482df5bf2aa5dee0848426c5e8ee71b" args="($)()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::removeTempDirectory </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-removeTempDirectory($)' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-removeTempDirectory($)-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-removeTempDirectory($)-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-removeTempDirectory($)-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in removeTempDirectory($): 4</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a1482df5bf2aa5dee0848426c5e8ee71b">removeTempDirectory</a>($) {
    my ($dir) = @_;
    rmtree($dir, 0, 0);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a8c9b4298c062bee342e2f73161b6da83"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::render" ref="a8c9b4298c062bee342e2f73161b6da83" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::render </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-render' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-render-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-render-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-render-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in render: 148</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a8c9b4298c062bee342e2f73161b6da83">render</a> {
    my ($self, %options) = @_;
    
    my $tempDir  = $self-&gt;{tempDir};
    my $dir      = $self-&gt;{dir};
    my $basename = $self-&gt;{basename};
    my $latex    = $self-&gt;{latex};
    my $dvipng   = $self-&gt;{dvipng};
    my $names    = $self-&gt;{names};
    my $strings  = $self-&gt;{strings};
    my $depths   = $self-&gt;{depths};
    $self-&gt;{body_text} = $options{body_text};
    my $forceRefresh = $self-&gt;{<a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a6334febe2af35a18c1a4d590b903ceb0">refresh</a>} || 0;      # recreate every equation image -- <span class="keywordflow">default</span> is <span class="keywordflow">do</span> not <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#a6334febe2af35a18c1a4d590b903ceb0">refresh</a>

<span class="preprocessor">    ###############################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # check that the equations directory exists and create if it doesn&#39;t</span>
<span class="preprocessor"></span><span class="preprocessor">    ###############################################</span>
<span class="preprocessor"></span>    unless (-e <span class="stringliteral">&quot;$dir&quot;</span>) {
        my $success = mkdir <span class="stringliteral">&quot;$dir&quot;</span>;
        warn <span class="stringliteral">&quot;Could not make directory $dir&quot;</span> unless $success;
    }
    
<span class="preprocessor">    ###############################################         </span>
<span class="preprocessor"></span><span class="preprocessor">    # determine which images need to be generated</span>
<span class="preprocessor"></span><span class="preprocessor">    ###############################################</span>
<span class="preprocessor"></span>    my (@newStrings, @newNames);
    <span class="keywordflow">for</span> (my $i = 0; $i &lt; @$strings; $i++) {
        my $string = $strings-&gt;[$i];
        my $name = $names-&gt;[$i];
        <span class="keywordflow">if</span> (!$forceRefresh and -e <span class="stringliteral">&quot;$dir/$name&quot;</span>) {
<span class="preprocessor">            #warn &quot;ImageGenerator: found a file named $name, skipping string $string\n&quot;;</span>
<span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<span class="preprocessor">            #warn &quot;ImageGenerator: didn&#39;t find a file named $name, including string $string\n&quot;;</span>
<span class="preprocessor"></span>            push @newStrings, $string;
            push @newNames, $name;
        }
    }
    
    <span class="keywordflow">if</span>(@newStrings) { # Don<span class="stringliteral">&#39;t run latex if there are no images to generate</span>
<span class="stringliteral">        </span>
<span class="stringliteral">        # create temporary directory in which to do TeX processing</span>
<span class="stringliteral">        my $wd = makeTempDirectory($tempDir, &quot;ImageGenerator&quot;);</span>
<span class="stringliteral">        </span>
<span class="stringliteral">        # store equations in a tex file</span>
<span class="stringliteral">        my $texFile = &quot;$wd/equation.tex&quot;;</span>
<span class="stringliteral">        open my $tex, &quot;&gt;&quot;, $texFile</span>
<span class="stringliteral">            or die &quot;failed to open file $texFile for writing: $!&quot;;</span>
<span class="stringliteral">        print $tex $TexPreamble;</span>
<span class="stringliteral">        print $tex $self-&gt;{texPreambleAdditions} if defined($self-&gt;{texPreambleAdditions});</span>
<span class="stringliteral">        print $tex &quot;$_\n&quot; foreach @newStrings;</span>
<span class="stringliteral">        print $tex $TexPostamble;</span>
<span class="stringliteral">        close $tex;</span>
<span class="stringliteral">        warn &quot;tex file $texFile was not written&quot; unless -e $texFile;</span>
<span class="stringliteral">        </span>
<span class="stringliteral">        ###############################################</span>
<span class="stringliteral">        # call LaTeX</span>
<span class="stringliteral">        ###############################################</span>
<span class="stringliteral">        my $latexCommand  = &quot;cd $wd &amp;&amp; $latex equation &gt; latex.out 2&gt; latex.err&quot;;</span>
<span class="stringliteral">        my $latexStatus = system $latexCommand;</span>
<span class="stringliteral">    </span>
<span class="stringliteral">        if ($latexStatus and $latexStatus !=256) {</span>
<span class="stringliteral">            warn &quot;$latexCommand returned non-zero status $latexStatus: $!&quot;;</span>
<span class="stringliteral">            warn &quot;cd $wd failed&quot; if system &quot;cd $wd&quot;;</span>
<span class="stringliteral">            warn &quot;Unable to write to directory $wd. &quot; unless -w $wd;</span>
<span class="stringliteral">            warn &quot;Unable to execute $latex &quot; unless -e $latex ;</span>
<span class="stringliteral">            </span>
<span class="stringliteral">            warn `ls -l $wd`;</span>
<span class="stringliteral">            my $errorMessage = &#39;</span><span class="stringliteral">&#39;;</span>
<span class="stringliteral">            if (-r &quot;$wd/equation.log&quot;) {</span>
<span class="stringliteral">                $errorMessage = readFile(&quot;$wd/equation.log&quot;);</span>
<span class="stringliteral">                warn &quot;&lt;pre&gt; Logfile contents:\n$errorMessage\n&lt;/pre&gt;&quot;;</span>
<span class="stringliteral">            } else {</span>
<span class="stringliteral">               warn &quot;Unable to read logfile $wd/equation.log &quot;;</span>
<span class="stringliteral">            }</span>
<span class="stringliteral">        }</span>
<span class="stringliteral">    </span>
<span class="stringliteral">        warn &quot;$latexCommand failed to generate a DVI file&quot;</span>
<span class="stringliteral">            unless -e &quot;$wd/equation.dvi&quot;;</span>
<span class="stringliteral">        </span>
<span class="stringliteral">        ############################################</span>
<span class="stringliteral">        # call dvipng</span>
<span class="stringliteral">        ############################################</span>
<span class="stringliteral">        my $dvipngCommand = &quot;cd $wd &amp;&amp; $dvipng &quot; . $DvipngArgs . &quot; equation &gt; dvipng.out 2&gt; dvipng.err&quot;;</span>
<span class="stringliteral">        my $dvipngStatus = system $dvipngCommand;</span>
<span class="stringliteral">        warn &quot;$dvipngCommand returned non-zero status $dvipngStatus: $!&quot;</span>
<span class="stringliteral">            if $dvipngStatus;</span>
<span class="stringliteral">        # get depths</span>
<span class="stringliteral">        my $dvipngout = &#39;</span><span class="stringliteral">&#39;;</span>
<span class="stringliteral">        $dvipngout = readFile(&quot;$wd/dvipng.out&quot;) if(-r &quot;$wd/dvipng.out&quot;);</span>
<span class="stringliteral">        my @dvipngdepths = ($dvipngout =~ /depth=(\d+)/g);</span>
<span class="stringliteral">        # kill them all if something goes wrnog</span>
<span class="stringliteral">        @dvipngdepths = () if(scalar(@dvipngdepths) != scalar(@newNames));</span>
<span class="stringliteral">    </span>
<span class="stringliteral">        ############################################</span>
<span class="stringliteral">        # move/rename images</span>
<span class="stringliteral">        ############################################</span>
<span class="stringliteral">    </span>
<span class="stringliteral">      chmod (0664,&lt;$wd/*&gt;);  # first make everything group writable so that a WeBWorK admin can delete images</span>
<span class="stringliteral">        foreach my $image (readDirectory($wd)) {</span>
<span class="stringliteral">            # only work on equation#.png files</span>
<span class="stringliteral">            next unless $image =~ m/^equation(\d+)\.png$/;</span>
<span class="stringliteral">            </span>
<span class="stringliteral">            # get image number from above match</span>
<span class="stringliteral">            my $imageNum = $1;</span>
<span class="stringliteral">            # note, problems with solutions/hints can have empty values in newNames</span>
<span class="stringliteral">            next unless $newNames[$imageNum-1];</span>
<span class="stringliteral">    </span>
<span class="stringliteral">            # record the dvipng offset</span>
<span class="stringliteral">            my $hashkey = $newNames[$imageNum-1];</span>
<span class="stringliteral">            $hashkey =~ s|/||;</span>
<span class="stringliteral">            $hashkey =~ s|\.png$||;</span>
<span class="stringliteral">            $depths-&gt;{&quot;$hashkey&quot;} = $dvipngdepths[$imageNum-1] if(defined($dvipngdepths[$imageNum-1]));</span>
<span class="stringliteral">            </span>
<span class="stringliteral">            #warn &quot;ImageGenerator: found generated image $imageNum with name $newNames[$imageNum-1]\n&quot;;</span>
<span class="stringliteral">            </span>
<span class="stringliteral">            # move/rename image</span>
<span class="stringliteral">            #my $mvCommand = &quot;cd $wd &amp;&amp; /bin/mv $wd/$image $dir/$basename.$imageNum.png&quot;;</span>
<span class="stringliteral">            # check to see if this requires a directory we haven&#39;</span>t made yet
            my $newdir = $newNames[$imageNum-1];
            $newdir =~ s|/.*$||;
            <span class="keywordflow">if</span>($newdir and not -d <span class="stringliteral">&quot;$dir/$newdir&quot;</span>) {
                my $success = mkdir <span class="stringliteral">&quot;$dir/$newdir&quot;</span>;
                chmod (0775,&lt;$dir/$newdir&gt;); # make the directory group writable so that a <a class="code" href="classWeBWorK.html">WeBWorK</a> admin can <span class="keyword">delete</span> images
                warn <span class="stringliteral">&quot;Could not make directory $dir/$newdir&quot;</span> unless $success;
            }
            my $mvCommand = <span class="stringliteral">&quot;cd $wd &amp;&amp; /bin/mv $wd/$image $dir/&quot;</span> . $newNames[$imageNum-1];
            my $mvStatus = system $mvCommand;
            <span class="keywordflow">if</span> ( $mvStatus) {
                warn <span class="stringliteral">&quot;$mvCommand returned non-zero status $mvStatus: $!&quot;</span>;
                warn <span class="stringliteral">&quot;Can&#39;t write to tmp/equations directory $dir&quot;</span> unless -w $dir;
            }
    
        }
<span class="preprocessor">        ############################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # remove temporary directory (and its contents)</span>
<span class="preprocessor"></span><span class="preprocessor">        ############################################</span>
<span class="preprocessor"></span>    
        <span class="keywordflow">if</span> ($PreserveTempFiles) {
            warn <span class="stringliteral">&quot;ImageGenerator: preserved temp files in working directory &#39;$wd&#39;.\n&quot;</span>;
            chmod (0775,$wd);
            chmod (0664,&lt;$wd<span class="comment">/*&gt;);</span>
<span class="comment">        } else {</span>
<span class="comment">            removeTempDirectory($wd);</span>
<span class="comment">        }</span>
<span class="comment">    }</span>
<span class="comment">    $self-&gt;update_depth_cache() if $self-&gt;{store_depths};</span>
<span class="comment">    $self-&gt;fix_markers() if ($self-&gt;{useMarkers} and defined $self-&gt;{body_text});</span>
<span class="comment">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aadf27cb8f9606f9daba2601587378676"></a><!-- doxytag: member="WeBWorK::PG::ImageGenerator::update_depth_cache" ref="aadf27cb8f9606f9daba2601587378676" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::PG::ImageGenerator::update_depth_cache </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-update_depth_cache' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-update_depth_cache-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-update_depth_cache-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-update_depth_cache-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in update_depth_cache: 19</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1PG_1_1ImageGenerator.html#aadf27cb8f9606f9daba2601587378676">update_depth_cache</a> {
    my $self = shift;
    <span class="keywordflow">return</span>() unless ($self-&gt;{dvipng_align} eq <span class="stringliteral">&#39;mysql&#39;</span>);
    my $dbh = DBI-&gt;connect_cached($self-&gt;{dvipng_depth_db}-&gt;{dbsource},
       $self-&gt;{dvipng_depth_db}-&gt;{user}, $self-&gt;{dvipng_depth_db}-&gt;{passwd});
    my $sth = $dbh-&gt;prepare(<span class="stringliteral">&quot;INSERT IGNORE INTO depths(md5, depth) VALUES (?,?)&quot;</span>);
    my $depthhash = $self-&gt;{depths};
    <span class="keywordflow">for</span> my $md5 (keys %{$depthhash}) {
        <span class="keywordflow">if</span>($depthhash-&gt;{$md5} eq <span class="stringliteral">&#39;none&#39;</span>) {
            my $got_values = $dbh-&gt;selectall_arrayref(<span class="stringliteral">&#39;select depth from depths where md5 = ?&#39;</span>, undef, <span class="stringliteral">&quot;$md5&quot;</span>);
            $depthhash-&gt;{<span class="stringliteral">&quot;$md5&quot;</span>} = $got_values-&gt;[0]-&gt;[0] <span class="keywordflow">if</span>(scalar(@{$got_values}));
<span class="preprocessor">            #warn &quot;Get depth from mysql for $md5&quot; . $depthhash-&gt;{&quot;$md5&quot;};</span>
<span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<span class="preprocessor">            #warn &quot;Put depth $depthhash-&gt;{$md5} for $md5 into mysql&quot;;</span>
<span class="preprocessor"></span>            $sth-&gt;execute($md5, $depthhash-&gt;{$md5});
        }
    }
    <span class="keywordflow">return</span>();
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="ImageGenerator_8pm_source.html">ImageGenerator.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:05 2012 for PG by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
