<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PG: Parser.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>Parser.pm</h1><a href="Parser_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="keyword">package </span>Parser;
<a name="l00002"></a>00002 my $pkg = <span class="stringliteral">&quot;Parser&quot;</span>;
<a name="l00003"></a>00003 use strict; no strict <span class="stringliteral">&quot;refs&quot;</span>;
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 BEGIN {
<a name="l00006"></a>00006 <span class="preprocessor">  #</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor">  #  Map class names to packages (added to Context, and</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor">  #  can be overriden to customize the parser)</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor">  #</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span>  our $class = {<a class="code" href="classParser.html#a88e52b9304be1766333fa340cc242e7e">Formula</a> =&gt; <span class="stringliteral">&#39;Value::Formula&#39;</span>};
<a name="l00011"></a>00011 
<a name="l00012"></a>00012 <span class="preprocessor">  #</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor">  #  Collect the default reduction flags for use in the context</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor">  #</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span>  our $reduce = {};
<a name="l00016"></a><a class="code" href="classParser.html">00016</a> }
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">##################################################</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="preprocessor">#  Parse a string and create a new Parser object</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="preprocessor">#  If the string is already a parsed object then copy the parse tree</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span><span class="preprocessor">#  If it is a Value, make an appropriate tree for it.</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span>sub <span class="keyword">new</span> {
<a name="l00025"></a>00025   my $self = shift;
<a name="l00026"></a>00026   my $context = (<a class="code" href="classValue.html#a2d6d7d0072c75611908bf0a79080e8df">Value::isContext</a>($_[0]) ? shift : $self-&gt;context);
<a name="l00027"></a>00027   my $class = $self-&gt;Item(<span class="stringliteral">&quot;Formula&quot;</span>,$context);
<a name="l00028"></a>00028   my $string = shift;
<a name="l00029"></a>00029   $string = $context-&gt;Package(<span class="stringliteral">&quot;List&quot;</span>)-&gt;new($context,$string,@_) <span class="keywordflow">if</span> scalar(@_) &gt; 0;
<a name="l00030"></a>00030   $string = $context-&gt;Package(<span class="stringliteral">&quot;List&quot;</span>)-&gt;new($context,$string)-&gt;with(open=&gt;<span class="charliteral">&#39;[&#39;</span>,close=&gt;<span class="charliteral">&#39;]&#39;</span>)
<a name="l00031"></a>00031     <span class="keywordflow">if</span> ref($string) eq <span class="stringliteral">&#39;ARRAY&#39;</span>;
<a name="l00032"></a>00032   my $math = bless {
<a name="l00033"></a>00033     <span class="keywordtype">string</span> =&gt; undef,
<a name="l00034"></a>00034     tokens =&gt; [], tree =&gt; undef,
<a name="l00035"></a>00035     variables =&gt; {}, values =&gt; {},
<a name="l00036"></a>00036     <a class="code" href="classcontext.html">context</a> =&gt; $context,
<a name="l00037"></a>00037   }, $class;
<a name="l00038"></a>00038   <span class="keywordflow">if</span> (<a class="code" href="classValue.html#af0cac5207e593050f2a9d56e10346245">Value::isParser</a>($string) || <a class="code" href="classValue.html#afa346ffc3c989970326e02766a63523a">Value::isFormula</a>($string)) {
<a name="l00039"></a>00039     my $tree = $string; $tree = $tree-&gt;{tree} <span class="keywordflow">if</span> defined $tree-&gt;{tree};
<a name="l00040"></a>00040     $math-&gt;{tree} = $tree-&gt;copy($math);
<a name="l00041"></a>00041     $math-&gt;{variables} = $math-&gt;{tree}-&gt;getVariables;
<a name="l00042"></a>00042   } elsif (<a class="code" href="classValue.html#a43e6b7aa1e386a5a9056190d0ac3cbb3">Value::isValue</a>($string)) {
<a name="l00043"></a>00043     $math-&gt;{tree} = $math-&gt;Item(<span class="stringliteral">&quot;Value&quot;</span>)-&gt;new($math,$string);
<a name="l00044"></a>00044   } elsif ($string eq <span class="stringliteral">&#39;&#39;</span> &amp;&amp; $context-&gt;{flags}{allowEmptyStrings}) {
<a name="l00045"></a>00045     $math-&gt;{<span class="keywordtype">string</span>} = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00046"></a>00046     $math-&gt;{tree} = $math-&gt;Item(<span class="stringliteral">&quot;Value&quot;</span>)-&gt;new($math,<span class="stringliteral">&quot;&quot;</span>);
<a name="l00047"></a>00047   } <span class="keywordflow">else</span> {
<a name="l00048"></a>00048     $math-&gt;{<span class="keywordtype">string</span>} = $string;
<a name="l00049"></a>00049     $math-&gt;tokenize;
<a name="l00050"></a>00050     $math-&gt;parse;
<a name="l00051"></a>00051   }
<a name="l00052"></a>00052   <span class="keywordflow">return</span> $math;
<a name="l00053"></a>00053 }
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#  Get the object&#39;s context, or the default one</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>sub <a class="code" href="classcontext.html">context</a> {
<a name="l00059"></a>00059   my $self = shift; my $context = shift;
<a name="l00060"></a>00060   <span class="keywordflow">if</span> (<a class="code" href="classValue.html#a854a2a9e80ba841a913783934305a0e3">Value::isHash</a>($self)) {
<a name="l00061"></a>00061     <span class="keywordflow">if</span> ($context &amp;&amp; $self-&gt;{<a class="code" href="classcontext.html">context</a>} != $context) {
<a name="l00062"></a>00062       $self-&gt;{<a class="code" href="classcontext.html">context</a>} = $context;
<a name="l00063"></a>00063       $self-&gt;{tree} = $self-&gt;{tree}-&gt;copy($self) <span class="keywordflow">if</span> $self-&gt;{tree};
<a name="l00064"></a>00064     }
<a name="l00065"></a>00065     <span class="keywordflow">return</span> $self-&gt;{<a class="code" href="classcontext.html">context</a>} <span class="keywordflow">if</span> $self-&gt;{<a class="code" href="classcontext.html">context</a>};
<a name="l00066"></a>00066   }
<a name="l00067"></a>00067   <a class="code" href="classParser_1_1Context.html">Parser::Context</a>-&gt;current;
<a name="l00068"></a>00068 }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="preprocessor">#</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span><span class="preprocessor">#  Get the package for a parser item</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span>sub Item {<a class="code" href="classParser_1_1Item.html#aa2d340ad2daac78f74dd1c65118f2b19">Parser::Item::Item</a>(@_)}
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="preprocessor">#</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#  Make a copy of a formula</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>sub copy {
<a name="l00079"></a>00079   my $self = shift;
<a name="l00080"></a>00080   my $copy  = bless {%{$self}}, ref($self);
<a name="l00081"></a>00081   <span class="keywordflow">foreach</span> my $id (<a class="code" href="classValue_1_1Formula.html#ab09428fcf57bd3b90d79c5bc49ee0e38">Value::Formula::noinherit</a>($self)) {<span class="keyword">delete</span> $copy-&gt;{$id}}
<a name="l00082"></a>00082   $copy-&gt;{tree} = $self-&gt;{tree}-&gt;copy($copy);
<a name="l00083"></a>00083   <span class="keywordflow">foreach</span> my $id (keys %{$self}) {
<a name="l00084"></a>00084     $copy-&gt;{$id} = {%{$self-&gt;{$id}}} <span class="keywordflow">if</span> ref($self-&gt;{$id}) eq <span class="stringliteral">&#39;HASH&#39;</span>;
<a name="l00085"></a>00085     $copy-&gt;{$id} = [@{$self-&gt;{$id}}] <span class="keywordflow">if</span> ref($self-&gt;{$id}) eq <span class="stringliteral">&#39;ARRAY&#39;</span>;
<a name="l00086"></a>00086   }
<a name="l00087"></a>00087   <span class="keywordflow">return</span> $copy;
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="preprocessor">##################################################</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">#  Break the string into tokens based on the patterns for the various</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">#  types of objects.</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>sub tokenize {
<a name="l00096"></a>00096   my $self = shift; my $space; my @match;
<a name="l00097"></a>00097   my $tokens = $self-&gt;{tokens}; my $string = $self-&gt;{<span class="keywordtype">string</span>};
<a name="l00098"></a>00098   my $tokenPattern = $self-&gt;{<a class="code" href="classcontext.html">context</a>}{pattern}{token};
<a name="l00099"></a>00099   my $tokenType = $self-&gt;{<a class="code" href="classcontext.html">context</a>}{pattern}{tokenType};
<a name="l00100"></a>00100   my @patternType = @{$self-&gt;{<a class="code" href="classcontext.html">context</a>}{pattern}{type}};
<a name="l00101"></a>00101   @{$tokens} = (); $self-&gt;{error} = 0;
<a name="l00102"></a>00102   $string =~ m/^\s*/gc; my $p0; my $p1;
<a name="l00103"></a>00103   <span class="keywordflow">while</span> (pos($string) &lt; length($string)) {
<a name="l00104"></a>00104     $p0 = pos($string);
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (@match = ($string =~ m/\G$tokenPattern/)) {
<a name="l00106"></a>00106       <span class="keywordflow">foreach</span> my $i (0..$#patternType) {
<a name="l00107"></a>00107     <span class="keywordflow">if</span> (defined($match[$i])) {
<a name="l00108"></a>00108       $p1 = pos($string) = pos($string) + length($match[$i]);
<a name="l00109"></a>00109       push(@{$tokens},[($patternType[$i]||$tokenType-&gt;{$match[$i]}),$match[$i],$p0,$p1,$space]);
<a name="l00110"></a>00110       last;
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112       }
<a name="l00113"></a>00113     } <span class="keywordflow">else</span> {
<a name="l00114"></a>00114       push(@{$tokens},[<span class="stringliteral">&#39;error&#39;</span>,substr($string,$p0,1),$p0,$p0+1]);
<a name="l00115"></a>00115       $self-&gt;{error} = 1;
<a name="l00116"></a>00116       last;
<a name="l00117"></a>00117     }
<a name="l00118"></a>00118     $space = ($string =~ m/\G\s+/gc);
<a name="l00119"></a>00119   }
<a name="l00120"></a>00120 }
<a name="l00121"></a>00121 
<a name="l00122"></a>00122 <span class="preprocessor">##################################################</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span><span class="preprocessor">#  Parse the token list to produce the expression tree.  This does syntax checks</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="preprocessor">#  and reports &quot;compile-time&quot; errors.</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span><span class="preprocessor">#  Start with a stack that has a single entry (an OPEN object for the expression)</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span><span class="preprocessor">#  For each token, try to add that token to the tree.</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span><span class="preprocessor">#  After all tokens have been finished, add a CLOSE object for the initial OPEN</span>
<a name="l00130"></a>00130 <span class="preprocessor"></span><span class="preprocessor">#    and save the complete tree</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00132"></a>00132 <span class="preprocessor"></span>sub parse {
<a name="l00133"></a>00133   my $self = shift;
<a name="l00134"></a>00134   $self-&gt;{tree} = undef; $self-&gt;{error} = 0;
<a name="l00135"></a>00135   $self-&gt;{stack} = [{type =&gt; <span class="stringliteral">&#39;open&#39;</span>, value =&gt; <span class="stringliteral">&#39;start&#39;</span>}];
<a name="l00136"></a>00136   <span class="keywordflow">foreach</span> my $ref (@{$self-&gt;{tokens}}) {
<a name="l00137"></a>00137     $self-&gt;{ref} = $ref; $self-&gt;{space} = $ref-&gt;[4];
<a name="l00138"></a>00138     <span class="keywordflow">for</span> ($ref-&gt;[0]) {
<a name="l00139"></a>00139       /open/  and <span class="keywordflow">do</span> {$self-&gt;Open($ref-&gt;[1]); last};
<a name="l00140"></a>00140       /close/ and <span class="keywordflow">do</span> {$self-&gt;Close($ref-&gt;[1],$ref); last};
<a name="l00141"></a>00141       /op/    and <span class="keywordflow">do</span> {$self-&gt;Op($ref-&gt;[1],$ref); last};
<a name="l00142"></a>00142       /num/   and <span class="keywordflow">do</span> {$self-&gt;Num($ref-&gt;[1]); last};
<a name="l00143"></a>00143       /<span class="keyword">const</span>/ and <span class="keywordflow">do</span> {$self-&gt;Const($ref-&gt;[1]); last};
<a name="l00144"></a>00144       /var/   and <span class="keywordflow">do</span> {$self-&gt;Var($ref-&gt;[1]); last};
<a name="l00145"></a>00145       /fn/    and <span class="keywordflow">do</span> {$self-&gt;Fn($ref-&gt;[1]); last};
<a name="l00146"></a>00146       /str/   and <span class="keywordflow">do</span> {$self-&gt;Str($ref-&gt;[1]); last};
<a name="l00147"></a>00147       /error/ and <span class="keywordflow">do</span> {$self-&gt;Error([<span class="stringliteral">&quot;Unexpected character &#39;%s&#39;&quot;</span>,$ref-&gt;[1]],$ref); last};
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     <span class="keywordflow">return</span> <span class="keywordflow">if</span> ($self-&gt;{error});
<a name="l00150"></a>00150   }
<a name="l00151"></a>00151   $self-&gt;Close(<span class="stringliteral">&#39;start&#39;</span>); <span class="keywordflow">return</span> <span class="keywordflow">if</span> ($self-&gt;{error});
<a name="l00152"></a>00152   $self-&gt;{tree} = $self-&gt;{stack}[0]{value};
<a name="l00153"></a>00153 }
<a name="l00154"></a>00154 
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="preprocessor">#  Get the top or previous item of the stack</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>sub top {
<a name="l00159"></a>00159   my $self = shift; my $i = shift || 0;
<a name="l00160"></a>00160   <span class="keywordflow">return</span> $self-&gt;{stack}[$i-1];
<a name="l00161"></a>00161 }
<a name="l00162"></a>00162 sub prev {(shift)-&gt;top(-1)}
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 <span class="preprocessor">#</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span><span class="preprocessor">#  Push or pop the top of the stack</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>sub pop {pop(@{(shift)-&gt;{stack}})}
<a name="l00168"></a>00168 sub push {push(@{(shift)-&gt;{stack}},@_)}
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 #
<a name="l00171"></a>00171 #  Return the type of the top item
<a name="l00172"></a>00172 #
<a name="l00173"></a>00173 sub state {(shift)-&gt;top-&gt;{type}}
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="preprocessor">#</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span><span class="preprocessor">#  Report an error at a given possition (if possible)</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>sub Error {
<a name="l00179"></a>00179   my $self = shift; my $context = $self-&gt;context;
<a name="l00180"></a>00180   my $message = shift; my $ref = shift;
<a name="l00181"></a>00181   my $string; my $more = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00182"></a>00182   <span class="keywordflow">if</span> ($ref) {
<a name="l00183"></a>00183     $more = <span class="stringliteral">&quot;; see position %d of formula&quot;</span>;
<a name="l00184"></a>00184     $string = $self-&gt;{<span class="keywordtype">string</span>};
<a name="l00185"></a>00185     $ref = [$ref-&gt;[2],$ref-&gt;[3]];
<a name="l00186"></a>00186   }
<a name="l00187"></a>00187   $context-&gt;setError($message,$string,$ref,$more);
<a name="l00188"></a>00188   die $context-&gt;{error}{message} . <a class="code" href="classValue.html#ac4fe2173b95f4c9de4d93251275b3137">Value::getCaller</a>();
<a name="l00189"></a>00189 }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="preprocessor">#</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span><span class="preprocessor">#  Insert an implicit multiplication</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span><span class="preprocessor">#  (fix up the reference for spaces or juxtaposition)</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>sub ImplicitMult {
<a name="l00196"></a>00196   my $self = shift;
<a name="l00197"></a>00197   my $ref = $self-&gt;{ref}; my $iref = [@{$ref}];
<a name="l00198"></a>00198   $iref-&gt;[2]--; $iref-&gt;[3] = $iref-&gt;[2]+1;
<a name="l00199"></a>00199   $iref-&gt;[3]++ unless substr($self-&gt;{<span class="keywordtype">string</span>},$iref-&gt;[2],1) eq <span class="charliteral">&#39; &#39;</span>;
<a name="l00200"></a>00200   $self-&gt;Error(<span class="stringliteral">&quot;Can&#39;t perform implied multiplication in this context&quot;</span>,$iref)
<a name="l00201"></a>00201     unless $self-&gt;{<a class="code" href="classcontext.html">context</a>}{operators}{<span class="charliteral">&#39; &#39;</span>}{<span class="keyword">class</span>};
<a name="l00202"></a>00202   $self-&gt;Op(<span class="charliteral">&#39; &#39;</span>,$iref);
<a name="l00203"></a>00203   $self-&gt;{ref} = $ref;
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 <span class="preprocessor">#</span>
<a name="l00207"></a>00207 <span class="preprocessor"></span><span class="preprocessor">#  Push an operator onto the expression stack.</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span><span class="preprocessor">#  We save the operator symbol, the precedence, etc.</span>
<a name="l00209"></a>00209 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span>sub pushOperator {
<a name="l00211"></a>00211   my $self = shift;
<a name="l00212"></a>00212   my ($op,$precedence,$reverse) = @_;
<a name="l00213"></a>00213   $self-&gt;push({
<a name="l00214"></a>00214     type =&gt; <span class="stringliteral">&#39;operator&#39;</span>, ref =&gt; $self-&gt;{ref},
<a name="l00215"></a>00215     name =&gt; $op, precedence =&gt; $precedence, reverse =&gt; $reverse
<a name="l00216"></a>00216   });
<a name="l00217"></a>00217 }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219 <span class="preprocessor">#</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span><span class="preprocessor">#  Push an operand onto the expression stack.</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>sub pushOperand {
<a name="l00223"></a>00223   my $self = shift; my $value = shift;
<a name="l00224"></a>00224   $self-&gt;push({type =&gt; <span class="stringliteral">&#39;operand&#39;</span>, ref =&gt; $self-&gt;{ref}, value =&gt; $value});
<a name="l00225"></a>00225 }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227 <span class="preprocessor">#</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span><span class="preprocessor">#  Push a blank operand (just as a place-holder)</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00230"></a>00230 <span class="preprocessor"></span>sub pushBlankOperand {
<a name="l00231"></a>00231   my $self = shift;
<a name="l00232"></a>00232   $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;Constant&quot;</span>)-&gt;new($self,<span class="stringliteral">&quot;_blank_&quot;</span>,$self-&gt;{ref}));
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 <span class="preprocessor">##################################################</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00237"></a>00237 <span class="preprocessor"></span><span class="preprocessor">#  Handle an operator token</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span><span class="preprocessor">#  Get the operator data from the context</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span><span class="preprocessor">#  If the top of the stack is an operand</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span><span class="preprocessor">#    If the operator is a left-associative unary operator</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span><span class="preprocessor">#      Insert an implicit multiplication and save the operator</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span><span class="preprocessor">#    Otherwise</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span><span class="preprocessor">#      Complete any pending operations of higher precedence</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span><span class="preprocessor">#      If the top item is still an operand</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span><span class="preprocessor">#        If we have a (right associative) unary operator</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span><span class="preprocessor">#          Apply it to the top operand</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span><span class="preprocessor">#        Otherwise (binary operator)</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span><span class="preprocessor">#          Convert the space operator to explicit multiplication</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span><span class="preprocessor">#          Save the opertor on the stack</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span><span class="preprocessor">#      Otherwise, (top is not an operand)</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span><span class="preprocessor">#        If the operator is an explicit one or the top is a function</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span><span class="preprocessor">#          Call Op again to report the error, or to apply</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span><span class="preprocessor">#            the operator to the function (this happens when</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span><span class="preprocessor">#            there is a function to a power, for example)</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span><span class="preprocessor">#  Otherwise (top is not an operand)</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">#    If this is a left-associative unary operator, save it on the stack</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span><span class="preprocessor">#    Otherwise, if it is a left-associative operator that CAN be unary</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="preprocessor">#      Save the unary version of the operator on the stack</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span><span class="preprocessor">#    Otherwise, if the top item is a function</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span><span class="preprocessor">#      If the operator can be applied to functions, save it on the stack</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span><span class="preprocessor">#      Otherwise, report that the function is missing its inputs</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span><span class="preprocessor">#    Otherwise, report the missing operand for this operator</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span>sub Op {
<a name="l00266"></a>00266   my $self = shift; my $name = shift;
<a name="l00267"></a>00267   my $ref = $self-&gt;{ref} = shift;
<a name="l00268"></a>00268   my $context = $self-&gt;{<a class="code" href="classcontext.html">context</a>}; my $op = $context-&gt;{operators}{$name};
<a name="l00269"></a>00269   $op = $context-&gt;{operators}{$op-&gt;{space}} if $self-&gt;{space} &amp;&amp; defined($op-&gt;{space});
<a name="l00270"></a>00270   <span class="keywordflow">if</span> ($self-&gt;state eq <span class="stringliteral">&#39;operand&#39;</span>) {
<a name="l00271"></a>00271     <span class="keywordflow">if</span> ($op-&gt;{type} eq <span class="stringliteral">&#39;unary&#39;</span> &amp;&amp; $op-&gt;{associativity} eq <span class="stringliteral">&#39;left&#39;</span>) {
<a name="l00272"></a>00272       $self-&gt;ImplicitMult();
<a name="l00273"></a>00273       $self-&gt;pushOperator($name,$op-&gt;{precedence});
<a name="l00274"></a>00274     } <span class="keywordflow">else</span> {
<a name="l00275"></a>00275       $self-&gt;Precedence($op-&gt;{precedence});
<a name="l00276"></a>00276       <span class="keywordflow">if</span> ($self-&gt;state eq <span class="stringliteral">&#39;operand&#39;</span>) {
<a name="l00277"></a>00277         <span class="keywordflow">if</span> ($op-&gt;{type} eq <span class="stringliteral">&#39;unary&#39;</span>) {
<a name="l00278"></a>00278           my $top = $self-&gt;pop;
<a name="l00279"></a>00279           $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;UOP&quot;</span>)-&gt;new($self,$name,$top-&gt;{value},$ref));
<a name="l00280"></a>00280         } <span class="keywordflow">else</span> {
<a name="l00281"></a>00281           $name = $context-&gt;{operators}{<span class="charliteral">&#39; &#39;</span>}{<span class="keywordtype">string</span>}
<a name="l00282"></a>00282             <span class="keywordflow">if</span> $name eq <span class="charliteral">&#39; &#39;</span> or $name eq $context-&gt;{operators}{<span class="charliteral">&#39; &#39;</span>}{space};
<a name="l00283"></a>00283           $self-&gt;pushOperator($name,$op-&gt;{precedence});
<a name="l00284"></a>00284         }
<a name="l00285"></a>00285       } elsif (($ref &amp;&amp; $name ne <span class="charliteral">&#39; &#39;</span>) || $self-&gt;state ne <span class="stringliteral">&#39;fn&#39;</span>) {$self-&gt;Op($name,$ref)}
<a name="l00286"></a>00286     }
<a name="l00287"></a>00287   } <span class="keywordflow">else</span> {
<a name="l00288"></a>00288     $name = <span class="charliteral">&#39;u&#39;</span>.$name, $op = $context-&gt;{operators}{$name}
<a name="l00289"></a>00289       <span class="keywordflow">if</span> ($op-&gt;{type} eq <span class="stringliteral">&#39;both&#39;</span> &amp;&amp; defined $context-&gt;{operators}{<span class="charliteral">&#39;u&#39;</span>.$name});
<a name="l00290"></a>00290     <span class="keywordflow">if</span> ($op-&gt;{type} eq <span class="stringliteral">&#39;unary&#39;</span> &amp;&amp; $op-&gt;{associativity} eq <span class="stringliteral">&#39;left&#39;</span>) {
<a name="l00291"></a>00291       $self-&gt;pushOperator($name,$op-&gt;{precedence});
<a name="l00292"></a>00292     } elsif ($self-&gt;state eq <span class="stringliteral">&#39;fn&#39;</span>) {
<a name="l00293"></a>00293       <span class="keywordflow">if</span> ($op-&gt;{leftf}) {
<a name="l00294"></a>00294         $self-&gt;pushOperator($name,$op-&gt;{precedence},1);
<a name="l00295"></a>00295       } elsif ($self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;flag(<span class="stringliteral">&quot;allowMissingFunctionInputs&quot;</span>)) {
<a name="l00296"></a>00296     $self-&gt;pushBlankOperand;
<a name="l00297"></a>00297     $self-&gt;CloseFn;
<a name="l00298"></a>00298     $self-&gt;pushOperator($name,$op-&gt;{precedence});
<a name="l00299"></a>00299       } <span class="keywordflow">else</span> {
<a name="l00300"></a>00300         my $top = $self-&gt;top;
<a name="l00301"></a>00301         $self-&gt;Error([<span class="stringliteral">&quot;Function &#39;%s&#39; is missing its input(s)&quot;</span>,$top-&gt;{name}],$top-&gt;{ref});
<a name="l00302"></a>00302       }
<a name="l00303"></a>00303     } elsif ($self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;flag(<span class="stringliteral">&quot;allowMissingOperands&quot;</span>)) {
<a name="l00304"></a>00304       $self-&gt;pushBlankOperand;
<a name="l00305"></a>00305       $self-&gt;Op($name,$ref);
<a name="l00306"></a>00306     } <span class="keywordflow">else</span> {$self-&gt;Error([<span class="stringliteral">&quot;Missing operand before &#39;%s&#39;&quot;</span>,$name],$ref)}
<a name="l00307"></a>00307   }
<a name="l00308"></a>00308 }
<a name="l00309"></a>00309 
<a name="l00310"></a>00310 <span class="preprocessor">##################################################</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00312"></a>00312 <span class="preprocessor"></span><span class="preprocessor">#  Handle an open parenthesis</span>
<a name="l00313"></a>00313 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span><span class="preprocessor">#  If the top of the stack is an operand</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span><span class="preprocessor">#    Check if the open paren is really a close paren (for when the open</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span><span class="preprocessor">#      and close symbol are the same)</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span><span class="preprocessor">#    Otherwise insert an implicit multiplication</span>
<a name="l00318"></a>00318 <span class="preprocessor"></span><span class="preprocessor">#  Save the open object on the stack</span>
<a name="l00319"></a>00319 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00320"></a>00320 <span class="preprocessor"></span>sub Open {
<a name="l00321"></a>00321   my $self = shift; my $type = shift;
<a name="l00322"></a>00322   my $paren = $self-&gt;{<a class="code" href="classcontext.html">context</a>}{parens}{$type};
<a name="l00323"></a>00323   <span class="keywordflow">if</span> ($self-&gt;state eq <span class="stringliteral">&#39;operand&#39;</span>) {
<a name="l00324"></a>00324     <span class="keywordflow">if</span> ($type eq $paren-&gt;{close}) {
<a name="l00325"></a>00325       my $stack = $self-&gt;{stack}; my $i = scalar(@{$stack})-1;
<a name="l00326"></a>00326       <span class="keywordflow">while</span> ($i &gt;= 0 &amp;&amp; $stack-&gt;[$i]{type} ne <span class="stringliteral">&quot;open&quot;</span>) {$i--}
<a name="l00327"></a>00327       <span class="keywordflow">if</span> ($i &gt;= 0 &amp;&amp; $stack-&gt;[$i]{value} eq $type) {
<a name="l00328"></a>00328     $self-&gt;Close($type,$self-&gt;{ref});
<a name="l00329"></a>00329     <span class="keywordflow">return</span>;
<a name="l00330"></a>00330       }
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332     $self-&gt;ImplicitMult();
<a name="l00333"></a>00333   }
<a name="l00334"></a>00334   $self-&gt;push({type =&gt; <span class="stringliteral">&#39;open&#39;</span>, value =&gt; $type, ref =&gt; $self-&gt;{ref}});
<a name="l00335"></a>00335 }
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 <span class="preprocessor">##################################################</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span><span class="preprocessor">#  Handle a close parenthesis</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span><span class="preprocessor">#  When the top stack object is</span>
<a name="l00342"></a>00342 <span class="preprocessor"></span><span class="preprocessor">#    An open parenthesis (that is empty):</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span><span class="preprocessor">#      Get the data for the type of parentheses</span>
<a name="l00344"></a>00344 <span class="preprocessor"></span><span class="preprocessor">#      If the parentheses can be empty and the parentheses match</span>
<a name="l00345"></a>00345 <span class="preprocessor"></span><span class="preprocessor">#        Save the empty list</span>
<a name="l00346"></a>00346 <span class="preprocessor"></span><span class="preprocessor">#      Otherwise report a message appropriate to the type of parentheses</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span><span class="preprocessor">#    An operand:</span>
<a name="l00349"></a>00349 <span class="preprocessor"></span><span class="preprocessor">#      Complete any pending operations, and stop if there was an error</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span><span class="preprocessor">#      If the top is no longer an operand</span>
<a name="l00351"></a>00351 <span class="preprocessor"></span><span class="preprocessor">#        Call Close to report the error and return</span>
<a name="l00352"></a>00352 <span class="preprocessor"></span><span class="preprocessor">#      Get the item before the operand (an OPEN object), and its parenthesis type</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span><span class="preprocessor">#      If the parens match</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span><span class="preprocessor">#        Pop the operand off the stack</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span><span class="preprocessor">#        If the parens can&#39;t be removed, or if the operand is a list</span>
<a name="l00356"></a>00356 <span class="preprocessor"></span><span class="preprocessor">#          Make the operand into a list object</span>
<a name="l00357"></a>00357 <span class="preprocessor"></span><span class="preprocessor">#        Replace the paren object with the operand</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span><span class="preprocessor">#        If the parentheses are used for function calls and the</span>
<a name="l00359"></a>00359 <span class="preprocessor"></span><span class="preprocessor">#          previous stack object is a function call, do the function apply</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span><span class="preprocessor">#      Otherwise if the parens can form Intervals, do so</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span><span class="preprocessor">#      Otherwise report an appropriate error message</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span><span class="preprocessor">#    A function:</span>
<a name="l00364"></a>00364 <span class="preprocessor"></span><span class="preprocessor">#      Report an error message about missing inputs</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span><span class="preprocessor">#    An operator:</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span><span class="preprocessor">#      Report the missing operation</span>
<a name="l00368"></a>00368 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span>sub Close {
<a name="l00370"></a>00370   my $self = shift; my $type = shift;
<a name="l00371"></a>00371   my $ref = $self-&gt;{ref} = shift;
<a name="l00372"></a>00372   my $parens = $self-&gt;{<a class="code" href="classcontext.html">context</a>}{parens};
<a name="l00373"></a>00373 
<a name="l00374"></a>00374   <span class="keywordflow">for</span> ($self-&gt;state) {
<a name="l00375"></a>00375     /open/ and <span class="keywordflow">do</span> {
<a name="l00376"></a>00376       my $top = $self-&gt;pop; my $paren = $parens-&gt;{$top-&gt;{value}};
<a name="l00377"></a>00377       <span class="keywordflow">if</span> ($paren-&gt;{emptyOK} &amp;&amp; $paren-&gt;{close} eq $type) {
<a name="l00378"></a>00378         $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;List&quot;</span>)-&gt;new($self,[],1,$paren,undef,$top-&gt;{value},$paren-&gt;{close}))
<a name="l00379"></a>00379       }
<a name="l00380"></a>00380       elsif ($type eq <span class="stringliteral">&#39;start&#39;</span>) {$self-&gt;Error([<span class="stringliteral">&quot;Missing close parenthesis for &#39;%s&#39;&quot;</span>,$top-&gt;{value}],$top-&gt;{ref})}
<a name="l00381"></a>00381       elsif ($top-&gt;{value} eq <span class="stringliteral">&#39;start&#39;</span>) {$self-&gt;Error([<span class="stringliteral">&quot;Extra close parenthesis &#39;%s&#39;&quot;</span>,$type],$ref)}
<a name="l00382"></a>00382       <span class="keywordflow">else</span> {$top-&gt;{ref}[3]=$ref-&gt;[3]; $self-&gt;Error(<span class="stringliteral">&quot;Empty parentheses&quot;</span>,$top-&gt;{ref})}
<a name="l00383"></a>00383       last;
<a name="l00384"></a>00384     };
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     /operand/ and <span class="keywordflow">do</span> {
<a name="l00387"></a>00387       $self-&gt;Precedence(-1); <span class="keywordflow">return</span> <span class="keywordflow">if</span> ($self-&gt;{error});
<a name="l00388"></a>00388       <span class="keywordflow">if</span> ($self-&gt;state ne <span class="stringliteral">&#39;operand&#39;</span>) {$self-&gt;Close($type,$ref); <span class="keywordflow">return</span>}
<a name="l00389"></a>00389       my $paren = $parens-&gt;{$self-&gt;prev-&gt;{value}};
<a name="l00390"></a>00390       <span class="keywordflow">if</span> ($paren-&gt;{close} eq $type) {
<a name="l00391"></a>00391         my $top = $self-&gt;pop;
<a name="l00392"></a>00392         <span class="keywordflow">if</span> (!$paren-&gt;{removable} || ($top-&gt;{value}-&gt;type eq <span class="stringliteral">&quot;Comma&quot;</span>)) {
<a name="l00393"></a>00393           $top = $top-&gt;{value};
<a name="l00394"></a>00394           $top = {type =&gt; <span class="stringliteral">&#39;operand&#39;</span>, value =&gt;
<a name="l00395"></a>00395               $self-&gt;Item(<span class="stringliteral">&quot;List&quot;</span>)-&gt;new($self,[$top-&gt;makeList],$top-&gt;{isConstant},$paren,
<a name="l00396"></a>00396                     ($top-&gt;type eq <span class="stringliteral">&#39;Comma&#39;</span>) ? $top-&gt;entryType : $top-&gt;typeRef,
<a name="l00397"></a>00397                     ($type ne <span class="stringliteral">&#39;start&#39;</span>) ? ($self-&gt;top-&gt;{value},$type) : () )};
<a name="l00398"></a>00398         } <span class="keywordflow">else</span> {
<a name="l00399"></a>00399       $top-&gt;{value}{hadParens} = 1;
<a name="l00400"></a>00400     }
<a name="l00401"></a>00401         $self-&gt;pop; $self-&gt;push($top);
<a name="l00402"></a>00402         $self-&gt;CloseFn() <span class="keywordflow">if</span> ($paren-&gt;{function} &amp;&amp; $self-&gt;prev-&gt;{type} eq <span class="stringliteral">&#39;fn&#39;</span>);
<a name="l00403"></a>00403       } elsif ($paren-&gt;{formInterval} eq $type &amp;&amp; $self-&gt;top-&gt;{value}-&gt;length == 2) {
<a name="l00404"></a>00404         my $top = $self-&gt;pop-&gt;{value}; my $open = $self-&gt;pop-&gt;{value};
<a name="l00405"></a>00405         $self-&gt;pushOperand(
<a name="l00406"></a>00406            $self-&gt;Item(<span class="stringliteral">&quot;List&quot;</span>)-&gt;new($self,[$top-&gt;makeList],$top-&gt;{isConstant},
<a name="l00407"></a>00407                      $paren,$top-&gt;entryType,$open,$type));
<a name="l00408"></a>00408       } <span class="keywordflow">else</span> {
<a name="l00409"></a>00409         my $prev = $self-&gt;prev;
<a name="l00410"></a>00410         <span class="keywordflow">if</span> ($type eq <span class="stringliteral">&quot;start&quot;</span>) {$self-&gt;Error([<span class="stringliteral">&quot;Missing close parenthesis for &#39;%s&#39;&quot;</span>,$prev-&gt;{value}],$prev-&gt;{ref})}
<a name="l00411"></a>00411         elsif ($prev-&gt;{value} eq <span class="stringliteral">&quot;start&quot;</span>) {$self-&gt;Error([<span class="stringliteral">&quot;Extra close parenthesis &#39;%s&#39;&quot;</span>,$type],$ref)}
<a name="l00412"></a>00412         <span class="keywordflow">else</span> {$self-&gt;Error([<span class="stringliteral">&quot;Mismatched parentheses: &#39;%s&#39; and &#39;%s&#39;&quot;</span>,$prev-&gt;{value},$type],$ref)}
<a name="l00413"></a>00413         <span class="keywordflow">return</span>;
<a name="l00414"></a>00414       }
<a name="l00415"></a>00415       last;
<a name="l00416"></a>00416     };
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     /fn/ and <span class="keywordflow">do</span> {
<a name="l00419"></a>00419       <span class="keywordflow">if</span> ($self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;flag(<span class="stringliteral">&quot;allowMissingFunctionInputs&quot;</span>)) {
<a name="l00420"></a>00420     $self-&gt;pushBlankOperand;
<a name="l00421"></a>00421     $self-&gt;Close($type,$ref);
<a name="l00422"></a>00422       } <span class="keywordflow">else</span> {
<a name="l00423"></a>00423         my $top = $self-&gt;top;
<a name="l00424"></a>00424         $self-&gt;Error([<span class="stringliteral">&quot;Function &#39;%s&#39; is missing its input(s)&quot;</span>,$top-&gt;{name}],$top-&gt;{ref});
<a name="l00425"></a>00425       }
<a name="l00426"></a>00426       <span class="keywordflow">return</span>;
<a name="l00427"></a>00427     };
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     /<span class="keyword">operator</span>/ and <span class="keywordflow">do</span> {
<a name="l00430"></a>00430       <span class="keywordflow">if</span> ($self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;flag(<span class="stringliteral">&quot;allowMissingOperands&quot;</span>)) {
<a name="l00431"></a>00431     $self-&gt;pushBlankOperand;
<a name="l00432"></a>00432     $self-&gt;Close($type,$ref);
<a name="l00433"></a>00433       } <span class="keywordflow">else</span> {
<a name="l00434"></a>00434         my $top = $self-&gt;top(); my $name = $top-&gt;{name}; $name =~ s/^u<span class="comment">//;</span>
<a name="l00435"></a>00435         $self-&gt;Error([<span class="stringliteral">&quot;Missing operand after &#39;%s&#39;&quot;</span>,$name],$top-&gt;{ref});
<a name="l00436"></a>00436       }
<a name="l00437"></a>00437       <span class="keywordflow">return</span>;
<a name="l00438"></a>00438     };
<a name="l00439"></a>00439   }
<a name="l00440"></a>00440 }
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 <span class="preprocessor">##################################################</span>
<a name="l00443"></a>00443 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00444"></a>00444 <span class="preprocessor"></span><span class="preprocessor">#  Handle any pending operations of higher precedence</span>
<a name="l00445"></a>00445 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span><span class="preprocessor">#  While the top stack item is an operand:</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span><span class="preprocessor">#    When the preceding item is:</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span><span class="preprocessor">#      An pending operator:</span>
<a name="l00449"></a>00449 <span class="preprocessor"></span><span class="preprocessor">#        Get the precedence of the operator (use the special right-hand prrecedence</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span><span class="preprocessor">#          of there is one, otherwise use the general precedence)</span>
<a name="l00451"></a>00451 <span class="preprocessor"></span><span class="preprocessor">#        Stop processing if the current operator precedence is higher</span>
<a name="l00452"></a>00452 <span class="preprocessor"></span><span class="preprocessor">#        If the stacked operator is binary or if it is reversed (for function operators)</span>
<a name="l00453"></a>00453 <span class="preprocessor"></span><span class="preprocessor">#          Stop processing if the precedence is equal and we are right associative</span>
<a name="l00454"></a>00454 <span class="preprocessor"></span><span class="preprocessor">#          If the operand for the stacked operator is a function</span>
<a name="l00455"></a>00455 <span class="preprocessor"></span><span class="preprocessor">#            If the operation is ^(-1) (for inverses)</span>
<a name="l00456"></a>00456 <span class="preprocessor"></span><span class="preprocessor">#              Push the inverse function name</span>
<a name="l00457"></a>00457 <span class="preprocessor"></span><span class="preprocessor">#            Otherwise</span>
<a name="l00458"></a>00458 <span class="preprocessor"></span><span class="preprocessor">#              Reverse the order of the stack, so that the function can be applied</span>
<a name="l00459"></a>00459 <span class="preprocessor"></span><span class="preprocessor">#                to the next operand (it will be unreversed later)</span>
<a name="l00460"></a>00460 <span class="preprocessor"></span><span class="preprocessor">#          Otherwise (not a function, so an operand)</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span><span class="preprocessor">#            Get the operands and binary operator off the stack</span>
<a name="l00462"></a>00462 <span class="preprocessor"></span><span class="preprocessor">#            If it is reversed (for functions), get the order right</span>
<a name="l00463"></a>00463 <span class="preprocessor"></span><span class="preprocessor">#            Save the result of the binary operation as an operand on the stack</span>
<a name="l00464"></a>00464 <span class="preprocessor"></span><span class="preprocessor">#        Otherwise (the stack contains a unary operator)</span>
<a name="l00465"></a>00465 <span class="preprocessor"></span><span class="preprocessor">#          Get the operator and operand off the stack</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span><span class="preprocessor">#          Push the result of the unary operator as an operand on the stack</span>
<a name="l00467"></a>00467 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00468"></a>00468 <span class="preprocessor"></span><span class="preprocessor">#      A pending function call:</span>
<a name="l00469"></a>00469 <span class="preprocessor"></span><span class="preprocessor">#        Keep working if the precedence of the operator is higher than a function call</span>
<a name="l00470"></a>00470 <span class="preprocessor"></span><span class="preprocessor">#        Otherwise apply the function to the operator and continue</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00472"></a>00472 <span class="preprocessor"></span><span class="preprocessor">#      Anything else:</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span><span class="preprocessor">#        Return (no more pending operations)</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span><span class="preprocessor">#    If there was an error, stop processing</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00477"></a>00477 <span class="preprocessor"></span>sub Precedence {
<a name="l00478"></a>00478   my $self = shift; my $precedence = shift;
<a name="l00479"></a>00479   my $context = $self-&gt;{<a class="code" href="classcontext.html">context</a>};
<a name="l00480"></a>00480   <span class="keywordflow">while</span> ($self-&gt;state eq <span class="stringliteral">&#39;operand&#39;</span>) {
<a name="l00481"></a>00481     my $prev = $self-&gt;prev;
<a name="l00482"></a>00482     <span class="keywordflow">for</span> ($prev-&gt;{type}) {
<a name="l00483"></a>00483 
<a name="l00484"></a>00484       /<span class="keyword">operator</span>/ and <span class="keywordflow">do</span> {
<a name="l00485"></a>00485         my $prev_prec = $context-&gt;{operators}{$prev-&gt;{name}}{rprecedence};
<a name="l00486"></a>00486         $prev_prec = $prev-&gt;{precedence} unless $prev_prec;
<a name="l00487"></a>00487         <span class="keywordflow">return</span> <span class="keywordflow">if</span> ($precedence &gt; $prev_prec);
<a name="l00488"></a>00488         <span class="keywordflow">if</span> ($self-&gt;top(-2)-&gt;{type} eq <span class="stringliteral">&#39;operand&#39;</span> || $prev-&gt;{reverse}) {
<a name="l00489"></a>00489           <span class="keywordflow">return</span> <span class="keywordflow">if</span> ($precedence == $prev_prec &amp;&amp;
<a name="l00490"></a>00490               $context-&gt;{operators}{$prev-&gt;{name}}{associativity} eq <span class="stringliteral">&#39;right&#39;</span>);
<a name="l00491"></a>00491           <span class="keywordflow">if</span> ($self-&gt;top(-2)-&gt;{type} eq <span class="stringliteral">&#39;fn&#39;</span>) {
<a name="l00492"></a>00492             my $top = $self-&gt;pop; my $op = $self-&gt;pop; my $fun = $self-&gt;pop;
<a name="l00493"></a>00493             <span class="keywordflow">if</span> (<a class="code" href="classParser_1_1Function.html#aebe31319d4c4919babf42aeafcccf3e3">Parser::Function::checkInverse</a>($self,$fun,$op,$top)) {
<a name="l00494"></a>00494               $fun-&gt;{name} = $context-&gt;{<a class="code" href="PGstringevaluators_8pl.html#a432234fc3d5710ff4fdc5eacd9a0eae2">functions</a>}{$fun-&gt;{name}}{inverse};
<a name="l00495"></a>00495               $self-&gt;push($fun);
<a name="l00496"></a>00496             } <span class="keywordflow">else</span> {$self-&gt;push($top,$op,$fun)}
<a name="l00497"></a>00497           } <span class="keywordflow">else</span> {
<a name="l00498"></a>00498             my $rop = $self-&gt;pop; my $op = $self-&gt;pop; my $lop = $self-&gt;pop;
<a name="l00499"></a>00499             <span class="keywordflow">if</span> ($op-&gt;{reverse}) {my $tmp = $rop; $rop = $lop; $lop = $tmp}
<a name="l00500"></a>00500             $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;BOP&quot;</span>)-&gt;new($self,$op-&gt;{name},
<a name="l00501"></a>00501                  $lop-&gt;{value},$rop-&gt;{value},$op-&gt;{ref}),$op-&gt;{reverse});
<a name="l00502"></a>00502           }
<a name="l00503"></a>00503         } <span class="keywordflow">else</span> {
<a name="l00504"></a>00504           my $rop = $self-&gt;pop; my $op = $self-&gt;pop;
<a name="l00505"></a>00505           $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;UOP&quot;</span>)-&gt;new
<a name="l00506"></a>00506            ($self,$op-&gt;{name},$rop-&gt;{value},$op-&gt;{ref}),$op-&gt;{reverse});
<a name="l00507"></a>00507         }
<a name="l00508"></a>00508         last;
<a name="l00509"></a>00509       };
<a name="l00510"></a>00510 
<a name="l00511"></a>00511       /fn/ and <span class="keywordflow">do</span> {
<a name="l00512"></a>00512         <span class="keywordflow">return</span> <span class="keywordflow">if</span> ($precedence &gt; $context-&gt;{operators}{fn}{precedence});
<a name="l00513"></a>00513         $self-&gt;CloseFn();
<a name="l00514"></a>00514         last;
<a name="l00515"></a>00515       };
<a name="l00516"></a>00516 
<a name="l00517"></a>00517       <span class="keywordflow">return</span>;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     }
<a name="l00520"></a>00520     <span class="keywordflow">return</span> <span class="keywordflow">if</span> ($self-&gt;{error});
<a name="l00521"></a>00521   }
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 <span class="preprocessor">##################################################</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00526"></a>00526 <span class="preprocessor"></span><span class="preprocessor">#  Apply a function to its parameters</span>
<a name="l00527"></a>00527 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00528"></a>00528 <span class="preprocessor"></span><span class="preprocessor">#  If the operand is a list and the parens are those for function calls</span>
<a name="l00529"></a>00529 <span class="preprocessor"></span><span class="preprocessor">#    Use the list items as the parameters, otherwise use the top item</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span><span class="preprocessor">#  Pop the function object, and push the result of the function call</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00532"></a>00532 <span class="preprocessor"></span>sub CloseFn {
<a name="l00533"></a>00533   my $self = shift; my $context = $self-&gt;{<a class="code" href="classcontext.html">context</a>};
<a name="l00534"></a>00534   my $top = $self-&gt;pop-&gt;{value}; my $fn = $self-&gt;pop;
<a name="l00535"></a>00535   my $constant = $top-&gt;{isConstant};
<a name="l00536"></a>00536   <span class="keywordflow">if</span> ($top-&gt;{open} &amp;&amp; $context-&gt;{parens}{$top-&gt;{open}}{function} &amp;&amp;
<a name="l00537"></a>00537       $context-&gt;{parens}{$top-&gt;{open}}{close} eq $top-&gt;{close} &amp;&amp;
<a name="l00538"></a>00538       !$context-&gt;{<a class="code" href="PGstringevaluators_8pl.html#a432234fc3d5710ff4fdc5eacd9a0eae2">functions</a>}{$fn-&gt;{name}}{vectorInput})
<a name="l00539"></a>00539          {$top = $top-&gt;coords} <span class="keywordflow">else</span> {$top = [$top]}
<a name="l00540"></a>00540   $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;Function&quot;</span>)-&gt;new($self,$fn-&gt;{name},$top,$constant,$fn-&gt;{ref}));
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 
<a name="l00543"></a>00543 <span class="preprocessor">##################################################</span>
<a name="l00544"></a>00544 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span><span class="preprocessor">#  Handle a numeric token</span>
<a name="l00546"></a>00546 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00547"></a>00547 <span class="preprocessor"></span><span class="preprocessor">#  Add an implicit multiplication, if needed</span>
<a name="l00548"></a>00548 <span class="preprocessor"></span><span class="preprocessor">#  Create the number object and check it</span>
<a name="l00549"></a>00549 <span class="preprocessor"></span><span class="preprocessor">#  Save the number as an operand</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span>sub Num {
<a name="l00552"></a>00552   my $self = shift;
<a name="l00553"></a>00553   $self-&gt;ImplicitMult() <span class="keywordflow">if</span> $self-&gt;state eq <span class="stringliteral">&#39;operand&#39;</span>;
<a name="l00554"></a>00554   my $num = $self-&gt;Item(<span class="stringliteral">&quot;Number&quot;</span>)-&gt;new($self,shift,$self-&gt;{ref});
<a name="l00555"></a>00555   my $check = $self-&gt;{<a class="code" href="classcontext.html">context</a>}-&gt;flag(<span class="stringliteral">&#39;NumberCheck&#39;</span>);
<a name="l00556"></a>00556   &amp;$check($num) if $check;
<a name="l00557"></a>00557   $self-&gt;pushOperand($num);
<a name="l00558"></a>00558 }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 <span class="preprocessor">##################################################</span>
<a name="l00561"></a>00561 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00562"></a>00562 <span class="preprocessor"></span><span class="preprocessor">#  Handle a constant token</span>
<a name="l00563"></a>00563 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00564"></a>00564 <span class="preprocessor"></span><span class="preprocessor">#  Add an implicit multiplication, if needed</span>
<a name="l00565"></a>00565 <span class="preprocessor"></span><span class="preprocessor">#  Save the number as an operand</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00567"></a>00567 <span class="preprocessor"></span>sub Const {
<a name="l00568"></a>00568   my $self = shift; my $ref = $self-&gt;{ref}; my $name = shift;
<a name="l00569"></a>00569   my $const = $self-&gt;{<a class="code" href="classcontext.html">context</a>}{constants}{$name};
<a name="l00570"></a>00570   $self-&gt;ImplicitMult() <span class="keywordflow">if</span> $self-&gt;state eq <span class="stringliteral">&#39;operand&#39;</span>;
<a name="l00571"></a>00571   <span class="keywordflow">if</span> (defined($self-&gt;{<a class="code" href="classcontext.html">context</a>}{variables}{$name})) {
<a name="l00572"></a>00572     $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;Variable&quot;</span>)-&gt;new($self,$name,$ref));
<a name="l00573"></a>00573   } elsif ($const-&gt;{keepName}) {
<a name="l00574"></a>00574     $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;Constant&quot;</span>)-&gt;new($self,$name,$ref));
<a name="l00575"></a>00575   } <span class="keywordflow">else</span> {
<a name="l00576"></a>00576     $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;Value&quot;</span>)-&gt;new($self,[$const-&gt;{value}],$ref));
<a name="l00577"></a>00577   }
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="preprocessor">##################################################</span>
<a name="l00581"></a>00581 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span><span class="preprocessor">#  Handle a variable token</span>
<a name="l00583"></a>00583 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span><span class="preprocessor">#  Add an implicit multiplication, if needed</span>
<a name="l00585"></a>00585 <span class="preprocessor"></span><span class="preprocessor">#  Save the variable as an operand</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00587"></a>00587 <span class="preprocessor"></span>sub Var {
<a name="l00588"></a>00588   my $self = shift;
<a name="l00589"></a>00589   $self-&gt;ImplicitMult() <span class="keywordflow">if</span> $self-&gt;state eq <span class="stringliteral">&#39;operand&#39;</span>;
<a name="l00590"></a>00590   $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;Variable&quot;</span>)-&gt;new($self,shift,$self-&gt;{ref}));
<a name="l00591"></a>00591 }
<a name="l00592"></a>00592 
<a name="l00593"></a>00593 <span class="preprocessor">##################################################</span>
<a name="l00594"></a>00594 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00595"></a>00595 <span class="preprocessor"></span><span class="preprocessor">#  Handle a function token</span>
<a name="l00596"></a>00596 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span><span class="preprocessor">#  Add an implicit multiplication, if needed</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span><span class="preprocessor">#  Save the function object on the stack</span>
<a name="l00599"></a>00599 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span>sub Fn {
<a name="l00601"></a>00601   my $self = shift;
<a name="l00602"></a>00602   $self-&gt;ImplicitMult() <span class="keywordflow">if</span> $self-&gt;state eq <span class="stringliteral">&#39;operand&#39;</span>;
<a name="l00603"></a>00603   $self-&gt;push({type =&gt; <span class="stringliteral">&#39;fn&#39;</span>, name =&gt; shift, ref =&gt; $self-&gt;{ref}});
<a name="l00604"></a>00604 }
<a name="l00605"></a>00605 
<a name="l00606"></a>00606 <span class="preprocessor">##################################################</span>
<a name="l00607"></a>00607 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span><span class="preprocessor">#  Handle a string constant</span>
<a name="l00609"></a>00609 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00610"></a>00610 <span class="preprocessor"></span><span class="preprocessor">#  Add an implicit multiplication, if needed (will report an error)</span>
<a name="l00611"></a>00611 <span class="preprocessor"></span><span class="preprocessor">#  Save the string object on the stack</span>
<a name="l00612"></a>00612 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00613"></a>00613 <span class="preprocessor"></span>sub Str {
<a name="l00614"></a>00614   my $self = shift;
<a name="l00615"></a>00615   $self-&gt;ImplicitMult() <span class="keywordflow">if</span> $self-&gt;state eq <span class="stringliteral">&#39;operand&#39;</span>;
<a name="l00616"></a>00616   $self-&gt;pushOperand($self-&gt;Item(<span class="stringliteral">&quot;String&quot;</span>)-&gt;new($self,shift,$self-&gt;{ref}));
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 <span class="preprocessor">##################################################</span>
<a name="l00620"></a>00620 <span class="preprocessor"></span><span class="preprocessor">##################################################</span>
<a name="l00621"></a>00621 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span><span class="preprocessor">#  Evaluate the equation using the given values</span>
<a name="l00623"></a>00623 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span>sub eval {
<a name="l00625"></a>00625   my $self = shift;
<a name="l00626"></a>00626   $self-&gt;setValues(@_);
<a name="l00627"></a>00627   <span class="keywordflow">foreach</span> my $x (keys %{$self-&gt;{values}}) {
<a name="l00628"></a>00628     $self-&gt;Error([<span class="stringliteral">&quot;The value of &#39;%s&#39; can&#39;t be a formula&quot;</span>,$x])
<a name="l00629"></a>00629       <span class="keywordflow">if</span> <a class="code" href="classValue.html#afa346ffc3c989970326e02766a63523a">Value::isFormula</a>($self-&gt;{values}{$x});
<a name="l00630"></a>00630   }
<a name="l00631"></a>00631   my $value = <a class="code" href="classValue.html#a43a81d16f2f6aee0019772bf09626569">Value::makeValue</a>($self-&gt;{tree}-&gt;eval,<a class="code" href="classcontext.html">context</a>=&gt;$self-&gt;context)-&gt;with(equation=&gt;$self);
<a name="l00632"></a>00632   $value-&gt;transferFlags(<span class="stringliteral">&quot;equation&quot;</span>);
<a name="l00633"></a>00633   $self-&gt;unsetValues;
<a name="l00634"></a>00634   <span class="keywordflow">return</span> $value;
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="preprocessor">##################################################</span>
<a name="l00638"></a>00638 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span><span class="preprocessor">#  Removes redundent items (like x+-y, 0+x and 1*x, etc)</span>
<a name="l00640"></a>00640 <span class="preprocessor"></span><span class="preprocessor">#  using the provided flags</span>
<a name="l00641"></a>00641 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00642"></a>00642 <span class="preprocessor"></span>sub reduce {
<a name="l00643"></a>00643   my $self = shift;
<a name="l00644"></a>00644   $self = $self-&gt;copy($self);
<a name="l00645"></a>00645   my $reduce = $self-&gt;{<a class="code" href="classcontext.html">context</a>}{reduction};
<a name="l00646"></a>00646   $self-&gt;{<a class="code" href="classcontext.html">context</a>}{reduction} = {%{$reduce},@_};
<a name="l00647"></a>00647   $self-&gt;{tree} = $self-&gt;{tree}-&gt;reduce;
<a name="l00648"></a>00648   $self-&gt;{variables} = $self-&gt;{tree}-&gt;getVariables;
<a name="l00649"></a>00649   $self-&gt;{<a class="code" href="classcontext.html">context</a>}{reduction} = $reduce <span class="keywordflow">if</span> $reduce;
<a name="l00650"></a>00650   <span class="keyword">delete</span> $self-&gt;{f};
<a name="l00651"></a>00651   <span class="keywordflow">return</span> $self;
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 <span class="preprocessor">##################################################</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00656"></a>00656 <span class="preprocessor"></span><span class="preprocessor">#  Substitute values for one or more variables</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00658"></a>00658 <span class="preprocessor"></span>sub substitute {
<a name="l00659"></a>00659   my $self = shift;
<a name="l00660"></a>00660   $self = $self-&gt;copy($self);
<a name="l00661"></a>00661   $self-&gt;setValues(@_);
<a name="l00662"></a>00662   <span class="keywordflow">foreach</span> my $x (keys %{$self-&gt;{values}}) {<span class="keyword">delete</span> $self-&gt;{variables}{$x}}
<a name="l00663"></a>00663   $self-&gt;{tree} = $self-&gt;{tree}-&gt;substitute;
<a name="l00664"></a>00664   $self-&gt;unsetValues;
<a name="l00665"></a>00665   <span class="keywordflow">foreach</span> my $id (<span class="stringliteral">&quot;test_values&quot;</span>,<span class="stringliteral">&quot;test_adapt&quot;</span>,<span class="stringliteral">&quot;string&quot;</span>,<span class="stringliteral">&quot;f&quot;</span>,
<a name="l00666"></a>00666                   <span class="stringliteral">&quot;stack&quot;</span>,<span class="stringliteral">&quot;ref&quot;</span>,<span class="stringliteral">&quot;tokens&quot;</span>,<span class="stringliteral">&quot;space&quot;</span>,<span class="stringliteral">&quot;domainMismatch&quot;</span>) {<span class="keyword">delete</span> $self-&gt;{$id}}
<a name="l00667"></a>00667   <span class="keywordflow">return</span> $self;
<a name="l00668"></a>00668 }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670 <span class="preprocessor">##################################################</span>
<a name="l00671"></a>00671 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00672"></a>00672 <span class="preprocessor"></span><span class="preprocessor">#  Produces a printable string (substituting the given values).</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00674"></a>00674 <span class="preprocessor"></span>sub <span class="keywordtype">string</span> {
<a name="l00675"></a>00675   my $self = shift;
<a name="l00676"></a>00676   $self-&gt;setValues(@_);
<a name="l00677"></a>00677   my $string = $self-&gt;{tree}-&gt;string;
<a name="l00678"></a>00678   $self-&gt;unsetValues;
<a name="l00679"></a>00679   <span class="keywordflow">return</span> $string;
<a name="l00680"></a>00680 }
<a name="l00681"></a>00681 
<a name="l00682"></a>00682 <span class="preprocessor">##################################################</span>
<a name="l00683"></a>00683 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00684"></a>00684 <span class="preprocessor"></span><span class="preprocessor">#  Produces a TeX string (substituting the given values).</span>
<a name="l00685"></a>00685 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00686"></a>00686 <span class="preprocessor"></span>sub TeX {
<a name="l00687"></a>00687   my $self = shift;
<a name="l00688"></a>00688   $self-&gt;setValues(@_);
<a name="l00689"></a>00689   my $tex = $self-&gt;{tree}-&gt;TeX;
<a name="l00690"></a>00690   $self-&gt;unsetValues;
<a name="l00691"></a>00691   <span class="keywordflow">return</span> $tex;
<a name="l00692"></a>00692 }
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 <span class="preprocessor">##################################################</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00696"></a>00696 <span class="preprocessor"></span><span class="preprocessor">#  Produces a perl eval string (substituting the given values).</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00698"></a>00698 <span class="preprocessor"></span>sub perl {
<a name="l00699"></a>00699   my $self = shift;
<a name="l00700"></a>00700   $self-&gt;setValues(@_);
<a name="l00701"></a>00701   my $perl = $self-&gt;{tree}-&gt;perl;
<a name="l00702"></a>00702   $perl = $self-&gt;Package(<span class="stringliteral">&quot;Real&quot;</span>).<span class="stringliteral">&#39;-&gt;new(&#39;</span>.$perl.<span class="charliteral">&#39;)&#39;</span> <span class="keywordflow">if</span> $self-&gt;isRealNumber;
<a name="l00703"></a>00703   $self-&gt;unsetValues;
<a name="l00704"></a>00704   <span class="keywordflow">return</span> $perl;
<a name="l00705"></a>00705 }
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 <span class="preprocessor">##################################################</span>
<a name="l00708"></a>00708 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00709"></a>00709 <span class="preprocessor"></span><span class="preprocessor">#  Produce a perl function</span>
<a name="l00710"></a>00710 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span><span class="preprocessor">#  (Parameters specify an optional name and an array reference of</span>
<a name="l00712"></a>00712 <span class="preprocessor"></span><span class="preprocessor">#   optional variables. If the name is not included, an anonymous</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span><span class="preprocessor">#   code reference is returned.  If the variables are not included,</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span><span class="preprocessor">#   then the variables from the formula are used in sorted order.)</span>
<a name="l00715"></a>00715 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00716"></a>00716 <span class="preprocessor"></span>sub perlFunction {
<a name="l00717"></a>00717   my $self = shift; my $name = shift || <span class="stringliteral">&#39;&#39;</span>; my $vars = shift;
<a name="l00718"></a>00718   $vars = [sort(keys %{$self-&gt;{variables}})] unless $vars;
<a name="l00719"></a>00719   $vars = [$vars] unless ref($vars) eq &#39;ARRAY&#39;;
<a name="l00720"></a>00720   my $n = scalar(@{$vars}); my $vnames = <span class="stringliteral">&#39;&#39;</span>; my %isArg;
<a name="l00721"></a>00721   my $variables = $self-&gt;context-&gt;variables;
<a name="l00722"></a>00722   <span class="keywordflow">if</span> ($n &gt; 0) {
<a name="l00723"></a>00723     my @v = ();
<a name="l00724"></a>00724     <span class="keywordflow">foreach</span> my $x (@{$vars}) {
<a name="l00725"></a>00725       my $perl = $variables-&gt;get($x)-&gt;{perl} || <span class="stringliteral">&quot;\$&quot;</span>.$x;
<a name="l00726"></a>00726       substr($perl,1) =~ s/([^a-z0-9_])/<span class="stringliteral">&quot;_&quot;</span>.ord($1)/ge;
<a name="l00727"></a>00727       CORE::push(@v,$perl);
<a name="l00728"></a>00728       $isArg{$x} = 1;
<a name="l00729"></a>00729     }
<a name="l00730"></a>00730     $vnames = <span class="stringliteral">&quot;my (&quot;</span>.join(<span class="charliteral">&#39;,&#39;</span>,@v).<span class="stringliteral">&quot;) = \@_;&quot;</span>;
<a name="l00731"></a>00731   }
<a name="l00732"></a>00732   <span class="keywordflow">foreach</span> my $x (keys %{$self-&gt;{variables}}) {
<a name="l00733"></a>00733     unless ($isArg{$x}) {
<a name="l00734"></a>00734       my $perl = $variables-&gt;get($x)-&gt;{perl} || <span class="stringliteral">&quot;\$&quot;</span>.$x;
<a name="l00735"></a>00735       substr($perl,1) =~ s/([^a-z0-9_])/<span class="stringliteral">&quot;_&quot;</span>.ord($1)/ge;
<a name="l00736"></a>00736       $vnames .= <span class="stringliteral">&quot;\n      my $perl = main::Formula(&#39;$x&#39;);&quot;</span>;
<a name="l00737"></a>00737     }
<a name="l00738"></a>00738   }
<a name="l00739"></a>00739   my $context = $self-&gt;context;
<a name="l00740"></a>00740   my $fn = eval
<a name="l00741"></a>00741    <span class="stringliteral">&quot;package main;</span>
<a name="l00742"></a>00742 <span class="stringliteral">    sub $name {</span>
<a name="l00743"></a>00743 <span class="stringliteral">      die \&quot;Wrong number of arguments&quot;</span>.($name?<span class="stringliteral">&quot; to &#39;$name&#39;&quot;</span>:<span class="stringliteral">&#39;&#39;</span>).<span class="stringliteral">&quot;\&quot; if scalar(\@_) != $n;</span>
<a name="l00744"></a>00744 <span class="stringliteral">      $vnames</span>
<a name="l00745"></a>00745 <span class="stringliteral">      my \$oldContext = \$\$Value::context; \$\$Value::context = \$context;</span>
<a name="l00746"></a>00746 <span class="stringliteral">      my \@result = &quot;</span>.$self-&gt;perl.<span class="stringliteral">&quot;;</span>
<a name="l00747"></a>00747 <span class="stringliteral">      \$\$Value::context = \$oldContext;</span>
<a name="l00748"></a>00748 <span class="stringliteral">      return (wantarray ? \@result : \$result[0]);</span>
<a name="l00749"></a>00749 <span class="stringliteral">    }&quot;</span>;
<a name="l00750"></a>00750   $self-&gt;Error($@) <span class="keywordflow">if</span> $@;
<a name="l00751"></a>00751   <span class="keywordflow">return</span> $fn;
<a name="l00752"></a>00752 }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 <span class="preprocessor">##################################################</span>
<a name="l00756"></a>00756 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span><span class="preprocessor">#  Sets the values of variables for evaluation purposes</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00759"></a>00759 <span class="preprocessor"></span>sub setValues {
<a name="l00760"></a>00760   my $self = shift; my ($xref,$value,$type);
<a name="l00761"></a>00761   my $context = $self-&gt;context;
<a name="l00762"></a>00762   my $variables = $context-&gt;{variables};
<a name="l00763"></a>00763   <span class="keywordflow">while</span> (scalar(@_)) {
<a name="l00764"></a>00764     $xref = shift; $value = shift;
<a name="l00765"></a>00765     <span class="keywordflow">if</span> (ref($xref) eq <span class="stringliteral">&quot;ARRAY&quot;</span>) {
<a name="l00766"></a>00766       $value = <a class="code" href="classValue.html#a43a81d16f2f6aee0019772bf09626569">Value::makeValue</a>($value,<a class="code" href="classcontext.html">context</a>=&gt;$context) unless ref($value);
<a name="l00767"></a>00767       $value = [$value-&gt;value] if <a class="code" href="classValue.html">Value</a>::isValue($value);
<a name="l00768"></a>00768       $value = @{$value}[0,1] <span class="keywordflow">if</span> <a class="code" href="classValue.html#a3518cd4f61c793378c1a59f4ddc67226">Value::classMatch</a>(<span class="stringliteral">&quot;Interval&quot;</span>);
<a name="l00769"></a>00769       $value = [$value] unless ref($value) eq &#39;ARRAY&#39;;
<a name="l00770"></a>00770     } else {
<a name="l00771"></a>00771       $xref = [$xref]; $value = [$value];
<a name="l00772"></a>00772     }
<a name="l00773"></a>00773     <span class="keywordflow">foreach</span> my $i (0..scalar(@$xref)-1) {
<a name="l00774"></a>00774       my $x = $xref-&gt;[$i]; my $v = $value-&gt;[$i];
<a name="l00775"></a>00775       $self-&gt;Error([<span class="stringliteral">&quot;Null value can&#39;t be assigned to variable &#39;%s&#39;&quot;</span>,$x]) unless defined $v;
<a name="l00776"></a>00776       $self-&gt;Error([<span class="stringliteral">&quot;Undeclared variable &#39;%s&#39;&quot;</span>,$x]) unless defined $variables-&gt;{$x};
<a name="l00777"></a>00777       $v = <a class="code" href="classValue.html#a43a81d16f2f6aee0019772bf09626569">Value::makeValue</a>($v,<a class="code" href="classcontext.html">context</a>=&gt;$context);
<a name="l00778"></a>00778       ($v,$type) = <a class="code" href="classValue.html#aa83b3a3e57f425ecfd80d41a23da9f89">Value::getValueType</a>($self,$v);
<a name="l00779"></a>00779       $self-&gt;Error([<span class="stringliteral">&quot;Variable &#39;%s&#39; should be of type %s&quot;</span>,$x,$variables-&gt;{$x}{type}{name}])
<a name="l00780"></a>00780     unless <a class="code" href="classParser_1_1Item.html#ab2aca365840f554d7a59aff1044d6976">Parser::Item::typeMatch</a>($type,$variables-&gt;{$x}{type});
<a name="l00781"></a>00781       $v-&gt;inContext($self-&gt;context) <span class="keywordflow">if</span> $v-&gt;context != $self-&gt;context;
<a name="l00782"></a>00782       $self-&gt;{values}{$x} = $v;
<a name="l00783"></a>00783     }
<a name="l00784"></a>00784   }
<a name="l00785"></a>00785 }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787 sub unsetValues {
<a name="l00788"></a>00788   my $self = shift;
<a name="l00789"></a>00789   <span class="keyword">delete</span> $self-&gt;{values};
<a name="l00790"></a>00790 }
<a name="l00791"></a>00791 
<a name="l00792"></a>00792 
<a name="l00793"></a>00793 <span class="preprocessor">##################################################</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span><span class="preprocessor">##################################################</span>
<a name="l00795"></a>00795 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span><span class="preprocessor">#  Produce a vector in ijk form</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00798"></a>00798 <span class="preprocessor"></span>sub ijk {
<a name="l00799"></a>00799   my $self = shift;
<a name="l00800"></a>00800   $self-&gt;{tree}-&gt;ijk;
<a name="l00801"></a>00801 }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 <span class="preprocessor">#########################################################################</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span><span class="preprocessor">#########################################################################</span>
<a name="l00805"></a>00805 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00806"></a>00806 <span class="preprocessor"></span><span class="preprocessor">#  Load the sub-classes and Value.pm</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00808"></a>00808 <span class="preprocessor"></span>
<a name="l00809"></a>00809 END {
<a name="l00810"></a>00810   use <a class="code" href="classParser_1_1Item.html">Parser::Item</a>;
<a name="l00811"></a>00811   use <a class="code" href="classValue.html">Value</a>;
<a name="l00812"></a>00812   use <a class="code" href="classParser_1_1Context.html">Parser::Context</a>;
<a name="l00813"></a>00813   use <a class="code" href="classParser_1_1Context_1_1Default.html">Parser::Context::Default</a>;
<a name="l00814"></a>00814   use <a class="code" href="classParser_1_1Differentiation.html">Parser::Differentiation</a>;
<a name="l00815"></a>00815 }
<a name="l00816"></a>00816 
<a name="l00817"></a>00817 <span class="preprocessor">###########################################################################</span>
<a name="l00818"></a>00818 <span class="preprocessor"></span>
<a name="l00819"></a>00819 our $installed = 1;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 <span class="preprocessor">###########################################################################</span>
<a name="l00822"></a>00822 <span class="preprocessor"></span>
<a name="l00823"></a>00823 1;
<a name="l00824"></a>00824 
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:54:55 2012 for PG by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
