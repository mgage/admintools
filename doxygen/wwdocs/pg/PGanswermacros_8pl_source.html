<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PG: PGanswermacros.pl Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>PGanswermacros.pl</h1><a href="PGanswermacros_8pl.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: pg/macros/PGanswermacros.pl,v 1.72 2010/02/01 01:33:05 apizer Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="preprocessor"># FIXME TODO:</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span><span class="preprocessor"># Document and maybe split out: filters, graders, utilities</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span>
<a name="l00020"></a>00020 =head1 NAME
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 PGanswermacros.pl - Macros <span class="keywordflow">for</span> building answer evaluators.
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 =head1 SYNPOSIS
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 Number Answer Evaluators:
<a name="l00027"></a>00027 
<a name="l00028"></a>00028     num_cmp()   --  uses an input hash to determine parameters
<a name="l00029"></a>00029     
<a name="l00030"></a>00030     std_num_cmp(), std_num_cmp_list(), std_num_cmp_abs, std_num_cmp_abs_list()
<a name="l00031"></a>00031     frac_num_cmp(), frac_num_cmp_list(), frac_num_cmp_abs, frac_num_cmp_abs_list()
<a name="l00032"></a>00032     arith_num_cmp(), arith_num_cmp_list(), arith_num_cmp_abs, arith_num_cmp_abs_list()
<a name="l00033"></a>00033     strict_num_cmp(), strict_num_cmp_list(), strict_num_cmp_abs, strict_num_cmp_abs_list()
<a name="l00034"></a>00034     
<a name="l00035"></a>00035     numerical_compare_with_units()  --  requires units as part of the answer
<a name="l00036"></a>00036     std_num_str_cmp()   --  also accepts a set of <a class="code" href="PGstringevaluators_8pl.html#a06b59ff01c251186550d61193ec7f328">strings</a> as possible answers
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 Function Answer Evaluators:
<a name="l00039"></a>00039 
<a name="l00040"></a>00040     fun_cmp()   --  uses an input hash to determine parameters
<a name="l00041"></a>00041     
<a name="l00042"></a>00042     function_cmp(), function_cmp_abs()
<a name="l00043"></a>00043     function_cmp_up_to_constant(), function_cmp_up_to_constant_abs()
<a name="l00044"></a>00044     multivar_function_cmp()
<a name="l00045"></a>00045 
<a name="l00046"></a>00046 String Answer Evaluators:
<a name="l00047"></a>00047 
<a name="l00048"></a>00048     <a class="code" href="PGstringevaluators_8pl.html#a477d668731862987bfa3c73819d50958">str_cmp</a>()   --  uses an input hash to determine parameters
<a name="l00049"></a>00049     
<a name="l00050"></a>00050     std_str_cmp(), std_str_cmp_list(), std_cs_str_cmp(), std_cs_str_cmp_list()
<a name="l00051"></a>00051     strict_str_cmp(), strict_str_cmp_list()
<a name="l00052"></a>00052     ordered_str_cmp(), ordered_str_cmp_list(), ordered_cs_str_cmp(), ordered_cs_str_cmp_list()
<a name="l00053"></a>00053     unordered_str_cmp(), unordered_str_cmp_list(), unordered_cs_str_cmp(), unordered_cs_str_cmp_list()
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 Miscellaneous Answer Evaluators:
<a name="l00056"></a>00056 
<a name="l00057"></a>00057     checkbox_cmp()
<a name="l00058"></a>00058     radio_cmp()
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 =head1 DESCRIPTION
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 The macros in this file are factories which construct and return answer
<a name="l00063"></a>00063 evaluators for checking student answers. The macros take various arguments,
<a name="l00064"></a>00064 including the correct answer, and return an &quot;answer evaluator&quot;, which is a
<a name="l00065"></a>00065 subroutine reference suitable for passing to the <a class="code" href="PGstringevaluators_8pl.html#a33aa1133c9196fed55af79d192977ed3">ANS</a>* family of macro.
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 When called with the student&#39;s answer, the answer evaluator will compare this
<a name="l00068"></a>00068 answer to the correct answer that it keeps internally and returns an <a class="code" href="classAnswerHash.html">AnswerHash</a>
<a name="l00069"></a>00069 representing the results of the comparison. Part of the answer hash is a score,
<a name="l00070"></a>00070 which is a number between 0 and 1 representing the correctness of the student&#39;s
<a name="l00071"></a>00071 answer. The fields of an <a class="code" href="classAnswerHash.html">AnswerHash</a> are as follows:
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     score                =&gt; $correctQ,
<a name="l00074"></a>00074     correct_ans          =&gt; $originalCorrEqn,
<a name="l00075"></a>00075     student_ans          =&gt; $modified_student_ans,
<a name="l00076"></a>00076     original_student_ans =&gt; $original_student_answer,
<a name="l00077"></a>00077     ans_message          =&gt; $PGanswerMessage,
<a name="l00078"></a>00078     type                 =&gt; &#39;typeString&#39;,
<a name="l00079"></a>00079     preview_text_string  =&gt; $preview_text_string,
<a name="l00080"></a>00080     preview_latex_string =&gt; $preview_latex_string, <span class="preprocessor"># optional</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span>
<a name="l00082"></a>00082 =over
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 =item C&lt;$ans_hash{score}&gt;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 a number between 0 and 1 indicating whether the answer is correct. Fractions
<a name="l00087"></a>00087 allow the implementation of partial credit <span class="keywordflow">for</span> incorrect answers.
<a name="l00088"></a>00088 
<a name="l00089"></a>00089 =item C&lt;$ans_hash{correct_ans}&gt;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 The correct answer, as supplied by the instructor and then formatted. This can
<a name="l00092"></a>00092 be viewed by the student after the answer date.
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 =item C&lt;$ans_hash{student_ans}&gt;
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 This is the student answer, after reformatting; <span class="keywordflow">for</span> example the answer might be
<a name="l00097"></a>00097 forced to capital letters <span class="keywordflow">for</span> comparison with the instructors answer. For a
<a name="l00098"></a>00098 numerical answer, it gives the evaluated answer. This is displayed in the
<a name="l00099"></a>00099 section reporting the results of checking the student answers.
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 =item C&lt;$ans_hash{original_student_ans}&gt;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 This is the original student answer. This is displayed on the preview page and
<a name="l00104"></a>00104 may be used <span class="keywordflow">for</span> sticky answers.
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 =item C&lt;$ans_hash{ans_message}&gt;
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 Any error message, or hint provided by the answer evaluator. This is also
<a name="l00109"></a>00109 displayed in the section reporting the results of checking the student answers.
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 =item C&lt;$ans_hash{type}&gt;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 A <span class="keywordtype">string</span> indicating the type of answer evaluator. This helps in preprocessing
<a name="l00114"></a>00114 the student answer <span class="keywordflow">for</span> errors. Some examples: C&lt;&#39;number_with_units&#39;&gt;,
<a name="l00115"></a>00115 C&lt;&#39;function&#39;&gt;, C&lt;&#39;frac_number&#39;&gt;, C&lt;&#39;arith_number&#39;&gt;.
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 =item C&lt;$ans_hash{preview_text_string}&gt;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 This typically shows how the student answer was parsed. It is displayed on the
<a name="l00120"></a>00120 preview page. For a student answer of 2sin(3x) this would be 2*sin(3*x). For
<a name="l00121"></a>00121 <span class="keywordtype">string</span> answers it is typically the same as $ans_hash{student_ans}.
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 =item C&lt;$ans_hash{preview_latex_string}&gt;
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 (Optional.) This is latex version of the student answer which is used to
<a name="l00126"></a>00126 show a typeset view on the answer on the preview page. For a student answer of
<a name="l00127"></a>00127 2/3, <span class="keyword">this</span> would be \frac{2}{3}.
<a name="l00128"></a>00128 
<a name="l00129"></a>00129 =back
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 =cut
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="preprocessor"># ^uses be_strict</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span>BEGIN { be_strict() }
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="preprocessor"># Until we get the PG cacheing business sorted out, we need to use</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span><span class="preprocessor"># PG_restricted_eval to get the correct values for some(?) PG environment</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span><span class="preprocessor"># variables. We do this once here and place the values in lexicals for later</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span><span class="preprocessor"># access.</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>
<a name="l00141"></a>00141 <span class="preprocessor"># ^variable my $BR</span>
<a name="l00142"></a>00142 <span class="preprocessor"></span>my $BR;
<a name="l00143"></a>00143 <span class="preprocessor"># ^variable my $functLLimitDefault</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span>my $functLLimitDefault;
<a name="l00145"></a>00145 <span class="preprocessor"># ^variable my $functULimitDefault</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>my $functULimitDefault;
<a name="l00147"></a>00147 <span class="preprocessor"># ^variable my $functVarDefault</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span>my $functVarDefault;
<a name="l00149"></a>00149 <span class="preprocessor"># ^variable my $useBaseTenLog</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span>my $useBaseTenLog;
<a name="l00151"></a>00151 <span class="preprocessor"># ^variable my $reducedScoringPeriod</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>my $reducedScoringPeriod;
<a name="l00153"></a>00153 <span class="preprocessor"># ^variable my $reducedScoringValue</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>my $reducedScoringValue;
<a name="l00155"></a>00155 <span class="preprocessor"># ^variable my $enable_reduced_scoring</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span>my $enable_reduced_scoring;
<a name="l00157"></a>00157 <span class="preprocessor"># ^variable my $dueDate</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>my $dueDate;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="preprocessor"># ^function _PGanswermacros_init</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span><span class="preprocessor"># ^uses loadMacros</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span><span class="preprocessor"># ^uses PG_restricted_eval</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span><span class="preprocessor"># ^uses $BR</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span><span class="preprocessor"># ^uses $envir{functLLimitDefault}</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span><span class="preprocessor"># ^uses $envir{functULimitDefault}</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span><span class="preprocessor"># ^uses $envir{functVarDefault}</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span><span class="preprocessor"># ^uses $envir{useBaseTenLog}</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span><span class="preprocessor"># ^uses $envir{reducedScoringPeriod}</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span><span class="preprocessor"># ^uses $envir{reducedScoringValue}</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span><span class="preprocessor"># ^uses $envir{enable_reduced_scoring}</span>
<a name="l00171"></a>00171 <span class="preprocessor"></span><span class="preprocessor"># ^uses $envir{dueDate}</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span>
<a name="l00173"></a>00173 sub _PGanswermacros_init {
<a name="l00174"></a>00174     loadMacros(<span class="stringliteral">&#39;PGnumericevaluators.pl&#39;</span>);   # even <span class="keywordflow">if</span> these files are already loaded they need to be initialized.
<a name="l00175"></a>00175     loadMacros(<span class="stringliteral">&#39;PGfunctionevaluators.pl&#39;</span>);
<a name="l00176"></a>00176     loadMacros(<span class="stringliteral">&#39;PGstringevaluators.pl&#39;</span>);
<a name="l00177"></a>00177     loadMacros(<span class="stringliteral">&#39;PGmiscevaluators.pl&#39;</span>);
<a name="l00178"></a>00178     
<a name="l00179"></a>00179     $BR                 = PG_restricted_eval(q/$BR/);
<a name="l00180"></a>00180     $functLLimitDefault = PG_restricted_eval(q/$envir{functLLimitDefault}/);
<a name="l00181"></a>00181     $functULimitDefault = PG_restricted_eval(q/$envir{functULimitDefault}/);
<a name="l00182"></a>00182     $functVarDefault    = PG_restricted_eval(q/$envir{functVarDefault}/);
<a name="l00183"></a>00183     $useBaseTenLog      = PG_restricted_eval(q/$envir{useBaseTenLog}/);
<a name="l00184"></a>00184     $reducedScoringPeriod= PG_restricted_eval(q/$envir{reducedScoringPeriod}/);
<a name="l00185"></a>00185     $reducedScoringValue= PG_restricted_eval(q/$envir{reducedScoringValue}/);
<a name="l00186"></a>00186     $enable_reduced_scoring= PG_restricted_eval(q/$envir{enable_reduced_scoring}/);
<a name="l00187"></a>00187     $dueDate        = PG_restricted_eval(q/$envir{dueDate}/);
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190 =head1 MACROS
<a name="l00191"></a>00191 
<a name="l00192"></a>00192 =head2 Answer evaluator macros
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 The answer macros have been split up into several separate files, one <span class="keywordflow">for each</span> type:
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 L&lt;PGnumericevaluators.pl&gt; - contains answer evaluators <span class="keywordflow">for</span> evaluating numeric
<a name="l00197"></a>00197 values, including num_cmp() and related.
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 L&lt;PGfunctionevaluators.pl&gt; - contains answer evaluators for evaluating
<a name="l00200"></a>00200 <a class="code" href="PGstringevaluators_8pl.html#a432234fc3d5710ff4fdc5eacd9a0eae2">functions</a>, including fun_cmp() and related.
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 L&lt;PGstringevaluators.pl&gt; - contains answer evaluators for evaluating <a class="code" href="PGstringevaluators_8pl.html#a06b59ff01c251186550d61193ec7f328">strings</a>,
<a name="l00203"></a>00203 including <a class="code" href="PGstringevaluators_8pl.html#a477d668731862987bfa3c73819d50958">str_cmp</a>() and related.
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 L&lt;PGtextevaluators.pl&gt; - contains answer evaluators that handle free response
<a name="l00206"></a>00206 questions and questionnaires.
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 L&lt;PGmiscevaluators.pl&gt; - contains answer evaluators that don&#39;t seem to fit into
<a name="l00209"></a>00209 other categories.
<a name="l00210"></a>00210 
<a name="l00211"></a>00211 =cut
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="preprocessor">###########################################################################</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span><span class="preprocessor">### THE FOLLOWING ARE LOCAL SUBROUTINES THAT ARE MEANT TO BE CALLED ONLY FROM THIS SCRIPT.</span>
<a name="l00215"></a>00215 <span class="preprocessor"></span>
<a name="l00216"></a>00216 <span class="preprocessor">## Internal routine that converts variables into the standard array format</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span><span class="preprocessor">##</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span><span class="preprocessor">## IN:  one of the following:</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span><span class="preprocessor">##          an undefined value (i.e., no variable was specified)</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span><span class="preprocessor">##          a reference to an array of variable names -- [var1, var2]</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span><span class="preprocessor">##          a number (the number of variables desired) -- 3</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span><span class="preprocessor">##          one or more variable names -- (var1, var2)</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span><span class="preprocessor">## OUT: an array of variable names</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span>
<a name="l00225"></a>00225 <span class="preprocessor"># ^function get_var_array</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span><span class="preprocessor"># ^uses $functVarDefault</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span>sub get_var_array {
<a name="l00228"></a>00228     my $in = shift @_;
<a name="l00229"></a>00229     my @out;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <span class="keywordflow">if</span>( not defined($in) ) {            #<span class="keywordflow">if</span> nothing defined, build <span class="keywordflow">default</span> array and <span class="keywordflow">return</span>
<a name="l00232"></a>00232         @out = ( $functVarDefault );
<a name="l00233"></a>00233         <span class="keywordflow">return</span> @out;
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235     elsif( ref( $in ) eq <span class="stringliteral">&#39;ARRAY&#39;</span> ) {    #<span class="keywordflow">if</span> given an array ref, dereference and <span class="keywordflow">return</span>
<a name="l00236"></a>00236         <span class="keywordflow">return</span> @{$in};
<a name="l00237"></a>00237     }
<a name="l00238"></a>00238     elsif( $in =~ /^\d+/ ) {            #<span class="keywordflow">if</span> given a number, <span class="keyword">set</span> up the array and <span class="keywordflow">return</span>
<a name="l00239"></a>00239         <span class="keywordflow">if</span>( $in == 1 ) {
<a name="l00240"></a>00240             $out[0] = <span class="charliteral">&#39;x&#39;</span>;
<a name="l00241"></a>00241         }
<a name="l00242"></a>00242         elsif( $in == 2 ) {
<a name="l00243"></a>00243             $out[0] = <span class="charliteral">&#39;x&#39;</span>;
<a name="l00244"></a>00244             $out[1] = <span class="charliteral">&#39;y&#39;</span>;
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246         elsif( $in == 3 ) {
<a name="l00247"></a>00247             $out[0] = <span class="charliteral">&#39;x&#39;</span>;
<a name="l00248"></a>00248             $out[1] = <span class="charliteral">&#39;y&#39;</span>;
<a name="l00249"></a>00249             $out[2] = <span class="charliteral">&#39;z&#39;</span>;
<a name="l00250"></a>00250         }
<a name="l00251"></a>00251         <span class="keywordflow">else</span> {  #<span class="keywordflow">default</span> to the x_1, x_2, ... convention
<a name="l00252"></a>00252             my ($i, $tag);
<a name="l00253"></a>00253             <span class="keywordflow">for</span>($i = 0; $i &lt; $in; $i++) {$out[$i] = <span class="stringliteral">&quot;${functVarDefault}_&quot;</span>.($i+1)}
<a name="l00254"></a>00254         }
<a name="l00255"></a>00255         <span class="keywordflow">return</span> @out;
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257     <span class="keywordflow">else</span> {                      #<span class="keywordflow">if</span> given one or more names, <span class="keywordflow">return</span> as an array
<a name="l00258"></a>00258         unshift( @_, $in );
<a name="l00259"></a>00259         <span class="keywordflow">return</span> @_;
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261 }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="preprocessor">## Internal routine that converts limits into the standard array of arrays format</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor">##  Some of the cases are probably unneccessary, but better safe than sorry</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor">##</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span><span class="preprocessor">## IN:  one of the following:</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span><span class="preprocessor">##          an undefined value (i.e., no limits were specified)</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span><span class="preprocessor">##          a reference to an array of arrays of limits -- [[llim,ulim], [llim,ulim]]</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span><span class="preprocessor">##          a reference to an array of limits -- [llim, ulim]</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">##          an array of array references -- ([llim,ulim], [llim,ulim])</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span><span class="preprocessor">##          an array of limits -- (llim,ulim)</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span><span class="preprocessor">## OUT: an array of array references -- ([llim,ulim], [llim,ulim]) or ([llim,ulim])</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span>
<a name="l00274"></a>00274 <span class="preprocessor"># ^function get_limits_array</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span><span class="preprocessor"># ^uses $functLLimitDefault</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span><span class="preprocessor"># ^uses $functULimitDefault</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span>sub get_limits_array {
<a name="l00278"></a>00278     my $in = shift @_;
<a name="l00279"></a>00279     my @out;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281     <span class="keywordflow">if</span>( not defined($in) ) {                #<span class="keywordflow">if</span> nothing defined, build <span class="keywordflow">default</span> array and <span class="keywordflow">return</span>
<a name="l00282"></a>00282         @out = ( [$functLLimitDefault, $functULimitDefault] );
<a name="l00283"></a>00283         <span class="keywordflow">return</span> @out;
<a name="l00284"></a>00284     }
<a name="l00285"></a>00285     elsif( ref($in) eq <span class="stringliteral">&#39;ARRAY&#39;</span> ) {              #$in is either ref to array, or ref to array of refs
<a name="l00286"></a>00286         my @deref = @{$in};
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         <span class="keywordflow">if</span>( ref( $in-&gt;[0] ) eq <span class="stringliteral">&#39;ARRAY&#39;</span> ) {      #$in is a ref to an array of array refs
<a name="l00289"></a>00289             <span class="keywordflow">return</span> @deref;
<a name="l00290"></a>00290         }
<a name="l00291"></a>00291         <span class="keywordflow">else</span> {                      #$in was just a ref to an array of numbers
<a name="l00292"></a>00292             @out = ( $in );
<a name="l00293"></a>00293             <span class="keywordflow">return</span> @out;
<a name="l00294"></a>00294         }
<a name="l00295"></a>00295     }
<a name="l00296"></a>00296     <span class="keywordflow">else</span> {                          #$in was an array of references or numbers
<a name="l00297"></a>00297         unshift( @_, $in );
<a name="l00298"></a>00298 
<a name="l00299"></a>00299         <span class="keywordflow">if</span>( ref($_[0]) eq <span class="stringliteral">&#39;ARRAY&#39;</span> ) {           #$in was an array of references, so just <span class="keywordflow">return</span> it
<a name="l00300"></a>00300             <span class="keywordflow">return</span> @_;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302         <span class="keywordflow">else</span> {                      #$in was an array of numbers
<a name="l00303"></a>00303             @out = ( \@_ );
<a name="l00304"></a>00304             <span class="keywordflow">return</span> @out;
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306     }
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 <span class="preprocessor">#sub check_option_list {</span>
<a name="l00310"></a>00310 <span class="preprocessor"></span><span class="preprocessor">#   my $size = scalar(@_);</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span><span class="preprocessor">#   if( ( $size % 2 ) != 0 ) {</span>
<a name="l00312"></a>00312 <span class="preprocessor"></span><span class="preprocessor">#       warn &quot;ERROR in answer evaluator generator:\n&quot; .</span>
<a name="l00313"></a>00313 <span class="preprocessor"></span><span class="preprocessor">#           &quot;Usage: &lt;CODE&gt;str_cmp([\$ans1,  \$ans2],%options)&lt;/CODE&gt;</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span><span class="preprocessor">#           or &lt;CODE&gt;   num_cmp([\$num1, \$num2], %options)&lt;/CODE&gt;&lt;BR&gt;</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span><span class="preprocessor">#           A list of inputs must be inclosed in square brackets &lt;CODE&gt;[\$ans1, \$ans2]&lt;/CODE&gt;&quot;;</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span><span class="preprocessor">#}</span>
<a name="l00318"></a>00318 <span class="preprocessor"></span>
<a name="l00319"></a>00319 <span class="preprocessor"># simple subroutine to display an error message when</span>
<a name="l00320"></a>00320 <span class="preprocessor"></span><span class="preprocessor"># function compares are called with invalid parameters</span>
<a name="l00321"></a>00321 <span class="preprocessor"></span><span class="preprocessor"># ^function function_invalid_params</span>
<a name="l00322"></a>00322 <span class="preprocessor"></span>sub function_invalid_params {
<a name="l00323"></a>00323     my $correctEqn = shift @_;
<a name="l00324"></a>00324     my $error_response = sub {
<a name="l00325"></a>00325         my $PGanswerMessage = <span class="stringliteral">&quot;Tell your professor that there is an error with the parameters &quot;</span> .
<a name="l00326"></a>00326                         <span class="stringliteral">&quot;to the function answer evaluator&quot;</span>;
<a name="l00327"></a>00327         <span class="keywordflow">return</span> ( 0, $correctEqn, <span class="stringliteral">&quot;&quot;</span>, $PGanswerMessage );
<a name="l00328"></a>00328     };
<a name="l00329"></a>00329     <span class="keywordflow">return</span> $error_response;
<a name="l00330"></a>00330 }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332 <span class="preprocessor"># ^function clean_up_error_msg</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span>sub clean_up_error_msg {
<a name="l00334"></a>00334     my $msg = $_[0];
<a name="l00335"></a>00335     $msg =~ s/^\[[^\]]*\][^:]*:<span class="comment">//;</span>
<a name="l00336"></a>00336     $msg =~ s/Unquoted <span class="keywordtype">string</span><span class="comment">//g;</span>
<a name="l00337"></a>00337     $msg =~ s/may\s+clash.*/does not make sense here/;
<a name="l00338"></a>00338     $msg =~ s/\sat.*line [\d]*<span class="comment">//g;</span>
<a name="l00339"></a>00339     $msg = <span class="stringliteral">&#39;Error: &#39;</span>. $msg;
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <span class="keywordflow">return</span> $msg;
<a name="l00342"></a>00342 }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344 <span class="preprocessor">#formats the student and correct answer as specified</span>
<a name="l00345"></a>00345 <span class="preprocessor"></span><span class="preprocessor">#format must be of a form suitable for sprintf (e.g. &#39;%0.5g&#39;),</span>
<a name="l00346"></a>00346 <span class="preprocessor"></span><span class="preprocessor">#with the exception that a &#39;#&#39; at the end of the string</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span><span class="preprocessor">#will cause trailing zeros in the decimal part to be removed</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span><span class="preprocessor"># ^function prfmt</span>
<a name="l00349"></a>00349 <span class="preprocessor"></span><span class="preprocessor"># ^uses is_a_number</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>sub prfmt {
<a name="l00351"></a>00351     my($number,$format) = @_;  # attention, the order of format and number are reversed
<a name="l00352"></a>00352     my $out;
<a name="l00353"></a>00353     <span class="keywordflow">if</span> ($format) {
<a name="l00354"></a>00354         warn <span class="stringliteral">&quot;Incorrect format used: $format. &lt;BR&gt; Format should look something like %4.5g&lt;BR&gt;&quot;</span>
<a name="l00355"></a>00355                                 unless $format =~ /^\s*%\d*\.?\d*\w#?\s*$/;
<a name="l00356"></a>00356 
<a name="l00357"></a>00357         <span class="keywordflow">if</span>( $format =~ s/#\s*$<span class="comment">// ) {    # remove trailing zeros in the decimal</span>
<a name="l00358"></a>00358             $out = sprintf( $format, $number );
<a name="l00359"></a>00359             $out =~ s/(\.\d*?)0+$/$1/;
<a name="l00360"></a>00360             $out =~ s/\.$<span class="comment">//;            # in case all decimal digits were zero, remove the decimal</span>
<a name="l00361"></a>00361             $out =~ s/e/E/g;                # only use capital E<span class="stringliteral">&#39;s for exponents. Little e is for 2.71828...</span>
<a name="l00362"></a>00362 <span class="stringliteral">        } elsif (is_a_number($number) ){</span>
<a name="l00363"></a>00363 <span class="stringliteral">            $out = sprintf( $format, $number );</span>
<a name="l00364"></a>00364 <span class="stringliteral">            $out =~ s/e/E/g;                # only use capital E&#39;</span>s <span class="keywordflow">for</span> exponents. Little e is <span class="keywordflow">for</span> 2.71828...
<a name="l00365"></a>00365         } <span class="keywordflow">else</span> { # number is probably a <span class="keywordtype">string</span> representing an arithmetic expression
<a name="l00366"></a>00366             $out = $number;
<a name="l00367"></a>00367         }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     } <span class="keywordflow">else</span> {
<a name="l00370"></a>00370         <span class="keywordflow">if</span> (is_a_number($number)) {# only use capital E<span class="stringliteral">&#39;s for exponents. Little e is for 2.71828...</span>
<a name="l00371"></a>00371 <span class="stringliteral">            $out = $number;</span>
<a name="l00372"></a>00372 <span class="stringliteral">            $out =~ s/e/E/g;</span>
<a name="l00373"></a>00373 <span class="stringliteral">        } else { # number is probably a string representing an arithmetic expression</span>
<a name="l00374"></a>00374 <span class="stringliteral">            $out = $number;</span>
<a name="l00375"></a>00375 <span class="stringliteral">        }</span>
<a name="l00376"></a>00376 <span class="stringliteral">    }</span>
<a name="l00377"></a>00377 <span class="stringliteral">    return $out;</span>
<a name="l00378"></a>00378 <span class="stringliteral">}</span>
<a name="l00379"></a>00379 <span class="stringliteral">#########################################################################</span>
<a name="l00380"></a>00380 <span class="stringliteral"># Filters for answer evaluators</span>
<a name="l00381"></a>00381 <span class="stringliteral">#########################################################################</span>
<a name="l00382"></a>00382 <span class="stringliteral"></span>
<a name="l00383"></a>00383 <span class="stringliteral">=head2 Filters</span>
<a name="l00384"></a>00384 <span class="stringliteral"></span>
<a name="l00385"></a>00385 <span class="stringliteral">=pod</span>
<a name="l00386"></a>00386 <span class="stringliteral"></span>
<a name="l00387"></a>00387 <span class="stringliteral">A filter is a short subroutine with the following structure.  It accepts an</span>
<a name="l00388"></a>00388 <span class="stringliteral">AnswerHash, followed by a hash of options.  It returns an AnswerHash</span>
<a name="l00389"></a>00389 <span class="stringliteral"></span>
<a name="l00390"></a>00390 <span class="stringliteral">    $ans_hash = filter($ans_hash, %options);</span>
<a name="l00391"></a>00391 <span class="stringliteral"></span>
<a name="l00392"></a>00392 <span class="stringliteral">See the AnswerHash.pm file for a list of entries which can be expected to be found</span>
<a name="l00393"></a>00393 <span class="stringliteral">in an AnswerHash, such as &#39;</span>student_ans<span class="stringliteral">&#39;, &#39;</span>score<span class="stringliteral">&#39; and so forth.  Other entries</span>
<a name="l00394"></a>00394 <span class="stringliteral">may be present for specialized answer evaluators.</span>
<a name="l00395"></a>00395 <span class="stringliteral"></span>
<a name="l00396"></a>00396 <span class="stringliteral">The hope is that a well designed set of filters can easily be combined to form</span>
<a name="l00397"></a>00397 <span class="stringliteral">a new answer_evaluator and that this method will produce answer evaluators which are</span>
<a name="l00398"></a>00398 <span class="stringliteral">are more robust than the method of copying existing answer evaluators and modifying them.</span>
<a name="l00399"></a>00399 <span class="stringliteral"></span>
<a name="l00400"></a>00400 <span class="stringliteral">Here is an outline of how a filter is constructed:</span>
<a name="l00401"></a>00401 <span class="stringliteral"></span>
<a name="l00402"></a>00402 <span class="stringliteral">    sub filter{</span>
<a name="l00403"></a>00403 <span class="stringliteral">        my $rh_ans = shift;</span>
<a name="l00404"></a>00404 <span class="stringliteral">        my %options = @_;</span>
<a name="l00405"></a>00405 <span class="stringliteral">        assign_option_aliases(\%options,</span>
<a name="l00406"></a>00406 <span class="stringliteral">                &#39;</span>alias1<span class="stringliteral">&#39;    =&gt; &#39;</span>option5<span class="stringliteral">&#39;</span>
<a name="l00407"></a>00407 <span class="stringliteral">                &#39;</span>alias2<span class="stringliteral">&#39;    =&gt; &#39;</span>option7<span class="stringliteral">&#39;</span>
<a name="l00408"></a>00408 <span class="stringliteral">        );</span>
<a name="l00409"></a>00409 <span class="stringliteral">        set_default_options(\%options,</span>
<a name="l00410"></a>00410 <span class="stringliteral">                &#39;</span>_filter_name<span class="stringliteral">&#39;  =&gt;  &#39;</span>filter<span class="stringliteral">&#39;,</span>
<a name="l00411"></a>00411 <span class="stringliteral">                &#39;</span>option5<span class="stringliteral">&#39;       =&gt;  .0001,</span>
<a name="l00412"></a>00412 <span class="stringliteral">                &#39;</span>option7<span class="stringliteral">&#39;       =&gt;  &#39;</span>ascii<span class="stringliteral">&#39;,</span>
<a name="l00413"></a>00413 <span class="stringliteral">                &#39;</span>allow_unknown_options  =&gt;  0,
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415         .... body code of filter .......
<a name="l00416"></a>00416             <span class="keywordflow">if</span> ($error) {
<a name="l00417"></a>00417                 $rh_ans-&gt;throw_error(<span class="stringliteral">&quot;FILTER_ERROR&quot;</span>, <span class="stringliteral">&quot;Something went wrong&quot;</span>);
<a name="l00418"></a>00418 <span class="preprocessor">                # see AnswerHash.pm for details on using the throw_error method.</span>
<a name="l00419"></a>00419 <span class="preprocessor"></span>
<a name="l00420"></a>00420         $rh_ans;  #reference to an <a class="code" href="classAnswerHash.html">AnswerHash</a> <span class="keywordtype">object</span> is returned.
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 =cut
<a name="l00424"></a>00424 
<a name="l00425"></a>00425 =head4 compare_numbers
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 =cut
<a name="l00429"></a>00429 
<a name="l00430"></a>00430 <span class="preprocessor"># ^function compare_numbers</span>
<a name="l00431"></a>00431 <span class="preprocessor"></span><span class="preprocessor"># ^uses PG_answer_eval</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span><span class="preprocessor"># ^uses clean_up_error_msg</span>
<a name="l00433"></a>00433 <span class="preprocessor"></span><span class="preprocessor"># ^uses prfmt</span>
<a name="l00434"></a>00434 <span class="preprocessor"></span><span class="preprocessor"># ^uses is_a_number</span>
<a name="l00435"></a>00435 <span class="preprocessor"></span>sub compare_numbers {
<a name="l00436"></a>00436     my ($rh_ans, %options) = @_;
<a name="l00437"></a>00437     my ($inVal,$PG_eval_errors,$PG_full_error_report) = PG_answer_eval($rh_ans-&gt;{student_ans});
<a name="l00438"></a>00438     <span class="keywordflow">if</span> ($PG_eval_errors) {
<a name="l00439"></a>00439         $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;EVAL&#39;</span>,<span class="stringliteral">&#39;There is a syntax error in your answer&#39;</span>);
<a name="l00440"></a>00440         $rh_ans-&gt;{ans_message} = clean_up_error_msg($PG_eval_errors);
<a name="l00441"></a>00441 <span class="preprocessor">        # return $rh_ans;</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
<a name="l00443"></a>00443         $rh_ans-&gt;{student_ans} = prfmt($inVal,$options{format});
<a name="l00444"></a>00444     }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446     my $permitted_error;
<a name="l00447"></a>00447 
<a name="l00448"></a>00448     <span class="keywordflow">if</span> ($rh_ans-&gt;{tolType} eq <span class="stringliteral">&#39;absolute&#39;</span>)   {
<a name="l00449"></a>00449         $permitted_error = $rh_ans-&gt;{tolerance};
<a name="l00450"></a>00450     }
<a name="l00451"></a>00451     elsif ( abs($rh_ans-&gt;{correct_ans}) &lt;= $options{zeroLevel}) {
<a name="l00452"></a>00452             $permitted_error = $options{zeroLevelTol};  ## want $tol to be non zero
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454     <span class="keywordflow">else</span> {
<a name="l00455"></a>00455         $permitted_error = abs($rh_ans-&gt;{tolerance}*$rh_ans-&gt;{correct_ans});
<a name="l00456"></a>00456     }
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     my $is_a_number = is_a_number($inVal);
<a name="l00459"></a>00459     $rh_ans-&gt;{score} = 1 <span class="keywordflow">if</span> ( ($is_a_number) and
<a name="l00460"></a>00460           (abs( $inVal - $rh_ans-&gt;{correct_ans} ) &lt;= $permitted_error) );
<a name="l00461"></a>00461     <span class="keywordflow">if</span> (not $is_a_number) {
<a name="l00462"></a>00462         $rh_ans-&gt;{error_message} = <span class="stringliteral">&quot;$rh_ans-&gt;{error_message}&quot;</span>. <span class="stringliteral">&#39;Your answer does not evaluate to a number &#39;</span>;
<a name="l00463"></a>00463     }
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     $rh_ans;
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 =head4 std_num_filter
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     std_num_filter($rh_ans, %options)
<a name="l00471"></a>00471     returns $rh_ans
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 Replaces some constants using math_constants, then evaluates a perl expression.
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 =cut
<a name="l00477"></a>00477 
<a name="l00478"></a>00478 <span class="preprocessor"># ^function std_num_filter</span>
<a name="l00479"></a>00479 <span class="preprocessor"></span><span class="preprocessor"># ^uses math_constants</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span><span class="preprocessor"># ^uses PG_answer_eval</span>
<a name="l00481"></a>00481 <span class="preprocessor"></span><span class="preprocessor"># ^uses clean_up_error_msg</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span>sub std_num_filter {
<a name="l00483"></a>00483     my $rh_ans = shift;
<a name="l00484"></a>00484     my %options = @_;
<a name="l00485"></a>00485     my $in = $rh_ans-&gt;input();
<a name="l00486"></a>00486     $in = math_constants($in);
<a name="l00487"></a>00487     $rh_ans-&gt;{type} = <span class="stringliteral">&#39;std_number&#39;</span>;
<a name="l00488"></a>00488     my ($inVal,$PG_eval_errors,$PG_full_error_report);
<a name="l00489"></a>00489     <span class="keywordflow">if</span> ($in =~ /\S/) {
<a name="l00490"></a>00490         ($inVal,$PG_eval_errors,$PG_full_error_report) = PG_answer_eval($in);
<a name="l00491"></a>00491     } <span class="keywordflow">else</span> {
<a name="l00492"></a>00492         $PG_eval_errors = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00493"></a>00493     }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     <span class="keywordflow">if</span> ($PG_eval_errors) {            ##error message from eval or above
<a name="l00496"></a>00496         $rh_ans-&gt;{ans_message} = <span class="stringliteral">&#39;There is a syntax error   in your answer&#39;</span>;
<a name="l00497"></a>00497         $rh_ans-&gt;{student_ans} = 
<a name="l00498"></a>00498         clean_up_error_msg($PG_eval_errors);
<a name="l00499"></a>00499     } <span class="keywordflow">else</span> {
<a name="l00500"></a>00500         $rh_ans-&gt;{student_ans} = $inVal;
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502     $rh_ans;
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 =head4 std_num_array_filter
<a name="l00506"></a>00506 
<a name="l00507"></a>00507     std_num_array_filter($rh_ans, %options)
<a name="l00508"></a>00508     returns $rh_ans
<a name="l00509"></a>00509 
<a name="l00510"></a>00510 Assumes the {student_ans} field is a numerical  array, and applies BOTH check_syntax and std_num_filter
<a name="l00511"></a>00511 to each element of the array.  Does it<span class="stringliteral">&#39;s best to generate sensible error messages for syntax errors.</span>
<a name="l00512"></a>00512 <span class="stringliteral">A typical error message displayed in {studnet_ans} might be ( 56, error message, -4).</span>
<a name="l00513"></a>00513 <span class="stringliteral"></span>
<a name="l00514"></a>00514 <span class="stringliteral">=cut</span>
<a name="l00515"></a>00515 <span class="stringliteral"></span>
<a name="l00516"></a>00516 <span class="stringliteral"># ^function std_num_array_filter</span>
<a name="l00517"></a>00517 <span class="stringliteral"># ^uses set_default_options</span>
<a name="l00518"></a>00518 <span class="stringliteral"># ^uses AnswerHash::new</span>
<a name="l00519"></a>00519 <span class="stringliteral"># ^uses check_syntax</span>
<a name="l00520"></a>00520 <span class="stringliteral"># ^uses std_num_filter</span>
<a name="l00521"></a>00521 <span class="stringliteral">sub std_num_array_filter {</span>
<a name="l00522"></a>00522 <span class="stringliteral">    my $rh_ans= shift;</span>
<a name="l00523"></a>00523 <span class="stringliteral">    my %options = @_;</span>
<a name="l00524"></a>00524 <span class="stringliteral">    set_default_options(  \%options,</span>
<a name="l00525"></a>00525 <span class="stringliteral">                &#39;</span>_filter_name<span class="stringliteral">&#39;  =&gt;  &#39;</span>std_num_array_filter<span class="stringliteral">&#39;,</span>
<a name="l00526"></a>00526 <span class="stringliteral">    );</span>
<a name="l00527"></a>00527 <span class="stringliteral">    my @in = @{$rh_ans-&gt;{student_ans}};</span>
<a name="l00528"></a>00528 <span class="stringliteral">    my $temp_hash = new AnswerHash;</span>
<a name="l00529"></a>00529 <span class="stringliteral">    my @out=();</span>
<a name="l00530"></a>00530 <span class="stringliteral">    my $PGanswerMessage = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00531"></a>00531 <span class="stringliteral">    foreach my $item (@in)   {  # evaluate each number in the vector</span>
<a name="l00532"></a>00532 <span class="stringliteral">        $temp_hash-&gt;input($item);</span>
<a name="l00533"></a>00533 <span class="stringliteral">        $temp_hash = check_syntax($temp_hash);</span>
<a name="l00534"></a>00534 <span class="stringliteral">        if (defined($temp_hash-&gt;{error_flag}) and $temp_hash-&gt;{error_flag} eq &#39;</span>SYNTAX<span class="stringliteral">&#39;) {</span>
<a name="l00535"></a>00535 <span class="stringliteral">            $PGanswerMessage .= $temp_hash-&gt;{ans_message};</span>
<a name="l00536"></a>00536 <span class="stringliteral">            $temp_hash-&gt;{ans_message} = undef;</span>
<a name="l00537"></a>00537 <span class="stringliteral">        } else {</span>
<a name="l00538"></a>00538 <span class="stringliteral">            #continue processing</span>
<a name="l00539"></a>00539 <span class="stringliteral">            $temp_hash = std_num_filter($temp_hash);</span>
<a name="l00540"></a>00540 <span class="stringliteral">            if (defined($temp_hash-&gt;{ans_message}) and $temp_hash-&gt;{ans_message} ) {</span>
<a name="l00541"></a>00541 <span class="stringliteral">                $PGanswerMessage .= $temp_hash-&gt;{ans_message};</span>
<a name="l00542"></a>00542 <span class="stringliteral">                $temp_hash-&gt;{ans_message} = undef;</span>
<a name="l00543"></a>00543 <span class="stringliteral">            }</span>
<a name="l00544"></a>00544 <span class="stringliteral">        }</span>
<a name="l00545"></a>00545 <span class="stringliteral">        push(@out, $temp_hash-&gt;input());</span>
<a name="l00546"></a>00546 <span class="stringliteral"></span>
<a name="l00547"></a>00547 <span class="stringliteral">    }</span>
<a name="l00548"></a>00548 <span class="stringliteral">    if ($PGanswerMessage) {</span>
<a name="l00549"></a>00549 <span class="stringliteral">        $rh_ans-&gt;input( &quot;( &quot; . join(&quot;, &quot;, @out ) . &quot; )&quot; );</span>
<a name="l00550"></a>00550 <span class="stringliteral">            $rh_ans-&gt;throw_error(&#39;</span>SYNTAX<span class="stringliteral">&#39;, &#39;</span>There is a syntax error in your answer.<span class="stringliteral">&#39;);</span>
<a name="l00551"></a>00551 <span class="stringliteral">    } else {</span>
<a name="l00552"></a>00552 <span class="stringliteral">        $rh_ans-&gt;input( [@out] );</span>
<a name="l00553"></a>00553 <span class="stringliteral">    }</span>
<a name="l00554"></a>00554 <span class="stringliteral">    $rh_ans;</span>
<a name="l00555"></a>00555 <span class="stringliteral">}</span>
<a name="l00556"></a>00556 <span class="stringliteral"></span>
<a name="l00557"></a>00557 <span class="stringliteral">=head4 function_from_string2</span>
<a name="l00558"></a>00558 <span class="stringliteral"></span>
<a name="l00559"></a>00559 <span class="stringliteral"></span>
<a name="l00560"></a>00560 <span class="stringliteral"></span>
<a name="l00561"></a>00561 <span class="stringliteral">=cut</span>
<a name="l00562"></a>00562 <span class="stringliteral"></span>
<a name="l00563"></a>00563 <span class="stringliteral"># ^function function_from_string2</span>
<a name="l00564"></a>00564 <span class="stringliteral"># ^uses assign_option_aliases</span>
<a name="l00565"></a>00565 <span class="stringliteral"># ^uses set_default_options</span>
<a name="l00566"></a>00566 <span class="stringliteral"># ^uses math_constants</span>
<a name="l00567"></a>00567 <span class="stringliteral"># ^uses PG_restricted_eval</span>
<a name="l00568"></a>00568 <span class="stringliteral"># ^uses PG_answer_eval</span>
<a name="l00569"></a>00569 <span class="stringliteral"># ^uses clean_up_error_msg</span>
<a name="l00570"></a>00570 <span class="stringliteral">sub function_from_string2 {</span>
<a name="l00571"></a>00571 <span class="stringliteral">    my $rh_ans = shift;</span>
<a name="l00572"></a>00572 <span class="stringliteral">    my %options = @_;</span>
<a name="l00573"></a>00573 <span class="stringliteral">    assign_option_aliases(\%options,</span>
<a name="l00574"></a>00574 <span class="stringliteral">                &#39;</span>vars<span class="stringliteral">&#39;          =&gt; &#39;</span>ra_vars<span class="stringliteral">&#39;,</span>
<a name="l00575"></a>00575 <span class="stringliteral">                &#39;</span>var<span class="stringliteral">&#39;           =&gt; &#39;</span>ra_vars<span class="stringliteral">&#39;,</span>
<a name="l00576"></a>00576 <span class="stringliteral">                &#39;</span>store_in<span class="stringliteral">&#39;      =&gt; &#39;</span>stdout<span class="stringliteral">&#39;,</span>
<a name="l00577"></a>00577 <span class="stringliteral">    );</span>
<a name="l00578"></a>00578 <span class="stringliteral">    set_default_options(  \%options,</span>
<a name="l00579"></a>00579 <span class="stringliteral">                &#39;</span>stdin<span class="stringliteral">&#39;         =&gt;  &#39;</span>student_ans<span class="stringliteral">&#39;,</span>
<a name="l00580"></a>00580 <span class="stringliteral">                &#39;</span>stdout<span class="stringliteral">&#39;        =&gt;  &#39;</span>rf_student_ans<span class="stringliteral">&#39;,</span>
<a name="l00581"></a>00581 <span class="stringliteral">                &#39;</span>ra_vars<span class="stringliteral">&#39;       =&gt;  [qw( x y )],</span>
<a name="l00582"></a>00582 <span class="stringliteral">                &#39;</span>debug<span class="stringliteral">&#39;         =&gt;  0,</span>
<a name="l00583"></a>00583 <span class="stringliteral">                &#39;</span>_filter_name<span class="stringliteral">&#39;  =&gt;  &#39;</span>function_from_string2<span class="stringliteral">&#39;,</span>
<a name="l00584"></a>00584 <span class="stringliteral">    );</span>
<a name="l00585"></a>00585 <span class="stringliteral">    # initialize</span>
<a name="l00586"></a>00586 <span class="stringliteral">    $rh_ans-&gt;{_filter_name} = $options{_filter_name};</span>
<a name="l00587"></a>00587 <span class="stringliteral">    </span>
<a name="l00588"></a>00588 <span class="stringliteral">    my $eqn         = $rh_ans-&gt;{ $options{stdin} };</span>
<a name="l00589"></a>00589 <span class="stringliteral">    my @VARS        = @{ $options{ &#39;</span>ra_vars<span class="stringliteral">&#39;}    };</span>
<a name="l00590"></a>00590 <span class="stringliteral">    #warn &quot;VARS = &quot;, join(&quot;&lt;&gt;&quot;, @VARS) if defined($options{debug}) and $options{debug} ==1;</span>
<a name="l00591"></a>00591 <span class="stringliteral">    my $originalEqn = $eqn;</span>
<a name="l00592"></a>00592 <span class="stringliteral">    $eqn            = &amp;math_constants($eqn);</span>
<a name="l00593"></a>00593 <span class="stringliteral">    for( my $i = 0; $i &lt; @VARS; $i++ ) {</span>
<a name="l00594"></a>00594 <span class="stringliteral">        #  This next line is a hack required for 5.6.0 -- it doesn&#39;</span>t appear to be needed in 5.6.1
<a name="l00595"></a>00595         my ($temp,$er1,$er2) = PG_restricted_eval(<span class="charliteral">&#39;&quot;&#39;</span>. $VARS[$i] . <span class="charliteral">&#39;&quot;&#39;</span>);
<a name="l00596"></a>00596 <span class="preprocessor">        #$eqn   =~ s/\b$VARS[$i]\b/\$VARS[$i]/g;</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span>        $eqn    =~ s/\b$temp\b/\$VARS[$i]/g;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599     }
<a name="l00600"></a>00600 <span class="preprocessor">    #warn &quot;equation evaluated = $eqn&quot;,$rh_ans-&gt;pretty_print(), &quot;&lt;br&gt;\noptions&lt;br&gt;\n&quot;,</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span><span class="preprocessor">    #     pretty_print(\%options)</span>
<a name="l00602"></a>00602 <span class="preprocessor"></span><span class="preprocessor">    #     if defined($options{debug}) and $options{debug} ==1;</span>
<a name="l00603"></a>00603 <span class="preprocessor"></span>    my ($function_sub,$PG_eval_errors, $PG_full_errors) = PG_answer_eval( q!
<a name="l00604"></a>00604         sub {
<a name="l00605"></a>00605             my @VARS = @_;
<a name="l00606"></a>00606             my $input_str = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00607"></a>00607             <span class="keywordflow">for</span>( my $i=0; $i&lt;@VARS; $i++ ) {
<a name="l00608"></a>00608                 $input_str .= <span class="stringliteral">&quot;\$VARS[$i] = $VARS[$i]; &quot;</span>;
<a name="l00609"></a>00609             }
<a name="l00610"></a>00610             my $PGanswerMessage;
<a name="l00611"></a>00611             $input_str .= <span class="stringliteral">&#39;! . $eqn . q!&#39;</span>;  # need the single quotes to keep the contents of $eqn from being
<a name="l00612"></a>00612 <span class="preprocessor">                                            # evaluated when it is assigned to $input_str;</span>
<a name="l00613"></a>00613 <span class="preprocessor"></span>            my ($out, $PG_eval_errors, $PG_full_errors) = PG_answer_eval($input_str); #Finally evaluated
<a name="l00614"></a>00614 
<a name="l00615"></a>00615             <span class="keywordflow">if</span> ( defined($PG_eval_errors) and $PG_eval_errors =~ /\S/ ) {
<a name="l00616"></a>00616                 $PGanswerMessage    = clean_up_error_msg($PG_eval_errors);
<a name="l00617"></a>00617 <span class="preprocessor"># This message seemed too verbose, but it does give extra information, we&#39;ll see if it is needed.</span>
<a name="l00618"></a>00618 <span class="preprocessor"></span><span class="preprocessor">#                    &quot;&lt;br&gt; There was an error in evaluating your function &lt;br&gt;</span>
<a name="l00619"></a>00619 <span class="preprocessor"></span><span class="preprocessor">#                   !. $originalEqn . q! &lt;br&gt;</span>
<a name="l00620"></a>00620 <span class="preprocessor"></span><span class="preprocessor">#                   at ( &quot; . join(&#39;, &#39;, @VARS) . &quot; ) &lt;br&gt;</span>
<a name="l00621"></a>00621 <span class="preprocessor"></span><span class="preprocessor">#                    $PG_eval_errors</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span><span class="preprocessor">#                   &quot;;   # this message appears in the answer section which is not process by Latex2HTML so it must</span>
<a name="l00623"></a>00623 <span class="preprocessor"></span><span class="preprocessor">#                        # be in HTML.  That is why $BR is NOT used.</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span>
<a name="l00625"></a>00625             }
<a name="l00626"></a>00626             (wantarray) ? ($out, $PGanswerMessage): $out;   # PGanswerMessage may be undefined.
<a name="l00627"></a>00627         };
<a name="l00628"></a>00628     !);
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     <span class="keywordflow">if</span> (defined($PG_eval_errors) and $PG_eval_errors =~/\S/ ) {
<a name="l00631"></a>00631                 $PG_eval_errors = clean_up_error_msg($PG_eval_errors);
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         my $PGanswerMessage = <span class="stringliteral">&quot;There was an error in converting the expression</span>
<a name="l00634"></a>00634 <span class="stringliteral">            $BR $originalEqn $BR into a function.</span>
<a name="l00635"></a>00635 <span class="stringliteral">            $BR $PG_eval_errors.&quot;</span>;
<a name="l00636"></a>00636         $rh_ans-&gt;{rf_student_ans} = $function_sub;
<a name="l00637"></a>00637         $rh_ans-&gt;{ans_message} = $PGanswerMessage;
<a name="l00638"></a>00638         $rh_ans-&gt;{error_message} = $PGanswerMessage;
<a name="l00639"></a>00639         $rh_ans-&gt;{error_flag} = 1;
<a name="l00640"></a>00640 <span class="preprocessor">         # we couldn&#39;t compile the equation, we&#39;ll return an error message.</span>
<a name="l00641"></a>00641 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
<a name="l00642"></a>00642 <span class="preprocessor">#       if (defined($options{stdout} )) {</span>
<a name="l00643"></a>00643 <span class="preprocessor"></span><span class="preprocessor">#           $rh_ans -&gt;{$options{stdout}} = $function_sub;</span>
<a name="l00644"></a>00644 <span class="preprocessor"></span><span class="preprocessor">#       } else {</span>
<a name="l00645"></a>00645 <span class="preprocessor"></span><span class="preprocessor">#           $rh_ans-&gt;{rf_student_ans} = $function_sub;</span>
<a name="l00646"></a>00646 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00647"></a>00647 <span class="preprocessor"></span>        $rh_ans -&gt;{$options{stdout}} = $function_sub;
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650     $rh_ans;
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653 =head4 is_zero_array
<a name="l00654"></a>00654 
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 =cut
<a name="l00657"></a>00657 
<a name="l00658"></a>00658 <span class="preprocessor"># ^function is_zero_array</span>
<a name="l00659"></a>00659 <span class="preprocessor"></span><span class="preprocessor"># ^uses is_a_number</span>
<a name="l00660"></a>00660 <span class="preprocessor"></span>sub is_zero_array {
<a name="l00661"></a>00661     my $rh_ans = shift;
<a name="l00662"></a>00662     my %options = @_;
<a name="l00663"></a>00663     set_default_options(  \%options,
<a name="l00664"></a>00664                 <span class="stringliteral">&#39;_filter_name&#39;</span>  =&gt;  <span class="stringliteral">&#39;is_zero_array&#39;</span>,
<a name="l00665"></a>00665                 <span class="stringliteral">&#39;tolerance&#39;</span>     =&gt;  0.000001,
<a name="l00666"></a>00666                 <span class="stringliteral">&#39;stdin&#39;</span>         =&gt; <span class="stringliteral">&#39;ra_differences&#39;</span>,
<a name="l00667"></a>00667                 <span class="stringliteral">&#39;stdout&#39;</span>        =&gt; <span class="stringliteral">&#39;score&#39;</span>,
<a name="l00668"></a>00668     );
<a name="l00669"></a>00669 <span class="preprocessor">    #intialize</span>
<a name="l00670"></a>00670 <span class="preprocessor"></span>    $rh_ans-&gt;{_filter_name} = $options{_filter_name};
<a name="l00671"></a>00671     
<a name="l00672"></a>00672     my $array = $rh_ans -&gt; {$options{stdin}};  # <span class="keywordflow">default</span> ra_differences
<a name="l00673"></a>00673     my $num = @$array;
<a name="l00674"></a>00674     my $i;
<a name="l00675"></a>00675     my $max = 0; my $mm;
<a name="l00676"></a>00676     <span class="keywordflow">for</span> ($i=0; $i&lt; $num; $i++) {
<a name="l00677"></a>00677         $mm = $array-&gt;[$i] ;
<a name="l00678"></a>00678         <span class="keywordflow">if</span>  (not is_a_number($mm) ) {
<a name="l00679"></a>00679             $max = $mm;  # <span class="keywordflow">break</span> out <span class="keywordflow">if</span> one of the elements is not a number
<a name="l00680"></a>00680             last;
<a name="l00681"></a>00681         }
<a name="l00682"></a>00682         $max = abs($mm) if abs($mm) &gt; $max;
<a name="l00683"></a>00683     }
<a name="l00684"></a>00684     if (not is_a_number($max)) {
<a name="l00685"></a>00685         $rh_ans-&gt;{score} = 0;
<a name="l00686"></a>00686         my $error = <span class="stringliteral">&quot;WeBWorK was unable evaluate your function. Please check that your</span>
<a name="l00687"></a>00687 <span class="stringliteral">                    expression doesn&#39;t take roots of negative numbers, or divide by zero.&quot;</span>;
<a name="l00688"></a>00688         $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;EVAL&#39;</span>,$error);
<a name="l00689"></a>00689     } <span class="keywordflow">else</span> {
<a name="l00690"></a>00690         $rh_ans-&gt;{$options{stdout}} = ($max &lt; $options{tolerance} ) ? 1: 0;       # <span class="keyword">set</span> <span class="stringliteral">&#39;score&#39;</span> to 1 <span class="keywordflow">if</span> the array is close to 0;
<a name="l00691"></a>00691     }
<a name="l00692"></a>00692     $rh_ans;
<a name="l00693"></a>00693 }
<a name="l00694"></a>00694 
<a name="l00695"></a>00695 =head4 best_approx_parameters
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     best_approx_parameters($rh_ans,%options);   #requires the following fields in $rh_ans
<a name="l00698"></a>00698                           {rf_student_ans}      # reference to the test answer
<a name="l00699"></a>00699                           {rf_correct_ans}      # reference to the comparison answer
<a name="l00700"></a>00700                           {evaluation_points},  # an array of row vectors indicating the points
<a name="l00701"></a>00701 <span class="preprocessor">                                                # to evaluate when comparing the functions</span>
<a name="l00702"></a>00702 <span class="preprocessor"></span>
<a name="l00703"></a>00703                            %options             # debug =&gt; 1   gives more error answers
<a name="l00704"></a>00704 <span class="preprocessor">                                                # param_vars =&gt; [&#39;&#39;]  additional parameters used to adapt to function</span>
<a name="l00705"></a>00705 <span class="preprocessor"></span>                           )
<a name="l00706"></a>00706 
<a name="l00707"></a>00707 
<a name="l00708"></a>00708 The parameters <span class="keywordflow">for</span> the comparison function which best approximates the test_function are stored
<a name="l00709"></a>00709 in the field {ra_parameters}.
<a name="l00710"></a>00710 
<a name="l00711"></a>00711 
<a name="l00712"></a>00712 The last $dim_of_parms_space variables are assumed to be parameters, and it is also
<a name="l00713"></a>00713 assumed that the function \&amp;comparison_fun
<a name="l00714"></a>00714 depends linearly on these variables.  This function finds the  values <span class="keywordflow">for</span> these parameters which minimizes the
<a name="l00715"></a>00715 Euclidean distance (L2 distance) between the test function and the comparison function and the test points specified
<a name="l00716"></a>00716 by the array reference  \@rows_of_test_points.  This is assumed to be an array of arrays, with the inner arrays
<a name="l00717"></a>00717 determining a test point.
<a name="l00718"></a>00718 
<a name="l00719"></a>00719 The comparison function should have $dim_of_params_space more input variables than the test function.
<a name="l00720"></a>00720 
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 
<a name="l00723"></a>00723 
<a name="l00724"></a>00724 
<a name="l00725"></a>00725 =cut
<a name="l00726"></a>00726 
<a name="l00727"></a>00727 <span class="preprocessor">#   Used internally:</span>
<a name="l00728"></a>00728 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00729"></a>00729 <span class="preprocessor"></span><span class="preprocessor">#   &amp;$determine_param_coeff( $rf_comparison_function # a reference to the correct answer function</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span><span class="preprocessor">#                    $ra_variables                   # an array of the active input variables to the functions</span>
<a name="l00731"></a>00731 <span class="preprocessor"></span><span class="preprocessor">#                    $dim_of_params_space            # indicates the number of parameters upon which the</span>
<a name="l00732"></a>00732 <span class="preprocessor"></span><span class="preprocessor">#                                                    # the comparison function depends linearly.  These are assumed to</span>
<a name="l00733"></a>00733 <span class="preprocessor"></span><span class="preprocessor">#                                                    # be the last group of inputs to the comparison function.</span>
<a name="l00734"></a>00734 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span><span class="preprocessor">#                    %options                        # $options{debug} gives more error messages</span>
<a name="l00736"></a>00736 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00737"></a>00737 <span class="preprocessor"></span><span class="preprocessor">#                                                    # A typical function might look like</span>
<a name="l00738"></a>00738 <span class="preprocessor"></span><span class="preprocessor">#                                                    # f(x,y,z,a,b) = x^2+a*cos(xz) + b*sin(x) with a parameter</span>
<a name="l00739"></a>00739 <span class="preprocessor"></span><span class="preprocessor">#                                                    # space of dimension 2 and a variable space of dimension 3.</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span><span class="preprocessor">#                   )</span>
<a name="l00741"></a>00741 <span class="preprocessor"></span><span class="preprocessor">#               # returns a list of coefficients</span>
<a name="l00742"></a>00742 <span class="preprocessor"></span>
<a name="l00743"></a>00743 <span class="preprocessor"># ^function best_approx_parameters</span>
<a name="l00744"></a>00744 <span class="preprocessor"></span><span class="preprocessor"># ^uses set_default_options</span>
<a name="l00745"></a>00745 <span class="preprocessor"></span><span class="preprocessor"># ^uses pretty_print</span>
<a name="l00746"></a>00746 <span class="preprocessor"></span><span class="preprocessor"># ^uses Matrix::new</span>
<a name="l00747"></a>00747 <span class="preprocessor"></span><span class="preprocessor"># ^uses is_a_number</span>
<a name="l00748"></a>00748 <span class="preprocessor"></span>sub best_approx_parameters {
<a name="l00749"></a>00749     my $rh_ans = shift;
<a name="l00750"></a>00750     my %options = @_;
<a name="l00751"></a>00751     set_default_options(\%options,
<a name="l00752"></a>00752             <span class="stringliteral">&#39;_filter_name&#39;</span>          =&gt;  <span class="stringliteral">&#39;best_approx_paramters&#39;</span>,
<a name="l00753"></a>00753             <span class="stringliteral">&#39;allow_unknown_options&#39;</span> =&gt;  1,
<a name="l00754"></a>00754     );
<a name="l00755"></a>00755     my $errors = undef;
<a name="l00756"></a>00756 <span class="preprocessor">    # This subroutine for the determining the coefficents of the parameters at a given point</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span><span class="preprocessor">    # is pretty specialized, so it is included here as a sub-subroutine.</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span>    my $determine_param_coeffs  = sub {
<a name="l00759"></a>00759         my ($rf_fun, $ra_variables, $dim_of_params_space, %options) =@_;
<a name="l00760"></a>00760         my @zero_params=();
<a name="l00761"></a>00761         <span class="keywordflow">for</span>(my $i=1;$i&lt;=$dim_of_params_space;$i++){push(@zero_params,0); }
<a name="l00762"></a>00762         my @vars = @$ra_variables;
<a name="l00763"></a>00763         my @coeff = ();
<a name="l00764"></a>00764         my @inputs = (@vars,@zero_params);
<a name="l00765"></a>00765         my ($f0, $f1, $err);
<a name="l00766"></a>00766         ($f0, $err) = &amp;{$rf_fun}(@inputs);
<a name="l00767"></a>00767         <span class="keywordflow">if</span> (defined($err) ) {
<a name="l00768"></a>00768             $errors .= <span class="stringliteral">&quot;$err &quot;</span>;
<a name="l00769"></a>00769         } <span class="keywordflow">else</span> {
<a name="l00770"></a>00770             <span class="keywordflow">for</span> (my $i=@vars;$i&lt;@inputs;$i++) {
<a name="l00771"></a>00771                 $inputs[$i]=1;  # <span class="keyword">set</span> one parameter to 1;
<a name="l00772"></a>00772                 my($f1,$err) = &amp;$rf_fun(@inputs);
<a name="l00773"></a>00773                 <span class="keywordflow">if</span> (defined($err) ) {
<a name="l00774"></a>00774                     $errors .= <span class="stringliteral">&quot; $err &quot;</span>;
<a name="l00775"></a>00775                 } <span class="keywordflow">else</span> {
<a name="l00776"></a>00776                     push(@coeff, $f1-$f0);
<a name="l00777"></a>00777                 }
<a name="l00778"></a>00778                 $inputs[$i]=0;  # <span class="keyword">set</span> it back
<a name="l00779"></a>00779             }
<a name="l00780"></a>00780         }
<a name="l00781"></a>00781         (\@coeff, $errors);
<a name="l00782"></a>00782     };
<a name="l00783"></a>00783     my $rf_fun = $rh_ans-&gt;{rf_student_ans};
<a name="l00784"></a>00784     my $rf_correct_fun = $rh_ans-&gt;{rf_correct_ans};
<a name="l00785"></a>00785     my $ra_vars_matrix = $rh_ans-&gt;{evaluation_points};
<a name="l00786"></a>00786     my $dim_of_param_space = @{$options{param_vars}};
<a name="l00787"></a>00787 <span class="preprocessor">    # Short cut.  Bail if there are no param_vars</span>
<a name="l00788"></a>00788 <span class="preprocessor"></span>    unless ($dim_of_param_space &gt;0) {
<a name="l00789"></a>00789         $rh_ans -&gt;{ra_parameters} = [];
<a name="l00790"></a>00790         <span class="keywordflow">return</span> $rh_ans;
<a name="l00791"></a>00791     }
<a name="l00792"></a>00792 <span class="preprocessor">    # inputs are row arrays in this case.</span>
<a name="l00793"></a>00793 <span class="preprocessor"></span>    my @zero_params=();
<a name="l00794"></a>00794 
<a name="l00795"></a>00795     <span class="keywordflow">for</span>(my $i=1;$i&lt;=$dim_of_param_space;$i++){push(@zero_params,0); }
<a name="l00796"></a>00796     my @rows_of_vars = @$ra_vars_matrix;
<a name="l00797"></a>00797     warn <span class="stringliteral">&quot;input rows &quot;</span>, pretty_print(\@rows_of_vars) if defined($options{debug}) and $options{debug};
<a name="l00798"></a>00798     my $rows = @rows_of_vars;
<a name="l00799"></a>00799     my $matrix = <a class="code" href="classMatrix.html">Matrix</a>-&gt;new($rows,$dim_of_param_space);
<a name="l00800"></a>00800     my $rhs_vec =  <a class="code" href="classMatrix.html">Matrix</a>-&gt;new($rows, 1);
<a name="l00801"></a>00801     my $row_num = 1;
<a name="l00802"></a>00802     my ($ra_coeff,$val2, $val1, $err1,$err2,@inputs,@vars);
<a name="l00803"></a>00803     my $number_of_data_points = $dim_of_param_space +2;
<a name="l00804"></a>00804     <span class="keywordflow">while</span> (@rows_of_vars and $row_num &lt;= $number_of_data_points) {
<a name="l00805"></a>00805 <span class="preprocessor">       # get one set of data points from the test function;</span>
<a name="l00806"></a>00806 <span class="preprocessor"></span>        @vars = @{ shift(@rows_of_vars) };
<a name="l00807"></a>00807         ($val2, $err1) = &amp;{$rf_fun}(@vars);
<a name="l00808"></a>00808         $errors .= <span class="stringliteral">&quot; $err1 &quot;</span>  <span class="keywordflow">if</span> defined($err1);
<a name="l00809"></a>00809         @inputs = (@vars,@zero_params);
<a name="l00810"></a>00810         ($val1, $err2) = &amp;{$rf_correct_fun}(@inputs);
<a name="l00811"></a>00811         $errors .= <span class="stringliteral">&quot; $err2 &quot;</span> <span class="keywordflow">if</span> defined($err2);
<a name="l00812"></a>00812 
<a name="l00813"></a>00813         unless (defined($err1) or defined($err2) ) {
<a name="l00814"></a>00814             $rhs_vec-&gt;assign($row_num,1, $val2-$val1 );
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 <span class="preprocessor">        # warn &quot;rhs data  val1=$val1, val2=$val2, val2 - val1 = &quot;, $val2 - $val1 if $options{debug};</span>
<a name="l00817"></a>00817 <span class="preprocessor"></span><span class="preprocessor">        # warn &quot;vars &quot;, join(&quot; | &quot;, @vars) if $options{debug};</span>
<a name="l00818"></a>00818 <span class="preprocessor"></span>
<a name="l00819"></a>00819             ($ra_coeff, $err1) = &amp;{$determine_param_coeffs}($rf_correct_fun,\@vars,$dim_of_param_space,%options);
<a name="l00820"></a>00820             <span class="keywordflow">if</span> (defined($err1) ) {
<a name="l00821"></a>00821                 $errors .= <span class="stringliteral">&quot; $err1 &quot;</span>;
<a name="l00822"></a>00822             } <span class="keywordflow">else</span> {
<a name="l00823"></a>00823                 my @coeff = @$ra_coeff;
<a name="l00824"></a>00824                 my $col_num=1;
<a name="l00825"></a>00825                 <span class="keywordflow">while</span>(@coeff) {
<a name="l00826"></a>00826                     $matrix-&gt;assign($row_num,$col_num, shift(@coeff) );
<a name="l00827"></a>00827                     $col_num++;
<a name="l00828"></a>00828                 }
<a name="l00829"></a>00829             }
<a name="l00830"></a>00830         }
<a name="l00831"></a>00831         $row_num++;
<a name="l00832"></a>00832         last <span class="keywordflow">if</span> $errors;  # <span class="keywordflow">break</span> <span class="keywordflow">if</span> there are any errors.
<a name="l00833"></a>00833                           # This cuts down on the size of error messages.
<a name="l00834"></a>00834                           # However it impossible to check <span class="keywordflow">for</span> equivalence at 95% of points
<a name="l00835"></a>00835 <span class="preprocessor">                  # which might be useful for functions that are not defined at some points.</span>
<a name="l00836"></a>00836 <span class="preprocessor"></span>    }
<a name="l00837"></a>00837       warn <span class="stringliteral">&quot;&lt;br&gt; best_approx_parameters: matrix1 &lt;br&gt;  &quot;</span>, <span class="stringliteral">&quot; $matrix &quot;</span> <span class="keywordflow">if</span> $options{debug};
<a name="l00838"></a>00838       warn <span class="stringliteral">&quot;&lt;br&gt; best_approx_parameters: vector &lt;br&gt;  &quot;</span>, <span class="stringliteral">&quot; $rhs_vec &quot;</span> <span class="keywordflow">if</span> $options{debug};
<a name="l00839"></a>00839 
<a name="l00840"></a>00840 <span class="preprocessor">     # we have   Matrix * parameter = data_vec + perpendicular vector</span>
<a name="l00841"></a>00841 <span class="preprocessor"></span><span class="preprocessor">     # where the matrix has column vectors defining the span of the parameter space</span>
<a name="l00842"></a>00842 <span class="preprocessor"></span><span class="preprocessor">     # multiply both sides by Matrix_transpose and solve for the parameters</span>
<a name="l00843"></a>00843 <span class="preprocessor"></span><span class="preprocessor">     # This is exactly what the method proj_coeff method does.</span>
<a name="l00844"></a>00844 <span class="preprocessor"></span>     my @array;
<a name="l00845"></a>00845      <span class="keywordflow">if</span> (defined($errors) ) {
<a name="l00846"></a>00846         @array = ();   #     <span class="keyword">new</span> <a class="code" href="classMatrix.html">Matrix</a>($dim_of_param_space,1);
<a name="l00847"></a>00847      } <span class="keywordflow">else</span> {
<a name="l00848"></a>00848         @array = $matrix-&gt;proj_coeff($rhs_vec)-&gt;list();
<a name="l00849"></a>00849      }
<a name="l00850"></a>00850 <span class="preprocessor">    # check size (hack)</span>
<a name="l00851"></a>00851 <span class="preprocessor"></span>    my $max = 0;
<a name="l00852"></a>00852     <span class="keywordflow">foreach</span> my $val (@array ) {
<a name="l00853"></a>00853         $max = abs($val) if  $max &lt; abs($val);
<a name="l00854"></a>00854         if (not is_a_number($val) ) {
<a name="l00855"></a>00855             $max = <span class="stringliteral">&quot;NaN: $val&quot;</span>;
<a name="l00856"></a>00856             last;
<a name="l00857"></a>00857         }
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859     <span class="keywordflow">if</span> ($max =~/NaN/) {
<a name="l00860"></a>00860         $errors .= <span class="stringliteral">&quot;WeBWorK was unable evaluate your function. Please check that your</span>
<a name="l00861"></a>00861 <span class="stringliteral">                    expression doesn&#39;t take roots of negative numbers, or divide by zero.&quot;</span>;
<a name="l00862"></a>00862     } elsif ($max &gt; $options{maxConstantOfIntegration} ) {
<a name="l00863"></a>00863         $errors .= <span class="stringliteral">&quot;At least one of the adapting parameters</span>
<a name="l00864"></a>00864 <span class="stringliteral">               (perhaps the constant of integration) is too large: $max,</span>
<a name="l00865"></a>00865 <span class="stringliteral">               ( the maximum allowed is $options{maxConstantOfIntegration} )&quot;</span>;
<a name="l00866"></a>00866     }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     $rh_ans-&gt;{ra_parameters} = \@array;
<a name="l00869"></a>00869     $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;EVAL&#39;</span>, $errors) <span class="keywordflow">if</span> defined($errors);
<a name="l00870"></a>00870     $rh_ans;
<a name="l00871"></a>00871 }
<a name="l00872"></a>00872 
<a name="l00873"></a>00873 =head4 calculate_difference_vector
<a name="l00874"></a>00874 
<a name="l00875"></a>00875     calculate_difference_vector( $ans_hash, %options);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877                       {rf_student_ans},     # a reference to the test function
<a name="l00878"></a>00878                                  {rf_correct_ans},      # a reference to the correct answer function
<a name="l00879"></a>00879                                  {evaluation_points},   # an array of row vectors indicating the points
<a name="l00880"></a>00880 <span class="preprocessor">                                                # to evaluate when comparing the functions</span>
<a name="l00881"></a>00881 <span class="preprocessor"></span>                                 {ra_parameters}        # these are the (optional) additional inputs to
<a name="l00882"></a>00882                                                         <span class="preprocessor"># the comparison function which adapt it properly</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span><span class="preprocessor">                                                        # to the problem at hand.</span>
<a name="l00884"></a>00884 <span class="preprocessor"></span>
<a name="l00885"></a>00885                                  %options               # mode =&gt; <span class="stringliteral">&#39;rel&#39;</span>  specifies that each element in the
<a name="l00886"></a>00886 <span class="preprocessor">                                                        # difference matrix is divided by the correct answer.</span>
<a name="l00887"></a>00887 <span class="preprocessor"></span><span class="preprocessor">                                                        # unless the correct answer is nearly 0.</span>
<a name="l00888"></a>00888 <span class="preprocessor"></span>                                )
<a name="l00889"></a>00889 
<a name="l00890"></a>00890 =cut
<a name="l00891"></a>00891 
<a name="l00892"></a>00892 # ^function calculate_difference_vector
<a name="l00893"></a>00893 # ^uses assign_option_aliases
<a name="l00894"></a>00894 # ^uses set_default_options
<a name="l00895"></a>00895 sub calculate_difference_vector {
<a name="l00896"></a>00896     my $rh_ans = shift;
<a name="l00897"></a>00897     my %options = @_;
<a name="l00898"></a>00898     assign_option_aliases( \%options,
<a name="l00899"></a>00899     );
<a name="l00900"></a>00900     set_default_options(    \%options,
<a name="l00901"></a>00901         allow_unknown_options  =&gt;  1,
<a name="l00902"></a>00902         stdin1                 =&gt; <span class="stringliteral">&#39;rf_student_ans&#39;</span>,
<a name="l00903"></a>00903         stdin2                 =&gt; <span class="stringliteral">&#39;rf_correct_ans&#39;</span>,
<a name="l00904"></a>00904         stdout                 =&gt; <span class="stringliteral">&#39;ra_differences&#39;</span>,
<a name="l00905"></a>00905         debug                  =&gt;  0,
<a name="l00906"></a>00906         tolType                =&gt; <span class="stringliteral">&#39;absolute&#39;</span>,
<a name="l00907"></a>00907         error_msg_flag         =&gt;  1,
<a name="l00908"></a>00908      );
<a name="l00909"></a>00909 <span class="preprocessor">    # initialize</span>
<a name="l00910"></a>00910 <span class="preprocessor"></span>    $rh_ans-&gt;{_filter_name} = <span class="stringliteral">&#39;calculate_difference_vector&#39;</span>;
<a name="l00911"></a>00911     my $rf_fun              = $rh_ans -&gt; {$options{stdin1}};        # rf_student_ans by <span class="keywordflow">default</span>
<a name="l00912"></a>00912     my $rf_correct_fun      = $rh_ans -&gt; {$options{stdin2}};        # rf_correct_ans by <span class="keywordflow">default</span>
<a name="l00913"></a>00913     my $ra_parameters       = $rh_ans -&gt; {ra_parameters};
<a name="l00914"></a>00914     my @evaluation_points   = @{$rh_ans-&gt;{evaluation_points} };
<a name="l00915"></a>00915     my @parameters          = ();
<a name="l00916"></a>00916     @parameters             = @$ra_parameters <span class="keywordflow">if</span> defined($ra_parameters) and ref($ra_parameters) eq &#39;ARRAY&#39;;
<a name="l00917"></a>00917     my $errors              = undef;
<a name="l00918"></a>00918     my @zero_params         = ();
<a name="l00919"></a>00919     for (my $i=1;$i&lt;=@{$ra_parameters};$i++) { 
<a name="l00920"></a>00920         push(@zero_params,0); 
<a name="l00921"></a>00921     }
<a name="l00922"></a>00922     my @differences         = ();
<a name="l00923"></a>00923     my @student_values;
<a name="l00924"></a>00924     my @adjusted_student_values;
<a name="l00925"></a>00925     my @instructorVals;
<a name="l00926"></a>00926     my ($diff,$instructorVal);
<a name="l00927"></a>00927 <span class="preprocessor">    # calculate the vector of differences between the test function and the comparison function.</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span>    <span class="keywordflow">while</span> (@evaluation_points) {
<a name="l00929"></a>00929         my ($err1, $err2,$err3);
<a name="l00930"></a>00930         my @vars = @{ shift(@evaluation_points) };
<a name="l00931"></a>00931         my @inputs = (@vars, @parameters);
<a name="l00932"></a>00932         my ($inVal,  $correctVal);
<a name="l00933"></a>00933         ($inVal, $err1) = &amp;{$rf_fun}(@vars);
<a name="l00934"></a>00934         $errors .= <span class="stringliteral">&quot; $err1 &quot;</span>  <span class="keywordflow">if</span> defined($err1);
<a name="l00935"></a>00935         $errors .= <span class="stringliteral">&quot; Error detected evaluating student input at (&quot;</span>.join(<span class="stringliteral">&#39; , &#39;</span>,@vars) .<span class="stringliteral">&quot; ) &quot;</span> <span class="keywordflow">if</span>  defined($options{debug}) and $options{debug}==1 and defined($err1);
<a name="l00936"></a>00936         ($correctVal, $err2) =&amp;{$rf_correct_fun}(@inputs);
<a name="l00937"></a>00937         $errors .= <span class="stringliteral">&quot; There is an error in WeBWorK&#39;s answer to this problem, please alert your instructor.&lt;br&gt; $err2 &quot;</span> <span class="keywordflow">if</span> defined($err2);
<a name="l00938"></a>00938         $errors .= <span class="stringliteral">&quot; Error detected evaluating correct adapted answer  at (&quot;</span>.join(<span class="stringliteral">&#39; , &#39;</span>,@inputs) .<span class="stringliteral">&quot; ) &quot;</span> <span class="keywordflow">if</span> defined($options{debug}) and $options{debug}=1 and defined($err2);
<a name="l00939"></a>00939         ($instructorVal,$err3)= &amp;$rf_correct_fun(@vars, @zero_params);
<a name="l00940"></a>00940         $errors .= <span class="stringliteral">&quot; There is an error in WeBWorK&#39;s answer to this problem, please alert your instructor.&lt;br&gt; $err3 &quot;</span> <span class="keywordflow">if</span> defined($err3);
<a name="l00941"></a>00941         $errors .= <span class="stringliteral">&quot; Error detected evaluating instructor answer  at (&quot;</span>.join(<span class="stringliteral">&#39; , &#39;</span>,@vars, @zero_params) .<span class="stringliteral">&quot; ) &quot;</span> <span class="keywordflow">if</span> defined($options{debug}) and $options{debug}=1 and defined($err3);
<a name="l00942"></a>00942         unless (defined($err1) or defined($err2) or defined($err3) ) {
<a name="l00943"></a>00943             $diff = ( $inVal - ($correctVal -$instructorVal ) ) - $instructorVal;  #prevents entering too high a number?
<a name="l00944"></a>00944 <span class="preprocessor">            #warn &quot;taking the difference of &quot;, $inVal, &quot; and &quot;, $correctVal, &quot; is &quot;, $diff;</span>
<a name="l00945"></a>00945 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $options{tolType} eq <span class="stringliteral">&#39;relative&#39;</span> ) {  #relative tolerance
<a name="l00946"></a>00946 <span class="preprocessor">                #warn &quot;diff = $diff&quot;;</span>
<a name="l00947"></a>00947 <span class="preprocessor"></span><span class="preprocessor">                #$diff = ( $inVal - ($correctVal-$instructorVal ) )/abs($instructorVal) -1    if abs($instructorVal) &gt; $options{zeroLevel};</span>
<a name="l00948"></a>00948 <span class="preprocessor"></span>                $diff = ( $inVal - ($correctVal-$instructorVal ) )/$instructorVal -1    <span class="keywordflow">if</span> abs($instructorVal) &gt; $options{zeroLevel};
<a name="l00949"></a>00949 <span class="preprocessor">#  DPVC -- adjust so that a check for tolerance will</span>
<a name="l00950"></a>00950 <span class="preprocessor"></span><span class="preprocessor">#          do a zeroLevelTol check</span>
<a name="l00951"></a>00951 <span class="preprocessor"></span><span class="preprocessor">## $diff *= $options{tolerance}/$options{zeroLevelTol} unless abs($instructorVal) &gt; $options{zeroLevel};</span>
<a name="l00952"></a>00952 <span class="preprocessor"></span><span class="preprocessor"># /DPVC</span>
<a name="l00953"></a>00953 <span class="preprocessor"></span><span class="preprocessor">                #$diff = ( $inVal - ($correctVal-$instructorVal- $instructorVal ) )/abs($instructorVal)    if abs($instructorVal) &gt; $options{zeroLevel};</span>
<a name="l00954"></a>00954 <span class="preprocessor"></span><span class="preprocessor">                #warn &quot;diff = $diff,   &quot;, abs( &amp;$rf_correct_fun(@inputs) ) , &quot;-- $correctVal&quot;;</span>
<a name="l00955"></a>00955 <span class="preprocessor"></span>            }
<a name="l00956"></a>00956         }
<a name="l00957"></a>00957         last <span class="keywordflow">if</span> $errors;  # <span class="keywordflow">break</span> <span class="keywordflow">if</span> there are any errors.
<a name="l00958"></a>00958                   # This cuts down on the size of error messages.
<a name="l00959"></a>00959                   # However it impossible to check <span class="keywordflow">for</span> equivalence at 95% of points
<a name="l00960"></a>00960 <span class="preprocessor">                  # which might be useful for functions that are not defined at some points.</span>
<a name="l00961"></a>00961 <span class="preprocessor"></span>        push(@student_values,$inVal);
<a name="l00962"></a>00962         push(@adjusted_student_values,(  $inVal - ($correctVal -$instructorVal) ) );
<a name="l00963"></a>00963         push(@differences, $diff);
<a name="l00964"></a>00964         push(@instructorVals,$instructorVal);
<a name="l00965"></a>00965     }
<a name="l00966"></a>00966     <span class="keywordflow">if</span> (( not defined($errors) )  or $errors eq <span class="stringliteral">&#39;&#39;</span> or $options{error_msg_flag} ) {
<a name="l00967"></a>00967         $rh_ans -&gt;{$options{stdout}} = \@differences;
<a name="l00968"></a>00968         $rh_ans -&gt;{ra_student_values} = \@student_values;
<a name="l00969"></a>00969         $rh_ans -&gt;{ra_adjusted_student_values} = \@adjusted_student_values;
<a name="l00970"></a>00970         $rh_ans-&gt;{ra_instructor_values}=\@instructorVals;
<a name="l00971"></a>00971         $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;EVAL&#39;</span>, $errors) <span class="keywordflow">if</span> defined($errors);
<a name="l00972"></a>00972     } <span class="keywordflow">else</span> { 
<a name="l00973"></a>00973          
<a name="l00974"></a>00974     }      # no output <span class="keywordflow">if</span> error_msg_flag is <span class="keyword">set</span> to 0.
<a name="l00975"></a>00975     
<a name="l00976"></a>00976     $rh_ans;
<a name="l00977"></a>00977 }
<a name="l00978"></a>00978 
<a name="l00979"></a>00979 =head4 fix_answer_for_display
<a name="l00980"></a>00980 
<a name="l00981"></a>00981 =cut
<a name="l00982"></a>00982 
<a name="l00983"></a>00983 <span class="preprocessor"># ^function fix_answers_for_display</span>
<a name="l00984"></a>00984 <span class="preprocessor"></span><span class="preprocessor"># ^uses evaluatesToNumber</span>
<a name="l00985"></a>00985 <span class="preprocessor"></span><span class="preprocessor"># ^uses AnswerHash::new</span>
<a name="l00986"></a>00986 <span class="preprocessor"></span><span class="preprocessor"># ^uses check_syntax</span>
<a name="l00987"></a>00987 <span class="preprocessor"></span>sub fix_answers_for_display {
<a name="l00988"></a>00988     my ($rh_ans, %options) = @_;
<a name="l00989"></a>00989     <span class="keywordflow">if</span> ( $rh_ans-&gt;{answerIsString} ==1) {
<a name="l00990"></a>00990         $rh_ans = evaluatesToNumber ($rh_ans, %options);
<a name="l00991"></a>00991     }
<a name="l00992"></a>00992     <span class="keywordflow">if</span> (defined ($rh_ans-&gt;{student_units})) {
<a name="l00993"></a>00993         $rh_ans-&gt;{student_ans} = $rh_ans-&gt;{student_ans}. <span class="charliteral">&#39; &#39;</span>. $rh_ans-&gt;{student_units};
<a name="l00994"></a>00994         
<a name="l00995"></a>00995     }
<a name="l00996"></a>00996     <span class="keywordflow">if</span> ( $rh_ans-&gt;catch_error(<span class="stringliteral">&#39;UNITS&#39;</span>)  ) {  # create preview latex <span class="keywordtype">string</span> <span class="keywordflow">for</span> expressions even <span class="keywordflow">if</span> the units are incorrect
<a name="l00997"></a>00997             my $rh_temp = <span class="keyword">new</span> <a class="code" href="classAnswerHash.html">AnswerHash</a>;
<a name="l00998"></a>00998             $rh_temp-&gt;{student_ans} = $rh_ans-&gt;{student_ans};
<a name="l00999"></a>00999             $rh_temp = check_syntax($rh_temp);
<a name="l01000"></a>01000             $rh_ans-&gt;{preview_latex_string} = $rh_temp-&gt;{preview_latex_string};
<a name="l01001"></a>01001     }
<a name="l01002"></a>01002     $rh_ans-&gt;{correct_ans} = $rh_ans-&gt;{original_correct_ans};
<a name="l01003"></a>01003 
<a name="l01004"></a>01004     $rh_ans;
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007 =head4 evaluatesToNumber
<a name="l01008"></a>01008 
<a name="l01009"></a>01009 =cut
<a name="l01010"></a>01010 
<a name="l01011"></a>01011 <span class="preprocessor"># ^function evaluatesToNumber</span>
<a name="l01012"></a>01012 <span class="preprocessor"></span><span class="preprocessor"># ^uses is_a_numeric_expression</span>
<a name="l01013"></a>01013 <span class="preprocessor"></span><span class="preprocessor"># ^uses PG_answer_eval</span>
<a name="l01014"></a>01014 <span class="preprocessor"></span><span class="preprocessor"># ^uses prfmt</span>
<a name="l01015"></a>01015 <span class="preprocessor"></span>sub evaluatesToNumber {
<a name="l01016"></a>01016     my ($rh_ans, %options) = @_;
<a name="l01017"></a>01017     <span class="keywordflow">if</span> (is_a_numeric_expression($rh_ans-&gt;{student_ans})) {
<a name="l01018"></a>01018         my ($inVal,$PG_eval_errors,$PG_full_error_report) = PG_answer_eval($rh_ans-&gt;{student_ans});
<a name="l01019"></a>01019         <span class="keywordflow">if</span> ($PG_eval_errors) { # <span class="keyword">this</span> <span class="keywordflow">if</span> statement should never be run
<a name="l01020"></a>01020 <span class="preprocessor">            # change nothing</span>
<a name="l01021"></a>01021 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<a name="l01022"></a>01022 <span class="preprocessor">            # change this</span>
<a name="l01023"></a>01023 <span class="preprocessor"></span>            $rh_ans-&gt;{student_ans} = prfmt($inVal,$options{format});
<a name="l01024"></a>01024         }
<a name="l01025"></a>01025     }
<a name="l01026"></a>01026     $rh_ans;
<a name="l01027"></a>01027 }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029 =head4 is_numeric_expression
<a name="l01030"></a>01030 
<a name="l01031"></a>01031 =cut
<a name="l01032"></a>01032 
<a name="l01033"></a>01033 <span class="preprocessor"># ^function is_a_numeric_expression</span>
<a name="l01034"></a>01034 <span class="preprocessor"></span><span class="preprocessor"># ^uses PG_answer_eval</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span>sub is_a_numeric_expression {
<a name="l01036"></a>01036     my $testString = shift;
<a name="l01037"></a>01037     my $is_a_numeric_expression = 0;
<a name="l01038"></a>01038     my ($inVal,$PG_eval_errors,$PG_full_error_report) = PG_answer_eval($testString);
<a name="l01039"></a>01039     <span class="keywordflow">if</span> ($PG_eval_errors) {
<a name="l01040"></a>01040         $is_a_numeric_expression = 0;
<a name="l01041"></a>01041     } <span class="keywordflow">else</span> {
<a name="l01042"></a>01042         $is_a_numeric_expression = 1;
<a name="l01043"></a>01043     }
<a name="l01044"></a>01044     $is_a_numeric_expression;
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 
<a name="l01047"></a>01047 =head4 is_a_number
<a name="l01048"></a>01048 
<a name="l01049"></a>01049 =cut
<a name="l01050"></a>01050 
<a name="l01051"></a>01051 <span class="preprocessor"># ^function is_a_number</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span>sub is_a_number {
<a name="l01053"></a>01053     my ($num,%options) =    @_;
<a name="l01054"></a>01054     my $process_ans_hash = ( ref( $num ) eq &#39;<a class="code" href="classAnswerHash.html">AnswerHash</a>&#39; ) ? 1 : 0 ;
<a name="l01055"></a>01055     my ($rh_ans);
<a name="l01056"></a>01056     if ($process_ans_hash) {
<a name="l01057"></a>01057         $rh_ans = $num;
<a name="l01058"></a>01058         $num = $rh_ans-&gt;{student_ans};
<a name="l01059"></a>01059     }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061     my $is_a_number = 0;
<a name="l01062"></a>01062     <span class="keywordflow">return</span> $is_a_number unless defined($num);
<a name="l01063"></a>01063     $num =~ s/^\s*<span class="comment">//; ## remove initial spaces</span>
<a name="l01064"></a>01064     $num =~ s/\s*$<span class="comment">//; ## remove trailing spaces</span>
<a name="l01065"></a>01065 
<a name="l01066"></a>01066 <span class="preprocessor">    ## the following is copied from the online perl manual</span>
<a name="l01067"></a>01067 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($num =~ /^([+-]?)(?=\d|\.\d)\d*(\.\d*)?([Ee]([+-]?\d+))?$/){
<a name="l01068"></a>01068         $is_a_number = 1;
<a name="l01069"></a>01069     }
<a name="l01070"></a>01070 
<a name="l01071"></a>01071     <span class="keywordflow">if</span> ($process_ans_hash)   {
<a name="l01072"></a>01072             <span class="keywordflow">if</span> ($is_a_number == 1 ) {
<a name="l01073"></a>01073                 $rh_ans-&gt;{student_ans}=$num;
<a name="l01074"></a>01074                 <span class="keywordflow">return</span> $rh_ans;
<a name="l01075"></a>01075             } <span class="keywordflow">else</span> {
<a name="l01076"></a>01076                 $rh_ans-&gt;{student_ans} = <span class="stringliteral">&quot;Incorrect number format:  You must enter a number, e.g. -6, 5.3, or 6.12E-3&quot;</span>;
<a name="l01077"></a>01077                 $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;NUMBER&#39;</span>, <span class="stringliteral">&#39;You must enter a number, e.g. -6, 5.3, or 6.12E-3&#39;</span>);
<a name="l01078"></a>01078                 <span class="keywordflow">return</span> $rh_ans;
<a name="l01079"></a>01079             }
<a name="l01080"></a>01080     } <span class="keywordflow">else</span> {
<a name="l01081"></a>01081         <span class="keywordflow">return</span> $is_a_number;
<a name="l01082"></a>01082     }
<a name="l01083"></a>01083 }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085 =head4 is_a_fraction
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 =cut
<a name="l01088"></a>01088 
<a name="l01089"></a>01089 <span class="preprocessor"># ^function is_a_fraction</span>
<a name="l01090"></a>01090 <span class="preprocessor"></span>sub is_a_fraction {
<a name="l01091"></a>01091     my ($num,%options) =    @_;
<a name="l01092"></a>01092     my $process_ans_hash = ( ref( $num ) eq &#39;<a class="code" href="classAnswerHash.html">AnswerHash</a>&#39; ) ? 1 : 0 ;
<a name="l01093"></a>01093     my ($rh_ans);
<a name="l01094"></a>01094     if ($process_ans_hash) {
<a name="l01095"></a>01095         $rh_ans = $num;
<a name="l01096"></a>01096         $num = $rh_ans-&gt;{student_ans};
<a name="l01097"></a>01097     }
<a name="l01098"></a>01098 
<a name="l01099"></a>01099     my $is_a_fraction = 0;
<a name="l01100"></a>01100     <span class="keywordflow">return</span> $is_a_fraction unless defined($num);
<a name="l01101"></a>01101     $num =~ s/^\s*<span class="comment">//; ## remove initial spaces</span>
<a name="l01102"></a>01102     $num =~ s/\s*$<span class="comment">//; ## remove trailing spaces</span>
<a name="l01103"></a>01103 
<a name="l01104"></a>01104     <span class="keywordflow">if</span> ($num =~ /^\s*\-?\s*[\/\d\.Ee\s]*$/) {
<a name="l01105"></a>01105         $is_a_fraction = 1;
<a name="l01106"></a>01106     }
<a name="l01107"></a>01107 
<a name="l01108"></a>01108     <span class="keywordflow">if</span> ($process_ans_hash)   {
<a name="l01109"></a>01109         <span class="keywordflow">if</span> ($is_a_fraction == 1 ) {
<a name="l01110"></a>01110             $rh_ans-&gt;{student_ans}=$num;
<a name="l01111"></a>01111             <span class="keywordflow">return</span> $rh_ans;
<a name="l01112"></a>01112         } <span class="keywordflow">else</span> {
<a name="l01113"></a>01113             $rh_ans-&gt;{student_ans} = <span class="stringliteral">&quot;Not a number of fraction: You must enter a number or fraction, e.g. -6 or 7/13&quot;</span>;
<a name="l01114"></a>01114             $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;NUMBER&#39;</span>, <span class="stringliteral">&#39;You must enter a number, e.g. -6, 5.3, or 6.12E-3&#39;</span>);
<a name="l01115"></a>01115             <span class="keywordflow">return</span> $rh_ans;
<a name="l01116"></a>01116         }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118         } <span class="keywordflow">else</span> {
<a name="l01119"></a>01119         <span class="keywordflow">return</span> $is_a_fraction;
<a name="l01120"></a>01120     }
<a name="l01121"></a>01121 }
<a name="l01122"></a>01122 
<a name="l01123"></a>01123 =head4 phase_pi
<a name="l01124"></a>01124     I often discovered that the answers I was getting, when <span class="keyword">using</span> the arctan function would be off by phases of
<a name="l01125"></a>01125     pi, which <span class="keywordflow">for</span> the tangent function, were equivalent values. This method allows <span class="keywordflow">for</span> this.
<a name="l01126"></a>01126 =cut
<a name="l01127"></a>01127 
<a name="l01128"></a>01128 <span class="preprocessor"># ^function phase_pi</span>
<a name="l01129"></a>01129 <span class="preprocessor"></span>sub phase_pi {
<a name="l01130"></a>01130     my ($num,%options) =    @_;
<a name="l01131"></a>01131     my $process_ans_hash = ( ref( $num ) eq &#39;<a class="code" href="classAnswerHash.html">AnswerHash</a>&#39; ) ? 1 : 0 ;
<a name="l01132"></a>01132     my ($rh_ans);
<a name="l01133"></a>01133     if ($process_ans_hash) {
<a name="l01134"></a>01134         $rh_ans = $num;
<a name="l01135"></a>01135         $num = $rh_ans-&gt;{correct_ans};
<a name="l01136"></a>01136     }
<a name="l01137"></a>01137     <span class="keywordflow">while</span>( ($rh_ans-&gt;{correct_ans}) &gt;  3.14159265358979/2 ){
<a name="l01138"></a>01138         $rh_ans-&gt;{correct_ans} -= 3.14159265358979;
<a name="l01139"></a>01139     }
<a name="l01140"></a>01140     <span class="keywordflow">while</span>( ($rh_ans-&gt;{correct_ans}) &lt;= -3.14159265358979/2 ){
<a name="l01141"></a>01141         $rh_ans-&gt;{correct_ans} += 3.14159265358979;
<a name="l01142"></a>01142     }
<a name="l01143"></a>01143     $rh_ans;
<a name="l01144"></a>01144 }
<a name="l01145"></a>01145 
<a name="l01146"></a>01146 =head4 is_an_arithemetic_expression
<a name="l01147"></a>01147 
<a name="l01148"></a>01148 =cut
<a name="l01149"></a>01149 
<a name="l01150"></a>01150 <span class="preprocessor"># ^function is_an_arithmetic_expression</span>
<a name="l01151"></a>01151 <span class="preprocessor"></span>sub is_an_arithmetic_expression {
<a name="l01152"></a>01152     my ($num,%options) =    @_;
<a name="l01153"></a>01153     my $process_ans_hash = ( ref( $num ) eq &#39;<a class="code" href="classAnswerHash.html">AnswerHash</a>&#39; ) ? 1 : 0 ;
<a name="l01154"></a>01154     my ($rh_ans);
<a name="l01155"></a>01155     if ($process_ans_hash) {
<a name="l01156"></a>01156         $rh_ans = $num;
<a name="l01157"></a>01157         $num = $rh_ans-&gt;{student_ans};
<a name="l01158"></a>01158     }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160     my $is_an_arithmetic_expression = 0;
<a name="l01161"></a>01161     <span class="keywordflow">return</span> $is_an_arithmetic_expression unless defined($num);
<a name="l01162"></a>01162     $num =~ s/^\s*<span class="comment">//; ## remove initial spaces</span>
<a name="l01163"></a>01163     $num =~ s/\s*$<span class="comment">//; ## remove trailing spaces</span>
<a name="l01164"></a>01164 
<a name="l01165"></a>01165     <span class="keywordflow">if</span> ($num =~ /^[+\-*\/\^\(\)\[\]\{\}\s\d\.Ee]*$/) {
<a name="l01166"></a>01166         $is_an_arithmetic_expression =  1;
<a name="l01167"></a>01167     }
<a name="l01168"></a>01168 
<a name="l01169"></a>01169     <span class="keywordflow">if</span> ($process_ans_hash)   {
<a name="l01170"></a>01170         <span class="keywordflow">if</span> ($is_an_arithmetic_expression == 1 ) {
<a name="l01171"></a>01171             $rh_ans-&gt;{student_ans}=$num;
<a name="l01172"></a>01172             <span class="keywordflow">return</span> $rh_ans;
<a name="l01173"></a>01173         } <span class="keywordflow">else</span> {
<a name="l01174"></a>01174 
<a name="l01175"></a>01175         $rh_ans-&gt;{student_ans} = <span class="stringliteral">&quot;Not an arithmetic expression: You must enter an arithmetic expression, e.g. -6 or (2.3*4+5/3)^2&quot;</span>;
<a name="l01176"></a>01176             $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;NUMBER&#39;</span>, <span class="stringliteral">&#39;You must enter an arithmetic expression, e.g. -6 or (2.3*4+5/3)^2&#39;</span>);
<a name="l01177"></a>01177             <span class="keywordflow">return</span> $rh_ans;
<a name="l01178"></a>01178         }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180         } <span class="keywordflow">else</span> {
<a name="l01181"></a>01181         <span class="keywordflow">return</span> $is_an_arithmetic_expression;
<a name="l01182"></a>01182     }
<a name="l01183"></a>01183 }
<a name="l01184"></a>01184 
<a name="l01185"></a>01185 <span class="preprocessor">#</span>
<a name="l01186"></a>01186 <span class="preprocessor"></span>
<a name="l01187"></a>01187 =head4 math_constants
<a name="l01188"></a>01188 
<a name="l01189"></a>01189 replaces pi, e, and ^ with their Perl equivalents
<a name="l01190"></a>01190 <span class="keywordflow">if</span> useBaseTenLog is non-zero, convert log to logten
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 =cut
<a name="l01193"></a>01193 
<a name="l01194"></a>01194 <span class="preprocessor"># ^function math_constants</span>
<a name="l01195"></a>01195 <span class="preprocessor"></span>sub math_constants {
<a name="l01196"></a>01196     my($in,%options) = @_;
<a name="l01197"></a>01197     my $rh_ans;
<a name="l01198"></a>01198     my $process_ans_hash = ( ref( $in ) eq &#39;<a class="code" href="classAnswerHash.html">AnswerHash</a>&#39; ) ? 1 : 0 ;
<a name="l01199"></a>01199     if ($process_ans_hash) {
<a name="l01200"></a>01200         $rh_ans = $in;
<a name="l01201"></a>01201         $in = $rh_ans-&gt;{student_ans};
<a name="l01202"></a>01202     }
<a name="l01203"></a>01203 <span class="preprocessor">    # The code fragment above allows this filter to be used when the input is simply a string</span>
<a name="l01204"></a>01204 <span class="preprocessor"></span><span class="preprocessor">    # as well as when the input is an AnswerHash, and options.</span>
<a name="l01205"></a>01205 <span class="preprocessor"></span>    $in =~s/\bpi\b/(4*atan2(1,1))/ge;
<a name="l01206"></a>01206     $in =~s/\be\b/(exp(1))/ge;
<a name="l01207"></a>01207     $in =~s/\^g;
<a name="l01208"></a>01208     <span class="keywordflow">if</span>($useBaseTenLog) {
<a name="l01209"></a>01209         $in =~ s/\blog\b/logten/g;
<a name="l01210"></a>01210     }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212     <span class="keywordflow">if</span> ($process_ans_hash)   {
<a name="l01213"></a>01213         $rh_ans-&gt;{student_ans}=$in;
<a name="l01214"></a>01214         <span class="keywordflow">return</span> $rh_ans;
<a name="l01215"></a>01215     } <span class="keywordflow">else</span> {
<a name="l01216"></a>01216         <span class="keywordflow">return</span> $in;
<a name="l01217"></a>01217     }
<a name="l01218"></a>01218 }
<a name="l01219"></a>01219 
<a name="l01220"></a>01220 
<a name="l01221"></a>01221 
<a name="l01222"></a>01222 =head4 is_array
<a name="l01223"></a>01223 
<a name="l01224"></a>01224     is_array($rh_ans)
<a name="l01225"></a>01225         returns: $rh_ans.   Throws error &quot;NOTARRAY&quot; if this is not an array
<a name="l01226"></a>01226 
<a name="l01227"></a>01227 =cut
<a name="l01228"></a>01228 
<a name="l01229"></a>01229 <span class="preprocessor"># ^function is_array</span>
<a name="l01230"></a>01230 <span class="preprocessor"></span>sub is_array    {
<a name="l01231"></a>01231     my $rh_ans = shift;
<a name="l01232"></a>01232 <span class="preprocessor">    # return if the result is an array</span>
<a name="l01233"></a>01233 <span class="preprocessor"></span>    <span class="keywordflow">return</span>($rh_ans) <span class="keywordflow">if</span>  ref($rh_ans-&gt;{student_ans}) eq <span class="stringliteral">&#39;ARRAY&#39;</span> ;
<a name="l01234"></a>01234     $rh_ans-&gt;throw_error(<span class="stringliteral">&quot;NOTARRAY&quot;</span>,<span class="stringliteral">&quot;The answer is not an array&quot;</span>);
<a name="l01235"></a>01235     $rh_ans;
<a name="l01236"></a>01236 }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238 =head4 check_syntax
<a name="l01239"></a>01239 
<a name="l01240"></a>01240     check_syntax( $rh_ans, %options)
<a name="l01241"></a>01241         returns an answer hash.
<a name="l01242"></a>01242 
<a name="l01243"></a>01243 latex2html preview code are installed in the answer hash.
<a name="l01244"></a>01244 The input has been transformed, changing 7pi to 7*pi  or 7x to 7*x.
<a name="l01245"></a>01245 Syntax error messages may be generated and stored in student_ans
<a name="l01246"></a>01246 Additional syntax error messages are stored in {ans_message} and duplicated in {error_message}
<a name="l01247"></a>01247 
<a name="l01248"></a>01248 
<a name="l01249"></a>01249 =cut
<a name="l01250"></a>01250 
<a name="l01251"></a>01251 <span class="preprocessor"># ^function check_syntax</span>
<a name="l01252"></a>01252 <span class="preprocessor"></span><span class="preprocessor"># ^uses assign_option_aliases</span>
<a name="l01253"></a>01253 <span class="preprocessor"></span><span class="preprocessor"># ^uses set_default_options</span>
<a name="l01254"></a>01254 <span class="preprocessor"></span><span class="preprocessor"># ^uses AlgParserWithImplicitExpand::new</span>
<a name="l01255"></a>01255 <span class="preprocessor"></span>sub check_syntax {
<a name="l01256"></a>01256         my $rh_ans = shift;
<a name="l01257"></a>01257         my %options = @_;
<a name="l01258"></a>01258         assign_option_aliases(\%options,
<a name="l01259"></a>01259         );
<a name="l01260"></a>01260         set_default_options(  \%options,
<a name="l01261"></a>01261                     <span class="stringliteral">&#39;stdin&#39;</span>         =&gt;  <span class="stringliteral">&#39;student_ans&#39;</span>,
<a name="l01262"></a>01262                     <span class="stringliteral">&#39;stdout&#39;</span>        =&gt;  <span class="stringliteral">&#39;student_ans&#39;</span>,
<a name="l01263"></a>01263                     <span class="stringliteral">&#39;ra_vars&#39;</span>       =&gt;  [qw( x y )],
<a name="l01264"></a>01264                     <span class="stringliteral">&#39;debug&#39;</span>         =&gt;  0,
<a name="l01265"></a>01265                     <span class="stringliteral">&#39;_filter_name&#39;</span>  =&gt;  <span class="stringliteral">&#39;check_syntax&#39;</span>,
<a name="l01266"></a>01266                     error_msg_flag  =&gt;  1,
<a name="l01267"></a>01267         );
<a name="l01268"></a>01268 <span class="preprocessor">        #initialize</span>
<a name="l01269"></a>01269 <span class="preprocessor"></span>        $rh_ans-&gt;{_filter_name}     = $options{_filter_name};
<a name="l01270"></a>01270         unless ( defined( $rh_ans-&gt;{$options{stdin}} ) ) {
<a name="l01271"></a>01271             warn <span class="stringliteral">&quot;Check_syntax requires an equation in the field &#39;$options{stdin}&#39; or input&quot;</span>;
<a name="l01272"></a>01272             $rh_ans-&gt;throw_error(<span class="stringliteral">&quot;1&quot;</span>,<span class="stringliteral">&quot;&#39;$options{stdin}&#39; field not defined&quot;</span>);
<a name="l01273"></a>01273             <span class="keywordflow">return</span> $rh_ans;
<a name="l01274"></a>01274         }
<a name="l01275"></a>01275         my $in     = $rh_ans-&gt;{$options{stdin}};
<a name="l01276"></a>01276         my $parser = <span class="keyword">new</span> <a class="code" href="classAlgParserWithImplicitExpand.html">AlgParserWithImplicitExpand</a>;
<a name="l01277"></a>01277         my $ret    = $parser -&gt; parse($in);         #<span class="keywordflow">for</span> use with loops
<a name="l01278"></a>01278 
<a name="l01279"></a>01279         <span class="keywordflow">if</span> ( ref($ret) )  {     ## parsed successfully
<a name="l01280"></a>01280 <span class="preprocessor">            # $parser -&gt; tostring();   # FIXME?  was this needed for some reason?????</span>
<a name="l01281"></a>01281 <span class="preprocessor"></span>            $parser -&gt; normalize();
<a name="l01282"></a>01282             $rh_ans -&gt; {$options{stdout}}     = $parser -&gt; tostring();
<a name="l01283"></a>01283             $rh_ans -&gt; {preview_text_string}  = $in;
<a name="l01284"></a>01284             $rh_ans -&gt; {preview_latex_string} = $parser -&gt; tolatex();
<a name="l01285"></a>01285 
<a name="l01286"></a>01286         } elsif ($options{error_msg_flag} ) {                   ## error in parsing
<a name="l01287"></a>01287 
<a name="l01288"></a>01288             $rh_ans-&gt;{$options{stdout}}         =   <span class="stringliteral">&#39;syntax error:&#39;</span>. $parser-&gt;{htmlerror},
<a name="l01289"></a>01289             $rh_ans-&gt;{<span class="stringliteral">&#39;ans_message&#39;</span>}            =   $parser -&gt; {error_msg},
<a name="l01290"></a>01290             $rh_ans-&gt;{<span class="stringliteral">&#39;preview_text_string&#39;</span>}    =   <span class="stringliteral">&#39;&#39;</span>,
<a name="l01291"></a>01291             $rh_ans-&gt;{<span class="stringliteral">&#39;preview_latex_string&#39;</span>}   =   <span class="stringliteral">&#39;&#39;</span>,
<a name="l01292"></a>01292             $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;SYNTAX&#39;</span>,  <span class="stringliteral">&#39;syntax error in answer:&#39;</span>. $parser-&gt;{htmlerror} . <span class="stringliteral">&quot;$BR&quot;</span> .$parser -&gt; {error_msg});
<a name="l01293"></a>01293         }   # no output is produced <span class="keywordflow">if</span> there is an error and the error_msg_flag is <span class="keyword">set</span> to zero
<a name="l01294"></a>01294        $rh_ans;
<a name="l01295"></a>01295 
<a name="l01296"></a>01296 }
<a name="l01297"></a>01297 
<a name="l01298"></a>01298 =head4 check_strings
<a name="l01299"></a>01299 
<a name="l01300"></a>01300     check_strings ($rh_ans, %options)
<a name="l01301"></a>01301         returns $rh_ans
<a name="l01302"></a>01302 
<a name="l01303"></a>01303 =cut
<a name="l01304"></a>01304 
<a name="l01305"></a>01305 <span class="preprocessor"># ^function check_strings</span>
<a name="l01306"></a>01306 <span class="preprocessor"></span><span class="preprocessor"># ^uses str_filters</span>
<a name="l01307"></a>01307 <span class="preprocessor"></span><span class="preprocessor"># ^uses str_cmp</span>
<a name="l01308"></a>01308 <span class="preprocessor"></span>sub check_strings {
<a name="l01309"></a>01309     my ($rh_ans, %options) = @_;
<a name="l01310"></a>01310 
<a name="l01311"></a>01311 <span class="preprocessor">    # if the student&#39;s answer is a number, simply return the answer hash (unchanged).</span>
<a name="l01312"></a>01312 <span class="preprocessor"></span>
<a name="l01313"></a>01313 <span class="preprocessor">    #  we allow constructions like -INF to be treated as a string. Thus we ignore an initial</span>
<a name="l01314"></a>01314 <span class="preprocessor"></span><span class="preprocessor">    # - in deciding whether the student&#39;s answer is a number or string</span>
<a name="l01315"></a>01315 <span class="preprocessor"></span>
<a name="l01316"></a>01316     my $temp_ans = $rh_ans-&gt;{student_ans};
<a name="l01317"></a>01317     $temp_ans =~ s/^\s*\-<span class="comment">//;   # remove an initial -</span>
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     <span class="keywordflow">if</span>  ( $temp_ans =~ m/[\d+\-*\/^(){}\[\]]|^\s*e\s*$|^\s*pi\s*$/)   {
<a name="l01320"></a>01320 <span class="preprocessor">    #   if ( $rh_ans-&gt;{answerIsString} == 1) {</span>
<a name="l01321"></a>01321 <span class="preprocessor"></span><span class="preprocessor">    #           #$rh_ans-&gt;throw_error(&#39;STRING&#39;,&#39;Incorrect Answer&#39;); # student&#39;s answer is a number</span>
<a name="l01322"></a>01322 <span class="preprocessor"></span><span class="preprocessor">    #   }</span>
<a name="l01323"></a>01323 <span class="preprocessor"></span>        <span class="keywordflow">return</span> $rh_ans;
<a name="l01324"></a>01324     }
<a name="l01325"></a>01325 <span class="preprocessor">    # the student&#39;s answer is recognized as a string</span>
<a name="l01326"></a>01326 <span class="preprocessor"></span>    my $ans = $rh_ans-&gt;{student_ans};
<a name="l01327"></a>01327 
<a name="l01328"></a>01328 <span class="preprocessor"># OVERVIEW of reminder of function:</span>
<a name="l01329"></a>01329 <span class="preprocessor"></span><span class="preprocessor"># if answer is correct, return correct.  (adjust score to 1)</span>
<a name="l01330"></a>01330 <span class="preprocessor"></span><span class="preprocessor"># if answer is incorect:</span>
<a name="l01331"></a>01331 <span class="preprocessor"></span><span class="preprocessor">#   1) determine if the answer is sensible.  if it is, return incorrect.</span>
<a name="l01332"></a>01332 <span class="preprocessor"></span><span class="preprocessor">#   2) if the answer is not sensible (and incorrect), then return an error message indicating so.</span>
<a name="l01333"></a>01333 <span class="preprocessor"></span><span class="preprocessor"># no matter what:  throw a &#39;STRING&#39; error to skip numerical evaluations.  (error flag skips remainder of pre_filters and evaluators)</span>
<a name="l01334"></a>01334 <span class="preprocessor"></span><span class="preprocessor"># last: &#39;STRING&#39; post_filter will clear the error (avoiding pink screen.)</span>
<a name="l01335"></a>01335 <span class="preprocessor"></span>
<a name="l01336"></a>01336     my $sensibleAnswer = 0;
<a name="l01337"></a>01337     $ans = str_filters( $ans, <span class="stringliteral">&#39;compress_whitespace&#39;</span> );  # <span class="keyword">remove</span> trailing, leading, and <span class="keywordtype">double</span> spaces.
<a name="l01338"></a>01338     my ($ans_eval) = <a class="code" href="PGstringevaluators_8pl.html#a477d668731862987bfa3c73819d50958">str_cmp</a>($rh_ans-&gt;{correct_ans});
<a name="l01339"></a>01339     my $temp_ans_hash = $ans_eval-&gt;evaluate($ans);
<a name="l01340"></a>01340     $rh_ans-&gt;{test} = $temp_ans_hash;
<a name="l01341"></a>01341     
<a name="l01342"></a>01342     <span class="keywordflow">if</span> ($temp_ans_hash-&gt;{score} ==1 ) {         # students answer matches the correct answer.
<a name="l01343"></a>01343         $rh_ans-&gt;{score} = 1;
<a name="l01344"></a>01344         $sensibleAnswer = 1;
<a name="l01345"></a>01345     } <span class="keywordflow">else</span> {                        # students answer does not match the correct answer.
<a name="l01346"></a>01346         my $legalString = <span class="stringliteral">&#39;&#39;</span>;               # find out <span class="keywordflow">if</span> <span class="keywordtype">string</span> makes sense
<a name="l01347"></a>01347         my @legalStrings = @{$options{strings}};
<a name="l01348"></a>01348         <span class="keywordflow">foreach</span> $legalString (@legalStrings) {
<a name="l01349"></a>01349             <span class="keywordflow">if</span> ( uc($ans) eq uc($legalString) ) {
<a name="l01350"></a>01350                 $sensibleAnswer = 1;
<a name="l01351"></a>01351                 last;
<a name="l01352"></a>01352                 }
<a name="l01353"></a>01353             }
<a name="l01354"></a>01354         $sensibleAnswer = 1 unless $ans =~ /\S/;  ## empty answers are sensible
<a name="l01355"></a>01355         $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;EVAL&#39;</span>, <span class="stringliteral">&quot;Your answer is not a recognized answer&quot;</span>) unless ($sensibleAnswer);
<a name="l01356"></a>01356 <span class="preprocessor">        # $temp_ans_hash -&gt; setKeys( &#39;ans_message&#39; =&gt; &#39;Your answer is not a recognized answer&#39; ) unless ($sensibleAnswer);</span>
<a name="l01357"></a>01357 <span class="preprocessor"></span><span class="preprocessor">        # $temp_ans_hash -&gt; setKeys( &#39;student_ans&#39; =&gt; uc($ans) );</span>
<a name="l01358"></a>01358 <span class="preprocessor"></span>    }
<a name="l01359"></a>01359     
<a name="l01360"></a>01360     $rh_ans-&gt;{student_ans} = $ans;
<a name="l01361"></a>01361     
<a name="l01362"></a>01362     <span class="keywordflow">if</span> ($sensibleAnswer) {
<a name="l01363"></a>01363         $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;STRING&#39;</span>, <span class="stringliteral">&quot;The student&#39;s answer $rh_ans-&gt;{student_ans} is interpreted as a string.&quot;</span>);
<a name="l01364"></a>01364     }
<a name="l01365"></a>01365     
<a name="l01366"></a>01366     $rh_ans-&gt;{<span class="stringliteral">&#39;preview_text_string&#39;</span>}    =   $ans,
<a name="l01367"></a>01367     $rh_ans-&gt;{<span class="stringliteral">&#39;preview_latex_string&#39;</span>}   =   $ans,
<a name="l01368"></a>01368 
<a name="l01369"></a>01369 <span class="preprocessor">    # warn (&quot;\$rh_ans-&gt;{answerIsString} = $rh_ans-&gt;{answerIsString}&quot;);</span>
<a name="l01370"></a>01370 <span class="preprocessor"></span>    $rh_ans;
<a name="l01371"></a>01371 }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373 =head4 check_units
<a name="l01374"></a>01374 
<a name="l01375"></a>01375     check_strings ($rh_ans, %options)
<a name="l01376"></a>01376         returns $rh_ans
<a name="l01377"></a>01377 
<a name="l01378"></a>01378 
<a name="l01379"></a>01379 =cut
<a name="l01380"></a>01380 
<a name="l01381"></a>01381 <span class="preprocessor"># ^function check_units</span>
<a name="l01382"></a>01382 <span class="preprocessor"></span><span class="preprocessor"># ^uses str_filters</span>
<a name="l01383"></a>01383 <span class="preprocessor"></span><span class="preprocessor"># ^uses Units::evaluate_units</span>
<a name="l01384"></a>01384 <span class="preprocessor"></span><span class="preprocessor"># ^uses clean_up_error_msg</span>
<a name="l01385"></a>01385 <span class="preprocessor"></span><span class="preprocessor"># ^uses prfmt</span>
<a name="l01386"></a>01386 <span class="preprocessor"></span>sub check_units {
<a name="l01387"></a>01387     my ($rh_ans, %options) = @_;
<a name="l01388"></a>01388     my %correct_units = %{$rh_ans-&gt; {rh_correct_units}};
<a name="l01389"></a>01389     my $ans = $rh_ans-&gt;{student_ans};
<a name="l01390"></a>01390 <span class="preprocessor">    # $ans = &#39;&#39; unless defined ($ans);</span>
<a name="l01391"></a>01391 <span class="preprocessor"></span>    $ans = str_filters ($ans, <span class="stringliteral">&#39;trim_whitespace&#39;</span>);
<a name="l01392"></a>01392     my $original_student_ans = $ans;
<a name="l01393"></a>01393     $rh_ans-&gt;{original_student_ans} = $original_student_ans;
<a name="l01394"></a>01394 
<a name="l01395"></a>01395 <span class="preprocessor">    # it surprises me that the match below works since the first .* is greedy.</span>
<a name="l01396"></a>01396 <span class="preprocessor"></span>    my ($num_answer, $units) = $ans =~ /^(.*)\s+([^\s]*)$/;
<a name="l01397"></a>01397 
<a name="l01398"></a>01398     unless ( defined($num_answer) &amp;&amp; $units ) {
<a name="l01399"></a>01399 <span class="preprocessor">        # there is an error reading the input</span>
<a name="l01400"></a>01400 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $ans =~ /\S/ )  {  # the answer is not blank
<a name="l01401"></a>01401             $rh_ans -&gt; setKeys( <span class="stringliteral">&#39;ans_message&#39;</span> =&gt; <span class="stringliteral">&quot;The answer \&quot;$ans\&quot; could not be interpreted &quot;</span> .
<a name="l01402"></a>01402                 <span class="stringliteral">&quot;as a number or an arithmetic expression followed by a unit specification. &quot;</span> .
<a name="l01403"></a>01403                 <span class="stringliteral">&quot;Your answer must contain units.&quot;</span> );
<a name="l01404"></a>01404             $rh_ans-&gt;throw_error(<span class="stringliteral">&#39;UNITS&#39;</span>, <span class="stringliteral">&quot;The answer \&quot;$ans\&quot; could not be interpreted &quot;</span> .
<a name="l01405"></a>01405                 <span class="stringliteral">&quot;as a number or an arithmetic expression followed by a unit specification. &quot;</span> .
<a name="l01406"></a>01406                 <span class="stringliteral">&quot;Your answer must contain units.&quot;</span> );
<a name="l01407"></a>01407         }
<a name="l01408"></a>01408         <span class="keywordflow">return</span> $rh_ans;
<a name="l01409"></a>01409     }
<a name="l01410"></a>01410 
<a name="l01411"></a>01411 <span class="preprocessor">    # we have been able to parse the answer into a numerical part and a unit part</span>
<a name="l01412"></a>01412 <span class="preprocessor"></span>
<a name="l01413"></a>01413 <span class="preprocessor">    # $num_answer   = $1;       #$1 and $2 from the regular expression above</span>
<a name="l01414"></a>01414 <span class="preprocessor"></span><span class="preprocessor">    # $units        = $2;</span>
<a name="l01415"></a>01415 <span class="preprocessor"></span>
<a name="l01416"></a>01416     my %units = <a class="code" href="classUnits.html#abbe5788fabebcc46cb9c20e49d7647e3">Units::evaluate_units</a>($units);
<a name="l01417"></a>01417     <span class="keywordflow">if</span> ( defined( $units{<span class="stringliteral">&#39;ERROR&#39;</span>} ) ) {
<a name="l01418"></a>01418 <span class="preprocessor">         # handle error condition</span>
<a name="l01419"></a>01419 <span class="preprocessor"></span>            $units{<span class="stringliteral">&#39;ERROR&#39;</span>} = clean_up_error_msg($units{<span class="stringliteral">&#39;ERROR&#39;</span>});
<a name="l01420"></a>01420         $rh_ans -&gt; setKeys( <span class="stringliteral">&#39;ans_message&#39;</span> =&gt; <span class="stringliteral">&quot;$units{&#39;ERROR&#39;}&quot;</span> );
<a name="l01421"></a>01421         $rh_ans -&gt; throw_error(<span class="stringliteral">&#39;UNITS&#39;</span>, <span class="stringliteral">&quot;$units{&#39;ERROR&#39;}&quot;</span>);
<a name="l01422"></a>01422         <span class="keywordflow">return</span> $rh_ans;
<a name="l01423"></a>01423     }
<a name="l01424"></a>01424 
<a name="l01425"></a>01425     my $units_match = 1;
<a name="l01426"></a>01426     my $fund_unit;
<a name="l01427"></a>01427     <span class="keywordflow">foreach</span> $fund_unit (keys %correct_units) {
<a name="l01428"></a>01428         next <span class="keywordflow">if</span> $fund_unit eq <span class="stringliteral">&#39;factor&#39;</span>;
<a name="l01429"></a>01429         $units_match = 0 unless $correct_units{$fund_unit} == $units{$fund_unit};
<a name="l01430"></a>01430     }
<a name="l01431"></a>01431 
<a name="l01432"></a>01432     <span class="keywordflow">if</span> ( $units_match ) {
<a name="l01433"></a>01433 <span class="preprocessor">            # units are ok.  Evaluate the numerical part of the answer</span>
<a name="l01434"></a>01434 <span class="preprocessor"></span>        $rh_ans-&gt;{<span class="stringliteral">&#39;tolerance&#39;</span>} = $rh_ans-&gt;{<span class="stringliteral">&#39;tolerance&#39;</span>}* $correct_units{<span class="stringliteral">&#39;factor&#39;</span>}/$units{<span class="stringliteral">&#39;factor&#39;</span>}  <span class="keywordflow">if</span>
<a name="l01435"></a>01435                 $rh_ans-&gt;{<span class="stringliteral">&#39;tolType&#39;</span>} eq <span class="stringliteral">&#39;absolute&#39;</span>; # the tolerance is in the units specified by the instructor.
<a name="l01436"></a>01436         $rh_ans-&gt;{correct_ans} =  prfmt($rh_ans-&gt;{correct_ans}*$correct_units{<span class="stringliteral">&#39;factor&#39;</span>}/$units{<span class="stringliteral">&#39;factor&#39;</span>});
<a name="l01437"></a>01437         $rh_ans-&gt;{student_units} = $units;
<a name="l01438"></a>01438         $rh_ans-&gt;{student_ans} = $num_answer;
<a name="l01439"></a>01439 
<a name="l01440"></a>01440     } <span class="keywordflow">else</span> {
<a name="l01441"></a>01441             $rh_ans -&gt; setKeys( ans_message =&gt; <span class="stringliteral">&#39;There is an error in the units for this answer.&#39;</span> );
<a name="l01442"></a>01442             $rh_ans -&gt; throw_error ( <span class="stringliteral">&#39;UNITS&#39;</span>, <span class="stringliteral">&#39;There is an error in the units for this answer.&#39;</span> );
<a name="l01443"></a>01443     }
<a name="l01444"></a>01444 
<a name="l01445"></a>01445     <span class="keywordflow">return</span> $rh_ans;
<a name="l01446"></a>01446 }
<a name="l01447"></a>01447 
<a name="l01448"></a>01448 
<a name="l01449"></a>01449 
<a name="l01450"></a>01450 
<a name="l01451"></a>01451 =head4 std_problem_grader
<a name="l01452"></a>01452 
<a name="l01453"></a>01453 This is an all-or-nothing grader.  A student must <span class="keyword">get</span> all parts of the problem write
<a name="l01454"></a>01454 before receiving credit.  You should make sure to use <span class="keyword">this</span> grader on multiple choice
<a name="l01455"></a>01455 and <span class="keyword">true</span>-<span class="keyword">false</span> questions, otherwise students will be able to deduce how many
<a name="l01456"></a>01456 answers are correct by the grade reported by webwork.
<a name="l01457"></a>01457 
<a name="l01458"></a>01458 
<a name="l01459"></a>01459     install_problem_grader(~~&amp;std_problem_grader);
<a name="l01460"></a>01460 
<a name="l01461"></a>01461 =cut
<a name="l01462"></a>01462 
<a name="l01463"></a>01463 <span class="preprocessor"># ^function std_problem_grader</span>
<a name="l01464"></a>01464 <span class="preprocessor"></span>sub std_problem_grader {
<a name="l01465"></a>01465     my $rh_evaluated_answers = shift;
<a name="l01466"></a>01466     my $rh_problem_state = shift;
<a name="l01467"></a>01467     my %form_options = @_;
<a name="l01468"></a>01468     my %evaluated_answers = %{$rh_evaluated_answers};
<a name="l01469"></a>01469 <span class="preprocessor">    #  The hash $rh_evaluated_answers typically contains:</span>
<a name="l01470"></a>01470 <span class="preprocessor"></span><span class="preprocessor">    #      &#39;answer1&#39; =&gt; 34, &#39;answer2&#39;=&gt; &#39;Mozart&#39;, etc.</span>
<a name="l01471"></a>01471 <span class="preprocessor"></span>
<a name="l01472"></a>01472 <span class="preprocessor">    # By default the  old problem state is simply passed back out again.</span>
<a name="l01473"></a>01473 <span class="preprocessor"></span>    my %problem_state = %$rh_problem_state;
<a name="l01474"></a>01474 
<a name="l01475"></a>01475 <span class="preprocessor">    # %form_options might include</span>
<a name="l01476"></a>01476 <span class="preprocessor"></span><span class="preprocessor">    # The user login name</span>
<a name="l01477"></a>01477 <span class="preprocessor"></span><span class="preprocessor">    # The permission level of the user</span>
<a name="l01478"></a>01478 <span class="preprocessor"></span><span class="preprocessor">    # The studentLogin name for this psvn.</span>
<a name="l01479"></a>01479 <span class="preprocessor"></span><span class="preprocessor">    # Whether the form is asking for a refresh or is submitting a new answer.</span>
<a name="l01480"></a>01480 <span class="preprocessor"></span>
<a name="l01481"></a>01481 <span class="preprocessor">    # initial setup of the answer</span>
<a name="l01482"></a>01482 <span class="preprocessor"></span>    my %problem_result = ( score        =&gt; 0,
<a name="l01483"></a>01483                    errors       =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l01484"></a>01484                    type     =&gt; <span class="stringliteral">&#39;std_problem_grader&#39;</span>,
<a name="l01485"></a>01485                    msg      =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l01486"></a>01486     );
<a name="l01487"></a>01487 <span class="preprocessor">    # Checks</span>
<a name="l01488"></a>01488 <span class="preprocessor"></span>
<a name="l01489"></a>01489     my $ansCount = keys %evaluated_answers;  # <span class="keyword">get</span> the number of answers
<a name="l01490"></a>01490 
<a name="l01491"></a>01491     unless ($ansCount &gt; 0 ) {
<a name="l01492"></a>01492 
<a name="l01493"></a>01493         $problem_result{msg} = <span class="stringliteral">&quot;This problem did not ask any questions.&quot;</span>;
<a name="l01494"></a>01494         <span class="keywordflow">return</span>(\%problem_result,\%problem_state);
<a name="l01495"></a>01495     }
<a name="l01496"></a>01496 
<a name="l01497"></a>01497     <span class="keywordflow">if</span> ($ansCount &gt; 1 ) {
<a name="l01498"></a>01498         $problem_result{msg} = <span class="stringliteral">&#39;In order to get credit for this problem all answers must be correct.&#39;</span> ;
<a name="l01499"></a>01499     }
<a name="l01500"></a>01500 
<a name="l01501"></a>01501     unless ($form_options{answers_submitted} == 1) {
<a name="l01502"></a>01502         <span class="keywordflow">return</span>(\%problem_result,\%problem_state);
<a name="l01503"></a>01503     }
<a name="l01504"></a>01504 
<a name="l01505"></a>01505     my $allAnswersCorrectQ=1;
<a name="l01506"></a>01506     <span class="keywordflow">foreach</span> my $ans_name (keys %evaluated_answers) {
<a name="l01507"></a>01507 <span class="preprocessor">    # I&#39;m not sure if this check is really useful.</span>
<a name="l01508"></a>01508 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( ( ref($evaluated_answers{$ans_name} ) eq <span class="stringliteral">&#39;HASH&#39;</span> ) or ( ref($evaluated_answers{$ans_name}) eq <span class="stringliteral">&#39;AnswerHash&#39;</span> ) )  {
<a name="l01509"></a>01509             $allAnswersCorrectQ = 0 unless( 1 == $evaluated_answers{$ans_name}-&gt;{score} );
<a name="l01510"></a>01510         }
<a name="l01511"></a>01511         <span class="keywordflow">else</span> {
<a name="l01512"></a>01512             die <span class="stringliteral">&quot;Error at file &quot;</span>,__FILE__,<span class="stringliteral">&quot;line &quot;</span>, __LINE__,<span class="stringliteral">&quot;:  Answer |$ans_name| is not a hash reference\n&quot;</span>.
<a name="l01513"></a>01513                  $evaluated_answers{$ans_name} .
<a name="l01514"></a>01514                  <span class="stringliteral">&quot;This probably means that the answer evaluator for this answer\n&quot;</span> .
<a name="l01515"></a>01515                  <span class="stringliteral">&quot;is not working correctly.&quot;</span>;
<a name="l01516"></a>01516             $problem_result{error} = <span class="stringliteral">&quot;Error: Answer $ans_name is not a hash: $evaluated_answers{$ans_name}&quot;</span>;
<a name="l01517"></a>01517         }
<a name="l01518"></a>01518     }
<a name="l01519"></a>01519 <span class="preprocessor">    # report the results</span>
<a name="l01520"></a>01520 <span class="preprocessor"></span>    $problem_result{score} = $allAnswersCorrectQ;
<a name="l01521"></a>01521     
<a name="l01522"></a>01522     $problem_state{num_of_correct_ans}++ <span class="keywordflow">if</span> $allAnswersCorrectQ == 1;
<a name="l01523"></a>01523     $problem_state{num_of_incorrect_ans}++ <span class="keywordflow">if</span> $allAnswersCorrectQ == 0;
<a name="l01524"></a>01524 
<a name="l01525"></a>01525 <span class="preprocessor">    # Determine if we are in the reduced scoring period and act accordingly</span>
<a name="l01526"></a>01526 <span class="preprocessor"></span>
<a name="l01527"></a>01527     my $reducedScoringPeriodSec = $reducedScoringPeriod*60;   # $reducedScoringPeriod is in minutes
<a name="l01528"></a>01528     <span class="keywordflow">if</span> (!$enable_reduced_scoring or time() &lt; ($dueDate - $reducedScoringPeriodSec)) {   # the reduced scoring period is disabled or it is before the reduced scoring period
<a name="l01529"></a>01529 <span class="preprocessor">        # increase recorded score if the current score is greater.</span>
<a name="l01530"></a>01530 <span class="preprocessor"></span>        $problem_state{recorded_score} = $problem_result{score} <span class="keywordflow">if</span> $problem_result{score} &gt; $problem_state{recorded_score};
<a name="l01531"></a>01531 <span class="preprocessor">        # the sub_recored_score holds the recored_score before entering the reduced scoring period</span>
<a name="l01532"></a>01532 <span class="preprocessor"></span>        $problem_state{sub_recorded_score} = $problem_state{recorded_score};
<a name="l01533"></a>01533     }
<a name="l01534"></a>01534     elsif (time() &lt; $dueDate) { # we are in the reduced scoring period. 
<a name="l01535"></a>01535 <span class="preprocessor">        # student gets credit for all work done before the reduced scoring period plus a portion of work done during period</span>
<a name="l01536"></a>01536 <span class="preprocessor"></span>        my $newScore = 0;
<a name="l01537"></a>01537         $newScore =   $problem_state{sub_recorded_score} + $reducedScoringValue*($problem_result{score} - $problem_state{sub_recorded_score})  <span class="keywordflow">if</span> ($problem_result{score} &gt; $problem_state{sub_recorded_score});
<a name="l01538"></a>01538         $problem_state{recorded_score} = $newScore <span class="keywordflow">if</span> $newScore &gt; $problem_state{recorded_score};
<a name="l01539"></a>01539         my $reducedScoringPerCent = int(100*$reducedScoringValue+.5);
<a name="l01540"></a>01540         $problem_result{msg} = $problem_result{msg}.<span class="stringliteral">&quot;&lt;br /&gt;You are in the Reduced Credit Period: All additional work done counts $reducedScoringPerCent\% of the original.&quot;</span>;        
<a name="l01541"></a>01541     }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543     $problem_state{state_summary_msg} = <span class="stringliteral">&#39;&#39;</span>;  # an HTML formatted message printed at the bottom of the problem page
<a name="l01544"></a>01544     
<a name="l01545"></a>01545     (\%problem_result, \%problem_state);
<a name="l01546"></a>01546 }
<a name="l01547"></a>01547 
<a name="l01548"></a>01548 =head4 std_problem_grader2
<a name="l01549"></a>01549 
<a name="l01550"></a>01550 This is an all-or-nothing grader.  A student must <span class="keyword">get</span> all parts of the problem write
<a name="l01551"></a>01551 before receiving credit.  You should make sure to use <span class="keyword">this</span> grader on multiple choice
<a name="l01552"></a>01552 and <span class="keyword">true</span>-<span class="keyword">false</span> questions, otherwise students will be able to deduce how many
<a name="l01553"></a>01553 answers are correct by the grade reported by webwork.
<a name="l01554"></a>01554 
<a name="l01555"></a>01555 
<a name="l01556"></a>01556     install_problem_grader(~~&amp;std_problem_grader2);
<a name="l01557"></a>01557 
<a name="l01558"></a>01558 The only difference between the two versions
<a name="l01559"></a>01559 is at the end of the subroutine, where std_problem_grader2
<a name="l01560"></a>01560 records the attempt only <span class="keywordflow">if</span> there have been no syntax errors,
<a name="l01561"></a>01561 whereas std_problem_grader records it regardless.
<a name="l01562"></a>01562 
<a name="l01563"></a>01563 =cut
<a name="l01564"></a>01564 
<a name="l01565"></a>01565 
<a name="l01566"></a>01566 
<a name="l01567"></a>01567 <span class="preprocessor"># ^function std_problem_grader2</span>
<a name="l01568"></a>01568 <span class="preprocessor"></span>sub std_problem_grader2 {
<a name="l01569"></a>01569     my $rh_evaluated_answers = shift;
<a name="l01570"></a>01570     my $rh_problem_state = shift;
<a name="l01571"></a>01571     my %form_options = @_;
<a name="l01572"></a>01572     my %evaluated_answers = %{$rh_evaluated_answers};
<a name="l01573"></a>01573 <span class="preprocessor">    #  The hash $rh_evaluated_answers typically contains:</span>
<a name="l01574"></a>01574 <span class="preprocessor"></span><span class="preprocessor">    #      &#39;answer1&#39; =&gt; 34, &#39;answer2&#39;=&gt; &#39;Mozart&#39;, etc.</span>
<a name="l01575"></a>01575 <span class="preprocessor"></span>
<a name="l01576"></a>01576 <span class="preprocessor">    # By default the  old problem state is simply passed back out again.</span>
<a name="l01577"></a>01577 <span class="preprocessor"></span>    my %problem_state = %$rh_problem_state;
<a name="l01578"></a>01578 
<a name="l01579"></a>01579 <span class="preprocessor">    # %form_options might include</span>
<a name="l01580"></a>01580 <span class="preprocessor"></span><span class="preprocessor">    # The user login name</span>
<a name="l01581"></a>01581 <span class="preprocessor"></span><span class="preprocessor">    # The permission level of the user</span>
<a name="l01582"></a>01582 <span class="preprocessor"></span><span class="preprocessor">    # The studentLogin name for this psvn.</span>
<a name="l01583"></a>01583 <span class="preprocessor"></span><span class="preprocessor">    # Whether the form is asking for a refresh or is submitting a new answer.</span>
<a name="l01584"></a>01584 <span class="preprocessor"></span>
<a name="l01585"></a>01585 <span class="preprocessor">    # initial setup of the answer</span>
<a name="l01586"></a>01586 <span class="preprocessor"></span>    my %problem_result = ( score                =&gt; 0,
<a name="l01587"></a>01587                    errors               =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l01588"></a>01588                    type             =&gt; <span class="stringliteral">&#39;std_problem_grader&#39;</span>,
<a name="l01589"></a>01589                    msg              =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l01590"></a>01590     );
<a name="l01591"></a>01591 
<a name="l01592"></a>01592 <span class="preprocessor">    # syntax errors are not counted.</span>
<a name="l01593"></a>01593 <span class="preprocessor"></span>    my $record_problem_attempt = 1;
<a name="l01594"></a>01594 <span class="preprocessor">    # Checks</span>
<a name="l01595"></a>01595 <span class="preprocessor"></span><span class="preprocessor">    # FIXME:  syntax errors are never checked for so this grader does not perform as advertised</span>
<a name="l01596"></a>01596 <span class="preprocessor"></span>
<a name="l01597"></a>01597     my $ansCount = keys %evaluated_answers;  # <span class="keyword">get</span> the number of answers
<a name="l01598"></a>01598     unless ($ansCount &gt; 0 ) {
<a name="l01599"></a>01599         $problem_result{msg} = <span class="stringliteral">&quot;This problem did not ask any questions.&quot;</span>;
<a name="l01600"></a>01600         <span class="keywordflow">return</span>(\%problem_result,\%problem_state);
<a name="l01601"></a>01601     }
<a name="l01602"></a>01602 
<a name="l01603"></a>01603     <span class="keywordflow">if</span> ($ansCount &gt; 1 ) {
<a name="l01604"></a>01604         $problem_result{msg} = <span class="stringliteral">&#39;In order to get credit for this problem all answers must be correct.&#39;</span> ;
<a name="l01605"></a>01605     }
<a name="l01606"></a>01606 
<a name="l01607"></a>01607     unless ($form_options{answers_submitted} == 1) {
<a name="l01608"></a>01608         <span class="keywordflow">return</span>(\%problem_result,\%problem_state);
<a name="l01609"></a>01609     }
<a name="l01610"></a>01610 
<a name="l01611"></a>01611     my  $allAnswersCorrectQ=1;
<a name="l01612"></a>01612     <span class="keywordflow">foreach</span> my $ans_name (keys %evaluated_answers) {
<a name="l01613"></a>01613 <span class="preprocessor">    # I&#39;m not sure if this check is really useful.</span>
<a name="l01614"></a>01614 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( ( ref($evaluated_answers{$ans_name} ) eq <span class="stringliteral">&#39;HASH&#39;</span> ) or ( ref($evaluated_answers{$ans_name}) eq <span class="stringliteral">&#39;AnswerHash&#39;</span> ) )  {
<a name="l01615"></a>01615             $allAnswersCorrectQ = 0 unless( 1 == $evaluated_answers{$ans_name}-&gt;{score} );
<a name="l01616"></a>01616         }
<a name="l01617"></a>01617         <span class="keywordflow">else</span> {
<a name="l01618"></a>01618             die <span class="stringliteral">&quot;Error at file &quot;</span>,__FILE__,<span class="stringliteral">&quot;line &quot;</span>, __LINE__,<span class="stringliteral">&quot;:  Answer |$ans_name| is not a hash reference\n&quot;</span>.
<a name="l01619"></a>01619                  $evaluated_answers{$ans_name} .
<a name="l01620"></a>01620                  <span class="stringliteral">&quot;This probably means that the answer evaluator for this answer\n&quot;</span> .
<a name="l01621"></a>01621                  <span class="stringliteral">&quot;is not working correctly.&quot;</span>;
<a name="l01622"></a>01622             $problem_result{error} = <span class="stringliteral">&quot;Error: Answer $ans_name is not a hash: $evaluated_answers{$ans_name}&quot;</span>;
<a name="l01623"></a>01623         }
<a name="l01624"></a>01624     }
<a name="l01625"></a>01625 <span class="preprocessor">    # report the results</span>
<a name="l01626"></a>01626 <span class="preprocessor"></span>    $problem_result{score} = $allAnswersCorrectQ;
<a name="l01627"></a>01627 
<a name="l01628"></a>01628 <span class="preprocessor">    # Determine if we are in the reduced scoring period and act accordingly</span>
<a name="l01629"></a>01629 <span class="preprocessor"></span>
<a name="l01630"></a>01630     my $reducedScoringPeriodSec = $reducedScoringPeriod*60;   # $reducedScoringPeriod is in minutes
<a name="l01631"></a>01631     <span class="keywordflow">if</span> (!$enable_reduced_scoring or time() &lt; ($dueDate - $reducedScoringPeriodSec)) {   # the reduced scoring period is disabled or it is before the reduced scoring period
<a name="l01632"></a>01632 <span class="preprocessor">        # increase recorded score if the current score is greater.</span>
<a name="l01633"></a>01633 <span class="preprocessor"></span>        $problem_state{recorded_score} = $problem_result{score} <span class="keywordflow">if</span> $problem_result{score} &gt; $problem_state{recorded_score};
<a name="l01634"></a>01634 <span class="preprocessor">        # the sub_recored_score holds the recored_score before entering the reduced scoring period</span>
<a name="l01635"></a>01635 <span class="preprocessor"></span>        $problem_state{sub_recorded_score} = $problem_state{recorded_score};
<a name="l01636"></a>01636     }
<a name="l01637"></a>01637     elsif (time() &lt; $dueDate) { # we are in the reduced scoring period.
<a name="l01638"></a>01638         # student gets credit <span class="keywordflow">for</span> all work done before the reduced scoring period plus a portion of work done during period
<a name="l01639"></a>01639         my $newScore = 0;
<a name="l01640"></a>01640         $newScore =   $problem_state{sub_recorded_score} + $reducedScoringValue*($problem_result{score} - $problem_state{sub_recorded_score})  <span class="keywordflow">if</span> ($problem_result{score} &gt; $problem_state{sub_recorded_score});
<a name="l01641"></a>01641         $problem_state{recorded_score} = $newScore <span class="keywordflow">if</span> $newScore &gt; $problem_state{recorded_score};
<a name="l01642"></a>01642         my $reducedScoringPerCent = int(100*$reducedScoringValue+.5);
<a name="l01643"></a>01643         $problem_result{msg} = $problem_result{msg}.<span class="stringliteral">&quot;&lt;br /&gt;You are in the Reduced Credit Period: All additional work done counts $reducedScoringPerCent\% of the original.&quot;</span>;        
<a name="l01644"></a>01644     }
<a name="l01645"></a>01645 <span class="preprocessor">    # record attempt only if there have been no syntax errors.</span>
<a name="l01646"></a>01646 <span class="preprocessor"></span>
<a name="l01647"></a>01647     <span class="keywordflow">if</span> ($record_problem_attempt == 1) {
<a name="l01648"></a>01648         $problem_state{num_of_correct_ans}++ <span class="keywordflow">if</span> $allAnswersCorrectQ == 1;
<a name="l01649"></a>01649         $problem_state{num_of_incorrect_ans}++ <span class="keywordflow">if</span> $allAnswersCorrectQ == 0;
<a name="l01650"></a>01650         $problem_state{state_summary_msg} = <span class="stringliteral">&#39;&#39;</span>;  # an HTML formatted message printed at the bottom of the problem page
<a name="l01651"></a>01651     
<a name="l01652"></a>01652     }
<a name="l01653"></a>01653     <span class="keywordflow">else</span> {
<a name="l01654"></a>01654         $problem_result{show_partial_correct_answers} = 0 ;  # prevent partial correct answers from being shown <span class="keywordflow">for</span> syntax errors.
<a name="l01655"></a>01655     }
<a name="l01656"></a>01656     (\%problem_result, \%problem_state);
<a name="l01657"></a>01657 }
<a name="l01658"></a>01658 
<a name="l01659"></a>01659 =head4 avg_problem_grader
<a name="l01660"></a>01660 
<a name="l01661"></a>01661 This grader gives a grade depending on how many questions from the problem are correct.  (The highest
<a name="l01662"></a>01662 grade is the one that is kept.  One can never lower the recorded grade on a problem by repeating it.)
<a name="l01663"></a>01663 Many professors (and almost all students :-)  ) prefer <span class="keyword">this</span> grader.
<a name="l01664"></a>01664 
<a name="l01665"></a>01665 
<a name="l01666"></a>01666     install_problem_grader(~~&amp;avg_problem_grader);
<a name="l01667"></a>01667 
<a name="l01668"></a>01668 =cut
<a name="l01669"></a>01669 
<a name="l01670"></a>01670 <span class="preprocessor"># ^function avg_problem_grader</span>
<a name="l01671"></a>01671 <span class="preprocessor"></span>sub avg_problem_grader {
<a name="l01672"></a>01672         my $rh_evaluated_answers = shift;
<a name="l01673"></a>01673     my $rh_problem_state = shift;
<a name="l01674"></a>01674     my %form_options = @_;
<a name="l01675"></a>01675     my %evaluated_answers = %{$rh_evaluated_answers};
<a name="l01676"></a>01676 <span class="preprocessor">    #  The hash $rh_evaluated_answers typically contains:</span>
<a name="l01677"></a>01677 <span class="preprocessor"></span><span class="preprocessor">    #      &#39;answer1&#39; =&gt; 34, &#39;answer2&#39;=&gt; &#39;Mozart&#39;, etc.</span>
<a name="l01678"></a>01678 <span class="preprocessor"></span>
<a name="l01679"></a>01679 <span class="preprocessor">    # By default the  old problem state is simply passed back out again.</span>
<a name="l01680"></a>01680 <span class="preprocessor"></span>    my %problem_state = %$rh_problem_state;
<a name="l01681"></a>01681 
<a name="l01682"></a>01682 <span class="preprocessor">    # %form_options might include</span>
<a name="l01683"></a>01683 <span class="preprocessor"></span><span class="preprocessor">    # The user login name</span>
<a name="l01684"></a>01684 <span class="preprocessor"></span><span class="preprocessor">    # The permission level of the user</span>
<a name="l01685"></a>01685 <span class="preprocessor"></span><span class="preprocessor">    # The studentLogin name for this psvn.</span>
<a name="l01686"></a>01686 <span class="preprocessor"></span><span class="preprocessor">    # Whether the form is asking for a refresh or is submitting a new answer.</span>
<a name="l01687"></a>01687 <span class="preprocessor"></span>
<a name="l01688"></a>01688 <span class="preprocessor">    # initial setup of the answer</span>
<a name="l01689"></a>01689 <span class="preprocessor"></span>    my  $total=0;
<a name="l01690"></a>01690     my %problem_result = ( score                =&gt; 0,
<a name="l01691"></a>01691                    errors               =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l01692"></a>01692                    type             =&gt; <span class="stringliteral">&#39;avg_problem_grader&#39;</span>,
<a name="l01693"></a>01693                    msg              =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l01694"></a>01694     );
<a name="l01695"></a>01695     my $count = keys %evaluated_answers;
<a name="l01696"></a>01696     $problem_result{msg} = <span class="stringliteral">&#39;You can earn partial credit on this problem.&#39;</span> <span class="keywordflow">if</span> $count &gt;1;
<a name="l01697"></a>01697 <span class="preprocessor">    # Return unless answers have been submitted</span>
<a name="l01698"></a>01698 <span class="preprocessor"></span>    unless ($form_options{answers_submitted} == 1) {
<a name="l01699"></a>01699         <span class="keywordflow">return</span>(\%problem_result,\%problem_state);
<a name="l01700"></a>01700     }
<a name="l01701"></a>01701 
<a name="l01702"></a>01702 <span class="preprocessor">    # Answers have been submitted -- process them.</span>
<a name="l01703"></a>01703 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $ans_name (keys %evaluated_answers) {
<a name="l01704"></a>01704 <span class="preprocessor">        # I&#39;m not sure if this check is really useful.</span>
<a name="l01705"></a>01705 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( ( ref($evaluated_answers{$ans_name} ) eq <span class="stringliteral">&#39;HASH&#39;</span> ) or ( ref($evaluated_answers{$ans_name}) eq <span class="stringliteral">&#39;AnswerHash&#39;</span> ) )  {
<a name="l01706"></a>01706             $total += $evaluated_answers{$ans_name}-&gt;{score};
<a name="l01707"></a>01707         }
<a name="l01708"></a>01708         <span class="keywordflow">else</span> {
<a name="l01709"></a>01709             die <span class="stringliteral">&quot;Error: Answer |$ans_name| is not a hash reference\n&quot;</span>.
<a name="l01710"></a>01710                  $evaluated_answers{$ans_name} .
<a name="l01711"></a>01711                  <span class="stringliteral">&quot;This probably means that the answer evaluator for this answer\n&quot;</span> .
<a name="l01712"></a>01712                  <span class="stringliteral">&quot;is not working correctly.&quot;</span>;
<a name="l01713"></a>01713             $problem_result{error} = <span class="stringliteral">&quot;Error: Answer $ans_name is not a hash: $evaluated_answers{$ans_name}&quot;</span>;
<a name="l01714"></a>01714         }
<a name="l01715"></a>01715     }
<a name="l01716"></a>01716 <span class="preprocessor">    # Calculate score rounded to three places to avoid roundoff problems</span>
<a name="l01717"></a>01717 <span class="preprocessor"></span>    $problem_result{score} = $total/$count <span class="keywordflow">if</span> $count;
<a name="l01718"></a>01718 
<a name="l01719"></a>01719     $problem_state{num_of_correct_ans}++ <span class="keywordflow">if</span> $total == $count;
<a name="l01720"></a>01720     $problem_state{num_of_incorrect_ans}++ <span class="keywordflow">if</span> $total &lt; $count;
<a name="l01721"></a>01721 
<a name="l01722"></a>01722 <span class="preprocessor">    # Determine if we are in the reduced scoring period and if the reduced scoring period is enabled and act accordingly</span>
<a name="l01723"></a>01723 <span class="preprocessor"></span><span class="preprocessor">#warn(&quot;enable_reduced_scoring is $enable_reduced_scoring&quot;);</span>
<a name="l01724"></a>01724 <span class="preprocessor"></span><span class="preprocessor"># warn(&quot;dueDate is $dueDate&quot;);</span>
<a name="l01725"></a>01725 <span class="preprocessor"></span>    my $reducedScoringPeriodSec = $reducedScoringPeriod*60;   # $reducedScoringPeriod is in minutes
<a name="l01726"></a>01726     <span class="keywordflow">if</span> (!$enable_reduced_scoring or time() &lt; ($dueDate - $reducedScoringPeriodSec)) {   # the reduced scoring period is disabled or it is before the reduced scoring period
<a name="l01727"></a>01727 <span class="preprocessor">        # increase recorded score if the current score is greater.</span>
<a name="l01728"></a>01728 <span class="preprocessor"></span>        $problem_state{recorded_score} = $problem_result{score} <span class="keywordflow">if</span> $problem_result{score} &gt; $problem_state{recorded_score};
<a name="l01729"></a>01729 <span class="preprocessor">        # the sub_recored_score holds the recored_score before entering the reduced scoring period</span>
<a name="l01730"></a>01730 <span class="preprocessor"></span>        $problem_state{sub_recorded_score} = $problem_state{recorded_score};
<a name="l01731"></a>01731     }
<a name="l01732"></a>01732 elsif (time() &lt; $dueDate) { # we are in the reduced scoring period.
<a name="l01733"></a>01733         # student gets credit <span class="keywordflow">for</span> all work done before the reduced scoring period plus a portion of work done during period
<a name="l01734"></a>01734         my $newScore = 0;
<a name="l01735"></a>01735         $newScore =   $problem_state{sub_recorded_score} + $reducedScoringValue*($problem_result{score} - $problem_state{sub_recorded_score})  <span class="keywordflow">if</span> ($problem_result{score} &gt; $problem_state{sub_recorded_score});
<a name="l01736"></a>01736         $problem_state{recorded_score} = $newScore <span class="keywordflow">if</span> $newScore &gt; $problem_state{recorded_score};
<a name="l01737"></a>01737         my $reducedScoringPerCent = int(100*$reducedScoringValue+.5);
<a name="l01738"></a>01738         $problem_result{msg} = $problem_result{msg}.<span class="stringliteral">&quot;&lt;br /&gt;You are in the Reduced Credit Period: All additional work done counts $reducedScoringPerCent\% of the original.&quot;</span>;        
<a name="l01739"></a>01739     }
<a name="l01740"></a>01740     
<a name="l01741"></a>01741     $problem_state{state_summary_msg} = <span class="stringliteral">&#39;&#39;</span>;  # an HTML formatted message printed at the bottom of the problem page
<a name="l01742"></a>01742 
<a name="l01743"></a>01743     warn <span class="stringliteral">&quot;Error in grading this problem the total $total is larger than $count&quot;</span> <span class="keywordflow">if</span> $total &gt; $count;
<a name="l01744"></a>01744     (\%problem_result, \%problem_state);
<a name="l01745"></a>01745 }
<a name="l01746"></a>01746 
<a name="l01747"></a>01747 =head2 Utility subroutines
<a name="l01748"></a>01748 
<a name="l01749"></a>01749 =head4 pretty_print
<a name="l01750"></a>01750 
<a name="l01751"></a>01751     Usage: warn pretty_print( $rh_hash_input)
<a name="l01752"></a>01752            TEXT(pretty_print($ans_hash));
<a name="l01753"></a>01753            TEXT(~~%envir);
<a name="l01754"></a>01754 
<a name="l01755"></a>01755 This can be very useful for printing out messages about objects while debugging
<a name="l01756"></a>01756 
<a name="l01757"></a>01757 =cut
<a name="l01758"></a>01758 
<a name="l01759"></a>01759 <span class="preprocessor"># ^function pretty_print</span>
<a name="l01760"></a>01760 <span class="preprocessor"></span><span class="preprocessor"># ^uses lex_sort</span>
<a name="l01761"></a>01761 <span class="preprocessor"></span><span class="preprocessor"># ^uses pretty_print</span>
<a name="l01762"></a>01762 <span class="preprocessor"></span><span class="preprocessor"># sub pretty_print {</span>
<a name="l01763"></a>01763 <span class="preprocessor"></span><span class="preprocessor">#     my $r_input = shift;</span>
<a name="l01764"></a>01764 <span class="preprocessor"></span><span class="preprocessor">#     my $out = &#39;&#39;;</span>
<a name="l01765"></a>01765 <span class="preprocessor"></span><span class="preprocessor">#     if ( not ref($r_input) ) {</span>
<a name="l01766"></a>01766 <span class="preprocessor"></span><span class="preprocessor">#       $out = $r_input if defined $r_input;    # not a reference</span>
<a name="l01767"></a>01767 <span class="preprocessor"></span><span class="preprocessor">#       $out =~ s/&lt;/&amp;lt;/g  ;  # protect for HTML output</span>
<a name="l01768"></a>01768 <span class="preprocessor"></span><span class="preprocessor">#     } elsif (&quot;$r_input&quot; =~/hash/i) {  # this will pick up objects whose &#39;$self&#39; is hash and so works better than ref($r_iput).</span>
<a name="l01769"></a>01769 <span class="preprocessor"></span><span class="preprocessor">#       local($^W) = 0;</span>
<a name="l01770"></a>01770 <span class="preprocessor"></span><span class="preprocessor">#       </span>
<a name="l01771"></a>01771 <span class="preprocessor"></span><span class="preprocessor">#       $out .= &quot;$r_input &quot; .&quot;&lt;TABLE border = \&quot;2\&quot; cellpadding = \&quot;3\&quot; BGCOLOR = \&quot;#FFFFFF\&quot;&gt;&quot;;</span>
<a name="l01772"></a>01772 <span class="preprocessor"></span><span class="preprocessor">#       </span>
<a name="l01773"></a>01773 <span class="preprocessor"></span><span class="preprocessor">#       </span>
<a name="l01774"></a>01774 <span class="preprocessor"></span><span class="preprocessor">#       foreach my $key (lex_sort( keys %$r_input )) {</span>
<a name="l01775"></a>01775 <span class="preprocessor"></span><span class="preprocessor">#           $out .= &quot;&lt;tr&gt;&lt;TD&gt; $key&lt;/TD&gt;&lt;TD&gt;=&amp;gt;&lt;/td&gt;&lt;td&gt;&amp;nbsp;&quot;.pretty_print($r_input-&gt;{$key}) . &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</span>
<a name="l01776"></a>01776 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l01777"></a>01777 <span class="preprocessor"></span><span class="preprocessor">#       </span>
<a name="l01778"></a>01778 <span class="preprocessor"></span><span class="preprocessor">#       </span>
<a name="l01779"></a>01779 <span class="preprocessor"></span><span class="preprocessor">#       </span>
<a name="l01780"></a>01780 <span class="preprocessor"></span><span class="preprocessor">#       $out .=&quot;&lt;/table&gt;&quot;;</span>
<a name="l01781"></a>01781 <span class="preprocessor"></span><span class="preprocessor">#   } elsif (ref($r_input) eq &#39;ARRAY&#39; ) {</span>
<a name="l01782"></a>01782 <span class="preprocessor"></span><span class="preprocessor">#       my @array = @$r_input;</span>
<a name="l01783"></a>01783 <span class="preprocessor"></span><span class="preprocessor">#       $out .= &quot;( &quot; ;</span>
<a name="l01784"></a>01784 <span class="preprocessor"></span><span class="preprocessor">#       while (@array) {</span>
<a name="l01785"></a>01785 <span class="preprocessor"></span><span class="preprocessor">#           $out .= pretty_print(shift @array) . &quot; , &quot;;</span>
<a name="l01786"></a>01786 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l01787"></a>01787 <span class="preprocessor"></span><span class="preprocessor">#       $out .= &quot; )&quot;;</span>
<a name="l01788"></a>01788 <span class="preprocessor"></span><span class="preprocessor">#   } elsif (ref($r_input) eq &#39;CODE&#39;) {</span>
<a name="l01789"></a>01789 <span class="preprocessor"></span><span class="preprocessor">#       $out = &quot;$r_input&quot;;</span>
<a name="l01790"></a>01790 <span class="preprocessor"></span><span class="preprocessor">#   } else {</span>
<a name="l01791"></a>01791 <span class="preprocessor"></span><span class="preprocessor">#       $out = $r_input;</span>
<a name="l01792"></a>01792 <span class="preprocessor"></span><span class="preprocessor">#       $out =~ s/&lt;/&amp;lt;/g ;  # protect for HTML output</span>
<a name="l01793"></a>01793 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l01794"></a>01794 <span class="preprocessor"></span><span class="preprocessor">#       $out;</span>
<a name="l01795"></a>01795 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l01796"></a>01796 <span class="preprocessor"></span>
<a name="l01797"></a>01797 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:54:55 2012 for PG by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
