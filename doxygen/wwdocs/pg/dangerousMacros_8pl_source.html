<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PG: dangerousMacros.pl Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>dangerousMacros.pl</h1><a href="dangerousMacros_8pl.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: pg/macros/dangerousMacros.pl,v 1.58 2009/11/04 17:54:42 dpvc Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 =head1 NAME
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 dangerousMacros.pl - Macros which require elevated permissions to execute.
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 =head1 SYNPOSIS
<a name="l00022"></a>00022 
<a name="l00023"></a>00023     loadMacros(macrofile1,macrofile2,...)
<a name="l00024"></a>00024     
<a name="l00025"></a>00025     insertGraph(graphObject); <span class="preprocessor"># returns a path to the file containing the graph image.</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>    
<a name="l00027"></a>00027     tth(texString); # returns an HTML version of the tex code passed to it.
<a name="l00028"></a>00028     
<a name="l00029"></a>00029     alias(pathToFile); # returns URL which links to that file
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 =head1 DESCRIPTION
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 dangerousMacros.pl contains macros that use potentially dangerous <a class="code" href="PGstringevaluators_8pl.html#a432234fc3d5710ff4fdc5eacd9a0eae2">functions</a> like
<a name="l00034"></a>00034 require and eval. They can reference disk files <span class="keywordflow">for</span> reading and writing, create
<a name="l00035"></a>00035 links, and execute commands. It may be necessary to modify certain addresses in
<a name="l00036"></a>00036 <span class="keyword">this</span> file to make the scripts run properly in different environments.
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 This file is loaded implicitly every time a <span class="keyword">new</span> problem is rendered.
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 =<span class="keywordflow">for</span> comment
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 FIXME <span class="keyword">this</span> information belongs in global.conf where modules to load are listed.
<a name="l00043"></a>00043 I don<span class="stringliteral">&#39;t see why this shows up here.</span>
<a name="l00044"></a>00044 <span class="stringliteral"></span>
<a name="l00045"></a>00045 <span class="stringliteral">=head2 Sharing modules</span>
<a name="l00046"></a>00046 <span class="stringliteral"></span>
<a name="l00047"></a>00047 <span class="stringliteral">Most modules are loaded by dangerousMacros.pl</span>
<a name="l00048"></a>00048 <span class="stringliteral"></span>
<a name="l00049"></a>00049 <span class="stringliteral">The modules must be loaded using require (not use) since the</span>
<a name="l00050"></a>00050 <span class="stringliteral">courseScriptsDirectory is defined at run time.</span>
<a name="l00051"></a>00051 <span class="stringliteral"></span>
<a name="l00052"></a>00052 <span class="stringliteral">The following considerations come into play.</span>
<a name="l00053"></a>00053 <span class="stringliteral"></span>
<a name="l00054"></a>00054 <span class="stringliteral">=over</span>
<a name="l00055"></a>00055 <span class="stringliteral"></span>
<a name="l00056"></a>00056 <span class="stringliteral">=item *</span>
<a name="l00057"></a>00057 <span class="stringliteral"></span>
<a name="l00058"></a>00058 <span class="stringliteral">One needs to limit the access to modules for safety -- hence only modules in the</span>
<a name="l00059"></a>00059 <span class="stringliteral">F&lt;courseScriptsDirectory&gt; can be loaded.</span>
<a name="l00060"></a>00060 <span class="stringliteral"></span>
<a name="l00061"></a>00061 <span class="stringliteral">=item *</span>
<a name="l00062"></a>00062 <span class="stringliteral"></span>
<a name="l00063"></a>00063 <span class="stringliteral">Loading them in dangerousMacros.pl is wasteful, since the modules would need to</span>
<a name="l00064"></a>00064 <span class="stringliteral">be reloaded everytime a new safe compartment is created. (I believe that using</span>
<a name="l00065"></a>00065 <span class="stringliteral">require takes care of this.)</span>
<a name="l00066"></a>00066 <span class="stringliteral"></span>
<a name="l00067"></a>00067 <span class="stringliteral">=item *</span>
<a name="l00068"></a>00068 <span class="stringliteral"></span>
<a name="l00069"></a>00069 <span class="stringliteral">Loading GD within a safeCompartment creates infinite recurrsion in AUTOLOAD</span>
<a name="l00070"></a>00070 <span class="stringliteral">(probably a bug) hence this module is loaded by translate.pl and then shared</span>
<a name="l00071"></a>00071 <span class="stringliteral">with the safe compartment.</span>
<a name="l00072"></a>00072 <span class="stringliteral"></span>
<a name="l00073"></a>00073 <span class="stringliteral">=item *</span>
<a name="l00074"></a>00074 <span class="stringliteral"></span>
<a name="l00075"></a>00075 <span class="stringliteral">Other modules loaded by translate.pl are C&lt;Exporter&gt; and C&lt;DynaLoader&gt;.</span>
<a name="l00076"></a>00076 <span class="stringliteral"></span>
<a name="l00077"></a>00077 <span class="stringliteral">=item *</span>
<a name="l00078"></a>00078 <span class="stringliteral"></span>
<a name="l00079"></a>00079 <span class="stringliteral">PGrandom is loaded by F&lt;PG.pl&gt;, since it is needed there.</span>
<a name="l00080"></a>00080 <span class="stringliteral"></span>
<a name="l00081"></a>00081 <span class="stringliteral">=back</span>
<a name="l00082"></a>00082 <span class="stringliteral"></span>
<a name="l00083"></a>00083 <span class="stringliteral">The module name spaces loaded in dangerousMacros are:</span>
<a name="l00084"></a>00084 <span class="stringliteral"></span>
<a name="l00085"></a>00085 <span class="stringliteral">    PGrandom (if not previously loaded)</span>
<a name="l00086"></a>00086 <span class="stringliteral">    WWPlot</span>
<a name="l00087"></a>00087 <span class="stringliteral">    Fun</span>
<a name="l00088"></a>00088 <span class="stringliteral">    Label</span>
<a name="l00089"></a>00089 <span class="stringliteral">    Circle</span>
<a name="l00090"></a>00090 <span class="stringliteral"></span>
<a name="l00091"></a>00091 <span class="stringliteral">in addition the subroutine &amp;evaluate_units is shared from the module Units.</span>
<a name="l00092"></a>00092 <span class="stringliteral"></span>
<a name="l00093"></a>00093 <span class="stringliteral">=cut</span>
<a name="l00094"></a>00094 <span class="stringliteral"></span>
<a name="l00095"></a>00095 <span class="stringliteral"># </span>
<a name="l00096"></a>00096 <span class="stringliteral"># BEGIN {</span>
<a name="l00097"></a>00097 <span class="stringliteral">#   be_strict(); # an alias for use strict.  This means that all global variable must contain main:: as a prefix.</span>
<a name="l00098"></a>00098 <span class="stringliteral">#   </span>
<a name="l00099"></a>00099 <span class="stringliteral"># }</span>
<a name="l00100"></a>00100 <span class="stringliteral"># </span>
<a name="l00101"></a>00101 <span class="stringliteral"># # ^variable my $debugON</span>
<a name="l00102"></a>00102 <span class="stringliteral"># my $debugON = 0;</span>
<a name="l00103"></a>00103 <span class="stringliteral"># </span>
<a name="l00104"></a>00104 <span class="stringliteral"># # grab read only variables from the current safe compartment</span>
<a name="l00105"></a>00105 <span class="stringliteral"># </span>
<a name="l00106"></a>00106 <span class="stringliteral"># # ^variable my $macrosPath</span>
<a name="l00107"></a>00107 <span class="stringliteral"># my ($macrosPath,</span>
<a name="l00108"></a>00108 <span class="stringliteral">#     # ^variable my $pwd</span>
<a name="l00109"></a>00109 <span class="stringliteral">#     $pwd,</span>
<a name="l00110"></a>00110 <span class="stringliteral">#     # ^variable my $appletPath</span>
<a name="l00111"></a>00111 <span class="stringliteral">#     $appletPath,</span>
<a name="l00112"></a>00112 <span class="stringliteral">#     # ^variable my $server_root_url</span>
<a name="l00113"></a>00113 <span class="stringliteral">#     $server_root_url,</span>
<a name="l00114"></a>00114 <span class="stringliteral">#   # ^variable my $templateDirectory</span>
<a name="l00115"></a>00115 <span class="stringliteral">#   $templateDirectory,</span>
<a name="l00116"></a>00116 <span class="stringliteral">#   # ^variable my $scriptDirectory</span>
<a name="l00117"></a>00117 <span class="stringliteral">#   $scriptDirectory,</span>
<a name="l00118"></a>00118 <span class="stringliteral">#   # ^variable my $externalTTHPath</span>
<a name="l00119"></a>00119 <span class="stringliteral">#   $externalTTHPath,</span>
<a name="l00120"></a>00120 <span class="stringliteral">#   );</span>
<a name="l00121"></a>00121 <span class="stringliteral"># </span>
<a name="l00122"></a>00122 <span class="stringliteral"># # ^function _dangerousMacros_init</span>
<a name="l00123"></a>00123 <span class="stringliteral"># # ^uses %envir</span>
<a name="l00124"></a>00124 <span class="stringliteral"># # ^uses $macrosPath</span>
<a name="l00125"></a>00125 <span class="stringliteral"># # ^uses $pwd</span>
<a name="l00126"></a>00126 <span class="stringliteral"># # ^uses $appletPath</span>
<a name="l00127"></a>00127 <span class="stringliteral"># # ^uses $server_root_url</span>
<a name="l00128"></a>00128 <span class="stringliteral"># # ^uses $templateDirectory</span>
<a name="l00129"></a>00129 <span class="stringliteral"># # ^uses $scriptDirectory</span>
<a name="l00130"></a>00130 <span class="stringliteral"># # ^uses $externalTTHPath</span>
<a name="l00131"></a>00131 <span class="stringliteral"># # ^uses $debugON</span>
<a name="l00132"></a>00132 <span class="stringliteral"></span>
<a name="l00133"></a>00133 <span class="stringliteral">sub _dangerousMacros_init {   #use  envir instead of local variables?</span>
<a name="l00134"></a>00134 <span class="stringliteral">#     # will allow easy addition of new directories -- is this too liberal? do some pg directories need to be protected?</span>
<a name="l00135"></a>00135 <span class="stringliteral">#     $macrosPath               = eval(&#39;</span>$main::envir{pgDirectories}{macrosPath}<span class="stringliteral">&#39;); </span>
<a name="l00136"></a>00136 <span class="stringliteral">#     # will allow easy addition of new directories -- is this too liberal? do some pg directories need to be protected?</span>
<a name="l00137"></a>00137 <span class="stringliteral">#     $pwd                      = eval(&#39;</span>$main::envir{fileName}<span class="stringliteral">&#39;); $pwd =~ s!/[^/]*$!!;</span>
<a name="l00138"></a>00138 <span class="stringliteral">#     $appletPath               = eval(&#39;</span>$main::envir{pgDirectories}{appletPath}<span class="stringliteral">&#39;);</span>
<a name="l00139"></a>00139 <span class="stringliteral">#     $server_root_url          = eval(&#39;</span>$main::envir{server_root_url}<span class="stringliteral">&#39;);</span>
<a name="l00140"></a>00140 <span class="stringliteral"># </span>
<a name="l00141"></a>00141 <span class="stringliteral">#     $templateDirectory        = eval(&#39;</span>$main::envir{templateDirectory}<span class="stringliteral">&#39;);</span>
<a name="l00142"></a>00142 <span class="stringliteral">#     $scriptDirectory          = eval(&#39;</span>$main::envir{scriptDirectory}<span class="stringliteral">&#39;);</span>
<a name="l00143"></a>00143 <span class="stringliteral">#     $externalTTHPath          = eval(&#39;</span>$main::envir{externalTTHPath}<span class="stringliteral">&#39;);</span>
<a name="l00144"></a>00144 <span class="stringliteral">#     $pwd = $templateDirectory.$pwd unless substr($pwd,0,1) eq &#39;</span>/<span class="stringliteral">&#39;;</span>
<a name="l00145"></a>00145 <span class="stringliteral">#     $pwd =~ s!/tmpEdit/!/!;</span>
<a name="l00146"></a>00146 <span class="stringliteral">#     warn &quot;dangerousmacros initialized&quot; if $debugON;</span>
<a name="l00147"></a>00147 <span class="stringliteral">#     warn eval(q! &quot;dangerousmacros.pl externalTTHPath is &quot;.$main::externalTTHPath;!) if $debugON;</span>
<a name="l00148"></a>00148 <span class="stringliteral">#     warn eval(q! &quot;dangerousmacros.pl:  The envir variable $main::{envir} is&quot;.join(&quot; &quot;,%main::envir)!) if $debugON; </span>
<a name="l00149"></a>00149 <span class="stringliteral"></span>
<a name="l00150"></a>00150 <span class="stringliteral"> }</span>
<a name="l00151"></a>00151 <span class="stringliteral"> </span>
<a name="l00152"></a>00152 <span class="stringliteral"># </span>
<a name="l00153"></a>00153 <span class="stringliteral"># # ^function _dangerousMacros_export</span>
<a name="l00154"></a>00154 <span class="stringliteral"># sub _dangerousMacros_export {</span>
<a name="l00155"></a>00155 <span class="stringliteral">#   my @EXPORT= (</span>
<a name="l00156"></a>00156 <span class="stringliteral">#       &#39;</span>&amp;_dangerousMacros_init<span class="stringliteral">&#39;,</span>
<a name="l00157"></a>00157 <span class="stringliteral">#       &#39;</span>&amp;alias<span class="stringliteral">&#39;,</span>
<a name="l00158"></a>00158 <span class="stringliteral">#       &#39;</span>&amp;compile_file<span class="stringliteral">&#39;,</span>
<a name="l00159"></a>00159 <span class="stringliteral">#       &#39;</span>&amp;insertGraph<span class="stringliteral">&#39;,</span>
<a name="l00160"></a>00160 <span class="stringliteral">#       &#39;</span>&amp;loadMacros<span class="stringliteral">&#39;,</span>
<a name="l00161"></a>00161 <span class="stringliteral">#       &#39;</span>&amp;HEADER_TEXT<span class="stringliteral">&#39;,</span>
<a name="l00162"></a>00162 <span class="stringliteral">#       &#39;</span>&amp;sourceAlias<span class="stringliteral">&#39;,</span>
<a name="l00163"></a>00163 <span class="stringliteral">#       &#39;</span>&amp;tth<span class="stringliteral">&#39;,</span>
<a name="l00164"></a>00164 <span class="stringliteral">#   );</span>
<a name="l00165"></a>00165 <span class="stringliteral">#   @EXPORT;</span>
<a name="l00166"></a>00166 <span class="stringliteral"># }</span>
<a name="l00167"></a>00167 <span class="stringliteral"># </span>
<a name="l00168"></a>00168 <span class="stringliteral"># </span>
<a name="l00169"></a>00169 <span class="stringliteral"># =head2 loadMacros</span>
<a name="l00170"></a>00170 <span class="stringliteral"># </span>
<a name="l00171"></a>00171 <span class="stringliteral">#   loadMacros(@macroFiles)</span>
<a name="l00172"></a>00172 <span class="stringliteral"># </span>
<a name="l00173"></a>00173 <span class="stringliteral"># loadMacros takes a list of file names and evaluates the contents of each file. </span>
<a name="l00174"></a>00174 <span class="stringliteral"># This is used to load macros which define and augment the PG language. The macro</span>
<a name="l00175"></a>00175 <span class="stringliteral"># files are searched for in the directories specified by the array referenced by</span>
<a name="l00176"></a>00176 <span class="stringliteral"># $macrosPath, which by default is the current course&#39;</span>s macros directory followed
<a name="l00177"></a>00177 <span class="preprocessor"># by WeBWorK&#39;s pg/macros directory. The latter is where the default behaviour of</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span><span class="preprocessor"># the PG language is defined. The default path is set in the global.conf file.</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="preprocessor"># Macro files named PG.pl, IO.pl, or dangerousMacros.pl will be loaded with no</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span><span class="preprocessor"># opcode restrictions, hence any code in those files will be able to execute</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span><span class="preprocessor"># privileged operations. This is true no matter which macro directory the file is</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span><span class="preprocessor"># in. For example, if $macrosPath contains the path to a problem library macros</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span><span class="preprocessor"># directory which contains a PG.pl file, this file will be loaded and allowed to</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span><span class="preprocessor"># engage in privileged behavior.</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00187"></a>00187 <span class="preprocessor"></span><span class="preprocessor"># =head3 Overloading macro files</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00189"></a>00189 <span class="preprocessor"></span><span class="preprocessor"># An individual course can modify the PG language, for that course only, by</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="preprocessor"># duplicating one of the macro files in the system-wide macros directory and</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor"># placing this file in the macros directory for the course. The new file in the</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span><span class="preprocessor"># course&#39;s macros directory will now be used instead of the file in the</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span><span class="preprocessor"># system-wide macros directory.</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00195"></a>00195 <span class="preprocessor"></span><span class="preprocessor"># The new file in the course macros directory can by modified by adding macros or</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span><span class="preprocessor"># modifying existing macros.</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00198"></a>00198 <span class="preprocessor"></span><span class="preprocessor"># =head3 Modifying existing macros</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00200"></a>00200 <span class="preprocessor"></span><span class="preprocessor"># I&lt;Modifying macros is for users with some experience.&gt;</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00202"></a>00202 <span class="preprocessor"></span><span class="preprocessor"># Modifying existing macros might break other standard macros or problems which</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span><span class="preprocessor"># depend on the unmodified behavior of these macors so do this with great caution.</span>
<a name="l00204"></a>00204 <span class="preprocessor"></span><span class="preprocessor"># In addition problems which use new macros defined in these files or which depend</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span><span class="preprocessor"># on the modified behavior of existing macros will not work in other courses</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span><span class="preprocessor"># unless the macros are also transferred to the new course.  It helps to document</span>
<a name="l00207"></a>00207 <span class="preprocessor"></span><span class="preprocessor"># the  problems by indicating any special macros which the problems require.</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00209"></a>00209 <span class="preprocessor"></span><span class="preprocessor"># There is no facility for modifying or overloading a single macro. The entire</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span><span class="preprocessor"># file containing the macro must be overloaded.</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00212"></a>00212 <span class="preprocessor"></span><span class="preprocessor"># Modifications to files in the course macros directory affect only that course,</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span><span class="preprocessor"># they will not interfere with the normal behavior of WeBWorK in other courses.</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00215"></a>00215 <span class="preprocessor"></span><span class="preprocessor"># =cut</span>
<a name="l00216"></a>00216 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00217"></a>00217 <span class="preprocessor"></span><span class="preprocessor"># # Global variables used</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span><span class="preprocessor"># #   ${main::macrosPath}</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span><span class="preprocessor"># # Global macros used</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span><span class="preprocessor"># # None</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00222"></a>00222 <span class="preprocessor"></span><span class="preprocessor"># # Because of the need to use the directory variables it is tricky to define this</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span><span class="preprocessor"># # in translate.pl since, as currently written, the directories are not available</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span><span class="preprocessor"># # at that time.  Perhaps if I rewrite translate as an object that method will work.</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00226"></a>00226 <span class="preprocessor"></span><span class="preprocessor"># # The only difficulty with defining loadMacros inside the Safe compartment is that</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span><span class="preprocessor"># # the error reporting does not work with syntax errors.</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span><span class="preprocessor"># # A kludge using require works around this problem</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00230"></a>00230 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00231"></a>00231 <span class="preprocessor"></span><span class="preprocessor"># # ^function loadMacros</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span><span class="preprocessor"># # ^uses time_it</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $debugON</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $externalTTHPath</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span><span class="preprocessor"># # ^uses findMacroFile</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span><span class="preprocessor"># sub loadMacros {</span>
<a name="l00237"></a>00237 <span class="preprocessor"></span><span class="preprocessor">#     my @files = @_;</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span><span class="preprocessor">#     my $fileName;</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span><span class="preprocessor">#     eval {main::time_it(&quot;begin load macros&quot;);};</span>
<a name="l00240"></a>00240 <span class="preprocessor"></span><span class="preprocessor">#     ###############################################################################</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span><span class="preprocessor">#   # At this point the directories have been defined from %envir and we can define</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span><span class="preprocessor">#   # the directories for this file</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span><span class="preprocessor">#   ###############################################################################</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span><span class="preprocessor">#    </span>
<a name="l00245"></a>00245 <span class="preprocessor"></span><span class="preprocessor">#   # special case inits</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span><span class="preprocessor">#   foreach my $file (&#39;PG.pl&#39;,&#39;dangerousMacros.pl&#39;,&#39;IO.pl&#39;) {</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span><span class="preprocessor">#       my $macro_file_name = $file;</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span><span class="preprocessor">#       $macro_file_name =~s/\.pl//;  # trim off the extension</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span><span class="preprocessor">#       $macro_file_name =~s/\.pg//;  # sometimes the extension is .pg (e.g. CAPA files)</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span><span class="preprocessor">#       my $init_subroutine_name = &quot;_${macro_file_name}_init&quot;;</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span><span class="preprocessor">#       my $init_subroutine  = eval { \&amp;{$init_subroutine_name} };</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span><span class="preprocessor">#       use strict;</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span><span class="preprocessor">#         my $macro_file_loaded = defined($init_subroutine);</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span><span class="preprocessor">#         warn &quot;dangerousMacros: macro init $init_subroutine_name defined |$init_subroutine| |$macro_file_loaded|&quot; if $debugON;</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span><span class="preprocessor">#       if ( defined($init_subroutine) &amp;&amp; defined( &amp;{$init_subroutine} ) ) {</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">#           warn &quot;dangerousMacros:  initializing $macro_file_name&quot;  if $debugON;</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span><span class="preprocessor">#           &amp;$init_subroutine();</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span><span class="preprocessor">#     unless (defined( $externalTTHPath)){</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span><span class="preprocessor">#       warn &quot;WARNING::Please make sure that the DOCUMENT() statement comes before&lt;BR&gt;\n&quot; .</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span><span class="preprocessor">#            &quot; the loadMacros() statement in the problem template.&lt;p&gt;&quot; .</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor">#            &quot; The externalTTHPath variable |$externalTTHPath| was\n&quot;.</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor">#            &quot; not defined which usually indicates the problem above.&lt;br&gt;\n&quot;;</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00267"></a>00267 <span class="preprocessor"></span><span class="preprocessor">#     }</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span><span class="preprocessor">#     #warn &quot;running load macros&quot;;</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span><span class="preprocessor">#     while (@files) {</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">#         $fileName = shift @files;</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span><span class="preprocessor">#         next  if ($fileName =~ /^PG.pl$/) ;    # the PG.pl macro package is already loaded.</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00273"></a>00273 <span class="preprocessor"></span><span class="preprocessor">#         my $macro_file_name = $fileName;</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span><span class="preprocessor">#       $macro_file_name =~s/\.pl//;  # trim off the extension</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span><span class="preprocessor">#       $macro_file_name =~s/\.pg//;  # sometimes the extension is .pg (e.g. CAPA files)</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span><span class="preprocessor">#       my $init_subroutine_name = &quot;_${macro_file_name}_init&quot;;</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span><span class="preprocessor">#       $init_subroutine_name =~ s![^a-zA-Z0-9_]!_!g;  # remove dangerous chars</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00279"></a>00279 <span class="preprocessor"></span><span class="preprocessor">#       ###############################################################################</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span><span class="preprocessor">#       # For some reason the &quot;no stict&quot; which works on webwork-db doesn&#39;t work on</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="preprocessor">#       # webwork.  For this reason the constuction &amp;{$init_subroutine_name}</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">#       # was abandoned and replaced by eval.  This is considerably more dangerous</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span><span class="preprocessor">#       # since one could hide something nasty in a file name.</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span><span class="preprocessor">#       #  Keep an eye on this ???</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span><span class="preprocessor">#       # webwork-db used perl 5.6.1 and webwork used perl 5.6.0 </span>
<a name="l00286"></a>00286 <span class="preprocessor"></span><span class="preprocessor">#       ###############################################################################</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00288"></a>00288 <span class="preprocessor"></span><span class="preprocessor">#       # compile initialization subroutine. (5.6.0 version)</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00290"></a>00290 <span class="preprocessor"></span><span class="preprocessor">#       </span>
<a name="l00291"></a>00291 <span class="preprocessor"></span><span class="preprocessor"># #     eval( q{ \$init_subroutine = \\&amp;main::}.$init_subroutine_name);</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span><span class="preprocessor"># #     warn &quot;dangerousMacros: failed to compile $init_subroutine_name. $@&quot; if $@;</span>
<a name="l00293"></a>00293 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00294"></a>00294 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00295"></a>00295 <span class="preprocessor"></span><span class="preprocessor">#       ###############################################################################</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span><span class="preprocessor">#       #compile initialization subroutine. (5.6.1 version) also works with 5.6.0</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00298"></a>00298 <span class="preprocessor"></span><span class="preprocessor"># #         no strict;</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span><span class="preprocessor">#       my $init_subroutine  = eval { \&amp;{&#39;main::&#39;.$init_subroutine_name} };</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span><span class="preprocessor"># #         use strict;</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00302"></a>00302 <span class="preprocessor"></span><span class="preprocessor">#       ###############################################################################</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00304"></a>00304 <span class="preprocessor"></span><span class="preprocessor">#         # macros are searched for in the directories listed in the $macrosPath array reference.</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span><span class="preprocessor">#         </span>
<a name="l00306"></a>00306 <span class="preprocessor"></span><span class="preprocessor">#         my $macro_file_loaded = defined($init_subroutine) &amp;&amp; defined(&amp;$init_subroutine);</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span><span class="preprocessor">#         warn &quot;dangerousMacros: macro init $init_subroutine_name defined |$init_subroutine| |$macro_file_loaded|&quot;  if $debugON;</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span><span class="preprocessor">#         unless ($macro_file_loaded) {</span>
<a name="l00309"></a>00309 <span class="preprocessor"></span><span class="preprocessor">#           warn &quot;loadMacros: loading macro file $fileName\n&quot; if $debugON;</span>
<a name="l00310"></a>00310 <span class="preprocessor"></span><span class="preprocessor">#       my $filePath = findMacroFile($fileName);</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span><span class="preprocessor">#       #### (check for renamed files here?) ####</span>
<a name="l00312"></a>00312 <span class="preprocessor"></span><span class="preprocessor">#       if ($filePath) {</span>
<a name="l00313"></a>00313 <span class="preprocessor"></span><span class="preprocessor">#           compile_file($filePath); </span>
<a name="l00314"></a>00314 <span class="preprocessor"></span><span class="preprocessor">#           #warn &quot;loadMacros is compiling $filePath\n&quot;;</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span><span class="preprocessor">#       else {</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span><span class="preprocessor">#         die &quot;Can&#39;t locate macro file |$fileName| via path: |&quot;.join(&quot;|, |&quot;,@{$macrosPath}).&quot;|&quot;;</span>
<a name="l00318"></a>00318 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00319"></a>00319 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00320"></a>00320 <span class="preprocessor"></span><span class="preprocessor">#       ###############################################################################</span>
<a name="l00321"></a>00321 <span class="preprocessor"></span><span class="preprocessor">#       # Try again to define the initialization subroutine. (5.6.0 version)</span>
<a name="l00322"></a>00322 <span class="preprocessor"></span><span class="preprocessor">#       </span>
<a name="l00323"></a>00323 <span class="preprocessor"></span><span class="preprocessor"># #     eval( q{ \$init_subroutine = \\&amp;main::}.$init_subroutine_name );</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span><span class="preprocessor"># #     warn &quot;dangerousMacros: failed to compile $init_subroutine_name. $@&quot; if $@;</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span><span class="preprocessor"># #     $init_subroutine = $temp::rf_init_subroutine;</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span><span class="preprocessor">#       ###############################################################################</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span><span class="preprocessor">#       # Try again to define the initialization subroutine. (5.6.1 version) also works with 5.6.0  </span>
<a name="l00328"></a>00328 <span class="preprocessor"></span><span class="preprocessor">#           </span>
<a name="l00329"></a>00329 <span class="preprocessor"></span><span class="preprocessor"># #         no strict;            </span>
<a name="l00330"></a>00330 <span class="preprocessor"></span><span class="preprocessor">#       $init_subroutine  = eval { \&amp;{&#39;main::&#39;.$init_subroutine_name} };</span>
<a name="l00331"></a>00331 <span class="preprocessor"></span><span class="preprocessor"># #         use strict;</span>
<a name="l00332"></a>00332 <span class="preprocessor"></span><span class="preprocessor">#       ###############################################################################</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span><span class="preprocessor">#       #warn &quot;loadMacros: defining \$temp::rf_init_subroutine &quot;,$temp::rf_init_subroutine;</span>
<a name="l00334"></a>00334 <span class="preprocessor"></span><span class="preprocessor">#        $macro_file_loaded = defined($init_subroutine) &amp;&amp; defined(&amp;$init_subroutine);</span>
<a name="l00335"></a>00335 <span class="preprocessor"></span><span class="preprocessor">#        warn &quot;dangerousMacros: macro init $init_subroutine_name defined |$init_subroutine| |$macro_file_loaded|&quot; if $debugON;</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00337"></a>00337 <span class="preprocessor"></span><span class="preprocessor">#       if ( defined($init_subroutine) &amp;&amp; defined( &amp;{$init_subroutine} ) ) {</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span><span class="preprocessor">#           warn &quot;dangerousMacros:  initializing $macro_file_name&quot; if $debugON;</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span><span class="preprocessor">#           &amp;$init_subroutine();</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span><span class="preprocessor">#       #warn &quot;main:: contains &lt;br&gt;\n $macro_file_name &quot;.join(&quot;&lt;br&gt;\n $macro_file_name &quot;, %main::);</span>
<a name="l00342"></a>00342 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span><span class="preprocessor">#   eval{main::time_it(&quot;end load macros&quot;);};</span>
<a name="l00344"></a>00344 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00345"></a>00345 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00346"></a>00346 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span><span class="preprocessor"># #  Look for a macro file in the directories specified in the macros path</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l00349"></a>00349 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00350"></a>00350 <span class="preprocessor"></span><span class="preprocessor"># # ^function findMacroFile</span>
<a name="l00351"></a>00351 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $macrosPath</span>
<a name="l00352"></a>00352 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $pwd</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span><span class="preprocessor"># sub findMacroFile {</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span><span class="preprocessor">#   my $fileName = shift;</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span><span class="preprocessor">#   my $filePath;</span>
<a name="l00356"></a>00356 <span class="preprocessor"></span><span class="preprocessor">#   foreach my $dir (@{$macrosPath}) {</span>
<a name="l00357"></a>00357 <span class="preprocessor"></span><span class="preprocessor">#     $filePath = &quot;$dir/$fileName&quot;;</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span><span class="preprocessor">#     $filePath =~ s!^\.\.?/!$pwd/!;</span>
<a name="l00359"></a>00359 <span class="preprocessor"></span><span class="preprocessor">#     return $filePath if (-r $filePath);</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span><span class="preprocessor">#   return;  # no file found</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00364"></a>00364 <span class="preprocessor"></span><span class="preprocessor"># # ^function check_url</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span><span class="preprocessor"># # ^uses %envir</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span><span class="preprocessor"># sub check_url {</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span><span class="preprocessor">#   my $url  = shift;</span>
<a name="l00368"></a>00368 <span class="preprocessor"></span><span class="preprocessor">#   return undef if $url =~ /;/;   # make sure we can&#39;t get a second command in the url</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span><span class="preprocessor">#   #FIXME -- check for other exploits of the system call</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span><span class="preprocessor">#   #FIXME -- ALARM feature so that the response cannot be held up for too long.</span>
<a name="l00371"></a>00371 <span class="preprocessor"></span><span class="preprocessor">#   #FIXME doesn&#39;t seem to work with relative addresses.</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span><span class="preprocessor">#   #FIXME  Can we get the machine name of the server?</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00374"></a>00374 <span class="preprocessor"></span><span class="preprocessor">#    my $check_url_command = $envir{externalCheckUrl};</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span><span class="preprocessor">#    my $response = system(&quot;$check_url_command $url&quot;); </span>
<a name="l00376"></a>00376 <span class="preprocessor"></span><span class="preprocessor">#   return ($response) ? 0 : 1; # 0 indicates success, 256 is failure possibly more checks can be made</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00379"></a>00379 <span class="preprocessor"></span><span class="preprocessor"># # ^variable our %appletCodebaseLocations</span>
<a name="l00380"></a>00380 <span class="preprocessor"></span><span class="preprocessor"># our %appletCodebaseLocations = ();</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span><span class="preprocessor"># # ^function findAppletCodebase</span>
<a name="l00382"></a>00382 <span class="preprocessor"></span><span class="preprocessor"># # ^uses %appletCodebaseLocations</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $appletPath</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $server_root_url</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span><span class="preprocessor"># # ^uses check_url</span>
<a name="l00386"></a>00386 <span class="preprocessor"></span><span class="preprocessor"># sub findAppletCodebase {</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span><span class="preprocessor">#   my $fileName = shift;  # probably the name of a jar file</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span><span class="preprocessor">#   return $appletCodebaseLocations{$fileName}    #check cache first</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span><span class="preprocessor">#       if defined($appletCodebaseLocations{$fileName})</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span><span class="preprocessor">#           and $appletCodebaseLocations{$fileName} =~/\S/;</span>
<a name="l00391"></a>00391 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l00392"></a>00392 <span class="preprocessor"></span><span class="preprocessor">#   foreach my $appletLocation (@{$appletPath}) {</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span><span class="preprocessor">#       if ($appletLocation =~ m|^/|) {</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span><span class="preprocessor">#           $appletLocation = &quot;$server_root_url$appletLocation&quot;;</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00396"></a>00396 <span class="preprocessor"></span><span class="preprocessor">#       return $appletLocation;  # --hack workaround -- just pick the first location and use that -- no checks</span>
<a name="l00397"></a>00397 <span class="preprocessor"></span><span class="preprocessor"># #hack to workaround conflict between lwp-request and apache2</span>
<a name="l00398"></a>00398 <span class="preprocessor"></span><span class="preprocessor"># # comment out the check_url block</span>
<a name="l00399"></a>00399 <span class="preprocessor"></span><span class="preprocessor"># #         my $url = &quot;$appletLocation/$fileName&quot;;</span>
<a name="l00400"></a>00400 <span class="preprocessor"></span><span class="preprocessor"># #         if (check_url($url)) {</span>
<a name="l00401"></a>00401 <span class="preprocessor"></span><span class="preprocessor"># #                 $appletCodebaseLocations{$fileName} = $appletLocation; #update cache</span>
<a name="l00402"></a>00402 <span class="preprocessor"></span><span class="preprocessor"># #             return $appletLocation   # return codebase part of url</span>
<a name="l00403"></a>00403 <span class="preprocessor"></span><span class="preprocessor"># #         }</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span><span class="preprocessor">#   return &quot;Error: $fileName not found at &quot;. join(&quot;,    &quot;, @{$appletPath} );    # no file found</span>
<a name="l00406"></a>00406 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00407"></a>00407 <span class="preprocessor"></span><span class="preprocessor"># # errors in compiling macros is not always being reported.</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span><span class="preprocessor"># # ^function compile_file</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span><span class="preprocessor"># # ^uses @__eval__</span>
<a name="l00410"></a>00410 <span class="preprocessor"></span><span class="preprocessor"># # ^uses PG_restricted_eval</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $__files__</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span><span class="preprocessor"># sub compile_file {</span>
<a name="l00413"></a>00413 <span class="preprocessor"></span><span class="preprocessor">#   my $filePath = shift;</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;loading $filePath&quot; if $debugON; </span>
<a name="l00415"></a>00415 <span class="preprocessor"></span><span class="preprocessor">#   local(*MACROFILE);</span>
<a name="l00416"></a>00416 <span class="preprocessor"></span><span class="preprocessor">#   local($/);</span>
<a name="l00417"></a>00417 <span class="preprocessor"></span><span class="preprocessor">#   $/ = undef;   # allows us to treat the file as a single line</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span><span class="preprocessor">#   open(MACROFILE, &quot;&lt;$filePath&quot;) || die &quot;Cannot open file: $filePath&quot;;</span>
<a name="l00419"></a>00419 <span class="preprocessor"></span><span class="preprocessor">#   my $string = &#39;BEGIN {push @__eval__, __FILE__};&#39; . &quot;\n&quot; . &lt;MACROFILE&gt;;</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span><span class="preprocessor">#   my ($result,$error,$fullerror) = &amp;PG_restricted_eval($string);</span>
<a name="l00421"></a>00421 <span class="preprocessor"></span><span class="preprocessor">#   eval (&#39;$main::__files__-&gt;{pop @main::__eval__} = $filePath&#39;);</span>
<a name="l00422"></a>00422 <span class="preprocessor"></span><span class="preprocessor">#   if ($error) {    # the $fullerror report has formatting and is never empty</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span><span class="preprocessor">#                 # this is now handled by PG_errorMessage() in the PG translator</span>
<a name="l00424"></a>00424 <span class="preprocessor"></span><span class="preprocessor">#       #$fullerror =~ s/\(eval \d+\)/ $filePath\n/;   # attempt to insert file name instead of eval number</span>
<a name="l00425"></a>00425 <span class="preprocessor"></span><span class="preprocessor">#       die &quot;Error detected while loading $filePath:\n$fullerror&quot;;</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00427"></a>00427 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00428"></a>00428 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00429"></a>00429 <span class="preprocessor"></span><span class="preprocessor">#   close(MACROFILE);</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00431"></a>00431 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00433"></a>00433 <span class="preprocessor"></span><span class="preprocessor"># # This creates on the fly graphs</span>
<a name="l00434"></a>00434 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00435"></a>00435 <span class="preprocessor"></span><span class="preprocessor"># =head2 insertGraph</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00437"></a>00437 <span class="preprocessor"></span><span class="preprocessor">#   # returns a path to the file containing the graph image.</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span><span class="preprocessor">#   $filePath = insertGraph($graphObject);</span>
<a name="l00439"></a>00439 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00440"></a>00440 <span class="preprocessor"></span><span class="preprocessor"># insertGraph writes a GIF or PNG image file to the gif subdirectory of the</span>
<a name="l00441"></a>00441 <span class="preprocessor"></span><span class="preprocessor"># current course&#39;s HTML temp directory. The file name is obtained from the graph</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span><span class="preprocessor"># object. Warnings are issued if errors occur while writing to the file.</span>
<a name="l00443"></a>00443 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00444"></a>00444 <span class="preprocessor"></span><span class="preprocessor"># Returns a string containing the full path to the temporary file containing the</span>
<a name="l00445"></a>00445 <span class="preprocessor"></span><span class="preprocessor"># image. This is most often used in the construct</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00447"></a>00447 <span class="preprocessor"></span><span class="preprocessor">#   TEXT(alias(insertGraph($graph)));</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00449"></a>00449 <span class="preprocessor"></span><span class="preprocessor"># where alias converts the directory address to a URL when serving HTML pages and</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span><span class="preprocessor"># insures that an EPS file is generated when creating TeX code for downloading.</span>
<a name="l00451"></a>00451 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00452"></a>00452 <span class="preprocessor"></span><span class="preprocessor"># =cut</span>
<a name="l00453"></a>00453 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00454"></a>00454 <span class="preprocessor"></span><span class="preprocessor"># # ^function insertGraph</span>
<a name="l00455"></a>00455 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $WWPlot::use_png</span>
<a name="l00456"></a>00456 <span class="preprocessor"></span><span class="preprocessor"># # ^uses convertPath</span>
<a name="l00457"></a>00457 <span class="preprocessor"></span><span class="preprocessor"># # ^uses surePathToTmpFile</span>
<a name="l00458"></a>00458 <span class="preprocessor"></span><span class="preprocessor"># # ^uses PG_restricted_eval</span>
<a name="l00459"></a>00459 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $refreshCachedImages</span>
<a name="l00460"></a>00460 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $templateDirectory</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span><span class="preprocessor"># # ^uses %envir</span>
<a name="l00462"></a>00462 <span class="preprocessor"></span><span class="preprocessor"># sub insertGraph {</span>
<a name="l00463"></a>00463 <span class="preprocessor"></span><span class="preprocessor">#           # Convert the image to GIF and print it on standard output</span>
<a name="l00464"></a>00464 <span class="preprocessor"></span><span class="preprocessor">#   my $graph = shift;</span>
<a name="l00465"></a>00465 <span class="preprocessor"></span><span class="preprocessor">#   my $extension = ($WWPlot::use_png) ? &#39;.png&#39; : &#39;.gif&#39;;</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span><span class="preprocessor">#   my $fileName = $graph-&gt;imageName  . $extension;</span>
<a name="l00467"></a>00467 <span class="preprocessor"></span><span class="preprocessor">#   my $filePath = convertPath(&quot;gif/$fileName&quot;);</span>
<a name="l00468"></a>00468 <span class="preprocessor"></span><span class="preprocessor">#   $filePath = &amp;surePathToTmpFile( $filePath );</span>
<a name="l00469"></a>00469 <span class="preprocessor"></span><span class="preprocessor">#   my $refreshCachedImages = PG_restricted_eval(q!$refreshCachedImages!);</span>
<a name="l00470"></a>00470 <span class="preprocessor"></span><span class="preprocessor">#   # Check to see if we already have this graph, or if we have to make it</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span><span class="preprocessor">#   if( not -e $filePath # does it exist?</span>
<a name="l00472"></a>00472 <span class="preprocessor"></span><span class="preprocessor">#     or ((stat &quot;$templateDirectory&quot;.&quot;$main::envir{fileName}&quot;)[9] &gt; (stat $filePath)[9]) # source has changed</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span><span class="preprocessor">#     or $graph-&gt;imageName =~ /Undefined_Set/ # problems from SetMaker and its ilk should always be redone</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span><span class="preprocessor">#     or $refreshCachedImages</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span><span class="preprocessor">#   ) {</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span><span class="preprocessor">#       #createFile($filePath, $main::tmp_file_permission, $main::numericalGroupID);</span>
<a name="l00477"></a>00477 <span class="preprocessor"></span><span class="preprocessor">#       local(*OUTPUT);  # create local file handle so it won&#39;t overwrite other open files.</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span><span class="preprocessor">#       open(OUTPUT, &quot;&gt;$filePath&quot;)||warn (&quot;$0&quot;,&quot;Can&#39;t open $filePath&lt;BR&gt;&quot;,&quot;&quot;);</span>
<a name="l00479"></a>00479 <span class="preprocessor"></span><span class="preprocessor">#       chmod( 0777, $filePath);</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span><span class="preprocessor">#       print OUTPUT $graph-&gt;draw|| warn(&quot;$0&quot;,&quot;Can&#39;t print graph to $filePath&lt;BR&gt;&quot;,&quot;&quot;);</span>
<a name="l00481"></a>00481 <span class="preprocessor"></span><span class="preprocessor">#       close(OUTPUT)||warn(&quot;$0&quot;,&quot;Can&#39;t close $filePath&lt;BR&gt;&quot;,&quot;&quot;);</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span><span class="preprocessor">#   $filePath;</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00485"></a>00485 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00486"></a>00486 <span class="preprocessor"></span><span class="preprocessor"># =head2 [DEPRECATED] tth</span>
<a name="l00487"></a>00487 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00488"></a>00488 <span class="preprocessor"></span><span class="preprocessor">#   # returns an HTML version of the TeX code passed to it.</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span><span class="preprocessor">#   tth($texString);</span>
<a name="l00490"></a>00490 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00491"></a>00491 <span class="preprocessor"></span><span class="preprocessor"># This macro sends $texString to the filter program TtH, a TeX to HTML translator</span>
<a name="l00492"></a>00492 <span class="preprocessor"></span><span class="preprocessor"># written by Ian Hutchinson. TtH is available free of change non-commerical</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span><span class="preprocessor"># use at L&lt;http://hutchinson.belmont.ma.us/tth/&gt;.</span>
<a name="l00494"></a>00494 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00495"></a>00495 <span class="preprocessor"></span><span class="preprocessor"># The purpose of TtH is to translate text in the TeX or LaTeX markup language into</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span><span class="preprocessor"># HTML markup as best as possible.  Some symbols, such as square root symbols are</span>
<a name="l00497"></a>00497 <span class="preprocessor"></span><span class="preprocessor"># not translated completely.  Macintosh users must use the &quot;MacRoman&quot; encoding</span>
<a name="l00498"></a>00498 <span class="preprocessor"></span><span class="preprocessor"># (available in 4.0 and higher browsers) in order to view the symbols correctly. </span>
<a name="l00499"></a>00499 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK attempts to force Macintosh browsers to use this encoding when such a</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span><span class="preprocessor"># browser is detected.</span>
<a name="l00501"></a>00501 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00502"></a>00502 <span class="preprocessor"></span><span class="preprocessor"># The contents of the file F&lt;tthPreamble.tex&gt; in the courses template directory</span>
<a name="l00503"></a>00503 <span class="preprocessor"></span><span class="preprocessor"># are prepended to each string.  This allows one to define TeX macros which can be</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span><span class="preprocessor"># used in every problem. Currently there is no default F&lt;tthPreamble.tex&gt; file, so</span>
<a name="l00505"></a>00505 <span class="preprocessor"></span><span class="preprocessor"># if the file is not present in the course template directory no TeX macro</span>
<a name="l00506"></a>00506 <span class="preprocessor"></span><span class="preprocessor"># definitions are prepended. TtH already understands most LaTeX commands, but will</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span><span class="preprocessor"># not in general know AMS-LaTeX commands.</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00509"></a>00509 <span class="preprocessor"></span><span class="preprocessor"># This macro contains code which is system dependent and may need to be modified</span>
<a name="l00510"></a>00510 <span class="preprocessor"></span><span class="preprocessor"># to run on different systems.</span>
<a name="l00511"></a>00511 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00512"></a>00512 <span class="preprocessor"></span><span class="preprocessor"># =cut</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00514"></a>00514 <span class="preprocessor"></span><span class="preprocessor"># # the contents of this file will not change during problem compilation it</span>
<a name="l00515"></a>00515 <span class="preprocessor"></span><span class="preprocessor"># # only needs to be read once. however, the contents of the file may change,</span>
<a name="l00516"></a>00516 <span class="preprocessor"></span><span class="preprocessor"># # and indeed the file refered to may change, between rendering passes. thus,</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span><span class="preprocessor"># # we need to keep track of the file name and the mtime as well.</span>
<a name="l00518"></a>00518 <span class="preprocessor"></span><span class="preprocessor"># # ^variable my $tthPreambleFile</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span><span class="preprocessor"># # ^variable my $tthPreambleMtime</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span><span class="preprocessor"># # ^variable my $tthPreambleContents</span>
<a name="l00521"></a>00521 <span class="preprocessor"></span><span class="preprocessor"># my ($tthPreambleFile, $tthPreambleMtime, $tthPreambleContents);</span>
<a name="l00522"></a>00522 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00523"></a>00523 <span class="preprocessor"></span><span class="preprocessor"># # ^function tth</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $templateDirectory</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{externalTTHPath}</span>
<a name="l00526"></a>00526 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $tthPreambleFile</span>
<a name="l00527"></a>00527 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $tthPreambleMtime</span>
<a name="l00528"></a>00528 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $tthPreambleContents</span>
<a name="l00529"></a>00529 <span class="preprocessor"></span><span class="preprocessor"># sub tth {</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span><span class="preprocessor">#   my $inputString = shift;</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l00532"></a>00532 <span class="preprocessor"></span><span class="preprocessor">#   my $thisFile = &quot;${templateDirectory}tthPreamble.tex&quot; if -r &quot;${templateDirectory}tthPreamble.tex&quot;;</span>
<a name="l00533"></a>00533 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l00534"></a>00534 <span class="preprocessor"></span><span class="preprocessor">#   if (defined $thisFile) {</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span><span class="preprocessor">#       my $thisMtime = (stat $thisFile)[9];</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span><span class="preprocessor">#       my $load = </span>
<a name="l00537"></a>00537 <span class="preprocessor"></span><span class="preprocessor">#           # load preamble if we haven&#39;t loaded it ever</span>
<a name="l00538"></a>00538 <span class="preprocessor"></span><span class="preprocessor">#           (not defined $tthPreambleFile or not defined $tthPreambleMtime or not defined $tthPreambleContents)</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span><span class="preprocessor">#               ||</span>
<a name="l00540"></a>00540 <span class="preprocessor"></span><span class="preprocessor">#           # load if the file path has changed</span>
<a name="l00541"></a>00541 <span class="preprocessor"></span><span class="preprocessor">#           ($tthPreambleFile ne $thisFile)</span>
<a name="l00542"></a>00542 <span class="preprocessor"></span><span class="preprocessor">#               ||</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span><span class="preprocessor">#           # load if the file has been modified</span>
<a name="l00544"></a>00544 <span class="preprocessor"></span><span class="preprocessor">#           ($tthPreambleMtime &lt; $thisMtime);</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span><span class="preprocessor">#       </span>
<a name="l00546"></a>00546 <span class="preprocessor"></span><span class="preprocessor">#       if ($load) {</span>
<a name="l00547"></a>00547 <span class="preprocessor"></span><span class="preprocessor">#           local(*TTHIN);</span>
<a name="l00548"></a>00548 <span class="preprocessor"></span><span class="preprocessor">#           open (TTHIN, &quot;${templateDirectory}tthPreamble.tex&quot;) || die &quot;Can&#39;t open file ${templateDirectory}tthPreamble.tex&quot;;</span>
<a name="l00549"></a>00549 <span class="preprocessor"></span><span class="preprocessor">#           local($/);</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span><span class="preprocessor">#           $/ = undef;</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span><span class="preprocessor">#           $tthPreambleContents = &lt;TTHIN&gt;;</span>
<a name="l00552"></a>00552 <span class="preprocessor"></span><span class="preprocessor">#           close(TTHIN);</span>
<a name="l00553"></a>00553 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00554"></a>00554 <span class="preprocessor"></span><span class="preprocessor">#           $tthPreambleContents =~ s/(.)\n/$1%\n/g;  # thanks to Jim Martino</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span><span class="preprocessor">#                                                     # each line in the definition file</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span><span class="preprocessor">#                                                     # should end with a % to prevent</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span><span class="preprocessor">#                                                     # adding supurious paragraphs to output.</span>
<a name="l00558"></a>00558 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00559"></a>00559 <span class="preprocessor"></span><span class="preprocessor">#           $tthPreambleContents .=&quot;%\n&quot;;             # solves the problem if the file doesn&#39;t end with a return.</span>
<a name="l00560"></a>00560 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00561"></a>00561 <span class="preprocessor"></span><span class="preprocessor">#   } else {</span>
<a name="l00562"></a>00562 <span class="preprocessor"></span><span class="preprocessor">#       $tthPreambleContents = &quot;&quot;;</span>
<a name="l00563"></a>00563 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00564"></a>00564 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l00565"></a>00565 <span class="preprocessor"></span><span class="preprocessor">#     $inputString = $tthPreambleContents . $inputString;</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span><span class="preprocessor">#     $inputString    = &quot;&lt;&lt;END_OF_TTH_INPUT_STRING;\n\n\n&quot; . $inputString . &quot;\nEND_OF_TTH_INPUT_STRING\necho \&quot;\&quot; &gt;/dev/null&quot;; #it&#39;s not clear why another command is needed.</span>
<a name="l00567"></a>00567 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00568"></a>00568 <span class="preprocessor"></span><span class="preprocessor">#   # $tthpath is now taken from $Global::externalTTHPath via %envir.</span>
<a name="l00569"></a>00569 <span class="preprocessor"></span><span class="preprocessor">#     my $tthpath     = $envir{externalTTHPath};</span>
<a name="l00570"></a>00570 <span class="preprocessor"></span><span class="preprocessor">#     my $out;</span>
<a name="l00571"></a>00571 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00572"></a>00572 <span class="preprocessor"></span><span class="preprocessor">#     if (-x $tthpath ) {</span>
<a name="l00573"></a>00573 <span class="preprocessor"></span><span class="preprocessor">#       my $tthcmd      = &quot;$tthpath -L -f5 -u -r  2&gt;/dev/null &quot; . $inputString;</span>
<a name="l00574"></a>00574 <span class="preprocessor"></span><span class="preprocessor">#       if (open(TTH, &quot;$tthcmd   |&quot;)) {</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span><span class="preprocessor">#           local($/);</span>
<a name="l00576"></a>00576 <span class="preprocessor"></span><span class="preprocessor">#           $/ = undef;</span>
<a name="l00577"></a>00577 <span class="preprocessor"></span><span class="preprocessor">#           $out = &lt;TTH&gt;;</span>
<a name="l00578"></a>00578 <span class="preprocessor"></span><span class="preprocessor">#           $/ = &quot;\n&quot;;</span>
<a name="l00579"></a>00579 <span class="preprocessor"></span><span class="preprocessor">#           close(TTH);</span>
<a name="l00580"></a>00580 <span class="preprocessor"></span><span class="preprocessor">#       }else {</span>
<a name="l00581"></a>00581 <span class="preprocessor"></span><span class="preprocessor">#           $out = &quot;&lt;BR&gt;there has been an error in executing $tthcmd&lt;BR&gt;&quot;;</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00583"></a>00583 <span class="preprocessor"></span><span class="preprocessor">#   } else {</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span><span class="preprocessor">#       $out = &quot;&lt;BR&gt; Can&#39;t execute the program tth at |$tthpath|&lt;BR&gt;&quot;;</span>
<a name="l00585"></a>00585 <span class="preprocessor"></span><span class="preprocessor">#     }</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00587"></a>00587 <span class="preprocessor"></span><span class="preprocessor">#     $out;</span>
<a name="l00588"></a>00588 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00589"></a>00589 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00590"></a>00590 <span class="preprocessor"></span><span class="preprocessor"># # possible solution to the tth font problem?  Works only for iCab.</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span><span class="preprocessor"># # ^function symbolConvert</span>
<a name="l00592"></a>00592 <span class="preprocessor"></span><span class="preprocessor"># sub symbolConvert {</span>
<a name="l00593"></a>00593 <span class="preprocessor"></span><span class="preprocessor">#   my  $string = shift;</span>
<a name="l00594"></a>00594 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\x5C/\&amp;#092;/g;        #\      92                       &amp;#092;</span>
<a name="l00595"></a>00595 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\x7B/\&amp;#123;/g;        #{      123                       &amp;#123;</span>
<a name="l00596"></a>00596 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\x7D/\&amp;#125;/g;        #}      125                       &amp;#125;</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xE7/\&amp;#193;/g;        #Á      231                       &amp;#193;</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xE6/\&amp;#202;/g;        #Ê      230                       &amp;#202;</span>
<a name="l00599"></a>00599 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xE8/\&amp;#203;/g;        #Ë      232                       &amp;#203;</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xF3/\&amp;#219;/g;        #Û      243                       &amp;#219;</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xA5/\&amp;bull;/g;        #      165                       &amp;bull;</span>
<a name="l00602"></a>00602 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xB2/\&amp;le;/g;          #¾      178                       &amp;le;</span>
<a name="l00603"></a>00603 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xB3/\&amp;ge;/g;          #      179                       &amp;ge;</span>
<a name="l00604"></a>00604 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xB6/\&amp;part;/g;        #      182                       &amp;part;</span>
<a name="l00605"></a>00605 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xCE/\&amp;#338;/g;        #      206                       &amp;#338;</span>
<a name="l00606"></a>00606 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xD6/\&amp;#732/g;         #÷      214                       &amp;#732;</span>
<a name="l00607"></a>00607 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xD9/\&amp;Yuml;/g;        #      217                       &amp;Yuml;</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xDA/\&amp;frasl;/g;       #      218                       &amp;frasl;</span>
<a name="l00609"></a>00609 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xF5/\&amp;#305;/g;        #      245                       &amp;#305</span>
<a name="l00610"></a>00610 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xF6/\&amp;#710;/g;        #      246                       &amp;#710;</span>
<a name="l00611"></a>00611 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xF7/\&amp;#193;/g;        #      247                       &amp;#193;</span>
<a name="l00612"></a>00612 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xF8/\&amp;#175;/g;        #¯      248                       &amp;#175;</span>
<a name="l00613"></a>00613 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xF9/\&amp;#728;/g;        #      249                       &amp;#728;</span>
<a name="l00614"></a>00614 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xFA/\&amp;#729;/g;        #      250                       &amp;#729;</span>
<a name="l00615"></a>00615 <span class="preprocessor"></span><span class="preprocessor">#   $string =~ s/\xFB/\&amp;#730;;/g;       #      251                       &amp;#730;</span>
<a name="l00616"></a>00616 <span class="preprocessor"></span><span class="preprocessor">#   $string;</span>
<a name="l00617"></a>00617 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00618"></a>00618 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00619"></a>00619 <span class="preprocessor"></span><span class="preprocessor"># # ----- ----- ----- -----</span>
<a name="l00620"></a>00620 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00621"></a>00621 <span class="preprocessor"></span><span class="preprocessor"># =head2 [DEPRECATED] math2img</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00623"></a>00623 <span class="preprocessor"></span><span class="preprocessor">#   # returns an IMG tag pointing to an image version of the supplied TeX</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span><span class="preprocessor">#   math2img($texString);</span>
<a name="l00625"></a>00625 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00626"></a>00626 <span class="preprocessor"></span><span class="preprocessor"># This macro was used by the HTML_img display mode, which no longer exists.</span>
<a name="l00627"></a>00627 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00628"></a>00628 <span class="preprocessor"></span><span class="preprocessor"># =cut</span>
<a name="l00629"></a>00629 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00630"></a>00630 <span class="preprocessor"></span><span class="preprocessor"># # ^variable my $math2imgCount</span>
<a name="l00631"></a>00631 <span class="preprocessor"></span><span class="preprocessor"># my $math2imgCount = 0;</span>
<a name="l00632"></a>00632 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00633"></a>00633 <span class="preprocessor"></span><span class="preprocessor"># # ^function math2img</span>
<a name="l00634"></a>00634 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $math2imgCount</span>
<a name="l00635"></a>00635 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{templateDirectory}</span>
<a name="l00636"></a>00636 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{fileName}</span>
<a name="l00637"></a>00637 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{studentLogin}</span>
<a name="l00638"></a>00638 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{setNumber}</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{probNum}</span>
<a name="l00640"></a>00640 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{tempURL}</span>
<a name="l00641"></a>00641 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{refreshMath2img}</span>
<a name="l00642"></a>00642 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{dvipngTempDir}</span>
<a name="l00643"></a>00643 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{externalLaTeXPath}</span>
<a name="l00644"></a>00644 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{externalDvipngPath}</span>
<a name="l00645"></a>00645 <span class="preprocessor"></span><span class="preprocessor"># sub math2img {</span>
<a name="l00646"></a>00646 <span class="preprocessor"></span><span class="preprocessor">#   my $tex = shift;</span>
<a name="l00647"></a>00647 <span class="preprocessor"></span><span class="preprocessor">#   my $mode = shift;</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00649"></a>00649 <span class="preprocessor"></span><span class="preprocessor">#   my $sourcePath = $envir{templateDirectory} . &quot;/&quot; . $envir{fileName};</span>
<a name="l00650"></a>00650 <span class="preprocessor"></span><span class="preprocessor">#   my $tempFile = &quot;m2i/$envir{studentLogin}.$envir{setNumber}.$envir{probNum}.&quot;</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span><span class="preprocessor">#       . $math2imgCount++ . &quot;.png&quot;;</span>
<a name="l00652"></a>00652 <span class="preprocessor"></span><span class="preprocessor">#   my $tempPath = surePathToTmpFile($tempFile); #my $tempPath = &quot;$envir{tempDirectory}$tempFile&quot;;</span>
<a name="l00653"></a>00653 <span class="preprocessor"></span><span class="preprocessor">#   my $tempURL = &quot;$envir{tempURL}/$tempFile&quot;;</span>
<a name="l00654"></a>00654 <span class="preprocessor"></span><span class="preprocessor">#   my $forceRefresh = $envir{refreshMath2img};</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span><span class="preprocessor">#   my $imageMissing = not -e $tempPath;</span>
<a name="l00656"></a>00656 <span class="preprocessor"></span><span class="preprocessor">#   my $imageStale   = (stat $sourcePath)[9] &gt; (stat $tempPath)[9] if -e $tempPath;</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span><span class="preprocessor">#   if ($forceRefresh or $imageMissing or $imageStale) {</span>
<a name="l00658"></a>00658 <span class="preprocessor"></span><span class="preprocessor">#       # image file doesn&#39;t exist, or source file is newer then image file</span>
<a name="l00659"></a>00659 <span class="preprocessor"></span><span class="preprocessor">#       #warn &quot;math2img: refreshMath2img forcing image generation for $tempFile\n&quot; if $forceRefresh;</span>
<a name="l00660"></a>00660 <span class="preprocessor"></span><span class="preprocessor">#       #warn &quot;math2img: $tempFile doesn&#39;t exist, so generating it\n&quot; if $imageMissing;</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span><span class="preprocessor">#       #warn &quot;math2img: source file (&quot;, (stat $sourcePath)[9], &quot;) is newer than image file (&quot;,</span>
<a name="l00662"></a>00662 <span class="preprocessor"></span><span class="preprocessor">#       #   (stat $tempPath)[9], &quot;) so re-generating image\n&quot; if $imageStale;</span>
<a name="l00663"></a>00663 <span class="preprocessor"></span><span class="preprocessor">#       if (-e $tempPath) {</span>
<a name="l00664"></a>00664 <span class="preprocessor"></span><span class="preprocessor">#           unlink $tempPath or die &quot;Failed to delete stale math2img file $tempPath: $!&quot;;</span>
<a name="l00665"></a>00665 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00666"></a>00666 <span class="preprocessor"></span><span class="preprocessor">#       dvipng(</span>
<a name="l00667"></a>00667 <span class="preprocessor"></span><span class="preprocessor">#           $envir{dvipngTempDir}, $envir{externalLaTeXPath},</span>
<a name="l00668"></a>00668 <span class="preprocessor"></span><span class="preprocessor">#           $envir{externalDvipngPath}, $tex, $tempPath</span>
<a name="l00669"></a>00669 <span class="preprocessor"></span><span class="preprocessor">#       );</span>
<a name="l00670"></a>00670 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00671"></a>00671 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00672"></a>00672 <span class="preprocessor"></span><span class="preprocessor">#   if (-e $tempPath) {</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span><span class="preprocessor">#       return &quot;&lt;img align=\&quot;middle\&quot; src=\&quot;$tempURL\&quot; alt=\&quot;$tex\&quot;&gt;&quot;            if $mode eq &quot;inline&quot;;</span>
<a name="l00674"></a>00674 <span class="preprocessor"></span><span class="preprocessor">#       return &quot;&lt;div align=\&quot;center\&quot;&gt;&lt;img src=\&quot;$tempURL\&quot; alt=\&quot;$tex\&quot;&gt;&lt;/div&gt;&quot; if $mode eq &quot;display&quot;;</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span><span class="preprocessor">#   } else {</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span><span class="preprocessor">#       return &quot;&lt;b&gt;[math2img failed]&lt;/b&gt;&quot;;</span>
<a name="l00677"></a>00677 <span class="preprocessor"></span><span class="preprocessor">#       # it might be nice to call tth here as a fallback instead:</span>
<a name="l00678"></a>00678 <span class="preprocessor"></span><span class="preprocessor">#       #return tth($tex);</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00680"></a>00680 <span class="preprocessor"></span><span class="preprocessor"># };</span>
<a name="l00681"></a>00681 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00682"></a>00682 <span class="preprocessor"></span><span class="preprocessor"># =head2 [DEPRECATED] dvipng</span>
<a name="l00683"></a>00683 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00684"></a>00684 <span class="preprocessor"></span><span class="preprocessor">#   dvipng($working_directory, $latex_path, $dvipng_path, $tex_string, $target_path)</span>
<a name="l00685"></a>00685 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00686"></a>00686 <span class="preprocessor"></span><span class="preprocessor"># This macro was used by the HTML_img display mode, which no longer exists.</span>
<a name="l00687"></a>00687 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00688"></a>00688 <span class="preprocessor"></span><span class="preprocessor"># =cut</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00690"></a>00690 <span class="preprocessor"></span><span class="preprocessor"># # copied from IO.pm for backward compatibility with WeBWorK1.8;</span>
<a name="l00691"></a>00691 <span class="preprocessor"></span><span class="preprocessor"># # ^function dvipng</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span><span class="preprocessor"># sub dvipng($$$$$) {</span>
<a name="l00693"></a>00693 <span class="preprocessor"></span><span class="preprocessor">#   my (</span>
<a name="l00694"></a>00694 <span class="preprocessor"></span><span class="preprocessor">#       $wd,        # working directory, for latex and dvipng garbage</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span><span class="preprocessor">#                   # (must already exist!)</span>
<a name="l00696"></a>00696 <span class="preprocessor"></span><span class="preprocessor">#       $latex,     # path to latex binary</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span><span class="preprocessor">#       $dvipng,    # path to dvipng binary</span>
<a name="l00698"></a>00698 <span class="preprocessor"></span><span class="preprocessor">#       $tex,       # tex string representing equation</span>
<a name="l00699"></a>00699 <span class="preprocessor"></span><span class="preprocessor">#       $targetPath # location of resulting image file</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span><span class="preprocessor">#   ) = @_;</span>
<a name="l00701"></a>00701 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00702"></a>00702 <span class="preprocessor"></span><span class="preprocessor">#   my $dvipngBroken = 0;</span>
<a name="l00703"></a>00703 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00704"></a>00704 <span class="preprocessor"></span><span class="preprocessor">#   my $texFile  = &quot;$wd/equation.tex&quot;;</span>
<a name="l00705"></a>00705 <span class="preprocessor"></span><span class="preprocessor">#   my $dviFile  = &quot;$wd/equation.dvi&quot;;</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span><span class="preprocessor">#   my $dviFile2 = &quot;$wd/equationequation.dvi&quot;;</span>
<a name="l00707"></a>00707 <span class="preprocessor"></span><span class="preprocessor">#   my $dviCall  = &quot;equation&quot;;</span>
<a name="l00708"></a>00708 <span class="preprocessor"></span><span class="preprocessor">#   my $pngFile  = &quot;$wd/equation1.png&quot;;</span>
<a name="l00709"></a>00709 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00710"></a>00710 <span class="preprocessor"></span><span class="preprocessor">#   unless (-e $wd) {</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span><span class="preprocessor">#       die &quot;dvipng working directory $wd doesn&#39;t exist -- caller should have created it for us!\n&quot;;</span>
<a name="l00712"></a>00712 <span class="preprocessor"></span><span class="preprocessor">#       return 0;</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00715"></a>00715 <span class="preprocessor"></span><span class="preprocessor">#   # write the tex file</span>
<a name="l00716"></a>00716 <span class="preprocessor"></span><span class="preprocessor">#   local *TEX;</span>
<a name="l00717"></a>00717 <span class="preprocessor"></span><span class="preprocessor">#   open TEX, &quot;&gt;&quot;, $texFile or warn &quot;Failed to create $texFile: $!&quot;;</span>
<a name="l00718"></a>00718 <span class="preprocessor"></span><span class="preprocessor">#   print TEX &lt;&lt;&#39;EOF&#39;;</span>
<a name="l00719"></a>00719 <span class="preprocessor"></span><span class="preprocessor"># % BEGIN HEADER</span>
<a name="l00720"></a>00720 <span class="preprocessor"></span><span class="preprocessor"># \batchmode</span>
<a name="l00721"></a>00721 <span class="preprocessor"></span><span class="preprocessor"># \documentclass[12pt]{article}</span>
<a name="l00722"></a>00722 <span class="preprocessor"></span><span class="preprocessor"># \usepackage{amsmath,amsfonts,amssymb}</span>
<a name="l00723"></a>00723 <span class="preprocessor"></span><span class="preprocessor"># \def\gt{&gt;}</span>
<a name="l00724"></a>00724 <span class="preprocessor"></span><span class="preprocessor"># \def\lt{&lt;}</span>
<a name="l00725"></a>00725 <span class="preprocessor"></span><span class="preprocessor"># \usepackage[active,textmath,displaymath]{preview}</span>
<a name="l00726"></a>00726 <span class="preprocessor"></span><span class="preprocessor"># \begin{document}</span>
<a name="l00727"></a>00727 <span class="preprocessor"></span><span class="preprocessor"># % END HEADER</span>
<a name="l00728"></a>00728 <span class="preprocessor"></span><span class="preprocessor"># EOF</span>
<a name="l00729"></a>00729 <span class="preprocessor"></span><span class="preprocessor">#   print TEX &quot;\\( \\displaystyle{$tex} \\)\n&quot;;</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span><span class="preprocessor">#   print TEX &lt;&lt;&#39;EOF&#39;;</span>
<a name="l00731"></a>00731 <span class="preprocessor"></span><span class="preprocessor"># % BEGIN FOOTER</span>
<a name="l00732"></a>00732 <span class="preprocessor"></span><span class="preprocessor"># \end{document}</span>
<a name="l00733"></a>00733 <span class="preprocessor"></span><span class="preprocessor"># % END FOOTER</span>
<a name="l00734"></a>00734 <span class="preprocessor"></span><span class="preprocessor"># EOF</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span><span class="preprocessor">#   close TEX;</span>
<a name="l00736"></a>00736 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00737"></a>00737 <span class="preprocessor"></span><span class="preprocessor">#   # call latex</span>
<a name="l00738"></a>00738 <span class="preprocessor"></span><span class="preprocessor">#   system &quot;cd $wd &amp;&amp; $latex $texFile &gt; /dev/null&quot;</span>
<a name="l00739"></a>00739 <span class="preprocessor"></span><span class="preprocessor">#       and warn &quot;Failed to call $latex with $texFile: $!&quot;;</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00741"></a>00741 <span class="preprocessor"></span><span class="preprocessor">#   unless (-e $dviFile) {</span>
<a name="l00742"></a>00742 <span class="preprocessor"></span><span class="preprocessor">#       warn &quot;Failed to generate DVI file $dviFile&quot;;</span>
<a name="l00743"></a>00743 <span class="preprocessor"></span><span class="preprocessor">#       return 0;</span>
<a name="l00744"></a>00744 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00745"></a>00745 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00746"></a>00746 <span class="preprocessor"></span><span class="preprocessor">#   if ($dvipngBroken) {</span>
<a name="l00747"></a>00747 <span class="preprocessor"></span><span class="preprocessor">#       # change the name of the DVI file to get around dvipng&#39;s</span>
<a name="l00748"></a>00748 <span class="preprocessor"></span><span class="preprocessor">#       # crackheadedness. This is no longer needed with the newest</span>
<a name="l00749"></a>00749 <span class="preprocessor"></span><span class="preprocessor">#       # version of dvipng (10 something)</span>
<a name="l00750"></a>00750 <span class="preprocessor"></span><span class="preprocessor">#       system &quot;/bin/mv&quot;, $dviFile, $dviFile2;</span>
<a name="l00751"></a>00751 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00752"></a>00752 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00753"></a>00753 <span class="preprocessor"></span><span class="preprocessor">#   # call dvipng -- using warn instead of die passes some extra information</span>
<a name="l00754"></a>00754 <span class="preprocessor"></span><span class="preprocessor">#   # back to the user the complete warning is still printed in the apache</span>
<a name="l00755"></a>00755 <span class="preprocessor"></span><span class="preprocessor">#   # error log and a simple message (math2img failed) is returned to the</span>
<a name="l00756"></a>00756 <span class="preprocessor"></span><span class="preprocessor">#   # webpage.</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span><span class="preprocessor">#   my $cmdout;</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span><span class="preprocessor">#   $cmdout = system &quot;cd $wd &amp;&amp; $dvipng $dviCall &gt; /dev/null&quot;</span>
<a name="l00759"></a>00759 <span class="preprocessor"></span><span class="preprocessor">#       and warn &quot;Failed to call$dvipng with $dviCall: $! with signal $cmdout&quot;;</span>
<a name="l00760"></a>00760 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00761"></a>00761 <span class="preprocessor"></span><span class="preprocessor">#   unless (-e $pngFile) {</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span><span class="preprocessor">#       warn &quot;Failed to create PNG file $pngFile&quot;;</span>
<a name="l00763"></a>00763 <span class="preprocessor"></span><span class="preprocessor">#       return 0;</span>
<a name="l00764"></a>00764 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00765"></a>00765 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00766"></a>00766 <span class="preprocessor"></span><span class="preprocessor">#   $cmdout = system &quot;/bin/mv&quot;, $pngFile, $targetPath and warn &quot;Failed to mv: /bin/mv  $pngFile $targetPath $!. Call returned $cmdout. \n&quot;;</span>
<a name="l00767"></a>00767 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00768"></a>00768 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00769"></a>00769 <span class="preprocessor"></span><span class="preprocessor"># ----- ----- ----- -----</span>
<a name="l00770"></a>00770 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00771"></a>00771 <span class="preprocessor"></span><span class="preprocessor"># =head2  alias</span>
<a name="l00772"></a>00772 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00773"></a>00773 <span class="preprocessor"></span><span class="preprocessor">#   # In HTML modes, returns the URL of a web-friendly version of the specified file.</span>
<a name="l00774"></a>00774 <span class="preprocessor"></span><span class="preprocessor">#   # In TeX mode, returns the path to a TeX-friendly version of the specified file.</span>
<a name="l00775"></a>00775 <span class="preprocessor"></span><span class="preprocessor">#   alias($pathToFile);</span>
<a name="l00776"></a>00776 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00777"></a>00777 <span class="preprocessor"></span><span class="preprocessor"># alias allows you to refer to auxiliary files which are in a directory along with</span>
<a name="l00778"></a>00778 <span class="preprocessor"></span><span class="preprocessor"># the problem definition. In addition alias creates an EPS version of GIF or PNG</span>
<a name="l00779"></a>00779 <span class="preprocessor"></span><span class="preprocessor"># files when called in TeX mode.</span>
<a name="l00780"></a>00780 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00781"></a>00781 <span class="preprocessor"></span><span class="preprocessor"># As a rule auxiliary files that are used by a number of problems in a course</span>
<a name="l00782"></a>00782 <span class="preprocessor"></span><span class="preprocessor"># should be placed in C&lt;html/gif&gt; or C&lt;html&gt; or in a subdirectory of the C&lt;html&gt;</span>
<a name="l00783"></a>00783 <span class="preprocessor"></span><span class="preprocessor"># directory, while auxiliary files which are used in only one problem should be</span>
<a name="l00784"></a>00784 <span class="preprocessor"></span><span class="preprocessor"># placed in the same directory as the problem in order to make the problem more</span>
<a name="l00785"></a>00785 <span class="preprocessor"></span><span class="preprocessor"># portable.</span>
<a name="l00786"></a>00786 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00787"></a>00787 <span class="preprocessor"></span><span class="preprocessor"># =head3 Specific behavior of the alias macro</span>
<a name="l00788"></a>00788 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00789"></a>00789 <span class="preprocessor"></span><span class="preprocessor"># =head4 Files in the html subdirectory</span>
<a name="l00790"></a>00790 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00791"></a>00791 <span class="preprocessor"></span><span class="preprocessor"># =over</span>
<a name="l00792"></a>00792 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00793"></a>00793 <span class="preprocessor"></span><span class="preprocessor"># =item When not in TeX mode</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00795"></a>00795 <span class="preprocessor"></span><span class="preprocessor"># If the file lies under the F&lt;html&gt; subdirectory, then the approriate URL for the</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span><span class="preprocessor"># file is returned. Since the F&lt;html&gt; subdirectory is already accessible to the</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span><span class="preprocessor"># webserver no other changes need to be made. The file path for this type of file</span>
<a name="l00798"></a>00798 <span class="preprocessor"></span><span class="preprocessor"># should be the complete file path. The path should start with the prefix defined</span>
<a name="l00799"></a>00799 <span class="preprocessor"></span><span class="preprocessor"># in $courseDirs{html_temp} in global.conf.</span>
<a name="l00800"></a>00800 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00801"></a>00801 <span class="preprocessor"></span><span class="preprocessor"># =item When in TeX mode</span>
<a name="l00802"></a>00802 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00803"></a>00803 <span class="preprocessor"></span><span class="preprocessor"># GIF and PNG files will be translated into EPS files and placed in the directory</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span><span class="preprocessor"># F&lt;tmp/eps&gt;. The full path to this file is returned for use by TeX in producing</span>
<a name="l00805"></a>00805 <span class="preprocessor"></span><span class="preprocessor"># the hard copy. The conversion is done by a system dependent commands defined in</span>
<a name="l00806"></a>00806 <span class="preprocessor"></span><span class="preprocessor"># F&lt;global.conf&gt; $externalPrograms{gif2eps} (for GIF images) or</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span><span class="preprocessor"># $externalPrograms{png2eps} (for PNG images). The URLs for the other files are</span>
<a name="l00808"></a>00808 <span class="preprocessor"></span><span class="preprocessor"># produced as in non-TeX mode but will of course not be usable to TeX.</span>
<a name="l00809"></a>00809 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00810"></a>00810 <span class="preprocessor"></span><span class="preprocessor"># =back</span>
<a name="l00811"></a>00811 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00812"></a>00812 <span class="preprocessor"></span><span class="preprocessor"># =head4 Files in the tmp subdirectory</span>
<a name="l00813"></a>00813 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00814"></a>00814 <span class="preprocessor"></span><span class="preprocessor"># =over</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00816"></a>00816 <span class="preprocessor"></span><span class="preprocessor"># =item When not in TeX mode</span>
<a name="l00817"></a>00817 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00818"></a>00818 <span class="preprocessor"></span><span class="preprocessor"># If the file lies under the F&lt;tmp&gt; subdirectory, then the approriate URL for the</span>
<a name="l00819"></a>00819 <span class="preprocessor"></span><span class="preprocessor"># file is created. Since the F&lt;tmp&gt; subdirectory is already accessible to the</span>
<a name="l00820"></a>00820 <span class="preprocessor"></span><span class="preprocessor"># webserver no other changes need to be made. The file path for this type of file</span>
<a name="l00821"></a>00821 <span class="preprocessor"></span><span class="preprocessor"># should be the complete file path. The path should start with the prefix defined</span>
<a name="l00822"></a>00822 <span class="preprocessor"></span><span class="preprocessor"># in $courseDirs{html_temp} in global.conf.</span>
<a name="l00823"></a>00823 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00824"></a>00824 <span class="preprocessor"></span><span class="preprocessor"># =item When in TeX mode</span>
<a name="l00825"></a>00825 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00826"></a>00826 <span class="preprocessor"></span><span class="preprocessor"># GIF and PNG files will be translated into EPS files and placed in the directory</span>
<a name="l00827"></a>00827 <span class="preprocessor"></span><span class="preprocessor"># F&lt;tmp/eps&gt;. The full path to this file is returned for use by TeX in producing</span>
<a name="l00828"></a>00828 <span class="preprocessor"></span><span class="preprocessor"># the hard copy. The conversion is done by a system dependent commands defined in</span>
<a name="l00829"></a>00829 <span class="preprocessor"></span><span class="preprocessor"># F&lt;global.conf&gt; $externalPrograms{gif2eps} (for GIF images) or</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span><span class="preprocessor"># $externalPrograms{png2eps} (for PNG images). The URLs for the other files are</span>
<a name="l00831"></a>00831 <span class="preprocessor"></span><span class="preprocessor"># produced as in non-TeX mode but will of course not be usable to TeX.</span>
<a name="l00832"></a>00832 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00833"></a>00833 <span class="preprocessor"></span><span class="preprocessor"># =back</span>
<a name="l00834"></a>00834 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00835"></a>00835 <span class="preprocessor"></span><span class="preprocessor"># =head4 Files in the course template subdirectory</span>
<a name="l00836"></a>00836 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00837"></a>00837 <span class="preprocessor"></span><span class="preprocessor"># =over</span>
<a name="l00838"></a>00838 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00839"></a>00839 <span class="preprocessor"></span><span class="preprocessor"># =item When not in TeX mode</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00841"></a>00841 <span class="preprocessor"></span><span class="preprocessor"># If the file lies under the course templates subdirectory, it is assumed to lie</span>
<a name="l00842"></a>00842 <span class="preprocessor"></span><span class="preprocessor"># in subdirectory rooted in the directory containing the problem template file. An</span>
<a name="l00843"></a>00843 <span class="preprocessor"></span><span class="preprocessor"># alias is created under the F&lt;html/tmp/gif&gt; or F&lt;html/tmp/html&gt; directory and</span>
<a name="l00844"></a>00844 <span class="preprocessor"></span><span class="preprocessor"># linked to the original file. The file path for this type of file is a relative</span>
<a name="l00845"></a>00845 <span class="preprocessor"></span><span class="preprocessor"># path rooted at the directory containing the problem template file.</span>
<a name="l00846"></a>00846 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00847"></a>00847 <span class="preprocessor"></span><span class="preprocessor"># =item When in TeX mode</span>
<a name="l00848"></a>00848 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00849"></a>00849 <span class="preprocessor"></span><span class="preprocessor"># GIF and PNG files will be translated into EPS files and placed in the directory</span>
<a name="l00850"></a>00850 <span class="preprocessor"></span><span class="preprocessor"># F&lt;tmp/eps&gt;. The full path to this file is returned for use by TeX in producing</span>
<a name="l00851"></a>00851 <span class="preprocessor"></span><span class="preprocessor"># the hard copy. The conversion is done by a system dependent commands defined in</span>
<a name="l00852"></a>00852 <span class="preprocessor"></span><span class="preprocessor"># F&lt;global.conf&gt; $externalPrograms{gif2eps} (for GIF images) or</span>
<a name="l00853"></a>00853 <span class="preprocessor"></span><span class="preprocessor"># $externalPrograms{png2eps} (for PNG images). The URLs for the other files are</span>
<a name="l00854"></a>00854 <span class="preprocessor"></span><span class="preprocessor"># produced as in non-TeX mode but will of course not be usable to TeX.</span>
<a name="l00855"></a>00855 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00856"></a>00856 <span class="preprocessor"></span><span class="preprocessor"># =back</span>
<a name="l00857"></a>00857 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00858"></a>00858 <span class="preprocessor"></span><span class="preprocessor"># =cut</span>
<a name="l00859"></a>00859 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00860"></a>00860 <span class="preprocessor"></span>
<a name="l00861"></a>00861 <span class="preprocessor"># </span>
<a name="l00862"></a>00862 <span class="preprocessor"></span><span class="preprocessor"># # Currently gif, html and types are supported.</span>
<a name="l00863"></a>00863 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l00864"></a>00864 <span class="preprocessor"></span><span class="preprocessor"># # If the auxiliary file path has not extension then the extension .gif isassumed.</span>
<a name="l00865"></a>00865 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l00866"></a>00866 <span class="preprocessor"></span><span class="preprocessor"># # If the auxiliary file path leads to a file in the ${Global::htmlDirectory}</span>
<a name="l00867"></a>00867 <span class="preprocessor"></span><span class="preprocessor"># # no changes are made to the file path.</span>
<a name="l00868"></a>00868 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l00869"></a>00869 <span class="preprocessor"></span><span class="preprocessor"># # If the auxiliary file path is not complete, than it is assumed that it refers</span>
<a name="l00870"></a>00870 <span class="preprocessor"></span><span class="preprocessor"># # to a subdirectoy of the directory containing the problem..</span>
<a name="l00871"></a>00871 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l00872"></a>00872 <span class="preprocessor"></span><span class="preprocessor"># # The output is either the correct URL for the file</span>
<a name="l00873"></a>00873 <span class="preprocessor"></span><span class="preprocessor"># # or (in TeX mode) the complete path to the eps version of the file</span>
<a name="l00874"></a>00874 <span class="preprocessor"></span><span class="preprocessor"># # and can be used as input into the image macro.</span>
<a name="l00875"></a>00875 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l00876"></a>00876 <span class="preprocessor"></span><span class="preprocessor"># # surePathToTmpFile takes a path and outputs the complete path:</span>
<a name="l00877"></a>00877 <span class="preprocessor"></span><span class="preprocessor"># # ${main::htmlDirectory}/tmp/path</span>
<a name="l00878"></a>00878 <span class="preprocessor"></span><span class="preprocessor"># # It insures that all of the directories in the path have been created,</span>
<a name="l00879"></a>00879 <span class="preprocessor"></span><span class="preprocessor"># # but does not create the</span>
<a name="l00880"></a>00880 <span class="preprocessor"></span><span class="preprocessor"># # final file.</span>
<a name="l00881"></a>00881 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00882"></a>00882 <span class="preprocessor"></span><span class="preprocessor"># # For postscript printing, alias generates an eps version of the gif image and places</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span><span class="preprocessor"># # it in the directory eps.  This slows down downloading postscript versions somewhat,</span>
<a name="l00884"></a>00884 <span class="preprocessor"></span><span class="preprocessor"># # but not excessivevly.</span>
<a name="l00885"></a>00885 <span class="preprocessor"></span><span class="preprocessor"># # Alias does not do any garbage collection, so files and alias may accumulate and</span>
<a name="l00886"></a>00886 <span class="preprocessor"></span><span class="preprocessor"># # need to be removed manually or by a reaper daemon.</span>
<a name="l00887"></a>00887 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00888"></a>00888 <span class="preprocessor"></span><span class="preprocessor"># # This subroutine  has commands which will not work on non-UNIX environments.</span>
<a name="l00889"></a>00889 <span class="preprocessor"></span><span class="preprocessor"># # system(&quot;cat $gifSourceFile  | /usr/math/bin/giftopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn&gt;$adr_output&quot;) &amp;&amp;</span>
<a name="l00890"></a>00890 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00891"></a>00891 <span class="preprocessor"></span><span class="preprocessor"># # ^function alias</span>
<a name="l00892"></a>00892 <span class="preprocessor"></span><span class="preprocessor"># # ^uses %envir</span>
<a name="l00893"></a>00893 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{fileName}</span>
<a name="l00894"></a>00894 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{htmlDirectory}</span>
<a name="l00895"></a>00895 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{htmlURL}</span>
<a name="l00896"></a>00896 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{tempDirectory}</span>
<a name="l00897"></a>00897 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{tempURL}</span>
<a name="l00898"></a>00898 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{studentLogin}</span>
<a name="l00899"></a>00899 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{psvnNumber}</span>
<a name="l00900"></a>00900 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{setNumber}</span>
<a name="l00901"></a>00901 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{probNum}</span>
<a name="l00902"></a>00902 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{displayMode}</span>
<a name="l00903"></a>00903 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{externalGif2EpsPath}</span>
<a name="l00904"></a>00904 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{externalPng2EpsPath}</span>
<a name="l00905"></a>00905 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;surePathToTmpFile</span>
<a name="l00906"></a>00906 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;convertPath</span>
<a name="l00907"></a>00907 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;directoryFromPath</span>
<a name="l00908"></a>00908 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;fileFromPath</span>
<a name="l00909"></a>00909 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{texDisposition}</span>
<a name="l00910"></a>00910 <span class="preprocessor"></span>
<a name="l00911"></a>00911 <span class="preprocessor"># sub alias {</span>
<a name="l00912"></a>00912 <span class="preprocessor"></span><span class="preprocessor">#   # input is a path to the original auxiliary file</span>
<a name="l00913"></a>00913 <span class="preprocessor"></span><span class="preprocessor">#   my $envir               = eval(q!\%main::envir!);  # get the current root environment</span>
<a name="l00914"></a>00914 <span class="preprocessor"></span><span class="preprocessor">#       my $fileName            = $envir-&gt;{fileName};</span>
<a name="l00915"></a>00915 <span class="preprocessor"></span><span class="preprocessor">#   my $htmlDirectory       = $envir-&gt;{htmlDirectory};</span>
<a name="l00916"></a>00916 <span class="preprocessor"></span><span class="preprocessor">#   my $htmlURL             = $envir-&gt;{htmlURL};</span>
<a name="l00917"></a>00917 <span class="preprocessor"></span><span class="preprocessor">#   my $tempDirectory       = $envir-&gt;{tempDirectory};</span>
<a name="l00918"></a>00918 <span class="preprocessor"></span><span class="preprocessor">#   my $tempURL             = $envir-&gt;{tempURL};</span>
<a name="l00919"></a>00919 <span class="preprocessor"></span><span class="preprocessor">#   my $studentLogin        = $envir-&gt;{studentLogin};</span>
<a name="l00920"></a>00920 <span class="preprocessor"></span><span class="preprocessor">#   my $psvnNumber          = $envir-&gt;{psvnNumber};</span>
<a name="l00921"></a>00921 <span class="preprocessor"></span><span class="preprocessor">#   my $setNumber           = $envir-&gt;{setNumber};</span>
<a name="l00922"></a>00922 <span class="preprocessor"></span><span class="preprocessor">#   my $probNum             = $envir-&gt;{probNum};</span>
<a name="l00923"></a>00923 <span class="preprocessor"></span><span class="preprocessor">#   my $displayMode         = $envir-&gt;{displayMode};</span>
<a name="l00924"></a>00924 <span class="preprocessor"></span><span class="preprocessor">#     my $externalGif2EpsPath = $envir-&gt;{externalGif2EpsPath};</span>
<a name="l00925"></a>00925 <span class="preprocessor"></span><span class="preprocessor">#     my $externalPng2EpsPath = $envir-&gt;{externalPng2EpsPath};</span>
<a name="l00926"></a>00926 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00927"></a>00927 <span class="preprocessor"></span><span class="preprocessor">#   my $aux_file_path = shift @_;</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;Empty string used as input into the function alias&quot; unless $aux_file_path;</span>
<a name="l00929"></a>00929 <span class="preprocessor"></span><span class="preprocessor">#   #</span>
<a name="l00930"></a>00930 <span class="preprocessor"></span><span class="preprocessor">#   #  Find auxiliary files even when the main file is in tempates/tmpEdit</span>
<a name="l00931"></a>00931 <span class="preprocessor"></span><span class="preprocessor">#   #</span>
<a name="l00932"></a>00932 <span class="preprocessor"></span><span class="preprocessor">#   $fileName =~ s!(^|/)tmpEdit/!\1!;</span>
<a name="l00933"></a>00933 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00934"></a>00934 <span class="preprocessor"></span><span class="preprocessor">#   # problem specific data</span>
<a name="l00935"></a>00935 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The path to the current problem file template is not defined.&quot;     unless $fileName;</span>
<a name="l00936"></a>00936 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The current studentLogin is not defined &quot;                          unless $studentLogin;</span>
<a name="l00937"></a>00937 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The current problem set number is not defined&quot;                     if $setNumber eq &quot;&quot;; # allow for sets equal to 0</span>
<a name="l00938"></a>00938 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The current problem number is not defined&quot;                         if $probNum eq &quot;&quot;;</span>
<a name="l00939"></a>00939 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The current problem set version number (psvn) is not defined&quot;      unless defined($psvnNumber);</span>
<a name="l00940"></a>00940 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The displayMode is not defined&quot;                                    unless $displayMode;</span>
<a name="l00941"></a>00941 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00942"></a>00942 <span class="preprocessor"></span><span class="preprocessor">#   # required macros</span>
<a name="l00943"></a>00943 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The macro &amp;surePathToTmpFile can&#39;t be found&quot; unless defined(&amp;surePathToTmpFile);</span>
<a name="l00944"></a>00944 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The macro &amp;convertPath can&#39;t be found&quot; unless defined(&amp;convertPath);</span>
<a name="l00945"></a>00945 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The macro &amp;directoryFromPath can&#39;t be found&quot; unless defined(&amp;directoryFromPath);</span>
<a name="l00946"></a>00946 <span class="preprocessor"></span><span class="preprocessor">#   # warn &quot;The webwork server does not have permission to execute the gif2eps script at  ${externalGif2EpsPath}.&quot; unless ( -x &quot;${externalGif2EpsPath}&quot; );</span>
<a name="l00947"></a>00947 <span class="preprocessor"></span><span class="preprocessor">#   # warn &quot;The webwork server does not have permission to execute the png2eps script at ${externalPng2EpsPath}.&quot; unless ( -x &quot;${externalPng2EpsPath}&quot; );</span>
<a name="l00948"></a>00948 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00949"></a>00949 <span class="preprocessor"></span><span class="preprocessor">#   # required directory addresses (and URL address)</span>
<a name="l00950"></a>00950 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;htmlDirectory is not defined in $htmlDirectory&quot; unless $htmlDirectory;</span>
<a name="l00951"></a>00951 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;htmlURL is not defined in \$htmlURL&quot; unless $htmlURL;</span>
<a name="l00952"></a>00952 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;tempURL is not defined in \$tempURL&quot; unless $tempURL;</span>
<a name="l00953"></a>00953 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00954"></a>00954 <span class="preprocessor"></span><span class="preprocessor">#   # determine extension, if there is one</span>
<a name="l00955"></a>00955 <span class="preprocessor"></span><span class="preprocessor">#   # if extension exists, strip and use the value for $ext</span>
<a name="l00956"></a>00956 <span class="preprocessor"></span><span class="preprocessor">#   # files without extensions are considered to be picture files:</span>
<a name="l00957"></a>00957 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00958"></a>00958 <span class="preprocessor"></span><span class="preprocessor">#   my $ext;</span>
<a name="l00959"></a>00959 <span class="preprocessor"></span><span class="preprocessor">#   if ($aux_file_path =~ s/\.([^\.]*)$// ) {</span>
<a name="l00960"></a>00960 <span class="preprocessor"></span><span class="preprocessor">#       $ext = $1;</span>
<a name="l00961"></a>00961 <span class="preprocessor"></span><span class="preprocessor">#   } else {</span>
<a name="l00962"></a>00962 <span class="preprocessor"></span><span class="preprocessor">#       warn &quot;This file name $aux_file_path did not have an extension.&lt;BR&gt; &quot; .</span>
<a name="l00963"></a>00963 <span class="preprocessor"></span><span class="preprocessor">#            &quot;Every file name used as an argument to alias must have an extension.&lt;BR&gt; &quot; .</span>
<a name="l00964"></a>00964 <span class="preprocessor"></span><span class="preprocessor">#            &quot;The permissable extensions are .gif, .png, and .html .&lt;BR&gt;&quot;;</span>
<a name="l00965"></a>00965 <span class="preprocessor"></span><span class="preprocessor">#       $ext  = &quot;gif&quot;;</span>
<a name="l00966"></a>00966 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00967"></a>00967 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00968"></a>00968 <span class="preprocessor"></span><span class="preprocessor">#   # $adr_output is a url in HTML and Latex2HTML modes</span>
<a name="l00969"></a>00969 <span class="preprocessor"></span><span class="preprocessor">#   # and a complete path in TEX mode.</span>
<a name="l00970"></a>00970 <span class="preprocessor"></span><span class="preprocessor">#   my $adr_output;</span>
<a name="l00971"></a>00971 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00972"></a>00972 <span class="preprocessor"></span><span class="preprocessor">#   # in order to facilitate maintenance of this macro the routines for handling</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span><span class="preprocessor">#   # different file types are defined separately.  This involves some redundancy</span>
<a name="l00974"></a>00974 <span class="preprocessor"></span><span class="preprocessor">#   # in the code but it makes it easier to define special handling for a new file</span>
<a name="l00975"></a>00975 <span class="preprocessor"></span><span class="preprocessor">#   # type, (but harder to change the behavior for all of the file types at once</span>
<a name="l00976"></a>00976 <span class="preprocessor"></span><span class="preprocessor">#   # (sigh)  ).</span>
<a name="l00977"></a>00977 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00978"></a>00978 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00979"></a>00979 <span class="preprocessor"></span><span class="preprocessor">#   if ($ext eq &#39;html&#39;) {</span>
<a name="l00980"></a>00980 <span class="preprocessor"></span><span class="preprocessor">#       ################################################################################</span>
<a name="l00981"></a>00981 <span class="preprocessor"></span><span class="preprocessor">#       # .html FILES in HTML, HTML_tth, HTML_dpng, HTML_img, etc. and Latex2HTML mode</span>
<a name="l00982"></a>00982 <span class="preprocessor"></span><span class="preprocessor">#       ################################################################################</span>
<a name="l00983"></a>00983 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00984"></a>00984 <span class="preprocessor"></span><span class="preprocessor">#       # No changes are made for auxiliary files in the</span>
<a name="l00985"></a>00985 <span class="preprocessor"></span><span class="preprocessor">#       # ${Global::htmlDirectory} subtree.</span>
<a name="l00986"></a>00986 <span class="preprocessor"></span><span class="preprocessor">#       if ( $aux_file_path =~ m|^$tempDirectory| ) {</span>
<a name="l00987"></a>00987 <span class="preprocessor"></span><span class="preprocessor">#           $adr_output = $aux_file_path;</span>
<a name="l00988"></a>00988 <span class="preprocessor"></span><span class="preprocessor">#           $adr_output =~ s|$tempDirectory|$tempURL/|;</span>
<a name="l00989"></a>00989 <span class="preprocessor"></span><span class="preprocessor">#           $adr_output .= &quot;.$ext&quot;;</span>
<a name="l00990"></a>00990 <span class="preprocessor"></span><span class="preprocessor">#       } elsif ($aux_file_path =~ m|^$htmlDirectory| ) {</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span><span class="preprocessor">#           $adr_output = $aux_file_path;</span>
<a name="l00992"></a>00992 <span class="preprocessor"></span><span class="preprocessor">#           $adr_output =~ s|$htmlDirectory|$htmlURL|;</span>
<a name="l00993"></a>00993 <span class="preprocessor"></span><span class="preprocessor">#           $adr_output .= &quot;.$ext&quot;;</span>
<a name="l00994"></a>00994 <span class="preprocessor"></span><span class="preprocessor">#       } else {</span>
<a name="l00995"></a>00995 <span class="preprocessor"></span><span class="preprocessor">#           # HTML files not in the htmlDirectory are assumed under live under the</span>
<a name="l00996"></a>00996 <span class="preprocessor"></span><span class="preprocessor">#           # templateDirectory in the same directory as the problem.</span>
<a name="l00997"></a>00997 <span class="preprocessor"></span><span class="preprocessor">#           # Create an alias file (link) in the directory html/tmp/html which</span>
<a name="l00998"></a>00998 <span class="preprocessor"></span><span class="preprocessor">#           # points to the original file and return the URL of this alias.</span>
<a name="l00999"></a>00999 <span class="preprocessor"></span><span class="preprocessor">#           # Create all of the subdirectories of html/tmp/html which are needed</span>
<a name="l01000"></a>01000 <span class="preprocessor"></span><span class="preprocessor">#           # using sure file to path.</span>
<a name="l01001"></a>01001 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01002"></a>01002 <span class="preprocessor"></span><span class="preprocessor">#           # $fileName is obtained from environment for PGeval</span>
<a name="l01003"></a>01003 <span class="preprocessor"></span><span class="preprocessor">#           # it gives the  full path to the current problem</span>
<a name="l01004"></a>01004 <span class="preprocessor"></span><span class="preprocessor">#           my $filePath = directoryFromPath($fileName);</span>
<a name="l01005"></a>01005 <span class="preprocessor"></span><span class="preprocessor">#           my $htmlFileSource = convertPath(&quot;$templateDirectory${filePath}$aux_file_path.html&quot;);</span>
<a name="l01006"></a>01006 <span class="preprocessor"></span><span class="preprocessor">#           my $link = &quot;html/$studentLogin-$psvnNumber-set$setNumber-prob$probNum-$aux_file_path.$ext&quot;;</span>
<a name="l01007"></a>01007 <span class="preprocessor"></span><span class="preprocessor">#           my $linkPath = surePathToTmpFile($link);</span>
<a name="l01008"></a>01008 <span class="preprocessor"></span><span class="preprocessor">#           $adr_output = &quot;${tempURL}$link&quot;;</span>
<a name="l01009"></a>01009 <span class="preprocessor"></span><span class="preprocessor">#           if (-e $htmlFileSource) {</span>
<a name="l01010"></a>01010 <span class="preprocessor"></span><span class="preprocessor">#               if (-e $linkPath) {</span>
<a name="l01011"></a>01011 <span class="preprocessor"></span><span class="preprocessor">#                   unlink($linkPath) || warn &quot;Unable to unlink alias file at |$linkPath|&quot;;</span>
<a name="l01012"></a>01012 <span class="preprocessor"></span><span class="preprocessor">#                   # destroy the old link.</span>
<a name="l01013"></a>01013 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l01014"></a>01014 <span class="preprocessor"></span><span class="preprocessor">#               symlink( $htmlFileSource, $linkPath)</span>
<a name="l01015"></a>01015 <span class="preprocessor"></span><span class="preprocessor">#                       || warn &quot;The macro alias cannot create a link from |$linkPath|  to |$htmlFileSource| &lt;BR&gt;&quot; ;</span>
<a name="l01016"></a>01016 <span class="preprocessor"></span><span class="preprocessor">#           } else {</span>
<a name="l01017"></a>01017 <span class="preprocessor"></span><span class="preprocessor">#               warn(&quot;The macro alias cannot find an HTML file at: |$htmlFileSource|&quot;);</span>
<a name="l01018"></a>01018 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l01019"></a>01019 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l01020"></a>01020 <span class="preprocessor"></span><span class="preprocessor">#   } elsif ($ext eq &#39;gif&#39;) {</span>
<a name="l01021"></a>01021 <span class="preprocessor"></span><span class="preprocessor">#       if ( $displayMode eq &#39;HTML&#39; ||</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_tth&#39;||</span>
<a name="l01023"></a>01023 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_dpng&#39;||</span>
<a name="l01024"></a>01024 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_asciimath&#39;||</span>
<a name="l01025"></a>01025 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_LaTeXMathML&#39;||</span>
<a name="l01026"></a>01026 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_jsMath&#39;||</span>
<a name="l01027"></a>01027 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_img&#39;||</span>
<a name="l01028"></a>01028 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;Latex2HTML&#39;)  {</span>
<a name="l01029"></a>01029 <span class="preprocessor"></span><span class="preprocessor">#           ################################################################################</span>
<a name="l01030"></a>01030 <span class="preprocessor"></span><span class="preprocessor">#           # .gif FILES in HTML, HTML_tth, HTML_dpng, HTML_img, and Latex2HTML modes</span>
<a name="l01031"></a>01031 <span class="preprocessor"></span><span class="preprocessor">#           ################################################################################</span>
<a name="l01032"></a>01032 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01033"></a>01033 <span class="preprocessor"></span><span class="preprocessor">#           #warn &quot;tempDirectory is $tempDirectory&quot;;</span>
<a name="l01034"></a>01034 <span class="preprocessor"></span><span class="preprocessor">#           #warn &quot;file Path for auxiliary file is $aux_file_path&quot;;</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01036"></a>01036 <span class="preprocessor"></span><span class="preprocessor">#           # No changes are made for auxiliary files in the htmlDirectory or in the tempDirectory subtree.</span>
<a name="l01037"></a>01037 <span class="preprocessor"></span><span class="preprocessor">#           if ( $aux_file_path =~ m|^$tempDirectory| ) {</span>
<a name="l01038"></a>01038 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output = $aux_file_path;</span>
<a name="l01039"></a>01039 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output =~ s|$tempDirectory|$tempURL|;</span>
<a name="l01040"></a>01040 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output .= &quot;.$ext&quot;;</span>
<a name="l01041"></a>01041 <span class="preprocessor"></span><span class="preprocessor">#               #warn &quot;adress out is $adr_output&quot;;</span>
<a name="l01042"></a>01042 <span class="preprocessor"></span><span class="preprocessor">#           } elsif ($aux_file_path =~ m|^$htmlDirectory| ) {</span>
<a name="l01043"></a>01043 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output = $aux_file_path;</span>
<a name="l01044"></a>01044 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output =~ s|$htmlDirectory|$htmlURL|;</span>
<a name="l01045"></a>01045 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output .= &quot;.$ext&quot;;</span>
<a name="l01046"></a>01046 <span class="preprocessor"></span><span class="preprocessor">#           } else {</span>
<a name="l01047"></a>01047 <span class="preprocessor"></span><span class="preprocessor">#               # files not in the htmlDirectory sub tree are assumed to live under the templateDirectory</span>
<a name="l01048"></a>01048 <span class="preprocessor"></span><span class="preprocessor">#               # subtree in the same directory as the problem.</span>
<a name="l01049"></a>01049 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01050"></a>01050 <span class="preprocessor"></span><span class="preprocessor">#               # For a gif file the alias macro creates an alias under the html/images directory</span>
<a name="l01051"></a>01051 <span class="preprocessor"></span><span class="preprocessor">#               # which points to the gif file in the problem directory.</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span><span class="preprocessor">#               # All of the subdirectories of html/tmp/gif which are needed are also created.</span>
<a name="l01053"></a>01053 <span class="preprocessor"></span><span class="preprocessor">#               my $filePath = directoryFromPath($fileName);</span>
<a name="l01054"></a>01054 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01055"></a>01055 <span class="preprocessor"></span><span class="preprocessor">#               # $fileName is obtained from environment for PGeval</span>
<a name="l01056"></a>01056 <span class="preprocessor"></span><span class="preprocessor">#               # it gives the full path to the current problem</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span><span class="preprocessor">#               my $gifSourceFile = convertPath(&quot;$templateDirectory${filePath}$aux_file_path.gif&quot;);</span>
<a name="l01058"></a>01058 <span class="preprocessor"></span><span class="preprocessor">#               #my $link = &quot;gif/$studentLogin-$psvnNumber-set$setNumber-prob$probNum-$aux_file_path.$ext&quot;;</span>
<a name="l01059"></a>01059 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01060"></a>01060 <span class="preprocessor"></span><span class="preprocessor">#               #  Make file names work in Library Browser when the images in several</span>
<a name="l01061"></a>01061 <span class="preprocessor"></span><span class="preprocessor">#               #  files have the same names.</span>
<a name="l01062"></a>01062 <span class="preprocessor"></span><span class="preprocessor">#               my $libFix = &quot;&quot;;</span>
<a name="l01063"></a>01063 <span class="preprocessor"></span><span class="preprocessor">#               if ($setNumber eq &quot;Undefined_Set&quot;) {</span>
<a name="l01064"></a>01064 <span class="preprocessor"></span><span class="preprocessor">#                 $libFix = $fileName;</span>
<a name="l01065"></a>01065 <span class="preprocessor"></span><span class="preprocessor">#                 $libFix =~ s!.*/!!; $libFix =~ s!\.pg(\..*)?$!!;</span>
<a name="l01066"></a>01066 <span class="preprocessor"></span><span class="preprocessor">#                 $libFix =~ s![^a-zA-Z0-9._-]!!g;</span>
<a name="l01067"></a>01067 <span class="preprocessor"></span><span class="preprocessor">#                 $libFix .= &#39;-&#39;;</span>
<a name="l01068"></a>01068 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l01069"></a>01069 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01070"></a>01070 <span class="preprocessor"></span><span class="preprocessor">#               my $link = &quot;gif/$setNumber-prob$probNum-$libFix$aux_file_path.$ext&quot;;</span>
<a name="l01071"></a>01071 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01072"></a>01072 <span class="preprocessor"></span><span class="preprocessor">#               my $linkPath = surePathToTmpFile($link);</span>
<a name="l01073"></a>01073 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output = &quot;${tempURL}$link&quot;;</span>
<a name="l01074"></a>01074 <span class="preprocessor"></span><span class="preprocessor">#               #warn &quot;linkPath is $linkPath&quot;;</span>
<a name="l01075"></a>01075 <span class="preprocessor"></span><span class="preprocessor">#               #warn &quot;adr_output is $adr_output&quot;;</span>
<a name="l01076"></a>01076 <span class="preprocessor"></span><span class="preprocessor">#               if (-e $gifSourceFile) {</span>
<a name="l01077"></a>01077 <span class="preprocessor"></span><span class="preprocessor">#                   if (-e $linkPath) {</span>
<a name="l01078"></a>01078 <span class="preprocessor"></span><span class="preprocessor">#                       unlink($linkPath) || warn &quot;Unable to unlink old alias file at $linkPath&quot;;</span>
<a name="l01079"></a>01079 <span class="preprocessor"></span><span class="preprocessor">#                   }</span>
<a name="l01080"></a>01080 <span class="preprocessor"></span><span class="preprocessor">#                   symlink($gifSourceFile, $linkPath)</span>
<a name="l01081"></a>01081 <span class="preprocessor"></span><span class="preprocessor">#                       || warn &quot;The macro alias cannot create a link from |$linkPath|  to |$gifSourceFile| &lt;BR&gt;&quot; ;</span>
<a name="l01082"></a>01082 <span class="preprocessor"></span><span class="preprocessor">#               } else {</span>
<a name="l01083"></a>01083 <span class="preprocessor"></span><span class="preprocessor">#                   warn(&quot;The macro alias cannot find a GIF file at: |$gifSourceFile|&quot;);</span>
<a name="l01084"></a>01084 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l01085"></a>01085 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l01086"></a>01086 <span class="preprocessor"></span><span class="preprocessor">#       } elsif ($displayMode eq &#39;TeX&#39;) {</span>
<a name="l01087"></a>01087 <span class="preprocessor"></span><span class="preprocessor">#           ################################################################################</span>
<a name="l01088"></a>01088 <span class="preprocessor"></span><span class="preprocessor">#           # .gif FILES in TeX mode</span>
<a name="l01089"></a>01089 <span class="preprocessor"></span><span class="preprocessor">#           ################################################################################</span>
<a name="l01090"></a>01090 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01091"></a>01091 <span class="preprocessor"></span><span class="preprocessor">#               $setNumber =~ s/\./_/g;  ## extra dots confuse latex&#39;s graphics package</span>
<a name="l01092"></a>01092 <span class="preprocessor"></span><span class="preprocessor">#           if ($envir{texDisposition} eq &quot;pdf&quot;) {</span>
<a name="l01093"></a>01093 <span class="preprocessor"></span><span class="preprocessor">#               # We&#39;re going to create PDF files with our TeX (using pdflatex), so we</span>
<a name="l01094"></a>01094 <span class="preprocessor"></span><span class="preprocessor">#               # need images in PNG format.</span>
<a name="l01095"></a>01095 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01096"></a>01096 <span class="preprocessor"></span><span class="preprocessor">#               my $gifFilePath;</span>
<a name="l01097"></a>01097 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01098"></a>01098 <span class="preprocessor"></span><span class="preprocessor">#               if ($aux_file_path =~ m/^$htmlDirectory/ or $aux_file_path =~ m/^$tempDirectory/) {</span>
<a name="l01099"></a>01099 <span class="preprocessor"></span><span class="preprocessor">#                   # we&#39;ve got a full pathname to a file</span>
<a name="l01100"></a>01100 <span class="preprocessor"></span><span class="preprocessor">#                   $gifFilePath = &quot;$aux_file_path.gif&quot;;</span>
<a name="l01101"></a>01101 <span class="preprocessor"></span><span class="preprocessor">#               } else {</span>
<a name="l01102"></a>01102 <span class="preprocessor"></span><span class="preprocessor">#                   # we assume the file is in the same directory as the problem source file</span>
<a name="l01103"></a>01103 <span class="preprocessor"></span><span class="preprocessor">#                   $gifFilePath = $templateDirectory . directoryFromPath($fileName) . &quot;$aux_file_path.gif&quot;;</span>
<a name="l01104"></a>01104 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l01105"></a>01105 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01106"></a>01106 <span class="preprocessor"></span><span class="preprocessor">#               my $gifFileName = fileFromPath($gifFilePath);</span>
<a name="l01107"></a>01107 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01108"></a>01108 <span class="preprocessor"></span><span class="preprocessor">#               $gifFileName =~ /^(.*)\.gif$/;</span>
<a name="l01109"></a>01109 <span class="preprocessor"></span><span class="preprocessor"># #             my $pngFilePath = surePathToTmpFile(&quot;${tempDirectory}png/$probNum-$1.png&quot;);</span>
<a name="l01110"></a>01110 <span class="preprocessor"></span><span class="preprocessor">#               my $pngFilePath = surePathToTmpFile(&quot;${tempDirectory}png/$setNumber-$probNum-$1.png&quot;);</span>
<a name="l01111"></a>01111 <span class="preprocessor"></span><span class="preprocessor">#               my $returnCode = system &quot;cat $gifFilePath | $envir{externalGif2PngPath} &gt; $pngFilePath&quot;;</span>
<a name="l01112"></a>01112 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01113"></a>01113 <span class="preprocessor"></span><span class="preprocessor">#               if ($returnCode or not -e $pngFilePath) {</span>
<a name="l01114"></a>01114 <span class="preprocessor"></span><span class="preprocessor">#                   die &quot;failed to convert $gifFilePath to $pngFilePath using gif-&gt;png with $envir{externalGif2PngPath}: $!\n&quot;;</span>
<a name="l01115"></a>01115 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l01116"></a>01116 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01117"></a>01117 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output = $pngFilePath;</span>
<a name="l01118"></a>01118 <span class="preprocessor"></span><span class="preprocessor">#           } else {</span>
<a name="l01119"></a>01119 <span class="preprocessor"></span><span class="preprocessor">#               # Since we&#39;re not creating PDF files, we&#39;re probably just using a plain</span>
<a name="l01120"></a>01120 <span class="preprocessor"></span><span class="preprocessor">#               # vanilla latex. Hence, we need EPS images.</span>
<a name="l01121"></a>01121 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01122"></a>01122 <span class="preprocessor"></span><span class="preprocessor">#               ################################################################################</span>
<a name="l01123"></a>01123 <span class="preprocessor"></span><span class="preprocessor">#               # This is statement used below is system dependent.</span>
<a name="l01124"></a>01124 <span class="preprocessor"></span><span class="preprocessor">#               # Notice that the range of colors is restricted when converting to postscript to keep the files small</span>
<a name="l01125"></a>01125 <span class="preprocessor"></span><span class="preprocessor">#               # &quot;cat $gifSourceFile  | /usr/math/bin/giftopnm | /usr/math/bin/pnmtops -noturn &gt; $adr_output&quot;</span>
<a name="l01126"></a>01126 <span class="preprocessor"></span><span class="preprocessor">#               # &quot;cat $gifSourceFile  | /usr/math/bin/giftopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn &gt; $adr_output&quot;</span>
<a name="l01127"></a>01127 <span class="preprocessor"></span><span class="preprocessor">#               ################################################################################</span>
<a name="l01128"></a>01128 <span class="preprocessor"></span><span class="preprocessor">#               if ($aux_file_path =~  m|^$htmlDirectory|  or $aux_file_path =~  m|^$tempDirectory|)  {</span>
<a name="l01129"></a>01129 <span class="preprocessor"></span><span class="preprocessor">#                   # To serve an eps file copy an eps version of the gif file to the subdirectory of eps/</span>
<a name="l01130"></a>01130 <span class="preprocessor"></span><span class="preprocessor">#                   my $linkPath = directoryFromPath($fileName);</span>
<a name="l01131"></a>01131 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01132"></a>01132 <span class="preprocessor"></span><span class="preprocessor">#                   my $gifSourceFile = &quot;$aux_file_path.gif&quot;;</span>
<a name="l01133"></a>01133 <span class="preprocessor"></span><span class="preprocessor">#                   my $gifFileName = fileFromPath($gifSourceFile);</span>
<a name="l01134"></a>01134 <span class="preprocessor"></span><span class="preprocessor">#                   $adr_output = surePathToTmpFile(&quot;$tempDirectory/eps/$studentLogin-$psvnNumber-$gifFileName.eps&quot;) ;</span>
<a name="l01135"></a>01135 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01136"></a>01136 <span class="preprocessor"></span><span class="preprocessor">#                   if (-e $gifSourceFile) {</span>
<a name="l01137"></a>01137 <span class="preprocessor"></span><span class="preprocessor">#                       #system(&quot;cat $gifSourceFile  | /usr/math/bin/giftopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn&gt;$adr_output&quot;)</span>
<a name="l01138"></a>01138 <span class="preprocessor"></span><span class="preprocessor">#                       system(&quot;cat $gifSourceFile | ${externalGif2EpsPath} &gt; $adr_output&quot; )</span>
<a name="l01139"></a>01139 <span class="preprocessor"></span><span class="preprocessor">#                           &amp;&amp; die &quot;Unable to create eps file:\n |$adr_output| from file\n |$gifSourceFile|\n in problem $probNum &quot; .</span>
<a name="l01140"></a>01140 <span class="preprocessor"></span><span class="preprocessor">#                                  &quot;using the system dependent script\n |${externalGif2EpsPath}| \n&quot;;</span>
<a name="l01141"></a>01141 <span class="preprocessor"></span><span class="preprocessor">#                   } else {</span>
<a name="l01142"></a>01142 <span class="preprocessor"></span><span class="preprocessor">#                       die &quot;|$gifSourceFile| cannot be found.  Problem number: |$probNum|&quot;;</span>
<a name="l01143"></a>01143 <span class="preprocessor"></span><span class="preprocessor">#                   }</span>
<a name="l01144"></a>01144 <span class="preprocessor"></span><span class="preprocessor">#               } else {</span>
<a name="l01145"></a>01145 <span class="preprocessor"></span><span class="preprocessor">#                   # To serve an eps file copy an eps version of the gif file to  a subdirectory of eps/</span>
<a name="l01146"></a>01146 <span class="preprocessor"></span><span class="preprocessor">#                   my $filePath = directoryFromPath($fileName);</span>
<a name="l01147"></a>01147 <span class="preprocessor"></span><span class="preprocessor">#                   my $gifSourceFile = &quot;${templateDirectory}${filePath}$aux_file_path.gif&quot;;</span>
<a name="l01148"></a>01148 <span class="preprocessor"></span><span class="preprocessor">#                   #print &quot;content-type: text/plain \n\nfileName = $fileName and aux_file_path =$aux_file_path&lt;BR&gt;&quot;;</span>
<a name="l01149"></a>01149 <span class="preprocessor"></span><span class="preprocessor">#                   $adr_output = surePathToTmpFile(&quot;eps/$studentLogin-$psvnNumber-set$setNumber-prob$probNum-$aux_file_path.eps&quot;);</span>
<a name="l01150"></a>01150 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01151"></a>01151 <span class="preprocessor"></span><span class="preprocessor">#                   if (-e $gifSourceFile) {</span>
<a name="l01152"></a>01152 <span class="preprocessor"></span><span class="preprocessor">#                       #system(&quot;cat $gifSourceFile  | /usr/math/bin/giftopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn&gt;$adr_output&quot;) &amp;&amp;</span>
<a name="l01153"></a>01153 <span class="preprocessor"></span><span class="preprocessor">#                       #warn &quot;Unable to create eps file: |$adr_output|\n from file\n |$gifSourceFile|\n in problem $probNum&quot;;</span>
<a name="l01154"></a>01154 <span class="preprocessor"></span><span class="preprocessor">#                       #warn &quot;Help ${:externalGif2EpsPath}&quot; unless -x &quot;${main::externalGif2EpsPath}&quot;;</span>
<a name="l01155"></a>01155 <span class="preprocessor"></span><span class="preprocessor">#                       system(&quot;cat $gifSourceFile | ${externalGif2EpsPath} &gt; $adr_output&quot; )</span>
<a name="l01156"></a>01156 <span class="preprocessor"></span><span class="preprocessor">#                           &amp;&amp; die &quot;Unable to create eps file:\n |$adr_output| from file\n |$gifSourceFile|\n in problem $probNum &quot; .</span>
<a name="l01157"></a>01157 <span class="preprocessor"></span><span class="preprocessor">#                                  &quot;using the system dependent commands \n |${externalGif2EpsPath}| \n &quot;;</span>
<a name="l01158"></a>01158 <span class="preprocessor"></span><span class="preprocessor">#                   }  else {</span>
<a name="l01159"></a>01159 <span class="preprocessor"></span><span class="preprocessor">#                       die &quot;|$gifSourceFile| cannot be found.  Problem number: |$probNum|&quot;;</span>
<a name="l01160"></a>01160 <span class="preprocessor"></span><span class="preprocessor">#                   }</span>
<a name="l01161"></a>01161 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l01162"></a>01162 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l01163"></a>01163 <span class="preprocessor"></span><span class="preprocessor">#       } else {</span>
<a name="l01164"></a>01164 <span class="preprocessor"></span><span class="preprocessor">#           die &quot;Error in alias: dangerousMacros.pl: unrecognizable displayMode = $displayMode&quot;;</span>
<a name="l01165"></a>01165 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l01166"></a>01166 <span class="preprocessor"></span><span class="preprocessor">#   } elsif ($ext eq &#39;png&#39;) {</span>
<a name="l01167"></a>01167 <span class="preprocessor"></span><span class="preprocessor">#       if ( $displayMode eq &#39;HTML&#39; ||</span>
<a name="l01168"></a>01168 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_tth&#39;||</span>
<a name="l01169"></a>01169 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_dpng&#39;||</span>
<a name="l01170"></a>01170 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_asciimath&#39;||</span>
<a name="l01171"></a>01171 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_LaTeXMathML&#39;||</span>
<a name="l01172"></a>01172 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_jsMath&#39;||</span>
<a name="l01173"></a>01173 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;HTML_img&#39;||</span>
<a name="l01174"></a>01174 <span class="preprocessor"></span><span class="preprocessor">#            $displayMode eq &#39;Latex2HTML&#39;)  {</span>
<a name="l01175"></a>01175 <span class="preprocessor"></span><span class="preprocessor">#           ################################################################################</span>
<a name="l01176"></a>01176 <span class="preprocessor"></span><span class="preprocessor">#           # .png FILES in HTML, HTML_tth, HTML_dpng, HTML_img, etc. and Latex2HTML modes</span>
<a name="l01177"></a>01177 <span class="preprocessor"></span><span class="preprocessor">#           ################################################################################</span>
<a name="l01178"></a>01178 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01179"></a>01179 <span class="preprocessor"></span><span class="preprocessor">#           #warn &quot;tempDirectory is $tempDirectory&quot;;</span>
<a name="l01180"></a>01180 <span class="preprocessor"></span><span class="preprocessor">#           #warn &quot;file Path for auxiliary file is $aux_file_path&quot;;</span>
<a name="l01181"></a>01181 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01182"></a>01182 <span class="preprocessor"></span><span class="preprocessor">#           # No changes are made for auxiliary files in the htmlDirectory or in the tempDirectory subtree.</span>
<a name="l01183"></a>01183 <span class="preprocessor"></span><span class="preprocessor">#           if ( $aux_file_path =~ m|^$tempDirectory| ) {</span>
<a name="l01184"></a>01184 <span class="preprocessor"></span><span class="preprocessor">#           $adr_output = $aux_file_path;</span>
<a name="l01185"></a>01185 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output =~ s|$tempDirectory|$tempURL|;</span>
<a name="l01186"></a>01186 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output .= &quot;.$ext&quot;;</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span><span class="preprocessor">#               #warn &quot;adress out is $adr_output&quot;;</span>
<a name="l01188"></a>01188 <span class="preprocessor"></span><span class="preprocessor">#           } elsif ($aux_file_path =~ m|^$htmlDirectory| ) {</span>
<a name="l01189"></a>01189 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output = $aux_file_path;</span>
<a name="l01190"></a>01190 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output =~ s|$htmlDirectory|$htmlURL|;</span>
<a name="l01191"></a>01191 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output .= &quot;.$ext&quot;;</span>
<a name="l01192"></a>01192 <span class="preprocessor"></span><span class="preprocessor">#           } else {</span>
<a name="l01193"></a>01193 <span class="preprocessor"></span><span class="preprocessor">#               # files not in the htmlDirectory sub tree are assumed to live under the templateDirectory</span>
<a name="l01194"></a>01194 <span class="preprocessor"></span><span class="preprocessor">#               # subtree in the same directory as the problem.</span>
<a name="l01195"></a>01195 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01196"></a>01196 <span class="preprocessor"></span><span class="preprocessor">#               # For a png file the alias macro creates an alias under the html/images directory</span>
<a name="l01197"></a>01197 <span class="preprocessor"></span><span class="preprocessor">#               # which points to the png file in the problem directory.</span>
<a name="l01198"></a>01198 <span class="preprocessor"></span><span class="preprocessor">#               # All of the subdirectories of html/tmp/gif which are needed are also created.</span>
<a name="l01199"></a>01199 <span class="preprocessor"></span><span class="preprocessor">#               my $filePath = directoryFromPath($fileName);</span>
<a name="l01200"></a>01200 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01201"></a>01201 <span class="preprocessor"></span><span class="preprocessor">#               # $fileName is obtained from environment for PGeval</span>
<a name="l01202"></a>01202 <span class="preprocessor"></span><span class="preprocessor">#               # it gives the full path to the current problem</span>
<a name="l01203"></a>01203 <span class="preprocessor"></span><span class="preprocessor">#               my $pngSourceFile = convertPath(&quot;$templateDirectory${filePath}$aux_file_path.png&quot;);</span>
<a name="l01204"></a>01204 <span class="preprocessor"></span><span class="preprocessor">#               my $link = &quot;gif/$studentLogin-$psvnNumber-set$setNumber-prob$probNum-$aux_file_path.$ext&quot;;</span>
<a name="l01205"></a>01205 <span class="preprocessor"></span><span class="preprocessor">#               my $linkPath = surePathToTmpFile($link);</span>
<a name="l01206"></a>01206 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output = &quot;${tempURL}$link&quot;;</span>
<a name="l01207"></a>01207 <span class="preprocessor"></span><span class="preprocessor">#               #warn &quot;linkPath is $linkPath&quot;;</span>
<a name="l01208"></a>01208 <span class="preprocessor"></span><span class="preprocessor">#               #warn &quot;adr_output is $adr_output&quot;;</span>
<a name="l01209"></a>01209 <span class="preprocessor"></span><span class="preprocessor">#               if (-e $pngSourceFile) {</span>
<a name="l01210"></a>01210 <span class="preprocessor"></span><span class="preprocessor">#                   if (-e $linkPath) {</span>
<a name="l01211"></a>01211 <span class="preprocessor"></span><span class="preprocessor">#                       unlink($linkPath) || warn &quot;Unable to unlink old alias file at $linkPath&quot;;</span>
<a name="l01212"></a>01212 <span class="preprocessor"></span><span class="preprocessor">#                   }</span>
<a name="l01213"></a>01213 <span class="preprocessor"></span><span class="preprocessor">#                   symlink($pngSourceFile, $linkPath)</span>
<a name="l01214"></a>01214 <span class="preprocessor"></span><span class="preprocessor">#                   || warn &quot;The macro alias cannot create a link from |$linkPath|  to |$pngSourceFile| &lt;BR&gt;&quot; ;</span>
<a name="l01215"></a>01215 <span class="preprocessor"></span><span class="preprocessor">#               } else {</span>
<a name="l01216"></a>01216 <span class="preprocessor"></span><span class="preprocessor">#                   warn(&quot;The macro alias cannot find a PNG file at: |$pngSourceFile|&quot;);</span>
<a name="l01217"></a>01217 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l01218"></a>01218 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l01219"></a>01219 <span class="preprocessor"></span><span class="preprocessor">#       } elsif ($displayMode eq &#39;TeX&#39;) {</span>
<a name="l01220"></a>01220 <span class="preprocessor"></span><span class="preprocessor">#           ################################################################################</span>
<a name="l01221"></a>01221 <span class="preprocessor"></span><span class="preprocessor">#           # .png FILES in TeX mode</span>
<a name="l01222"></a>01222 <span class="preprocessor"></span><span class="preprocessor">#           ################################################################################</span>
<a name="l01223"></a>01223 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01224"></a>01224 <span class="preprocessor"></span><span class="preprocessor">#               $setNumber =~ s/\./_/g;  ## extra dots confuse latex&#39;s graphics package</span>
<a name="l01225"></a>01225 <span class="preprocessor"></span><span class="preprocessor">#           if ($envir{texDisposition} eq &quot;pdf&quot;) {</span>
<a name="l01226"></a>01226 <span class="preprocessor"></span><span class="preprocessor">#               # We&#39;re going to create PDF files with our TeX (using pdflatex), so we</span>
<a name="l01227"></a>01227 <span class="preprocessor"></span><span class="preprocessor">#               # need images in PNG format. what luck! they&#39;re already in PDF format!</span>
<a name="l01228"></a>01228 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01229"></a>01229 <span class="preprocessor"></span><span class="preprocessor">#               my $pngFilePath;</span>
<a name="l01230"></a>01230 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01231"></a>01231 <span class="preprocessor"></span><span class="preprocessor">#               if ($aux_file_path =~ m/^$htmlDirectory/ or $aux_file_path =~ m/^$tempDirectory/) {</span>
<a name="l01232"></a>01232 <span class="preprocessor"></span><span class="preprocessor">#                   # we&#39;ve got a full pathname to a file</span>
<a name="l01233"></a>01233 <span class="preprocessor"></span><span class="preprocessor">#                   $pngFilePath = &quot;$aux_file_path.png&quot;;</span>
<a name="l01234"></a>01234 <span class="preprocessor"></span><span class="preprocessor">#               } else {</span>
<a name="l01235"></a>01235 <span class="preprocessor"></span><span class="preprocessor">#                   # we assume the file is in the same directory as the problem source file</span>
<a name="l01236"></a>01236 <span class="preprocessor"></span><span class="preprocessor">#                   $pngFilePath = $templateDirectory . directoryFromPath($fileName) . &quot;$aux_file_path.png&quot;;</span>
<a name="l01237"></a>01237 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l01238"></a>01238 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01239"></a>01239 <span class="preprocessor"></span><span class="preprocessor">#               $adr_output = $pngFilePath;</span>
<a name="l01240"></a>01240 <span class="preprocessor"></span><span class="preprocessor">#           } else {</span>
<a name="l01241"></a>01241 <span class="preprocessor"></span><span class="preprocessor">#               # Since we&#39;re not creating PDF files, we&#39;re probably just using a plain</span>
<a name="l01242"></a>01242 <span class="preprocessor"></span><span class="preprocessor">#               # vanilla latex. Hence, we need EPS images.</span>
<a name="l01243"></a>01243 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01244"></a>01244 <span class="preprocessor"></span><span class="preprocessor">#               ################################################################################</span>
<a name="l01245"></a>01245 <span class="preprocessor"></span><span class="preprocessor">#               # This is statement used below is system dependent.</span>
<a name="l01246"></a>01246 <span class="preprocessor"></span><span class="preprocessor">#               # Notice that the range of colors is restricted when converting to postscript to keep the files small</span>
<a name="l01247"></a>01247 <span class="preprocessor"></span><span class="preprocessor">#               # &quot;cat $pngSourceFile  | /usr/math/bin/pngtopnm | /usr/math/bin/pnmtops -noturn &gt; $adr_output&quot;</span>
<a name="l01248"></a>01248 <span class="preprocessor"></span><span class="preprocessor">#               # &quot;cat $pngSourceFile  | /usr/math/bin/pngtopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn &gt; $adr_output&quot;</span>
<a name="l01249"></a>01249 <span class="preprocessor"></span><span class="preprocessor">#               ################################################################################</span>
<a name="l01250"></a>01250 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01251"></a>01251 <span class="preprocessor"></span><span class="preprocessor">#               if ($aux_file_path =~  m|^$htmlDirectory|  or $aux_file_path =~  m|^$tempDirectory|)  {</span>
<a name="l01252"></a>01252 <span class="preprocessor"></span><span class="preprocessor">#                   # To serve an eps file copy an eps version of the png file to the subdirectory of eps/</span>
<a name="l01253"></a>01253 <span class="preprocessor"></span><span class="preprocessor">#                   my $linkPath = directoryFromPath($fileName);</span>
<a name="l01254"></a>01254 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01255"></a>01255 <span class="preprocessor"></span><span class="preprocessor">#                   my $pngSourceFile = &quot;$aux_file_path.png&quot;;</span>
<a name="l01256"></a>01256 <span class="preprocessor"></span><span class="preprocessor">#                   my $pngFileName = fileFromPath($pngSourceFile);</span>
<a name="l01257"></a>01257 <span class="preprocessor"></span><span class="preprocessor">#                   $adr_output = surePathToTmpFile(&quot;$tempDirectory/eps/$studentLogin-$psvnNumber-$pngFileName.eps&quot;) ;</span>
<a name="l01258"></a>01258 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01259"></a>01259 <span class="preprocessor"></span><span class="preprocessor">#                   if (-e $pngSourceFile) {</span>
<a name="l01260"></a>01260 <span class="preprocessor"></span><span class="preprocessor">#                       #system(&quot;cat $pngSourceFile  | /usr/math/bin/pngtopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn&gt;$adr_output&quot;)</span>
<a name="l01261"></a>01261 <span class="preprocessor"></span><span class="preprocessor">#                       system(&quot;cat $pngSourceFile | ${externalPng2EpsPath} &gt; $adr_output&quot; )</span>
<a name="l01262"></a>01262 <span class="preprocessor"></span><span class="preprocessor">#                           &amp;&amp; die &quot;Unable to create eps file:\n |$adr_output| from file\n |$pngSourceFile|\n in problem $probNum &quot; .</span>
<a name="l01263"></a>01263 <span class="preprocessor"></span><span class="preprocessor">#                                  &quot;using the system dependent commands\n |${externalPng2EpsPath}| \n&quot;;</span>
<a name="l01264"></a>01264 <span class="preprocessor"></span><span class="preprocessor">#                   } else {</span>
<a name="l01265"></a>01265 <span class="preprocessor"></span><span class="preprocessor">#                       die &quot;|$pngSourceFile| cannot be found.  Problem number: |$probNum|&quot;;</span>
<a name="l01266"></a>01266 <span class="preprocessor"></span><span class="preprocessor">#                   }</span>
<a name="l01267"></a>01267 <span class="preprocessor"></span><span class="preprocessor">#               } else {</span>
<a name="l01268"></a>01268 <span class="preprocessor"></span><span class="preprocessor">#                   # To serve an eps file copy an eps version of the png file to  a subdirectory of eps/</span>
<a name="l01269"></a>01269 <span class="preprocessor"></span><span class="preprocessor">#                   my $filePath = directoryFromPath($fileName);</span>
<a name="l01270"></a>01270 <span class="preprocessor"></span><span class="preprocessor">#                   my $pngSourceFile = &quot;${templateDirectory}${filePath}$aux_file_path.png&quot;;</span>
<a name="l01271"></a>01271 <span class="preprocessor"></span><span class="preprocessor">#                   #print &quot;content-type: text/plain \n\nfileName = $fileName and aux_file_path =$aux_file_path&lt;BR&gt;&quot;;</span>
<a name="l01272"></a>01272 <span class="preprocessor"></span><span class="preprocessor">#                   $adr_output = surePathToTmpFile(&quot;eps/$studentLogin-$psvnNumber-set$setNumber-prob$probNum-$aux_file_path.eps&quot;) ;</span>
<a name="l01273"></a>01273 <span class="preprocessor"></span><span class="preprocessor">#                   if (-e $pngSourceFile) {</span>
<a name="l01274"></a>01274 <span class="preprocessor"></span><span class="preprocessor">#                       #system(&quot;cat $pngSourceFile  | /usr/math/bin/pngtopnm | /usr/math/bin/pnmdepth 1 | /usr/math/bin/pnmtops -noturn&gt;$adr_output&quot;) &amp;&amp;</span>
<a name="l01275"></a>01275 <span class="preprocessor"></span><span class="preprocessor">#                       #warn &quot;Unable to create eps file: |$adr_output|\n from file\n |$pngSourceFile|\n in problem $probNum&quot;;</span>
<a name="l01276"></a>01276 <span class="preprocessor"></span><span class="preprocessor">#                       #warn &quot;Help ${externalPng2EpsPath}&quot; unless -x &quot;${externalPng2EpsPath}&quot;;</span>
<a name="l01277"></a>01277 <span class="preprocessor"></span><span class="preprocessor">#                       system(&quot;cat $pngSourceFile | ${externalPng2EpsPath} &gt; $adr_output&quot; )</span>
<a name="l01278"></a>01278 <span class="preprocessor"></span><span class="preprocessor">#                           &amp;&amp; die &quot;Unable to create eps file:\n |$adr_output| from file\n |$pngSourceFile|\n in problem $probNum &quot; .</span>
<a name="l01279"></a>01279 <span class="preprocessor"></span><span class="preprocessor">#                                  &quot;using the system dependent commands\n |${externalPng2EpsPath}| \n &quot;;</span>
<a name="l01280"></a>01280 <span class="preprocessor"></span><span class="preprocessor">#                   } else {</span>
<a name="l01281"></a>01281 <span class="preprocessor"></span><span class="preprocessor">#                       die &quot;|$pngSourceFile| cannot be found.  Problem number: |$probNum|&quot;;</span>
<a name="l01282"></a>01282 <span class="preprocessor"></span><span class="preprocessor">#                   }</span>
<a name="l01283"></a>01283 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l01284"></a>01284 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l01285"></a>01285 <span class="preprocessor"></span><span class="preprocessor">#       } else {</span>
<a name="l01286"></a>01286 <span class="preprocessor"></span><span class="preprocessor">#           warn  &quot;Error in alias: dangerousMacros.pl&quot;,&quot;unrecognizable displayMode = $displayMode&quot;,&quot;&quot;;</span>
<a name="l01287"></a>01287 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l01288"></a>01288 <span class="preprocessor"></span><span class="preprocessor">#   } else { # $ext is not recognized</span>
<a name="l01289"></a>01289 <span class="preprocessor"></span><span class="preprocessor">#       ################################################################################</span>
<a name="l01290"></a>01290 <span class="preprocessor"></span><span class="preprocessor">#       # FILES  with unrecognized file extensions in any display modes</span>
<a name="l01291"></a>01291 <span class="preprocessor"></span><span class="preprocessor">#       ################################################################################</span>
<a name="l01292"></a>01292 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01293"></a>01293 <span class="preprocessor"></span><span class="preprocessor">#       warn &quot;Error in the macro alias. Alias does not understand how to process files with extension $ext.  (Path ot problem file is  $fileName) &quot;;</span>
<a name="l01294"></a>01294 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l01295"></a>01295 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01296"></a>01296 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;The macro alias was unable to form a URL for some auxiliary file used in this problem.&quot; unless $adr_output;</span>
<a name="l01297"></a>01297 <span class="preprocessor"></span><span class="preprocessor">#   return $adr_output;</span>
<a name="l01298"></a>01298 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l01299"></a>01299 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01300"></a>01300 <span class="preprocessor"></span><span class="preprocessor"># =head2 sourceAlias</span>
<a name="l01301"></a>01301 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01302"></a>01302 <span class="preprocessor"></span><span class="preprocessor">#   sourceAlias($path_to_PG_file);</span>
<a name="l01303"></a>01303 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01304"></a>01304 <span class="preprocessor"></span><span class="preprocessor"># Returns a relative URL to the F&lt;source.pl&gt; script, which may be installed in a</span>
<a name="l01305"></a>01305 <span class="preprocessor"></span><span class="preprocessor"># course&#39;s F&lt;html&gt; directory to allow formatted viewing of the problem source.</span>
<a name="l01306"></a>01306 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01307"></a>01307 <span class="preprocessor"></span><span class="preprocessor"># =cut</span>
<a name="l01308"></a>01308 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01309"></a>01309 <span class="preprocessor"></span><span class="preprocessor"># # ^function sourceAlias</span>
<a name="l01310"></a>01310 <span class="preprocessor"></span><span class="preprocessor"># # ^uses PG_restricted_eval</span>
<a name="l01311"></a>01311 <span class="preprocessor"></span><span class="preprocessor"># # ^uses %envir</span>
<a name="l01312"></a>01312 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{inputs_ref}</span>
<a name="l01313"></a>01313 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{psvn}</span>
<a name="l01314"></a>01314 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{probNum}</span>
<a name="l01315"></a>01315 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{displayMode}</span>
<a name="l01316"></a>01316 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{courseName}</span>
<a name="l01317"></a>01317 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $envir{sessionKey}</span>
<a name="l01318"></a>01318 <span class="preprocessor"></span><span class="preprocessor"># sub sourceAlias {</span>
<a name="l01319"></a>01319 <span class="preprocessor"></span><span class="preprocessor">#   my $path_to_file = shift;</span>
<a name="l01320"></a>01320 <span class="preprocessor"></span><span class="preprocessor">#   my $envir        =  PG_restricted_eval(q!\%main::envir!);</span>
<a name="l01321"></a>01321 <span class="preprocessor"></span><span class="preprocessor">#   my $user         = $envir-&gt;{inputs_ref}-&gt;{user};</span>
<a name="l01322"></a>01322 <span class="preprocessor"></span><span class="preprocessor">#   $user            = &quot; &quot; unless defined($user);</span>
<a name="l01323"></a>01323 <span class="preprocessor"></span><span class="preprocessor">#     my $out = &#39;source.pl?probSetKey=&#39;  . $envir-&gt;{psvn}.</span>
<a name="l01324"></a>01324 <span class="preprocessor"></span><span class="preprocessor">#                 &#39;&amp;amp;probNum=&#39;          . $envir-&gt;{probNum} .</span>
<a name="l01325"></a>01325 <span class="preprocessor"></span><span class="preprocessor">#                 &#39;&amp;amp;Mode=&#39;             . $envir-&gt;{displayMode} .</span>
<a name="l01326"></a>01326 <span class="preprocessor"></span><span class="preprocessor">#                 &#39;&amp;amp;course=&#39;           . $envir-&gt;{courseName} .</span>
<a name="l01327"></a>01327 <span class="preprocessor"></span><span class="preprocessor">#             &#39;&amp;amp;user=&#39;             . $user .</span>
<a name="l01328"></a>01328 <span class="preprocessor"></span><span class="preprocessor">#             &#39;&amp;amp;displayPath=&#39;      . $path_to_file .</span>
<a name="l01329"></a>01329 <span class="preprocessor"></span><span class="preprocessor">#             &#39;&amp;amp;key=&#39;              . $envir-&gt;{sessionKey};</span>
<a name="l01330"></a>01330 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01331"></a>01331 <span class="preprocessor"></span><span class="preprocessor">#    $out;</span>
<a name="l01332"></a>01332 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l01333"></a>01333 <span class="preprocessor"></span>
<a name="l01334"></a>01334 <span class="preprocessor"># </span>
<a name="l01335"></a>01335 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l01336"></a>01336 <span class="preprocessor"></span><span class="preprocessor"># #  Some constants that can be used in perl experssions</span>
<a name="l01337"></a>01337 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l01338"></a>01338 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01339"></a>01339 <span class="preprocessor"></span><span class="preprocessor"># # ^function i</span>
<a name="l01340"></a>01340 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $_parser_loaded</span>
<a name="l01341"></a>01341 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;Complex::i</span>
<a name="l01342"></a>01342 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;Value::Package</span>
<a name="l01343"></a>01343 <span class="preprocessor"></span><span class="preprocessor"># sub i () {</span>
<a name="l01344"></a>01344 <span class="preprocessor"></span><span class="preprocessor">#   #  check if Parser.pl is loaded, otherwise use Complex package</span>
<a name="l01345"></a>01345 <span class="preprocessor"></span><span class="preprocessor">#   if (!eval(q!$main::_parser_loaded!)) {return Complex::i}</span>
<a name="l01346"></a>01346 <span class="preprocessor"></span><span class="preprocessor">#   return Value-&gt;Package(&quot;Formula&quot;)-&gt;new(&#39;i&#39;)-&gt;eval;</span>
<a name="l01347"></a>01347 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l01348"></a>01348 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01349"></a>01349 <span class="preprocessor"></span><span class="preprocessor"># # ^function j</span>
<a name="l01350"></a>01350 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $_parser_loaded</span>
<a name="l01351"></a>01351 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;Value::Package</span>
<a name="l01352"></a>01352 <span class="preprocessor"></span><span class="preprocessor"># sub j () {</span>
<a name="l01353"></a>01353 <span class="preprocessor"></span><span class="preprocessor">#   if (!eval(q!$main::_parser_loaded!)) {return &#39;j&#39;}</span>
<a name="l01354"></a>01354 <span class="preprocessor"></span><span class="preprocessor">#   Value-&gt;Package(&quot;Formula&quot;)-&gt;new(&#39;j&#39;)-&gt;eval;</span>
<a name="l01355"></a>01355 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l01356"></a>01356 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01357"></a>01357 <span class="preprocessor"></span><span class="preprocessor"># # ^function k</span>
<a name="l01358"></a>01358 <span class="preprocessor"></span><span class="preprocessor"># # ^uses $_parser_loaded</span>
<a name="l01359"></a>01359 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;Value::Package</span>
<a name="l01360"></a>01360 <span class="preprocessor"></span><span class="preprocessor"># sub k () {</span>
<a name="l01361"></a>01361 <span class="preprocessor"></span><span class="preprocessor">#   if (!eval(q!$main::_parser_loaded!)) {return &#39;k&#39;}</span>
<a name="l01362"></a>01362 <span class="preprocessor"></span><span class="preprocessor">#   Value-&gt;Package(&quot;Formula&quot;)-&gt;new(&#39;k&#39;)-&gt;eval;</span>
<a name="l01363"></a>01363 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l01364"></a>01364 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01365"></a>01365 <span class="preprocessor"></span><span class="preprocessor"># # ^function pi</span>
<a name="l01366"></a>01366 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;Value::Package</span>
<a name="l01367"></a>01367 <span class="preprocessor"></span><span class="preprocessor"># sub pi () {Value-&gt;Package(&quot;Formula&quot;)-&gt;new(&#39;pi&#39;)-&gt;eval}</span>
<a name="l01368"></a>01368 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01369"></a>01369 <span class="preprocessor"></span><span class="preprocessor"># # ^function Infinity</span>
<a name="l01370"></a>01370 <span class="preprocessor"></span><span class="preprocessor"># # ^uses &amp;Value::Package</span>
<a name="l01371"></a>01371 <span class="preprocessor"></span><span class="preprocessor"># sub Infinity () {Value-&gt;Package(&quot;Infinity&quot;)-&gt;new()}</span>
<a name="l01372"></a>01372 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01373"></a>01373 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01374"></a>01374 <span class="preprocessor"></span><span class="preprocessor"># # ^function abs</span>
<a name="l01375"></a>01375 <span class="preprocessor"></span><span class="preprocessor"># # ^function sqrt</span>
<a name="l01376"></a>01376 <span class="preprocessor"></span><span class="preprocessor"># # ^function exp</span>
<a name="l01377"></a>01377 <span class="preprocessor"></span><span class="preprocessor"># # ^function log</span>
<a name="l01378"></a>01378 <span class="preprocessor"></span><span class="preprocessor"># # ^function sin</span>
<a name="l01379"></a>01379 <span class="preprocessor"></span><span class="preprocessor"># # ^function cos</span>
<a name="l01380"></a>01380 <span class="preprocessor"></span><span class="preprocessor"># # ^function atan2</span>
<a name="l01381"></a>01381 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l01382"></a>01382 <span class="preprocessor"></span><span class="preprocessor"># #  Allow these functions to be overridden</span>
<a name="l01383"></a>01383 <span class="preprocessor"></span><span class="preprocessor"># #  (needed for log() to implement $useBaseTenLog)</span>
<a name="l01384"></a>01384 <span class="preprocessor"></span><span class="preprocessor"># #</span>
<a name="l01385"></a>01385 <span class="preprocessor"></span><span class="preprocessor"># use subs &#39;abs&#39;, &#39;sqrt&#39;, &#39;exp&#39;, &#39;log&#39;, &#39;sin&#39;, &#39;cos&#39;, &#39;atan2&#39;;</span>
<a name="l01386"></a>01386 <span class="preprocessor"></span><span class="preprocessor"># sub abs($)  {return CORE::abs($_[0])};</span>
<a name="l01387"></a>01387 <span class="preprocessor"></span><span class="preprocessor"># sub sqrt($) {return CORE::sqrt($_[0])};</span>
<a name="l01388"></a>01388 <span class="preprocessor"></span><span class="preprocessor"># sub exp($)  {return CORE::exp($_[0])};</span>
<a name="l01389"></a>01389 <span class="preprocessor"></span><span class="preprocessor"># sub log($)  {return CORE::log($_[0])};</span>
<a name="l01390"></a>01390 <span class="preprocessor"></span><span class="preprocessor"># sub sin($)  {return CORE::sin($_[0])};</span>
<a name="l01391"></a>01391 <span class="preprocessor"></span><span class="preprocessor"># sub cos($)  {return CORE::cos($_[0])};</span>
<a name="l01392"></a>01392 <span class="preprocessor"></span><span class="preprocessor"># sub atan2($$) {return CORE::atan2($_[0],$_[1])};</span>
<a name="l01393"></a>01393 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01394"></a>01394 <span class="preprocessor"></span><span class="preprocessor"># sub Parser::defineLog {eval {sub log($) {CommonFunction-&gt;Call(&quot;log&quot;,@_)}}};</span>
<a name="l01395"></a>01395 <span class="preprocessor"></span>sub foobar {
<a name="l01396"></a>01396     my $self = shift;
<a name="l01397"></a>01397 
<a name="l01398"></a>01398 }
<a name="l01399"></a>01399 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:54:54 2012 for PG by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
