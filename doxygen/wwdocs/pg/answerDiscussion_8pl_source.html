<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PG: answerDiscussion.pl Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
<h1>answerDiscussion.pl</h1><a href="answerDiscussion_8pl.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">######################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor">#  This file implements discussion-based questions, where the student</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor">#  can provide essay-style answers, and the professor can make comments</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor">#  on those.  The student and professor can continue to respond to</span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor">#  either other, and so carry on a mathematical discussion.  The</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor">#  discussion is private between the professor and student, with</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor">#  each student carrying on a separate discussion with the professor.</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor">#  The professor can view a list of the students in the class with links</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor">#  to their discussions, and indications of how many new messages there</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor">#  are in each.</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor">#  The messages can contain mathematics by enclosing it with \(...\)</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">#  for in-line mathematics and \[...\] for display-mode math.  The</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor">#  mathematics is entered in TeX format.  It is also possible to use</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="preprocessor">#  Parser strings that are like the ones students give in normal formula</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span><span class="preprocessor">#  answer blanks.  These are enclosed in `...` or ``...`` for in-line</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span><span class="preprocessor">#  and display modes.  For example `sin(x/(x+1))` would have the same</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="preprocessor">#  effect as \(\sin\!\left(\frac{x}{x+1}\right)\), but is somewhat easier</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="preprocessor">#  to read.  [FIXME: a more complete Context() needs to be provided</span>
<a name="l00022"></a>00022 <span class="preprocessor"></span><span class="preprocessor">#  for this.]</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span><span class="preprocessor">#  To make discussions work properly, the professor must set up two files:</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#  one called courseStudentList.pg and one called courseProfessorList.pg,</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#  with the first containing a list of the userID&#39;s of the students in the</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span><span class="preprocessor">#  course and the second containing a list of the professor ID&#39;s.  Sample</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span><span class="preprocessor">#  files are provided that you can place in your course templates/macros</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="preprocessor">#  directory and edit to suit your needs.  Without these files, the</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="preprocessor">#  professor functions will not operate properly, though the students</span>
<a name="l00031"></a><a class="code" href="classDiscussion.html">00031</a> <span class="preprocessor"></span><span class="preprocessor">#  could still create entries on their own.</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#  To start a duscussion, simply assign answerDiscussion.pg to any homework</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#  set.  That&#39;s it.  The professors can write messages that are visible</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#  to all the students, so such a message could be used to provide the</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#  starting question for a discussion, for example.  Or the problem could</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#  be used by the student to keep a &quot;math journal&quot; for the course (you would</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#  want to be sure to keep the homework set open for the whole course in</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#  this case).</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span><span class="preprocessor">#  This code is currently considered experimental, and there are still features</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span><span class="preprocessor">#  the need to be added, but it gives a sense of what is possible.</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">######################################################################</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00046"></a>00046 loadMacros(
<a name="l00047"></a>00047   <span class="stringliteral">&quot;EV3P.pl&quot;</span>,
<a name="l00048"></a>00048   <span class="stringliteral">&quot;text2PG.pl&quot;</span>,
<a name="l00049"></a>00049 );
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 sub _answerDiscussion_init {}
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 <span class="preprocessor">######################################################################</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055 <span class="keyword">package </span>Discussion;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#  The defaults for the discussion</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>our %discussion = (
<a name="l00061"></a>00061   graderSummary =&gt; 
<a name="l00062"></a>00062     <span class="stringliteral">&#39;&lt;script&gt;(document.getElementsByName(&quot;previewAnswers&quot;))[0].parentNode.style.display=&quot;none&quot;;&lt;/script&gt;&#39;</span>,
<a name="l00063"></a>00063   upArrow     =&gt; <span class="stringliteral">&#39;&amp;#x25B2;&#39;</span>,
<a name="l00064"></a>00064   downArrow   =&gt; <span class="stringliteral">&#39;&amp;#x25BC;&#39;</span>,
<a name="l00065"></a>00065   rightArrow  =&gt; <span class="charliteral">&#39;&gt;&#39;</span>,  # &amp;#x25B6;
<a name="l00066"></a>00066   leftArrow   =&gt; <span class="charliteral">&#39;&lt;&#39;</span>,  # &amp;#x25C0;  # (Mozilla doesn<span class="stringliteral">&#39;t handle this well on a Mac)</span>
<a name="l00067"></a>00067 <span class="stringliteral">  selectMark  =&gt; &#39;</span>&amp;#x25B6;<span class="stringliteral">&#39;,</span>
<a name="l00068"></a>00068 <span class="stringliteral">  newMark     =&gt; &#39;</span> &lt;small&gt;[<span class="keyword">new</span>]&lt;/small&gt;<span class="stringliteral">&#39;,</span>
<a name="l00069"></a>00069 <span class="stringliteral">  CSSfile     =&gt; &quot;answerDiscussion.css&quot;,</span>
<a name="l00070"></a>00070 <span class="stringliteral">  CSSfilePG   =&gt; &quot;answerDiscussionCSS.pg&quot;,</span>
<a name="l00071"></a>00071 <span class="stringliteral">  profFile    =&gt; &quot;courseProfessorList.pg&quot;,</span>
<a name="l00072"></a>00072 <span class="stringliteral">  studentFile =&gt; &quot;courseStudentList.pg&quot;,</span>
<a name="l00073"></a>00073 <span class="stringliteral">  columns     =&gt; 5,</span>
<a name="l00074"></a>00074 <span class="stringliteral">  extension   =&gt; ($WWPlot::use_png)? &#39;</span>.png<span class="stringliteral">&#39;: &#39;</span>.gif<span class="stringliteral">&#39;,</span>
<a name="l00075"></a>00075 <span class="stringliteral">  allowStudentEdits =&gt; 0,</span>
<a name="l00076"></a>00076 <span class="stringliteral">);</span>
<a name="l00077"></a>00077 <span class="stringliteral"></span>
<a name="l00078"></a>00078 <span class="stringliteral">##################################################</span>
<a name="l00079"></a>00079 <span class="stringliteral">#</span>
<a name="l00080"></a>00080 <span class="stringliteral">#  Create a new discussion object</span>
<a name="l00081"></a>00081 <span class="stringliteral">#</span>
<a name="l00082"></a>00082 <span class="stringliteral">sub new {</span>
<a name="l00083"></a>00083 <span class="stringliteral">  my $self = shift; my $class = ref($self) || $self;</span>
<a name="l00084"></a>00084 <span class="stringliteral">  my $discussion = bless {%discussion,@_}, $class;</span>
<a name="l00085"></a>00085 <span class="stringliteral">  $main::inputs_ref-&gt;{user} = $main::studentLogin unless defined $main::inputs_ref-&gt;{user};</span>
<a name="l00086"></a>00086 <span class="stringliteral">  $main::inputs_ref-&gt;{effectiveUser} = $main::studentLogin unless defined $main::inputs_ref-&gt;{effectiveUser};</span>
<a name="l00087"></a>00087 <span class="stringliteral">  $discussion-&gt;getProfessors;</span>
<a name="l00088"></a>00088 <span class="stringliteral">  $discussion-&gt;{isActing} = ($main::inputs_ref-&gt;{user} ne $main::inputs_ref-&gt;{effectiveUser});</span>
<a name="l00089"></a>00089 <span class="stringliteral">  $discussion-&gt;{isProfessor} = $discussion-&gt;{isActing} || $discussion-&gt;isProfessor;</span>
<a name="l00090"></a>00090 <span class="stringliteral">  $discussion-&gt;{isSuperProf} = (defined($main::SuperProf) &amp;&amp; $main::SuperProf eq $main::inputs_ref-&gt;{user});</span>
<a name="l00091"></a>00091 <span class="stringliteral">  $discussion-&gt;{pastDue} = (time() &gt; $main::dueDate) &amp;&amp; !$self-&gt;{isProfessor};</span>
<a name="l00092"></a>00092 <span class="stringliteral">  return $discussion;</span>
<a name="l00093"></a>00093 <span class="stringliteral">}</span>
<a name="l00094"></a>00094 <span class="stringliteral"></span>
<a name="l00095"></a>00095 <span class="stringliteral">##################################################</span>
<a name="l00096"></a>00096 <span class="stringliteral">#</span>
<a name="l00097"></a>00097 <span class="stringliteral">#  make it easier to access the TEXT command in main::</span>
<a name="l00098"></a>00098 <span class="stringliteral">#</span>
<a name="l00099"></a>00099 <span class="stringliteral">sub TEXT {main::TEXT(@_)}</span>
<a name="l00100"></a>00100 <span class="stringliteral"></span>
<a name="l00101"></a>00101 <span class="stringliteral">##################################################</span>
<a name="l00102"></a>00102 <span class="stringliteral">#</span>
<a name="l00103"></a>00103 <span class="stringliteral">#  True if the user is a professor</span>
<a name="l00104"></a>00104 <span class="stringliteral">#</span>
<a name="l00105"></a>00105 <span class="stringliteral">sub isProfessor {</span>
<a name="l00106"></a>00106 <span class="stringliteral">  my $self = shift;</span>
<a name="l00107"></a>00107 <span class="stringliteral">  my $user = $main::inputs_ref-&gt;{user};</span>
<a name="l00108"></a>00108 <span class="stringliteral">  foreach my $prof (@main::ProfessorIds) {return 1 if $prof eq $user}</span>
<a name="l00109"></a>00109 <span class="stringliteral">  return 0;</span>
<a name="l00110"></a>00110 <span class="stringliteral">}</span>
<a name="l00111"></a>00111 <span class="stringliteral"></span>
<a name="l00112"></a>00112 <span class="stringliteral">##################################################</span>
<a name="l00113"></a>00113 <span class="stringliteral">#</span>
<a name="l00114"></a>00114 <span class="stringliteral">#  Get the list of professors from the courseProfessorList.pg file.</span>
<a name="l00115"></a>00115 <span class="stringliteral">#  (At some point this could be obtained from the database.)  We</span>
<a name="l00116"></a>00116 <span class="stringliteral">#  fail silently if the file can&#39;</span>t be read.
<a name="l00117"></a>00117 #
<a name="l00118"></a>00118 sub <a class="code" href="classDiscussion.html#a93b7020383481cac37f760ded1fb2518">getProfessors</a> {
<a name="l00119"></a>00119   my $self = shift;
<a name="l00120"></a>00120   <span class="keywordflow">if</span> (!defined(@main::ProfessorIds)) {
<a name="l00121"></a>00121     my $profFile = <a class="code" href="classmain.html#aa06734e89a497fdd530c567b450f28c2">main::findMacroFile</a>($self-&gt;{profFile});
<a name="l00122"></a>00122     <span class="keywordflow">return</span> unless $profFile;
<a name="l00123"></a>00123     my ($text,$error) = main::PG_restricted_eval(<span class="stringliteral">&quot;read_whole_file(&#39;$profFile&#39;)&quot;</span>);
<a name="l00124"></a>00124     <span class="keywordflow">return</span> unless $text;
<a name="l00125"></a>00125     main::PG_restricted_eval($$text);
<a name="l00126"></a>00126     <span class="keywordflow">return</span> unless defined(@main::ProfessorIds);
<a name="l00127"></a>00127   }
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="preprocessor">##################################################</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00132"></a>00132 <span class="preprocessor"></span><span class="preprocessor">#  Get the list of students from the courseStudentList.pg file.</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span><span class="preprocessor">#  (At some point this could be taken from the database.)</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>sub getStudents {
<a name="l00136"></a>00136   my $self = shift;
<a name="l00137"></a>00137   <span class="keywordflow">if</span> (!defined(@main::StudentIds)) {
<a name="l00138"></a>00138     @main::StudentIds = ();
<a name="l00139"></a>00139     my $studentFile = <a class="code" href="classmain.html#aa06734e89a497fdd530c567b450f28c2">main::findMacroFile</a>($self-&gt;{studentFile});
<a name="l00140"></a>00140     <span class="keywordflow">if</span> (!$studentFile) {warn <span class="stringliteral">&quot;You must provide a &#39;$self-&gt;{studentFile}&#39; file&quot;</span>; <span class="keywordflow">return</span>}
<a name="l00141"></a>00141     my ($text,$error) = main::PG_restricted_eval(<span class="stringliteral">&quot;read_whole_file(&#39;$studentFile&#39;)&quot;</span>);
<a name="l00142"></a>00142     <span class="keywordflow">if</span> ($error) {warn <span class="stringliteral">&quot;There was an error reading your &#39;$self-&gt;{studentFile}&#39; file:&lt;br /&gt;&quot;</span>.$error; <span class="keywordflow">return</span>}
<a name="l00143"></a>00143     ($text,$error) = main::PG_restricted_eval($$text);
<a name="l00144"></a>00144     <span class="keywordflow">if</span> ($error) {warn <span class="stringliteral">&quot;There was an error executing your &#39;$self-&gt;{studentFile}&#39; file:&lt;br /&gt;&quot;</span>.$error; <span class="keywordflow">return</span>}
<a name="l00145"></a>00145   }
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="preprocessor">##################################################</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span><span class="preprocessor">#  Create a partial URL used for links that maintain the current data on the page.</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>sub getURL {
<a name="l00153"></a>00153   my $self = shift; my $url = <span class="stringliteral">&quot;?&quot;</span>;
<a name="l00154"></a>00154   <span class="keywordflow">foreach</span> my $id (<span class="stringliteral">&#39;key&#39;</span>,<span class="stringliteral">&#39;displayMode&#39;</span>,<span class="stringliteral">&#39;user&#39;</span>,@_) {
<a name="l00155"></a>00155     $url .= <span class="stringliteral">&quot;$id=$self-&gt;{inputs}{$id}&amp;&quot;</span>
<a name="l00156"></a>00156       <span class="keywordflow">if</span> defined $self-&gt;{inputs}{$id} &amp;&amp; $self-&gt;{inputs}{$id} ne <span class="stringliteral">&#39;&#39;</span>;
<a name="l00157"></a>00157   }
<a name="l00158"></a>00158   <span class="keywordflow">return</span> $url;
<a name="l00159"></a>00159 }
<a name="l00160"></a>00160 
<a name="l00161"></a>00161 <span class="preprocessor">##################################################</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00163"></a>00163 <span class="preprocessor"></span><span class="preprocessor">#  Look up the styles from the answerDiscussion.css file.</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span><span class="preprocessor">#  This can be overridden by putting a modified copy in</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span><span class="preprocessor">#  your course templates/macros directory.</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>sub setStyles {
<a name="l00168"></a>00168   my $self = shift; my $css;
<a name="l00169"></a>00169   TEXT(<span class="stringliteral">&#39;&lt;STYLE&gt;.problemHeader {display:none}&lt;/STYLE&gt;&#39;</span>);
<a name="l00170"></a>00170   my $cssFile = <a class="code" href="classmain.html#aa06734e89a497fdd530c567b450f28c2">main::findMacroFile</a>($self-&gt;{CSSfile});
<a name="l00171"></a>00171 <span class="preprocessor">  ### FIXME:  do error checking here</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span>  $css =  main::read_whole_file($cssFile) if $cssFile;
<a name="l00173"></a>00173   TEXT(&#39;&lt;style&gt;&#39;.$$css.&#39;&lt;/style&gt;&#39;) if $css;
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="preprocessor">##################################################</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span><span class="preprocessor">#  Build the list of entries based on the private</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span><span class="preprocessor">#  list in the student&#39;s directory, and the public</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="preprocessor">#  ones in the professors&#39; directories.</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>sub getEntries {
<a name="l00183"></a>00183   my $self = shift; my @entries = ();
<a name="l00184"></a>00184   my $text = $self-&gt;Read(<span class="stringliteral">&quot;entries&quot;</span>);
<a name="l00185"></a>00185   push(@entries,split(/\n/,$text)) if defined($text);
<a name="l00186"></a>00186   $self-&gt;{localEntries} = [main::PGsort(\&amp;sortEntries,@entries)];
<a name="l00187"></a>00187   <span class="keywordflow">if</span> ($self-&gt;{isActing} || !$self-&gt;{isProfessor}) {
<a name="l00188"></a>00188     <span class="keywordflow">foreach</span> my $prof (@main::ProfessorIds) {
<a name="l00189"></a>00189       $text = $self-&gt;Read($prof.<span class="stringliteral">&#39;/entries&#39;</span>);
<a name="l00190"></a>00190       push(@entries,split(/\n/,$text)) if defined($text);
<a name="l00191"></a>00191     }
<a name="l00192"></a>00192   }
<a name="l00193"></a>00193   $self-&gt;{entries} = [main::PGsort(\&amp;sortEntries, @entries)];
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 sub sortEntries {(split(<span class="stringliteral">&#39;[-/]&#39;</span>,$_[0]))[1] &gt; (split(<span class="stringliteral">&#39;[-/]&#39;</span>,$_[1]))[1]}
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 ##################################################
<a name="l00198"></a>00198 #
<a name="l00199"></a>00199 #  Determine which are <span class="keyword">new</span> entries by comparing to the list
<a name="l00200"></a>00200 #  of entries that have been read.
<a name="l00201"></a>00201 #
<a name="l00202"></a>00202 sub getNewEntries {
<a name="l00203"></a>00203   my $self = shift; my $user = $self-&gt;{inputs}{user};
<a name="l00204"></a>00204   my @read = (); my %unread; my %alread;
<a name="l00205"></a>00205   my $text = $self-&gt;Read(<span class="stringliteral">&quot;read-&quot;</span>.$user);
<a name="l00206"></a>00206   push(@read,split(/\n/,$text)) if defined($text);
<a name="l00207"></a>00207   foreach my $entry (@{$self-&gt;{entries}}) {$unread{$entry} = 1 unless $entry =~ m/-$user$/o}
<a name="l00208"></a>00208   <span class="keywordflow">foreach</span> my $entry (@read) {$alread{$entry} = 1 unless $entry =~ m/-$user$/o}
<a name="l00209"></a>00209   <span class="keywordflow">foreach</span> my $entry (@read) {<span class="keyword">delete</span> $unread{$entry}}
<a name="l00210"></a>00210   $self-&gt;{newEntries} = \%unread;
<a name="l00211"></a>00211   $self-&gt;{oldEntries} = \%alread;
<a name="l00212"></a>00212 }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 <span class="preprocessor">##################################################</span>
<a name="l00215"></a>00215 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00216"></a>00216 <span class="preprocessor"></span><span class="preprocessor">#  Get the number of new messages from a give student</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span><span class="preprocessor">#  (used in building the array of student messages</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span><span class="preprocessor">#  for the professor).</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span>sub getUnreadCount {
<a name="l00221"></a>00221   my $self = shift; my $student = shift;
<a name="l00222"></a>00222   my $user = $self-&gt;{inputs}{user};
<a name="l00223"></a>00223   my $text = $self-&gt;Read(<span class="stringliteral">&quot;$student/entries&quot;</span>);
<a name="l00224"></a>00224   <span class="keywordflow">return</span> 0 unless defined $text;
<a name="l00225"></a>00225   my %unread; 
<a name="l00226"></a>00226   <span class="keywordflow">foreach</span> my $entry (split(/\n/,$text)) {$unread{$entry} = 1 unless $entry =~ m/-$user$/o}
<a name="l00227"></a>00227   $text = $self-&gt;Read(<span class="stringliteral">&quot;$student/read-$user&quot;</span>);
<a name="l00228"></a>00228   <span class="keywordflow">if</span> (defined($text)) {<span class="keywordflow">foreach</span> my $entry (split(/\n/,$text)) {<span class="keyword">delete</span> $unread{$entry}}}
<a name="l00229"></a>00229   <span class="keywordflow">return</span> scalar(keys %unread);
<a name="l00230"></a>00230 }
<a name="l00231"></a>00231 
<a name="l00232"></a>00232 <span class="preprocessor">##################################################</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span><span class="preprocessor">#  Get the number of new messages from a give student</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span><span class="preprocessor">#  (used in building the array of student messages</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span><span class="preprocessor">#  for the professor).</span>
<a name="l00237"></a>00237 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span>sub getAlreadCount {
<a name="l00239"></a>00239   my $self = shift; my $student = shift;
<a name="l00240"></a>00240   my $user = $self-&gt;{inputs}{user};
<a name="l00241"></a>00241   my $text = $self-&gt;Read(<span class="stringliteral">&quot;$student/entries&quot;</span>);
<a name="l00242"></a>00242   <span class="keywordflow">return</span> 0 unless defined $text;
<a name="l00243"></a>00243   my %alread;
<a name="l00244"></a>00244   <span class="keywordflow">foreach</span> my $entry (split(/\n/,$text)) {$alread{$entry} = 1}
<a name="l00245"></a>00245   <span class="keywordflow">return</span> scalar(keys %alread);
<a name="l00246"></a>00246 }
<a name="l00247"></a>00247 <span class="preprocessor">##################################################</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span><span class="preprocessor">#  True if the given entry hasn&#39;t been read yet</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span>sub isNew {
<a name="l00252"></a>00252   my $self = shift; my $entry = shift;
<a name="l00253"></a>00253   <span class="keywordflow">return</span> $self-&gt;{newEntries}{$entry};
<a name="l00254"></a>00254 }
<a name="l00255"></a>00255 
<a name="l00256"></a>00256 <span class="preprocessor">##################################################</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span><span class="preprocessor">#  True if the user is the author of the given entry</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span>sub amAuthor {
<a name="l00261"></a>00261   my $self = shift; my $entry = shift;
<a name="l00262"></a>00262   my ($name,$user) = $self-&gt;ParseEntryName($entry);
<a name="l00263"></a>00263   <span class="keywordflow">return</span> $user eq $self-&gt;{inputs}{user};
<a name="l00264"></a>00264 }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266 <span class="preprocessor">##################################################</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span><span class="preprocessor">#  Get the formatted name and user from the entry</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span><span class="preprocessor">#  file name</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span>sub ParseEntryName {
<a name="l00272"></a>00272   my $self = shift;
<a name="l00273"></a>00273   my ($dir,$time,$user) = split(<span class="stringliteral">&#39;[-/]&#39;</span>,shift);
<a name="l00274"></a>00274   my ($sec,$min,$hour,$mday,$mon,$year) = localtime($time);
<a name="l00275"></a>00275   my $name = <a class="code" href="classmain.html#a1a9a1ce6369dcdbba8c58f88d00460c5">main::spf</a>($year+1900,<span class="stringliteral">&quot;%04d&quot;</span>).<span class="stringliteral">&quot;-&quot;</span>.<a class="code" href="classmain.html#a1a9a1ce6369dcdbba8c58f88d00460c5">main::spf</a>($mon+1,<span class="stringliteral">&quot;%02d&quot;</span>).<span class="stringliteral">&quot;-&quot;</span>.<a class="code" href="classmain.html#a1a9a1ce6369dcdbba8c58f88d00460c5">main::spf</a>($mday+1,<span class="stringliteral">&quot;%02d&quot;</span>).<span class="stringliteral">&quot; &quot;</span>
<a name="l00276"></a>00276            . <a class="code" href="classmain.html#a1a9a1ce6369dcdbba8c58f88d00460c5">main::spf</a>($hour,<span class="stringliteral">&quot;%02d&quot;</span>).<span class="stringliteral">&quot;:&quot;</span>.<a class="code" href="classmain.html#a1a9a1ce6369dcdbba8c58f88d00460c5">main::spf</a>($min,<span class="stringliteral">&quot;%02d&quot;</span>);
<a name="l00277"></a>00277   <span class="keywordflow">return</span> ($name,$user);
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 <span class="preprocessor">##################################################</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">#  Find the currently selected entry based on the</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span><span class="preprocessor">#  current action and the state contained in the</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span><span class="preprocessor">#  form.</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span>sub selectedEntry {
<a name="l00287"></a>00287   my $self = shift; my $action = $self-&gt;{action};
<a name="l00288"></a>00288   <span class="keywordflow">return</span> <span class="keywordflow">if</span> $action eq <span class="stringliteral">&#39;View All&#39;</span>;
<a name="l00289"></a>00289   <span class="keywordflow">if</span> ($action eq <span class="stringliteral">&#39;Clear&#39;</span>) {
<a name="l00290"></a>00290     <span class="keyword">delete</span> $self-&gt;{inputs}{entry};
<a name="l00291"></a>00291     <span class="keyword">delete</span> $self-&gt;{inputs}{preview};
<a name="l00292"></a>00292   }
<a name="l00293"></a>00293   <span class="keywordflow">if</span> ($action eq <span class="stringliteral">&#39;Compose&#39;</span> || $action eq <span class="stringliteral">&#39;Respond&#39;</span>) {
<a name="l00294"></a>00294     <span class="keyword">delete</span> $self-&gt;{inputs}{entry};
<a name="l00295"></a>00295     <span class="keyword">delete</span> $self-&gt;{inputs}{preview};
<a name="l00296"></a>00296     <span class="keyword">delete</span> $self-&gt;{inputs}{source};
<a name="l00297"></a>00297     <span class="keyword">delete</span> $self-&gt;{inputs}{editing};
<a name="l00298"></a>00298     $self-&gt;{inputs}{compose} = 1;
<a name="l00299"></a>00299     <span class="keywordflow">return</span> <span class="keywordflow">if</span> $action eq <span class="stringliteral">&#39;Compose&#39;</span>;
<a name="l00300"></a>00300   }
<a name="l00301"></a>00301   <span class="keywordflow">return</span> $self-&gt;MakeEntry <span class="keywordflow">if</span> $action eq <span class="stringliteral">&#39;Make Entry&#39;</span> || $action eq <span class="stringliteral">&#39;Update Entry&#39;</span>;
<a name="l00302"></a>00302   <span class="keywordflow">return</span> $self-&gt;DeleteEntry(0) <span class="keywordflow">if</span> $action eq <span class="stringliteral">&#39;Delete&#39;</span>;
<a name="l00303"></a>00303   <span class="keywordflow">return</span> $self-&gt;DeleteEntry(1) <span class="keywordflow">if</span> $action eq <span class="stringliteral">&#39;Yes&#39;</span>;
<a name="l00304"></a>00304   <span class="keywordflow">return</span> $self-&gt;EditEntry <span class="keywordflow">if</span> $action eq <span class="stringliteral">&#39;Edit&#39;</span>;
<a name="l00305"></a>00305   <span class="keywordflow">return</span> $self-&gt;{inputs}{next} <span class="keywordflow">if</span> $self-&gt;{inputs}{goNext};
<a name="l00306"></a>00306   <span class="keywordflow">return</span> $self-&gt;{inputs}{prev} <span class="keywordflow">if</span> $self-&gt;{inputs}{goPrev};
<a name="l00307"></a>00307   <span class="keywordflow">return</span> $self-&gt;{inputs}{go} <span class="keywordflow">if</span> $self-&gt;{inputs}{go};
<a name="l00308"></a>00308   <span class="keywordflow">return</span> $self-&gt;{inputs}{selected} <span class="keywordflow">if</span> $self-&gt;{inputs}{selected};
<a name="l00309"></a>00309   <span class="keywordflow">return</span> <span class="keywordflow">if</span> $action eq <span class="stringliteral">&#39;Clear&#39;</span> || $action eq <span class="stringliteral">&#39;Preview&#39;</span>;
<a name="l00310"></a>00310   <span class="keywordflow">return</span> $self-&gt;firstEntry;
<a name="l00311"></a>00311 }
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="preprocessor">##################################################</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00315"></a>00315 <span class="preprocessor"></span><span class="preprocessor">#  Find the first (oldest) unread message</span>
<a name="l00316"></a>00316 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span>sub firstEntry {
<a name="l00318"></a>00318   my $self = shift;
<a name="l00319"></a>00319   <span class="keywordflow">return</span> unless $self-&gt;{entries} &amp;&amp; scalar(@{$self-&gt;{entries}});
<a name="l00320"></a>00320   my @unread = keys %{$self-&gt;{newEntries}};
<a name="l00321"></a>00321   <span class="keywordflow">return</span> $self-&gt;{entries}[0] unless scalar(@unread);
<a name="l00322"></a>00322   <span class="keywordflow">return</span> (main::PGsort(\&amp;sortEntries,@unread))[-1];
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325 <span class="preprocessor">######################################################################</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span><span class="preprocessor">######################################################################</span>
<a name="l00327"></a>00327 <span class="preprocessor"></span>
<a name="l00328"></a>00328 <span class="preprocessor">#</span>
<a name="l00329"></a>00329 <span class="preprocessor"></span><span class="preprocessor">#  Initialize a discussion problem</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span><span class="preprocessor">#  (get the initial data and start the table that</span>
<a name="l00331"></a>00331 <span class="preprocessor"></span><span class="preprocessor">#  holds the various windows)</span>
<a name="l00332"></a>00332 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span>sub Begin {
<a name="l00334"></a>00334   my $self = shift;
<a name="l00335"></a>00335   $self-&gt;setStyles;
<a name="l00336"></a>00336   $self-&gt;Grader;
<a name="l00337"></a>00337   $self-&gt;{inputs} = $main::inputs_ref;
<a name="l00338"></a>00338   $self-&gt;{action} = $self-&gt;{inputs}{action} || <span class="stringliteral">&#39;&#39;</span>;
<a name="l00339"></a>00339   $self-&gt;getEntries;
<a name="l00340"></a>00340   $self-&gt;getNewEntries;
<a name="l00341"></a>00341   TEXT(<span class="stringliteral">&#39;&lt;div id=&quot;discussion&quot;&gt;&#39;</span>);
<a name="l00342"></a>00342   TEXT(<span class="stringliteral">&quot;&lt;script&gt;&quot;</span>
<a name="l00343"></a>00343       .<span class="stringliteral">&quot;  function closePreview () {\n&quot;</span>
<a name="l00344"></a>00344       .<span class="stringliteral">&quot;    document.getElementById(&#39;Preview&#39;).parentNode.style.display=&#39;none&#39;;\n&quot;</span>
<a name="l00345"></a>00345       .<span class="stringliteral">&quot;    (document.getElementsByName(&#39;preview&#39;))[0].value = 0;\n&quot;</span>
<a name="l00346"></a>00346       .<span class="stringliteral">&quot;  }\n&quot;</span>
<a name="l00347"></a>00347       .<span class="stringliteral">&quot;&lt;/script&gt;&quot;</span>);
<a name="l00348"></a>00348   TEXT(<span class="stringliteral">&#39;&lt;p&gt;&lt;table border=&quot;0&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot; width=&quot;100%&quot;&gt;&#39;</span>.
<a name="l00349"></a>00349        <span class="stringliteral">&#39;&lt;tr valign=&quot;top&quot;&gt;&lt;td align=&quot;left&quot; id=&quot;leftPane&quot;&gt;&#39;</span>);
<a name="l00350"></a>00350 }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="preprocessor">##################################################</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span><span class="preprocessor">#  End the left column and start the right</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00356"></a>00356 <span class="preprocessor"></span>sub Middle {
<a name="l00357"></a>00357   TEXT(<span class="stringliteral">&#39;&lt;/td&gt;&lt;td id=&quot;rightPane&quot;&gt;&#39;</span>);
<a name="l00358"></a>00358 }
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="preprocessor">##################################################</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span><span class="preprocessor">#  End the problem (and its associated table).</span>
<a name="l00363"></a>00363 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00364"></a>00364 <span class="preprocessor"></span>sub End {
<a name="l00365"></a>00365   TEXT(<span class="stringliteral">&#39;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&#39;</span>);
<a name="l00366"></a>00366   TEXT(<span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>);
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <span class="preprocessor">######################################################################</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span><span class="preprocessor">######################################################################</span>
<a name="l00371"></a>00371 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span><span class="preprocessor">#  Draw the Composition text entry area.  Use the</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span><span class="preprocessor">#  correct wording for creating a new message</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span><span class="preprocessor">#  versus editing an old one.  Show the preview</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span><span class="preprocessor">#  box, if requested.</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span>sub ComposeEntry {
<a name="l00378"></a>00378   my $self = shift;
<a name="l00379"></a>00379 
<a name="l00380"></a>00380   <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{pastDue};
<a name="l00381"></a>00381 
<a name="l00382"></a>00382   my $entry = $self-&gt;{inputs}{entry};
<a name="l00383"></a>00383   $self-&gt;Panel(
<a name="l00384"></a>00384     <span class="keywordtype">id</span> =&gt; <span class="stringliteral">&#39;Preview&#39;</span>,
<a name="l00385"></a>00385     title =&gt; <span class="stringliteral">&#39;&amp;nbsp; Preview: &amp;nbsp; &amp;nbsp;&#39;</span>,
<a name="l00386"></a>00386     box =&gt;<span class="stringliteral">&#39;&lt;div class=&quot;close&quot; onclick=&quot;closePreview()&quot;&gt;&lt;/div&gt;&#39;</span>,
<a name="l00387"></a>00387     text =&gt; $entry,
<a name="l00388"></a>00388   ) <span class="keywordflow">if</span> (defined($entry) &amp;&amp; ($self-&gt;{action} eq <span class="stringliteral">&#39;Preview&#39;</span> || $self-&gt;{inputs}{preview}));
<a name="l00389"></a>00389 
<a name="l00390"></a>00390   $entry = <span class="stringliteral">&quot;&quot;</span> unless defined($entry);
<a name="l00391"></a>00391   $entry =~ s/&amp;/&amp;amp;/g;
<a name="l00392"></a>00392   $entry =~ s/&lt;/&amp;lt;/g;
<a name="l00393"></a>00393   $entry =~ s/&gt;/&amp;gt;/g;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395   my ($compose,$make) = 
<a name="l00396"></a>00396     ($self-&gt;{inputs}{editing} ? (<span class="stringliteral">&quot;Update&quot;</span>,<span class="stringliteral">&quot;Update&quot;</span>) : (<span class="stringliteral">&quot;Compose&quot;</span>,<span class="stringliteral">&quot;Make&quot;</span>));
<a name="l00397"></a>00397 
<a name="l00398"></a>00398   $self-&gt;Panel(
<a name="l00399"></a>00399     <span class="keywordtype">id</span> =&gt; <span class="stringliteral">&#39;Compose&#39;</span>,
<a name="l00400"></a>00400     title =&gt; $compose.<span class="stringliteral">&#39; your message below:&#39;</span>,
<a name="l00401"></a>00401     box =&gt; <span class="stringliteral">&#39;&lt;div class=&quot;help&quot;&gt;[&lt;a href=&quot;http://webwork.math.rochester.edu/docs/docs/studentintro.html&quot; target=&quot;WW_help&quot;&gt;Help&lt;/a&gt;]&lt;/div&gt;&#39;</span>,
<a name="l00402"></a>00402     html =&gt; 
<a name="l00403"></a>00403       <span class="stringliteral">&#39;&lt;table border=&quot;0&quot; cellspacing=&quot;5&quot; cellpadding=&quot;0&quot;&gt;&#39;</span>.
<a name="l00404"></a>00404         <span class="stringliteral">&#39;&lt;tr&gt;&lt;td colspan=&quot;3&quot; align=&quot;center&quot;&gt;&#39;</span>.
<a name="l00405"></a>00405         <span class="stringliteral">&#39;&lt;textarea name=&quot;entry&quot; id=&quot;entry&quot;&gt;&#39;</span>.$entry.<span class="stringliteral">&#39;&lt;/textarea&gt;&#39;</span>.
<a name="l00406"></a>00406         <span class="stringliteral">&#39;&lt;/td&gt;&lt;/tr&gt;&#39;</span>.
<a name="l00407"></a>00407         <span class="stringliteral">&#39;&lt;tr&gt;&#39;</span>.
<a name="l00408"></a>00408           <span class="stringliteral">&#39;&lt;td width=&quot;33%&quot; align=&quot;center&quot;&gt;&#39;</span>.
<a name="l00409"></a>00409             <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;Clear&quot; /&gt;&#39;</span>.
<a name="l00410"></a>00410           <span class="stringliteral">&#39;&lt;/td&gt;&#39;</span>.
<a name="l00411"></a>00411           <span class="stringliteral">&#39;&lt;td width=&quot;33%&quot; align=&quot;center&quot;&gt;&#39;</span>.
<a name="l00412"></a>00412             <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;&#39;</span>.$make.<span class="stringliteral">&#39; Entry&quot; /&gt;&#39;</span>.
<a name="l00413"></a>00413           <span class="stringliteral">&#39;&lt;/td&gt;&#39;</span>.
<a name="l00414"></a>00414           <span class="stringliteral">&#39;&lt;td width=&quot;33%&quot; align=&quot;center&quot;&gt;&#39;</span>.
<a name="l00415"></a>00415             <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;Preview&quot; /&gt;&#39;</span>.
<a name="l00416"></a>00416           <span class="stringliteral">&#39;&lt;/td&gt;&#39;</span>.
<a name="l00417"></a>00417         <span class="stringliteral">&#39;&lt;/tr&gt;&#39;</span>.
<a name="l00418"></a>00418       <span class="stringliteral">&#39;&lt;/table&gt;&#39;</span>
<a name="l00419"></a>00419   );
<a name="l00420"></a>00420     
<a name="l00421"></a>00421   TEXT(<span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;editing&quot; value=&quot;&#39;</span>.$self-&gt;{inputs}{editing}.<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>)
<a name="l00422"></a>00422     if $self-&gt;{inputs}{editing};
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 <span class="preprocessor">######################################################################</span>
<a name="l00427"></a>00427 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00428"></a>00428 <span class="preprocessor"></span><span class="preprocessor">#  Draw the list of entries an dassociated buttons.</span>
<a name="l00429"></a>00429 <span class="preprocessor"></span><span class="preprocessor">#  Mark the new ones as new, and highlight the</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span><span class="preprocessor">#  selected one.  Make sure the proper buttons</span>
<a name="l00431"></a>00431 <span class="preprocessor"></span><span class="preprocessor">#  are active.</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00433"></a>00433 <span class="preprocessor"></span>sub EntryPanel {
<a name="l00434"></a>00434   my $self = shift;
<a name="l00435"></a>00435   my $selected = shift || $self-&gt;{selected} || 0;
<a name="l00436"></a>00436   my $url = $self-&gt;getURL(<span class="stringliteral">&#39;effectiveUser&#39;</span>).<span class="stringliteral">&#39;go=&#39;</span>;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438   my @rows; my $row; my $si = -1;
<a name="l00439"></a>00439   <span class="keywordflow">foreach</span> my $entry (@{$self-&gt;{entries}}) {
<a name="l00440"></a>00440     my ($name,$user) = $self-&gt;ParseEntryName($entry);
<a name="l00441"></a>00441     my ($new,$NEW) = ($self-&gt;isNew($entry) ? ($self-&gt;{newMark},<span class="stringliteral">&#39; class=&quot;new&quot;&#39;</span>) : (<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>));
<a name="l00442"></a>00442     <span class="keywordflow">if</span> ($si &lt; 0 &amp;&amp; $entry eq $selected) {
<a name="l00443"></a>00443       $row = <span class="stringliteral">&#39;&lt;tr&gt;&#39;</span>
<a name="l00444"></a>00444            . <span class="stringliteral">&#39;&lt;td align=&quot;right&quot;&gt;&#39;</span>.$self-&gt;{selectMark}.<span class="stringliteral">&#39;&lt;/td&gt;&#39;</span>
<a name="l00445"></a>00445        . <span class="stringliteral">&quot;&lt;td$NEW&gt;$name ($user)$new&lt;/td&gt;&quot;</span>
<a name="l00446"></a>00446        . <span class="stringliteral">&#39;&lt;/tr&gt;&#39;</span>;
<a name="l00447"></a>00447       $si = scalar(@rows);
<a name="l00448"></a>00448     } <span class="keywordflow">else</span> {
<a name="l00449"></a>00449       $row = <span class="stringliteral">&#39;&lt;tr&gt;&#39;</span>
<a name="l00450"></a>00450        . <span class="stringliteral">&#39;&lt;td&gt;&lt;/td&gt;&#39;</span>
<a name="l00451"></a>00451        . qq!&lt;td$NEW&gt;&lt;a href=<span class="stringliteral">&quot;$url$entry&quot;</span>&gt;$name&lt;/a&gt; ($user)$new&lt;/td&gt;!
<a name="l00452"></a>00452            . <span class="stringliteral">&#39;&lt;/tr&gt;&#39;</span>;
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454     push(@rows,$row);
<a name="l00455"></a>00455   }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   my ($UP,$DOWN,$VIEW,$COMPOSE) = (<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>);
<a name="l00458"></a>00458   $UP   = <span class="stringliteral">&quot; disabled&quot;</span> unless $si &gt; 0;
<a name="l00459"></a>00459   $DOWN = <span class="stringliteral">&quot; disabled&quot;</span> unless $si &gt;= 0 &amp;&amp; $si &lt; $#rows;
<a name="l00460"></a>00460   $VIEW = <span class="stringliteral">&quot; disabled&quot;</span> unless @rows;
<a name="l00461"></a>00461   push(@rows,<span class="stringliteral">&#39;&lt;tr&gt;&lt;td&gt;&lt;/td&gt;&lt;td&gt;&lt;i&gt;You have not made any entries yet.&lt;/i&gt;&lt;/td&gt;&lt;/tr&gt;&#39;</span>) unless @rows;
<a name="l00462"></a>00462   $COMPOSE = &quot; disabled&quot; if $self-&gt;{pastDue};
<a name="l00463"></a>00463 
<a name="l00464"></a>00464   my $nextprev = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00465"></a>00465   $nextprev .= <span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;next&quot; value=&quot;&#39;</span>.$self-&gt;{entries}[$si-1].<span class="stringliteral">&#39;&quot; /&gt;&#39;</span> <span class="keywordflow">if</span> $si &gt; 0;
<a name="l00466"></a>00466   $nextprev .= <span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;prev&quot; value=&quot;&#39;</span>.$self-&gt;{entries}[$si+1].<span class="stringliteral">&#39;&quot; /&gt;&#39;</span> <span class="keywordflow">if</span> $si &lt; $#rows &amp;&amp; $si &gt;= 0;
<a name="l00467"></a>00467 
<a name="l00468"></a>00468   TEXT(<span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;selected&quot; value=&quot;&#39;</span>.$selected.<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>) if $si &gt;= 0;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470   $self-&gt;Panel(
<a name="l00471"></a>00471     <span class="keywordtype">id</span> =&gt; &#39;Entries&#39;,
<a name="l00472"></a>00472     title =&gt; ($self-&gt;{isProfessor} ? <span class="stringliteral">&#39;Global Entries:&#39;</span> : <span class="stringliteral">&#39;Entries:&#39;</span>),
<a name="l00473"></a>00473     html =&gt; 
<a name="l00474"></a>00474       <span class="stringliteral">&#39;&lt;table border=&quot;0&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot;&gt;&#39;</span>.
<a name="l00475"></a>00475         <span class="stringliteral">&#39;&lt;tr valign=&quot;center&quot;&gt;&lt;td&gt;&#39;</span>.
<a name="l00476"></a>00476           <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;goNext&quot; value=&quot;&#39;</span>.$self-&gt;{upArrow}.<span class="charliteral">&#39;&quot;&#39;</span>.$UP.<span class="stringliteral">&#39; /&gt;&lt;br /&gt;&#39;</span>.
<a name="l00477"></a>00477           <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;goPrev&quot; value=&quot;&#39;</span>.$self-&gt;{downArrow}.<span class="charliteral">&#39;&quot;&#39;</span>.$DOWN.<span class="stringliteral">&#39; /&gt;&#39;</span>.
<a name="l00478"></a>00478           $nextprev.
<a name="l00479"></a>00479         <span class="stringliteral">&#39;&lt;/td&gt;&lt;td align=&quot;center&quot;&gt;&#39;</span>.
<a name="l00480"></a>00480           <span class="stringliteral">&#39;&lt;hr width=&quot;90%&quot; /&gt;&#39;</span>.
<a name="l00481"></a>00481           <span class="stringliteral">&#39;&amp;nbsp; &lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;Compose&quot;&#39;</span>.$COMPOSE.<span class="stringliteral">&#39; /&gt; &amp;nbsp; &#39;</span>.
<a name="l00482"></a>00482           <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;View All&quot;&#39;</span>.$VIEW.<span class="stringliteral">&#39; /&gt; &amp;nbsp;&#39;</span>.
<a name="l00483"></a>00483           <span class="stringliteral">&#39;&lt;hr width=&quot;90%&quot; /&gt;&#39;</span>.
<a name="l00484"></a>00484         <span class="stringliteral">&#39;&lt;/td&gt;&lt;/tr&gt;&#39;</span>.
<a name="l00485"></a>00485         <span class="stringliteral">&#39;&lt;tr&gt;&lt;td height=&quot;3&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&#39;</span>.
<a name="l00486"></a>00486         join(<span class="stringliteral">&#39;&#39;</span>,@rows).
<a name="l00487"></a>00487       <span class="stringliteral">&#39;&lt;/table&gt;&#39;</span>
<a name="l00488"></a>00488   );
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 
<a name="l00491"></a>00491 <span class="preprocessor">##################################################</span>
<a name="l00492"></a>00492 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span><span class="preprocessor">#  Display an entry in its window, adding the </span>
<a name="l00494"></a>00494 <span class="preprocessor"></span><span class="preprocessor">#  proper buttons, and showing the source code</span>
<a name="l00495"></a>00495 <span class="preprocessor"></span><span class="preprocessor">#  if requested.  Record the fact that this</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span><span class="preprocessor">#  entry has been read.</span>
<a name="l00497"></a>00497 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00498"></a>00498 <span class="preprocessor"></span>sub ShowEntry {
<a name="l00499"></a>00499   my $self = shift; my $entry = shift; my $n = shift || <span class="stringliteral">&quot;&quot;</span>;
<a name="l00500"></a>00500   my ($name,$user) = $self-&gt;ParseEntryName($entry);
<a name="l00501"></a>00501   my $text = $self-&gt;Read($entry); my $html = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00502"></a>00502   my $sourceButton = <span class="stringliteral">&quot;Source&quot;</span>; my $sourceHidden = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00503"></a>00503   $text = $self-&gt;{error} <span class="keywordflow">if</span> $self-&gt;{error};
<a name="l00504"></a>00504   my $disabled = <span class="stringliteral">&quot;&quot;</span>; $disabled = <span class="stringliteral">&quot; disabled&quot;</span>
<a name="l00505"></a>00505      <span class="keywordflow">if</span> (!$self-&gt;{isSuperProf} &amp;&amp; $text =~ s/(^|\n)==locked==$<span class="comment">//) ||</span>
<a name="l00506"></a>00506         (!$self-&gt;{isProfessor} &amp;&amp; ($user ne $self-&gt;{inputs}{user} || $self-&gt;{pastDue}));
<a name="l00507"></a>00507   <span class="keywordflow">if</span> ($self-&gt;{action} eq <span class="stringliteral">&#39;Source&#39;</span> ||
<a name="l00508"></a>00508      ($self-&gt;{action} ne <span class="stringliteral">&#39;Formatted&#39;</span> &amp;&amp; $self-&gt;{inputs}{source})) {
<a name="l00509"></a>00509     $html = $text; $text = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00510"></a>00510     $html =~ s/&amp;/&amp;amp;/g;
<a name="l00511"></a>00511     $html =~ s/&lt;/&amp;lt;/g;
<a name="l00512"></a>00512     $html =~ s/&gt;/&amp;gt;/g;
<a name="l00513"></a>00513     $html =~ s!\n!&lt;br /&gt;!g;
<a name="l00514"></a>00514     $html = <span class="stringliteral">&#39;&lt;code&gt;&#39;</span>.$html.<span class="stringliteral">&#39;&lt;/code&gt;&#39;</span>;
<a name="l00515"></a>00515     $sourceButton = <span class="stringliteral">&#39;Formatted&#39;</span>;
<a name="l00516"></a>00516     $sourceHidden = <span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;source&quot; value=&quot;1&quot; /&gt;&#39;</span>;
<a name="l00517"></a>00517   }
<a name="l00518"></a>00518   my ($LEFT,$RIGHT) = (<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>);
<a name="l00519"></a>00519   $LEFT  = <span class="stringliteral">&quot; disabled&quot;</span> <span class="keywordflow">if</span> $entry eq $self-&gt;{entries}[-1];
<a name="l00520"></a>00520   $RIGHT = <span class="stringliteral">&quot; disabled&quot;</span> <span class="keywordflow">if</span> $entry eq $self-&gt;{entries}[0];
<a name="l00521"></a>00521   my ($CLASS,$NEW) = ($self-&gt;isNew($entry) ? (<span class="stringliteral">&#39;new&#39;</span>,$self-&gt;{newMark}) : (<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>));
<a name="l00522"></a>00522   $self-&gt;Panel(
<a name="l00523"></a>00523     <span class="keyword">class</span> =&gt; $CLASS,
<a name="l00524"></a>00524     <span class="keywordtype">id</span> =&gt; <span class="stringliteral">&#39;View&#39;</span>.$n,
<a name="l00525"></a>00525     title =&gt; <span class="stringliteral">&quot;$name ($user)$NEW&quot;</span>,
<a name="l00526"></a>00526     text =&gt; $text,
<a name="l00527"></a>00527     html =&gt; $html,
<a name="l00528"></a>00528     header =&gt; ($n ? <span class="stringliteral">&quot;&quot;</span> :
<a name="l00529"></a>00529       <span class="stringliteral">&#39;&lt;div class=&quot;view&quot;&gt;&#39;</span>.
<a name="l00530"></a>00530         <span class="stringliteral">&#39;&lt;table border=&quot;0&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot;&gt;&#39;</span>.
<a name="l00531"></a>00531           <span class="stringliteral">&#39;&lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;&#39;</span>),
<a name="l00532"></a>00532     footer =&gt; ($n ? <span class="stringliteral">&quot;&quot;</span> :
<a name="l00533"></a>00533       <span class="stringliteral">&#39;&lt;/td&gt;&lt;/tr&gt;&#39;</span>.
<a name="l00534"></a>00534           <span class="stringliteral">&#39;&lt;tr&gt;&lt;td colspan=&quot;3&quot;&gt;&lt;hr /&gt;&lt;/td&gt;&lt;/tr&gt;&#39;</span>.
<a name="l00535"></a>00535           <span class="stringliteral">&#39;&lt;tr&gt;&lt;td align=&quot;left&quot;&gt;&#39;</span>.
<a name="l00536"></a>00536             <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;&#39;</span>.$sourceButton.<span class="stringliteral">&#39;&quot; /&gt;&#39;</span>.
<a name="l00537"></a>00537             ($self-&gt;{isProfessor} || $self-&gt;{allowStudentEdits} ? 
<a name="l00538"></a>00538               <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;Delete&quot;&#39;</span>.$disabled.<span class="stringliteral">&#39; /&gt;&#39;</span> .
<a name="l00539"></a>00539               <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;Edit&quot;&#39;</span>.$disabled.<span class="stringliteral">&#39; /&gt;&#39;</span> : <span class="stringliteral">&quot;&quot;</span>).
<a name="l00540"></a>00540           <span class="stringliteral">&#39;&lt;/td&gt;&lt;td&gt;&amp;nbsp;&amp;nbsp;&lt;/td&gt;&lt;td align=&quot;right&quot;&gt;&#39;</span>.
<a name="l00541"></a>00541             <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;Respond&quot; /&gt;&#39;</span>.
<a name="l00542"></a>00542             <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;goPrev&quot; value=&quot;&#39;</span>.$self-&gt;{leftArrow}.<span class="charliteral">&#39;&quot;&#39;</span>.$LEFT.<span class="stringliteral">&#39; /&gt;&#39;</span>.
<a name="l00543"></a>00543             <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;goNext&quot; value=&quot;&#39;</span>.$self-&gt;{rightArrow}.<span class="charliteral">&#39;&quot;&#39;</span>.$RIGHT.<span class="stringliteral">&#39; /&gt;&#39;</span>.
<a name="l00544"></a>00544           <span class="stringliteral">&#39;&lt;/td&gt;&lt;/tr&gt;&#39;</span>.
<a name="l00545"></a>00545         <span class="stringliteral">&#39;&lt;/table&gt;&#39;</span>.$sourceHidden.
<a name="l00546"></a>00546       <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>),
<a name="l00547"></a>00547   );
<a name="l00548"></a>00548 
<a name="l00549"></a>00549   $self-&gt;Append(<span class="stringliteral">&quot;read-&quot;</span>.$self-&gt;{inputs}{user},$entry.<span class="stringliteral">&quot;\n&quot;</span>) <span class="keywordflow">if</span> $self-&gt;isNew($entry);
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="preprocessor">##################################################</span>
<a name="l00553"></a>00553 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00554"></a>00554 <span class="preprocessor"></span><span class="preprocessor">#  Save the entry that is being composed or edited.</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span>sub MakeEntry {
<a name="l00557"></a>00557   my $self = shift;
<a name="l00558"></a>00558   <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{pastDue};
<a name="l00559"></a>00559   my $text = $self-&gt;{inputs}{entry};
<a name="l00560"></a>00560   <span class="keywordflow">if</span> (!defined($text) || $text !~ m/\S/) {
<a name="l00561"></a>00561     $self-&gt;Panel(
<a name="l00562"></a>00562       <span class="keywordtype">id</span> =&gt; <span class="stringliteral">&#39;Error&#39;</span>,
<a name="l00563"></a>00563       title =&gt; <span class="stringliteral">&#39;Error:&#39;</span>,
<a name="l00564"></a>00564       html =&gt; <span class="stringliteral">&quot;You can&#39;t save a blank entry!&quot;</span>
<a name="l00565"></a>00565     );
<a name="l00566"></a>00566     <span class="keyword">delete</span> $self-&gt;{inputs}{entry};
<a name="l00567"></a>00567     <span class="keywordflow">return</span> $self-&gt;{inputs}{selected};
<a name="l00568"></a>00568   }
<a name="l00569"></a>00569   <span class="keyword">delete</span> $self-&gt;{inputs}{compose};
<a name="l00570"></a>00570   my $user = $self-&gt;{inputs}{effectiveUser};
<a name="l00571"></a>00571   my $name = $self-&gt;{inputs}{editing} || ($user.<span class="charliteral">&#39;/&#39;</span>.time().<span class="charliteral">&#39;-&#39;</span>.($self-&gt;{inputs}{user}||$user));
<a name="l00572"></a>00572   $self-&gt;Write($name,$text);
<a name="l00573"></a>00573   <span class="keywordflow">if</span> (!$self-&gt;{inputs}{editing}) {
<a name="l00574"></a>00574     $self-&gt;Append(<span class="stringliteral">&quot;entries&quot;</span>,$name.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00575"></a>00575     unshift(@{$self-&gt;{entries}},$name);
<a name="l00576"></a>00576   }
<a name="l00577"></a>00577   <span class="keywordflow">return</span> $name;
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580 <span class="preprocessor">##################################################</span>
<a name="l00581"></a>00581 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span><span class="preprocessor">#  Delete an entry (if it is allowed).  First put</span>
<a name="l00583"></a>00583 <span class="preprocessor"></span><span class="preprocessor">#  up a confirmation box, however.</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span><span class="preprocessor">#  </span>
<a name="l00585"></a>00585 <span class="preprocessor"></span>sub DeleteEntry {
<a name="l00586"></a>00586   my $self = shift; my $really = shift;
<a name="l00587"></a>00587   <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{pastDue};
<a name="l00588"></a>00588   my $entry = $self-&gt;{inputs}{selected};
<a name="l00589"></a>00589   <span class="keywordflow">if</span> ($self-&gt;{isProfessor} || ($self-&gt;{allowStudentEdits} &amp;&amp; $self-&gt;amAuthor($entry))) {
<a name="l00590"></a>00590     <span class="keywordflow">if</span> ($really) {
<a name="l00591"></a>00591       my @entries = @{$self-&gt;{localEntries}};
<a name="l00592"></a>00592       <span class="keywordflow">foreach</span> my $i (0..$#entries) {
<a name="l00593"></a>00593         <span class="keywordflow">if</span> ($entry eq $entries[$i]) {
<a name="l00594"></a>00594       splice @entries, $i, 1;
<a name="l00595"></a>00595           my $text = scalar(@entries) ? join(<span class="stringliteral">&quot;\n&quot;</span>,@entries).<span class="stringliteral">&quot;\n&quot;</span> : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00596"></a>00596       $self-&gt;Write(<span class="stringliteral">&quot;entries&quot;</span>,$text);
<a name="l00597"></a>00597       $self-&gt;Append(<span class="stringliteral">&quot;deleted&quot;</span>,$entry.<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00598"></a>00598       $self-&gt;getEntries;
<a name="l00599"></a>00599       <span class="keywordflow">return</span> $entries[$i] <span class="keywordflow">if</span> $entries[$i];
<a name="l00600"></a>00600       <span class="keywordflow">return</span> $entries[$i-1];
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602       }
<a name="l00603"></a>00603     } <span class="keywordflow">else</span> {
<a name="l00604"></a>00604       $self-&gt;Panel(
<a name="l00605"></a>00605         <span class="keywordtype">id</span> =&gt; <span class="stringliteral">&#39;Confirmation&#39;</span>,
<a name="l00606"></a>00606         title =&gt; <span class="stringliteral">&#39;Confirmation:&#39;</span>,
<a name="l00607"></a>00607         html =&gt; <span class="stringliteral">&#39;Really delete this entry?&#39;</span>,
<a name="l00608"></a>00608         footer =&gt; 
<a name="l00609"></a>00609           <span class="stringliteral">&#39;&lt;div class=&quot;YesNo&quot;&gt;&#39;</span>.
<a name="l00610"></a>00610             <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;No&quot; /&gt; &#39;</span>.
<a name="l00611"></a>00611             <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;Yes&quot; /&gt; &#39;</span>.
<a name="l00612"></a>00612           <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>
<a name="l00613"></a>00613       );
<a name="l00614"></a>00614     }
<a name="l00615"></a>00615   }
<a name="l00616"></a>00616   $entry = $self-&gt;firstEntry unless $entry;
<a name="l00617"></a>00617   <span class="keywordflow">return</span> $entry;
<a name="l00618"></a>00618 }
<a name="l00619"></a>00619 
<a name="l00620"></a>00620 <span class="preprocessor">##################################################</span>
<a name="l00621"></a>00621 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span><span class="preprocessor">#  Start editing the selected entry.</span>
<a name="l00623"></a>00623 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span>sub EditEntry {
<a name="l00625"></a>00625   my $self = shift;
<a name="l00626"></a>00626   my $entry = $self-&gt;{inputs}{selected};
<a name="l00627"></a>00627   <span class="keywordflow">if</span> ($self-&gt;{isProfessor} || ($self-&gt;{allowStudentEdits} &amp;&amp; $self-&gt;amAuthor($entry))) {
<a name="l00628"></a>00628     $self-&gt;{inputs}{compose} = 1;
<a name="l00629"></a>00629     $self-&gt;{inputs}{editing} = $entry;
<a name="l00630"></a>00630     my $text = $self-&gt;Read($entry);
<a name="l00631"></a>00631     $text = $self-&gt;{error} <span class="keywordflow">if</span> $self-&gt;{error};
<a name="l00632"></a>00632     $self-&gt;{inputs}{entry} = $text;
<a name="l00633"></a>00633   } <span class="keywordflow">else</span> {
<a name="l00634"></a>00634     $entry = $self-&gt;firstEntry unless $entry;
<a name="l00635"></a>00635   }
<a name="l00636"></a>00636   <span class="keywordflow">return</span> $entry;
<a name="l00637"></a>00637 }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639 <span class="preprocessor">######################################################################</span>
<a name="l00640"></a>00640 <span class="preprocessor"></span><span class="preprocessor">######################################################################</span>
<a name="l00641"></a>00641 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00642"></a>00642 <span class="preprocessor"></span><span class="preprocessor">#  Display the options panel</span>
<a name="l00643"></a>00643 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00644"></a>00644 <span class="preprocessor"></span>sub OptionPanel {
<a name="l00645"></a>00645   my $self = shift;
<a name="l00646"></a>00646   <span class="keywordflow">return</span> unless ($self-&gt;{isProfessor} &amp;&amp; !$self-&gt;{isActing}) || $self-&gt;{isSuperProf};
<a name="l00647"></a>00647   $self-&gt;Panel(
<a name="l00648"></a>00648     <span class="keywordtype">id</span> =&gt; <span class="stringliteral">&#39;Options&#39;</span>,
<a name="l00649"></a>00649     title =&gt; <span class="stringliteral">&#39;Options:&#39;</span>,
<a name="l00650"></a>00650     html =&gt; <span class="stringliteral">&#39;&lt;input type=&quot;submit&quot; name=&quot;action&quot; value=&quot;Show Student Array&quot;&gt;&#39;</span>,
<a name="l00651"></a>00651   );
<a name="l00652"></a>00652 }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 <span class="preprocessor">##################################################</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00656"></a>00656 <span class="preprocessor"></span><span class="preprocessor">#  Show the student array, with links to each student and</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span><span class="preprocessor">#  the number of new messages for each.</span>
<a name="l00658"></a>00658 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00659"></a>00659 <span class="preprocessor"></span>sub ShowStudents {
<a name="l00660"></a>00660   my $self = shift;
<a name="l00661"></a>00661   $self-&gt;getStudents;
<a name="l00662"></a>00662   my @students = <a class="code" href="classmain.html#abfd1f69ce77d1737ae37a97b21265f84">main::lex_sort</a>(@main::StudentIds);
<a name="l00663"></a>00663   my $url = $self-&gt;getURL.<span class="stringliteral">&#39;effectiveUser=&#39;</span>;
<a name="l00664"></a>00664   my $n = scalar(@students);
<a name="l00665"></a>00665   my $k = int($n/$self-&gt;{columns});
<a name="l00666"></a>00666   my $k1 = $n - $k*$self-&gt;{columns};
<a name="l00667"></a>00667   my @cols = (); my $m = 0; my $mr = 0;
<a name="l00668"></a>00668   <span class="keywordflow">foreach</span> my $i (1..$self-&gt;{columns}) {
<a name="l00669"></a>00669     my $one = ($i &lt;= $k1 ? 1 : 0);
<a name="l00670"></a>00670     my @col = @students[$m..($m+$k+$one-1)];
<a name="l00671"></a>00671     $m += $k+$one;
<a name="l00672"></a>00672     <span class="keywordflow">foreach</span> my $student (@col) {
<a name="l00673"></a>00673       my $m = $self-&gt;getUnreadCount($student);
<a name="l00674"></a>00674       my $mr = $self-&gt;getAlreadCount($student);
<a name="l00675"></a>00675       $student = <span class="stringliteral">&#39;&lt;a href=&quot;&#39;</span>.$url.$student.<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.$student.<span class="stringliteral">&#39;&lt;/a&gt;&#39;</span>;
<a name="l00676"></a>00676       $student = qq!&lt;span <span class="keyword">class</span>=<span class="stringliteral">&quot;new&quot;</span>&gt;$student ($mr)&lt;/span&gt;! <span class="keywordflow">if</span> ($mr &amp;&amp;!$m);
<a name="l00677"></a>00677       $student = qq!&lt;span <span class="keyword">class</span>=<span class="stringliteral">&quot;red&quot;</span>&gt;$student ($mr)$m&lt;/span&gt;! if ($m &amp;&amp; $mr);
<a name="l00678"></a>00678     }
<a name="l00679"></a>00679     push(@cols,join(&#39;&lt;br /&gt;&#39;,@col));
<a name="l00680"></a>00680   }
<a name="l00681"></a>00681   $self-&gt;Panel(
<a name="l00682"></a>00682     <span class="keywordtype">id</span> =&gt; &#39;Students&#39;,
<a name="l00683"></a>00683     title =&gt; &quot;New Student Messages:&quot;,
<a name="l00684"></a>00684     html =&gt;
<a name="l00685"></a>00685      &#39;&lt;table border=&quot;0&quot; cellspacing=&quot;0&quot; cellpadding=&quot;0&quot;&gt;&#39;.
<a name="l00686"></a>00686        &#39;&lt;tr valign=&quot;top&quot;&gt;&lt;td width=&quot;15&quot;&gt;&lt;/td&gt;&lt;td nowrap&gt;&#39;.
<a name="l00687"></a>00687          join(&#39;&lt;/td&gt;&lt;td width=&quot;20&quot;&gt;&lt;/td&gt;&lt;td nowrap&gt;&#39;,@cols).
<a name="l00688"></a>00688        &#39;&lt;/td&gt;&lt;td width=&quot;15&quot;&gt;&lt;/td&gt;&lt;/tr&gt;&#39;.
<a name="l00689"></a>00689      &#39;&lt;/table&gt;&#39;
<a name="l00690"></a>00690   );
<a name="l00691"></a>00691 }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693 <span class="preprocessor">######################################################################</span>
<a name="l00694"></a>00694 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span><span class="preprocessor">#  Show ALL the entries.</span>
<a name="l00696"></a>00696 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>sub ViewAll {
<a name="l00698"></a>00698   my $self = shift; my $n = 1;
<a name="l00699"></a>00699   <span class="keywordflow">foreach</span> my $entry (@{$self-&gt;{entries}}) {$self-&gt;ShowEntry($entry,$n++)}
<a name="l00700"></a>00700 }
<a name="l00701"></a>00701 
<a name="l00702"></a>00702 
<a name="l00703"></a>00703 <span class="preprocessor">######################################################################</span>
<a name="l00704"></a>00704 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00705"></a>00705 <span class="preprocessor"></span><span class="preprocessor">#  Hardcopy includes ALL the messages, nicely formatted.</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00707"></a>00707 <span class="preprocessor"></span>sub Hardcopy {
<a name="l00708"></a>00708   my $self = shift;
<a name="l00709"></a>00709   $self-&gt;{inputs} = $main::inputs_ref;
<a name="l00710"></a>00710   $self-&gt;getProfessors;
<a name="l00711"></a>00711   $self-&gt;getEntries;
<a name="l00712"></a>00712   <span class="keywordflow">for</span> (my $i = scalar(@{$self-&gt;{entries}})-1; $i &gt;= 0; $i--) {
<a name="l00713"></a>00713     $entry = $self-&gt;{entries}[$i];
<a name="l00714"></a>00714     my ($name,$user) = $self-&gt;ParseEntryName($entry);
<a name="l00715"></a>00715     my $text = $self-&gt;Read($entry);
<a name="l00716"></a>00716     $text = $self-&gt;{error} <span class="keywordflow">if</span> $self-&gt;{error};
<a name="l00717"></a>00717     $text =~ s/(^|\n)==locked==$<span class="comment">//;</span>
<a name="l00718"></a>00718     $text = <a class="code" href="classmain.html#a01b7b1d1eb638041ac9c41461cb620d3">main::EV3P</a>({processCommands=&gt;0,processVariables=&gt;0},main::text2PG($text));
<a name="l00719"></a>00719     TEXT(<span class="stringliteral">&#39;\par\goodbreak\vskip\baselineskip&#39;</span>.
<a name="l00720"></a>00720          $self-&gt;hardcopyTitle(<span class="stringliteral">&quot;$name ($user)&quot;</span>).
<a name="l00721"></a>00721         <span class="stringliteral">&#39;\nobreak\vskip-.5\parskip\noindent &#39;</span>);
<a name="l00722"></a>00722     TEXT($text);
<a name="l00723"></a>00723   }
<a name="l00724"></a>00724 }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726 sub hardcopyTitle {
<a name="l00727"></a>00727   my $self = shift; my $title = shift;
<a name="l00728"></a>00728   $title = main::text2PG($title,doubleSlashes=&gt;0);
<a name="l00729"></a>00729   <span class="keywordflow">return</span> <span class="stringliteral">&#39;\hbox{\vrule\vbox{&#39;</span>.
<a name="l00730"></a>00730            <span class="stringliteral">&#39;\hrule\kern1pt\hrule\kern2pt&#39;</span>.
<a name="l00731"></a>00731            <span class="stringliteral">&#39;\hbox to\hsize{&#39;</span>.
<a name="l00732"></a>00732              <span class="stringliteral">&#39;\hss\strut{&#39;</span>.$title.<span class="stringliteral">&#39;}\hss&#39;</span>.
<a name="l00733"></a>00733            <span class="stringliteral">&#39;}\kern2pt\hrule&#39;</span>.
<a name="l00734"></a>00734      <span class="stringliteral">&#39;}\vrule}&#39;</span>;
<a name="l00735"></a>00735 }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737 <span class="preprocessor">######################################################################</span>
<a name="l00738"></a>00738 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00739"></a>00739 <span class="preprocessor"></span><span class="preprocessor">#  Create the HTML for a panel, given the title, text and so on.</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00741"></a>00741 <span class="preprocessor"></span>sub Panel {
<a name="l00742"></a>00742   my $self = shift;
<a name="l00743"></a>00743   my %options = (
<a name="l00744"></a>00744     <span class="keyword">class </span>=&gt; &#39;&#39;,
<a name="l00745"></a>00745     id =&gt; <span class="stringliteral">&quot;Information&quot;</span>,
<a name="l00746"></a>00746     title =&gt; <span class="stringliteral">&quot;Information:&quot;</span>,
<a name="l00747"></a>00747     box =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00748"></a>00748     header =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00749"></a>00749     text =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00750"></a>00750     html =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00751"></a>00751     footer =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00752"></a>00752     @_,
<a name="l00753"></a>00753   );
<a name="l00754"></a>00754   my $preview = <a class="code" href="classmain.html#a01b7b1d1eb638041ac9c41461cb620d3">main::EV3P</a>({processCommands=&gt;0,processVariables=&gt;0},main::text2PG($options{text}));
<a name="l00755"></a>00755   TEXT(
<a name="l00756"></a>00756     ($options{<span class="keyword">class</span>} ? <span class="stringliteral">&#39;&lt;div class=&quot;&#39;</span>.$options{<span class="keyword">class</span>}.<span class="stringliteral">&#39;&quot;&gt;&#39;</span> : <span class="stringliteral">&#39;&lt;div&gt;&#39;</span>).
<a name="l00757"></a>00757       <span class="stringliteral">&#39;&lt;div class=&quot;outerFrame&quot; id=&quot;&#39;</span>.$options{<span class="keywordtype">id</span>}.<span class="stringliteral">&#39;&quot;&gt;&#39;</span>.
<a name="l00758"></a>00758         $options{box}.
<a name="l00759"></a>00759         <span class="stringliteral">&#39;&lt;div class=&quot;heading&quot;&gt;&#39;</span>.$options{title}.<span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.
<a name="l00760"></a>00760         <span class="stringliteral">&#39;&lt;div class=&quot;innerFrame&quot;&gt;&#39;</span>.
<a name="l00761"></a>00761           $options{header}.
<a name="l00762"></a>00762           $preview.
<a name="l00763"></a>00763           $options{html}.
<a name="l00764"></a>00764           $options{footer}.
<a name="l00765"></a>00765         <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.
<a name="l00766"></a>00766       <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>.
<a name="l00767"></a>00767       <span class="stringliteral">&#39;&lt;br clear=&quot;all&quot; /&gt;&#39;</span>.
<a name="l00768"></a>00768       <span class="stringliteral">&#39;&lt;input type=&quot;hidden&quot; name=&quot;&#39;</span>.lc($options{<span class="keywordtype">id</span>}).<span class="stringliteral">&#39;&quot; value=&quot;1&quot; /&gt;&#39;</span>.
<a name="l00769"></a>00769     <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>
<a name="l00770"></a>00770   );
<a name="l00771"></a>00771   
<a name="l00772"></a>00772 }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774 <span class="preprocessor">######################################################################</span>
<a name="l00775"></a>00775 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00776"></a>00776 <span class="preprocessor"></span><span class="preprocessor">#  A custom grader that uses the message aread to hide the normal</span>
<a name="l00777"></a>00777 <span class="preprocessor"></span><span class="preprocessor">#  preview/check/submit buttons (if these were marked via an ID in the</span>
<a name="l00778"></a>00778 <span class="preprocessor"></span><span class="preprocessor">#  HTML code, we could use CSS to do this instead).</span>
<a name="l00779"></a>00779 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00780"></a>00780 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>sub Grader {
<a name="l00782"></a>00782   my $self = shift;
<a name="l00783"></a>00783   my $grader = $main::PG_FLAGS{PROBLEM_GRADER_TO_USE} || \&amp;<a class="code" href="classmain.html#ae4a37aefa853d9d70b429a4317ee293b">main::avg_problem_grader</a>;
<a name="l00784"></a>00784   <a class="code" href="classmain.html#a9bcb5802e999970d22a45177b9aaf546">main::install_problem_grader</a>(sub {
<a name="l00785"></a>00785     my ($result,$state) = &amp;{$grader}(@_);
<a name="l00786"></a>00786     $state-&gt;{state_summary_msg} = $self-&gt;{graderSummary};
<a name="l00787"></a>00787     <span class="keywordflow">return</span> ($result,$state);
<a name="l00788"></a>00788   });
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 
<a name="l00791"></a>00791 <span class="preprocessor">######################################################################</span>
<a name="l00792"></a>00792 <span class="preprocessor"></span><span class="preprocessor">######################################################################</span>
<a name="l00793"></a>00793 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span><span class="preprocessor">#  Look up a file and return its contents or an error message.</span>
<a name="l00795"></a>00795 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span>sub Read {
<a name="l00797"></a>00797   my $self = shift; my $filename = shift;
<a name="l00798"></a>00798   die <span class="stringliteral">&quot;You must supply a problem file name&quot;</span> unless $filename;
<a name="l00799"></a>00799   <span class="keyword">delete</span> $self-&gt;{error};
<a name="l00800"></a>00800   $filename = main::surePathToTmpFile(<span class="stringliteral">&#39;gif/&#39;</span>.$self-&gt;dataFilePath($filename).$self-&gt;{extension});
<a name="l00801"></a>00801   my ($text,$error) = main::PG_restricted_eval(<span class="stringliteral">&quot;read_whole_file(&#39;$filename&#39;)&quot;</span>);
<a name="l00802"></a>00802   <span class="keywordflow">return</span> $$text unless $error;
<a name="l00803"></a>00803 <span class="preprocessor">  ###  FIXME:  return generic error for students</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span>  $error =~ s/^.*subroutine:\s*<span class="comment">//s;  # trim extra data inserted by read_whole_file()</span>
<a name="l00805"></a>00805   $error =~ s!\s* at .*?<a class="code" href="classWeBWorK.html">WeBWorK</a>/<a class="code" href="classWeBWorK_1_1PG.html">PG</a>/IO.pm line \d+.\s*$!!s;
<a name="l00806"></a>00806   $error =~ s!^&lt;BR&gt;!!;
<a name="l00807"></a>00807   $self-&gt;{error} = $error;
<a name="l00808"></a>00808   <span class="keywordflow">return</span>;
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 <span class="preprocessor">######################################################################</span>
<a name="l00812"></a>00812 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00813"></a>00813 <span class="preprocessor"></span><span class="preprocessor">#  Perform the actual writing of the file, using a hack that</span>
<a name="l00814"></a>00814 <span class="preprocessor"></span><span class="preprocessor">#  takes advantage of the fact that insertGraph() can write files</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span><span class="preprocessor">#  in the html/tmp/gif directory.</span>
<a name="l00816"></a>00816 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00817"></a>00817 <span class="preprocessor"></span>sub Write {
<a name="l00818"></a>00818   my $self = shift; $self-&gt;{file} = shift; $self-&gt;{data} = shift;
<a name="l00819"></a>00819   <span class="keywordflow">if</span> ($main::setNumber eq <span class="stringliteral">&#39;Undefined_Set&#39;</span>) {
<a name="l00820"></a>00820     <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{undefinedSetWarning};
<a name="l00821"></a>00821     $self-&gt;{undefinedSetWarning} = 1;
<a name="l00822"></a>00822     $self-&gt;Panel(
<a name="l00823"></a>00823       <span class="keywordtype">id</span> =&gt; <span class="stringliteral">&#39;Error&#39;</span>,
<a name="l00824"></a>00824       title =&gt; <span class="stringliteral">&#39;Error:&#39;</span>,
<a name="l00825"></a>00825       html =&gt; <span class="stringliteral">&quot;You can&#39;t make changes from the Undefined_Set&lt;br /&gt;&quot;</span>
<a name="l00826"></a>00826             . <span class="stringliteral">&#39;(i.e., not from the Library Browser or ProblemEditor).&#39;</span>,
<a name="l00827"></a>00827     );
<a name="l00828"></a>00828     <span class="keywordflow">return</span>;
<a name="l00829"></a>00829   }
<a name="l00830"></a>00830   die <span class="stringliteral">&quot;You must supply a file name&quot;</span> unless defined $self-&gt;{file};
<a name="l00831"></a>00831   $self-&gt;{file} = $self-&gt;dataFilePath($self-&gt;{file});
<a name="l00832"></a>00832   $self-&gt;{data} = <span class="stringliteral">&quot;\n&quot;</span> unless defined $self-&gt;{data} &amp;&amp; $self-&gt;{data} ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l00833"></a>00833   my $oldRefresh = $main::refreshCachedImages;
<a name="l00834"></a>00834   $main::refreshCachedImages = 1;
<a name="l00835"></a>00835   <a class="code" href="classmain.html#a987fc9ec14b16fe4f8eabcf00085ab0c">main::insertGraph</a>($self);
<a name="l00836"></a>00836   $main::refreshCachedImages = $oldRefresh;
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 <span class="preprocessor">#</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span><span class="preprocessor">#  The answerDiscussion object mimics the WWPlot object by defining draw() and</span>
<a name="l00841"></a>00841 <span class="preprocessor"></span><span class="preprocessor">#  imageName() methods.  These are used by insertGraph() to write image</span>
<a name="l00842"></a>00842 <span class="preprocessor"></span><span class="preprocessor">#  files, and we can use that to write the data files that we need.</span>
<a name="l00843"></a>00843 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00844"></a>00844 <span class="preprocessor"></span>sub draw {shift-&gt;{data}}
<a name="l00845"></a>00845 sub imageName {shift-&gt;{file}}
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 <span class="preprocessor">######################################################################</span>
<a name="l00848"></a>00848 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00849"></a>00849 <span class="preprocessor"></span><span class="preprocessor">#  Append data to a file (here implemented as reading followed by</span>
<a name="l00850"></a>00850 <span class="preprocessor"></span><span class="preprocessor">#  writing).</span>
<a name="l00851"></a>00851 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00852"></a>00852 <span class="preprocessor"></span>sub Append {
<a name="l00853"></a>00853   my $self = shift; my $file = shift; my $data = shift;
<a name="l00854"></a>00854   <span class="keywordflow">return</span> unless $data;
<a name="l00855"></a>00855   my $text = $self-&gt;Read($file);  ## test <span class="keywordflow">for</span> errors other than file does not exist?
<a name="l00856"></a>00856   $text = <span class="stringliteral">&quot;&quot;</span> unless defined $text; $text =~ s/^\n+<span class="comment">//;</span>
<a name="l00857"></a>00857   $self-&gt;Write($file,$text.$data);
<a name="l00858"></a>00858 }
<a name="l00859"></a>00859 
<a name="l00860"></a>00860 <span class="preprocessor">######################################################################</span>
<a name="l00861"></a>00861 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00862"></a>00862 <span class="preprocessor"></span><span class="preprocessor">#  Get the (sanitized) file name for the temporary file</span>
<a name="l00863"></a>00863 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00864"></a>00864 <span class="preprocessor"></span>sub dataFilePath {
<a name="l00865"></a>00865   my $self = shift; my $file = shift;
<a name="l00866"></a>00866   $file =~ s!\.pg!!;                      # <span class="keyword">remove</span> trailing .pg
<a name="l00867"></a>00867   $file =~ s![^-a-zA-Z0-9._+=/]!!g;       # <span class="keyword">remove</span> unusual characters
<a name="l00868"></a>00868   $file =~ s!(^|/)\.\.(/\.\.)*(/|$)!$3!g; # <span class="keyword">remove</span> /../ directories
<a name="l00869"></a>00869   $file =~ s!<span class="comment">//+!/!g;                     # remove extra //&#39;s</span>
<a name="l00870"></a>00870   $file =~ s!^/+!!;                       # <span class="keyword">remove</span> leading /<span class="stringliteral">&#39;s</span>
<a name="l00871"></a>00871 <span class="stringliteral">  my $dir = &#39;</span>S09Discussion/<span class="stringliteral">&#39;.$main::setNumber.&#39;</span>/<span class="stringliteral">&#39;.$main::probNum;</span>
<a name="l00872"></a>00872 <span class="stringliteral">  $dir .= &#39;</span>/<span class="stringliteral">&#39;.$self-&gt;{inputs}{effectiveUser} unless $file =~ m!/!;</span>
<a name="l00873"></a>00873 <span class="stringliteral"> #$dir .= &#39;</span>/S09All<span class="stringliteral">&#39; unless $file =~ m!/!; </span>
<a name="l00874"></a>00874 <span class="stringliteral">  return $dir.&#39;</span>/<span class="stringliteral">&#39;.$file;                  # add directory name</span>
<a name="l00875"></a>00875 <span class="stringliteral">}</span>
<a name="l00876"></a>00876 <span class="stringliteral"></span>
<a name="l00877"></a>00877 <span class="stringliteral">######################################################################</span>
<a name="l00878"></a>00878 <span class="stringliteral">1;</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:54:54 2012 for PG by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
