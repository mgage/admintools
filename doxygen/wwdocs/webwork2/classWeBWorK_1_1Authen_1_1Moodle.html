<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::Authen::Moodle Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1Authen.html">Authen</a>::<a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html">Moodle</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::Authen::Moodle Class Reference</h1><!-- doxytag: class="WeBWorK::Authen::Moodle" --><!-- doxytag: inherits="WeBWorK::Authen" --><div class="dynheader">
Inheritance diagram for WeBWorK::Authen::Moodle:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1Authen_1_1Moodle__inherit__graph.png" border="0" usemap="#WeBWorK_1_1Authen_1_1Moodle_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1Authen_1_1Moodle_inherit__map" id="WeBWorK_1_1Authen_1_1Moodle_inherit__map">
<area shape="rect" href="classWeBWorK_1_1Authen.html" title="WeBWorK::Authen" alt="" coords="31,80,161,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="55,5,137,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::Authen::Moodle:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1Authen_1_1Moodle__coll__graph.png" border="0" usemap="#WeBWorK_1_1Authen_1_1Moodle_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1Authen_1_1Moodle_coll__map" id="WeBWorK_1_1Authen_1_1Moodle_coll__map">
<area shape="rect" href="classWeBWorK_1_1Authen.html" title="WeBWorK::Authen" alt="" coords="31,80,161,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="55,5,137,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1Authen_1_1Moodle-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#a86ae862bbca29aa5373d472b35695dd6">check_session</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#acdd5fb0247c2e75e6da746a946a9af30">prefix_table</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#a035a63ad0d03e7e72737eccc4d9a9779">update_moodle_session</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#a7c4beb9aeb66796cda0ae634f18f2fc2">get_credentials</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#afd08ba4307f7d03f30e104fc929165ea">checkPassword</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#ab670ec8cd320c132734cf6708c5f1984">site_fixup</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#a324dcc29dbed2f1bb6726916aa2c907a">fetch_moodle_session</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#a974af427584432a27b9030e8ea2d0464">unserialize_session</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#a7898402682db6320ec628ce740956fbf">new</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html#a33d746647ded5e3a90ca2413973bdbc9">init_mdl_session</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1Authen_1_1Moodle.html">WeBWorK::Authen::Moodle</a> - Allow moodle cookies to be used for <a class="el" href="classWeBWorK.html">WeBWorK</a> authentication. </p>
<p>TODO </p>
<p>* Modules that modify data that's being taken from moodle should check for "alternative URLs" in the CE that can point back to the moodle installation. operations include: change password, change user data, change permission level, add user, delete user. Run this for a rough estimate: pcregrep -r '\$db-&gt;(add|put)(User|Password|PermissionLevel)\b' lib </p>

<p>Definition at line <a class="el" href="Moodle_8pm_source.html#l00029">29</a> of file <a class="el" href="Moodle_8pm_source.html">Moodle.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a86ae862bbca29aa5373d472b35695dd6"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::check_session" ref="a86ae862bbca29aa5373d472b35695dd6" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::check_session </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-check_session' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-check_session-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-check_session-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-check_session-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in check_session: 19</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#a86ae862bbca29aa5373d472b35695dd6">check_session</a> {
    my ($self, $user_id, $session_key, $update_timestamp) = @_;
    
    my ($sessionExists, $keyMatches, $timestampValid) = $self-&gt;SUPER::check_session($user_id, $session_key, $update_timestamp);
    debug(<span class="stringliteral">&quot;SUPER::check_session returned: sessionExists=&#39;&quot;</span>, $sessionExists, <span class="stringliteral">&quot;&#39; keyMatches=&#39;&quot;</span>, $keyMatches, <span class="stringliteral">&quot;&#39; timestampValid=&#39;&quot;</span>, $timestampValid, <span class="stringliteral">&quot;&#39;&quot;</span>);
    
    <span class="keywordflow">if</span> ($update_timestamp and $sessionExists and $keyMatches and not $timestampValid) {
        debug(<span class="stringliteral">&quot;special case: webwork key matches an expired session (check for a unexpired moodle session)&quot;</span>);
        my ($moodle_user_id, $moodle_expiration_time) = $self-&gt;fetch_moodle_session;
        debug(<span class="stringliteral">&quot;fetch_moodle_session returned: moodle_user_id=&#39;$moodle_user_id&#39; moodle_expiration_time=&#39;$moodle_expiration_time&#39;.\n&quot;</span>);
        <span class="keywordflow">if</span> (defined $moodle_user_id and $moodle_user_id eq $user_id
                and defined $moodle_expiration_time and time &lt;= $moodle_expiration_time) {
            $self-&gt;{session_key} = $self-&gt;create_session($moodle_user_id);
            $timestampValid = 1;
        }
    }
    
    <span class="keywordflow">return</span> $sessionExists, $keyMatches, $timestampValid;
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1Authen.html#adcf73784f90bb9a39011be916da177a0">WeBWorK::Authen</a>.</p>

</div>
</div>
<a class="anchor" id="afd08ba4307f7d03f30e104fc929165ea"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::checkPassword" ref="afd08ba4307f7d03f30e104fc929165ea" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::checkPassword </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-checkPassword' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-checkPassword-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-checkPassword-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-checkPassword-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in checkPassword: 27</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#afd08ba4307f7d03f30e104fc929165ea">checkPassword</a> {
    my ($self, $userID, $possibleClearPassword) = @_;
    my $db = $self-&gt;{r}-&gt;db;
    
    debug(<span class="stringliteral">&quot;Moodle module is doing the password checking.\n&quot;</span>);
    
    my $Password = $db-&gt;getPassword($userID); # checked
    <span class="keywordflow">if</span> (defined $Password) {
<span class="preprocessor">        # check against Moodle password database</span>
<span class="preprocessor"></span>        my $possibleMD5Password = md5_hex($possibleClearPassword);
        debug(<span class="stringliteral">&quot;Hashed password from supplied cleartext: &#39;$possibleMD5Password&#39;.\n&quot;</span>);
        debug(<span class="stringliteral">&quot;Hashed password from Password record: &#39;&quot;</span>, $Password-&gt;password, <span class="stringliteral">&quot;&#39;.\n&quot;</span>);
        <span class="keywordflow">if</span> ($possibleMD5Password eq $Password-&gt;password) {
            $self-&gt;write_log_entry(<span class="stringliteral">&quot;AUTH MDL: password accepted&quot;</span>);
            <span class="keywordflow">return</span> 1;
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">if</span> ($self-&gt;can(<span class="stringliteral">&quot;site_checkPassword&quot;</span>)) {
                $self-&gt;write_log_entry(<span class="stringliteral">&quot;AUTH MDL: password rejected, deferring to site_checkPassword&quot;</span>);
                <span class="keywordflow">return</span> $self-&gt;site_checkPassword($userID, $possibleClearPassword);
            } <span class="keywordflow">else</span> {
                $self-&gt;write_log_entry(<span class="stringliteral">&quot;AUTH MDL: password rejected&quot;</span>);
                <span class="keywordflow">return</span> 0;
            }
        }
        
    }
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1Authen.html#aee4263d395016632ca758390ad142c16">WeBWorK::Authen</a>.</p>

</div>
</div>
<a class="anchor" id="a324dcc29dbed2f1bb6726916aa2c907a"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::fetch_moodle_session" ref="a324dcc29dbed2f1bb6726916aa2c907a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::fetch_moodle_session </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-fetch_moodle_session' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-fetch_moodle_session-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-fetch_moodle_session-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-fetch_moodle_session-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in fetch_moodle_session: 34</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#a324dcc29dbed2f1bb6726916aa2c907a">fetch_moodle_session</a> {
<span class="preprocessor">    # fetches the basic information from the moodle session.</span>
<span class="preprocessor"></span><span class="preprocessor">    # returns the user name and expiration time of the moodle session</span>
<span class="preprocessor"></span><span class="preprocessor">    # Note that we don&#39;t worry about the user being in this course at this point.</span>
<span class="preprocessor"></span><span class="preprocessor">    # That is taken care of in Schema::Moodle::User.</span>
<span class="preprocessor"></span>    my ($self) = @_;
    my $r = $self-&gt;{r};
    my $db = $r-&gt;db;
    
    my %cookies = <a class="code" href="classWeBWorK_1_1Cookie.html">WeBWorK::Cookie</a>-&gt;fetch( MP2 ? $r : () );
    my $cookie = $cookies{<span class="stringliteral">&quot;MoodleSession&quot;</span>};
    <span class="keywordflow">return</span> unless $cookie;
    
    my $session_table = $self-&gt;prefix_table($self-&gt;{sql_session_table});
    my $data_field = $self-&gt;{sql_data_field};
    my $stmt = <span class="stringliteral">&quot;SELECT `expiry`,`$data_field` FROM `$session_table` WHERE `sesskey`=?&quot;</span>;
    my @bind_vals = $cookie-&gt;value;
    
    my $sth = $self-&gt;{mdl_dbh}-&gt;prepare_cached($stmt, undef, 3); # 3: see DBI docs
    $sth-&gt;execute(@bind_vals);
    my $row = $sth-&gt;fetchrow_arrayref;
    $sth-&gt;finish;
    <span class="keywordflow">return</span> unless defined $row;
    
    my ($expires, $data_string) = @$row;
    
<span class="preprocessor">    # Moodle 1.7 stores expiry as a DATETIME, but WeBWorK wants a UNIX timestamp.</span>
<span class="preprocessor"></span>    $expires = str2time($expires) if $self-&gt;{moodle17};
    
    my $data = <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#a974af427584432a27b9030e8ea2d0464">unserialize_session</a>($data_string);
    my $username = $data-&gt;{<span class="stringliteral">&quot;USER&quot;</span>}{<span class="stringliteral">&quot;username&quot;</span>};
    
    <span class="keywordflow">return</span> $username, $expires;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a7c4beb9aeb66796cda0ae634f18f2fc2"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::get_credentials" ref="a7c4beb9aeb66796cda0ae634f18f2fc2" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::get_credentials </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_credentials' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-get_credentials-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_credentials-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_credentials-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in get_credentials: 31</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#a7c4beb9aeb66796cda0ae634f18f2fc2">get_credentials</a> {
    my $self = shift;
    my $r = $self-&gt;{r};
    
    my $super_result = $self-&gt;SUPER::get_credentials;
    <span class="keywordflow">if</span> ($super_result) {
        debug(<span class="stringliteral">&quot;Superclass&#39;s get_credentials found credentials. Using them.\n&quot;</span>);
        <span class="keywordflow">return</span> $super_result;
    }
    
    my ($moodle_user_id, $moodle_expiration_time) = $self-&gt;fetch_moodle_session;
<span class="preprocessor">    #debug(&quot;fetch_moodle_session returned: moodle_user_id=&#39;$moodle_user_id&#39; moodle_expiration_time=&#39;$moodle_expiration_time&#39;.\n&quot;); # causes errors when undefined</span>
<span class="preprocessor"></span>    
    <span class="keywordflow">if</span> (defined $moodle_user_id and defined $moodle_expiration_time and time &lt;= $moodle_expiration_time) {
        my $newKey = $self-&gt;create_session($moodle_user_id);
        debug(<span class="stringliteral">&quot;Unexpired moodle session found. Created new WeBWorK session with newKey=&#39;$newKey&#39;.\n&quot;</span>);
        
        $self-&gt;{user_id} = $moodle_user_id;
        $self-&gt;{session_key} = $newKey;
        $self-&gt;{login_type} = <span class="stringliteral">&quot;normal&quot;</span>;
        $self-&gt;{credential_source} = <span class="stringliteral">&quot;moodle&quot;</span>;
        <span class="keywordflow">return</span> 1;
    } <span class="keywordflow">else</span> {
        debug(<span class="stringliteral">&quot;No moodle session found or moodle session expired. No credentials to be had.\n&quot;</span>);
        warn(<span class="stringliteral">&quot;No moodle session found or moodle sessioin expired.  If this happens repeatedly and you are constantly being asked</span>
<span class="stringliteral">              to log back in ask your moodle admin to check that the Moodle item: </span>
<span class="stringliteral">              Server -&gt; Session Handling -&gt; dbsessions (Use database for session information) has been checked.&quot;</span>);
    }
    
    <span class="keywordflow">return</span> 0;
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1Authen.html#ad1a65658ae4c2c5b879884e5e1c67e02">WeBWorK::Authen</a>.</p>

</div>
</div>
<a class="anchor" id="a33d746647ded5e3a90ca2413973bdbc9"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::init_mdl_session" ref="a33d746647ded5e3a90ca2413973bdbc9" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::init_mdl_session </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-init_mdl_session' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-init_mdl_session-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-init_mdl_session-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-init_mdl_session-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in init_mdl_session: 19</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#a33d746647ded5e3a90ca2413973bdbc9">init_mdl_session</a> {
    my $self = shift;
    
<span class="preprocessor">    # version-specific stuff</span>
<span class="preprocessor"></span>    $self-&gt;{moodle17} = $self-&gt;{r}-&gt;ce-&gt;{authen}{moodle_options}{moodle17};
    $self-&gt;{sql_session_table} = $self-&gt;{moodle17} ? <span class="stringliteral">&quot;sessions2&quot;</span> : <span class="stringliteral">&quot;sessions&quot;</span>;
    $self-&gt;{sql_data_field} = $self-&gt;{moodle17} ? <span class="stringliteral">&quot;sessdata&quot;</span> : <span class="stringliteral">&quot;data&quot;</span>;
    
    $self-&gt;{mdl_dbh} = DBI-&gt;connect_cached(
        $self-&gt;{r}-&gt;ce-&gt;{authen}{moodle_options}{dsn},
        $self-&gt;{r}-&gt;ce-&gt;{authen}{moodle_options}{username},
        $self-&gt;{r}-&gt;ce-&gt;{authen}{moodle_options}{password},
        {
            PrintError =&gt; 0,
            RaiseError =&gt; 1,
        },
    );
    die $DBI::errstr unless defined $self-&gt;{mdl_dbh};
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a7898402682db6320ec628ce740956fbf"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::new" ref="a7898402682db6320ec628ce740956fbf" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::new </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-new' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-new-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-new-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-new-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in new: 7</span>
<span class="preprocessor"></span>sub <span class="keyword">new</span> {
    my $self = shift-&gt;SUPER::new(@_);
    
    $self-&gt;init_mdl_session;
    
    <span class="keywordflow">return</span> $self;
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1Authen.html#a0767dba0fe7f22677987500aee7ce531">WeBWorK::Authen</a>.</p>

</div>
</div>
<a class="anchor" id="acdd5fb0247c2e75e6da746a946a9af30"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::prefix_table" ref="acdd5fb0247c2e75e6da746a946a9af30" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::prefix_table </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-prefix_table' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-prefix_table-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-prefix_table-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-prefix_table-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in prefix_table: 8</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#acdd5fb0247c2e75e6da746a946a9af30">prefix_table</a> {
    my ($self, $base) = @_;
    <span class="keywordflow">if</span> (defined $self-&gt;{r}-&gt;ce-&gt;{authen}{moodle_options}{table_prefix}) {
        <span class="keywordflow">return</span> $self-&gt;{r}-&gt;ce-&gt;{authen}{moodle_options}{table_prefix} . $base;
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">return</span> $base;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ab670ec8cd320c132734cf6708c5f1984"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::site_fixup" ref="ab670ec8cd320c132734cf6708c5f1984" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::site_fixup </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-site_fixup' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-site_fixup-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-site_fixup-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-site_fixup-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in site_fixup: 8</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#ab670ec8cd320c132734cf6708c5f1984">site_fixup</a> {
    my $self = shift;
    
    <span class="keywordflow">if</span> ($self-&gt;was_verified) {
        debug(<span class="stringliteral">&quot;User was verified, updating moodle session.\n&quot;</span>);
        $self-&gt;update_moodle_session;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a974af427584432a27b9030e8ea2d0464"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::unserialize_session" ref="a974af427584432a27b9030e8ea2d0464" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::unserialize_session </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-unserialize_session' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-unserialize_session-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-unserialize_session-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-unserialize_session-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in unserialize_session: 11</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#a974af427584432a27b9030e8ea2d0464">unserialize_session</a> {
    my $serialData = shift;
<span class="preprocessor">    # first, url decode:</span>
<span class="preprocessor"></span>    $serialData =~ s/\%([A-Fa-f0-9]{2})/pack(<span class="charliteral">&#39;C&#39;</span>, hex($1))/seg;
<span class="preprocessor">    # then, split it up by |, it&#39;s some ADODB sillyness</span>
<span class="preprocessor"></span>    my @serialArray = split(/(\w+)\|/, $serialData);
    my %variables;
<span class="preprocessor">    # finally, actually deserialize it:</span>
<span class="preprocessor"></span>    <span class="keywordflow">for</span>( my $i = 1; $i &lt; $#serialArray; $i += 2 ) {
        $variables{$serialArray[$i]} = unserialize($serialArray[$i+1]);
    }
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a035a63ad0d03e7e72737eccc4d9a9779"></a><!-- doxytag: member="WeBWorK::Authen::Moodle::update_moodle_session" ref="a035a63ad0d03e7e72737eccc4d9a9779" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authen::Moodle::update_moodle_session </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-update_moodle_session' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-update_moodle_session-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-update_moodle_session-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-update_moodle_session-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in update_moodle_session: 26</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authen_1_1Moodle.html#a035a63ad0d03e7e72737eccc4d9a9779">update_moodle_session</a> {
<span class="preprocessor">    # extend the timeout of the current moodle session, if one exists.</span>
<span class="preprocessor"></span>    my ($self) = @_;
    my $r = $self-&gt;{r};
    my $db = $r-&gt;db;
    
    my %cookies = <a class="code" href="classWeBWorK_1_1Cookie.html">WeBWorK::Cookie</a>-&gt;fetch( MP2 ? $r : () );
    my $cookie = $cookies{<span class="stringliteral">&quot;MoodleSession&quot;</span>};
    <span class="keywordflow">return</span> unless $cookie;
    
    my $config_table = $self-&gt;prefix_table(<span class="stringliteral">&quot;config&quot;</span>);
    my $value = <span class="stringliteral">&quot;IFNULL((SELECT `value` FROM `$config_table` WHERE `name`=?),?)+?&quot;</span>;
    
<span class="preprocessor">    # Moodle 1.7 stores expiry as a DATETIME, but WeBWorK supplies a UNIX timestamp.</span>
<span class="preprocessor"></span>    $value = <span class="stringliteral">&quot;FROM_UNIXTIME($value)&quot;</span> <span class="keywordflow">if</span> $self-&gt;{moodle17};
    
    my $session_table = $self-&gt;prefix_table($self-&gt;{sql_session_table});
    my $stmt = <span class="stringliteral">&quot;UPDATE `$session_table` SET `expiry`=$value WHERE `sesskey`=?&quot;</span>;
    my @bind_vals = (<span class="stringliteral">&quot;sessiontimeout&quot;</span>, DEFAULT_EXPIRY, time, $cookie-&gt;value);
    
    my $sth = $self-&gt;{mdl_dbh}-&gt;prepare_cached($stmt, undef, 3); # 3: see DBI docs
    my $result = $sth-&gt;execute(@bind_vals);
    $sth-&gt;finish;
    
    <span class="keywordflow">return</span> defined $result;
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="Moodle_8pm_source.html">Moodle.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:43 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
