<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>WeBWorK.pm</h1><a href="WeBWorK_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK.pm,v 1.104 2010/05/15 18:44:26 gage Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK;
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 =head1 NAME
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <a class="code" href="classWeBWorK.html">WeBWorK</a> - Dispatch requests to the appropriate content generator.
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 =head1 SYNOPSIS
<a name="l00024"></a>00024 
<a name="l00025"></a>00025  my $r = <a class="code" href="classApache.html">Apache</a>-&gt;request;
<a name="l00026"></a>00026  my $result = eval { <a class="code" href="classWeBWorK.html#a3ad969bf48d82ae1219c5bb413e4592c">WeBWorK::dispatch</a>($r) };
<a name="l00027"></a>00027  die <span class="stringliteral">&quot;something bad happened: $@&quot;</span> <span class="keywordflow">if</span> $@;
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 =head1 DESCRIPTION
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 C&lt;WeBWorK&gt; is the dispatcher <span class="keywordflow">for</span> the <a class="code" href="classWeBWorK.html">WeBWorK</a> system. Given an <a class="code" href="classApache.html">Apache</a> request
<a name="l00032"></a>00032 object, it performs authentication and determines which subclass of
<a name="l00033"></a>00033 C&lt;WeBWorK::ContentGenerator&gt; to call.
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 =cut
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 BEGIN { $main::VERSION = <span class="stringliteral">&quot;2.4.9&quot;</span>; }
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 use strict;
<a name="l00040"></a>00040 use warnings;
<a name="l00041"></a>00041 use Time::HiRes qw/time/;
<a name="l00042"></a>00042 use <a class="code" href="classWeBWorK_1_1Localize.html">WeBWorK::Localize</a>;
<a name="l00043"></a>00043 <span class="preprocessor"># load WeBWorK::Constants before anything else</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor"># this sets package variables in several packages</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1Constants.html">WeBWorK::Constants</a>;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 use <a class="code" href="classWeBWorK_1_1Authen.html">WeBWorK::Authen</a>;
<a name="l00048"></a>00048 use <a class="code" href="classWeBWorK_1_1Authz.html">WeBWorK::Authz</a>;
<a name="l00049"></a>00049 use <a class="code" href="classWeBWorK_1_1CourseEnvironment.html">WeBWorK::CourseEnvironment</a>;
<a name="l00050"></a>00050 use <a class="code" href="classWeBWorK_1_1DB.html">WeBWorK::DB</a>;
<a name="l00051"></a>00051 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00052"></a>00052 use <a class="code" href="classWeBWorK_1_1Request.html">WeBWorK::Request</a>;
<a name="l00053"></a>00053 use <a class="code" href="classWeBWorK_1_1Upload.html">WeBWorK::Upload</a>;
<a name="l00054"></a>00054 use <a class="code" href="classWeBWorK_1_1URLPath.html">WeBWorK::URLPath</a>;
<a name="l00055"></a><a class="code" href="classWeBWorK.html">00055</a> use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00056"></a>00056 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(runtime_use writeTimingLogEntry);
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 use mod_perl;
<a name="l00059"></a>00059 use constant MP2 =&gt; ( exists $ENV{MOD_PERL_API_VERSION} and $ENV{MOD_PERL_API_VERSION} &gt;= 2 );
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor"># Apache2 needs upload class</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>BEGIN {
<a name="l00063"></a>00063     <span class="keywordflow">if</span> (MP2) {
<a name="l00064"></a>00064         require Apache2::Upload;
<a name="l00065"></a>00065         Apache2::Upload-&gt;import();
<a name="l00066"></a>00066         require Apache2::RequestUtil;
<a name="l00067"></a>00067         Apache2::RequestUtil-&gt;import();
<a name="l00068"></a>00068     }
<a name="l00069"></a>00069 }
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 use constant LOGIN_MODULE =&gt; <span class="stringliteral">&quot;WeBWorK::ContentGenerator::Login&quot;</span>;
<a name="l00072"></a>00072 use constant PROCTOR_LOGIN_MODULE =&gt; <span class="stringliteral">&quot;WeBWorK::ContentGenerator::LoginProctor&quot;</span>;
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 BEGIN {
<a name="l00075"></a>00075 <span class="preprocessor">    # pre-compile all content generators</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">    # Login and LoginProctor need to be handled separately, since they don&#39;t have paths</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>    map { eval <span class="stringliteral">&quot;require $_&quot;</span>; die $@ <span class="keywordflow">if</span> $@ }
<a name="l00078"></a>00078         <a class="code" href="classWeBWorK_1_1URLPath.html">WeBWorK::URLPath</a>-&gt;all_modules,
<a name="l00079"></a>00079         LOGIN_MODULE,
<a name="l00080"></a>00080         PROCTOR_LOGIN_MODULE;
<a name="l00081"></a>00081 <span class="preprocessor">    # other candidates for preloading:</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">    # - DB Record, Schema, and Driver classes (esp. Driver::SQL as it loads DBI)</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span><span class="preprocessor">    # - CourseManagement subclasses (ditto. sql_single.pm)</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="preprocessor">    # - WeBWorK::PG::Local, which loads WeBWorK::PG::Translator</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor">    # - Authen subclasses</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>}
<a name="l00087"></a>00087 
<a name="l00088"></a>00088 our %SeedCE;
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 sub <a class="code" href="classWeBWorK.html#a3ad969bf48d82ae1219c5bb413e4592c">dispatch</a>($) {
<a name="l00091"></a>00091     my ($apache) = @_;
<a name="l00092"></a>00092     my $r = <a class="code" href="classWeBWorK_1_1Request.html">WeBWorK::Request</a>-&gt;new($apache);
<a name="l00093"></a>00093     
<a name="l00094"></a>00094     my $method = $r-&gt;method;
<a name="l00095"></a>00095     my $location = $r-&gt;location;
<a name="l00096"></a>00096     my $uri = $r-&gt;uri;
<a name="l00097"></a>00097     my $path_info = $r-&gt;path_info | <span class="stringliteral">&quot;&quot;</span>;
<a name="l00098"></a>00098     my $args = $r-&gt;args || <span class="stringliteral">&quot;&quot;</span>;
<a name="l00099"></a>00099     my $dir_config = $r-&gt;dir_config;
<a name="l00100"></a>00100     my %conf_vars = map { $_ =&gt; $dir_config-&gt;{$_} } grep { /^webwork_/ } keys %$dir_config;
<a name="l00101"></a>00101     @SeedCE{keys %conf_vars} = values %conf_vars;
<a name="l00102"></a>00102     
<a name="l00103"></a>00103     debug(<span class="stringliteral">&quot;\n\n===&gt; Begin &quot;</span> . __PACKAGE__ . <span class="stringliteral">&quot;::dispatch() &lt;===\n\n&quot;</span>);
<a name="l00104"></a>00104     debug(<span class="stringliteral">&quot;Hi, I&#39;m the new dispatcher!\n&quot;</span>);
<a name="l00105"></a>00105     debug((<span class="stringliteral">&quot;-&quot;</span> x 80) . <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00106"></a>00106     
<a name="l00107"></a>00107     debug(<span class="stringliteral">&quot;Okay, I got some basic information:\n&quot;</span>);
<a name="l00108"></a>00108     debug(<span class="stringliteral">&quot;The apache location is $location\n&quot;</span>);
<a name="l00109"></a>00109     debug(<span class="stringliteral">&quot;The request method is $method\n&quot;</span>);
<a name="l00110"></a>00110     debug(<span class="stringliteral">&quot;The URI is $uri\n&quot;</span>);
<a name="l00111"></a>00111     debug(<span class="stringliteral">&quot;The path-info is $path_info\n&quot;</span>);
<a name="l00112"></a>00112     debug(<span class="stringliteral">&quot;The argument string is $args\n&quot;</span>);
<a name="l00113"></a>00113 <span class="preprocessor">    #debug(&quot;The WeBWorK root directory is $webwork_root\n&quot;);</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span><span class="preprocessor">    #debug(&quot;The PG root directory is $pg_root\n&quot;);</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span>    debug((<span class="stringliteral">&quot;-&quot;</span> x 80) . <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00116"></a>00116     
<a name="l00117"></a>00117     debug(<span class="stringliteral">&quot;The first thing we need to do is munge the path a little:\n&quot;</span>);
<a name="l00118"></a>00118     
<a name="l00119"></a>00119 <span class="preprocessor">    ######################################################################</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span><span class="preprocessor">    # Create a URLPath  object</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span><span class="preprocessor">    ######################################################################</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>    my ($path) = $uri =~ m/$location(.*)/;
<a name="l00123"></a>00123     $path = <span class="stringliteral">&quot;/&quot;</span> <span class="keywordflow">if</span> $path eq <span class="stringliteral">&quot;&quot;</span>; # no path at all
<a name="l00124"></a>00124     
<a name="l00125"></a>00125     debug(<span class="stringliteral">&quot;We can&#39;t trust the path-info, so we make our own path.\n&quot;</span>);
<a name="l00126"></a>00126     debug(<span class="stringliteral">&quot;path-info claims: $path_info\n&quot;</span>);
<a name="l00127"></a>00127     debug(<span class="stringliteral">&quot;but it&#39;s really: $path\n&quot;</span>);
<a name="l00128"></a>00128     debug(<span class="stringliteral">&quot;(if it&#39;s empty, we set it to \&quot;/\&quot;.)\n&quot;</span>);
<a name="l00129"></a>00129     
<a name="l00130"></a>00130     $path =~ s|/+|/|g;
<a name="l00131"></a>00131     debug(<span class="stringliteral">&quot;...and here it is without repeated slashes: $path\n&quot;</span>);
<a name="l00132"></a>00132     
<a name="l00133"></a>00133 <span class="preprocessor">    # lookbehind assertion for &quot;not a slash&quot;</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span><span class="preprocessor">    # matches the boundary after the last char</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>    $path =~ s|(?&lt;=[^/])$|/|;
<a name="l00136"></a>00136     debug(<span class="stringliteral">&quot;...and here it is with a trailing slash: $path\n&quot;</span>);
<a name="l00137"></a>00137     
<a name="l00138"></a>00138     debug((<span class="stringliteral">&quot;-&quot;</span> x 80) . <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00139"></a>00139     
<a name="l00140"></a>00140     debug(<span class="stringliteral">&quot;Now we need to look at the path a little to figure out where we are\n&quot;</span>);
<a name="l00141"></a>00141     
<a name="l00142"></a>00142     debug(<span class="stringliteral">&quot;-------------------- call to WeBWorK::URLPath::newFromPath\n&quot;</span>);
<a name="l00143"></a>00143     my $urlPath = <a class="code" href="classWeBWorK_1_1URLPath.html">WeBWorK::URLPath</a>-&gt;newFromPath($path, $r);
<a name="l00144"></a>00144 <span class="preprocessor">                                # pointer to parent request for access to the $ce and language translation ability</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span><span class="preprocessor">                                # need to add this pointer whenever a new URLPath is created.</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;-------------------- call to WeBWorK::URLPath::newFromPath\n&quot;</span>);
<a name="l00147"></a>00147     
<a name="l00148"></a>00148     unless ($urlPath) {
<a name="l00149"></a>00149         debug(<span class="stringliteral">&quot;This path is invalid... see you later!\n&quot;</span>);
<a name="l00150"></a>00150         die <span class="stringliteral">&quot;The path &#39;$path&#39; is not valid.\n&quot;</span>;
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152     
<a name="l00153"></a>00153     my $displayModule = $urlPath-&gt;module;
<a name="l00154"></a>00154     my %displayArgs = $urlPath-&gt;args;
<a name="l00155"></a>00155     
<a name="l00156"></a>00156     unless ($displayModule) {
<a name="l00157"></a>00157         debug(<span class="stringliteral">&quot;The display module is empty, so we can DECLINE here.\n&quot;</span>);
<a name="l00158"></a>00158         die <span class="stringliteral">&quot;No display module found for path &#39;$path&#39;.&quot;</span>;
<a name="l00159"></a>00159     }
<a name="l00160"></a>00160     
<a name="l00161"></a>00161     debug(<span class="stringliteral">&quot;The display module for this path is: $displayModule\n&quot;</span>);
<a name="l00162"></a>00162     debug(<span class="stringliteral">&quot;...and here are the arguments we&#39;ll pass to it:\n&quot;</span>);
<a name="l00163"></a>00163     <span class="keywordflow">foreach</span> my $key (keys %displayArgs) {
<a name="l00164"></a>00164         debug(<span class="stringliteral">&quot;\t$key =&gt; $displayArgs{$key}\n&quot;</span>);
<a name="l00165"></a>00165     }
<a name="l00166"></a>00166     
<a name="l00167"></a>00167     my $selfPath = $urlPath-&gt;path;
<a name="l00168"></a>00168     my $parent = $urlPath-&gt;parent;
<a name="l00169"></a>00169     my $parentPath = $parent ? $parent-&gt;path : <span class="stringliteral">&quot;&lt;no parent&gt;&quot;</span>;
<a name="l00170"></a>00170     
<a name="l00171"></a>00171     debug(<span class="stringliteral">&quot;Reconstructing the original path gets us: $selfPath\n&quot;</span>);
<a name="l00172"></a>00172     debug(<span class="stringliteral">&quot;And we can generate the path to our parent, too: $parentPath\n&quot;</span>);
<a name="l00173"></a>00173     debug(<span class="stringliteral">&quot;(We could also figure out who our children are, but we&#39;d need to supply additional arguments.)\n&quot;</span>);
<a name="l00174"></a>00174     debug((<span class="stringliteral">&quot;-&quot;</span> x 80) . <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00175"></a>00175     
<a name="l00176"></a>00176     debug(<span class="stringliteral">&quot;The URLPath looks good, we&#39;ll add it to the request.\n&quot;</span>);
<a name="l00177"></a>00177     $r-&gt;urlpath($urlPath);
<a name="l00178"></a>00178     
<a name="l00179"></a>00179     debug(<span class="stringliteral">&quot;Now we want to look at the parameters we got.\n&quot;</span>);
<a name="l00180"></a>00180     
<a name="l00181"></a>00181     debug(<span class="stringliteral">&quot;The raw params:\n&quot;</span>);
<a name="l00182"></a>00182     <span class="keywordflow">foreach</span> my $key ($r-&gt;param) {
<a name="l00183"></a>00183         my @vals = $r-&gt;param($key);
<a name="l00184"></a>00184         my $vals = join(<span class="stringliteral">&quot;, &quot;</span>, map { <span class="stringliteral">&quot;&#39;$_&#39;&quot;</span> } @vals);
<a name="l00185"></a>00185         debug(<span class="stringliteral">&quot;\t$key =&gt; $vals\n&quot;</span>);
<a name="l00186"></a>00186     }
<a name="l00187"></a>00187     
<a name="l00188"></a>00188 <span class="preprocessor">    #mungeParams($r);</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="preprocessor">    #debug(&quot;The munged params:\n&quot;);</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor">    #foreach my $key ($r-&gt;param) {</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span><span class="preprocessor">    #   debug(&quot;\t$key\n&quot;);</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span><span class="preprocessor">    #   debug(&quot;\t\t$_\n&quot;) foreach $r-&gt;param($key);</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span><span class="preprocessor">    #}</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>    
<a name="l00196"></a>00196     debug((<span class="stringliteral">&quot;-&quot;</span> x 80) . <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00197"></a>00197     
<a name="l00198"></a>00198     my $apache_hostname = $r-&gt;hostname;
<a name="l00199"></a>00199     my $apache_port     = $r-&gt;get_server_port;
<a name="l00200"></a>00200     my $apache_is_ssl   = ($r-&gt;subprocess_env(<span class="stringliteral">&#39;https&#39;</span>) ? 1 : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00201"></a>00201     my $apache_root_url;
<a name="l00202"></a>00202     <span class="keywordflow">if</span> ($apache_is_ssl) {
<a name="l00203"></a>00203         $apache_root_url = <span class="stringliteral">&quot;https://$apache_hostname&quot;</span>;
<a name="l00204"></a>00204         $apache_root_url .= <span class="stringliteral">&quot;:$apache_port&quot;</span> <span class="keywordflow">if</span> $apache_port != 443;
<a name="l00205"></a>00205     } <span class="keywordflow">else</span> {
<a name="l00206"></a>00206         $apache_root_url = <span class="stringliteral">&quot;http://$apache_hostname&quot;</span>;
<a name="l00207"></a>00207         $apache_root_url .= <span class="stringliteral">&quot;:$apache_port&quot;</span> <span class="keywordflow">if</span> $apache_port != 80;
<a name="l00208"></a>00208     }
<a name="l00209"></a>00209     
<a name="l00210"></a>00210     
<a name="l00211"></a>00211 <span class="preprocessor">    ####################################################################</span>
<a name="l00212"></a>00212 <span class="preprocessor"></span><span class="preprocessor">    # Create Course Environment    $ce</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span><span class="preprocessor">    ####################################################################</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;We need to get a course environment (with or without a courseID!)\n&quot;</span>);
<a name="l00215"></a>00215     my $ce = eval { <span class="keyword">new</span> <a class="code" href="classWeBWorK_1_1CourseEnvironment.html">WeBWorK::CourseEnvironment</a>({
<a name="l00216"></a>00216         %SeedCE,
<a name="l00217"></a>00217         courseName =&gt; $displayArgs{courseID},
<a name="l00218"></a>00218 <span class="preprocessor">        # this is kind of a hack, but it&#39;s really the only sane way to get this</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span><span class="preprocessor">        # server information into the PG box</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span>        apache_hostname =&gt; $apache_hostname,
<a name="l00221"></a>00221         apache_port =&gt; $apache_port,
<a name="l00222"></a>00222         apache_is_ssl =&gt; $apache_is_ssl,
<a name="l00223"></a>00223         apache_root_url =&gt; $apache_root_url,
<a name="l00224"></a>00224     }) };
<a name="l00225"></a>00225     $@ and die <span class="stringliteral">&quot;Failed to initialize course environment: $@\n&quot;</span>;
<a name="l00226"></a>00226     debug(<span class="stringliteral">&quot;Here&#39;s the course environment: $ce\n&quot;</span>);
<a name="l00227"></a>00227     $r-&gt;ce($ce);
<a name="l00228"></a>00228     
<a name="l00229"></a>00229     
<a name="l00230"></a>00230 <span class="preprocessor">    ######################</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span><span class="preprocessor">    # Localizing language</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span><span class="preprocessor">    ######################</span>
<a name="l00233"></a>00233 <span class="preprocessor"></span>    my $language= $ce-&gt;{language} || <span class="stringliteral">&quot;en&quot;</span>;
<a name="l00234"></a>00234 <span class="preprocessor">    # $r-&gt;language_handle( WeBWorK::Localize-&gt;get_handle($language) );</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span>    $r-&gt;language_handle( <a class="code" href="classWeBWorK_1_1Localize.html#aa29946a22a0318125c4c5e359f6788fa">WeBWorK::Localize::getLoc</a>($language) );
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     my @uploads;
<a name="l00238"></a>00238     <span class="keywordflow">if</span> (MP2) {
<a name="l00239"></a>00239         my $upload_table = $r-&gt;upload;
<a name="l00240"></a>00240         @uploads = values %$upload_table <span class="keywordflow">if</span> defined $upload_table;
<a name="l00241"></a>00241     } <span class="keywordflow">else</span> {
<a name="l00242"></a>00242         @uploads = $r-&gt;upload;
<a name="l00243"></a>00243     }
<a name="l00244"></a>00244     <span class="keywordflow">foreach</span> my $u (@uploads) {
<a name="l00245"></a>00245 <span class="preprocessor">        # make sure it&#39;s a &quot;real&quot; upload</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span>        next unless $u-&gt;filename;
<a name="l00247"></a>00247         
<a name="l00248"></a>00248 <span class="preprocessor">        # store the upload</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span>        my $upload = <a class="code" href="classWeBWorK_1_1Upload.html">WeBWorK::Upload</a>-&gt;store($u,
<a name="l00250"></a>00250             dir =&gt; $ce-&gt;{webworkDirs}-&gt;{uploadCache}
<a name="l00251"></a>00251         );
<a name="l00252"></a>00252         
<a name="l00253"></a>00253 <span class="preprocessor">        # store the upload ID and hash in the file upload field</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span>        my $id = $upload-&gt;id;
<a name="l00255"></a>00255         my $hash = $upload-&gt;hash;
<a name="l00256"></a>00256         $r-&gt;param($u-&gt;name =&gt; <span class="stringliteral">&quot;$id $hash&quot;</span>);
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258     
<a name="l00259"></a>00259 <span class="preprocessor">    # create these out here. they should fail if they don&#39;t have the right information</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span><span class="preprocessor">    # this lets us not be so careful about whether these objects are defined when we use them.</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span><span class="preprocessor">    # instead, we just create the behavior that if they don&#39;t have a valid $db they fail.</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span>    my $authz = <span class="keyword">new</span> <a class="code" href="classWeBWorK_1_1Authz.html">WeBWorK::Authz</a>($r);
<a name="l00263"></a>00263     $r-&gt;authz($authz);
<a name="l00264"></a>00264     
<a name="l00265"></a>00265 <span class="preprocessor">    # figure out which authentication modules to use</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span><span class="preprocessor">    #my $user_authen_module;</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span><span class="preprocessor">    #my $proctor_authen_module;</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span><span class="preprocessor">    #if (ref $ce-&gt;{authen}{user_module} eq &quot;HASH&quot;) {</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span><span class="preprocessor">    #   if (exists $ce-&gt;{authen}{user_module}{$ce-&gt;{dbLayoutName}}) {</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">    #       $user_authen_module = $ce-&gt;{authen}{user_module}{$ce-&gt;{dbLayoutName}};</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span><span class="preprocessor">    #   } else {</span>
<a name="l00272"></a>00272 <span class="preprocessor"></span><span class="preprocessor">    #       $user_authen_module = $ce-&gt;{authen}{user_module}{&quot;*&quot;};</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span><span class="preprocessor">    #   }</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span><span class="preprocessor">    #} else {</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span><span class="preprocessor">    #   $user_authen_module = $ce-&gt;{authen}{user_module};</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span><span class="preprocessor">    #}</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span><span class="preprocessor">    #if (ref $ce-&gt;{authen}{proctor_module} eq &quot;HASH&quot;) {</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span><span class="preprocessor">    #   if (exists $ce-&gt;{authen}{proctor_module}{$ce-&gt;{dbLayoutName}}) {</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span><span class="preprocessor">    #       $proctor_authen_module = $ce-&gt;{authen}{proctor_module}{$ce-&gt;{dbLayoutName}};</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span><span class="preprocessor">    #   } else {</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="preprocessor">    #       $proctor_authen_module = $ce-&gt;{authen}{proctor_module}{&quot;*&quot;};</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">    #   }</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span><span class="preprocessor">    #} else {</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span><span class="preprocessor">    #   $proctor_authen_module = $ce-&gt;{authen}{proctor_module};</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span><span class="preprocessor">    #}</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span>    
<a name="l00287"></a>00287     my $user_authen_module = <a class="code" href="classWeBWorK_1_1Authen.html#a3c1c3ea6f0c758d0f37519f732bba145">WeBWorK::Authen::class</a>($ce, <span class="stringliteral">&quot;user_module&quot;</span>);
<a name="l00288"></a>00288     
<a name="l00289"></a>00289     runtime_use $user_authen_module;
<a name="l00290"></a>00290     my $authen = $user_authen_module-&gt;new($r);
<a name="l00291"></a>00291     debug(<span class="stringliteral">&quot;Using user_authen_module $user_authen_module: $authen\n&quot;</span>);
<a name="l00292"></a>00292     $r-&gt;authen($authen);
<a name="l00293"></a>00293     
<a name="l00294"></a>00294     my $db;
<a name="l00295"></a>00295     
<a name="l00296"></a>00296     <span class="keywordflow">if</span> ($displayArgs{courseID}) {
<a name="l00297"></a>00297         debug(<span class="stringliteral">&quot;We got a courseID from the URLPath, now we can do some stuff:\n&quot;</span>);
<a name="l00298"></a>00298         
<a name="l00299"></a>00299         unless (-e $ce-&gt;{courseDirs}-&gt;{root}) {
<a name="l00300"></a>00300             die <span class="stringliteral">&quot;Course &#39;$displayArgs{courseID}&#39; not found: $!&quot;</span>;
<a name="l00301"></a>00301         }
<a name="l00302"></a>00302         
<a name="l00303"></a>00303         debug(<span class="stringliteral">&quot;...we can create a database object...\n&quot;</span>);
<a name="l00304"></a>00304         $db = <span class="keyword">new</span> <a class="code" href="classWeBWorK_1_1DB.html">WeBWorK::DB</a>($ce-&gt;{dbLayout});
<a name="l00305"></a>00305         debug(<span class="stringliteral">&quot;(here&#39;s the DB handle: $db)\n&quot;</span>);
<a name="l00306"></a>00306         $r-&gt;db($db);
<a name="l00307"></a>00307         
<a name="l00308"></a>00308         my $authenOK = $authen-&gt;verify;
<a name="l00309"></a>00309         <span class="keywordflow">if</span> ($authenOK) {
<a name="l00310"></a>00310             my $userID = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00311"></a>00311             debug(<span class="stringliteral">&quot;Hi, $userID, glad you made it.\n&quot;</span>);
<a name="l00312"></a>00312             
<a name="l00313"></a>00313 <span class="preprocessor">            # tell authorizer to cache this user&#39;s permission level</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span>            $authz-&gt;setCachedUser($userID);
<a name="l00315"></a>00315             
<a name="l00316"></a>00316             debug(<span class="stringliteral">&quot;Now we deal with the effective user:\n&quot;</span>);
<a name="l00317"></a>00317             my $eUserID = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>) || $userID;
<a name="l00318"></a>00318             debug(<span class="stringliteral">&quot;userID=$userID eUserID=$eUserID\n&quot;</span>);
<a name="l00319"></a>00319             <span class="keywordflow">if</span> ($userID ne $eUserID) {
<a name="l00320"></a>00320                 debug(<span class="stringliteral">&quot;userID and eUserID differ... seeing if userID has &#39;become_student&#39; permission.\n&quot;</span>);
<a name="l00321"></a>00321                 my $su_authorized = $authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;become_student&quot;</span>);
<a name="l00322"></a>00322                 <span class="keywordflow">if</span> ($su_authorized) {
<a name="l00323"></a>00323                     debug(<span class="stringliteral">&quot;Ok, looks like you&#39;re allowed to become $eUserID. Whoopie!\n&quot;</span>);
<a name="l00324"></a>00324                 } <span class="keywordflow">else</span> {
<a name="l00325"></a>00325                     debug(<span class="stringliteral">&quot;Uh oh, you&#39;re not allowed to become $eUserID. Nice try!\n&quot;</span>);
<a name="l00326"></a>00326                     die <span class="stringliteral">&quot;You are not allowed to act as another user.\n&quot;</span>;
<a name="l00327"></a>00327                 }
<a name="l00328"></a>00328             }
<a name="l00329"></a>00329             
<a name="l00330"></a>00330 <span class="preprocessor">            # set effectiveUser in case it was changed or not set to begin with</span>
<a name="l00331"></a>00331 <span class="preprocessor"></span>            $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span> =&gt; $eUserID);
<a name="l00332"></a>00332             
<a name="l00333"></a>00333 <span class="preprocessor">            # if we&#39;re doing a proctored test, after the user has been authenticated</span>
<a name="l00334"></a>00334 <span class="preprocessor"></span><span class="preprocessor">            # we need to also check on the proctor.  note that in the gateway quiz</span>
<a name="l00335"></a>00335 <span class="preprocessor"></span><span class="preprocessor">            # module we double check this, to be sure that someone isn&#39;t taking a</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span><span class="preprocessor">            # proctored quiz but calling the unproctored ContentGenerator</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span>            my $urlProducedPath = $urlPath-&gt;path();
<a name="l00338"></a>00338             <span class="keywordflow">if</span> ( $urlProducedPath =~ /proctored_quiz_mode/i ) {
<a name="l00339"></a>00339                 my $proctor_authen_module = <a class="code" href="classWeBWorK_1_1Authen.html#a3c1c3ea6f0c758d0f37519f732bba145">WeBWorK::Authen::class</a>($ce, <span class="stringliteral">&quot;proctor_module&quot;</span>);
<a name="l00340"></a>00340                 runtime_use $proctor_authen_module;
<a name="l00341"></a>00341                 my $authenProctor = $proctor_authen_module-&gt;new($r);
<a name="l00342"></a>00342                 debug(<span class="stringliteral">&quot;Using proctor_authen_module $proctor_authen_module: $authenProctor\n&quot;</span>);
<a name="l00343"></a>00343                 my $procAuthOK = $authenProctor-&gt;verify();
<a name="l00344"></a>00344                 
<a name="l00345"></a>00345                 <span class="keywordflow">if</span> (not $procAuthOK) {
<a name="l00346"></a>00346                     $displayModule = PROCTOR_LOGIN_MODULE;
<a name="l00347"></a>00347                 }
<a name="l00348"></a>00348             }
<a name="l00349"></a>00349         } <span class="keywordflow">else</span> {
<a name="l00350"></a>00350             debug(<span class="stringliteral">&quot;Bad news: authentication failed!\n&quot;</span>);
<a name="l00351"></a>00351             $displayModule = LOGIN_MODULE;
<a name="l00352"></a>00352             debug(<span class="stringliteral">&quot;set displayModule to $displayModule\n&quot;</span>);
<a name="l00353"></a>00353         }
<a name="l00354"></a>00354     }
<a name="l00355"></a>00355     
<a name="l00356"></a>00356 <span class="preprocessor">    # store the time before we invoke the content generator</span>
<a name="l00357"></a>00357 <span class="preprocessor"></span>    my $cg_start = time; # <span class="keyword">this</span> is Time::HiRes<span class="stringliteral">&#39;s time, which gives floating point values</span>
<a name="l00358"></a>00358 <span class="stringliteral">    </span>
<a name="l00359"></a>00359 <span class="stringliteral">    debug((&quot;-&quot; x 80) . &quot;\n&quot;);</span>
<a name="l00360"></a>00360 <span class="stringliteral">    debug(&quot;Finally, we&#39;</span>ll load the display module...\n<span class="stringliteral">&quot;);</span>
<a name="l00361"></a>00361 <span class="stringliteral">    </span>
<a name="l00362"></a>00362 <span class="stringliteral">    runtime_use($displayModule);</span>
<a name="l00363"></a>00363 <span class="stringliteral">    </span>
<a name="l00364"></a>00364 <span class="stringliteral">    debug(&quot;</span>...instantiate it...\n<span class="stringliteral">&quot;);</span>
<a name="l00365"></a>00365 <span class="stringliteral">    </span>
<a name="l00366"></a>00366 <span class="stringliteral">    my $instance = $displayModule-&gt;new($r);</span>
<a name="l00367"></a>00367 <span class="stringliteral">    </span>
<a name="l00368"></a>00368 <span class="stringliteral">    debug(&quot;</span>...and call it:\n<span class="stringliteral">&quot;);</span>
<a name="l00369"></a>00369 <span class="stringliteral">    debug(&quot;</span>-------------------- call to ${displayModule}::go\n<span class="stringliteral">&quot;);</span>
<a name="l00370"></a>00370 <span class="stringliteral">    </span>
<a name="l00371"></a>00371 <span class="stringliteral">    my $result = $instance-&gt;go();</span>
<a name="l00372"></a>00372 <span class="stringliteral">    </span>
<a name="l00373"></a>00373 <span class="stringliteral">    debug(&quot;</span>-------------------- call to ${displayModule}::go\n<span class="stringliteral">&quot;);</span>
<a name="l00374"></a>00374 <span class="stringliteral">    </span>
<a name="l00375"></a>00375 <span class="stringliteral">    my $cg_end = time;</span>
<a name="l00376"></a>00376 <span class="stringliteral">    my $cg_duration = $cg_end - $cg_start;</span>
<a name="l00377"></a>00377 <span class="stringliteral">    writeTimingLogEntry($ce, &quot;</span>[<span class="stringliteral">&quot;.$r-&gt;uri.&quot;</span>]<span class="stringliteral">&quot;, sprintf(&quot;</span>runTime = %.3f sec<span class="stringliteral">&quot;, $cg_duration).&quot;</span> <span class="stringliteral">&quot;.$ce-&gt;{dbLayoutName}, &quot;</span><span class="stringliteral">&quot;);</span>
<a name="l00378"></a>00378 <span class="stringliteral">    </span>
<a name="l00379"></a>00379 <span class="stringliteral">    debug(&quot;</span>returning result: <span class="stringliteral">&quot; . (defined $result ? $result : &quot;</span>UNDEF<span class="stringliteral">&quot;) . &quot;</span>\n<span class="stringliteral">&quot;);</span>
<a name="l00380"></a>00380 <span class="stringliteral">        #@LimitedPolynomial::BOP::ISA; #FIXME this  is needed to zero out </span>
<a name="l00381"></a>00381 <span class="stringliteral">        #@LimitedPolynomial::UOP::ISA;</span>
<a name="l00382"></a>00382 <span class="stringliteral">        #\@LimitedPolynomial::BOP::ISA and prevent error messages of the form </span>
<a name="l00383"></a>00383 <span class="stringliteral">        #[Sat May 15 14:23:08 2010] [warn] [client 127.0.0.1] [/webwork2/gage_course/test_set/6/] </span>
<a name="l00384"></a>00384 <span class="stringliteral">        #Can&#39;t locate package LimitedPolynomial::BOP for @LimitedPolynomial::BOP::add::ISA at /opt/webwork/webwork2/lib/Apache/WeBWorK.pm line 115., referer: http://localhost/webwork2/gage_course/test_set/6/ no one knows why</span>
<a name="l00385"></a>00385 <span class="stringliteral">    return $result;</span>
<a name="l00386"></a>00386 <span class="stringliteral">}</span>
<a name="l00387"></a>00387 <span class="stringliteral"></span>
<a name="l00388"></a>00388 <span class="stringliteral">sub mungeParams {</span>
<a name="l00389"></a>00389 <span class="stringliteral">    my ($r) = @_;</span>
<a name="l00390"></a>00390 <span class="stringliteral">    </span>
<a name="l00391"></a>00391 <span class="stringliteral">    my @paramQueue;</span>
<a name="l00392"></a>00392 <span class="stringliteral">    </span>
<a name="l00393"></a>00393 <span class="stringliteral">    # remove all the params from the request, and store them in the param queue</span>
<a name="l00394"></a>00394 <span class="stringliteral">    foreach my $key ($r-&gt;param) {</span>
<a name="l00395"></a>00395 <span class="stringliteral">        push @paramQueue, [ $key =&gt; [ $r-&gt;param($key) ] ];</span>
<a name="l00396"></a>00396 <span class="stringliteral">        $r-&gt;parms-&gt;unset($key)</span>
<a name="l00397"></a>00397 <span class="stringliteral">    }</span>
<a name="l00398"></a>00398 <span class="stringliteral">    </span>
<a name="l00399"></a>00399 <span class="stringliteral">    # exhaust the param queue, decoding encoded params</span>
<a name="l00400"></a>00400 <span class="stringliteral">    while (@paramQueue) {</span>
<a name="l00401"></a>00401 <span class="stringliteral">        my ($key, $values) = @{ shift @paramQueue };</span>
<a name="l00402"></a>00402 <span class="stringliteral">        </span>
<a name="l00403"></a>00403 <span class="stringliteral">        if ($key =~ m/\,/) {</span>
<a name="l00404"></a>00404 <span class="stringliteral">            # we have multiple params encoded in a single param</span>
<a name="l00405"></a>00405 <span class="stringliteral">            # split them up and add them to the end of the queue</span>
<a name="l00406"></a>00406 <span class="stringliteral">            push @paramQueue, map { [ $_, $values ] } split m/\,/, $key;</span>
<a name="l00407"></a>00407 <span class="stringliteral">        } elsif ($key =~ m/\:/) {</span>
<a name="l00408"></a>00408 <span class="stringliteral">            # we have a whole param encoded in a key</span>
<a name="l00409"></a>00409 <span class="stringliteral">            # split it up and add it to the end of the queue</span>
<a name="l00410"></a>00410 <span class="stringliteral">            my ($newKey, $newValue) = split m/\:/, $key;</span>
<a name="l00411"></a>00411 <span class="stringliteral">            push @paramQueue, [ $newKey, [ $newValue ] ];</span>
<a name="l00412"></a>00412 <span class="stringliteral">        } else {</span>
<a name="l00413"></a>00413 <span class="stringliteral">            # this is a &quot;</span>normal<span class="stringliteral">&quot; param</span>
<a name="l00414"></a>00414 <span class="stringliteral">            # add it to the param list</span>
<a name="l00415"></a>00415 <span class="stringliteral">            if (defined $r-&gt;param($key)) {</span>
<a name="l00416"></a>00416 <span class="stringliteral">                # the param already exists -- append the values we have</span>
<a name="l00417"></a>00417 <span class="stringliteral">                $r-&gt;param($key =&gt; [ $r-&gt;param($key), @$values ]);</span>
<a name="l00418"></a>00418 <span class="stringliteral">            } else {</span>
<a name="l00419"></a>00419 <span class="stringliteral">                # the param doesn&#39;t exist -- create it with the values we have</span>
<a name="l00420"></a>00420 <span class="stringliteral">                $r-&gt;param($key =&gt; $values);</span>
<a name="l00421"></a>00421 <span class="stringliteral">            }</span>
<a name="l00422"></a>00422 <span class="stringliteral">        }</span>
<a name="l00423"></a>00423 <span class="stringliteral">    }</span>
<a name="l00424"></a>00424 <span class="stringliteral">}</span>
<a name="l00425"></a>00425 <span class="stringliteral"></span>
<a name="l00426"></a>00426 <span class="stringliteral"></span>
<a name="l00427"></a>00427 <span class="stringliteral"># labeled_input subroutine</span>
<a name="l00428"></a>00428 <span class="stringliteral">#</span>
<a name="l00429"></a>00429 <span class="stringliteral"># Creates a form input element with a label added to the correct place.</span>
<a name="l00430"></a>00430 <span class="stringliteral"># Takes in up to six parameters:</span>
<a name="l00431"></a>00431 <span class="stringliteral">#</span>
<a name="l00432"></a>00432 <span class="stringliteral"># -type (type of input element), -name (name of input element), -id (id of the input element), -value (value of the input element), -label_text (the text on the label), -label_id (the id of the label)</span>
<a name="l00433"></a>00433 <span class="stringliteral">#</span>
<a name="l00434"></a>00434 <span class="stringliteral"># If any of the parameters are not specified, they default to &quot;</span>none<span class="stringliteral">&quot;. </span>
<a name="l00435"></a>00435 <span class="stringliteral">#</span>
<a name="l00436"></a>00436 <span class="stringliteral"># UPDATE: updated lable tags so that their &quot;</span><span class="keywordflow">for</span><span class="stringliteral">&quot; property will point to the id of the element that they are labeling. This means that entering an id for the input element becomes essentially mandatory if you want the tag to work correctly.</span>
<a name="l00437"></a>00437 <span class="stringliteral"></span>
<a name="l00438"></a>00438 <span class="stringliteral"># DEPRECATED - see below</span>
<a name="l00439"></a>00439 <span class="stringliteral"></span>
<a name="l00440"></a>00440 <span class="stringliteral"># sub labeled_input</span>
<a name="l00441"></a>00441 <span class="stringliteral"># {</span>
<a name="l00442"></a>00442 <span class="stringliteral">    # my %param = (-type=&gt;&quot;</span>none<span class="stringliteral">&quot;, -name=&gt;&quot;</span>none<span class="stringliteral">&quot;, -value=&gt;&quot;</span>none<span class="stringliteral">&quot;, -id=&gt;&quot;</span>none<span class="stringliteral">&quot;, -label_text=&gt;&quot;</span>none<span class="stringliteral">&quot;, -label_id=&gt;&quot;</span>none<span class="stringliteral">&quot;, @_);</span>
<a name="l00443"></a>00443 <span class="stringliteral">    </span>
<a name="l00444"></a>00444 <span class="stringliteral">    # if($param{-type} eq &quot;</span>text<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>password<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>file<span class="stringliteral">&quot;){</span>
<a name="l00445"></a>00445 <span class="stringliteral">        # return CGI::label({-id=&gt;$param{-label_id}, -for=&gt;$param{-id}},$param{-label_text}).CGI::input({-type=&gt;$param{-type}, -name=&gt;$param{-name}, -value=&gt;$param{-value}, -id=&gt;$param{-id}}).CGI::br();</span>
<a name="l00446"></a>00446 <span class="stringliteral">    # }</span>
<a name="l00447"></a>00447 <span class="stringliteral">    # elsif($param{-type} eq &quot;</span>checkbox<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>radio<span class="stringliteral">&quot;){</span>
<a name="l00448"></a>00448 <span class="stringliteral">        # return CGI::input({-type=&gt;$param{-type}, -name=&gt;$param{-name}, -value=&gt;$param{-value}, -id=&gt;$param{-id}}).CGI::label({-id=&gt;$param{-label_id}, -for=&gt;$param{-id}},$param{-label_text}).CGI::br();</span>
<a name="l00449"></a>00449 <span class="stringliteral">    # }</span>
<a name="l00450"></a>00450 <span class="stringliteral">    # elsif($param{-type} eq &quot;</span>submit<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>button<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>reset<span class="stringliteral">&quot;){</span>
<a name="l00451"></a>00451 <span class="stringliteral">        # return CGI::input({-type=&gt;$param{-type}, -name=&gt;$param{-name}, -value=&gt;$param{-value}, -id=&gt;$param{-id}}).CGI::br();</span>
<a name="l00452"></a>00452 <span class="stringliteral">    # }</span>
<a name="l00453"></a>00453 <span class="stringliteral">    # else{</span>
<a name="l00454"></a>00454 <span class="stringliteral">        # return &quot;</span>Not a valid input type<span class="stringliteral">&quot;;</span>
<a name="l00455"></a>00455 <span class="stringliteral">    # }</span>
<a name="l00456"></a>00456 <span class="stringliteral"># }</span>
<a name="l00457"></a>00457 <span class="stringliteral"></span>
<a name="l00458"></a>00458 <span class="stringliteral"></span>
<a name="l00459"></a>00459 <span class="stringliteral"># CGI_labeled_input subroutine</span>
<a name="l00460"></a>00460 <span class="stringliteral"></span>
<a name="l00461"></a>00461 <span class="stringliteral"># A replacement to the labeled_input subroutine above, created when it was determined that the old subroutine was limited in that it did not allow for attributes other than the ones that it specified.</span>
<a name="l00462"></a>00462 <span class="stringliteral"></span>
<a name="l00463"></a>00463 <span class="stringliteral"># This subroutine rectifies that problem by taking in attributes for the input elements and label elements as hashes and simply entering them into the CGI routines, which already support attributes as hash parameters.</span>
<a name="l00464"></a>00464 <span class="stringliteral"></span>
<a name="l00465"></a>00465 <span class="stringliteral"># The way it attaches label tags is similar to the labeled_input subroutine.</span>
<a name="l00466"></a>00466 <span class="stringliteral"></span>
<a name="l00467"></a>00467 <span class="stringliteral"># This subroutine has also been expanded to be able to handle select elements.</span>
<a name="l00468"></a>00468 <span class="stringliteral"></span>
<a name="l00469"></a>00469 <span class="stringliteral"># Five parameters are taken in as a hash: -type (specifying the type of the input element), -id (specifying the id of the input element), -label_text (specifying the text to go in the label), -input_attr (a hash specifying any additional attributes for the input element, if any), and -label_attr (a hash specifying additional attributes for the label element, if any).</span>
<a name="l00470"></a>00470 <span class="stringliteral"></span>
<a name="l00471"></a>00471 <span class="stringliteral"># As before, all parameters are optional, with the scalar parameters defaulting to &quot;</span>none<span class="stringliteral">&quot; and the hash parameters defaulting to empty. </span>
<a name="l00472"></a>00472 <span class="stringliteral"></span>
<a name="l00473"></a>00473 <span class="stringliteral"></span>
<a name="l00474"></a>00474 <span class="stringliteral">sub CGI_labeled_input</span>
<a name="l00475"></a>00475 <span class="stringliteral">{</span>
<a name="l00476"></a>00476 <span class="stringliteral">    my %param = (-type=&gt;&quot;</span>none<span class="stringliteral">&quot;, -id=&gt;&quot;</span>none<span class="stringliteral">&quot;, -label_text=&gt;&quot;</span>none<span class="stringliteral">&quot;, -input_attr=&gt;{}, -label_attr=&gt;{}, @_);</span>
<a name="l00477"></a>00477 <span class="stringliteral">    </span>
<a name="l00478"></a>00478 <span class="stringliteral">    $param{-input_attr}{-type} = $param{-type};</span>
<a name="l00479"></a>00479 <span class="stringliteral">    $param{-input_attr}{-id} = $param{-id};</span>
<a name="l00480"></a>00480 <span class="stringliteral">    $param{-label_attr}{-for} = $param{-id};</span>
<a name="l00481"></a>00481 <span class="stringliteral">    </span>
<a name="l00482"></a>00482 <span class="stringliteral">    if($param{-type} eq &quot;</span>text<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>password<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>file<span class="stringliteral">&quot;){</span>
<a name="l00483"></a>00483 <span class="stringliteral">        return CGI::label($param{-label_attr},$param{-label_text}).CGI::input($param{-input_attr});</span>
<a name="l00484"></a>00484 <span class="stringliteral">    }</span>
<a name="l00485"></a>00485 <span class="stringliteral">    elsif($param{-type} eq &quot;</span>checkbox<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>radio<span class="stringliteral">&quot;){</span>
<a name="l00486"></a>00486 <span class="stringliteral">        return CGI::input($param{-input_attr}).CGI::label($param{-label_attr},$param{-label_text});</span>
<a name="l00487"></a>00487 <span class="stringliteral">    }</span>
<a name="l00488"></a>00488 <span class="stringliteral">    elsif($param{-type} eq &quot;</span>submit<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>button<span class="stringliteral">&quot; or $param{-type} eq &quot;</span>reset<span class="stringliteral">&quot;){</span>
<a name="l00489"></a>00489 <span class="stringliteral">        return CGI::input($param{-input_attr});</span>
<a name="l00490"></a>00490 <span class="stringliteral">    }</span>
<a name="l00491"></a>00491 <span class="stringliteral">    elsif($param{-type} eq &quot;</span>select<span class="stringliteral">&quot;){</span>
<a name="l00492"></a>00492 <span class="stringliteral">        return CGI::label($param{-label_attr},$param{-label_text}).CGI::popup_menu($param{-input_attr});</span>
<a name="l00493"></a>00493 <span class="stringliteral">    }</span>
<a name="l00494"></a>00494 <span class="stringliteral">    elsif($param{-type} eq &quot;</span>textarea<span class="stringliteral">&quot;){</span>
<a name="l00495"></a>00495 <span class="stringliteral">        return CGI::label($param{-label_attr},$param{-label_text}).CGI::br().CGI::br().CGI::textarea($param{-input_attr});</span>
<a name="l00496"></a>00496 <span class="stringliteral">    }</span>
<a name="l00497"></a>00497 <span class="stringliteral">    else{</span>
<a name="l00498"></a>00498 <span class="stringliteral">        &quot;</span>Not a valid input type<span class="stringliteral">&quot;;</span>
<a name="l00499"></a>00499 <span class="stringliteral">    }</span>
<a name="l00500"></a>00500 <span class="stringliteral">}</span>
<a name="l00501"></a>00501 <span class="stringliteral"></span>
<a name="l00502"></a>00502 <span class="stringliteral"># split_cap subroutine - ghe3</span>
<a name="l00503"></a>00503 <span class="stringliteral"></span>
<a name="l00504"></a>00504 <span class="stringliteral"># A sort of wrapper for the built-in split function which uses capital letters as a delimiter, and returns a string containing the separated substrings separated by a whitespace.  Used to make actionID&#39;s more readable.</span>
<a name="l00505"></a>00505 <span class="stringliteral"></span>
<a name="l00506"></a>00506 <span class="stringliteral">sub split_cap</span>
<a name="l00507"></a>00507 <span class="stringliteral">{</span>
<a name="l00508"></a>00508 <span class="stringliteral">    my $str = shift;</span>
<a name="l00509"></a>00509 <span class="stringliteral">    </span>
<a name="l00510"></a>00510 <span class="stringliteral">    my @str_arr = split(//,$str);</span>
<a name="l00511"></a>00511 <span class="stringliteral">    my $count = scalar(@str_arr);</span>
<a name="l00512"></a>00512 <span class="stringliteral">    </span>
<a name="l00513"></a>00513 <span class="stringliteral">    my $i = 0;</span>
<a name="l00514"></a>00514 <span class="stringliteral">    my $prev = 0;</span>
<a name="l00515"></a>00515 <span class="stringliteral">    my @result = ();</span>
<a name="l00516"></a>00516 <span class="stringliteral">    my $hasCapital = 0;</span>
<a name="l00517"></a>00517 <span class="stringliteral">    foreach(@str_arr){</span>
<a name="l00518"></a>00518 <span class="stringliteral">        if($_ =~ /[A-Z]/){</span>
<a name="l00519"></a>00519 <span class="stringliteral">            $hasCapital = 1;</span>
<a name="l00520"></a>00520 <span class="stringliteral">            push(@result, join(&quot;</span><span class="stringliteral">&quot;, @str_arr[$prev..$i-1]));</span>
<a name="l00521"></a>00521 <span class="stringliteral">            $prev = $i;</span>
<a name="l00522"></a>00522 <span class="stringliteral">        }</span>
<a name="l00523"></a>00523 <span class="stringliteral">        $i++;</span>
<a name="l00524"></a>00524 <span class="stringliteral">    }</span>
<a name="l00525"></a>00525 <span class="stringliteral">    </span>
<a name="l00526"></a>00526 <span class="stringliteral">    unless($hasCapital){</span>
<a name="l00527"></a>00527 <span class="stringliteral">        return $str;</span>
<a name="l00528"></a>00528 <span class="stringliteral">    }</span>
<a name="l00529"></a>00529 <span class="stringliteral">    else{</span>
<a name="l00530"></a>00530 <span class="stringliteral">        push(@result, join(&quot;</span><span class="stringliteral">&quot;, @str_arr[$prev..$count-1])); </span>
<a name="l00531"></a>00531 <span class="stringliteral">        return join(&quot;</span> <span class="stringliteral">&quot;,@result);</span>
<a name="l00532"></a>00532 <span class="stringliteral">    }</span>
<a name="l00533"></a>00533 <span class="stringliteral">}</span>
<a name="l00534"></a>00534 <span class="stringliteral"></span>
<a name="l00535"></a>00535 <span class="stringliteral"># underscore_to_whitespace subroutine</span>
<a name="l00536"></a>00536 <span class="stringliteral"></span>
<a name="l00537"></a>00537 <span class="stringliteral"># a simple subroutine for converting underscores in a given string to whitespace</span>
<a name="l00538"></a>00538 <span class="stringliteral"></span>
<a name="l00539"></a>00539 <span class="stringliteral">sub underscore_to_whitespace{</span>
<a name="l00540"></a>00540 <span class="stringliteral">    my $str = shift;</span>
<a name="l00541"></a>00541 <span class="stringliteral">    </span>
<a name="l00542"></a>00542 <span class="stringliteral">    my @strArr = split(&quot;</span><span class="stringliteral">&quot;,$str);</span>
<a name="l00543"></a>00543 <span class="stringliteral">    foreach(@strArr){</span>
<a name="l00544"></a>00544 <span class="stringliteral">        if($_ eq &quot;</span>_<span class="stringliteral">&quot;){</span>
<a name="l00545"></a>00545 <span class="stringliteral">            $_ = &quot;</span> <span class="stringliteral">&quot;</span>
<a name="l00546"></a>00546 <span class="stringliteral">        }</span>
<a name="l00547"></a>00547 <span class="stringliteral">    }</span>
<a name="l00548"></a>00548 <span class="stringliteral">    </span>
<a name="l00549"></a>00549 <span class="stringliteral">    my $result = join(&quot;</span><span class="stringliteral">&quot;,@strArr);</span>
<a name="l00550"></a>00550 <span class="stringliteral">    </span>
<a name="l00551"></a>00551 <span class="stringliteral">    return $result;</span>
<a name="l00552"></a>00552 <span class="stringliteral">}</span>
<a name="l00553"></a>00553 <span class="stringliteral"></span>
<a name="l00554"></a>00554 <span class="stringliteral">sub remove_duplicates{</span>
<a name="l00555"></a>00555 <span class="stringliteral">    my @arr = @_;</span>
<a name="l00556"></a>00556 <span class="stringliteral">    </span>
<a name="l00557"></a>00557 <span class="stringliteral">    my %unique;</span>
<a name="l00558"></a>00558 <span class="stringliteral">    my @result;</span>
<a name="l00559"></a>00559 <span class="stringliteral">    </span>
<a name="l00560"></a>00560 <span class="stringliteral">    foreach(@arr){</span>
<a name="l00561"></a>00561 <span class="stringliteral">        if(defined $unique{$_}){</span>
<a name="l00562"></a>00562 <span class="stringliteral">            next;</span>
<a name="l00563"></a>00563 <span class="stringliteral">        }</span>
<a name="l00564"></a>00564 <span class="stringliteral">        else{</span>
<a name="l00565"></a>00565 <span class="stringliteral">            push(@result, $_);</span>
<a name="l00566"></a>00566 <span class="stringliteral">            $unique{$_} = &quot;</span>seen<span class="stringliteral">&quot;;</span>
<a name="l00567"></a>00567 <span class="stringliteral">        }</span>
<a name="l00568"></a>00568 <span class="stringliteral">    }</span>
<a name="l00569"></a>00569 <span class="stringliteral">    </span>
<a name="l00570"></a>00570 <span class="stringliteral">    return @result;</span>
<a name="l00571"></a>00571 <span class="stringliteral">    </span>
<a name="l00572"></a>00572 <span class="stringliteral">}</span>
<a name="l00573"></a>00573 <span class="stringliteral"></span>
<a name="l00574"></a>00574 <span class="stringliteral">=head1 AUTHOR</span>
<a name="l00575"></a>00575 <span class="stringliteral"></span>
<a name="l00576"></a>00576 <span class="stringliteral">Written by Dennis Lambe, malsyned at math.rochester.edu. Modified by Sam</span>
<a name="l00577"></a>00577 <span class="stringliteral">Hathaway, sh002i at math.rochester.edu.</span>
<a name="l00578"></a>00578 <span class="stringliteral"></span>
<a name="l00579"></a>00579 <span class="stringliteral">=cut</span>
<a name="l00580"></a>00580 <span class="stringliteral"></span>
<a name="l00581"></a>00581 <span class="stringliteral">1;</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:35 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
