<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::Utils::DBUpgrade Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1Utils.html">Utils</a>::<a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html">DBUpgrade</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::Utils::DBUpgrade Class Reference</h1><!-- doxytag: class="WeBWorK::Utils::DBUpgrade" --><!-- doxytag: inherits="WeBWorK::Utils" --><div class="dynheader">
Inheritance diagram for WeBWorK::Utils::DBUpgrade:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1Utils_1_1DBUpgrade__inherit__graph.png" border="0" usemap="#WeBWorK_1_1Utils_1_1DBUpgrade_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1Utils_1_1DBUpgrade_inherit__map" id="WeBWorK_1_1Utils_1_1DBUpgrade_inherit__map">
<area shape="rect" href="classWeBWorK_1_1Utils.html" title="WeBWorK::Utils" alt="" coords="43,80,160,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="60,5,143,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::Utils::DBUpgrade:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1Utils_1_1DBUpgrade__coll__graph.png" border="0" usemap="#WeBWorK_1_1Utils_1_1DBUpgrade_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1Utils_1_1DBUpgrade_coll__map" id="WeBWorK_1_1Utils_1_1DBUpgrade_coll__map">
<area shape="rect" href="classWeBWorK_1_1Utils.html" title="WeBWorK::Utils" alt="" coords="43,80,160,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="60,5,143,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1Utils_1_1DBUpgrade-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a3bd017462c0697f6ae02bf03940de815">verbose</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#adc01d5443cf03d1007e38d7fccc6df99">upgrade_course_to_version</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#af21e8ac0d788149725fc5b8994202d82">register_sql_table</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a0670eed6b6fe7c40622a87857491c4ce">set_db_version</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a687590095dd81b688b9b689125d39edf">ce</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a2b67a82dec8b999782bfd67da064566b">init</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a319388b95add83f331971f24c86e205b">confirm</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a680298d1ebfd09940d3d89564d12209e">new</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a4e5d237a8458112b40a9f0f84aacb4ee">upgrade_to_version</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a42eaada34b08195a8dc9128fefd7b8b0">unlock_database</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#ae7fd8cb51dec7d0594ff575524d54223">sql_table_exists</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#af8cddf805782687e04d7ffdda8935240">do_upgrade</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#add904fd92750bf9f0a3caf45be96db2d">unregister_sql_table</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a588375828485eb56df73128e10070d49">DESTROY</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#aa4a61667869f2da8607b65ef1bcda905">check_db_version_format</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a5a498f025ab097f7b077f9a62c2b938a">get_db_version</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#ac105f0a57d78b684f06510b3600ee6ef">ask_permission_stdio</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a43f2a201a533872fbc8921750ffecdad">dbh</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a4800b82fd5e818f5b058e2ac02905eda">lock_database</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#aac5662aa1b892c628cda3a015b01a837">load_sql_table_list</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html">WeBWorK::Utils::DBUpgrade</a> - upgrade <a class="el" href="classWeBWorK.html">WeBWorK</a> SQL databases. </p>

<p>Definition at line <a class="el" href="DBUpgrade_8pm_source.html#l00021">21</a> of file <a class="el" href="DBUpgrade_8pm_source.html">DBUpgrade.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="ac105f0a57d78b684f06510b3600ee6ef"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::ask_permission_stdio" ref="ac105f0a57d78b684f06510b3600ee6ef" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::ask_permission_stdio </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-ask_permission_stdio' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-ask_permission_stdio-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-ask_permission_stdio-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-ask_permission_stdio-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in ask_permission_stdio: 16</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#ac105f0a57d78b684f06510b3600ee6ef">ask_permission_stdio</a> {
    my ($prompt, $default) = @_;
    
    $default = 1 <span class="keywordflow">if</span> not defined $default;
    my $options = $default ? <span class="stringliteral">&quot;[Y/n]&quot;</span> : <span class="stringliteral">&quot;[y/N]&quot;</span>;
    
    <span class="keywordflow">while</span> (1) {
        print <span class="stringliteral">&quot;$prompt $options &quot;</span>;
        my $resp = &lt;STDIN&gt;;
        chomp $resp;
        <span class="keywordflow">return</span> $default <span class="keywordflow">if</span> $resp eq <span class="stringliteral">&quot;&quot;</span>;
        <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> lc $resp eq <span class="stringliteral">&quot;y&quot;</span>;
        <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> lc $resp eq <span class="stringliteral">&quot;n&quot;</span>;
        $prompt = <span class="stringliteral">&#39;Please enter &quot;y&quot; or &quot;n&quot;.&#39;</span>;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a687590095dd81b688b9b689125d39edf"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::ce" ref="a687590095dd81b688b9b689125d39edf" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::ce </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-ce' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-ce-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-ce-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-ce-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in ce: 1</span>
<span class="preprocessor">sub ce { return shift-&gt;{ce} }</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aa4a61667869f2da8607b65ef1bcda905"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::check_db_version_format" ref="aa4a61667869f2da8607b65ef1bcda905" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::check_db_version_format </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-check_db_version_format' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-check_db_version_format-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-check_db_version_format-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-check_db_version_format-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in check_db_version_format: 15</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#aa4a61667869f2da8607b65ef1bcda905">check_db_version_format</a> {
    my ($self, $db_version) = @_;
    <span class="keywordflow">if</span> (not defined $db_version) {
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&#39;db_version&#39; has a NULL value. $vers_value_should_be&quot;</span>;
    } elsif ($db_version !~ /^-?\d+$/) {
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&#39;db_version&#39; is set to the non-numeric value &#39;$db_version&#39;. $vers_value_should_be&quot;</span>;
    } elsif ($db_version &lt; 0) {
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&#39;db_version&#39; is set to the negative value &#39;$db_version&#39;. $vers_value_should_be&quot;</span>;
    } elsif ($db_version == 0) {
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&#39;db_version&#39; is set to 0, which is reserved to indicate a pre-automatic-upgrade version. $vers_value_should_be&quot;</span>;
    } <span class="keywordflow">else</span> {
<span class="preprocessor">        # db_version is a positive integer! yay!</span>
<span class="preprocessor"></span>        <span class="keywordflow">return</span>;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a319388b95add83f331971f24c86e205b"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::confirm" ref="a319388b95add83f331971f24c86e205b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::confirm </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-confirm' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-confirm-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-confirm-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-confirm-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in confirm: 1</span>
<span class="preprocessor">sub confirm { my $sub = shift-&gt;{confirm_sub}; return &amp;$sub(@_) }</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a43f2a201a533872fbc8921750ffecdad"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::dbh" ref="a43f2a201a533872fbc8921750ffecdad" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::dbh </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-dbh' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-dbh-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-dbh-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-dbh-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in dbh: 1</span>
<span class="preprocessor">sub dbh { return shift-&gt;{dbh} }</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a588375828485eb56df73128e10070d49"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::DESTROY" ref="a588375828485eb56df73128e10070d49" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::DESTROY </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-DESTROY' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-DESTROY-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-DESTROY-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-DESTROY-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in DESTROY: 5</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a588375828485eb56df73128e10070d49">DESTROY</a> {
    my ($self) = @_;
    $self-&gt;unlock_database;
    $self-&gt;SUPER::DESTROY <span class="keywordflow">if</span> $self-&gt;can(<span class="stringliteral">&quot;SUPER::DESTROY&quot;</span>);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="af8cddf805782687e04d7ffdda8935240"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::do_upgrade" ref="af8cddf805782687e04d7ffdda8935240" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::do_upgrade </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-do_upgrade' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-do_upgrade-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-do_upgrade-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-do_upgrade-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in do_upgrade: 137</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#af8cddf805782687e04d7ffdda8935240">do_upgrade</a> {
    my ($self) = @_;
    
    $self-&gt;lock_database;
    $self-&gt;load_sql_table_list;
    
<span class="preprocessor">    #### Get system&#39;s database version</span>
<span class="preprocessor"></span>    
    my $system_db_version = $self-&gt;get_db_version();
    
    <span class="keywordflow">if</span> ($system_db_version == DB_TABLE_MISSING) {
        warn <span class="stringliteral">&quot;No &#39;upgrade&#39; table exists: assuming system database version is 0.\n&quot;</span>;
        $system_db_version = 0;
    } elsif ($system_db_version == DB_RECORD_MISSING) {
        die <span class="stringliteral">&quot;The &#39;dbupgrade&#39; table exists in the database, but no &#39;db_version&#39; record exists in it. Can&#39;t continue.\n&quot;</span>;
    } elsif (my $error = $self-&gt;check_db_version_format($system_db_version)) {
        die <span class="stringliteral">&quot;$error Can&#39;t continue.\n&quot;</span>;
    } elsif ($system_db_version &gt; $THIS_DB_VERSION) {
        die <span class="stringliteral">&quot;This database&#39;s system db_version value is $system_db_version, but the current database version is only $THIS_DB_VERSION. This database was probably used with a newer version of WeBWorK. Can&#39;t continue.\n&quot;</span>;
    }
    
    $self-&gt;verbose(<span class="stringliteral">&quot;Initial system db_version is $system_db_version\n&quot;</span>);
    
<span class="preprocessor">    #### Get database version for each course</span>
<span class="preprocessor"></span><span class="preprocessor">    # If $system_db_version &lt; $FIRST_COURSE_DB_VERSION, most courses will not have</span>
<span class="preprocessor"></span><span class="preprocessor">    # a db_version, but some might. (Say, if they were imported from a newer</span>
<span class="preprocessor"></span><span class="preprocessor">    # version of WeBWorK.)</span>
<span class="preprocessor"></span>    
    my @ww_courses = listCourses($self-&gt;ce);
    $self-&gt;{ww_courses} = \@ww_courses;

    my $course_db_versions = $self-&gt;{course_db_versions};

    <span class="keywordflow">foreach</span> my $course (@ww_courses) {
        my $course_db_version = $self-&gt;get_db_version($course);
        
        <span class="keywordflow">if</span> ($system_db_version &lt; $FIRST_COURSE_DB_VERSION) {
            
            <span class="keywordflow">if</span> ($course_db_version == DB_TABLE_MISSING) {
<span class="preprocessor">                # this is to be expected -- we assume the course is at the current system version</span>
<span class="preprocessor"></span>                $self-&gt;verbose(<span class="stringliteral">&quot;Course &#39;$course&#39; has no db_version of it&#39;s own, assuming system db_version $system_db_version.\n&quot;</span>);
                $course_db_versions-&gt;{$course} = $system_db_version;
            } <span class="keywordflow">else</span> {
<span class="preprocessor">                # there is a settings table -- the course is probably from a later version of WW</span>
<span class="preprocessor"></span>                warn <span class="stringliteral">&quot;The course &#39;$course&#39; already contains a &#39;${course}_setting&#39; table.&quot;</span>
                    .<span class="stringliteral">&quot; Settings tables were introduced at db_version $FIRST_COURSE_DB_VERSION,&quot;</span>
                    .<span class="stringliteral">&quot; but the current system db_version is only $system_db_version.&quot;</span>
                    .<span class="stringliteral">&quot; We&#39;ll assume that this course is from a later version of WeBWorK&quot;</span>
                    .<span class="stringliteral">&quot; and try to determine the course&#39;s version...\n&quot;</span>;
                <span class="keywordflow">if</span> ($course_db_version == DB_RECORD_MISSING) {
                    warn <span class="stringliteral">&quot;There is no &#39;db_version&#39; record in the course&#39;s settings table,&quot;</span>
                        .<span class="stringliteral">&quot; so we can&#39;t determine the version. This course will be excluded from upgrades.&quot;</span>
                        .<span class="stringliteral">&quot; If you know the version of this course,&quot;</span>
                        .<span class="stringliteral">&quot; add a &#39;db_version&#39; record with the appropriate value to the &#39;${course}_setting&#39; table.\n&quot;</span>;
                } elsif (my $error = <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#aa4a61667869f2da8607b65ef1bcda905">check_db_version_format</a>($course_db_version)) {
                    warn <span class="stringliteral">&quot;$error\n&quot;</span>;
                    warn <span class="stringliteral">&quot;There is a &#39;db_version&#39; record in the course&#39;s settings table,&quot;</span>
                        .<span class="stringliteral">&quot; but it has an invalid value , so we can&#39;t determine the version.&quot;</span>
                        .<span class="stringliteral">&quot; This course will be excluded from upgrades.&quot;</span>
                        .<span class="stringliteral">&quot; If you know the version of this course,&quot;</span>
                        .<span class="stringliteral">&quot; update &#39;db_version&#39; record in the &#39;${course}_setting&#39; table with the appropriate value.\n&quot;</span>;
                } elsif ($course_db_version &lt; $FIRST_COURSE_DB_VERSION) {
                    warn <span class="stringliteral">&quot;This course&#39;s version is $course_db_version, which is before per-course versioning was introduced.&quot;</span>
                        .<span class="stringliteral">&quot; Therefore, a course at version $course_db_version should have neither a &#39;${course}_setting&#39; table&quot;</span>
                        .<span class="stringliteral">&quot; nor a &#39;db_version&#39; record in that table. Regardless, we will assume the recorded version is correct.\n&quot;</span>;
                    $course_db_versions-&gt;{$course} = $system_db_version;
                } <span class="keywordflow">else</span> {
                    warn <span class="stringliteral">&quot;This course&#39;s version is $course_db_version, which makes sense.\n&quot;</span>;
                    $course_db_versions-&gt;{$course} = $course_db_version;
                }
            }
            
        } <span class="keywordflow">else</span> {
            
            <span class="keywordflow">if</span> ($course_db_version == DB_TABLE_MISSING) {
                warn <span class="stringliteral">&quot;The course &#39;$course&#39; is missing a &#39;${course}_setting&#39; table, so we can&#39;t determine the version.&quot;</span>
                    .<span class="stringliteral">&quot; This course will be ignored.&quot;</span>
                    .<span class="stringliteral">&quot; If you know the version of this course, add a &#39;${course}_setting&#39; table&quot;</span>
                    .<span class="stringliteral">&quot; and add a &#39;db_version&#39; record with the appropriate value to the table.\n&quot;</span>;
            } <span class="keywordflow">else</span> {
<span class="preprocessor">                # there is a settings table -- good</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span> ($course_db_version == DB_RECORD_MISSING) {
                    warn <span class="stringliteral">&quot;The course &#39;$course&#39; is missing a &#39;db_version&#39; record in its &#39;${course}_setting&#39; table,&quot;</span>
                        .<span class="stringliteral">&quot; so we can&#39;t determine the version. This course will be ignored.&quot;</span>
                        .<span class="stringliteral">&quot; If you know the version of this course,&quot;</span>
                        .<span class="stringliteral">&quot; add a &#39;db_version&#39; record with the appropriate value to the &#39;${course}_setting&#39; table.\n&quot;</span>;
                } elsif (my $error = <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#aa4a61667869f2da8607b65ef1bcda905">check_db_version_format</a>($course_db_version)) {
                    warn <span class="stringliteral">&quot;$error\n&quot;</span>;
                    warn <span class="stringliteral">&quot;The course &#39;$course&#39; has an invalid value in the &#39;db_version&#39; record in its &#39;${course}_setting&#39; table,&quot;</span>
                        .<span class="stringliteral">&quot; so we can&#39;t determine the version. This course will be ignored.&quot;</span>
                        .<span class="stringliteral">&quot; If you know the version of this course,&quot;</span>
                        .<span class="stringliteral">&quot; update the &#39;db_version&#39; record in the &#39;${course}_setting&#39; table with the appropriate value.\n&quot;</span>;
                } elsif ($course_db_version &lt; $FIRST_COURSE_DB_VERSION) {
                    warn <span class="stringliteral">&quot;This course&#39;s version is $course_db_version, which is before per-course versioning was introduced.&quot;</span>
                        .<span class="stringliteral">&quot; Therefore, a course at version $course_db_version should have neither a &#39;${course}_setting&#39; table&quot;</span>
                        .<span class="stringliteral">&quot; nor a &#39;db_version&#39; record in that table. Regardless, we will assume the recorded version is correct.\n&quot;</span>;
                    $course_db_versions-&gt;{$course} = $course_db_version;
                } <span class="keywordflow">else</span> {
                    $self-&gt;verbose(<span class="stringliteral">&quot;Course &#39;$course&#39; has valid db_version $course_db_version.\n&quot;</span>);
                    $course_db_versions-&gt;{$course} = $system_db_version;
                }
            }
            
        }
    }

    $self-&gt;verbose(map { <span class="stringliteral">&quot;$_ =&gt; $$course_db_versions{$_}\n&quot;</span> } keys %$course_db_versions);

<span class="preprocessor">    #### Determine lowest version</span>
<span class="preprocessor"></span>
    my $lowest_db_version = $system_db_version;
    <span class="keywordflow">foreach</span> my $v (values %$course_db_versions) {
        $lowest_db_version = $v <span class="keywordflow">if</span> $v &lt; $lowest_db_version;
    }

    $self-&gt;verbose(<span class="stringliteral">&quot;Lowest db_version is $lowest_db_version\n&quot;</span>);

<span class="preprocessor">    #### Do the upgrades</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # upgrade_to_version uses this</span>
<span class="preprocessor"></span>    $self-&gt;{system_db_version} = $system_db_version;
    
    my $vers = $lowest_db_version;
    <span class="keywordflow">while</span> ($vers &lt; $THIS_DB_VERSION) {
        $vers++;
        unless ($self-&gt;upgrade_to_version($vers)) {
            print <span class="stringliteral">&quot;\nUpgrading from version &quot;</span>.($vers-1).<span class="stringliteral">&quot; to $vers failed.\n\n&quot;</span>;
            unless ($self-&gt;ask_permission(<span class="stringliteral">&quot;Ignore this error and go on to the next version?&quot;</span>, 0)) {
                exit 3;
            }
        }
    }
    
<span class="preprocessor">    #### All done!</span>
<span class="preprocessor"></span>    
    print <span class="stringliteral">&quot;\nDatabase is up-to-date at version $vers.\n&quot;</span>;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a5a498f025ab097f7b077f9a62c2b938a"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::get_db_version" ref="a5a498f025ab097f7b077f9a62c2b938a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::get_db_version </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-get_db_version' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-get_db_version-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-get_db_version-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-get_db_version-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in get_db_version: 15</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a5a498f025ab097f7b077f9a62c2b938a">get_db_version</a> {
    my ($self, $course) = @_;
    my $table = defined $course ? <span class="stringliteral">&quot;${course}_setting&quot;</span> : <span class="stringliteral">&quot;dbupgrade&quot;</span>;
    <span class="keywordflow">if</span> ($self-&gt;sql_table_exists($table)) {
        my $table_quoted = $self-&gt;dbh-&gt;quote_identifier($table);
        my @record = $self-&gt;dbh-&gt;selectrow_array(<span class="stringliteral">&quot;SELECT `value` FROM $table_quoted WHERE `name`=&#39;db_version&#39;&quot;</span>);
        <span class="keywordflow">if</span> (@record) {
            <span class="keywordflow">return</span> $record[0];
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">return</span> DB_RECORD_MISSING;
        }
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">return</span> DB_TABLE_MISSING;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2b67a82dec8b999782bfd67da064566b"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::init" ref="a2b67a82dec8b999782bfd67da064566b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::init </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-init' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-init-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-init-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-init-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in init: 17</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a2b67a82dec8b999782bfd67da064566b">init</a> {
    my ($self, %options) = @_;
    
    $self-&gt;{<a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a43f2a201a533872fbc8921750ffecdad">dbh</a>} = DBI-&gt;connect(
        $options{ce}{database_dsn},
        $options{ce}{database_username},
        $options{ce}{database_password},
        {
            PrintError =&gt; 0,
            RaiseError =&gt; 1,
        },
    );
    $self-&gt;{verbose_sub} = $options{verbose_sub} || \&amp;debug;
    $self-&gt;{confirm_sub} = $options{confirm_sub} || \&amp;<a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#ac105f0a57d78b684f06510b3600ee6ef">ask_permission_stdio</a>;
    $self-&gt;{ce} = $options{ce};
    $self-&gt;{course_db_versions} = {};
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aac5662aa1b892c628cda3a015b01a837"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::load_sql_table_list" ref="aac5662aa1b892c628cda3a015b01a837" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::load_sql_table_list </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-load_sql_table_list' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-load_sql_table_list-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-load_sql_table_list-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-load_sql_table_list-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in load_sql_table_list: 5</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#aac5662aa1b892c628cda3a015b01a837">load_sql_table_list</a> {
    my ($self) = @_;
    my $sql_tables_ref = $self-&gt;dbh-&gt;selectcol_arrayref(<span class="stringliteral">&quot;SHOW TABLES&quot;</span>);
    $self-&gt;{sql_tables} = {}; @{$self-&gt;{sql_tables}}{@$sql_tables_ref} = ();
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a4800b82fd5e818f5b058e2ac02905eda"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::lock_database" ref="a4800b82fd5e818f5b058e2ac02905eda" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::lock_database </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-lock_database' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-lock_database-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-lock_database-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-lock_database-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in lock_database: 14</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a4800b82fd5e818f5b058e2ac02905eda">lock_database</a> {
    my ($self) = @_;
    
    $self-&gt;verbose(<span class="stringliteral">&quot;Obtaining dbupgrade lock...\n&quot;</span>);
    my ($lock_status) = $self-&gt;dbh-&gt;selectrow_array(<span class="stringliteral">&quot;SELECT GET_LOCK(&#39;dbupgrade&#39;, 10)&quot;</span>);
    <span class="keywordflow">if</span> (not defined $lock_status) {
        die <span class="stringliteral">&quot;Couldn&#39;t obtain lock because an error occurred.\n&quot;</span>;
    }
    <span class="keywordflow">if</span> ($lock_status) {
        $self-&gt;verbose(<span class="stringliteral">&quot;Got lock.\n&quot;</span>);
    } <span class="keywordflow">else</span> {
        die <span class="stringliteral">&quot;Timed out while waiting for lock.\n&quot;</span>;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a680298d1ebfd09940d3d89564d12209e"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::new" ref="a680298d1ebfd09940d3d89564d12209e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::new </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-new' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-new-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-new-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-new-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in new: 7</span>
<span class="preprocessor"></span>sub <span class="keyword">new</span> {
    my $invocant = shift;
    my $class = ref $invocant || $invocant;
    my $self = bless {}, $class;
    $self-&gt;init(@_);
    <span class="keywordflow">return</span> $self;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="af21e8ac0d788149725fc5b8994202d82"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::register_sql_table" ref="af21e8ac0d788149725fc5b8994202d82" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::register_sql_table </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-register_sql_table' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-register_sql_table-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-register_sql_table-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-register_sql_table-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in register_sql_table: 4</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#af21e8ac0d788149725fc5b8994202d82">register_sql_table</a> {
    my ($self, $table) = @_;
    $self-&gt;{sql_tables}{$table} = ();
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a0670eed6b6fe7c40622a87857491c4ce"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::set_db_version" ref="a0670eed6b6fe7c40622a87857491c4ce" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::set_db_version </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-set_db_version' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-set_db_version-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-set_db_version-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-set_db_version-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in set_db_version: 6</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a0670eed6b6fe7c40622a87857491c4ce">set_db_version</a> {
    my ($self, $vers, $course) = @_;
    my $table = defined $course ? <span class="stringliteral">&quot;${course}_setting&quot;</span> : <span class="stringliteral">&quot;dbupgrade&quot;</span>;
    my $table_quoted = $self-&gt;dbh-&gt;quote_identifier($table);
    $self-&gt;dbh-&gt;do(<span class="stringliteral">&quot;UPDATE $table_quoted SET `value`=? WHERE `name`=&#39;db_version&#39;&quot;</span>, {}, $vers);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ae7fd8cb51dec7d0594ff575524d54223"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::sql_table_exists" ref="ae7fd8cb51dec7d0594ff575524d54223" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::sql_table_exists </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-sql_table_exists' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-sql_table_exists-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-sql_table_exists-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-sql_table_exists-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in sql_table_exists: 4</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#ae7fd8cb51dec7d0594ff575524d54223">sql_table_exists</a> {
    my ($self, $table) = @_;
    <span class="keywordflow">return</span> exists $self-&gt;{sql_tables}{$table};
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a42eaada34b08195a8dc9128fefd7b8b0"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::unlock_database" ref="a42eaada34b08195a8dc9128fefd7b8b0" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::unlock_database </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-unlock_database' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-unlock_database-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-unlock_database-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-unlock_database-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in unlock_database: 14</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a42eaada34b08195a8dc9128fefd7b8b0">unlock_database</a> {
    my ($self) = @_;
    
    $self-&gt;verbose(<span class="stringliteral">&quot;Releasing dbupgrade lock...\n&quot;</span>);
    my ($lock_status) = $self-&gt;dbh-&gt;selectrow_array(<span class="stringliteral">&quot;SELECT RELEASE_LOCK(&#39;dbupgrade&#39;)&quot;</span>);
    <span class="keywordflow">if</span> (not defined $lock_status) {
        die <span class="stringliteral">&quot;Couldn&#39;t release lock because the lock does not exist.\n&quot;</span>;
    }
    <span class="keywordflow">if</span> ($lock_status) {
        $self-&gt;verbose(<span class="stringliteral">&quot;Released lock.\n&quot;</span>);
    } <span class="keywordflow">else</span> {
        die <span class="stringliteral">&quot;Couldn&#39;t release lock because the lock is not held by this thread.\n&quot;</span>;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="add904fd92750bf9f0a3caf45be96db2d"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::unregister_sql_table" ref="add904fd92750bf9f0a3caf45be96db2d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::unregister_sql_table </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-unregister_sql_table' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-unregister_sql_table-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-unregister_sql_table-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-unregister_sql_table-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in unregister_sql_table: 4</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#add904fd92750bf9f0a3caf45be96db2d">unregister_sql_table</a> {
    my ($self, $table) = @_;
    <span class="keyword">delete</span> $self-&gt;{sql_tables}{$table};
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="adc01d5443cf03d1007e38d7fccc6df99"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::upgrade_course_to_version" ref="adc01d5443cf03d1007e38d7fccc6df99" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::upgrade_course_to_version </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-upgrade_course_to_version' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-upgrade_course_to_version-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-upgrade_course_to_version-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-upgrade_course_to_version-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in upgrade_course_to_version: 34</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#adc01d5443cf03d1007e38d7fccc6df99">upgrade_course_to_version</a> {
    my ($self, $course, $vers) = @_;
    my $course_db_versions = $self-&gt;{course_db_versions};
    my %info = %{$DB_VERSIONS[$vers]};
    
    my $course_vers = $course_db_versions-&gt;{$course};
<span class="preprocessor">    #$self-&gt;verbose(&quot;course=$course course_vers=$course_vers vers=$vers\n&quot;);</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (not defined $course_vers) {
        $self-&gt;verbose(<span class="stringliteral">&quot;Course &#39;$course&#39; has a missing or invalid version -- skipping.\n&quot;</span>);
        <span class="keywordflow">return</span> SKIPPED;
    } elsif ($course_vers == $vers) {
        $self-&gt;verbose(<span class="stringliteral">&quot;Course &#39;$course&#39; is already at version $vers -- skipping.\n&quot;</span>);
        <span class="keywordflow">return</span> SKIPPED;
    } elsif ($course_vers &gt; $vers) {
        $self-&gt;verbose(<span class="stringliteral">&quot;Course &#39;$course&#39; version $course_vers &gt; target version $vers -- skipping.\n&quot;</span>);
        <span class="keywordflow">return</span> SKIPPED;
    } elsif ($course_vers &lt; $vers-1) {
        warn <span class="stringliteral">&quot;Course &#39;$course&#39; at version $course_vers, which is too old to upgrade to $vers. This should never happen. Not upgrading.\n&quot;</span>;
        <span class="keywordflow">return</span> SKIPPED;
    }
    
    $self-&gt;verbose(<span class="stringliteral">&quot;Upgrading course &#39;$course&#39; to version $vers...\n&quot;</span>);
    eval {
        local $WeBWorK::Utils::DBUpgrade::self = $self;
        $info{course_code}-&gt;($course);
    };
    <span class="keywordflow">if</span> ($@) {
        print <span class="stringliteral">&quot;\nAn error occured while running the course upgrade code for version $vers on course $course:\n&quot;</span>;
        print <span class="stringliteral">&quot;$@&quot;</span>;
        <span class="keywordflow">return</span> ERROR;
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">return</span> OK;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a4e5d237a8458112b40a9f0f84aacb4ee"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::upgrade_to_version" ref="a4e5d237a8458112b40a9f0f84aacb4ee" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::upgrade_to_version </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-upgrade_to_version' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-upgrade_to_version-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-upgrade_to_version-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-upgrade_to_version-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in upgrade_to_version: 54</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a4e5d237a8458112b40a9f0f84aacb4ee">upgrade_to_version</a> {
    my ($self, $vers) = @_;
    my %info = %{$DB_VERSIONS[$vers]};
    
    print <span class="stringliteral">&quot;\nUpgrading database from version &quot;</span> . ($vers-1) . <span class="stringliteral">&quot; to $vers...\n&quot;</span>;
    my $desc = $info{desc} || <span class="stringliteral">&quot;has no description.&quot;</span>;
    print <span class="stringliteral">&quot;(Version $vers $desc)\n&quot;</span>;
    
    <span class="keywordflow">if</span> ($self-&gt;{system_db_version} &lt; $vers and exists $info{global_code}) {
        eval {
            local $WeBWorK::Utils::DBUpgrade::self = $self;
            $info{global_code}-&gt;();
        };
        <span class="keywordflow">if</span> ($@) {
            print <span class="stringliteral">&quot;\nAn error occured while running the system upgrade code for version $vers:\n&quot;</span>;
            print <span class="stringliteral">&quot;$@&quot;</span>;
            <span class="keywordflow">return</span> 0 unless $self-&gt;ask_permission(<span class="stringliteral">&quot;Ignore this error and keep going?&quot;</span>, 0);
        }
    }
    $self-&gt;set_db_version($vers);
    
    my $do_upgrade = 1;
    <span class="keywordflow">foreach</span> my $course (@{$self-&gt;{ww_courses}}) {
        <span class="keywordflow">if</span> ($do_upgrade) {
            my $result = $self-&gt;upgrade_course_to_version($course, $vers);
            <span class="keywordflow">if</span> ($result == ERROR) {
                <span class="keywordflow">if</span> ($self-&gt;ask_permission(<span class="stringliteral">&quot;Update course&#39;s stored db_version to $vers anyway?&quot;</span>, 0)) {
                    <a class="code" href="classWeBWorK_1_1Utils_1_1DBUpgrade.html#a0670eed6b6fe7c40622a87857491c4ce">set_db_version</a>($vers, $course);
                    print <span class="stringliteral">&quot;OK, updated course&#39;s stored db_version.\n&quot;</span>;
                } <span class="keywordflow">else</span> {
                    print <span class="stringliteral">&quot;OK, not updating course&#39;s stored db_version.\n&quot;</span>;
                }
                <span class="keywordflow">if</span> ($self-&gt;ask_permission(<span class="stringliteral">&quot;Upgrade the remaining courses to version $vers?&quot;</span>, 0)) {
                    print <span class="stringliteral">&quot;OK, going on to the next course...\n&quot;</span>;
                } <span class="keywordflow">else</span> {
                    print <span class="stringliteral">&quot;OK, we&#39;ll skip upgrading the rest of the courses to version $vers.\n&quot;</span>;
                    <span class="keywordflow">if</span> ($self-&gt;ask_permission(<span class="stringliteral">&quot;Update the stored db_version for the courses we&#39;re skipping, as if we had upgraded them?&quot;</span>, 1)) {
                        $do_upgrade = 0;
                    } <span class="keywordflow">else</span> {
                        <span class="keywordflow">return</span> 0;
                    }
                }
            } elsif ($result == OK) {
                $self-&gt;set_db_version($vers, $course);
            } elsif ($result == SKIPPED) {
<span class="preprocessor">                # do nothing</span>
<span class="preprocessor"></span>            }
        } <span class="keywordflow">else</span> {
            $self-&gt;set_db_version($vers, $course);
        }
    }
    
    <span class="keywordflow">return</span> 1;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a3bd017462c0697f6ae02bf03940de815"></a><!-- doxytag: member="WeBWorK::Utils::DBUpgrade::verbose" ref="a3bd017462c0697f6ae02bf03940de815" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::DBUpgrade::verbose </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-verbose' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-verbose-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-verbose-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-verbose-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in verbose: 1</span>
<span class="preprocessor">sub verbose { my $sub = shift-&gt;{verbose_sub}; return &amp;$sub(@_) }</span>
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="DBUpgrade_8pm_source.html">DBUpgrade.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 23:00:19 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
