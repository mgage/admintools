<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: UserDetail.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>UserDetail.pm</h1><a href="UserDetail_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: </span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::Instructor::UserDetail;
<a name="l00018"></a>00018 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">WeBWorK::ContentGenerator::Instructor</a>);
<a name="l00019"></a>00019 
<a name="l00020"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html">00020</a> =head1 NAME
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html">WeBWorK::ContentGenerator::Instructor::UserDetail</a> - Detailed User specific information
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 =cut
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 use strict;
<a name="l00027"></a>00027 use warnings;
<a name="l00028"></a>00028 <span class="preprocessor">#use CGI qw(-nosticky );</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00030"></a>00030 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(sortByName);
<a name="l00031"></a>00031 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 use constant DATE_FIELDS =&gt; {   open_date    =&gt; <span class="stringliteral">&quot; Open: &quot;</span>,
<a name="l00034"></a>00034                                 due_date     =&gt; <span class="stringliteral">&quot; Due&amp;nbsp;: &quot;</span>,
<a name="l00035"></a>00035                                 answer_date  =&gt; <span class="stringliteral">&quot; Ans&amp;nbsp;: &quot;</span>
<a name="l00036"></a>00036 };
<a name="l00037"></a>00037 use constant DATE_FIELDS_ORDER =&gt;[qw(open_date due_date answer_date )];
<a name="l00038"></a>00038 sub initialize {
<a name="l00039"></a>00039     my ($self) = @_;
<a name="l00040"></a>00040     my $r = $self-&gt;r;
<a name="l00041"></a>00041     my $urlpath = $r-&gt;urlpath;
<a name="l00042"></a>00042     my $db = $r-&gt;db;
<a name="l00043"></a>00043     my $authz = $r-&gt;authz;
<a name="l00044"></a>00044     my $userID = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00045"></a>00045     my $editForUserID = $urlpath-&gt;arg(<span class="stringliteral">&quot;userID&quot;</span>);
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     <span class="keywordflow">return</span> CGI::div({<span class="keyword">class </span>=&gt; &quot;ResultsWithError&quot;}, &quot;You are not authorized to edit user specific information.&quot;)
<a name="l00048"></a>00048         unless $authz-&gt;hasPermissions($userID, &quot;access_instructor_tools&quot;);
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="preprocessor">    # templates for getting field names</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>    my $userTemplate = $self-&gt;{userTemplate} = $db-&gt;newUser;
<a name="l00052"></a>00052     my $permissionLevelTemplate = $self-&gt;{permissionLevelTemplate} = $db-&gt;newPermissionLevel;
<a name="l00053"></a>00053     
<a name="l00054"></a>00054 <span class="preprocessor">    # first check to see if a save form has been submitted</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span> unless $r-&gt;param(<span class="stringliteral">&#39;save_button&#39;</span>);
<a name="l00056"></a>00056     
<a name="l00057"></a>00057 <span class="preprocessor">    # As it stands we need to check each set to see if it is still assigned </span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">    # the forms are not currently set up to simply transmit changes</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>    
<a name="l00060"></a>00060 <span class="preprocessor">    #Get the list of sets and the global set records</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">    # DBFIXME shouldn&#39;t need set IDs to get records</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>    my @setIDs = $db-&gt;listGlobalSets;
<a name="l00063"></a>00063     my @setRecords = grep { defined $_ } $db-&gt;getGlobalSets(@setIDs);
<a name="l00064"></a>00064     
<a name="l00065"></a>00065     my @assignedSets = ();
<a name="l00066"></a>00066     <span class="keywordflow">foreach</span> my $setID (@setIDs) {
<a name="l00067"></a>00067         push @assignedSets, $setID <span class="keywordflow">if</span> defined($r-&gt;param(<span class="stringliteral">&quot;set.$setID.assignment&quot;</span>));
<a name="l00068"></a>00068     }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 <span class="preprocessor">    # note: assignedSets are those sets that are assigned in the submitted form</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;assignedSets&quot;</span>, join(<span class="stringliteral">&quot; &quot;</span>, @assignedSets));
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     my %selectedSets = map { $_ =&gt; 1 } @assignedSets;
<a name="l00074"></a>00074 
<a name="l00075"></a>00075 <span class="preprocessor">    #debug ##########################</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">        #print STDERR (&quot;aSsigned sets&quot;, join(&quot; &quot;,@assignedSets));</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">        #my @params = $r-&gt;param();</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">        #print STDERR &quot; parameters &quot;, join(&quot; &quot;, @params);</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">    ###############</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 <span class="preprocessor">    #Get the user(s) whose records are to be modified</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">    #  for now: $editForUserID</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span><span class="preprocessor">    # check the user exists?  Is this necessary?</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span>    my $editUserRecord = $db-&gt;getUser($editForUserID);
<a name="l00085"></a>00085     die <span class="stringliteral">&quot;record not found for $editForUserID.\n&quot;</span> unless $editUserRecord;
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">    #Perform the desired assignments or deletions</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span>    my %userSets = map { $_ =&gt; 1 } $db-&gt;listUserSets($editForUserID);
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="preprocessor">    # go through each possible set</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot; parameters &quot;</span>, join(<span class="stringliteral">&quot; &quot;</span>, $r-&gt;param()) );
<a name="l00092"></a>00092     <span class="keywordflow">foreach</span> my $setRecord (@setRecords) {
<a name="l00093"></a>00093         my $setID = $setRecord-&gt;set_id;
<a name="l00094"></a>00094 <span class="preprocessor">        # does the user want it to be assigned to the selected user</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (exists $selectedSets{$setID}) {
<a name="l00096"></a>00096 <span class="preprocessor">            # change by glarose, 2007/02/07: only assign set if the </span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="preprocessor">            # user doesn&#39;t already have the set assigned.</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>            $self-&gt;assignSetToUser($editForUserID, $setRecord) <span class="keywordflow">if</span> ( ! $userSets{$setID} );
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 <span class="preprocessor">            #override dates</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span>            my $userSetRecord = $db-&gt;getUserSet($editForUserID, $setID);
<a name="l00102"></a>00102 <span class="preprocessor">            # get the dates</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="preprocessor">            #do checks to see if new dates meet criteria</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>            my $rh_dates = $self-&gt;checkDates($setRecord,$setID);
<a name="l00105"></a>00105             unless  ( $rh_dates-&gt;{error} ) { #returns 1 <span class="keywordflow">if</span> error
<a name="l00106"></a>00106 <span class="preprocessor">                # if no error update database</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>                <span class="keywordflow">foreach</span> my $field (keys %{DATE_FIELDS()}) {
<a name="l00108"></a>00108                     <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field.override&quot;</span>)) {
<a name="l00109"></a>00109                         $userSetRecord-&gt;$field($rh_dates-&gt;{$field});
<a name="l00110"></a>00110                     } <span class="keywordflow">else</span> {
<a name="l00111"></a>00111                         $userSetRecord-&gt;$field(undef); #stop <span class="keyword">override</span>
<a name="l00112"></a>00112                     }
<a name="l00113"></a>00113                 }
<a name="l00114"></a>00114                 $db-&gt;putUserSet($userSetRecord);
<a name="l00115"></a>00115             }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="preprocessor">            # if the set is a gateway set, also check to see if we&#39;re</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span><span class="preprocessor">            #    resetting the dates for any of the assigned set versions</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $setRecord-&gt;assignment_type =~ /gateway/ ) {
<a name="l00120"></a>00120                 my @setVer = $db-&gt;listSetVersions( $editForUserID,
<a name="l00121"></a>00121                                    $setID );
<a name="l00122"></a>00122                 <span class="keywordflow">foreach</span> my $ver ( @setVer ) {
<a name="l00123"></a>00123                     my $setVersionRecord =
<a name="l00124"></a>00124                         $db-&gt;getSetVersion( $editForUserID,
<a name="l00125"></a>00125                                     $setID, $ver );
<a name="l00126"></a>00126                     my $rh_dates = $self-&gt;checkDates($setVersionRecord,
<a name="l00127"></a>00127                                      <span class="stringliteral">&quot;$setID,v$ver&quot;</span>);
<a name="l00128"></a>00128                     unless ( $rh_dates-&gt;{error} ) {
<a name="l00129"></a>00129                         <span class="keywordflow">foreach</span> my $field ( keys %{DATE_FIELDS()} ) {
<a name="l00130"></a>00130                             <span class="keywordflow">if</span> ( defined( $r-&gt;param(<span class="stringliteral">&quot;set.$setID,v$ver.$field.override&quot;</span>) ) ) {
<a name="l00131"></a>00131                                 $setVersionRecord-&gt;$field($rh_dates-&gt;{$field});
<a name="l00132"></a>00132                             } <span class="keywordflow">else</span> {
<a name="l00133"></a>00133                                 $setVersionRecord-&gt;$field(undef);
<a name="l00134"></a>00134                             }
<a name="l00135"></a>00135                         }
<a name="l00136"></a>00136                         $db-&gt;putSetVersion( $setVersionRecord );
<a name="l00137"></a>00137                     }
<a name="l00138"></a>00138                 }
<a name="l00139"></a>00139             }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         } <span class="keywordflow">else</span> {
<a name="l00142"></a>00142 <span class="preprocessor">            # user asked to NOT have the set assigned to the selected user</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span><span class="preprocessor">            # debug(&quot;deleteUserSet($editForUserID, $setID)&quot;);</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span><span class="preprocessor">            # change by glarose, 2007/02/07: only do delete if user</span>
<a name="l00145"></a>00145 <span class="preprocessor"></span><span class="preprocessor">            # had the set previously assigned</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span>            $db-&gt;deleteUserSet($editForUserID, $setID) <span class="keywordflow">if</span> ( $userSets{$setID} );
<a name="l00147"></a>00147 <span class="preprocessor">            # debug(&quot;done deleteUserSet($editForUserID, $setID)&quot;);</span>
<a name="l00148"></a>00148 <span class="preprocessor"></span>        }
<a name="l00149"></a>00149     }
<a name="l00150"></a>00150     
<a name="l00151"></a>00151     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00152"></a>00152     
<a name="l00153"></a>00153     
<a name="l00154"></a>00154     
<a name="l00155"></a>00155 }
<a name="l00156"></a>00156 
<a name="l00157"></a>00157 sub body {
<a name="l00158"></a>00158     my ($self) = @_;
<a name="l00159"></a>00159     my $r = $self-&gt;r;
<a name="l00160"></a>00160     my $urlpath = $r-&gt;urlpath;
<a name="l00161"></a>00161     my $db = $r-&gt;db;
<a name="l00162"></a>00162     my $ce = $r-&gt;ce;
<a name="l00163"></a>00163     my $authz = $r-&gt;authz;
<a name="l00164"></a>00164     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00165"></a>00165     my $editForUserID = $urlpath-&gt;arg(<span class="stringliteral">&quot;userID&quot;</span>);
<a name="l00166"></a>00166     my $userID = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00167"></a>00167     
<a name="l00168"></a>00168     my @editForSets = $r-&gt;param(<span class="stringliteral">&quot;editForSets&quot;</span>);
<a name="l00169"></a>00169     
<a name="l00170"></a>00170     <span class="keywordflow">return</span> CGI::div({<span class="keyword">class </span>=&gt; &quot;ResultsWithError&quot;}, &quot;You are not authorized to edit user specific information.&quot;)
<a name="l00171"></a>00171         unless $authz-&gt;hasPermissions($userID, &quot;access_instructor_tools&quot;);
<a name="l00172"></a>00172     
<a name="l00173"></a>00173     my $UserRecord = $db-&gt;getUser($editForUserID);
<a name="l00174"></a>00174     my $PermissionRecord = $db-&gt;getPermissionLevel($editForUserID);
<a name="l00175"></a>00175     my @UserSetIDs = $db-&gt;listUserSets($editForUserID);
<a name="l00176"></a>00176     
<a name="l00177"></a>00177     my $userName = $UserRecord-&gt;first_name . <span class="stringliteral">&quot; &quot;</span> . $UserRecord-&gt;last_name;
<a name="l00178"></a>00178 
<a name="l00179"></a>00179 <span class="preprocessor">    # templates for getting field names</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span>    my $userTemplate = $self-&gt;{userTemplate};
<a name="l00181"></a>00181     my $permissionLevelTemplate = $self-&gt;{permissionLevelTemplate};
<a name="l00182"></a>00182     
<a name="l00183"></a>00183 <span class="preprocessor">    # This table can be consulted when display-ready forms of field names are needed.</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>    my %prettyFieldNames = map { $_ =&gt; $_ } 
<a name="l00185"></a>00185         $userTemplate-&gt;FIELDS();
<a name="l00186"></a>00186     
<a name="l00187"></a>00187 <span class="preprocessor">#   @prettyFieldNames{qw(</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span><span class="preprocessor">#       #user_id</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span><span class="preprocessor">#       first_name</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="preprocessor">#       last_name</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor">#       email_address</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span><span class="preprocessor">#       student_id</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span><span class="preprocessor">#       status</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span><span class="preprocessor">#       section</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span><span class="preprocessor">#       recitation</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span><span class="preprocessor">#       comment</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span><span class="preprocessor">#       permission</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span><span class="preprocessor">#   )} = (</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span><span class="preprocessor">#       #&quot;Login Name&quot;,</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span><span class="preprocessor">#       &quot;First Name&quot;,</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span><span class="preprocessor">#       &quot;Last Name&quot;,</span>
<a name="l00202"></a>00202 <span class="preprocessor"></span><span class="preprocessor">#       &quot;Email&quot;,</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span><span class="preprocessor">#       &quot;Student ID&quot;,</span>
<a name="l00204"></a>00204 <span class="preprocessor"></span><span class="preprocessor">#       &quot;Status&quot;,</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span><span class="preprocessor">#       &quot;Section&quot;,</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span><span class="preprocessor">#       &quot;Recitation&quot;,</span>
<a name="l00207"></a>00207 <span class="preprocessor"></span><span class="preprocessor">#       &quot;Comment&quot;,</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span><span class="preprocessor">#       &quot;Permission Level&quot;,</span>
<a name="l00209"></a>00209 <span class="preprocessor"></span><span class="preprocessor">#   );</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span>    
<a name="l00211"></a>00211     my @dateFields         = @{DATE_FIELDS_ORDER()};
<a name="l00212"></a>00212     my $rh_dateFieldLabels =  DATE_FIELDS();
<a name="l00213"></a>00213 
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="preprocessor">    # create a link to the SetsAssignedToUser page</span>
<a name="l00216"></a>00216 <span class="preprocessor"></span><span class="preprocessor">#   my $editSetsPath = $urlpath-&gt;newFromModule(</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span><span class="preprocessor">#       &quot;WeBWorK::ContentGenerator::Instructor::SetsAssignedToUser&quot;, $r, </span>
<a name="l00218"></a>00218 <span class="preprocessor"></span><span class="preprocessor">#       courseID =&gt; $courseID,</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span><span class="preprocessor">#       userID =&gt; $userID,</span>
<a name="l00220"></a>00220 <span class="preprocessor"></span><span class="preprocessor">#   );</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span><span class="preprocessor">#   my $editSetsAssignedToUserURL = $self-&gt;systemLink($editSetsPath);</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>    
<a name="l00223"></a>00223 <span class="preprocessor">    # create a message about how many sets have been assigned to this user</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span>    my $setCount = $db-&gt;countUserSets($editForUserID);
<a name="l00225"></a>00225 <span class="preprocessor">#   my $userCountMessage =  CGI::a({href=&gt;$editSetsAssignedToUserURL}, $setCount . &quot; sets.&quot;);</span>
<a name="l00226"></a>00226 <span class="preprocessor"></span><span class="preprocessor">#   $userCountMessage = &quot;The user &quot; . CGI::b($userName . &quot; ($editForUserID)&quot;) . &quot; has been assigned &quot; . $userCountMessage;</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span>    my $basicInfoPage = $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;instructor_user_list&#39;</span>,
<a name="l00228"></a>00228                     args =&gt;{
<a name="l00229"></a>00229                         courseID =&gt; $courseID,
<a name="l00230"></a>00230                     }
<a name="l00231"></a>00231         );
<a name="l00232"></a>00232         my $basicInfoUrl = $self-&gt;systemLink($basicInfoPage,
<a name="l00233"></a>00233                                              params =&gt;{visible_users =&gt; $editForUserID,
<a name="l00234"></a>00234                                                        editMode      =&gt; 1,
<a name="l00235"></a>00235                                                       }
<a name="l00236"></a>00236         );
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     print CGI::h4({align=&gt;<span class="stringliteral">&#39;center&#39;</span>},<span class="stringliteral">&quot;Edit &quot;</span>,CGI::a({href=&gt;$basicInfoUrl},<span class="stringliteral">&#39;class list data&#39;</span>),<span class="stringliteral">&quot; for  $userName ($editForUserID) who has been assigned $setCount sets.&quot;</span>);
<a name="l00239"></a>00239     
<a name="l00240"></a>00240 <span class="preprocessor">    #print CGI::h4(&quot;User Data&quot;);</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::start_table({ align=&gt;&#39;center&#39;, border=&gt;1,cellpadding=&gt;5});</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span><span class="preprocessor">#       CGI::th(CGI::checkbox({ type =&gt; &#39;checkbox&#39;,</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span><span class="preprocessor">#                               name =&gt; &quot;edit.basic.info&quot;,</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span><span class="preprocessor">#                               label =&gt; &#39;&#39;,</span>
<a name="l00246"></a>00246 <span class="preprocessor"></span><span class="preprocessor">#                               checked =&gt; 0</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span><span class="preprocessor">#         }),&quot;Edit class list data for $editForUserID&quot;),</span>
<a name="l00248"></a>00248 <span class="preprocessor"></span><span class="preprocessor">#         CGI::th(CGI::checkbox({ type =&gt; &#39;checkbox&#39;,</span>
<a name="l00249"></a>00249 <span class="preprocessor"></span><span class="preprocessor">#                               name =&gt; &quot;change.password&quot;,</span>
<a name="l00250"></a>00250 <span class="preprocessor"></span><span class="preprocessor">#                               label =&gt; &#39;&#39;,</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span><span class="preprocessor">#                               checked =&gt; 0</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span><span class="preprocessor">#         }),&quot;Change Password for $editForUserID&quot;));</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span><span class="preprocessor">#         </span>
<a name="l00254"></a>00254 <span class="preprocessor"></span><span class="preprocessor">#   print &quot;&lt;tr&gt;&lt;td rowspan=\&quot;2\&quot;&gt;&quot;;</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span><span class="preprocessor">#   ########################################</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span><span class="preprocessor">#   # Basic student data</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">#   ########################################</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::start_table();</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="preprocessor">#   foreach ($userTemplate-&gt;FIELDS()) {</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span><span class="preprocessor">#       next if $_ eq &#39;user_id&#39;;   # don&#39;t print login name</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span><span class="preprocessor">#       print CGI::Tr(</span>
<a name="l00262"></a>00262 <span class="preprocessor"></span><span class="preprocessor">#           CGI::td([</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span><span class="preprocessor">#                   $prettyFieldNames{$_}, </span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $UserRecord-&gt;$_, -size =&gt; 25 })</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor">#           ])</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span><span class="preprocessor">#       );</span>
<a name="l00267"></a>00267 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00268"></a>00268 <span class="preprocessor"></span><span class="preprocessor">#   foreach ($permissionLevelTemplate-&gt;FIELDS()) {</span>
<a name="l00269"></a>00269 <span class="preprocessor"></span><span class="preprocessor">#       print CGI::Tr(</span>
<a name="l00270"></a>00270 <span class="preprocessor"></span><span class="preprocessor">#           CGI::td([</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span><span class="preprocessor">#                   $prettyFieldNames{$_}, </span>
<a name="l00272"></a>00272 <span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $PermissionRecord-&gt;$_, -size =&gt; 25 })</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span><span class="preprocessor">#           ])</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span><span class="preprocessor">#       );</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::end_table();</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l00278"></a>00278 <span class="preprocessor"></span><span class="preprocessor">#   #print CGI::br();</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span><span class="preprocessor">#   print &quot;&lt;/td&gt;&lt;td valign=\&quot;top\&quot;&gt;&quot;;</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span><span class="preprocessor">#   ########################################</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="preprocessor">#   # Change password section</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">#   ########################################</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span><span class="preprocessor">#   my $profRecord = $db-&gt;getUser($userID);</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span><span class="preprocessor">#   my $profName = $profRecord-&gt;first_name . &quot; &quot; . $profRecord-&gt;last_name;</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span><span class="preprocessor">#   my $poss = &quot;&#39;s &quot;;</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span><span class="preprocessor">#   my $pass = &quot; password &quot;;</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l00288"></a>00288 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::start_table();</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(CGI::td([&quot;&lt;b&gt;$profName&lt;/b&gt;$poss$pass&quot;, CGI::input({ -type =&gt; &quot;password&quot;, -name =&gt; &quot;$userID.password&quot;})]));</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(CGI::td([&quot;&lt;b&gt;$userName&lt;/b&gt;$poss new $pass&quot;, CGI::input({ -type =&gt; &quot;password&quot;, -name =&gt; &quot;$editForUserID.password.1&quot;})]));</span>
<a name="l00291"></a>00291 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(CGI::td([&quot;Confirm &lt;b&gt;$userName&lt;/b&gt;$poss new $pass&quot;, CGI::input({ -type =&gt; &quot;password&quot;, -name =&gt; &quot;$editForUserID.password.2&quot;})]));</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::end_table();</span>
<a name="l00293"></a>00293 <span class="preprocessor"></span><span class="preprocessor">#   print &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(CGI::th(  #FIXME  enable this once it can be handled</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span><span class="preprocessor"># #         CGI::checkbox({ type =&gt; &#39;checkbox&#39;,</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span><span class="preprocessor"># #                                 name =&gt; &quot;change.login&quot;,</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span><span class="preprocessor"># #                                 label =&gt; &#39;&#39;,</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span><span class="preprocessor"># #                                 checked =&gt; 0</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span><span class="preprocessor"># #         }),</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span><span class="preprocessor">#         &quot;Change login name $editForUserID to &quot;, CGI::input({-name=&gt;&#39;new_login&#39;, -value=&gt;&#39;&#39;  ,-size=&gt;25})</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span><span class="preprocessor">#   ));</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::end_table();</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span>    
<a name="l00304"></a>00304     print CGI::br();
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 <span class="preprocessor">    #print CGI::h4(&quot;Sets assigned to $userName&quot;);</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span><span class="preprocessor">    # construct url for the form</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span>    my $userDetailPage = $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;instructor_user_detail&#39;</span>,
<a name="l00309"></a>00309                                            args =&gt;{
<a name="l00310"></a>00310                                                      courseID =&gt; $courseID,
<a name="l00311"></a>00311                                                      userID   =&gt; $editForUserID, #FIXME eventually <span class="keyword">this</span> should be a list??
<a name="l00312"></a>00312                     }
<a name="l00313"></a>00313     );
<a name="l00314"></a>00314     my $userDetailUrl = $self-&gt;systemLink($userDetailPage,authen=&gt;0);
<a name="l00315"></a>00315 
<a name="l00316"></a>00316 <span class="preprocessor">    # DBFIXME all we need here is set IDs</span>
<a name="l00317"></a>00317 <span class="preprocessor"></span><span class="preprocessor">    # DBFIXME do sorting in DB</span>
<a name="l00318"></a>00318 <span class="preprocessor"></span>    my %GlobalSetRecords = map { $_-&gt;set_id =&gt; $_ } $db-&gt;getGlobalSets($db-&gt;listGlobalSets());
<a name="l00319"></a>00319     my @UserSetRefs = map { [$editForUserID, $_] } sortByName(undef, @UserSetIDs);
<a name="l00320"></a>00320     my %UserSetRecords = map { $_-&gt;set_id =&gt; $_ } $db-&gt;getUserSets(@UserSetRefs);
<a name="l00321"></a>00321     my @MergedSetRefs = map { [$editForUserID, $_] } sortByName(undef, @UserSetIDs);
<a name="l00322"></a>00322     my %MergedSetRecords = map { $_-&gt;set_id =&gt; $_ } $db-&gt;getMergedSets(@MergedSetRefs);
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="preprocessor">    # get set versions of versioned sets</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span>    my %UserSetVersionRecords;
<a name="l00326"></a>00326     my %UserSetMergedVersionRecords;
<a name="l00327"></a>00327     <span class="keywordflow">foreach</span> my $setid ( keys( %UserSetRecords ) ) {
<a name="l00328"></a>00328         <span class="keywordflow">if</span> ( $GlobalSetRecords{$setid}-&gt;assignment_type =~ /gateway/ ) {
<a name="l00329"></a>00329             my @setVersionRefs = map { [$editForUserID, $setid, $_] }
<a name="l00330"></a>00330                 $db-&gt;listSetVersions( $editForUserID, $setid );
<a name="l00331"></a>00331             <span class="keywordflow">if</span> ( @setVersionRefs ) {
<a name="l00332"></a>00332                 $UserSetVersionRecords{$setid} = [ $db-&gt;getSetVersions(@setVersionRefs) ];
<a name="l00333"></a>00333                 $UserSetMergedVersionRecords{$setid} = [ $db-&gt;getMergedSetVersions(@setVersionRefs) ];
<a name="l00334"></a>00334             }
<a name="l00335"></a>00335         }
<a name="l00336"></a>00336     }
<a name="l00337"></a>00337     
<a name="l00338"></a>00338 <span class="preprocessor">    ########################################</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span><span class="preprocessor">    # Print warning</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span><span class="preprocessor">    ########################################</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span>    print CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},
<a name="l00342"></a>00342                <span class="stringliteral">&quot;Do not uncheck a set unless you know what you are doing.&quot;</span>, CGI::br(),
<a name="l00343"></a>00343                <span class="stringliteral">&quot;There is NO undo for unassigning a set.&quot;</span>);
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     print CGI::p(<span class="stringliteral">&quot;To change status (scores or grades) for this student for one</span>
<a name="l00346"></a>00346 <span class="stringliteral">                  set, click on the individual set link.&quot;</span>);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348     print CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},<span class="stringliteral">&quot;When you uncheck a homework set (and save the changes), you destroy all</span>
<a name="l00349"></a>00349 <span class="stringliteral">              of the data for that set for this student.   If you</span>
<a name="l00350"></a>00350 <span class="stringliteral">              reassign the set, the student will receive a new version of each problem.</span>
<a name="l00351"></a>00351 <span class="stringliteral">              Make sure this is what you want to do before unchecking sets.&quot;</span>
<a name="l00352"></a>00352     );
<a name="l00353"></a>00353 <span class="preprocessor">    ########################################</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span><span class="preprocessor">    # Assigned sets form</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span><span class="preprocessor">    ########################################</span>
<a name="l00356"></a>00356 <span class="preprocessor"></span>
<a name="l00357"></a>00357     print CGI::start_form( {method=&gt;<span class="stringliteral">&#39;post&#39;</span>,action=&gt;$userDetailUrl, name=&gt;<span class="stringliteral">&#39;UserDetail&#39;</span>}),<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00358"></a>00358     print $self-&gt;hidden_authen_fields();
<a name="l00359"></a>00359     print CGI::p(CGI::submit(-name=&gt;<span class="stringliteral">&#39;save_button&#39;</span>,-label=&gt;<span class="stringliteral">&#39;Save changes&#39;</span>,));
<a name="l00360"></a>00360     
<a name="l00361"></a>00361     print CGI::start_table({ border=&gt; 1,cellpadding=&gt;5}),<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00362"></a>00362     print CGI::Tr(
<a name="l00363"></a>00363         CGI::th({align=&gt;<span class="stringliteral">&#39;center&#39;</span>,colspan=&gt;3}, <span class="stringliteral">&quot;Sets assigned to $userName ($editForUserID)&quot;</span>)
<a name="l00364"></a>00364     ),<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00365"></a>00365     print CGI::Tr(
<a name="l00366"></a>00366         CGI::th({ -align =&gt; <span class="stringliteral">&quot;center&quot;</span>}, [
<a name="l00367"></a>00367             <span class="stringliteral">&quot;Assigned&quot;</span>,
<a name="l00368"></a>00368             <span class="stringliteral">&quot;Edit set for $editForUserID&quot;</span>,
<a name="l00369"></a>00369             <span class="stringliteral">&quot;Dates&quot;</span>,
<a name="l00370"></a>00370         ])
<a name="l00371"></a>00371     ),<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373 <span class="preprocessor">    # get a list of sets to show</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span><span class="preprocessor">    # DBFIXME already have this data</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span>    my @setsToShow = sortByName( undef, $db-&gt;listGlobalSets() );
<a name="l00376"></a>00376 <span class="preprocessor">    # insert any set versions that we have</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span>    my $i = $#setsToShow;
<a name="l00378"></a>00378     <span class="keywordflow">if</span> ( defined( $UserSetVersionRecords{$setsToShow[$i]} ) ) {
<a name="l00379"></a>00379         push( @setsToShow, map{ $_-&gt;set_id . <span class="stringliteral">&quot;,v&quot;</span> . $_-&gt;version_id }
<a name="l00380"></a>00380             @{$UserSetVersionRecords{$setsToShow[$i]}} );
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382     $i--;
<a name="l00383"></a>00383     my $numit = 0;
<a name="l00384"></a>00384     <span class="keywordflow">while</span> ( $i&gt;=0 ) {
<a name="l00385"></a>00385         <span class="keywordflow">if</span> ( defined( $UserSetVersionRecords{$setsToShow[$i]} ) ) {
<a name="l00386"></a>00386             splice( @setsToShow, $i+1, 0,
<a name="l00387"></a>00387                 map{ $_-&gt;set_id . <span class="stringliteral">&quot;,v&quot;</span> . $_-&gt;version_id }
<a name="l00388"></a>00388                 @{$UserSetVersionRecords{$setsToShow[$i]}} );
<a name="l00389"></a>00389         }
<a name="l00390"></a>00390         $i--;
<a name="l00391"></a>00391         $numit++;
<a name="l00392"></a>00392 <span class="preprocessor">        # just to be safe</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span>        last <span class="keywordflow">if</span> $numit &gt;= 150;
<a name="l00394"></a>00394     }
<a name="l00395"></a>00395     warn(<span class="stringliteral">&quot;Truncated display of sets at 150 in UserDetail.pm.  This is a &quot;</span> .
<a name="l00396"></a>00396          <span class="stringliteral">&quot;brake to avoid spiraling into the abyss.  If you really have &quot;</span> .
<a name="l00397"></a>00397          <span class="stringliteral">&quot;more than 150 sets in your course, reset the limit at about line &quot;</span> .
<a name="l00398"></a>00398          <span class="stringliteral">&quot;370 in webwork/lib/WeBWorK/ContentGenerator/Instructor/UserDetail.pm.&quot;</span>)
<a name="l00399"></a>00399         if ( $numit == 150 );
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 
<a name="l00402"></a>00402     foreach my $setID ( @setsToShow ) {
<a name="l00403"></a>00403 <span class="preprocessor">        # catch the versioned sets that we just added</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span>        my $setVersion = 0;
<a name="l00405"></a>00405         my $fullSetID = $setID;
<a name="l00406"></a>00406         <span class="keywordflow">if</span> ( $setID =~ /,v(\d+)$/ ) {
<a name="l00407"></a>00407             $setVersion = $1;
<a name="l00408"></a>00408             $setID =~ s/,v\d+$<span class="comment">//;</span>
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         my $GlobalSetRecord = $GlobalSetRecords{$setID};
<a name="l00412"></a>00412         my $UserSetRecord = (! $setVersion) ? $UserSetRecords{$setID} :
<a name="l00413"></a>00413             $UserSetVersionRecords{$setID}-&gt;[$setVersion-1];
<a name="l00414"></a>00414         my $MergedSetRecord = (! $setVersion) ?  $MergedSetRecords{$setID} :
<a name="l00415"></a>00415             $UserSetMergedVersionRecords{$setID}-&gt;[$setVersion-1];
<a name="l00416"></a>00416         my $setListPage = $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;instructor_set_detail&#39;</span>,
<a name="l00417"></a>00417                     args =&gt;{
<a name="l00418"></a>00418                         courseID =&gt; $courseID,
<a name="l00419"></a>00419                         setID    =&gt; $fullSetID
<a name="l00420"></a>00420                     }
<a name="l00421"></a>00421         );
<a name="l00422"></a>00422         my $url = $self-&gt;systemLink($setListPage,
<a name="l00423"></a>00423                               params =&gt;{effectiveUser =&gt; $editForUserID,
<a name="l00424"></a>00424                                         editForUser   =&gt; $editForUserID,
<a name="l00425"></a>00425         });
<a name="l00426"></a>00426 
<a name="l00427"></a>00427         my $setName = ( $setVersion ) ? <span class="stringliteral">&quot;test $setVersion&quot;</span> : $setID;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429         print CGI::Tr(
<a name="l00430"></a>00430             CGI::td({ -align =&gt; <span class="stringliteral">&quot;center&quot;</span> }, [
<a name="l00431"></a>00431                 ($setVersion) ? <span class="stringliteral">&quot;&quot;</span> : CGI::checkbox({ type =&gt; <span class="stringliteral">&#39;checkbox&#39;</span>,
<a name="l00432"></a>00432                                 name =&gt; <span class="stringliteral">&quot;set.$fullSetID.assignment&quot;</span>,
<a name="l00433"></a>00433                                 label =&gt; <span class="stringliteral">&#39;&#39;</span>,
<a name="l00434"></a>00434                                 value =&gt; <span class="stringliteral">&#39;assigned&#39;</span>,
<a name="l00435"></a>00435                                 checked =&gt; (defined $MergedSetRecord)}),
<a name="l00436"></a>00436                 defined($MergedSetRecord) ? CGI::b(CGI::a({href=&gt;$url},$setName, ) ) : CGI::b($setID, ),
<a name="l00437"></a>00437                 join <span class="stringliteral">&quot;\n&quot;</span>, $self-&gt;DBFieldTable($GlobalSetRecord, $UserSetRecord, $MergedSetRecord, <span class="stringliteral">&quot;set&quot;</span>, $setID, \@dateFields, $rh_dateFieldLabels),
<a name="l00438"></a>00438             ])
<a name="l00439"></a>00439         ),<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441     print CGI::end_table(),<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00442"></a>00442     print CGI::p(CGI::submit(-name=&gt;<span class="stringliteral">&#39;save_button&#39;</span>,-label=&gt;<span class="stringliteral">&#39;Save changes&#39;</span>,));
<a name="l00443"></a>00443     print CGI::end_form(),<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00444"></a>00444 <span class="preprocessor">    ########################################</span>
<a name="l00445"></a>00445 <span class="preprocessor"></span><span class="preprocessor">    # Print warning</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span><span class="preprocessor">    ########################################</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span>
<a name="l00448"></a>00448     CGI::div( {<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},
<a name="l00449"></a>00449                 <span class="stringliteral">&quot;There is NO undo for this function.  </span>
<a name="l00450"></a>00450 <span class="stringliteral">                 Do not use it unless you know what you are doing!  When you unassign</span>
<a name="l00451"></a>00451 <span class="stringliteral">                 sets using this button, or by unchecking their set names, you destroy all</span>
<a name="l00452"></a>00452 <span class="stringliteral">                 of the data for those sets for this student.&quot;</span>
<a name="l00453"></a>00453     );
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 <span class="preprocessor">#   print CGI::start_table();</span>
<a name="l00457"></a>00457 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(</span>
<a name="l00458"></a>00458 <span class="preprocessor"></span><span class="preprocessor">#       CGI::th({ -align =&gt; &quot;center&quot;},[</span>
<a name="l00459"></a>00459 <span class="preprocessor"></span><span class="preprocessor">#           &quot;Assigned&quot;,</span>
<a name="l00460"></a>00460 <span class="preprocessor"></span><span class="preprocessor">#           &quot;Set Name&quot;,</span>
<a name="l00461"></a>00461 <span class="preprocessor"></span><span class="preprocessor">#           &quot;Opens&quot;,</span>
<a name="l00462"></a>00462 <span class="preprocessor"></span><span class="preprocessor">#           &quot;Answers Due&quot;,</span>
<a name="l00463"></a>00463 <span class="preprocessor"></span><span class="preprocessor">#           &quot;Answers Available&quot;,</span>
<a name="l00464"></a>00464 <span class="preprocessor"></span><span class="preprocessor">#       ])</span>
<a name="l00465"></a>00465 <span class="preprocessor"></span><span class="preprocessor">#   );</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span>                
<a name="l00467"></a>00467 <span class="preprocessor">#   foreach my $setID (sortByName(undef, @UserSetIDs)) {</span>
<a name="l00468"></a>00468 <span class="preprocessor"></span><span class="preprocessor">#       my $MergedSetRecord = $MergedSetRecords{$setID};</span>
<a name="l00469"></a>00469 <span class="preprocessor"></span><span class="preprocessor">#       print CGI::Tr(</span>
<a name="l00470"></a>00470 <span class="preprocessor"></span><span class="preprocessor">#           CGI::td({ -align =&gt; &quot;center&quot; }, [</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span><span class="preprocessor">#               CGI::checkbox({checked =&gt; (defined $MergedSetRecord)}),</span>
<a name="l00472"></a>00472 <span class="preprocessor"></span><span class="preprocessor">#               $setID,</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span><span class="preprocessor">#               CGI::checkbox() .</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $self-&gt;formatDateTime($MergedSetRecord-&gt;open_date), -size =&gt; 25}),</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span><span class="preprocessor">#               CGI::checkbox() .</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $self-&gt;formatDateTime($MergedSetRecord-&gt;due_date), -size =&gt; 25}),</span>
<a name="l00477"></a>00477 <span class="preprocessor"></span><span class="preprocessor">#               CGI::checkbox() .</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $self-&gt;formatDateTime($MergedSetRecord-&gt;answer_date), -size =&gt; 25}),</span>
<a name="l00479"></a>00479 <span class="preprocessor"></span><span class="preprocessor">#           ])</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span><span class="preprocessor">#       );</span>
<a name="l00481"></a>00481 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a>00485 sub checkDates { 
<a name="l00486"></a>00486     my $self         = shift;
<a name="l00487"></a>00487     my $setRecord    = shift;
<a name="l00488"></a>00488     my $setID        = shift;
<a name="l00489"></a>00489     my $r            = $self-&gt;r;
<a name="l00490"></a>00490     my %dates = ();
<a name="l00491"></a>00491     my $error_undefined_override = 0;
<a name="l00492"></a>00492     my $numerical_date=0;
<a name="l00493"></a>00493     my $error        = 0;
<a name="l00494"></a>00494     <span class="keywordflow">foreach</span> my $field (@{DATE_FIELDS_ORDER()}) {  # check that <span class="keyword">override</span> dates can be parsed and are not blank
<a name="l00495"></a>00495         $dates{$field} = $setRecord-&gt;$field;
<a name="l00496"></a>00496         <span class="keywordflow">if</span> (defined  $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field.override&quot;</span>) ){
<a name="l00497"></a>00497             eval{ $numerical_date = $self-&gt;parseDateTime($r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field&quot;</span>))};
<a name="l00498"></a>00498             unless( $@  ) {
<a name="l00499"></a>00499                     $dates{$field}=$numerical_date;
<a name="l00500"></a>00500             } <span class="keywordflow">else</span> {
<a name="l00501"></a>00501                     $self-&gt;addbadmessage(<span class="stringliteral">&quot;&amp;nbsp;&amp;nbsp;* Badly defined time for set $setID $field. No date changes made:&lt;br/&gt;$@&quot;</span>);
<a name="l00502"></a>00502                     $error = 1;
<a name="l00503"></a>00503             }
<a name="l00504"></a>00504         }
<a name="l00505"></a>00505             
<a name="l00506"></a>00506 
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508     <span class="keywordflow">return</span> {%dates,error=&gt;1} <span class="keywordflow">if</span> $error;    # no point in going on <span class="keywordflow">if</span> the dates can<span class="stringliteral">&#39;t be parsed.</span>
<a name="l00509"></a>00509 <span class="stringliteral">    </span>
<a name="l00510"></a>00510 <span class="stringliteral">    my ($open_date, $due_date, $answer_date) = map { $dates{$_} } @{DATE_FIELDS_ORDER()};</span>
<a name="l00511"></a>00511 <span class="stringliteral"></span>
<a name="l00512"></a>00512 <span class="stringliteral">    unless ($answer_date &amp;&amp; $due_date &amp;&amp; $open_date) {</span>
<a name="l00513"></a>00513 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;set $setID has errors in its dates: answer_date |$answer_date|, </span>
<a name="l00514"></a>00514 <span class="stringliteral">         due date |$due_date|, open_date |$open_date|&quot;);</span>
<a name="l00515"></a>00515 <span class="stringliteral">    }</span>
<a name="l00516"></a>00516 <span class="stringliteral">    if ($answer_date &lt; $due_date || $answer_date &lt; $open_date) {        </span>
<a name="l00517"></a>00517 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;Answers cannot be made available until on or after the due date in set $setID!&quot;);</span>
<a name="l00518"></a>00518 <span class="stringliteral">        $error = 1;</span>
<a name="l00519"></a>00519 <span class="stringliteral">    }</span>
<a name="l00520"></a>00520 <span class="stringliteral">    </span>
<a name="l00521"></a>00521 <span class="stringliteral">    if ($due_date &lt; $open_date) {</span>
<a name="l00522"></a>00522 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;Answers cannot be due until on or after the open date in set $setID!&quot;);</span>
<a name="l00523"></a>00523 <span class="stringliteral">        $error = 1;</span>
<a name="l00524"></a>00524 <span class="stringliteral">    }</span>
<a name="l00525"></a>00525 <span class="stringliteral">    </span>
<a name="l00526"></a>00526 <span class="stringliteral">    # make sure the dates are not more than 10 years in the future</span>
<a name="l00527"></a>00527 <span class="stringliteral">    my $curr_time = time;</span>
<a name="l00528"></a>00528 <span class="stringliteral">    my $seconds_per_year = 31_556_926;</span>
<a name="l00529"></a>00529 <span class="stringliteral">    my $cutoff = $curr_time + $seconds_per_year*10;</span>
<a name="l00530"></a>00530 <span class="stringliteral">    if ($open_date &gt; $cutoff) {</span>
<a name="l00531"></a>00531 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;Error: open date cannot be more than 10 years from now in set $setID&quot;);</span>
<a name="l00532"></a>00532 <span class="stringliteral">        $error = 1;</span>
<a name="l00533"></a>00533 <span class="stringliteral">    }</span>
<a name="l00534"></a>00534 <span class="stringliteral">    if ($due_date &gt; $cutoff) {</span>
<a name="l00535"></a>00535 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;Error: due date cannot be more than 10 years from now in set $setID&quot;);</span>
<a name="l00536"></a>00536 <span class="stringliteral">        $error = 1;</span>
<a name="l00537"></a>00537 <span class="stringliteral">    }</span>
<a name="l00538"></a>00538 <span class="stringliteral">    if ($answer_date &gt; $cutoff) {</span>
<a name="l00539"></a>00539 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;Error: answer date cannot be more than 10 years from now in set $setID&quot;);</span>
<a name="l00540"></a>00540 <span class="stringliteral">        $error = 1;</span>
<a name="l00541"></a>00541 <span class="stringliteral">    }</span>
<a name="l00542"></a>00542 <span class="stringliteral">    </span>
<a name="l00543"></a>00543 <span class="stringliteral">    </span>
<a name="l00544"></a>00544 <span class="stringliteral">    if ($error) {</span>
<a name="l00545"></a>00545 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;No date changes were saved!&quot;);</span>
<a name="l00546"></a>00546 <span class="stringliteral">    }</span>
<a name="l00547"></a>00547 <span class="stringliteral">    return {%dates,error=&gt;$error};</span>
<a name="l00548"></a>00548 <span class="stringliteral">}</span>
<a name="l00549"></a>00549 <span class="stringliteral"></span>
<a name="l00550"></a>00550 <span class="stringliteral">sub DBFieldTable {</span>
<a name="l00551"></a>00551 <span class="stringliteral">    my ($self, $GlobalRecord, $UserRecord, $MergedRecord, $recordType,</span>
<a name="l00552"></a>00552 <span class="stringliteral">        $recordID, $fieldsRef, $rh_fieldLabels) = @_;</span>
<a name="l00553"></a>00553 <span class="stringliteral">    </span>
<a name="l00554"></a>00554 <span class="stringliteral">    return CGI::div({class =&gt; &quot;ResultsWithError&quot;}, &quot;No record exists for $recordType $recordID&quot;) unless defined $GlobalRecord;</span>
<a name="l00555"></a>00555 <span class="stringliteral">    </span>
<a name="l00556"></a>00556 <span class="stringliteral">    # modify record name if we&#39;</span>re dealing with versioned sets
<a name="l00557"></a>00557     my $isVersioned = 0;
<a name="l00558"></a>00558     <span class="keywordflow">if</span> ( $recordType eq <span class="stringliteral">&quot;set&quot;</span> &amp;&amp; defined($MergedRecord) &amp;&amp;
<a name="l00559"></a>00559          $MergedRecord-&gt;assignment_type =~ /gateway/ &amp;&amp;
<a name="l00560"></a>00560          $MergedRecord-&gt;can( <span class="stringliteral">&quot;version_id&quot;</span> ) ) {
<a name="l00561"></a>00561         $recordID .= <span class="stringliteral">&quot;,v&quot;</span> . $MergedRecord-&gt;version_id;
<a name="l00562"></a>00562         $isVersioned = 1;
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     my $r = $self-&gt;r;
<a name="l00565"></a>00565     my @fields = @$fieldsRef;
<a name="l00566"></a>00566     my @results;
<a name="l00567"></a>00567     <span class="keywordflow">foreach</span> my $field (@fields) {
<a name="l00568"></a>00568         my $globalValue = $GlobalRecord-&gt;$field;
<a name="l00569"></a>00569         my $userValue = defined $UserRecord ? $UserRecord-&gt;$field : $globalValue;
<a name="l00570"></a>00570         my $mergedValue  = defined $MergedRecord ? $MergedRecord-&gt;$field : $globalValue;
<a name="l00571"></a>00571         push @results, 
<a name="l00572"></a>00572             [$rh_fieldLabels-&gt;{$field},
<a name="l00573"></a>00573              defined $UserRecord ? 
<a name="l00574"></a>00574                 CGI::checkbox({
<a name="l00575"></a>00575                     type =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>,
<a name="l00576"></a>00576                     name =&gt; <span class="stringliteral">&quot;$recordType.$recordID.$field.override&quot;</span>,
<a name="l00577"></a>00577                     label =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00578"></a>00578                     value =&gt; $field,
<a name="l00579"></a>00579                     checked =&gt; ($r-&gt;param(<span class="stringliteral">&quot;$recordType.$recordID.$field.override&quot;</span>) || $mergedValue ne $globalValue || $isVersioned) ? 1 : 0
<a name="l00580"></a>00580                 }) : <span class="stringliteral">&quot;&quot;</span>,
<a name="l00581"></a>00581                 defined $UserRecord ? 
<a name="l00582"></a>00582                     (CGI::input({ -name=&gt;<span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>,
<a name="l00583"></a>00583                                   -value =&gt; $userValue ? $self-&gt;formatDateTime($userValue) : <span class="stringliteral">&quot;&quot;</span>, 
<a name="l00584"></a>00584                                   -size =&gt; 25})
<a name="l00585"></a>00585                     ) : <span class="stringliteral">&quot;&quot;</span>,
<a name="l00586"></a>00586                 $self-&gt;<a class="code" href="classWeBWorK_1_1ContentGenerator.html#ae7de5945eb830c6b4ba2067fd70ca000">formatDateTime</a>($globalValue),                
<a name="l00587"></a>00587             ]
<a name="l00588"></a>00588             
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590 
<a name="l00591"></a>00591     my @table;
<a name="l00592"></a>00592     <span class="keywordflow">foreach</span> my $row (@results) {
<a name="l00593"></a>00593         push @table, CGI::Tr(CGI::td({-align =&gt; <span class="stringliteral">&quot;center&quot;</span>}, $row));
<a name="l00594"></a>00594     }
<a name="l00595"></a>00595     
<a name="l00596"></a>00596     <span class="keywordflow">return</span> (CGI::start_table({border =&gt; 0}), @table, CGI::end_table());
<a name="l00597"></a>00597 }
<a name="l00598"></a>00598 
<a name="l00599"></a>00599 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:35 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
