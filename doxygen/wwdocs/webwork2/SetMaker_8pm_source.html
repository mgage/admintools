<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: SetMaker.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>SetMaker.pm</h1><a href="SetMaker_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/Instructor/SetMaker.pm,v 1.85 2008/07/01 13:18:52 glarose Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="keyword">package </span>WeBWorK::ContentGenerator::Instructor::SetMaker;
<a name="l00019"></a>00019 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">WeBWorK::ContentGenerator::Instructor</a>);
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 =head1 NAME
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SetMaker.html">WeBWorK::ContentGenerator::Instructor::SetMaker</a> - Make homework sets.
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 =cut
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 use strict;
<a name="l00028"></a>00028 use warnings;
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#use CGI qw(-nosticky);</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00033"></a>00033 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00034"></a>00034 use <a class="code" href="classWeBWorK_1_1Form.html">WeBWorK::Form</a>;
<a name="l00035"></a>00035 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(readDirectory max sortByName);
<a name="l00036"></a>00036 use <a class="code" href="classWeBWorK_1_1Utils_1_1Tasks.html">WeBWorK::Utils::Tasks</a> qw(renderProblems);
<a name="l00037"></a>00037 use File::Find;
<a name="l00038"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SetMaker.html">00038</a> 
<a name="l00039"></a>00039 require <a class="code" href="classWeBWorK_1_1Utils_1_1ListingDB.html">WeBWorK::Utils::ListingDB</a>;
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 use constant SHOW_HINTS_DEFAULT =&gt; 0;
<a name="l00042"></a>00042 use constant SHOW_SOLUTIONS_DEFAULT =&gt; 0;
<a name="l00043"></a>00043 use constant MAX_SHOW_DEFAULT =&gt; 20;
<a name="l00044"></a>00044 use constant NO_LOCAL_SET_STRING =&gt; <span class="stringliteral">&#39;No sets in this course yet&#39;</span>;
<a name="l00045"></a>00045 use constant SELECT_SET_STRING =&gt; <span class="stringliteral">&#39;Select a Set from this Course&#39;</span>;
<a name="l00046"></a>00046 use constant SELECT_LOCAL_STRING =&gt; <span class="stringliteral">&#39;Select a Problem Collection&#39;</span>;
<a name="l00047"></a>00047 use constant MY_PROBLEMS =&gt; <span class="stringliteral">&#39;  My Problems  &#39;</span>;
<a name="l00048"></a>00048 use constant MAIN_PROBLEMS =&gt; <span class="stringliteral">&#39;  Unclassified Problems  &#39;</span>;
<a name="l00049"></a>00049 use constant CREATE_SET_BUTTON =&gt; <span class="stringliteral">&#39;Create New Set&#39;</span>;
<a name="l00050"></a>00050 use constant ALL_CHAPTERS =&gt; <span class="stringliteral">&#39;All Chapters&#39;</span>;
<a name="l00051"></a>00051 use constant ALL_SUBJECTS =&gt; <span class="stringliteral">&#39;All Subjects&#39;</span>;
<a name="l00052"></a>00052 use constant ALL_SECTIONS =&gt; <span class="stringliteral">&#39;All Sections&#39;</span>;
<a name="l00053"></a>00053 use constant ALL_TEXTBOOKS =&gt; <span class="stringliteral">&#39;All Textbooks&#39;</span>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 use constant LIB2_DATA =&gt; {
<a name="l00056"></a>00056   <span class="stringliteral">&#39;dbchapter&#39;</span> =&gt; {name =&gt; <span class="stringliteral">&#39;library_chapters&#39;</span>, all =&gt; <span class="stringliteral">&#39;All Chapters&#39;</span>},
<a name="l00057"></a>00057   <span class="stringliteral">&#39;dbsection&#39;</span> =&gt;  {name =&gt; <span class="stringliteral">&#39;library_sections&#39;</span>, all =&gt;<span class="stringliteral">&#39;All Sections&#39;</span> },
<a name="l00058"></a>00058   <span class="stringliteral">&#39;dbsubject&#39;</span> =&gt;  {name =&gt; <span class="stringliteral">&#39;library_subjects&#39;</span>, all =&gt; <span class="stringliteral">&#39;All Subjects&#39;</span> },
<a name="l00059"></a>00059   <span class="stringliteral">&#39;textbook&#39;</span> =&gt;  {name =&gt; <span class="stringliteral">&#39;library_textbook&#39;</span>, all =&gt;  <span class="stringliteral">&#39;All Textbooks&#39;</span>},
<a name="l00060"></a>00060   <span class="stringliteral">&#39;textchapter&#39;</span> =&gt; {name =&gt; <span class="stringliteral">&#39;library_textchapter&#39;</span>, all =&gt; <span class="stringliteral">&#39;All Chapters&#39;</span>},
<a name="l00061"></a>00061   <span class="stringliteral">&#39;textsection&#39;</span> =&gt; {name =&gt; <span class="stringliteral">&#39;library_textsection&#39;</span>, all =&gt; <span class="stringliteral">&#39;All Sections&#39;</span>},
<a name="l00062"></a>00062   <span class="stringliteral">&#39;keywords&#39;</span> =&gt;  {name =&gt; <span class="stringliteral">&#39;library_keywords&#39;</span>, all =&gt; <span class="stringliteral">&#39;&#39;</span> },
<a name="l00063"></a>00063   };
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">## Flags for operations on files</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00067"></a>00067 use constant ADDED =&gt; 1;
<a name="l00068"></a>00068 use constant HIDDEN =&gt; (1 &lt;&lt; 1);
<a name="l00069"></a>00069 use constant SUCCESS =&gt; (1 &lt;&lt; 2);
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="preprocessor">##  for additional problib buttons</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span>my %problib;    ## filled in in global.conf
<a name="l00073"></a>00073 my %ignoredir = (
<a name="l00074"></a>00074     <span class="charliteral">&#39;.&#39;</span> =&gt; 1, <span class="stringliteral">&#39;..&#39;</span> =&gt; 1, <span class="stringliteral">&#39;Library&#39;</span> =&gt; 1, <span class="stringliteral">&#39;CVS&#39;</span> =&gt; 1, <span class="stringliteral">&#39;tmpEdit&#39;</span> =&gt; 1,
<a name="l00075"></a>00075     <span class="stringliteral">&#39;headers&#39;</span> =&gt; 1, <span class="stringliteral">&#39;macros&#39;</span> =&gt; 1, <span class="stringliteral">&#39;email&#39;</span> =&gt; 1, <span class="stringliteral">&#39;.svn&#39;</span> =&gt; 1,
<a name="l00076"></a>00076 );
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 sub prepare_activity_entry {
<a name="l00079"></a>00079     my $self=shift;
<a name="l00080"></a>00080     my $r = $self-&gt;r;
<a name="l00081"></a>00081     my $user = $self-&gt;r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>) || <span class="stringliteral">&#39;NO_USER&#39;</span>;
<a name="l00082"></a>00082     <span class="keywordflow">return</span>(<span class="stringliteral">&quot;In SetMaker as user $user&quot;</span>);
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="preprocessor">## This is for searching the disk for directories containing pg files.</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="preprocessor">## to make the recursion work, this returns an array where the first </span>
<a name="l00087"></a>00087 <span class="preprocessor"></span><span class="preprocessor">## item is the number of pg files in the directory.  The second is a</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span><span class="preprocessor">## list of directories which contain pg files.</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">##</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span><span class="preprocessor">## If a directory contains only one pg file and the directory name</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">## is the same as the file name, then the directory is considered</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">## to be part of the parent directory (it is probably in a separate</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">## directory only because it has auxiliary files that want to be</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">## kept together with the pg file).</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span><span class="preprocessor">##</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="preprocessor">## If a directory has a file named &quot;=library-ignore&quot;, it is never</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="preprocessor">## included in the directory menu.  If a directory contains a file</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span><span class="preprocessor">## called &quot;=library-combine-up&quot;, then its pg are included with those</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="preprocessor">## in the parent directory (and the directory does not appear in the</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span><span class="preprocessor">## menu).  If it has a file called &quot;=library-no-combine&quot; then it is</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="preprocessor">## always listed as a separate directory even if it contains only one</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span><span class="preprocessor">## pg file.</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span>
<a name="l00104"></a>00104 sub get_library_sets {
<a name="l00105"></a>00105     my $top = shift; my $dir = shift;
<a name="l00106"></a>00106 <span class="preprocessor">    # ignore directories that give us an error</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>    my @lis = eval { readDirectory($dir) };
<a name="l00108"></a>00108     <span class="keywordflow">if</span> ($@) {
<a name="l00109"></a>00109         warn $@;
<a name="l00110"></a>00110         <span class="keywordflow">return</span> (0);
<a name="l00111"></a>00111     }
<a name="l00112"></a>00112     <span class="keywordflow">return</span> (0) <span class="keywordflow">if</span> grep /^=library-ignore$/, @lis;
<a name="l00113"></a>00113 
<a name="l00114"></a>00114     my @pgfiles = grep { m/\.pg$/ and (not m/(Header|-text)\.pg$/) and -f &quot;$dir/$_&quot;} @lis;
<a name="l00115"></a>00115     my $pgcount = scalar(@pgfiles);
<a name="l00116"></a>00116     my $pgname = $dir; $pgname =~ s!.*/!!; $pgname .= &#39;.pg&#39;;
<a name="l00117"></a>00117     my $combineUp = ($pgcount == 1 &amp;&amp; $pgname eq $pgfiles[0] &amp;&amp; !(grep /^=library-no-combine$/, @lis));
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     my @pgdirs;
<a name="l00120"></a>00120     my @dirs = grep {!$ignoredir{$_} and -d <span class="stringliteral">&quot;$dir/$_&quot;</span>} @lis;
<a name="l00121"></a>00121     <span class="keywordflow">if</span> ($top == 1) {@dirs = grep {!$problib{$_}} @dirs}
<a name="l00122"></a>00122     <span class="keywordflow">foreach</span> my $subdir (@dirs) {
<a name="l00123"></a>00123         my @results = get_library_sets(0, <span class="stringliteral">&quot;$dir/$subdir&quot;</span>);
<a name="l00124"></a>00124         $pgcount += shift @results; push(@pgdirs,@results);
<a name="l00125"></a>00125     }
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     <span class="keywordflow">return</span> ($pgcount, @pgdirs) <span class="keywordflow">if</span> $top || $combineUp || grep /^=library-combine-up$/, @lis;
<a name="l00128"></a>00128     <span class="keywordflow">return</span> (0,@pgdirs,$dir);
<a name="l00129"></a>00129 }
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 sub get_library_pgs {
<a name="l00132"></a>00132     my $top = shift; my $base = shift; my $dir = shift;
<a name="l00133"></a>00133     my @lis = readDirectory(<span class="stringliteral">&quot;$base/$dir&quot;</span>);
<a name="l00134"></a>00134     <span class="keywordflow">return</span> () <span class="keywordflow">if</span> grep /^=library-ignore$/, @lis;
<a name="l00135"></a>00135     <span class="keywordflow">return</span> () <span class="keywordflow">if</span> !$top &amp;&amp; grep /^=library-no-combine$/, @lis;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137     my @pgs = grep { m/\.pg$/ and (not m/(Header|-text)\.pg$/) and -f &quot;$base/$dir/$_&quot;} @lis;
<a name="l00138"></a>00138     my $others = scalar(grep { (!m/\.pg$/ || m/(Header|-text)\.pg$/) &amp;&amp;
<a name="l00139"></a>00139                                 !m/(\.(tmp|bak)|~)$/ &amp;&amp; -f <span class="stringliteral">&quot;$base/$dir/$_&quot;</span> } @lis);
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     my @dirs = grep {!$ignoredir{$_} and -d <span class="stringliteral">&quot;$base/$dir/$_&quot;</span>} @lis;
<a name="l00142"></a>00142     <span class="keywordflow">if</span> ($top == 1) {@dirs = grep {!$problib{$_}} @dirs}
<a name="l00143"></a>00143     <span class="keywordflow">foreach</span> my $subdir (@dirs) {push(@pgs, get_library_pgs(0,<span class="stringliteral">&quot;$base/$dir&quot;</span>,$subdir))}
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     <span class="keywordflow">return</span> () unless $top || (scalar(@pgs) == 1 &amp;&amp; $others) || grep /^=library-combine-up$/, @lis;
<a name="l00146"></a>00146     <span class="keywordflow">return</span> (map {<span class="stringliteral">&quot;$dir/$_&quot;</span>} @pgs);
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149 sub list_pg_files {
<a name="l00150"></a>00150     my ($templates,$dir) = @_;
<a name="l00151"></a>00151     my $top = ($dir eq <span class="charliteral">&#39;.&#39;</span>)? 1 : 2;
<a name="l00152"></a>00152     my @pgs = get_library_pgs($top,$templates,$dir);
<a name="l00153"></a>00153     <span class="keywordflow">return</span> sortByName(undef,@pgs);
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 <span class="preprocessor">## Search for set definition files</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span>
<a name="l00158"></a>00158 sub get_set_defs {
<a name="l00159"></a>00159     my $topdir = shift;
<a name="l00160"></a>00160     my @found_set_defs;
<a name="l00161"></a>00161 <span class="preprocessor">    # get_set_defs_wanted is a closure over @found_set_defs</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span>    my $get_set_defs_wanted = sub {
<a name="l00163"></a>00163 <span class="preprocessor">        #my $fn = $_;</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span><span class="preprocessor">        #my $fdir = $File::Find::dir;</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span><span class="preprocessor">        #return() if($fn !~ /^set.*\.def$/);</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span><span class="preprocessor">        ##return() if(not -T $fn);</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span><span class="preprocessor">        #push @found_set_defs, &quot;$fdir/$fn&quot;;</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>        push @found_set_defs, $_ <span class="keywordflow">if</span> m|/<span class="keyword">set</span>[^/]*\.def$|;
<a name="l00169"></a>00169     };
<a name="l00170"></a>00170     find({ wanted =&gt; $get_set_defs_wanted, follow_fast=&gt;1, no_chdir=&gt;1}, $topdir);
<a name="l00171"></a>00171     map { $_ =~ s|^$topdir/?|| } @found_set_defs;
<a name="l00172"></a>00172     <span class="keywordflow">return</span> @found_set_defs;
<a name="l00173"></a>00173 }
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="preprocessor">## Try to make reading of set defs more flexible.  Additional strategies</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span><span class="preprocessor">## for fixing a path can be added here.</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span>
<a name="l00178"></a>00178 sub munge_pg_file_path {
<a name="l00179"></a>00179     my $self = shift;
<a name="l00180"></a>00180     my $pg_path = shift;
<a name="l00181"></a>00181     my $path_to_set_def = shift;
<a name="l00182"></a>00182     my $end_path = $pg_path;
<a name="l00183"></a>00183 <span class="preprocessor">    # if the path is ok, don&#39;t fix it</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>    <span class="keywordflow">return</span>($pg_path) <span class="keywordflow">if</span>(-e $self-&gt;r-&gt;ce-&gt;{courseDirs}{templates}.<span class="stringliteral">&quot;/$pg_path&quot;</span>);
<a name="l00185"></a>00185 <span class="preprocessor">    # if we have followed a link into a self contained course to get</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span><span class="preprocessor">    # to the set.def file, we need to insert the start of the path to</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span><span class="preprocessor">    # the set.def file</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span>    $end_path = <span class="stringliteral">&quot;$path_to_set_def/$pg_path&quot;</span>;
<a name="l00189"></a>00189     <span class="keywordflow">return</span>($end_path) <span class="keywordflow">if</span>(-e $self-&gt;r-&gt;ce-&gt;{courseDirs}{templates}.<span class="stringliteral">&quot;/$end_path&quot;</span>);
<a name="l00190"></a>00190 <span class="preprocessor">    # if we got this far, this path is bad, but we let it produce</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor">    # an error so the user knows there is a troublesome path in the</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span><span class="preprocessor">    # set.def file.</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span>    <span class="keywordflow">return</span>($pg_path);
<a name="l00194"></a>00194 }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="preprocessor">## Read a set definition file.  This could be abstracted since it happens</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span><span class="preprocessor">## elsewhere.  Here we don&#39;t have to process so much of the file.</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span>
<a name="l00199"></a>00199 sub read_set_def {
<a name="l00200"></a>00200     my $self = shift;
<a name="l00201"></a>00201     my $r = $self-&gt;r;
<a name="l00202"></a>00202     my $filePathOrig = shift;
<a name="l00203"></a>00203     my $filePath = $r-&gt;ce-&gt;{courseDirs}{templates}.<span class="stringliteral">&quot;/$filePathOrig&quot;</span>;
<a name="l00204"></a>00204     $filePathOrig =~ s/<span class="keyword">set</span>.*\.def$<span class="comment">//;</span>
<a name="l00205"></a>00205     $filePathOrig =~ s|/$||;
<a name="l00206"></a>00206     $filePathOrig = <span class="stringliteral">&quot;.&quot;</span> <span class="keywordflow">if</span> ($filePathOrig !~ /\S/);
<a name="l00207"></a>00207     my @pg_files = ();
<a name="l00208"></a>00208     my ($line, $got_to_pgs, $name, @rest) = (<span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00209"></a>00209     <span class="keywordflow">if</span> ( open (SETFILENAME, <span class="stringliteral">&quot;$filePath&quot;</span>) )    {
<a name="l00210"></a>00210         <span class="keywordflow">while</span>($line = &lt;SETFILENAME&gt;) {
<a name="l00211"></a>00211             chomp($line);
<a name="l00212"></a>00212             $line =~ s|(#.*)||; # don<span class="stringliteral">&#39;t read past comments</span>
<a name="l00213"></a>00213 <span class="stringliteral">            if($got_to_pgs) {</span>
<a name="l00214"></a>00214 <span class="stringliteral">                unless ($line =~ /\S/) {next;} # skip blank lines</span>
<a name="l00215"></a>00215 <span class="stringliteral">                ($name,@rest) = split (/\s*,\s*/,$line);</span>
<a name="l00216"></a>00216 <span class="stringliteral">                $name =~ s/\s*//g;</span>
<a name="l00217"></a>00217 <span class="stringliteral">                push @pg_files, $name;</span>
<a name="l00218"></a>00218 <span class="stringliteral">            } else {</span>
<a name="l00219"></a>00219 <span class="stringliteral">                $got_to_pgs = 1 if ($line =~ /problemList\s*=/);</span>
<a name="l00220"></a>00220 <span class="stringliteral">            }</span>
<a name="l00221"></a>00221 <span class="stringliteral">        }</span>
<a name="l00222"></a>00222 <span class="stringliteral">    } else {</span>
<a name="l00223"></a>00223 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;Cannot open $filePath&quot;);</span>
<a name="l00224"></a>00224 <span class="stringliteral">    }</span>
<a name="l00225"></a>00225 <span class="stringliteral">    # This is where we would potentially munge the pg file paths</span>
<a name="l00226"></a>00226 <span class="stringliteral">    # One possibility</span>
<a name="l00227"></a>00227 <span class="stringliteral">    @pg_files = map { $self-&gt;munge_pg_file_path($_, $filePathOrig) } @pg_files;</span>
<a name="l00228"></a>00228 <span class="stringliteral">    return(@pg_files);</span>
<a name="l00229"></a>00229 <span class="stringliteral">}</span>
<a name="l00230"></a>00230 <span class="stringliteral"></span>
<a name="l00231"></a>00231 <span class="stringliteral">## go through past page getting a list of identifiers for the problems</span>
<a name="l00232"></a>00232 <span class="stringliteral">## and whether or not they are selected, and whether or not they should</span>
<a name="l00233"></a>00233 <span class="stringliteral">## be hidden</span>
<a name="l00234"></a>00234 <span class="stringliteral"></span>
<a name="l00235"></a>00235 <span class="stringliteral">sub get_past_problem_files {</span>
<a name="l00236"></a>00236 <span class="stringliteral">    my $r = shift;</span>
<a name="l00237"></a>00237 <span class="stringliteral">    my @found=();</span>
<a name="l00238"></a>00238 <span class="stringliteral">    my $count =1;</span>
<a name="l00239"></a>00239 <span class="stringliteral">    while (defined($r-&gt;param(&quot;filetrial$count&quot;))) {</span>
<a name="l00240"></a>00240 <span class="stringliteral">        my $val = 0;</span>
<a name="l00241"></a>00241 <span class="stringliteral">        $val |= ADDED if($r-&gt;param(&quot;trial$count&quot;));</span>
<a name="l00242"></a>00242 <span class="stringliteral">        $val |= HIDDEN if($r-&gt;param(&quot;hideme$count&quot;));</span>
<a name="l00243"></a>00243 <span class="stringliteral">        push @found, [$r-&gt;param(&quot;filetrial$count&quot;), $val];          </span>
<a name="l00244"></a>00244 <span class="stringliteral">        $count++;</span>
<a name="l00245"></a>00245 <span class="stringliteral">    }</span>
<a name="l00246"></a>00246 <span class="stringliteral">    return(\@found);</span>
<a name="l00247"></a>00247 <span class="stringliteral">}</span>
<a name="l00248"></a>00248 <span class="stringliteral"></span>
<a name="l00249"></a>00249 <span class="stringliteral">#### For adding new problems</span>
<a name="l00250"></a>00250 <span class="stringliteral"></span>
<a name="l00251"></a>00251 <span class="stringliteral">sub add_selected {</span>
<a name="l00252"></a>00252 <span class="stringliteral">    my $self = shift;</span>
<a name="l00253"></a>00253 <span class="stringliteral">    my $db = shift;</span>
<a name="l00254"></a>00254 <span class="stringliteral">    my $setName = shift;</span>
<a name="l00255"></a>00255 <span class="stringliteral">    my @past_problems = @{$self-&gt;{past_problems}};</span>
<a name="l00256"></a>00256 <span class="stringliteral">    my @selected = @past_problems;</span>
<a name="l00257"></a>00257 <span class="stringliteral">    my (@path, $file, $selected, $freeProblemID);</span>
<a name="l00258"></a>00258 <span class="stringliteral">    # DBFIXME count would work just as well</span>
<a name="l00259"></a>00259 <span class="stringliteral">    $freeProblemID = max($db-&gt;listGlobalProblems($setName)) + 1;</span>
<a name="l00260"></a>00260 <span class="stringliteral">    my $addedcount=0;</span>
<a name="l00261"></a>00261 <span class="stringliteral"></span>
<a name="l00262"></a>00262 <span class="stringliteral">    for $selected (@selected) {</span>
<a name="l00263"></a>00263 <span class="stringliteral">        if($selected-&gt;[1] &amp; ADDED) {</span>
<a name="l00264"></a>00264 <span class="stringliteral">            $file = $selected-&gt;[0];</span>
<a name="l00265"></a>00265 <span class="stringliteral">            my $problemRecord = $self-&gt;addProblemToSet(setName =&gt; $setName,</span>
<a name="l00266"></a>00266 <span class="stringliteral">                sourceFile =&gt; $file, problemID =&gt; $freeProblemID);</span>
<a name="l00267"></a>00267 <span class="stringliteral">            $freeProblemID++;</span>
<a name="l00268"></a>00268 <span class="stringliteral">            $self-&gt;assignProblemToAllSetUsers($problemRecord);</span>
<a name="l00269"></a>00269 <span class="stringliteral">            $selected-&gt;[1] |= SUCCESS;</span>
<a name="l00270"></a>00270 <span class="stringliteral">            $addedcount++;</span>
<a name="l00271"></a>00271 <span class="stringliteral">        }</span>
<a name="l00272"></a>00272 <span class="stringliteral">    }</span>
<a name="l00273"></a>00273 <span class="stringliteral">    return($addedcount);</span>
<a name="l00274"></a>00274 <span class="stringliteral">}</span>
<a name="l00275"></a>00275 <span class="stringliteral"></span>
<a name="l00276"></a>00276 <span class="stringliteral"></span>
<a name="l00277"></a>00277 <span class="stringliteral">############# List of sets of problems in templates directory</span>
<a name="l00278"></a>00278 <span class="stringliteral"></span>
<a name="l00279"></a>00279 <span class="stringliteral">sub get_problem_directories {</span>
<a name="l00280"></a>00280 <span class="stringliteral">    my $ce = shift;</span>
<a name="l00281"></a>00281 <span class="stringliteral">    my $lib = shift;</span>
<a name="l00282"></a>00282 <span class="stringliteral">    my $source = $ce-&gt;{courseDirs}{templates};</span>
<a name="l00283"></a>00283 <span class="stringliteral">    my $main = MY_PROBLEMS; my $isTop = 1;</span>
<a name="l00284"></a>00284 <span class="stringliteral">    if ($lib) {$source .= &quot;/$lib&quot;; $main = MAIN_PROBLEMS; $isTop = 2}</span>
<a name="l00285"></a>00285 <span class="stringliteral">    my @all_problem_directories = get_library_sets($isTop, $source);</span>
<a name="l00286"></a>00286 <span class="stringliteral">    my $includetop = shift @all_problem_directories;</span>
<a name="l00287"></a>00287 <span class="stringliteral">    my $j;</span>
<a name="l00288"></a>00288 <span class="stringliteral">    for ($j=0; $j&lt;scalar(@all_problem_directories); $j++) {</span>
<a name="l00289"></a>00289 <span class="stringliteral">        $all_problem_directories[$j] =~ s|^$ce-&gt;{courseDirs}-&gt;{templates}/?||;</span>
<a name="l00290"></a>00290 <span class="stringliteral">    }</span>
<a name="l00291"></a>00291 <span class="stringliteral">    @all_problem_directories = sortByName(undef, @all_problem_directories);</span>
<a name="l00292"></a>00292 <span class="stringliteral">    unshift @all_problem_directories, $main if($includetop);</span>
<a name="l00293"></a>00293 <span class="stringliteral">    return (\@all_problem_directories);</span>
<a name="l00294"></a>00294 <span class="stringliteral">}</span>
<a name="l00295"></a>00295 <span class="stringliteral"></span>
<a name="l00296"></a>00296 <span class="stringliteral">############# Everyone has a view problems line.    Abstract it</span>
<a name="l00297"></a>00297 <span class="stringliteral">sub view_problems_line {</span>
<a name="l00298"></a>00298 <span class="stringliteral">    my $internal_name = shift;</span>
<a name="l00299"></a>00299 <span class="stringliteral">    my $label = shift;</span>
<a name="l00300"></a>00300 <span class="stringliteral">    my $r = shift; # so we can get parameter values</span>
<a name="l00301"></a>00301 <span class="stringliteral">    my $result = CGI::submit(-name=&gt;&quot;$internal_name&quot;, -value=&gt;$label);</span>
<a name="l00302"></a>00302 <span class="stringliteral"></span>
<a name="l00303"></a>00303 <span class="stringliteral">    my %display_modes = %{WeBWorK::PG::DISPLAY_MODES()};</span>
<a name="l00304"></a>00304 <span class="stringliteral">    my @active_modes = grep { exists $display_modes{$_} }</span>
<a name="l00305"></a>00305 <span class="stringliteral">        @{$r-&gt;ce-&gt;{pg}-&gt;{displayModes}};</span>
<a name="l00306"></a>00306 <span class="stringliteral">    push @active_modes, &#39;</span>None<span class="stringliteral">&#39;;</span>
<a name="l00307"></a>00307 <span class="stringliteral">    # We have our own displayMode since its value may be None, which is illegal</span>
<a name="l00308"></a>00308 <span class="stringliteral">    # in other modules.</span>
<a name="l00309"></a>00309 <span class="stringliteral">    my $mydisplayMode = $r-&gt;param(&#39;</span>mydisplayMode<span class="stringliteral">&#39;) || $r-&gt;ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};</span>
<a name="l00310"></a>00310 <span class="stringliteral">    $result .= &#39;</span>&amp;nbsp;Display&amp;nbsp;Mode:&amp;nbsp;<span class="stringliteral">&#39;.CGI::popup_menu(-name=&gt; &#39;</span>mydisplayMode<span class="stringliteral">&#39;,</span>
<a name="l00311"></a>00311 <span class="stringliteral">                                                                -values=&gt;\@active_modes,</span>
<a name="l00312"></a>00312 <span class="stringliteral">                                                                -default=&gt; $mydisplayMode);</span>
<a name="l00313"></a>00313 <span class="stringliteral">    # Now we give a choice of the number of problems to show</span>
<a name="l00314"></a>00314 <span class="stringliteral">    my $defaultMax = $r-&gt;param(&#39;</span>max_shown<span class="stringliteral">&#39;) || MAX_SHOW_DEFAULT;</span>
<a name="l00315"></a>00315 <span class="stringliteral">    $result .= &#39;</span>&amp;nbsp;Max. Shown:&amp;nbsp<span class="stringliteral">&#39;.</span>
<a name="l00316"></a>00316 <span class="stringliteral">        CGI::popup_menu(-name=&gt; &#39;</span>max_shown<span class="stringliteral">&#39;,</span>
<a name="l00317"></a>00317 <span class="stringliteral">                        -values=&gt;[5,10,15,20,25,30,50,&#39;</span>All<span class="stringliteral">&#39;],</span>
<a name="l00318"></a>00318 <span class="stringliteral">                        -default=&gt; $defaultMax);</span>
<a name="l00319"></a>00319 <span class="stringliteral">    # Option of whether to show hints and solutions</span>
<a name="l00320"></a>00320 <span class="stringliteral">    my $defaultHints = $r-&gt;param(&#39;</span>showHints<span class="stringliteral">&#39;) || SHOW_HINTS_DEFAULT;</span>
<a name="l00321"></a>00321 <span class="stringliteral">    $result .= &quot;&amp;nbsp;&quot;.CGI::checkbox(-name=&gt;&quot;showHints&quot;,-checked=&gt;$defaultHints,-label=&gt;&quot;Hints&quot;);</span>
<a name="l00322"></a>00322 <span class="stringliteral">    my $defaultSolutions = $r-&gt;param(&#39;</span>showSolutions<span class="stringliteral">&#39;) || SHOW_SOLUTIONS_DEFAULT;</span>
<a name="l00323"></a>00323 <span class="stringliteral">    $result .= &quot;&amp;nbsp;&quot;.CGI::checkbox(-name=&gt;&quot;showSolutions&quot;,-checked=&gt;$defaultSolutions,-label=&gt;&quot;Solutions&quot;);</span>
<a name="l00324"></a>00324 <span class="stringliteral">    </span>
<a name="l00325"></a>00325 <span class="stringliteral">    return($result);</span>
<a name="l00326"></a>00326 <span class="stringliteral">}</span>
<a name="l00327"></a>00327 <span class="stringliteral"></span>
<a name="l00328"></a>00328 <span class="stringliteral"></span>
<a name="l00329"></a>00329 <span class="stringliteral">### The browsing panel has three versions</span>
<a name="l00330"></a>00330 <span class="stringliteral">#####    Version 1 is local problems</span>
<a name="l00331"></a>00331 <span class="stringliteral">sub browse_local_panel {</span>
<a name="l00332"></a>00332 <span class="stringliteral">    my $self = shift;</span>
<a name="l00333"></a>00333 <span class="stringliteral">    my $library_selected = shift;</span>
<a name="l00334"></a>00334 <span class="stringliteral">    my $lib = shift || &#39;</span><span class="stringliteral">&#39;; $lib =~ s/^browse_//;</span>
<a name="l00335"></a>00335 <span class="stringliteral">    my $name = ($lib eq &#39;</span><span class="stringliteral">&#39;)? &#39;</span>Local<span class="stringliteral">&#39; : $problib{$lib};</span>
<a name="l00336"></a>00336 <span class="stringliteral">    </span>
<a name="l00337"></a>00337 <span class="stringliteral">    my $list_of_prob_dirs= get_problem_directories($self-&gt;r-&gt;ce,$lib);</span>
<a name="l00338"></a>00338 <span class="stringliteral">    if(scalar(@$list_of_prob_dirs) == 0) {</span>
<a name="l00339"></a>00339 <span class="stringliteral">        $library_selected = &quot;Found no directories containing problems&quot;;</span>
<a name="l00340"></a>00340 <span class="stringliteral">        unshift @{$list_of_prob_dirs}, $library_selected;</span>
<a name="l00341"></a>00341 <span class="stringliteral">    } else {</span>
<a name="l00342"></a>00342 <span class="stringliteral">        my $default_value = SELECT_LOCAL_STRING;</span>
<a name="l00343"></a>00343 <span class="stringliteral">        if (not $library_selected or $library_selected eq $default_value) {</span>
<a name="l00344"></a>00344 <span class="stringliteral">            unshift @{$list_of_prob_dirs},  $default_value;</span>
<a name="l00345"></a>00345 <span class="stringliteral">            $library_selected = $default_value;</span>
<a name="l00346"></a>00346 <span class="stringliteral">        }</span>
<a name="l00347"></a>00347 <span class="stringliteral">    }</span>
<a name="l00348"></a>00348 <span class="stringliteral">    debug(&quot;library is $lib and sets are $library_selected&quot;);</span>
<a name="l00349"></a>00349 <span class="stringliteral">    my $view_problem_line = view_problems_line(&#39;</span>view_local_set<span class="stringliteral">&#39;, &#39;</span>View Problems<span class="stringliteral">&#39;, $self-&gt;r);</span>
<a name="l00350"></a>00350 <span class="stringliteral">    my @popup_menu_args = (</span>
<a name="l00351"></a>00351 <span class="stringliteral">        -name =&gt; &#39;</span>library_sets<span class="stringliteral">&#39;,</span>
<a name="l00352"></a>00352 <span class="stringliteral">        -values =&gt; $list_of_prob_dirs,</span>
<a name="l00353"></a>00353 <span class="stringliteral">        -default =&gt; $library_selected,</span>
<a name="l00354"></a>00354 <span class="stringliteral">    );</span>
<a name="l00355"></a>00355 <span class="stringliteral">    # make labels without the $lib prefix -- reduces the width of the popup menu</span>
<a name="l00356"></a>00356 <span class="stringliteral">    if (length($lib)) {</span>
<a name="l00357"></a>00357 <span class="stringliteral">        my %labels = map { my($l)=$_=~/^$lib\/(.*)$/;$_=&gt;$l } @$list_of_prob_dirs;</span>
<a name="l00358"></a>00358 <span class="stringliteral">        push @popup_menu_args, -labels =&gt; \%labels;</span>
<a name="l00359"></a>00359 <span class="stringliteral">    }</span>
<a name="l00360"></a>00360 <span class="stringliteral">    print CGI::Tr({}, CGI::td({-class=&gt;&quot;InfoPanel&quot;, -align=&gt;&quot;left&quot;}, &quot;$name Problems: &quot;,</span>
<a name="l00361"></a>00361 <span class="stringliteral">                      CGI::popup_menu(@popup_menu_args),</span>
<a name="l00362"></a>00362 <span class="stringliteral">                      CGI::br(), </span>
<a name="l00363"></a>00363 <span class="stringliteral">                      $view_problem_line,</span>
<a name="l00364"></a>00364 <span class="stringliteral">    ));</span>
<a name="l00365"></a>00365 <span class="stringliteral">}</span>
<a name="l00366"></a>00366 <span class="stringliteral"></span>
<a name="l00367"></a>00367 <span class="stringliteral">#####    Version 2 is local homework sets</span>
<a name="l00368"></a>00368 <span class="stringliteral">sub browse_mysets_panel {</span>
<a name="l00369"></a>00369 <span class="stringliteral">    my $self = shift;</span>
<a name="l00370"></a>00370 <span class="stringliteral">    my $library_selected = shift;</span>
<a name="l00371"></a>00371 <span class="stringliteral">    my $list_of_local_sets = shift;</span>
<a name="l00372"></a>00372 <span class="stringliteral">    my $default_value = &quot;Select a Homework Set&quot;;</span>
<a name="l00373"></a>00373 <span class="stringliteral"></span>
<a name="l00374"></a>00374 <span class="stringliteral">    if(scalar(@$list_of_local_sets) == 0) {</span>
<a name="l00375"></a>00375 <span class="stringliteral">        $list_of_local_sets = [NO_LOCAL_SET_STRING];</span>
<a name="l00376"></a>00376 <span class="stringliteral">    } elsif (not $library_selected or $library_selected eq $default_value) { </span>
<a name="l00377"></a>00377 <span class="stringliteral">        unshift @{$list_of_local_sets},  $default_value; </span>
<a name="l00378"></a>00378 <span class="stringliteral">        $library_selected = $default_value; </span>
<a name="l00379"></a>00379 <span class="stringliteral">    } </span>
<a name="l00380"></a>00380 <span class="stringliteral"></span>
<a name="l00381"></a>00381 <span class="stringliteral">    my $view_problem_line = view_problems_line(&#39;</span>view_mysets_set<span class="stringliteral">&#39;, &#39;</span>View Problems<span class="stringliteral">&#39;, $self-&gt;r);</span>
<a name="l00382"></a>00382 <span class="stringliteral">    print CGI::Tr({},</span>
<a name="l00383"></a>00383 <span class="stringliteral">        CGI::td({-class=&gt;&quot;InfoPanel&quot;, -align=&gt;&quot;left&quot;}, &quot;Browse from: &quot;,</span>
<a name="l00384"></a>00384 <span class="stringliteral">        CGI::popup_menu(-name=&gt; &#39;</span>library_sets<span class="stringliteral">&#39;, </span>
<a name="l00385"></a>00385 <span class="stringliteral">                        -values=&gt;$list_of_local_sets, </span>
<a name="l00386"></a>00386 <span class="stringliteral">                        -default=&gt; $library_selected),</span>
<a name="l00387"></a>00387 <span class="stringliteral">        CGI::br(), </span>
<a name="l00388"></a>00388 <span class="stringliteral">        $view_problem_line</span>
<a name="l00389"></a>00389 <span class="stringliteral">    ));</span>
<a name="l00390"></a>00390 <span class="stringliteral">}</span>
<a name="l00391"></a>00391 <span class="stringliteral"></span>
<a name="l00392"></a>00392 <span class="stringliteral">#####    Version 3 is the problem library</span>
<a name="l00393"></a>00393 <span class="stringliteral"># </span>
<a name="l00394"></a>00394 <span class="stringliteral"># This comes in 3 forms, problem library version 1, and for version 2 there</span>
<a name="l00395"></a>00395 <span class="stringliteral"># is the basic, and the advanced interfaces.  This function checks what we are</span>
<a name="l00396"></a>00396 <span class="stringliteral"># supposed to do, or aborts if the problem library has not been installed.</span>
<a name="l00397"></a>00397 <span class="stringliteral"></span>
<a name="l00398"></a>00398 <span class="stringliteral">sub browse_library_panel {</span>
<a name="l00399"></a>00399 <span class="stringliteral">    my $self=shift;</span>
<a name="l00400"></a>00400 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00401"></a>00401 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00402"></a>00402 <span class="stringliteral"></span>
<a name="l00403"></a>00403 <span class="stringliteral">    # See if the problem library is installed</span>
<a name="l00404"></a>00404 <span class="stringliteral">    my $libraryRoot = $r-&gt;{ce}-&gt;{problemLibrary}-&gt;{root};</span>
<a name="l00405"></a>00405 <span class="stringliteral"></span>
<a name="l00406"></a>00406 <span class="stringliteral">    unless($libraryRoot) {</span>
<a name="l00407"></a>00407 <span class="stringliteral">        print CGI::Tr(CGI::td(CGI::div({class=&gt;&#39;</span>ResultsWithError<span class="stringliteral">&#39;, align=&gt;&quot;center&quot;}, </span>
<a name="l00408"></a>00408 <span class="stringliteral">            &quot;The problem library has not been installed.&quot;)));</span>
<a name="l00409"></a>00409 <span class="stringliteral">        return;</span>
<a name="l00410"></a>00410 <span class="stringliteral">    }</span>
<a name="l00411"></a>00411 <span class="stringliteral">    # Test if the Library directory link exists.  If not, try to make it</span>
<a name="l00412"></a>00412 <span class="stringliteral">    unless(-d &quot;$ce-&gt;{courseDirs}-&gt;{templates}/Library&quot;) {</span>
<a name="l00413"></a>00413 <span class="stringliteral">        unless(symlink($libraryRoot, &quot;$ce-&gt;{courseDirs}-&gt;{templates}/Library&quot;)) {</span>
<a name="l00414"></a>00414 <span class="stringliteral">            my $msg =    &lt;&lt;&quot;HERE&quot;;</span>
<a name="l00415"></a>00415 <span class="stringliteral">You are missing the directory &lt;code&gt;templates/Library&lt;/code&gt;, which is needed</span>
<a name="l00416"></a>00416 <span class="stringliteral">for the Problem Library to function.    It should be a link pointing to</span>
<a name="l00417"></a>00417 <span class="stringliteral">&lt;code&gt;$libraryRoot&lt;/code&gt;, which you set in &lt;code&gt;conf/global.conf&lt;/code&gt;.</span>
<a name="l00418"></a>00418 <span class="stringliteral">I tried to make the link for you, but that failed.  Check the permissions</span>
<a name="l00419"></a>00419 <span class="stringliteral">in your &lt;code&gt;templates&lt;/code&gt; directory.</span>
<a name="l00420"></a>00420 <span class="stringliteral">HERE</span>
<a name="l00421"></a>00421 <span class="stringliteral">            $self-&gt;addbadmessage($msg);</span>
<a name="l00422"></a>00422 <span class="stringliteral">        }</span>
<a name="l00423"></a>00423 <span class="stringliteral">    }</span>
<a name="l00424"></a>00424 <span class="stringliteral"></span>
<a name="l00425"></a>00425 <span class="stringliteral">    # Now check what version we are supposed to use</span>
<a name="l00426"></a>00426 <span class="stringliteral">    my $libraryVersion = $r-&gt;{ce}-&gt;{problemLibrary}-&gt;{version} || 1;</span>
<a name="l00427"></a>00427 <span class="stringliteral">    if($libraryVersion == 1) {</span>
<a name="l00428"></a>00428 <span class="stringliteral">        return $self-&gt;browse_library_panel1;</span>
<a name="l00429"></a>00429 <span class="stringliteral">    } elsif($libraryVersion == 2) {</span>
<a name="l00430"></a>00430 <span class="stringliteral">        return $self-&gt;browse_library_panel2 if($self-&gt;{library_basic}==1);</span>
<a name="l00431"></a>00431 <span class="stringliteral">        return $self-&gt;browse_library_panel2adv;</span>
<a name="l00432"></a>00432 <span class="stringliteral">    } else {</span>
<a name="l00433"></a>00433 <span class="stringliteral">        print CGI::Tr(CGI::td(CGI::div({class=&gt;&#39;</span>ResultsWithError<span class="stringliteral">&#39;, align=&gt;&quot;center&quot;}, </span>
<a name="l00434"></a>00434 <span class="stringliteral">            &quot;The problem library version is set to an illegal value.&quot;)));</span>
<a name="l00435"></a>00435 <span class="stringliteral">        return;</span>
<a name="l00436"></a>00436 <span class="stringliteral">    }</span>
<a name="l00437"></a>00437 <span class="stringliteral">}</span>
<a name="l00438"></a>00438 <span class="stringliteral"></span>
<a name="l00439"></a>00439 <span class="stringliteral">sub browse_library_panel1 {</span>
<a name="l00440"></a>00440 <span class="stringliteral">    my $self = shift;</span>
<a name="l00441"></a>00441 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00442"></a>00442 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00443"></a>00443 <span class="stringliteral">    </span>
<a name="l00444"></a>00444 <span class="stringliteral">    my @chaps = WeBWorK::Utils::ListingDB::getAllChapters($r-&gt;{ce});</span>
<a name="l00445"></a>00445 <span class="stringliteral">    unshift @chaps, LIB2_DATA-&gt;{dbchapter}{all};</span>
<a name="l00446"></a>00446 <span class="stringliteral">    my $chapter_selected = $r-&gt;param(&#39;</span>library_chapters<span class="stringliteral">&#39;) || LIB2_DATA-&gt;{dbchapter}-&gt;{all};</span>
<a name="l00447"></a>00447 <span class="stringliteral"></span>
<a name="l00448"></a>00448 <span class="stringliteral">    my @sects=();</span>
<a name="l00449"></a>00449 <span class="stringliteral">    if ($chapter_selected ne LIB2_DATA-&gt;{dbchapter}{all}) {</span>
<a name="l00450"></a>00450 <span class="stringliteral">        @sects = WeBWorK::Utils::ListingDB::getAllSections($r-&gt;{ce}, $chapter_selected);</span>
<a name="l00451"></a>00451 <span class="stringliteral">    }</span>
<a name="l00452"></a>00452 <span class="stringliteral"></span>
<a name="l00453"></a>00453 <span class="stringliteral">    unshift @sects, ALL_SECTIONS;</span>
<a name="l00454"></a>00454 <span class="stringliteral">    my $section_selected =  $r-&gt;param(&#39;</span>library_sections<span class="stringliteral">&#39;) || LIB2_DATA-&gt;{dbsection}{all};</span>
<a name="l00455"></a>00455 <span class="stringliteral"></span>
<a name="l00456"></a>00456 <span class="stringliteral">    my $view_problem_line = view_problems_line(&#39;</span>lib_view<span class="stringliteral">&#39;, &#39;</span>View Problems<span class="stringliteral">&#39;, $self-&gt;r);</span>
<a name="l00457"></a>00457 <span class="stringliteral"></span>
<a name="l00458"></a>00458 <span class="stringliteral">    print CGI::Tr(CGI::td({-class=&gt;&quot;InfoPanel&quot;, -align=&gt;&quot;left&quot;}, </span>
<a name="l00459"></a>00459 <span class="stringliteral">        CGI::start_table(),</span>
<a name="l00460"></a>00460 <span class="stringliteral">            CGI::Tr({},</span>
<a name="l00461"></a>00461 <span class="stringliteral">                CGI::td([&quot;Chapter:&quot;,</span>
<a name="l00462"></a>00462 <span class="stringliteral">                    CGI::popup_menu(-name=&gt; &#39;</span>library_chapters<span class="stringliteral">&#39;, </span>
<a name="l00463"></a>00463 <span class="stringliteral">                                    -values=&gt;\@chaps,</span>
<a name="l00464"></a>00464 <span class="stringliteral">                                    -default=&gt; $chapter_selected,</span>
<a name="l00465"></a>00465 <span class="stringliteral">                                    -onchange=&gt;&quot;submit();return true&quot;</span>
<a name="l00466"></a>00466 <span class="stringliteral">                    ),</span>
<a name="l00467"></a>00467 <span class="stringliteral">                    CGI::submit(-name=&gt;&quot;lib_select_chapter&quot;, -value=&gt;&quot;Update Section List&quot;)])),</span>
<a name="l00468"></a>00468 <span class="stringliteral">            CGI::Tr({},</span>
<a name="l00469"></a>00469 <span class="stringliteral">                CGI::td(&quot;Section:&quot;),</span>
<a name="l00470"></a>00470 <span class="stringliteral">                CGI::td({-colspan=&gt;2},</span>
<a name="l00471"></a>00471 <span class="stringliteral">                    CGI::popup_menu(-name=&gt; &#39;</span>library_sections<span class="stringliteral">&#39;, </span>
<a name="l00472"></a>00472 <span class="stringliteral">                                    -values=&gt;\@sects,</span>
<a name="l00473"></a>00473 <span class="stringliteral">                                    -default=&gt; $section_selected</span>
<a name="l00474"></a>00474 <span class="stringliteral">            ))),</span>
<a name="l00475"></a>00475 <span class="stringliteral"></span>
<a name="l00476"></a>00476 <span class="stringliteral">            CGI::Tr(CGI::td({-colspan=&gt;3}, $view_problem_line)),</span>
<a name="l00477"></a>00477 <span class="stringliteral">            CGI::end_table(),</span>
<a name="l00478"></a>00478 <span class="stringliteral">        ));</span>
<a name="l00479"></a>00479 <span class="stringliteral">}</span>
<a name="l00480"></a>00480 <span class="stringliteral"></span>
<a name="l00481"></a>00481 <span class="stringliteral">sub browse_library_panel2 {</span>
<a name="l00482"></a>00482 <span class="stringliteral">    my $self = shift;</span>
<a name="l00483"></a>00483 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00484"></a>00484 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00485"></a>00485 <span class="stringliteral"></span>
<a name="l00486"></a>00486 <span class="stringliteral">    my @subjs = WeBWorK::Utils::ListingDB::getAllDBsubjects($r);</span>
<a name="l00487"></a>00487 <span class="stringliteral">    unshift @subjs, LIB2_DATA-&gt;{dbsubject}{all};</span>
<a name="l00488"></a>00488 <span class="stringliteral"></span>
<a name="l00489"></a>00489 <span class="stringliteral">    my @chaps = WeBWorK::Utils::ListingDB::getAllDBchapters($r);</span>
<a name="l00490"></a>00490 <span class="stringliteral">    unshift @chaps, LIB2_DATA-&gt;{dbchapter}{all};</span>
<a name="l00491"></a>00491 <span class="stringliteral"></span>
<a name="l00492"></a>00492 <span class="stringliteral">    my @sects=();</span>
<a name="l00493"></a>00493 <span class="stringliteral">    @sects = WeBWorK::Utils::ListingDB::getAllDBsections($r);</span>
<a name="l00494"></a>00494 <span class="stringliteral">    unshift @sects, LIB2_DATA-&gt;{dbsection}{all};</span>
<a name="l00495"></a>00495 <span class="stringliteral"></span>
<a name="l00496"></a>00496 <span class="stringliteral">    my $subject_selected = $r-&gt;param(&#39;</span>library_subjects<span class="stringliteral">&#39;) || LIB2_DATA-&gt;{dbsubject}{all};</span>
<a name="l00497"></a>00497 <span class="stringliteral">    my $chapter_selected = $r-&gt;param(&#39;</span>library_chapters<span class="stringliteral">&#39;) || LIB2_DATA-&gt;{dbchapter}{all};</span>
<a name="l00498"></a>00498 <span class="stringliteral">    my $section_selected =  $r-&gt;param(&#39;</span>library_sections<span class="stringliteral">&#39;) || LIB2_DATA-&gt;{dbsection}{all};</span>
<a name="l00499"></a>00499 <span class="stringliteral"></span>
<a name="l00500"></a>00500 <span class="stringliteral">    my $view_problem_line = view_problems_line(&#39;</span>lib_view<span class="stringliteral">&#39;, &#39;</span>View Problems<span class="stringliteral">&#39;, $self-&gt;r);</span>
<a name="l00501"></a>00501 <span class="stringliteral"></span>
<a name="l00502"></a>00502 <span class="stringliteral">    my $count_line = WeBWorK::Utils::ListingDB::countDBListings($r);</span>
<a name="l00503"></a>00503 <span class="stringliteral">    if($count_line==0) {</span>
<a name="l00504"></a>00504 <span class="stringliteral">        $count_line = &quot;There are no matching pg files&quot;;</span>
<a name="l00505"></a>00505 <span class="stringliteral">    } else {</span>
<a name="l00506"></a>00506 <span class="stringliteral">        $count_line = &quot;There are $count_line matching WeBWorK problem files&quot;;</span>
<a name="l00507"></a>00507 <span class="stringliteral">    }</span>
<a name="l00508"></a>00508 <span class="stringliteral"></span>
<a name="l00509"></a>00509 <span class="stringliteral">    print CGI::Tr({},</span>
<a name="l00510"></a>00510 <span class="stringliteral">        CGI::td({-class=&gt;&quot;InfoPanel&quot;, -align=&gt;&quot;left&quot;}, </span>
<a name="l00511"></a>00511 <span class="stringliteral">        CGI::hidden(-name=&gt;&quot;library_is_basic&quot;, -default=&gt;1,-override=&gt;1),</span>
<a name="l00512"></a>00512 <span class="stringliteral">        CGI::start_table({-width=&gt;&quot;100%&quot;}),</span>
<a name="l00513"></a>00513 <span class="stringliteral">        CGI::Tr({},</span>
<a name="l00514"></a>00514 <span class="stringliteral">            CGI::td([&quot;Subject:&quot;,</span>
<a name="l00515"></a>00515 <span class="stringliteral">                CGI::popup_menu(-name=&gt; &#39;</span>library_subjects<span class="stringliteral">&#39;, </span>
<a name="l00516"></a>00516 <span class="stringliteral">                                -values=&gt;\@subjs,</span>
<a name="l00517"></a>00517 <span class="stringliteral">                                -default=&gt; $subject_selected,</span>
<a name="l00518"></a>00518 <span class="stringliteral">                                 -onchange=&gt;&quot;submit();return true&quot;</span>
<a name="l00519"></a>00519 <span class="stringliteral">                )]),</span>
<a name="l00520"></a>00520 <span class="stringliteral">            CGI::td({-colspan=&gt;2, -align=&gt;&quot;right&quot;},</span>
<a name="l00521"></a>00521 <span class="stringliteral">                CGI::submit(-name=&gt;&quot;lib_select_subject&quot;, -value=&gt;&quot;Update Chapter/Section Lists&quot;))</span>
<a name="l00522"></a>00522 <span class="stringliteral">        ),</span>
<a name="l00523"></a>00523 <span class="stringliteral">        CGI::Tr({},</span>
<a name="l00524"></a>00524 <span class="stringliteral">            CGI::td([&quot;Chapter:&quot;,</span>
<a name="l00525"></a>00525 <span class="stringliteral">                CGI::popup_menu(-name=&gt; &#39;</span>library_chapters<span class="stringliteral">&#39;, </span>
<a name="l00526"></a>00526 <span class="stringliteral">                                -values=&gt;\@chaps,</span>
<a name="l00527"></a>00527 <span class="stringliteral">                                -default=&gt; $chapter_selected,</span>
<a name="l00528"></a>00528 <span class="stringliteral">                                 -onchange=&gt;&quot;submit();return true&quot;</span>
<a name="l00529"></a>00529 <span class="stringliteral">            )]),</span>
<a name="l00530"></a>00530 <span class="stringliteral">            CGI::td({-colspan=&gt;2, -align=&gt;&quot;right&quot;},</span>
<a name="l00531"></a>00531 <span class="stringliteral">                    CGI::submit(-name=&gt;&quot;library_advanced&quot;, -value=&gt;&quot;Advanced Search&quot;))</span>
<a name="l00532"></a>00532 <span class="stringliteral">        ),</span>
<a name="l00533"></a>00533 <span class="stringliteral">        CGI::Tr({},</span>
<a name="l00534"></a>00534 <span class="stringliteral">            CGI::td([&quot;Section:&quot;,</span>
<a name="l00535"></a>00535 <span class="stringliteral">            CGI::popup_menu(-name=&gt; &#39;</span>library_sections<span class="stringliteral">&#39;, </span>
<a name="l00536"></a>00536 <span class="stringliteral">                            -values=&gt;\@sects,</span>
<a name="l00537"></a>00537 <span class="stringliteral">                            -default=&gt; $section_selected,</span>
<a name="l00538"></a>00538 <span class="stringliteral">                            -onchange=&gt;&quot;submit();return true&quot;</span>
<a name="l00539"></a>00539 <span class="stringliteral">            )]),</span>
<a name="l00540"></a>00540 <span class="stringliteral">         ),</span>
<a name="l00541"></a>00541 <span class="stringliteral">         CGI::Tr(CGI::td({-colspan=&gt;3}, $view_problem_line)),</span>
<a name="l00542"></a>00542 <span class="stringliteral">         CGI::Tr(CGI::td({-colspan=&gt;3, -align=&gt;&quot;center&quot;}, $count_line)),</span>
<a name="l00543"></a>00543 <span class="stringliteral">         CGI::end_table(),</span>
<a name="l00544"></a>00544 <span class="stringliteral">     ));</span>
<a name="l00545"></a>00545 <span class="stringliteral">    </span>
<a name="l00546"></a>00546 <span class="stringliteral">}</span>
<a name="l00547"></a>00547 <span class="stringliteral"></span>
<a name="l00548"></a>00548 <span class="stringliteral">sub browse_library_panel2adv {</span>
<a name="l00549"></a>00549 <span class="stringliteral">    my $self = shift;</span>
<a name="l00550"></a>00550 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00551"></a>00551 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00552"></a>00552 <span class="stringliteral">    my $right_button_style = &quot;width: 18ex&quot;;</span>
<a name="l00553"></a>00553 <span class="stringliteral"></span>
<a name="l00554"></a>00554 <span class="stringliteral">    my @subjs = WeBWorK::Utils::ListingDB::getAllDBsubjects($r);</span>
<a name="l00555"></a>00555 <span class="stringliteral">    if(! grep { $_ eq $r-&gt;param(&#39;</span>library_subjects<span class="stringliteral">&#39;) } @subjs) {</span>
<a name="l00556"></a>00556 <span class="stringliteral">        $r-&gt;param(&#39;</span>library_subjects<span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;);</span>
<a name="l00557"></a>00557 <span class="stringliteral">    }</span>
<a name="l00558"></a>00558 <span class="stringliteral">    unshift @subjs, LIB2_DATA-&gt;{dbsubject}{all};</span>
<a name="l00559"></a>00559 <span class="stringliteral"></span>
<a name="l00560"></a>00560 <span class="stringliteral">    my @chaps = WeBWorK::Utils::ListingDB::getAllDBchapters($r);</span>
<a name="l00561"></a>00561 <span class="stringliteral">    if(! grep { $_ eq $r-&gt;param(&#39;</span>library_chapters<span class="stringliteral">&#39;) } @chaps) {</span>
<a name="l00562"></a>00562 <span class="stringliteral">        $r-&gt;param(&#39;</span>library_chapters<span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;);</span>
<a name="l00563"></a>00563 <span class="stringliteral">    }</span>
<a name="l00564"></a>00564 <span class="stringliteral">    unshift @chaps, LIB2_DATA-&gt;{dbchapter}{all};</span>
<a name="l00565"></a>00565 <span class="stringliteral"></span>
<a name="l00566"></a>00566 <span class="stringliteral">    my @sects = WeBWorK::Utils::ListingDB::getAllDBsections($r);</span>
<a name="l00567"></a>00567 <span class="stringliteral">    if(! grep { $_ eq $r-&gt;param(&#39;</span>library_sections<span class="stringliteral">&#39;) } @sects) {</span>
<a name="l00568"></a>00568 <span class="stringliteral">        $r-&gt;param(&#39;</span>library_sections<span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;);</span>
<a name="l00569"></a>00569 <span class="stringliteral">    }</span>
<a name="l00570"></a>00570 <span class="stringliteral">    unshift @sects, LIB2_DATA-&gt;{dbsection}{all};</span>
<a name="l00571"></a>00571 <span class="stringliteral"></span>
<a name="l00572"></a>00572 <span class="stringliteral">    my $texts = WeBWorK::Utils::ListingDB::getDBTextbooks($r);</span>
<a name="l00573"></a>00573 <span class="stringliteral">    my @textarray = map { $_-&gt;[0] }  @{$texts};</span>
<a name="l00574"></a>00574 <span class="stringliteral">    my %textlabels = ();</span>
<a name="l00575"></a>00575 <span class="stringliteral">    for my $ta (@{$texts}) {</span>
<a name="l00576"></a>00576 <span class="stringliteral">        $textlabels{$ta-&gt;[0]} = $ta-&gt;[1].&quot; by &quot;.$ta-&gt;[2].&quot; (edition &quot;.$ta-&gt;[3].&quot;)&quot;;</span>
<a name="l00577"></a>00577 <span class="stringliteral">    }</span>
<a name="l00578"></a>00578 <span class="stringliteral">    if(! grep { $_ eq $r-&gt;param(&#39;</span>library_textbook<span class="stringliteral">&#39;) } @textarray) {</span>
<a name="l00579"></a>00579 <span class="stringliteral">        $r-&gt;param(&#39;</span>library_textbook<span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;);</span>
<a name="l00580"></a>00580 <span class="stringliteral">    }</span>
<a name="l00581"></a>00581 <span class="stringliteral">    unshift @textarray, LIB2_DATA-&gt;{textbook}{all};</span>
<a name="l00582"></a>00582 <span class="stringliteral">    my $atb = LIB2_DATA-&gt;{textbook}{all}; $textlabels{$atb} = LIB2_DATA-&gt;{textbook}{all};</span>
<a name="l00583"></a>00583 <span class="stringliteral"></span>
<a name="l00584"></a>00584 <span class="stringliteral">    my $textchap_ref = WeBWorK::Utils::ListingDB::getDBTextbooks($r, &#39;</span>textchapter<span class="stringliteral">&#39;);</span>
<a name="l00585"></a>00585 <span class="stringliteral">    my @textchaps = map { $_-&gt;[0] } @{$textchap_ref};</span>
<a name="l00586"></a>00586 <span class="stringliteral">    if(! grep { $_ eq $r-&gt;param(&#39;</span>library_textchapter<span class="stringliteral">&#39;) } @textchaps) {</span>
<a name="l00587"></a>00587 <span class="stringliteral">        $r-&gt;param(&#39;</span>library_textchapter<span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;);</span>
<a name="l00588"></a>00588 <span class="stringliteral">    }</span>
<a name="l00589"></a>00589 <span class="stringliteral">    unshift @textchaps, LIB2_DATA-&gt;{textchapter}{all};</span>
<a name="l00590"></a>00590 <span class="stringliteral"></span>
<a name="l00591"></a>00591 <span class="stringliteral">    my $textsec_ref = WeBWorK::Utils::ListingDB::getDBTextbooks($r, &#39;</span>textsection<span class="stringliteral">&#39;);</span>
<a name="l00592"></a>00592 <span class="stringliteral">    my @textsecs = map { $_-&gt;[0] } @{$textsec_ref};</span>
<a name="l00593"></a>00593 <span class="stringliteral">    if(! grep { $_ eq $r-&gt;param(&#39;</span>library_textsection<span class="stringliteral">&#39;) } @textsecs) {</span>
<a name="l00594"></a>00594 <span class="stringliteral">        $r-&gt;param(&#39;</span>library_textsection<span class="stringliteral">&#39;, &#39;</span><span class="stringliteral">&#39;);</span>
<a name="l00595"></a>00595 <span class="stringliteral">    }</span>
<a name="l00596"></a>00596 <span class="stringliteral">    unshift @textsecs, LIB2_DATA-&gt;{textsection}{all};</span>
<a name="l00597"></a>00597 <span class="stringliteral"></span>
<a name="l00598"></a>00598 <span class="stringliteral">    my %selected = ();</span>
<a name="l00599"></a>00599 <span class="stringliteral">    for my $j (qw( dbsection dbchapter dbsubject textbook textchapter textsection )) {</span>
<a name="l00600"></a>00600 <span class="stringliteral">        $selected{$j} = $r-&gt;param(LIB2_DATA-&gt;{$j}{name}) || LIB2_DATA-&gt;{$j}{all};</span>
<a name="l00601"></a>00601 <span class="stringliteral">    }</span>
<a name="l00602"></a>00602 <span class="stringliteral"></span>
<a name="l00603"></a>00603 <span class="stringliteral">    my $text_popup = CGI::popup_menu(-name =&gt; &#39;</span>library_textbook<span class="stringliteral">&#39;,</span>
<a name="l00604"></a>00604 <span class="stringliteral">                                     -values =&gt;\@textarray,</span>
<a name="l00605"></a>00605 <span class="stringliteral">                                     -labels =&gt; \%textlabels,</span>
<a name="l00606"></a>00606 <span class="stringliteral">                                     -default=&gt;$selected{textbook},</span>
<a name="l00607"></a>00607 <span class="stringliteral">                                     -onchange=&gt;&quot;submit();return true&quot;);</span>
<a name="l00608"></a>00608 <span class="stringliteral"></span>
<a name="l00609"></a>00609 <span class="stringliteral">    </span>
<a name="l00610"></a>00610 <span class="stringliteral">    my $library_keywords = $r-&gt;param(&#39;</span>library_keywords<span class="stringliteral">&#39;) || &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00611"></a>00611 <span class="stringliteral"></span>
<a name="l00612"></a>00612 <span class="stringliteral">    my $view_problem_line = view_problems_line(&#39;</span>lib_view<span class="stringliteral">&#39;, &#39;</span>View Problems<span class="stringliteral">&#39;, $self-&gt;r);</span>
<a name="l00613"></a>00613 <span class="stringliteral"></span>
<a name="l00614"></a>00614 <span class="stringliteral">    my $count_line = WeBWorK::Utils::ListingDB::countDBListings($r);</span>
<a name="l00615"></a>00615 <span class="stringliteral">    if($count_line==0) {</span>
<a name="l00616"></a>00616 <span class="stringliteral">        $count_line = &quot;There are no matching pg files&quot;;</span>
<a name="l00617"></a>00617 <span class="stringliteral">    } else {</span>
<a name="l00618"></a>00618 <span class="stringliteral">        $count_line = &quot;There are $count_line matching WeBWorK problem files&quot;;</span>
<a name="l00619"></a>00619 <span class="stringliteral">    }</span>
<a name="l00620"></a>00620 <span class="stringliteral"></span>
<a name="l00621"></a>00621 <span class="stringliteral">    print CGI::Tr({},</span>
<a name="l00622"></a>00622 <span class="stringliteral">      CGI::td({-class=&gt;&quot;InfoPanel&quot;, -align=&gt;&quot;left&quot;},</span>
<a name="l00623"></a>00623 <span class="stringliteral">        CGI::hidden(-name=&gt;&quot;library_is_basic&quot;, -default=&gt;2,-override=&gt;1),</span>
<a name="l00624"></a>00624 <span class="stringliteral">        CGI::start_table({-width=&gt;&quot;100%&quot;}),</span>
<a name="l00625"></a>00625 <span class="stringliteral">        # Html done by hand since it is temporary</span>
<a name="l00626"></a>00626 <span class="stringliteral">        CGI::Tr(CGI::td({-colspan=&gt;4, -align=&gt;&quot;center&quot;}, &#39;</span>All Selected Constraints Joined by <span class="stringliteral">&quot;And&quot;</span><span class="stringliteral">&#39;)),</span>
<a name="l00627"></a>00627 <span class="stringliteral">        CGI::Tr({},</span>
<a name="l00628"></a>00628 <span class="stringliteral">            CGI::td([&quot;Subject:&quot;,</span>
<a name="l00629"></a>00629 <span class="stringliteral">                CGI::popup_menu(-name=&gt; &#39;</span>library_subjects<span class="stringliteral">&#39;, </span>
<a name="l00630"></a>00630 <span class="stringliteral">                                -values=&gt;\@subjs,</span>
<a name="l00631"></a>00631 <span class="stringliteral">                                -default=&gt; $selected{dbsubject},</span>
<a name="l00632"></a>00632 <span class="stringliteral">                                 -onchange=&gt;&quot;submit();return true&quot;</span>
<a name="l00633"></a>00633 <span class="stringliteral">                )]),</span>
<a name="l00634"></a>00634 <span class="stringliteral">            CGI::td({-colspan=&gt;2, -align=&gt;&quot;right&quot;},</span>
<a name="l00635"></a>00635 <span class="stringliteral">                CGI::submit(-name=&gt;&quot;lib_select_subject&quot;, -value=&gt;&quot;Update Menus&quot;,</span>
<a name="l00636"></a>00636 <span class="stringliteral">                    -style=&gt; $right_button_style))),</span>
<a name="l00637"></a>00637 <span class="stringliteral">        CGI::Tr({},</span>
<a name="l00638"></a>00638 <span class="stringliteral">            CGI::td([&quot;Chapter:&quot;,</span>
<a name="l00639"></a>00639 <span class="stringliteral">                CGI::popup_menu(-name=&gt; &#39;</span>library_chapters<span class="stringliteral">&#39;, </span>
<a name="l00640"></a>00640 <span class="stringliteral">                                -values=&gt;\@chaps,</span>
<a name="l00641"></a>00641 <span class="stringliteral">                                -default=&gt; $selected{dbchapter},</span>
<a name="l00642"></a>00642 <span class="stringliteral">                                 -onchange=&gt;&quot;submit();return true&quot;</span>
<a name="l00643"></a>00643 <span class="stringliteral">            )]),</span>
<a name="l00644"></a>00644 <span class="stringliteral">            CGI::td({-colspan=&gt;2, -align=&gt;&quot;right&quot;},</span>
<a name="l00645"></a>00645 <span class="stringliteral">                    CGI::submit(-name=&gt;&quot;library_reset&quot;, -value=&gt;&quot;Reset&quot;,</span>
<a name="l00646"></a>00646 <span class="stringliteral">                    -style=&gt;$right_button_style))</span>
<a name="l00647"></a>00647 <span class="stringliteral">        ),</span>
<a name="l00648"></a>00648 <span class="stringliteral">        CGI::Tr({},</span>
<a name="l00649"></a>00649 <span class="stringliteral">            CGI::td([&quot;Section:&quot;,</span>
<a name="l00650"></a>00650 <span class="stringliteral">            CGI::popup_menu(-name=&gt; &#39;</span>library_sections<span class="stringliteral">&#39;, </span>
<a name="l00651"></a>00651 <span class="stringliteral">                            -values=&gt;\@sects,</span>
<a name="l00652"></a>00652 <span class="stringliteral">                            -default=&gt; $selected{dbsection},</span>
<a name="l00653"></a>00653 <span class="stringliteral">                            -onchange=&gt;&quot;submit();return true&quot;</span>
<a name="l00654"></a>00654 <span class="stringliteral">            )]),</span>
<a name="l00655"></a>00655 <span class="stringliteral">            CGI::td({-colspan=&gt;2, -align=&gt;&quot;right&quot;},</span>
<a name="l00656"></a>00656 <span class="stringliteral">                    CGI::submit(-name=&gt;&quot;library_basic&quot;, -value=&gt;&quot;Basic Search&quot;,</span>
<a name="l00657"></a>00657 <span class="stringliteral">                    -style=&gt;$right_button_style))</span>
<a name="l00658"></a>00658 <span class="stringliteral">         ),</span>
<a name="l00659"></a>00659 <span class="stringliteral">         CGI::Tr({},</span>
<a name="l00660"></a>00660 <span class="stringliteral">            CGI::td([&quot;Textbook:&quot;, $text_popup]),</span>
<a name="l00661"></a>00661 <span class="stringliteral">         ),</span>
<a name="l00662"></a>00662 <span class="stringliteral">         CGI::Tr({},</span>
<a name="l00663"></a>00663 <span class="stringliteral">            CGI::td([&quot;Text chapter:&quot;,</span>
<a name="l00664"></a>00664 <span class="stringliteral">            CGI::popup_menu(-name=&gt; &#39;</span>library_textchapter<span class="stringliteral">&#39;, </span>
<a name="l00665"></a>00665 <span class="stringliteral">                            -values=&gt;\@textchaps,</span>
<a name="l00666"></a>00666 <span class="stringliteral">                            -default=&gt; $selected{textchapter},</span>
<a name="l00667"></a>00667 <span class="stringliteral">                            -onchange=&gt;&quot;submit();return true&quot;</span>
<a name="l00668"></a>00668 <span class="stringliteral">            )]),</span>
<a name="l00669"></a>00669 <span class="stringliteral">         ),</span>
<a name="l00670"></a>00670 <span class="stringliteral">         CGI::Tr({},</span>
<a name="l00671"></a>00671 <span class="stringliteral">            CGI::td([&quot;Text section:&quot;,</span>
<a name="l00672"></a>00672 <span class="stringliteral">            CGI::popup_menu(-name=&gt; &#39;</span>library_textsection<span class="stringliteral">&#39;, </span>
<a name="l00673"></a>00673 <span class="stringliteral">                            -values=&gt;\@textsecs,</span>
<a name="l00674"></a>00674 <span class="stringliteral">                            -default=&gt; $selected{textsection},</span>
<a name="l00675"></a>00675 <span class="stringliteral">                            -onchange=&gt;&quot;submit();return true&quot;</span>
<a name="l00676"></a>00676 <span class="stringliteral">            )]),</span>
<a name="l00677"></a>00677 <span class="stringliteral">         ),</span>
<a name="l00678"></a>00678 <span class="stringliteral">         CGI::Tr({},</span>
<a name="l00679"></a>00679 <span class="stringliteral">             CGI::td(&quot;Keywords:&quot;),CGI::td({-colspan=&gt;2},</span>
<a name="l00680"></a>00680 <span class="stringliteral">             CGI::textfield(-name=&gt;&quot;library_keywords&quot;,</span>
<a name="l00681"></a>00681 <span class="stringliteral">                            -default=&gt;$library_keywords,</span>
<a name="l00682"></a>00682 <span class="stringliteral">                            -override=&gt;1,</span>
<a name="l00683"></a>00683 <span class="stringliteral">                            -size=&gt;40))),</span>
<a name="l00684"></a>00684 <span class="stringliteral">         CGI::Tr(CGI::td({-colspan=&gt;3}, $view_problem_line)),</span>
<a name="l00685"></a>00685 <span class="stringliteral">         CGI::Tr(CGI::td({-colspan=&gt;3, -align=&gt;&quot;center&quot;}, $count_line)),</span>
<a name="l00686"></a>00686 <span class="stringliteral">         CGI::end_table(),</span>
<a name="l00687"></a>00687 <span class="stringliteral">     ));</span>
<a name="l00688"></a>00688 <span class="stringliteral">    </span>
<a name="l00689"></a>00689 <span class="stringliteral">}</span>
<a name="l00690"></a>00690 <span class="stringliteral"></span>
<a name="l00691"></a>00691 <span class="stringliteral"></span>
<a name="l00692"></a>00692 <span class="stringliteral">#####    Version 4 is the set definition file panel</span>
<a name="l00693"></a>00693 <span class="stringliteral"></span>
<a name="l00694"></a>00694 <span class="stringliteral">sub browse_setdef_panel {</span>
<a name="l00695"></a>00695 <span class="stringliteral">    my $self = shift;</span>
<a name="l00696"></a>00696 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00697"></a>00697 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00698"></a>00698 <span class="stringliteral">    my $library_selected = shift;</span>
<a name="l00699"></a>00699 <span class="stringliteral">    my $default_value = &quot;Select a Set Definition File&quot;;</span>
<a name="l00700"></a>00700 <span class="stringliteral">    # in the following line, the parens after sort are important. if they are</span>
<a name="l00701"></a>00701 <span class="stringliteral">    # omitted, sort will interpret get_set_defs as the name of the comparison</span>
<a name="l00702"></a>00702 <span class="stringliteral">    # function, and ($ce-&gt;{courseDirs}{templates}) as a single element list to</span>
<a name="l00703"></a>00703 <span class="stringliteral">    # be sorted. *barf*</span>
<a name="l00704"></a>00704 <span class="stringliteral">    my @list_of_set_defs = sort(get_set_defs($ce-&gt;{courseDirs}{templates}));</span>
<a name="l00705"></a>00705 <span class="stringliteral">    if(scalar(@list_of_set_defs) == 0) {</span>
<a name="l00706"></a>00706 <span class="stringliteral">        @list_of_set_defs = (NO_LOCAL_SET_STRING);</span>
<a name="l00707"></a>00707 <span class="stringliteral">    } elsif (not $library_selected or $library_selected eq $default_value) { </span>
<a name="l00708"></a>00708 <span class="stringliteral">        unshift @list_of_set_defs, $default_value; </span>
<a name="l00709"></a>00709 <span class="stringliteral">        $library_selected = $default_value; </span>
<a name="l00710"></a>00710 <span class="stringliteral">    }</span>
<a name="l00711"></a>00711 <span class="stringliteral">    my $view_problem_line = view_problems_line(&#39;</span>view_setdef_set<span class="stringliteral">&#39;, &#39;</span>View Problems<span class="stringliteral">&#39;, $self-&gt;r);</span>
<a name="l00712"></a>00712 <span class="stringliteral">    my $popupetc = CGI::popup_menu(-name=&gt; &#39;</span>library_sets<span class="stringliteral">&#39;,</span>
<a name="l00713"></a>00713 <span class="stringliteral">                                -values=&gt;\@list_of_set_defs,</span>
<a name="l00714"></a>00714 <span class="stringliteral">                                -default=&gt; $library_selected).</span>
<a name="l00715"></a>00715 <span class="stringliteral">        CGI::br().  $view_problem_line;</span>
<a name="l00716"></a>00716 <span class="stringliteral">    if($list_of_set_defs[0] eq NO_LOCAL_SET_STRING) {</span>
<a name="l00717"></a>00717 <span class="stringliteral">        $popupetc = &quot;there are no set definition files in this course to look at.&quot;</span>
<a name="l00718"></a>00718 <span class="stringliteral">    }</span>
<a name="l00719"></a>00719 <span class="stringliteral">    print CGI::Tr(CGI::td({-class=&gt;&quot;InfoPanel&quot;, -align=&gt;&quot;left&quot;}, &quot;Browse from: &quot;,</span>
<a name="l00720"></a>00720 <span class="stringliteral">        $popupetc</span>
<a name="l00721"></a>00721 <span class="stringliteral">    ));</span>
<a name="l00722"></a>00722 <span class="stringliteral">}</span>
<a name="l00723"></a>00723 <span class="stringliteral"></span>
<a name="l00724"></a>00724 <span class="stringliteral">sub make_top_row {</span>
<a name="l00725"></a>00725 <span class="stringliteral">    my $self = shift;</span>
<a name="l00726"></a>00726 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00727"></a>00727 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00728"></a>00728 <span class="stringliteral">    my %data = @_;</span>
<a name="l00729"></a>00729 <span class="stringliteral"></span>
<a name="l00730"></a>00730 <span class="stringliteral">    my $list_of_local_sets = $data{all_db_sets};</span>
<a name="l00731"></a>00731 <span class="stringliteral">    my $have_local_sets = scalar(@$list_of_local_sets);</span>
<a name="l00732"></a>00732 <span class="stringliteral">    my $browse_which = $data{browse_which};</span>
<a name="l00733"></a>00733 <span class="stringliteral">    my $library_selected = $self-&gt;{current_library_set};</span>
<a name="l00734"></a>00734 <span class="stringliteral">    my $set_selected = $r-&gt;param(&#39;</span>local_sets<span class="stringliteral">&#39;);</span>
<a name="l00735"></a>00735 <span class="stringliteral">    my (@dis1, @dis2, @dis3, @dis4) = ();</span>
<a name="l00736"></a>00736 <span class="stringliteral">    @dis1 =  (-disabled=&gt;1) if($browse_which eq &#39;</span>browse_npl_library<span class="stringliteral">&#39;);   </span>
<a name="l00737"></a>00737 <span class="stringliteral">    @dis2 =  (-disabled=&gt;1) if($browse_which eq &#39;</span>browse_local<span class="stringliteral">&#39;);</span>
<a name="l00738"></a>00738 <span class="stringliteral">    @dis3 =  (-disabled=&gt;1) if($browse_which eq &#39;</span>browse_mysets<span class="stringliteral">&#39;);</span>
<a name="l00739"></a>00739 <span class="stringliteral">    @dis4 =  (-disabled=&gt;1) if($browse_which eq &#39;</span>browse_setdefs<span class="stringliteral">&#39;);</span>
<a name="l00740"></a>00740 <span class="stringliteral"></span>
<a name="l00741"></a>00741 <span class="stringliteral">    ##  Make buttons for additional problem libraries</span>
<a name="l00742"></a>00742 <span class="stringliteral">    my $libs = &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00743"></a>00743 <span class="stringliteral">    foreach my $lib (sort(keys(%problib))) {</span>
<a name="l00744"></a>00744 <span class="stringliteral">        $libs .= &#39;</span> <span class="stringliteral">&#39;. CGI::submit(-name=&gt;&quot;browse_$lib&quot;, -value=&gt;$problib{$lib},</span>
<a name="l00745"></a>00745 <span class="stringliteral">                                                                 ($browse_which eq &quot;browse_$lib&quot;)? (-disabled=&gt;1): ())</span>
<a name="l00746"></a>00746 <span class="stringliteral">            if (-d &quot;$ce-&gt;{courseDirs}{templates}/$lib&quot;);</span>
<a name="l00747"></a>00747 <span class="stringliteral">    }</span>
<a name="l00748"></a>00748 <span class="stringliteral">    $libs = CGI::br().&quot;or Problems from&quot;.$libs if $libs ne &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00749"></a>00749 <span class="stringliteral"></span>
<a name="l00750"></a>00750 <span class="stringliteral">    my $these_widths = &quot;width: 24ex&quot;;</span>
<a name="l00751"></a>00751 <span class="stringliteral"></span>
<a name="l00752"></a>00752 <span class="stringliteral">    if($have_local_sets ==0) {</span>
<a name="l00753"></a>00753 <span class="stringliteral">        $list_of_local_sets = [NO_LOCAL_SET_STRING];</span>
<a name="l00754"></a>00754 <span class="stringliteral">    } elsif (not defined($set_selected) or $set_selected eq &quot;&quot;</span>
<a name="l00755"></a>00755 <span class="stringliteral">      or $set_selected eq SELECT_SET_STRING) {</span>
<a name="l00756"></a>00756 <span class="stringliteral">        unshift @{$list_of_local_sets}, SELECT_SET_STRING;</span>
<a name="l00757"></a>00757 <span class="stringliteral">        $set_selected = SELECT_SET_STRING;</span>
<a name="l00758"></a>00758 <span class="stringliteral">    }</span>
<a name="l00759"></a>00759 <span class="stringliteral">    #my $myjs = &#39;</span>document.mainform.selfassign.value=confirm(<span class="stringliteral">&quot;Should I assign the new set to you now?\nUse OK for yes and Cancel for no.&quot;</span>);<span class="keyword">true</span>;<span class="stringliteral">&#39;;</span>
<a name="l00760"></a>00760 <span class="stringliteral"></span>
<a name="l00761"></a>00761 <span class="stringliteral">    print CGI::Tr(CGI::td({-class=&gt;&quot;InfoPanel&quot;, -align=&gt;&quot;left&quot;}, &quot;Add problems to &quot;,</span>
<a name="l00762"></a>00762 <span class="stringliteral">        CGI::b(&quot;Target Set: &quot;),</span>
<a name="l00763"></a>00763 <span class="stringliteral">        CGI::popup_menu(-name=&gt; &#39;</span>local_sets<span class="stringliteral">&#39;, </span>
<a name="l00764"></a>00764 <span class="stringliteral">                        -values=&gt;$list_of_local_sets, </span>
<a name="l00765"></a>00765 <span class="stringliteral">                        -default=&gt; $set_selected,</span>
<a name="l00766"></a>00766 <span class="stringliteral">                        -override=&gt;1),</span>
<a name="l00767"></a>00767 <span class="stringliteral">        CGI::submit(-name=&gt;&quot;edit_local&quot;, -value=&gt;&quot;Edit Target Set&quot;),</span>
<a name="l00768"></a>00768 <span class="stringliteral">        CGI::hidden(-name=&gt;&quot;selfassign&quot;, -default=&gt;0,-override=&gt;1).</span>
<a name="l00769"></a>00769 <span class="stringliteral">        CGI::br(), </span>
<a name="l00770"></a>00770 <span class="stringliteral">        CGI::br(), </span>
<a name="l00771"></a>00771 <span class="stringliteral">        CGI::submit(-name=&gt;&quot;new_local_set&quot;, -value=&gt;&quot;Create a New Set in This Course:&quot;,</span>
<a name="l00772"></a>00772 <span class="stringliteral">        -onclick=&gt;&quot;document.mainform.selfassign.value=1&quot;      #       $myjs</span>
<a name="l00773"></a>00773 <span class="stringliteral">        ),</span>
<a name="l00774"></a>00774 <span class="stringliteral">        &quot;  &quot;,</span>
<a name="l00775"></a>00775 <span class="stringliteral">        CGI::textfield(-name=&gt;&quot;new_set_name&quot;, </span>
<a name="l00776"></a>00776 <span class="stringliteral">                       -default=&gt;&quot;Name for new set here&quot;,</span>
<a name="l00777"></a>00777 <span class="stringliteral">                       -override=&gt;1, -size=&gt;30),</span>
<a name="l00778"></a>00778 <span class="stringliteral">    ));</span>
<a name="l00779"></a>00779 <span class="stringliteral"></span>
<a name="l00780"></a>00780 <span class="stringliteral">    print CGI::Tr(CGI::td({-bgcolor=&gt;&quot;black&quot;}));</span>
<a name="l00781"></a>00781 <span class="stringliteral"></span>
<a name="l00782"></a>00782 <span class="stringliteral">    # Tidy this list up since it is used in two different places</span>
<a name="l00783"></a>00783 <span class="stringliteral">    if ($list_of_local_sets-&gt;[0] eq SELECT_SET_STRING) {</span>
<a name="l00784"></a>00784 <span class="stringliteral">        shift @{$list_of_local_sets};</span>
<a name="l00785"></a>00785 <span class="stringliteral">    }</span>
<a name="l00786"></a>00786 <span class="stringliteral"></span>
<a name="l00787"></a>00787 <span class="stringliteral">    print CGI::Tr(CGI::td({-class=&gt;&quot;InfoPanel&quot;, -align=&gt;&quot;center&quot;},</span>
<a name="l00788"></a>00788 <span class="stringliteral">        &quot;Browse &quot;,</span>
<a name="l00789"></a>00789 <span class="stringliteral">        CGI::submit(-name=&gt;&quot;browse_npl_library&quot;, -value=&gt;&quot;National Problem Library&quot;, -style=&gt;$these_widths, @dis1),</span>
<a name="l00790"></a>00790 <span class="stringliteral">        CGI::submit(-name=&gt;&quot;browse_local&quot;, -value=&gt;&quot;Local Problems&quot;, -style=&gt;$these_widths, @dis2),</span>
<a name="l00791"></a>00791 <span class="stringliteral">        CGI::submit(-name=&gt;&quot;browse_mysets&quot;, -value=&gt;&quot;From This Course&quot;, -style=&gt;$these_widths, @dis3),</span>
<a name="l00792"></a>00792 <span class="stringliteral">        CGI::submit(-name=&gt;&quot;browse_setdefs&quot;, -value=&gt;&quot;Set Definition Files&quot;, -style=&gt;$these_widths, @dis4),</span>
<a name="l00793"></a>00793 <span class="stringliteral">        $libs,</span>
<a name="l00794"></a>00794 <span class="stringliteral">    ));</span>
<a name="l00795"></a>00795 <span class="stringliteral"></span>
<a name="l00796"></a>00796 <span class="stringliteral">    #print CGI::Tr(CGI::td({-bgcolor=&gt;&quot;black&quot;}));</span>
<a name="l00797"></a>00797 <span class="stringliteral">    print CGI::hr();</span>
<a name="l00798"></a>00798 <span class="stringliteral"></span>
<a name="l00799"></a>00799 <span class="stringliteral">    if ($browse_which eq &#39;</span>browse_local<span class="stringliteral">&#39;) {</span>
<a name="l00800"></a>00800 <span class="stringliteral">        $self-&gt;browse_local_panel($library_selected);</span>
<a name="l00801"></a>00801 <span class="stringliteral">    } elsif ($browse_which eq &#39;</span>browse_mysets<span class="stringliteral">&#39;) {</span>
<a name="l00802"></a>00802 <span class="stringliteral">        $self-&gt;browse_mysets_panel($library_selected, $list_of_local_sets);</span>
<a name="l00803"></a>00803 <span class="stringliteral">    } elsif ($browse_which eq &#39;</span>browse_npl_library<span class="stringliteral">&#39;) {</span>
<a name="l00804"></a>00804 <span class="stringliteral">        $self-&gt;browse_library_panel();</span>
<a name="l00805"></a>00805 <span class="stringliteral">    } elsif ($browse_which eq &#39;</span>browse_setdefs<span class="stringliteral">&#39;) {</span>
<a name="l00806"></a>00806 <span class="stringliteral">        $self-&gt;browse_setdef_panel($library_selected);</span>
<a name="l00807"></a>00807 <span class="stringliteral">    } else { ## handle other problem libraries</span>
<a name="l00808"></a>00808 <span class="stringliteral">        $self-&gt;browse_local_panel($library_selected,$browse_which);</span>
<a name="l00809"></a>00809 <span class="stringliteral">    }</span>
<a name="l00810"></a>00810 <span class="stringliteral"></span>
<a name="l00811"></a>00811 <span class="stringliteral">    print CGI::Tr(CGI::td({-bgcolor=&gt;&quot;black&quot;}));</span>
<a name="l00812"></a>00812 <span class="stringliteral"></span>
<a name="l00813"></a>00813 <span class="stringliteral">    # For next/previous buttons</span>
<a name="l00814"></a>00814 <span class="stringliteral">    my ($next_button, $prev_button, $shown_msg) = (&quot;&quot;, &quot;&quot;, &quot;&quot;);</span>
<a name="l00815"></a>00815 <span class="stringliteral">    my $first_shown = $self-&gt;{first_shown};</span>
<a name="l00816"></a>00816 <span class="stringliteral">    my $last_shown = $self-&gt;{last_shown}; </span>
<a name="l00817"></a>00817 <span class="stringliteral">    my @pg_files = @{$self-&gt;{pg_files}};</span>
<a name="l00818"></a>00818 <span class="stringliteral">    if ($first_shown &gt; 0) {</span>
<a name="l00819"></a>00819 <span class="stringliteral">        $prev_button = CGI::submit(-name=&gt;&quot;prev_page&quot;, -style=&gt;&quot;width:15ex&quot;,</span>
<a name="l00820"></a>00820 <span class="stringliteral">                         -value=&gt;&quot;Previous page&quot;);</span>
<a name="l00821"></a>00821 <span class="stringliteral">    }</span>
<a name="l00822"></a>00822 <span class="stringliteral">    if ((1+$last_shown)&lt;scalar(@pg_files)) {</span>
<a name="l00823"></a>00823 <span class="stringliteral">        $next_button = CGI::submit(-name=&gt;&quot;next_page&quot;, -style=&gt;&quot;width:15ex&quot;,</span>
<a name="l00824"></a>00824 <span class="stringliteral">                         -value=&gt;&quot;Next page&quot;);</span>
<a name="l00825"></a>00825 <span class="stringliteral">    }</span>
<a name="l00826"></a>00826 <span class="stringliteral"></span>
<a name="l00827"></a>00827 <span class="stringliteral">    print CGI::Tr({},</span>
<a name="l00828"></a>00828 <span class="stringliteral">            CGI::td({-class=&gt;&quot;InfoPanel&quot;, -align=&gt;&quot;center&quot;},</span>
<a name="l00829"></a>00829 <span class="stringliteral">              CGI::start_table({-border=&gt;&quot;0&quot;}),</span>
<a name="l00830"></a>00830 <span class="stringliteral">                CGI::Tr({}, CGI::td({ -align=&gt;&quot;center&quot;},</span>
<a name="l00831"></a>00831 <span class="stringliteral">                   CGI::submit(-name=&gt;&quot;select_all&quot;, -style=&gt;$these_widths,</span>
<a name="l00832"></a>00832 <span class="stringliteral">                        -value=&gt;&quot;Mark All For Adding&quot;),</span>
<a name="l00833"></a>00833 <span class="stringliteral">                   CGI::submit(-name=&gt;&quot;select_none&quot;, -style=&gt;$these_widths,</span>
<a name="l00834"></a>00834 <span class="stringliteral">                        -value=&gt;&quot;Clear All Marks&quot;),</span>
<a name="l00835"></a>00835 <span class="stringliteral">                   CGI::submit(-name=&gt;&quot;cleardisplay&quot;, </span>
<a name="l00836"></a>00836 <span class="stringliteral">                        -style=&gt;$these_widths,</span>
<a name="l00837"></a>00837 <span class="stringliteral">                        -value=&gt;&quot;Clear Problem Display&quot;)</span>
<a name="l00838"></a>00838 <span class="stringliteral">             )), </span>
<a name="l00839"></a>00839 <span class="stringliteral">        CGI::Tr({}, </span>
<a name="l00840"></a>00840 <span class="stringliteral">         CGI::td({},</span>
<a name="l00841"></a>00841 <span class="stringliteral">            CGI::submit(-name=&gt;&quot;update&quot;, -style=&gt;$these_widths. &quot;; font-weight:bold&quot;,</span>
<a name="l00842"></a>00842 <span class="stringliteral">                        -value=&gt;&quot;Update Set&quot;),</span>
<a name="l00843"></a>00843 <span class="stringliteral"></span>
<a name="l00844"></a>00844 <span class="stringliteral">            $prev_button, &quot; &quot;, $next_button,</span>
<a name="l00845"></a>00845 <span class="stringliteral"></span>
<a name="l00846"></a>00846 <span class="stringliteral">            CGI::submit(-name=&gt;&quot;rerandomize&quot;, </span>
<a name="l00847"></a>00847 <span class="stringliteral">                        -style=&gt;$these_widths,</span>
<a name="l00848"></a>00848 <span class="stringliteral">                        -value=&gt;&quot;Rerandomize&quot;),</span>
<a name="l00849"></a>00849 <span class="stringliteral">    )), </span>
<a name="l00850"></a>00850 <span class="stringliteral">    CGI::end_table()));</span>
<a name="l00851"></a>00851 <span class="stringliteral">}</span>
<a name="l00852"></a>00852 <span class="stringliteral"></span>
<a name="l00853"></a>00853 <span class="stringliteral">sub make_data_row {</span>
<a name="l00854"></a>00854 <span class="stringliteral">    my $self = shift;</span>
<a name="l00855"></a>00855 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00856"></a>00856 <span class="stringliteral">    my $sourceFileName = shift;</span>
<a name="l00857"></a>00857 <span class="stringliteral">    my $pg = shift;</span>
<a name="l00858"></a>00858 <span class="stringliteral">    my $cnt = shift;</span>
<a name="l00859"></a>00859 <span class="stringliteral">    my $mark = shift || 0;</span>
<a name="l00860"></a>00860 <span class="stringliteral"></span>
<a name="l00861"></a>00861 <span class="stringliteral">    $sourceFileName =~ s|^./||; # clean up top ugliness</span>
<a name="l00862"></a>00862 <span class="stringliteral"></span>
<a name="l00863"></a>00863 <span class="stringliteral">    my $urlpath = $self-&gt;r-&gt;urlpath;</span>
<a name="l00864"></a>00864 <span class="stringliteral">    my $db = $self-&gt;r-&gt;db;</span>
<a name="l00865"></a>00865 <span class="stringliteral"></span>
<a name="l00866"></a>00866 <span class="stringliteral">    ## to set up edit and try links elegantly we want to know if</span>
<a name="l00867"></a>00867 <span class="stringliteral">    ##    any target set is a gateway assignment or not</span>
<a name="l00868"></a>00868 <span class="stringliteral">    my $localSet = $self-&gt;r-&gt;param(&#39;</span>local_sets<span class="stringliteral">&#39;);</span>
<a name="l00869"></a>00869 <span class="stringliteral">    my $setRecord;</span>
<a name="l00870"></a>00870 <span class="stringliteral">    if ( defined($localSet) &amp;&amp; $localSet ne SELECT_SET_STRING &amp;&amp;</span>
<a name="l00871"></a>00871 <span class="stringliteral">         $localSet ne NO_LOCAL_SET_STRING ) {</span>
<a name="l00872"></a>00872 <span class="stringliteral">        $setRecord = $db-&gt;getGlobalSet( $localSet );</span>
<a name="l00873"></a>00873 <span class="stringliteral">    }</span>
<a name="l00874"></a>00874 <span class="stringliteral">    my $isGatewaySet = ( defined($setRecord) &amp;&amp; </span>
<a name="l00875"></a>00875 <span class="stringliteral">                 $setRecord-&gt;assignment_type =~ /gateway/ );</span>
<a name="l00876"></a>00876 <span class="stringliteral"></span>
<a name="l00877"></a>00877 <span class="stringliteral">    my $problem_output = $pg-&gt;{flags}-&gt;{error_flag} ?</span>
<a name="l00878"></a>00878 <span class="stringliteral">        CGI::div({class=&gt;&quot;ResultsWithError&quot;}, CGI::em(&quot;This problem produced an error&quot;))</span>
<a name="l00879"></a>00879 <span class="stringliteral">        : CGI::div({class=&gt;&quot;RenderSolo&quot;}, $pg-&gt;{body_text});</span>
<a name="l00880"></a>00880 <span class="stringliteral">    $problem_output .= $pg-&gt;{flags}-&gt;{comment} if($pg-&gt;{flags}-&gt;{comment});</span>
<a name="l00881"></a>00881 <span class="stringliteral"></span>
<a name="l00882"></a>00882 <span class="stringliteral"></span>
<a name="l00883"></a>00883 <span class="stringliteral">    #if($self-&gt;{r}-&gt;param(&#39;</span>browse_which<span class="stringliteral">&#39;) ne &#39;</span>browse_npl_library<span class="stringliteral">&#39;) {</span>
<a name="l00884"></a>00884 <span class="stringliteral">    my $problem_seed = $self-&gt;{&#39;</span>problem_seed<span class="stringliteral">&#39;} || 1234;</span>
<a name="l00885"></a>00885 <span class="stringliteral">    my $edit_link = CGI::a({href=&gt;$self-&gt;systemLink(</span>
<a name="l00886"></a>00886 <span class="stringliteral">         $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Instructor::PGProblemEditor&quot;, $r, </span>
<a name="l00887"></a>00887 <span class="stringliteral">              courseID =&gt;$urlpath-&gt;arg(&quot;courseID&quot;),</span>
<a name="l00888"></a>00888 <span class="stringliteral">              setID=&gt;&quot;Undefined_Set&quot;,</span>
<a name="l00889"></a>00889 <span class="stringliteral">              problemID=&gt;&quot;1&quot;),</span>
<a name="l00890"></a>00890 <span class="stringliteral">            params=&gt;{sourceFilePath =&gt; &quot;$sourceFileName&quot;, problemSeed=&gt; $problem_seed}</span>
<a name="l00891"></a>00891 <span class="stringliteral">          ), target=&gt;&quot;WW_Editor&quot;}, &quot;Edit it&quot; );</span>
<a name="l00892"></a>00892 <span class="stringliteral">    </span>
<a name="l00893"></a>00893 <span class="stringliteral">    my $displayMode = $self-&gt;r-&gt;param(&quot;mydisplayMode&quot;);</span>
<a name="l00894"></a>00894 <span class="stringliteral">    $displayMode = $self-&gt;r-&gt;ce-&gt;{pg}-&gt;{options}-&gt;{displayMode}</span>
<a name="l00895"></a>00895 <span class="stringliteral">        if not defined $displayMode or $displayMode eq &quot;None&quot;;</span>
<a name="l00896"></a>00896 <span class="stringliteral">    my $module = ( $isGatewaySet ) ? &quot;GatewayQuiz&quot; : &quot;Problem&quot;;</span>
<a name="l00897"></a>00897 <span class="stringliteral">    my %pathArgs = ( courseID =&gt;$urlpath-&gt;arg(&quot;courseID&quot;),</span>
<a name="l00898"></a>00898 <span class="stringliteral">            setID=&gt;&quot;Undefined_Set&quot; );</span>
<a name="l00899"></a>00899 <span class="stringliteral">    $pathArgs{problemID} = &quot;1&quot; if ( ! $isGatewaySet );</span>
<a name="l00900"></a>00900 <span class="stringliteral"></span>
<a name="l00901"></a>00901 <span class="stringliteral">    my $try_link = CGI::a({href=&gt;$self-&gt;systemLink(</span>
<a name="l00902"></a>00902 <span class="stringliteral">        $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::$module&quot;, $r, </span>
<a name="l00903"></a>00903 <span class="stringliteral">            %pathArgs ),</span>
<a name="l00904"></a>00904 <span class="stringliteral">            params =&gt;{</span>
<a name="l00905"></a>00905 <span class="stringliteral">                effectiveUser =&gt; scalar($self-&gt;r-&gt;param(&#39;</span>user<span class="stringliteral">&#39;)),</span>
<a name="l00906"></a>00906 <span class="stringliteral">                editMode =&gt; &quot;SetMaker&quot;,</span>
<a name="l00907"></a>00907 <span class="stringliteral">                problemSeed=&gt; $problem_seed,</span>
<a name="l00908"></a>00908 <span class="stringliteral">                sourceFilePath =&gt; &quot;$sourceFileName&quot;,</span>
<a name="l00909"></a>00909 <span class="stringliteral">                displayMode =&gt; $displayMode,</span>
<a name="l00910"></a>00910 <span class="stringliteral">            }</span>
<a name="l00911"></a>00911 <span class="stringliteral">        ), target=&gt;&quot;WW_View&quot;}, &quot;Try it&quot;);</span>
<a name="l00912"></a>00912 <span class="stringliteral"></span>
<a name="l00913"></a>00913 <span class="stringliteral">    my %add_box_data = ( -name=&gt;&quot;trial$cnt&quot;,-value=&gt;1,-label=&gt;&quot;Add this problem to the target set on the next update&quot;);</span>
<a name="l00914"></a>00914 <span class="stringliteral">    if($mark &amp; SUCCESS) {</span>
<a name="l00915"></a>00915 <span class="stringliteral">        $add_box_data{ -label } .= &quot; (just added this problem)&quot;;</span>
<a name="l00916"></a>00916 <span class="stringliteral">    } elsif($mark &amp; ADDED) {</span>
<a name="l00917"></a>00917 <span class="stringliteral">        $add_box_data{ -checked } = 1;</span>
<a name="l00918"></a>00918 <span class="stringliteral">    }</span>
<a name="l00919"></a>00919 <span class="stringliteral"></span>
<a name="l00920"></a>00920 <span class="stringliteral">    my $inSet = ($self-&gt;{isInSet}{$sourceFileName})?</span>
<a name="l00921"></a>00921 <span class="stringliteral">        CGI::span({-style=&gt;&quot;float:right; text-align: right&quot;},</span>
<a name="l00922"></a>00922 <span class="stringliteral">          CGI::i(CGI::b(&quot;(This problem is in the target set)&quot;))) : &quot;&quot;;</span>
<a name="l00923"></a>00923 <span class="stringliteral"></span>
<a name="l00924"></a>00924 <span class="stringliteral">    print CGI::Tr({-align=&gt;&quot;left&quot;}, CGI::td(</span>
<a name="l00925"></a>00925 <span class="stringliteral">        CGI::div({-style=&gt;&quot;background-color: #DDDDDD; margin: 0px auto&quot;},</span>
<a name="l00926"></a>00926 <span class="stringliteral">            CGI::span({-style=&gt;&quot;float:left ; text-align: left&quot;},&quot;File name: $sourceFileName &quot;), </span>
<a name="l00927"></a>00927 <span class="stringliteral">            CGI::span({-style=&gt;&quot;float:right ; text-align: right&quot;}, $edit_link, &quot; &quot;, $try_link)</span>
<a name="l00928"></a>00928 <span class="stringliteral">        ), CGI::br(),</span>
<a name="l00929"></a>00929 <span class="stringliteral">        CGI::checkbox(-name=&gt;&quot;hideme$cnt&quot;,-value=&gt;1,-label=&gt;&quot;Don&#39;</span>t show <span class="keyword">this</span> problem on the next update<span class="stringliteral">&quot;,-override=&gt;1),</span>
<a name="l00930"></a>00930 <span class="stringliteral">        CGI::br(),</span>
<a name="l00931"></a>00931 <span class="stringliteral">        $inSet,</span>
<a name="l00932"></a>00932 <span class="stringliteral">        CGI::checkbox((%add_box_data),-override=&gt;1),</span>
<a name="l00933"></a>00933 <span class="stringliteral">        CGI::hidden(-name=&gt;&quot;</span>filetrial$cnt<span class="stringliteral">&quot;, -default=&gt;$sourceFileName,-override=&gt;1).</span>
<a name="l00934"></a>00934 <span class="stringliteral">        CGI::p($problem_output),</span>
<a name="l00935"></a>00935 <span class="stringliteral">    ));</span>
<a name="l00936"></a>00936 <span class="stringliteral">}</span>
<a name="l00937"></a>00937 <span class="stringliteral"></span>
<a name="l00938"></a>00938 <span class="stringliteral">sub clear_default {</span>
<a name="l00939"></a>00939 <span class="stringliteral">    my $r = shift;</span>
<a name="l00940"></a>00940 <span class="stringliteral">    my $param = shift;</span>
<a name="l00941"></a>00941 <span class="stringliteral">    my $default = shift;</span>
<a name="l00942"></a>00942 <span class="stringliteral">    my $newvalue = $r-&gt;param($param) || &#39;&#39;;</span>
<a name="l00943"></a>00943 <span class="stringliteral">    $newvalue = &#39;&#39; if($newvalue eq $default);</span>
<a name="l00944"></a>00944 <span class="stringliteral">    $r-&gt;param($param, $newvalue);</span>
<a name="l00945"></a>00945 <span class="stringliteral">}</span>
<a name="l00946"></a>00946 <span class="stringliteral"></span>
<a name="l00947"></a>00947 <span class="stringliteral">sub pre_header_initialize {</span>
<a name="l00948"></a>00948 <span class="stringliteral">    my ($self) = @_;</span>
<a name="l00949"></a>00949 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00950"></a>00950 <span class="stringliteral">    ## For all cases, lets set some things</span>
<a name="l00951"></a>00951 <span class="stringliteral">    $self-&gt;{error}=0;</span>
<a name="l00952"></a>00952 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00953"></a>00953 <span class="stringliteral">    my $db = $r-&gt;db;</span>
<a name="l00954"></a>00954 <span class="stringliteral">    my $maxShown = $r-&gt;param(&#39;max_shown&#39;) || MAX_SHOW_DEFAULT;</span>
<a name="l00955"></a>00955 <span class="stringliteral">    $maxShown = 10000000 if($maxShown eq &#39;All&#39;); # let&#39;s hope there aren&#39;t more</span>
<a name="l00956"></a>00956 <span class="stringliteral">    my $library_basic = $r-&gt;param(&#39;library_is_basic&#39;) || 1;</span>
<a name="l00957"></a>00957 <span class="stringliteral">    $self-&gt;{problem_seed} = $r-&gt;param(&#39;problem_seed&#39;) || 1234;</span>
<a name="l00958"></a>00958 <span class="stringliteral">    ## Fix some parameters</span>
<a name="l00959"></a>00959 <span class="stringliteral">    for my $key (keys(%{ LIB2_DATA() })) {</span>
<a name="l00960"></a>00960 <span class="stringliteral">        clear_default($r, LIB2_DATA-&gt;{$key}-&gt;{name}, LIB2_DATA-&gt;{$key}-&gt;{all} );</span>
<a name="l00961"></a>00961 <span class="stringliteral">    }</span>
<a name="l00962"></a>00962 <span class="stringliteral">    ##  Grab library sets to display from parameters list.  We will modify this</span>
<a name="l00963"></a>00963 <span class="stringliteral">    ##  as we go through the if/else tree</span>
<a name="l00964"></a>00964 <span class="stringliteral">    $self-&gt;{current_library_set} =  $r-&gt;param(&#39;library_sets&#39;);</span>
<a name="l00965"></a>00965 <span class="stringliteral">    </span>
<a name="l00966"></a>00966 <span class="stringliteral">    ##  These directories will have individual buttons</span>
<a name="l00967"></a>00967 <span class="stringliteral">    %problib = %{$ce-&gt;{courseFiles}{problibs}} if $ce-&gt;{courseFiles}{problibs};</span>
<a name="l00968"></a>00968 <span class="stringliteral"></span>
<a name="l00969"></a>00969 <span class="stringliteral">    my $userName = $r-&gt;param(&#39;user&#39;);</span>
<a name="l00970"></a>00970 <span class="stringliteral">    my $user = $db-&gt;getUser($userName); # checked </span>
<a name="l00971"></a>00971 <span class="stringliteral">    die &quot;</span>record <span class="keywordflow">for</span> user $userName (real user) does not exist.<span class="stringliteral">&quot; </span>
<a name="l00972"></a>00972 <span class="stringliteral">        unless defined $user;</span>
<a name="l00973"></a>00973 <span class="stringliteral">    my $authz = $r-&gt;authz;</span>
<a name="l00974"></a>00974 <span class="stringliteral">    unless ($authz-&gt;hasPermissions($userName, &quot;</span>modify_problem_sets<span class="stringliteral">&quot;)) {</span>
<a name="l00975"></a>00975 <span class="stringliteral">        return(&quot;</span><span class="stringliteral">&quot;); # Error message already produced in the body</span>
<a name="l00976"></a>00976 <span class="stringliteral">    }</span>
<a name="l00977"></a>00977 <span class="stringliteral"></span>
<a name="l00978"></a>00978 <span class="stringliteral">    ## Now one action we have to deal with here</span>
<a name="l00979"></a>00979 <span class="stringliteral">    if ($r-&gt;param(&#39;edit_local&#39;)) {</span>
<a name="l00980"></a>00980 <span class="stringliteral">        my $urlpath = $r-&gt;urlpath;</span>
<a name="l00981"></a>00981 <span class="stringliteral">        my $db = $r-&gt;db;</span>
<a name="l00982"></a>00982 <span class="stringliteral">        my $checkset = $db-&gt;getGlobalSet($r-&gt;param(&#39;local_sets&#39;));</span>
<a name="l00983"></a>00983 <span class="stringliteral">        if (not defined($checkset)) {</span>
<a name="l00984"></a>00984 <span class="stringliteral">            $self-&gt;{error} = 1;</span>
<a name="l00985"></a>00985 <span class="stringliteral">            $self-&gt;addbadmessage(&#39;You need to select a &quot;</span>Target Set<span class="stringliteral">&quot; before you can edit it.&#39;);</span>
<a name="l00986"></a>00986 <span class="stringliteral">        } else {</span>
<a name="l00987"></a>00987 <span class="stringliteral">            my $page = $urlpath-&gt;newFromModule(&#39;WeBWorK::ContentGenerator::Instructor::ProblemSetDetail&#39;,  $r, setID=&gt;$r-&gt;param(&#39;local_sets&#39;), courseID=&gt;$urlpath-&gt;arg(&quot;</span>courseID<span class="stringliteral">&quot;));</span>
<a name="l00988"></a>00988 <span class="stringliteral">            my $url = $self-&gt;systemLink($page);</span>
<a name="l00989"></a>00989 <span class="stringliteral">            $self-&gt;reply_with_redirect($url);</span>
<a name="l00990"></a>00990 <span class="stringliteral">        }</span>
<a name="l00991"></a>00991 <span class="stringliteral">    }</span>
<a name="l00992"></a>00992 <span class="stringliteral"></span>
<a name="l00993"></a>00993 <span class="stringliteral">    ## Next, lots of set up so that errors can be reported with message()</span>
<a name="l00994"></a>00994 <span class="stringliteral"></span>
<a name="l00995"></a>00995 <span class="stringliteral">    ############# List of problems we have already printed</span>
<a name="l00996"></a>00996 <span class="stringliteral"></span>
<a name="l00997"></a>00997 <span class="stringliteral">    $self-&gt;{past_problems} = get_past_problem_files($r);</span>
<a name="l00998"></a>00998 <span class="stringliteral">    # if we don&#39;t end up reusing problems, this will be wiped out</span>
<a name="l00999"></a>00999 <span class="stringliteral">    # if we do redisplay the same problems, we must adjust this accordingly</span>
<a name="l01000"></a>01000 <span class="stringliteral">    my @past_marks = map {$_-&gt;[1]} @{$self-&gt;{past_problems}};</span>
<a name="l01001"></a>01001 <span class="stringliteral">    my $none_shown = scalar(@{$self-&gt;{past_problems}})==0;</span>
<a name="l01002"></a>01002 <span class="stringliteral">    my @pg_files=();</span>
<a name="l01003"></a>01003 <span class="stringliteral">    my $use_previous_problems = 1;</span>
<a name="l01004"></a>01004 <span class="stringliteral">    my $first_shown = $r-&gt;param(&#39;first_shown&#39;) || 0;</span>
<a name="l01005"></a>01005 <span class="stringliteral">    my $last_shown = $r-&gt;param(&#39;last_shown&#39;); </span>
<a name="l01006"></a>01006 <span class="stringliteral">    if (not defined($last_shown)) {</span>
<a name="l01007"></a>01007 <span class="stringliteral">        $last_shown = -1; </span>
<a name="l01008"></a>01008 <span class="stringliteral">    }</span>
<a name="l01009"></a>01009 <span class="stringliteral">    my @all_past_list = (); # these are include requested, but not shown</span>
<a name="l01010"></a>01010 <span class="stringliteral">    my $j = 0;</span>
<a name="l01011"></a>01011 <span class="stringliteral">    while (defined($r-&gt;param(&quot;</span>all_past_list$j<span class="stringliteral">&quot;))) {</span>
<a name="l01012"></a>01012 <span class="stringliteral">        push @all_past_list, $r-&gt;param(&quot;</span>all_past_list$j<span class="stringliteral">&quot;);</span>
<a name="l01013"></a>01013 <span class="stringliteral">        $j++;</span>
<a name="l01014"></a>01014 <span class="stringliteral">    }</span>
<a name="l01015"></a>01015 <span class="stringliteral"></span>
<a name="l01016"></a>01016 <span class="stringliteral">    ############# Default of which problem selector to display</span>
<a name="l01017"></a>01017 <span class="stringliteral"></span>
<a name="l01018"></a>01018 <span class="stringliteral">    my $browse_which = $r-&gt;param(&#39;browse_which&#39;) || &#39;browse_npl_library&#39;;</span>
<a name="l01019"></a>01019 <span class="stringliteral"></span>
<a name="l01020"></a>01020 <span class="stringliteral">    </span>
<a name="l01021"></a>01021 <span class="stringliteral"></span>
<a name="l01022"></a>01022 <span class="stringliteral">    ## check for problem lib buttons</span>
<a name="l01023"></a>01023 <span class="stringliteral">    my $browse_lib = &#39;&#39;;</span>
<a name="l01024"></a>01024 <span class="stringliteral">    foreach my $lib (keys %problib) {</span>
<a name="l01025"></a>01025 <span class="stringliteral">        if ($r-&gt;param(&quot;</span>browse_$lib<span class="stringliteral">&quot;)) {</span>
<a name="l01026"></a>01026 <span class="stringliteral">            $browse_lib = &quot;</span>browse_$lib<span class="stringliteral">&quot;;</span>
<a name="l01027"></a>01027 <span class="stringliteral">            last;</span>
<a name="l01028"></a>01028 <span class="stringliteral">        }</span>
<a name="l01029"></a>01029 <span class="stringliteral">    }</span>
<a name="l01030"></a>01030 <span class="stringliteral"></span>
<a name="l01031"></a>01031 <span class="stringliteral">    ########### Start the logic through if elsif elsif ...</span>
<a name="l01032"></a>01032 <span class="stringliteral">    debug(&quot;</span>browse_lib<span class="stringliteral">&quot;, $r-&gt;param(&quot;</span>$browse_lib<span class="stringliteral">&quot;));</span>
<a name="l01033"></a>01033 <span class="stringliteral">    debug(&quot;</span>browse_npl_library<span class="stringliteral">&quot;, $r-&gt;param(&quot;</span>browse_npl_library<span class="stringliteral">&quot;));</span>
<a name="l01034"></a>01034 <span class="stringliteral">    debug(&quot;</span>browse_mysets<span class="stringliteral">&quot;, $r-&gt;param(&quot;</span>browse_mysets<span class="stringliteral">&quot;));</span>
<a name="l01035"></a>01035 <span class="stringliteral">    debug(&quot;</span>browse_setdefs<span class="stringliteral">&quot;, $r-&gt;param(&quot;</span>browse_setdefs<span class="stringliteral">&quot;));</span>
<a name="l01036"></a>01036 <span class="stringliteral">    ##### Asked to browse certain problems</span>
<a name="l01037"></a>01037 <span class="stringliteral">    if ($browse_lib ne &#39;&#39;) {</span>
<a name="l01038"></a>01038 <span class="stringliteral">        $browse_which = $browse_lib;</span>
<a name="l01039"></a>01039 <span class="stringliteral">        $self-&gt;{current_library_set} = &quot;</span><span class="stringliteral">&quot;;</span>
<a name="l01040"></a>01040 <span class="stringliteral">        $use_previous_problems = 0; @pg_files = (); ## clear old problems</span>
<a name="l01041"></a>01041 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;browse_npl_library&#39;)) {</span>
<a name="l01042"></a>01042 <span class="stringliteral">        $browse_which = &#39;browse_npl_library&#39;;</span>
<a name="l01043"></a>01043 <span class="stringliteral">        $self-&gt;{current_library_set} = &quot;</span><span class="stringliteral">&quot;;</span>
<a name="l01044"></a>01044 <span class="stringliteral">        $use_previous_problems = 0; @pg_files = (); ## clear old problems</span>
<a name="l01045"></a>01045 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;browse_local&#39;)) {</span>
<a name="l01046"></a>01046 <span class="stringliteral">        $browse_which = &#39;browse_local&#39;;</span>
<a name="l01047"></a>01047 <span class="stringliteral">        #$self-&gt;{current_library_set} = &quot;</span><span class="stringliteral">&quot;;</span>
<a name="l01048"></a>01048 <span class="stringliteral">        $use_previous_problems = 0; @pg_files = (); ## clear old problems</span>
<a name="l01049"></a>01049 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;browse_mysets&#39;)) {</span>
<a name="l01050"></a>01050 <span class="stringliteral">        $browse_which = &#39;browse_mysets&#39;;</span>
<a name="l01051"></a>01051 <span class="stringliteral">        $self-&gt;{current_library_set} = &quot;</span><span class="stringliteral">&quot;;</span>
<a name="l01052"></a>01052 <span class="stringliteral">        $use_previous_problems = 0; @pg_files = (); ## clear old problems</span>
<a name="l01053"></a>01053 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;browse_setdefs&#39;)) {</span>
<a name="l01054"></a>01054 <span class="stringliteral">        $browse_which = &#39;browse_setdefs&#39;;</span>
<a name="l01055"></a>01055 <span class="stringliteral">        $self-&gt;{current_library_set} = &quot;</span><span class="stringliteral">&quot;;</span>
<a name="l01056"></a>01056 <span class="stringliteral">        $use_previous_problems = 0; @pg_files = (); ## clear old problems</span>
<a name="l01057"></a>01057 <span class="stringliteral"></span>
<a name="l01058"></a>01058 <span class="stringliteral">        ##### Change the seed value</span>
<a name="l01059"></a>01059 <span class="stringliteral"></span>
<a name="l01060"></a>01060 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;rerandomize&#39;)) {</span>
<a name="l01061"></a>01061 <span class="stringliteral">        $self-&gt;{problem_seed}= 1+$self-&gt;{problem_seed};</span>
<a name="l01062"></a>01062 <span class="stringliteral">        #$r-&gt;param(&#39;problem_seed&#39;, $problem_seed);</span>
<a name="l01063"></a>01063 <span class="stringliteral">        $self-&gt;addbadmessage(&#39;Changing the problem seed for display, but there are no problems showing.&#39;) if $none_shown;</span>
<a name="l01064"></a>01064 <span class="stringliteral"></span>
<a name="l01065"></a>01065 <span class="stringliteral">        ##### Clear the display</span>
<a name="l01066"></a>01066 <span class="stringliteral"></span>
<a name="l01067"></a>01067 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;cleardisplay&#39;)) {</span>
<a name="l01068"></a>01068 <span class="stringliteral">        @pg_files = ();</span>
<a name="l01069"></a>01069 <span class="stringliteral">        $use_previous_problems=0;</span>
<a name="l01070"></a>01070 <span class="stringliteral">        $self-&gt;addbadmessage(&#39;The display was already cleared.&#39;) if $none_shown;</span>
<a name="l01071"></a>01071 <span class="stringliteral"></span>
<a name="l01072"></a>01072 <span class="stringliteral">        ##### View problems selected from the local list</span>
<a name="l01073"></a>01073 <span class="stringliteral"></span>
<a name="l01074"></a>01074 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;view_local_set&#39;)) {</span>
<a name="l01075"></a>01075 <span class="stringliteral"></span>
<a name="l01076"></a>01076 <span class="stringliteral">        my $set_to_display = $self-&gt;{current_library_set};</span>
<a name="l01077"></a>01077 <span class="stringliteral">        if (not defined($set_to_display) or $set_to_display eq SELECT_LOCAL_STRING or $set_to_display eq &quot;</span>Found no directories containing problems<span class="stringliteral">&quot;) {</span>
<a name="l01078"></a>01078 <span class="stringliteral">            $self-&gt;addbadmessage(&#39;You need to select a set to view.&#39;);</span>
<a name="l01079"></a>01079 <span class="stringliteral">        } else {</span>
<a name="l01080"></a>01080 <span class="stringliteral">            $set_to_display = &#39;.&#39; if $set_to_display eq MY_PROBLEMS;</span>
<a name="l01081"></a>01081 <span class="stringliteral">            $set_to_display = substr($browse_which,7) if $set_to_display eq MAIN_PROBLEMS;</span>
<a name="l01082"></a>01082 <span class="stringliteral">            @pg_files = list_pg_files($ce-&gt;{courseDirs}-&gt;{templates},</span>
<a name="l01083"></a>01083 <span class="stringliteral">                &quot;</span>$set_to_display<span class="stringliteral">&quot;);</span>
<a name="l01084"></a>01084 <span class="stringliteral">            $use_previous_problems=0;</span>
<a name="l01085"></a>01085 <span class="stringliteral">        }</span>
<a name="l01086"></a>01086 <span class="stringliteral"></span>
<a name="l01087"></a>01087 <span class="stringliteral">        ##### View problems selected from the a set in this course</span>
<a name="l01088"></a>01088 <span class="stringliteral"></span>
<a name="l01089"></a>01089 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;view_mysets_set&#39;)) {</span>
<a name="l01090"></a>01090 <span class="stringliteral"></span>
<a name="l01091"></a>01091 <span class="stringliteral">        my $set_to_display = $self-&gt;{current_library_set};</span>
<a name="l01092"></a>01092 <span class="stringliteral">        debug(&quot;</span>set_to_display is $set_to_display<span class="stringliteral">&quot;);</span>
<a name="l01093"></a>01093 <span class="stringliteral">        if (not defined($set_to_display) </span>
<a name="l01094"></a>01094 <span class="stringliteral">                or $set_to_display eq &quot;</span>Select a Homework Set<span class="stringliteral">&quot;</span>
<a name="l01095"></a>01095 <span class="stringliteral">                or $set_to_display eq NO_LOCAL_SET_STRING) {</span>
<a name="l01096"></a>01096 <span class="stringliteral">            $self-&gt;addbadmessage(&quot;</span>You need to select a <span class="keyword">set</span> from <span class="keyword">this</span> course to view.<span class="stringliteral">&quot;);</span>
<a name="l01097"></a>01097 <span class="stringliteral">        } else {</span>
<a name="l01098"></a>01098 <span class="stringliteral">            # DBFIXME don&#39;t use ID list, use an iterator</span>
<a name="l01099"></a>01099 <span class="stringliteral">            my @problemList = $db-&gt;listGlobalProblems($set_to_display);</span>
<a name="l01100"></a>01100 <span class="stringliteral">            my $problem;</span>
<a name="l01101"></a>01101 <span class="stringliteral">            @pg_files=();</span>
<a name="l01102"></a>01102 <span class="stringliteral">            for $problem (@problemList) {</span>
<a name="l01103"></a>01103 <span class="stringliteral">                my $problemRecord = $db-&gt;getGlobalProblem($set_to_display, $problem); # checked</span>
<a name="l01104"></a>01104 <span class="stringliteral">                die &quot;</span>global $problem <span class="keywordflow">for</span> <span class="keyword">set</span> $set_to_display not found.<span class="stringliteral">&quot; unless</span>
<a name="l01105"></a>01105 <span class="stringliteral">                    $problemRecord;</span>
<a name="l01106"></a>01106 <span class="stringliteral">                push @pg_files, $problemRecord-&gt;source_file;</span>
<a name="l01107"></a>01107 <span class="stringliteral"></span>
<a name="l01108"></a>01108 <span class="stringliteral">            }</span>
<a name="l01109"></a>01109 <span class="stringliteral">            @pg_files = sortByName(undef,@pg_files);</span>
<a name="l01110"></a>01110 <span class="stringliteral">            $use_previous_problems=0;</span>
<a name="l01111"></a>01111 <span class="stringliteral">        }</span>
<a name="l01112"></a>01112 <span class="stringliteral"></span>
<a name="l01113"></a>01113 <span class="stringliteral">        ##### View from the library database</span>
<a name="l01114"></a>01114 <span class="stringliteral"> </span>
<a name="l01115"></a>01115 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;lib_view&#39;)) {</span>
<a name="l01116"></a>01116 <span class="stringliteral"> </span>
<a name="l01117"></a>01117 <span class="stringliteral">        @pg_files=();</span>
<a name="l01118"></a>01118 <span class="stringliteral">        my @dbsearch = WeBWorK::Utils::ListingDB::getSectionListings($r);</span>
<a name="l01119"></a>01119 <span class="stringliteral">        my ($result, $tolibpath);</span>
<a name="l01120"></a>01120 <span class="stringliteral">        for $result (@dbsearch) {</span>
<a name="l01121"></a>01121 <span class="stringliteral">            $tolibpath = &quot;</span>Library/$result-&gt;{path}/$result-&gt;{filename}<span class="stringliteral">&quot;;</span>
<a name="l01122"></a>01122 <span class="stringliteral">            </span>
<a name="l01123"></a>01123 <span class="stringliteral">            ## Too clunky!!!!</span>
<a name="l01124"></a>01124 <span class="stringliteral">            push @pg_files, $tolibpath;</span>
<a name="l01125"></a>01125 <span class="stringliteral">        }</span>
<a name="l01126"></a>01126 <span class="stringliteral">        $use_previous_problems=0; </span>
<a name="l01127"></a>01127 <span class="stringliteral"></span>
<a name="l01128"></a>01128 <span class="stringliteral">        ##### View a set from a set*.def</span>
<a name="l01129"></a>01129 <span class="stringliteral"></span>
<a name="l01130"></a>01130 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;view_setdef_set&#39;)) {</span>
<a name="l01131"></a>01131 <span class="stringliteral"></span>
<a name="l01132"></a>01132 <span class="stringliteral">        my $set_to_display = $self-&gt;{current_library_set};</span>
<a name="l01133"></a>01133 <span class="stringliteral">        debug(&quot;</span>set_to_display is $set_to_display<span class="stringliteral">&quot;);</span>
<a name="l01134"></a>01134 <span class="stringliteral">        if (not defined($set_to_display) </span>
<a name="l01135"></a>01135 <span class="stringliteral">                or $set_to_display eq &quot;</span>Select a Set Definition <a class="code" href="classWeBWorK_1_1File.html">File</a><span class="stringliteral">&quot;</span>
<a name="l01136"></a>01136 <span class="stringliteral">                or $set_to_display eq NO_LOCAL_SET_STRING) {</span>
<a name="l01137"></a>01137 <span class="stringliteral">            $self-&gt;addbadmessage(&quot;</span>You need to select a <span class="keyword">set</span> definition file to view.<span class="stringliteral">&quot;);</span>
<a name="l01138"></a>01138 <span class="stringliteral">        } else {</span>
<a name="l01139"></a>01139 <span class="stringliteral">            @pg_files= $self-&gt;read_set_def($set_to_display);</span>
<a name="l01140"></a>01140 <span class="stringliteral">        }</span>
<a name="l01141"></a>01141 <span class="stringliteral">        $use_previous_problems=0; </span>
<a name="l01142"></a>01142 <span class="stringliteral"></span>
<a name="l01143"></a>01143 <span class="stringliteral">        ##### Edit the current local homework set</span>
<a name="l01144"></a>01144 <span class="stringliteral"></span>
<a name="l01145"></a>01145 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;edit_local&#39;)) { ## Jump to set edit page</span>
<a name="l01146"></a>01146 <span class="stringliteral"></span>
<a name="l01147"></a>01147 <span class="stringliteral">        ; # already handled</span>
<a name="l01148"></a>01148 <span class="stringliteral"></span>
<a name="l01149"></a>01149 <span class="stringliteral"></span>
<a name="l01150"></a>01150 <span class="stringliteral">        ##### Make a new local homework set</span>
<a name="l01151"></a>01151 <span class="stringliteral"></span>
<a name="l01152"></a>01152 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;new_local_set&#39;)) {</span>
<a name="l01153"></a>01153 <span class="stringliteral">        if ($r-&gt;param(&#39;new_set_name&#39;) !~ /^[\w .-]*$/) {</span>
<a name="l01154"></a>01154 <span class="stringliteral">            $self-&gt;addbadmessage(&quot;</span>The name <span class="stringliteral">&quot;.$r-&gt;param(&#39;new_set_name&#39;).&quot;</span> is not a valid <span class="keyword">set</span> name.  Use only letters, digits, -, _, and .<span class="stringliteral">&quot;);</span>
<a name="l01155"></a>01155 <span class="stringliteral">        } else {</span>
<a name="l01156"></a>01156 <span class="stringliteral">            my $newSetName = $r-&gt;param(&#39;new_set_name&#39;);</span>
<a name="l01157"></a>01157 <span class="stringliteral">            # if we want to munge the input set name, do it here</span>
<a name="l01158"></a>01158 <span class="stringliteral">            $newSetName =~ s/\s/_/g;</span>
<a name="l01159"></a>01159 <span class="stringliteral">            debug(&quot;</span>local_sets was <span class="stringliteral">&quot;, $r-&gt;param(&#39;local_sets&#39;));</span>
<a name="l01160"></a>01160 <span class="stringliteral">            $r-&gt;param(&#39;local_sets&#39;,$newSetName);  ## use of two parameter param</span>
<a name="l01161"></a>01161 <span class="stringliteral">            debug(&quot;</span><span class="keyword">new</span> value of local_sets is <span class="stringliteral">&quot;, $r-&gt;param(&#39;local_sets&#39;));</span>
<a name="l01162"></a>01162 <span class="stringliteral">            my $newSetRecord     = $db-&gt;getGlobalSet($newSetName);</span>
<a name="l01163"></a>01163 <span class="stringliteral">            if (defined($newSetRecord)) {</span>
<a name="l01164"></a>01164 <span class="stringliteral">                $self-&gt;addbadmessage(&quot;</span>The <span class="keyword">set</span> name $newSetName is already in use.  
<a name="l01165"></a>01165                 Pick a different name <span class="keywordflow">if</span> you would like to start a <span class="keyword">new</span> <span class="keyword">set</span>.<span class="stringliteral">&quot;);</span>
<a name="l01166"></a>01166 <span class="stringliteral">            } else {            # Do it!</span>
<a name="l01167"></a>01167 <span class="stringliteral">                # DBFIXME use $db-&gt;newGlobalSet</span>
<a name="l01168"></a>01168 <span class="stringliteral">                $newSetRecord = $db-&gt;{set}-&gt;{record}-&gt;new();</span>
<a name="l01169"></a>01169 <span class="stringliteral">                $newSetRecord-&gt;set_id($newSetName);</span>
<a name="l01170"></a>01170 <span class="stringliteral">                $newSetRecord-&gt;set_header(&quot;</span>defaultHeader<span class="stringliteral">&quot;);</span>
<a name="l01171"></a>01171 <span class="stringliteral">                $newSetRecord-&gt;hardcopy_header(&quot;</span>defaultHeader<span class="stringliteral">&quot;);</span>
<a name="l01172"></a>01172 <span class="stringliteral">                $newSetRecord-&gt;open_date(time()+60*60*24*7); # in one week</span>
<a name="l01173"></a>01173 <span class="stringliteral">                $newSetRecord-&gt;due_date(time()+60*60*24*7*2); # in two weeks</span>
<a name="l01174"></a>01174 <span class="stringliteral">                $newSetRecord-&gt;answer_date(time()+60*60*24*7*3); # in three weeks</span>
<a name="l01175"></a>01175 <span class="stringliteral">                eval {$db-&gt;addGlobalSet($newSetRecord)};</span>
<a name="l01176"></a>01176 <span class="stringliteral">                if ($@) {</span>
<a name="l01177"></a>01177 <span class="stringliteral">                    $self-&gt;addbadmessage(&quot;</span>Problem creating <span class="keyword">set</span> $newSetName&lt;br&gt; $<span class="stringliteral">@&quot;);</span>
<a name="l01178"></a>01178 <span class="stringliteral">                } else {</span>
<a name="l01179"></a>01179 <span class="stringliteral">                    $self-&gt;addgoodmessage(&quot;</span>Set $newSetName has been created.<span class="stringliteral">&quot;);</span>
<a name="l01180"></a>01180 <span class="stringliteral">                    my $selfassign = $r-&gt;param(&#39;selfassign&#39;) || &quot;</span><span class="stringliteral">&quot;;</span>
<a name="l01181"></a>01181 <span class="stringliteral">                    $selfassign = &quot;</span><span class="stringliteral">&quot; if($selfassign =~ /false/i); # deal with javascript false</span>
<a name="l01182"></a>01182 <span class="stringliteral">                    if($selfassign) {</span>
<a name="l01183"></a>01183 <span class="stringliteral">                        $self-&gt;assignSetToUser($userName, $newSetRecord);</span>
<a name="l01184"></a>01184 <span class="stringliteral">                        $self-&gt;addgoodmessage(&quot;</span>Set $newSetName was assigned to $userName.<span class="stringliteral">&quot;);</span>
<a name="l01185"></a>01185 <span class="stringliteral">                    }</span>
<a name="l01186"></a>01186 <span class="stringliteral">                }</span>
<a name="l01187"></a>01187 <span class="stringliteral">            }</span>
<a name="l01188"></a>01188 <span class="stringliteral">        }</span>
<a name="l01189"></a>01189 <span class="stringliteral"></span>
<a name="l01190"></a>01190 <span class="stringliteral">        ##### Add selected problems to the current local set</span>
<a name="l01191"></a>01191 <span class="stringliteral"></span>
<a name="l01192"></a>01192 <span class="stringliteral">    } elsif ($r-&gt;param(&#39;update&#39;)) {</span>
<a name="l01193"></a>01193 <span class="stringliteral">        ## first handle problems to be added before we hide them</span>
<a name="l01194"></a>01194 <span class="stringliteral">        my($localSet, @selected);</span>
<a name="l01195"></a>01195 <span class="stringliteral"></span>
<a name="l01196"></a>01196 <span class="stringliteral">        @pg_files = grep {($_-&gt;[1] &amp; ADDED) != 0 } @{$self-&gt;{past_problems}}; </span>
<a name="l01197"></a>01197 <span class="stringliteral">        @selected = map {$_-&gt;[0]} @pg_files;</span>
<a name="l01198"></a>01198 <span class="stringliteral"></span>
<a name="l01199"></a>01199 <span class="stringliteral">        my @action_files = grep {$_-&gt;[1] &gt; 0 } @{$self-&gt;{past_problems}};</span>
<a name="l01200"></a>01200 <span class="stringliteral">        # There are now good reasons to do an update without selecting anything.</span>
<a name="l01201"></a>01201 <span class="stringliteral">        #if(scalar(@action_files) == 0) {</span>
<a name="l01202"></a>01202 <span class="stringliteral">        #    $self-&gt;addbadmessage(&#39;Update requested, but no problems were marked.&#39;);</span>
<a name="l01203"></a>01203 <span class="stringliteral">        #}</span>
<a name="l01204"></a>01204 <span class="stringliteral"></span>
<a name="l01205"></a>01205 <span class="stringliteral">        if (scalar(@selected)&gt;0) {  # if some are to be added, they need a place to go</span>
<a name="l01206"></a>01206 <span class="stringliteral">            $localSet = $r-&gt;param(&#39;local_sets&#39;);</span>
<a name="l01207"></a>01207 <span class="stringliteral">            if (not defined($localSet) or </span>
<a name="l01208"></a>01208 <span class="stringliteral">                    $localSet eq SELECT_SET_STRING or </span>
<a name="l01209"></a>01209 <span class="stringliteral">                    $localSet eq NO_LOCAL_SET_STRING) {</span>
<a name="l01210"></a>01210 <span class="stringliteral">                $self-&gt;addbadmessage(&#39;You are trying to add problems to something, </span>
<a name="l01211"></a>01211 <span class="stringliteral">                but you did not select a &quot;</span>Target Set<span class="stringliteral">&quot; name as a target.&#39;);</span>
<a name="l01212"></a>01212 <span class="stringliteral">            } else {</span>
<a name="l01213"></a>01213 <span class="stringliteral">                my $newSetRecord  = $db-&gt;getGlobalSet($localSet);</span>
<a name="l01214"></a>01214 <span class="stringliteral">                if (not defined($newSetRecord)) {</span>
<a name="l01215"></a>01215 <span class="stringliteral">                    $self-&gt;addbadmessage(&quot;</span>You are trying to add problems to $localSet, 
<a name="l01216"></a>01216                     but that <span class="keyword">set</span> does not seem to exist!  I bet you used your \<span class="stringliteral">&quot;Back\&quot; button.&quot;</span>);
<a name="l01217"></a>01217                 } <span class="keywordflow">else</span> {
<a name="l01218"></a>01218                     my $addcount = add_selected($self, $db, $localSet);
<a name="l01219"></a>01219                     <span class="keywordflow">if</span>($addcount &gt; 0) {
<a name="l01220"></a>01220                         $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Added $addcount problem&quot;</span>.(($addcount&gt;1)?<span class="charliteral">&#39;s&#39;</span>:<span class="stringliteral">&#39;&#39;</span>).
<a name="l01221"></a>01221                             <span class="stringliteral">&quot; to $localSet.&quot;</span>);
<a name="l01222"></a>01222                     }
<a name="l01223"></a>01223                 }
<a name="l01224"></a>01224             }
<a name="l01225"></a>01225         }
<a name="l01226"></a>01226 <span class="preprocessor">        ## now handle problems to be hidden</span>
<a name="l01227"></a>01227 <span class="preprocessor"></span>
<a name="l01228"></a>01228 <span class="preprocessor">        ## only keep the ones which are not hidden</span>
<a name="l01229"></a>01229 <span class="preprocessor"></span>        @pg_files = grep {($_-&gt;[1] &amp; HIDDEN) ==0 } @{$self-&gt;{past_problems}};
<a name="l01230"></a>01230         @past_marks = map {$_-&gt;[1]} @pg_files;
<a name="l01231"></a>01231         @pg_files = map {$_-&gt;[0]} @pg_files;
<a name="l01232"></a>01232         @all_past_list = (@all_past_list[0..($first_shown-1)],
<a name="l01233"></a>01233                     @pg_files,
<a name="l01234"></a>01234                     @all_past_list[($last_shown+1)..(scalar(@all_past_list)-1)]);
<a name="l01235"></a>01235         $last_shown = $first_shown+$maxShown -1; debug(<span class="stringliteral">&quot;last_shown 3: &quot;</span>, $last_shown);
<a name="l01236"></a>01236         $last_shown = (scalar(@all_past_list)-1) <span class="keywordflow">if</span>($last_shown&gt;=scalar(@all_past_list)); debug(<span class="stringliteral">&quot;last_shown 4: &quot;</span>, $last_shown);
<a name="l01237"></a>01237 
<a name="l01238"></a>01238     } elsif ($r-&gt;param(<span class="stringliteral">&#39;next_page&#39;</span>)) {
<a name="l01239"></a>01239         $first_shown = $last_shown+1;
<a name="l01240"></a>01240         $last_shown = $first_shown+$maxShown-1; debug(<span class="stringliteral">&quot;last_shown 5: &quot;</span>, $last_shown);
<a name="l01241"></a>01241         $last_shown = (scalar(@all_past_list)-1) <span class="keywordflow">if</span>($last_shown&gt;=scalar(@all_past_list)); debug(<span class="stringliteral">&quot;last_shown 6: &quot;</span>, $last_shown);
<a name="l01242"></a>01242         @past_marks = ();
<a name="l01243"></a>01243     } elsif ($r-&gt;param(<span class="stringliteral">&#39;prev_page&#39;</span>)) {
<a name="l01244"></a>01244         $last_shown = $first_shown-1; 
<a name="l01245"></a>01245         $first_shown = $last_shown - $maxShown+1;
<a name="l01246"></a>01246 
<a name="l01247"></a>01247         $first_shown = 0 <span class="keywordflow">if</span>($first_shown&lt;0);
<a name="l01248"></a>01248         @past_marks = ();
<a name="l01249"></a>01249 
<a name="l01250"></a>01250     } elsif ($r-&gt;param(<span class="stringliteral">&#39;select_all&#39;</span>)) {
<a name="l01251"></a>01251         @past_marks = map {1} @past_marks;
<a name="l01252"></a>01252     } elsif ($r-&gt;param(<span class="stringliteral">&#39;library_basic&#39;</span>)) {
<a name="l01253"></a>01253         $library_basic = 1;
<a name="l01254"></a>01254         <span class="keywordflow">for</span> my $jj (qw(textchapter textsection textbook)) {
<a name="l01255"></a>01255             $r-&gt;param(<span class="stringliteral">&#39;library_&#39;</span>.$jj,<span class="stringliteral">&#39;&#39;</span>);
<a name="l01256"></a>01256         }
<a name="l01257"></a>01257     } elsif ($r-&gt;param(<span class="stringliteral">&#39;library_advanced&#39;</span>)) {
<a name="l01258"></a>01258         $library_basic = 2;
<a name="l01259"></a>01259     } elsif ($r-&gt;param(<span class="stringliteral">&#39;library_reset&#39;</span>)) {
<a name="l01260"></a>01260         <span class="keywordflow">for</span> my $jj (qw(chapters sections subjects textbook keywords)) {
<a name="l01261"></a>01261             $r-&gt;param(<span class="stringliteral">&#39;library_&#39;</span>.$jj,<span class="stringliteral">&#39;&#39;</span>);
<a name="l01262"></a>01262         }
<a name="l01263"></a>01263     } elsif ($r-&gt;param(<span class="stringliteral">&#39;select_none&#39;</span>)) {
<a name="l01264"></a>01264         @past_marks = ();
<a name="l01265"></a>01265     } <span class="keywordflow">else</span> {
<a name="l01266"></a>01266 <span class="preprocessor">        ##### No action requested, probably our first time here</span>
<a name="l01267"></a>01267 <span class="preprocessor"></span>    }               ##### end of the <span class="keywordflow">if</span> elsif ...
<a name="l01268"></a>01268 
<a name="l01269"></a>01269  
<a name="l01270"></a>01270 <span class="preprocessor">    ############# List of local sets</span>
<a name="l01271"></a>01271 <span class="preprocessor"></span>
<a name="l01272"></a>01272 <span class="preprocessor">    # DBFIXME sorting in database, please!</span>
<a name="l01273"></a>01273 <span class="preprocessor"></span>    my @all_db_sets = $db-&gt;listGlobalSets;
<a name="l01274"></a>01274     @all_db_sets = sortByName(undef, @all_db_sets);
<a name="l01275"></a>01275 
<a name="l01276"></a>01276     <span class="keywordflow">if</span> ($use_previous_problems) {
<a name="l01277"></a>01277         @pg_files = @all_past_list;
<a name="l01278"></a>01278     } <span class="keywordflow">else</span> {
<a name="l01279"></a>01279         $first_shown = 0;
<a name="l01280"></a>01280         $last_shown = scalar(@pg_files)&lt;$maxShown ? scalar(@pg_files) : $maxShown; 
<a name="l01281"></a>01281         $last_shown--;      # to make it an array index
<a name="l01282"></a>01282         @past_marks = ();
<a name="l01283"></a>01283     }
<a name="l01284"></a>01284 <span class="preprocessor">    ############# Now store data in self for retreival by body</span>
<a name="l01285"></a>01285 <span class="preprocessor"></span>    $self-&gt;{first_shown} = $first_shown;
<a name="l01286"></a>01286     $self-&gt;{last_shown} = $last_shown;
<a name="l01287"></a>01287     $self-&gt;{browse_which} = $browse_which;
<a name="l01288"></a>01288 <span class="preprocessor">    #$self-&gt;{problem_seed} = $problem_seed;</span>
<a name="l01289"></a>01289 <span class="preprocessor"></span>    $self-&gt;{pg_files} = \@pg_files;
<a name="l01290"></a>01290     $self-&gt;{past_marks} = \@past_marks;
<a name="l01291"></a>01291     $self-&gt;{all_db_sets} = \@all_db_sets;
<a name="l01292"></a>01292     $self-&gt;{library_basic} = $library_basic;
<a name="l01293"></a>01293     debug(<span class="stringliteral">&quot;past_marks is &quot;</span>, join(<span class="stringliteral">&quot; &quot;</span>, @{$self-&gt;{past_marks}}));
<a name="l01294"></a>01294 }
<a name="l01295"></a>01295 
<a name="l01296"></a>01296 
<a name="l01297"></a>01297 sub title {
<a name="l01298"></a>01298     <span class="keywordflow">return</span> <span class="stringliteral">&quot;Library Browser&quot;</span>;
<a name="l01299"></a>01299 }
<a name="l01300"></a>01300 
<a name="l01301"></a>01301 <span class="preprocessor"># hide view options panel since it distracts from SetMaker&#39;s built-in view options</span>
<a name="l01302"></a>01302 <span class="preprocessor"></span>sub options {
<a name="l01303"></a>01303     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01304"></a>01304 }
<a name="l01305"></a>01305 
<a name="l01306"></a>01306 sub body {
<a name="l01307"></a>01307     my ($self) = @_;
<a name="l01308"></a>01308 
<a name="l01309"></a>01309     my $r = $self-&gt;r;
<a name="l01310"></a>01310     my $ce = $r-&gt;ce;        # course environment
<a name="l01311"></a>01311     my $db = $r-&gt;db;        # database
<a name="l01312"></a>01312     my $j;          # garden variety counter
<a name="l01313"></a>01313 
<a name="l01314"></a>01314     my $userName = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l01315"></a>01315 
<a name="l01316"></a>01316     my $user = $db-&gt;getUser($userName); # checked
<a name="l01317"></a>01317     die <span class="stringliteral">&quot;record for user $userName (real user) does not exist.&quot;</span>
<a name="l01318"></a>01318         unless defined $user;
<a name="l01319"></a>01319 
<a name="l01320"></a>01320 <span class="preprocessor">    ### Check that this is a professor</span>
<a name="l01321"></a>01321 <span class="preprocessor"></span>    my $authz = $r-&gt;authz;
<a name="l01322"></a>01322     unless ($authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>)) {
<a name="l01323"></a>01323         print <span class="stringliteral">&quot;User $userName returned &quot;</span> . 
<a name="l01324"></a>01324             $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>) . 
<a name="l01325"></a>01325     <span class="stringliteral">&quot; for permission&quot;</span>;
<a name="l01326"></a>01326         <span class="keywordflow">return</span>(CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},
<a name="l01327"></a>01327         CGI::em(<span class="stringliteral">&quot;You are not authorized to access the Instructor tools.&quot;</span>)));
<a name="l01328"></a>01328     }
<a name="l01329"></a>01329 
<a name="l01330"></a>01330     my $showHints = $r-&gt;param(<span class="stringliteral">&#39;showHints&#39;</span>);
<a name="l01331"></a>01331     my $showSolutions = $r-&gt;param(<span class="stringliteral">&#39;showSolutions&#39;</span>);
<a name="l01332"></a>01332     
<a name="l01333"></a>01333 <span class="preprocessor">    ##########  Extract information computed in pre_header_initialize</span>
<a name="l01334"></a>01334 <span class="preprocessor"></span>
<a name="l01335"></a>01335     my $first_shown = $self-&gt;{first_shown};
<a name="l01336"></a>01336     my $last_shown = $self-&gt;{last_shown}; 
<a name="l01337"></a>01337     my $browse_which = $self-&gt;{browse_which};
<a name="l01338"></a>01338     my $problem_seed = $self-&gt;{problem_seed}||1234;
<a name="l01339"></a>01339     my @pg_files = @{$self-&gt;{pg_files}};
<a name="l01340"></a>01340     my @all_db_sets = @{$self-&gt;{all_db_sets}};
<a name="l01341"></a>01341 
<a name="l01342"></a>01342     my @pg_html;
<a name="l01343"></a>01343     <span class="keywordflow">if</span> ($last_shown &gt;= $first_shown) {
<a name="l01344"></a>01344         @pg_html = renderProblems(
<a name="l01345"></a>01345             r=&gt; $r,
<a name="l01346"></a>01346             user =&gt; $user,
<a name="l01347"></a>01347             problem_list =&gt; [@pg_files[$first_shown..$last_shown]],
<a name="l01348"></a>01348             displayMode =&gt; $r-&gt;param(<span class="stringliteral">&#39;mydisplayMode&#39;</span>),
<a name="l01349"></a>01349             showHints =&gt; $showHints,
<a name="l01350"></a>01350             showSolutions =&gt; $showSolutions,
<a name="l01351"></a>01351         );
<a name="l01352"></a>01352     }
<a name="l01353"></a>01353 
<a name="l01354"></a>01354     my %isInSet;
<a name="l01355"></a>01355     my $setName = $r-&gt;param(<span class="stringliteral">&quot;local_sets&quot;</span>);
<a name="l01356"></a>01356     <span class="keywordflow">if</span> ($setName) {
<a name="l01357"></a>01357 <span class="preprocessor">        # DBFIXME where clause, iterator</span>
<a name="l01358"></a>01358 <span class="preprocessor"></span><span class="preprocessor">        # DBFIXME maybe instead of hashing here, query when checking source files?</span>
<a name="l01359"></a>01359 <span class="preprocessor"></span><span class="preprocessor">        # DBFIXME definitely don&#39;t need to be making full record objects</span>
<a name="l01360"></a>01360 <span class="preprocessor"></span><span class="preprocessor">        # DBFIXME SELECT source_file FROM whatever_problem WHERE set_id=? GROUP BY source_file ORDER BY NULL;</span>
<a name="l01361"></a>01361 <span class="preprocessor"></span><span class="preprocessor">        # DBFIXME (and stick result directly into hash)</span>
<a name="l01362"></a>01362 <span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $problem ($db-&gt;listGlobalProblems($setName)) {
<a name="l01363"></a>01363             my $problemRecord = $db-&gt;getGlobalProblem($setName, $problem);
<a name="l01364"></a>01364             $isInSet{$problemRecord-&gt;source_file} = 1;
<a name="l01365"></a>01365         }
<a name="l01366"></a>01366     }
<a name="l01367"></a>01367     $self-&gt;{isInSet} = \%isInSet;
<a name="l01368"></a>01368 
<a name="l01369"></a>01369 <span class="preprocessor">    ##########  Top part</span>
<a name="l01370"></a>01370 <span class="preprocessor"></span>    print CGI::start_form({-method=&gt;<span class="stringliteral">&quot;POST&quot;</span>, -action=&gt;$r-&gt;uri, -name=&gt;<span class="stringliteral">&#39;mainform&#39;</span>}),
<a name="l01371"></a>01371         $self-&gt;hidden_authen_fields,
<a name="l01372"></a>01372             <span class="stringliteral">&#39;&lt;div align=&quot;center&quot;&gt;&#39;</span>,
<a name="l01373"></a>01373     CGI::start_table({-border=&gt;2});
<a name="l01374"></a>01374     $self-&gt;make_top_row(<span class="stringliteral">&#39;all_db_sets&#39;</span>=&gt;\@all_db_sets, 
<a name="l01375"></a>01375                  <span class="stringliteral">&#39;browse_which&#39;</span>=&gt; $browse_which);
<a name="l01376"></a>01376     print CGI::hidden(-name=&gt;<span class="stringliteral">&#39;browse_which&#39;</span>, -value=&gt;$browse_which,-<span class="keyword">override</span>=&gt;1),
<a name="l01377"></a>01377         CGI::hidden(-name=&gt;<span class="stringliteral">&#39;problem_seed&#39;</span>, -value=&gt;$problem_seed, -<span class="keyword">override</span>=&gt;1);
<a name="l01378"></a>01378     <span class="keywordflow">for</span> ($j = 0 ; $j &lt; scalar(@pg_files) ; $j++) {
<a name="l01379"></a>01379         print CGI::hidden(-name=&gt;<span class="stringliteral">&quot;all_past_list$j&quot;</span>, -value=&gt;$pg_files[$j],-<span class="keyword">override</span>=&gt;1);
<a name="l01380"></a>01380     }
<a name="l01381"></a>01381 
<a name="l01382"></a>01382     print CGI::hidden(-name=&gt;<span class="stringliteral">&#39;first_shown&#39;</span>, -value=&gt;$first_shown,-<span class="keyword">override</span>=&gt;1);
<a name="l01383"></a>01383     
<a name="l01384"></a>01384     print CGI::hidden(-name=&gt;<span class="stringliteral">&#39;last_shown&#39;</span>, -value=&gt;$last_shown, -<span class="keyword">override</span>=&gt;1);
<a name="l01385"></a>01385 
<a name="l01386"></a>01386 
<a name="l01387"></a>01387 <span class="preprocessor">    ########## Now print problems</span>
<a name="l01388"></a>01388 <span class="preprocessor"></span>    my $jj;
<a name="l01389"></a>01389     <span class="keywordflow">for</span> ($jj=0; $jj&lt;scalar(@pg_html); $jj++) { 
<a name="l01390"></a>01390         $pg_files[$jj] =~ s|^$ce-&gt;{courseDirs}-&gt;{templates}/?||;
<a name="l01391"></a>01391         $self-&gt;make_data_row($pg_files[$jj+$first_shown], $pg_html[$jj], $jj+1, $self-&gt;{past_marks}-&gt;[$jj]); 
<a name="l01392"></a>01392 <span class="preprocessor">        #$self-&gt;make_data_row($pg_files[$jj+$first_shown], $pg_html[$jj], $jj+1, $self-&gt;{past_marks}-&gt;[$jj+$first_shown]); #MEG</span>
<a name="l01393"></a>01393 <span class="preprocessor"></span>    }
<a name="l01394"></a>01394 
<a name="l01395"></a>01395 <span class="preprocessor">    ########## Finish things off</span>
<a name="l01396"></a>01396 <span class="preprocessor"></span>    print CGI::end_table();
<a name="l01397"></a>01397     print <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l01398"></a>01398 <span class="preprocessor">    #    if($first_shown&gt;0 or (1+$last_shown)&lt;scalar(@pg_files)) {</span>
<a name="l01399"></a>01399 <span class="preprocessor"></span>    my ($next_button, $prev_button) = (<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01400"></a>01400     <span class="keywordflow">if</span> ($first_shown &gt; 0) {
<a name="l01401"></a>01401         $prev_button = CGI::submit(-name=&gt;<span class="stringliteral">&quot;prev_page&quot;</span>, -style=&gt;<span class="stringliteral">&quot;width:15ex&quot;</span>,
<a name="l01402"></a>01402                          -value=&gt;<span class="stringliteral">&quot;Previous page&quot;</span>);
<a name="l01403"></a>01403     }
<a name="l01404"></a>01404     <span class="keywordflow">if</span> ((1+$last_shown)&lt;scalar(@pg_files)) {
<a name="l01405"></a>01405         $next_button = CGI::submit(-name=&gt;<span class="stringliteral">&quot;next_page&quot;</span>, -style=&gt;<span class="stringliteral">&quot;width:15ex&quot;</span>,
<a name="l01406"></a>01406                          -value=&gt;<span class="stringliteral">&quot;Next page&quot;</span>);
<a name="l01407"></a>01407     }
<a name="l01408"></a>01408     <span class="keywordflow">if</span> (scalar(@pg_files)&gt;0) {
<a name="l01409"></a>01409         print CGI::p(($first_shown+1).<span class="stringliteral">&quot;-&quot;</span>.($last_shown+1).<span class="stringliteral">&quot; of &quot;</span>.scalar(@pg_files).
<a name="l01410"></a>01410             <span class="stringliteral">&quot; shown.&quot;</span>, $prev_button, <span class="stringliteral">&quot; &quot;</span>, $next_button,
<a name="l01411"></a>01411             CGI::submit(-name=&gt;<span class="stringliteral">&quot;update&quot;</span>, -style=&gt;<span class="stringliteral">&quot;width:15ex; font-weight:bold&quot;</span>,
<a name="l01412"></a>01412                     -value=&gt;<span class="stringliteral">&quot;Update Set&quot;</span>));
<a name="l01413"></a>01413     }
<a name="l01414"></a>01414 <span class="preprocessor">    #    }</span>
<a name="l01415"></a>01415 <span class="preprocessor"></span>    print CGI::endform(), <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01416"></a>01416 
<a name="l01417"></a>01417     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;  
<a name="l01418"></a>01418 }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420 =head1 AUTHOR
<a name="l01421"></a>01421 
<a name="l01422"></a>01422 Written by John Jones, jj (at) asu.edu.
<a name="l01423"></a>01423 
<a name="l01424"></a>01424 =cut
<a name="l01425"></a>01425 
<a name="l01426"></a>01426 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:35 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
