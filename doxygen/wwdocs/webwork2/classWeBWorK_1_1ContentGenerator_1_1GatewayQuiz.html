<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::ContentGenerator::GatewayQuiz Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator.html">ContentGenerator</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html">GatewayQuiz</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::ContentGenerator::GatewayQuiz Class Reference</h1><!-- doxytag: class="WeBWorK::ContentGenerator::GatewayQuiz" --><!-- doxytag: inherits="WeBWorK::ContentGenerator" --><div class="dynheader">
Inheritance diagram for WeBWorK::ContentGenerator::GatewayQuiz:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz__inherit__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1GatewayQuiz_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1GatewayQuiz_inherit__map" id="WeBWorK_1_1ContentGenerator_1_1GatewayQuiz_inherit__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="49,80,241,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="104,5,187,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::ContentGenerator::GatewayQuiz:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz__coll__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1GatewayQuiz_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1GatewayQuiz_coll__map" id="WeBWorK_1_1ContentGenerator_1_1GatewayQuiz_coll__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="49,80,241,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="104,5,187,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#adf0e6c5b7c11c901dbbe574d09354050">can_showScore</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#aee8845a5fa3c2cd056f3cc380e02f794">options</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a293e2d14f51a3b7553b70cf5ac1683d5">can_showHints</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#aee77b0d8b0c428ee0673a3b74fe2c2d8">pre_header_initialize</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a4ea731387cf72ce1c0e75602b4e627bd">body</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a8384f7308f34576e315347b3da570fb6">templateName</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a2e48d49a5c26dee9d38f3d026528a93f">can_showCorrectAnswers</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a38e35306aec2a93393b9817579c93670">nav</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#ac936647c88bff907b815e763e40a005e">can_checkAnswers</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a51093cea9e6da90f9b5506f281b8bebc">can_showSolutions</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a005727b2bfd1db0b8e2fb2f2f3c60937">path</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#ac5b90f00068e1a1cb89ac054fa9c780a">can_showOldAnswers</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a749618bb96db7d27de560704d2534849">previewAnswer</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a5454d55f0f8816366691cbc6bce91051">problemListRow</a> ($$$)()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a2d069ab43d45eafa609a372dd10bb5ab">can_recordAnswers</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a0b23da33fae3ad7c4bf1c07d5d1c11e4">attemptResults</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a516fc752fc5b49b1a983b0aaa66a2b2e">getProblemHTML</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html">WeBWorK::ContentGenerator::GatewayQuiz</a> - display a quiz of problems on one page, deal with versioning sets </p>

<p>Definition at line <a class="el" href="GatewayQuiz_8pm_source.html#l00028">28</a> of file <a class="el" href="GatewayQuiz_8pm_source.html">GatewayQuiz.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a0b23da33fae3ad7c4bf1c07d5d1c11e4"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::attemptResults" ref="a0b23da33fae3ad7c4bf1c07d5d1c11e4" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::attemptResults </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-attemptResults' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-attemptResults-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-attemptResults-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-attemptResults-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in attemptResults: 132</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a0b23da33fae3ad7c4bf1c07d5d1c11e4">attemptResults</a> {
    my $self = shift;
    my $pg = shift;
    my $showAttemptAnswers = shift;
    my $showCorrectAnswers = shift;
    my $showAttemptResults = $showAttemptAnswers &amp;&amp; shift;
    my $showSummary = shift;
    my $showAttemptPreview = shift || 0;
    
    my $r = $self-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a>};
    my $setName = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
    my $ce = $self-&gt;{ce};
    my $root = $ce-&gt;{webworkURLs}-&gt;{root};
    my $courseName = $ce-&gt;{courseName};
    my @links = (<span class="stringliteral">&quot;Homework Sets&quot;</span> , <span class="stringliteral">&quot;$root/$courseName&quot;</span>, <span class="stringliteral">&quot;navUp&quot;</span>);
    my $tail = <span class="stringliteral">&quot;&quot;</span>;
    
    my $problemResult = $pg-&gt;{result}; # the overall result of the problem
    my @answerNames = @{ $pg-&gt;{flags}-&gt;{ANSWER_ENTRY_ORDER} };
    
    my $showMessages = $showAttemptAnswers &amp;&amp; grep { $pg-&gt;{answers}-&gt;{$_}-&gt;{ans_message} } @answerNames;

<span class="preprocessor">  # present in ver 1.10; why is this checked here?</span>
<span class="preprocessor"></span><span class="preprocessor">    #   return CGI::p(CGI::font({-color=&gt;&quot;red&quot;}, &quot;This problem is not available because the homework set that contains it is not yet open.&quot;))</span>
<span class="preprocessor"></span><span class="preprocessor">    #   unless $self-&gt;{isOpen};</span>
<span class="preprocessor"></span>
    my $basename = <span class="stringliteral">&quot;equation-&quot;</span> . $self-&gt;{<span class="keyword">set</span>}-&gt;psvn. <span class="stringliteral">&quot;.&quot;</span> . $self-&gt;{problem}-&gt;problem_id . <span class="stringliteral">&quot;-preview&quot;</span>;

<span class="preprocessor">    # to make grabbing these options easier, we&#39;ll pull them out now...</span>
<span class="preprocessor"></span>    my %imagesModeOptions = %{$ce-&gt;{pg}-&gt;{displayModeOptions}-&gt;{images}};
    
    my $imgGen = WeBWorK::PG::ImageGenerator-&gt;new(
        tempDir         =&gt; $ce-&gt;{webworkDirs}-&gt;{tmp},
        latex           =&gt; $ce-&gt;{externalPrograms}-&gt;{latex},
        dvipng          =&gt; $ce-&gt;{externalPrograms}-&gt;{dvipng},
        useCache        =&gt; 1,
        cacheDir        =&gt; $ce-&gt;{webworkDirs}-&gt;{equationCache},
        cacheURL        =&gt; $ce-&gt;{webworkURLs}-&gt;{equationCache},
        cacheDB         =&gt; $ce-&gt;{webworkFiles}-&gt;{equationCacheDB},
        dvipng_align    =&gt; $imagesModeOptions{dvipng_align},
        dvipng_depth_db =&gt; $imagesModeOptions{dvipng_depth_db},
    );

    my %resultsData = ();
    $resultsData{<span class="stringliteral">&#39;Entered&#39;</span>}  = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;Your answer parses as:&quot;</span>);
    $resultsData{<span class="stringliteral">&#39;Preview&#39;</span>}  = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;Your answer previews as:&quot;</span>);
    $resultsData{<span class="stringliteral">&#39;Correct&#39;</span>}  = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;The correct answer is:&quot;</span>);
    $resultsData{<span class="stringliteral">&#39;Results&#39;</span>}  = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;Result:&quot;</span>);
    $resultsData{<span class="stringliteral">&#39;Messages&#39;</span>} = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;Messages:&quot;</span>);

    my %resultsRows = ();
    <span class="keywordflow">foreach</span> ( qw( Entered Preview Correct Results Messages ) ) {
        $resultsRows{$_} = <span class="stringliteral">&quot;&quot;</span>;
    }

    my $numCorrect = 0;
    my $numAns = 0;
    <span class="keywordflow">foreach</span> my $name (@answerNames) {
        my $answerResult  = $pg-&gt;{answers}-&gt;{$name};
        my $studentAnswer = $answerResult-&gt;{student_ans}; # original_student_ans
        my $preview       = ($showAttemptPreview
                                ? $self-&gt;previewAnswer($answerResult, $imgGen)
                                : <span class="stringliteral">&quot;&quot;</span>);
        my $correctAnswer = $answerResult-&gt;{correct_ans};
        my $answerScore   = $answerResult-&gt;{score};
        my $answerMessage = $showMessages ? $answerResult-&gt;{ans_message} : <span class="stringliteral">&quot;&quot;</span>;
<span class="preprocessor">        #FIXME  --Can we be sure that $answerScore is an integer-- could the problem give partial credit?</span>
<span class="preprocessor"></span>        $numCorrect += $answerScore &gt; 0;
        my $resultString = $answerScore == 1 ? <span class="stringliteral">&quot;correct&quot;</span> : <span class="stringliteral">&quot;incorrect&quot;</span>;
        
<span class="preprocessor">        # get rid of the goofy prefix on the answer names (supposedly, the format</span>
<span class="preprocessor"></span><span class="preprocessor">        # of the answer names is changeable. this only fixes it for &quot;AnSwEr&quot;</span>
<span class="preprocessor"></span><span class="preprocessor">        #$name =~ s/^AnSwEr//;</span>
<span class="preprocessor"></span>        
        my $pre = $numAns ? CGI::td(<span class="stringliteral">&quot;&amp;nbsp;&quot;</span>) : <span class="stringliteral">&quot;&quot;</span>;

        $resultsRows{<span class="stringliteral">&#39;Entered&#39;</span>} .= $showAttemptAnswers ? 
            CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Entered&#39;</span>} . 
                 CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($studentAnswer))) : <span class="stringliteral">&quot;&quot;</span>;
        $resultsData{<span class="stringliteral">&#39;Entered&#39;</span>} = <span class="stringliteral">&#39;&#39;</span>;
        $resultsRows{<span class="stringliteral">&#39;Preview&#39;</span>} .= $showAttemptPreview ? 
            CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Preview&#39;</span>} . 
                 CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($preview)) ) : <span class="stringliteral">&quot;&quot;</span>;
        $resultsData{<span class="stringliteral">&#39;Preview&#39;</span>} = <span class="stringliteral">&#39;&#39;</span>;
        $resultsRows{<span class="stringliteral">&#39;Correct&#39;</span>} .= $showCorrectAnswers ? 
            CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Correct&#39;</span>} . 
                 CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($correctAnswer)) ) : <span class="stringliteral">&quot;&quot;</span>;
        $resultsData{<span class="stringliteral">&#39;Correct&#39;</span>} = <span class="stringliteral">&#39;&#39;</span>;
        $resultsRows{<span class="stringliteral">&#39;Results&#39;</span>} .= $showAttemptResults ? 
            CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Results&#39;</span>} . 
                 CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($resultString)) )  : <span class="stringliteral">&quot;&quot;</span>;
        $resultsData{<span class="stringliteral">&#39;Results&#39;</span>} = <span class="stringliteral">&#39;&#39;</span>;
        $resultsRows{<span class="stringliteral">&#39;Messages&#39;</span>} .= $showMessages ? 
            CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Messages&#39;</span>} . 
                 CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($answerMessage)) ) : <span class="stringliteral">&quot;&quot;</span>;

        $numAns++;
    }
    
<span class="preprocessor">    # render equation images</span>
<span class="preprocessor"></span>    $imgGen-&gt;render(refresh =&gt; 1);
    
<span class="preprocessor">#   my $numIncorrectNoun = scalar @answerNames == 1 ? &quot;question&quot; : &quot;questions&quot;;</span>
<span class="preprocessor"></span>    my $scorePercent = sprintf(<span class="stringliteral">&quot;%.0f%%&quot;</span>, $problemResult-&gt;{score} * 100);
<span class="preprocessor">#   FIXME  -- I left the old code in in case we have to back out.</span>
<span class="preprocessor"></span><span class="preprocessor">#   my $summary = &quot;On this attempt, you answered $numCorrect out of &quot;</span>
<span class="preprocessor"></span><span class="preprocessor">#       . scalar @answerNames . &quot; $numIncorrectNoun correct, for a score of $scorePercent.&quot;;</span>
<span class="preprocessor"></span>
    my $summary = <span class="stringliteral">&quot;&quot;</span>; 
    <span class="keywordflow">if</span> (scalar @answerNames == 1) {
            <span class="keywordflow">if</span> ($numCorrect == scalar @answerNames) {
                $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwCorrect&quot;</span>},<span class="stringliteral">&quot;This answer is correct.&quot;</span>);
             } <span class="keywordflow">else</span> {
                 $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwIncorrect&quot;</span>},<span class="stringliteral">&quot;This answer is NOT correct.&quot;</span>);
             }
    } <span class="keywordflow">else</span> {
            <span class="keywordflow">if</span> ($numCorrect == scalar @answerNames) {
                $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwCorrect&quot;</span>},<span class="stringliteral">&quot;All of these answers are correct.&quot;</span>);
             } <span class="keywordflow">else</span> {
                 $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwIncorrect&quot;</span>},<span class="stringliteral">&quot;At least one of these answers is NOT correct.&quot;</span>);
             }
    }
    
    <span class="keywordflow">return</span>
<span class="preprocessor">#       CGI::table({-class=&gt;&quot;attemptResults&quot;}, $resultsRows{&#39;Entered&#39;}, </span>
<span class="preprocessor"></span>        CGI::table({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwAttemptResults&quot;</span>}, $resultsRows{<span class="stringliteral">&#39;Entered&#39;</span>}, 
               $resultsRows{<span class="stringliteral">&#39;Preview&#39;</span>}, $resultsRows{<span class="stringliteral">&#39;Correct&#39;</span>}, 
               $resultsRows{<span class="stringliteral">&#39;Results&#39;</span>}, $resultsRows{<span class="stringliteral">&#39;Messages&#39;</span>}) .
        ($showSummary ? CGI::p({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;attemptResultsSummary&#39;</span>},$summary) : <span class="stringliteral">&quot;&quot;</span>);
<span class="preprocessor">#       CGI::table({-class=&gt;&quot;attemptResults&quot;}, CGI::Tr(\@tableRows))</span>
<span class="preprocessor"></span><span class="preprocessor">#       . ($showSummary ? CGI::p({class=&gt;&#39;emphasis&#39;},$summary) : &quot;&quot;);</span>
<span class="preprocessor">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a4ea731387cf72ce1c0e75602b4e627bd"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::body" ref="a4ea731387cf72ce1c0e75602b4e627bd" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::body </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-body' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-body-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-body-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-body-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in body: 351</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a4ea731387cf72ce1c0e75602b4e627bd">body</a> {
    my $self = shift();
    my $r = $self-&gt;r;
    my $ce = $r-&gt;ce;
    my $db = $r-&gt;db;
    my $authz = $r-&gt;authz;
    my $urlpath = $r-&gt;urlpath;
    my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
    my $effectiveUser = $r-&gt;param(<span class="stringliteral">&#39;effectiveUser&#39;</span>);

<span class="preprocessor">    # report everything with the same time that we started with</span>
<span class="preprocessor"></span>    my $timeNow = $self-&gt;{timeNow};
    my $grace = $ce-&gt;{gatewayGracePeriod};

<span class="preprocessor">    #########################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # preliminary error checking and output</span>
<span class="preprocessor"></span><span class="preprocessor">    #########################################</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # if $self-&gt;{invalidSet} is set, then we have an error and should</span>
<span class="preprocessor"></span><span class="preprocessor">    #    just bail with the appropriate error message</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> ($self-&gt;{invalidSet} || $self-&gt;{invalidProblem}) {
<span class="preprocessor">        # delete any proctor keys that are floating around</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $self-&gt;{<span class="stringliteral">&#39;assignment_type&#39;</span>} eq <span class="stringliteral">&#39;proctored_gateway&#39;</span> ) {
            my $proctorID = $r-&gt;param(<span class="stringliteral">&#39;proctor_user&#39;</span>);
            <span class="keywordflow">if</span> ( $proctorID ) {
                eval{ $db-&gt;deleteKey(<span class="stringliteral">&quot;$effectiveUser,$proctorID&quot;</span>); };
                eval{ $db-&gt;deleteKey(<span class="stringliteral">&quot;$effectiveUser,$proctorID,g&quot;</span>); };
            }
        }

        my $newlink = <span class="stringliteral">&#39;&#39;</span>;
        my $usernote = <span class="stringliteral">&#39;&#39;</span>;
        <span class="keywordflow">if</span> ( defined( $self-&gt;{invalidVersionCreation} ) &amp;&amp;
             $self-&gt;{invalidVersionCreation} == 1 ) {
            my $gwpage = $urlpath-&gt;newFromModule($urlpath-&gt;module,$r,
                courseID=&gt;$urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>),
                setID=&gt;$urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>));
            my $link = $self-&gt;systemLink( $gwpage,
                params=&gt;{effectiveUser =&gt; $effectiveUser,
                     user =&gt; $user,
                     createnew_ok =&gt; 1} );
            $newlink = CGI::p(CGI::a({href=&gt;$link},
                <span class="stringliteral">&quot;Create new set version.&quot;</span>));
            $usernote = <span class="stringliteral">&quot; (acted as by $user)&quot;</span>;
        } elsif ( defined( $self-&gt;{invalidVersionCreation} ) &amp;&amp;
              $self-&gt;{invalidVersionCreation} == 2 ) {
            $usernote = <span class="stringliteral">&quot; (acted as by $user)&quot;</span>;
        }

        <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>},
                CGI::p(<span class="stringliteral">&quot;The selected problem set (&quot;</span> . 
                       $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>) . <span class="stringliteral">&quot;) is not &quot;</span> .
                       <span class="stringliteral">&quot;a valid set for $effectiveUser&quot;</span> .
                       <span class="stringliteral">&quot;$usernote:&quot;</span>),
                CGI::p($self-&gt;{invalidSet}),
                $newlink);
    }

    my $tmplSet = $self-&gt;{tmplSet};
    my $set = $self-&gt;{<span class="keyword">set</span>};
    my $Problem = $self-&gt;{problem};
    my $permissionLevel = $self-&gt;{permissionLevel};
    my $submitAnswers = $self-&gt;{submitAnswers};
    my $checkAnswers = $self-&gt;{checkAnswers};
    my $previewAnswers = $self-&gt;{previewAnswers};
    my $newPage = $self-&gt;{newPage};
    my %want = %{ $self-&gt;{want} };
    my %can = %{ $self-&gt;{can} };
    my %must = %{ $self-&gt;{must} };
    my %will = %{ $self-&gt;{will} };

    my @problems = @{ $self-&gt;{ra_problems} };
    my @pg_results = @{ $self-&gt;{ra_pg_results} };
    my @pg_errors = @{ $self-&gt;{errors} };
    my $requestedVersion = $self-&gt;{requestedVersion};

    my $startProb = $self-&gt;{startProb};
    my $endProb = $self-&gt;{endProb};
    my $numPages = $self-&gt;{numPages};
    my $pageNumber = $self-&gt;{pageNumber};
    my @probOrder = @{$self-&gt;{ra_probOrder}};

    my $setName  = $set-&gt;set_id;
    my $versionNumber = $set-&gt;version_id;
    my $setVName = <span class="stringliteral">&quot;$setName,v$versionNumber&quot;</span>;
    my $numProbPerPage = $set-&gt;problems_per_page;

<span class="preprocessor">    # translation errors -- we use the same output routine as Problem.pm, </span>
<span class="preprocessor"></span><span class="preprocessor">    #    but play around to allow for errors on multiple translations </span>
<span class="preprocessor"></span><span class="preprocessor">    #    because we have an array of problems to deal with.</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( @pg_errors ) {
        my $errorNum = 1;
        my ( $message, $context ) = ( <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span> );
        <span class="keywordflow">foreach</span> ( @pg_errors ) {

            $message .= <span class="stringliteral">&quot;$errorNum. &quot;</span> <span class="keywordflow">if</span> ( @pg_errors &gt; 1 );
            $message .= $_-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a>} . CGI::br() . <span class="stringliteral">&quot;\n&quot;</span>;

            $context .= CGI::p((@pg_errors &gt; 1? <span class="stringliteral">&quot;$errorNum.&quot;</span>: <span class="stringliteral">&#39;&#39;</span>) . 
                       $_-&gt;{context} ) . <span class="stringliteral">&quot;\n\n&quot;</span> . 
                       CGI::hr() . <span class="stringliteral">&quot;\n\n&quot;</span>;
        }
        <span class="keywordflow">return</span> $self-&gt;errorOutput( $message, $context );
    }

<span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # answer processing</span>
<span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span>
    debug(<span class="stringliteral">&quot;begin answer processing&quot;</span>); 

    my @scoreRecordedMessage = (<span class="stringliteral">&#39;&#39;</span>) x scalar(@problems);

<span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # save results to database as appropriate</span>
<span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> ( $submitAnswers || ( ($previewAnswers || $newPage) &amp;&amp;
                 $can{recordAnswers} ) ) {
<span class="preprocessor">        # if we&#39;re submitting answers, we have to save the problems</span>
<span class="preprocessor"></span><span class="preprocessor">        #    to the database.</span>
<span class="preprocessor"></span><span class="preprocessor">        # if we&#39;re previewing or switching pages and can still</span>
<span class="preprocessor"></span><span class="preprocessor">        #    record answers, we save the last answer for future </span>
<span class="preprocessor"></span><span class="preprocessor">        #    reference</span>
<span class="preprocessor"></span>
<span class="preprocessor">        # first, if we&#39;re submitting answers for a proctored exam, </span>
<span class="preprocessor"></span><span class="preprocessor">        #    we want to delete the proctor keys that authorized </span>
<span class="preprocessor"></span><span class="preprocessor">        #    that grading, so that it isn&#39;t possible to just log </span>
<span class="preprocessor"></span><span class="preprocessor">        #    in and take another proctored test without getting </span>
<span class="preprocessor"></span><span class="preprocessor">        #    reauthorized</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $submitAnswers &amp;&amp; 
             $self-&gt;{<span class="stringliteral">&#39;assignment_type&#39;</span>} eq <span class="stringliteral">&#39;proctored_gateway&#39;</span> ) {
            my $proctorID = $r-&gt;param(<span class="stringliteral">&#39;proctor_user&#39;</span>);

<span class="preprocessor">            # if we don&#39;t have attempts left, delete all</span>
<span class="preprocessor"></span><span class="preprocessor">            #    proctor keys for this user</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $set-&gt;attempts_per_version - 1 -
                 $Problem-&gt;num_correct - $Problem-&gt;num_incorrect 
                 &lt;= 0 ) {   
                eval{ $db-&gt;deleteAllProctorKeys( $effectiveUser ); };
            } <span class="keywordflow">else</span> {
<span class="preprocessor">                # otherwise, delete only the grading key</span>
<span class="preprocessor"></span>                eval{ $db-&gt;deleteKey(<span class="stringliteral">&quot;$effectiveUser,$proctorID,g&quot;</span>); };
<span class="preprocessor">                # in this case we may have a past, login, </span>
<span class="preprocessor"></span><span class="preprocessor">                #    proctor key that we can keep so that </span>
<span class="preprocessor"></span><span class="preprocessor">                #    we don&#39;t have to get another login to</span>
<span class="preprocessor"></span><span class="preprocessor">                #    continue working the test</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $r-&gt;param(<span class="stringliteral">&quot;past_proctor_user&quot;</span>) &amp;&amp;
                     $r-&gt;param(<span class="stringliteral">&quot;past_proctor_key&quot;</span>) ) {
                    $r-&gt;param(<span class="stringliteral">&quot;proctor_user&quot;</span>, $r-&gt;param(<span class="stringliteral">&quot;past_proctor_user&quot;</span>));
                    $r-&gt;param(<span class="stringliteral">&quot;proctor_key&quot;</span>, $r-&gt;param(<span class="stringliteral">&quot;past_proctor_key&quot;</span>));
                }
            }
<span class="preprocessor">            # this is unsubtle, but we&#39;d rather not have bogus </span>
<span class="preprocessor"></span><span class="preprocessor">            #    keys sitting around</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $@ ) {
                die(<span class="stringliteral">&quot;ERROR RESETTING PROCTOR GRADING KEY(S): $@\n&quot;</span>);
            }

        }

        my @pureProblems = $db-&gt;getAllProblemVersions($effectiveUser,
                                  $setName,
                                  $versionNumber);
        <span class="keywordflow">foreach</span> my $i ( 0 .. $#problems ) {  # process each problem
<span class="preprocessor">            # this code is essentially that from Problem.pm</span>
<span class="preprocessor"></span>            my $pureProblem = $pureProblems[$i];

<span class="preprocessor">            # store answers in problem for sticky answers later</span>
<span class="preprocessor"></span>            my %answersToStore;

<span class="preprocessor">            # we have to be a little careful about getting the</span>
<span class="preprocessor"></span><span class="preprocessor">            #    answers that we&#39;re saving, because we don&#39;t have</span>
<span class="preprocessor"></span><span class="preprocessor">            #    a pg_results object for all problems if we&#39;re not </span>
<span class="preprocessor"></span><span class="preprocessor">            #    submitting</span>
<span class="preprocessor"></span>            my %answerHash = ();
            my @answer_order = ();
            <span class="keywordflow">if</span> ( ref( $pg_results[$i] ) ) {
                %answerHash = %{$pg_results[$i]-&gt;{answers}};
                $answersToStore{$_} = $self-&gt;{formFields}-&gt;{$_} 
                    <span class="keywordflow">foreach</span> (keys %answerHash);
<span class="preprocessor">                # check for extra answers that slipped </span>
<span class="preprocessor"></span><span class="preprocessor">                #    by---e.g. for matrices, and get them </span>
<span class="preprocessor"></span><span class="preprocessor">                #    from the original input form</span>
<span class="preprocessor"></span>                my @extra_answer_names = 
                    @{ $pg_results[$i]-&gt;{flags}-&gt;{KEPT_EXTRA_ANSWERS} };
                $answersToStore{$_} = 
                    $self-&gt;{formFields}-&gt;{$_} <span class="keywordflow">foreach</span> (@extra_answer_names);
                @answer_order = 
                    ( @{$pg_results[$i]-&gt;{flags}-&gt;{ANSWER_ENTRY_ORDER}}, 
                      @extra_answer_names );
            } <span class="keywordflow">else</span> {
                my $prefix = sprintf(<span class="stringliteral">&#39;Q%04d_&#39;</span>,$i+1);
                my @fields = sort grep {/^$prefix/} (keys %{$self-&gt;{formFields}});
                %answersToStore = map {$_ =&gt; $self-&gt;{formFields}-&gt;{$_}} @fields;
                @answer_order = @fields;
            }
            my $answerString = encodeAnswers( %answersToStore, 
                              @answer_order );
<span class="preprocessor">            # and get the last answer </span>
<span class="preprocessor"></span>            $problems[$i]-&gt;last_answer( $answerString );
            $pureProblem-&gt;last_answer( $answerString );

<span class="preprocessor">            # next, store the state in the database if that makes </span>
<span class="preprocessor"></span><span class="preprocessor">            #    sense</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $submitAnswers &amp;&amp; $will{recordAnswers} ) {
  $problems[$i]-&gt;status($pg_results[$i]-&gt;{state}-&gt;{recorded_score});
  $problems[$i]-&gt;attempted(1);
  $problems[$i]-&gt;num_correct($pg_results[$i]-&gt;{state}-&gt;{num_of_correct_ans});
  $problems[$i]-&gt;num_incorrect($pg_results[$i]-&gt;{state}-&gt;{num_of_incorrect_ans});
  $pureProblem-&gt;status($pg_results[$i]-&gt;{state}-&gt;{recorded_score});
  $pureProblem-&gt;attempted(1);
  $pureProblem-&gt;num_correct($pg_results[$i]-&gt;{state}-&gt;{num_of_correct_ans});
  $pureProblem-&gt;num_incorrect($pg_results[$i]-&gt;{state}-&gt;{num_of_incorrect_ans});

                <span class="keywordflow">if</span> ( $db-&gt;putProblemVersion( $pureProblem ) ) {
                    $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
                        <span class="stringliteral">&quot;score on this problem was &quot;</span> .
                        <span class="stringliteral">&quot;recorded.&quot;</span>;
                } <span class="keywordflow">else</span> {
                    $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
                        <span class="stringliteral">&quot;score was not recorded &quot;</span> .
                        <span class="stringliteral">&quot;because there was a failure &quot;</span> .
                        <span class="stringliteral">&quot;in storing the problem &quot;</span> .
                        <span class="stringliteral">&quot;record to the database.&quot;</span>;
                }
<span class="preprocessor">                # write the transaction log</span>
<span class="preprocessor"></span>                writeLog( $self-&gt;{ce}, <span class="stringliteral">&quot;transaction&quot;</span>,
                      $problems[$i]-&gt;problem_id . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;set_id . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;user_id . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;source_file . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;value . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;max_attempts . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;problem_seed . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;status . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;attempted . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;last_answer . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;num_correct . <span class="stringliteral">&quot;\t&quot;</span> .
                      $problems[$i]-&gt;num_incorrect
                      );
            } elsif ( $submitAnswers ) {
<span class="preprocessor">                # this is the case where we submitted answers</span>
<span class="preprocessor"></span><span class="preprocessor">                #    but can&#39;t save them; report an error </span>
<span class="preprocessor"></span><span class="preprocessor">                #    message</span>
<span class="preprocessor"></span>
                <span class="keywordflow">if</span> ($self-&gt;{isClosed}) {
                    $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
                        <span class="stringliteral">&quot;score was not recorded &quot;</span> .
                        <span class="stringliteral">&quot;because this problem set &quot;</span> .
                        <span class="stringliteral">&quot;version is not open.&quot;</span>;
                } elsif ( $problems[$i]-&gt;num_correct + 
                      $problems[$i]-&gt;num_incorrect &gt;= 
                      $set-&gt;attempts_per_version ) {
                    $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
                        <span class="stringliteral">&quot;score was not recorded &quot;</span> .
                        <span class="stringliteral">&quot;because you have no &quot;</span> .
                        <span class="stringliteral">&quot;attempts remaining on this &quot;</span> .
                        <span class="stringliteral">&quot;set version.&quot;</span>;
                } elsif ( ! $self-&gt;{versionIsOpen} ) {
                    my $endTime = ( $set-&gt;version_last_attempt_time ) ? $set-&gt;version_last_attempt_time : $timeNow;
                    if ($endTime &gt; $set-&gt;due_date &amp;&amp; 
                        $endTime &lt; $set-&gt;due_date + $grace){
                        $endTime = $set-&gt;due_date;
                    }
                    my $elapsed = 
                        int(($endTime - $set-&gt;open_date)/0.6 + 0.5)/100;
<span class="preprocessor">                    # we assume that allowed is an even </span>
<span class="preprocessor"></span><span class="preprocessor">                    #    number of minutes</span>
<span class="preprocessor"></span>                    my $allowed = ($set-&gt;due_date - $set-&gt;open_date)/60;
                    $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
                        <span class="stringliteral">&quot;score was not recorded &quot;</span> .
                        <span class="stringliteral">&quot;because you have exceeded &quot;</span> .
                        <span class="stringliteral">&quot;the time limit for this &quot;</span> .
                        <span class="stringliteral">&quot;test. (Time taken: $elapsed &quot;</span> .
                        <span class="stringliteral">&quot;min; allowed: $allowed min.)&quot;</span>;
                } <span class="keywordflow">else</span> {
                    $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
                        <span class="stringliteral">&quot;score was not recorded.&quot;</span>;
                }
            } <span class="keywordflow">else</span> {
<span class="preprocessor">                # finally, we must be previewing or switching</span>
<span class="preprocessor"></span><span class="preprocessor">                #    pages.  save only the last answer for the</span>
<span class="preprocessor"></span><span class="preprocessor">                #    problems</span>
<span class="preprocessor"></span>                $db-&gt;putProblemVersion( $pureProblem );
            }
        } # end loop through problems

<span class="preprocessor">        ## finally, log student answers if we&#39;re submitting, </span>
<span class="preprocessor"></span><span class="preprocessor">        ##    previewing, or changing pages, provided that we can </span>
<span class="preprocessor"></span><span class="preprocessor">        ##    record answers.  note that this will log an overtime </span>
<span class="preprocessor"></span><span class="preprocessor">        ##    submission (or any case where someone submits the </span>
<span class="preprocessor"></span><span class="preprocessor">        ##    test, or spoofs a request to submit a test)</span>
<span class="preprocessor"></span>
        my $answer_log = 
            $self-&gt;{ce}-&gt;{courseFiles}-&gt;{logs}-&gt;{<span class="stringliteral">&#39;answer_log&#39;</span>};

<span class="preprocessor">        # this is carried over from Problem.pm</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( defined( $answer_log ) ) {
            <span class="keywordflow">foreach</span> my $i ( 0 .. $#problems ) {
                my $answerString = <span class="stringliteral">&#39;&#39;</span>;
                my $scores = <span class="stringliteral">&#39;&#39;</span>;
<span class="preprocessor">                # note that we store these answers in the </span>
<span class="preprocessor"></span><span class="preprocessor">                #    order that they are presented, not the </span>
<span class="preprocessor"></span><span class="preprocessor">                #    actual problem order</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span> ( ref( $pg_results[$probOrder[$i]] ) ) {
                    my %answerHash = %{ $pg_results[$probOrder[$i]]-&gt;{answers} };
                    <span class="keywordflow">foreach</span> ( sortByName(undef, keys %answerHash) ) {
                        my $sAns = defined($answerHash{$_}-&gt;{original_student_ans}) ? $answerHash{$_}-&gt;{original_student_ans} : <span class="stringliteral">&#39;&#39;</span>;
                        $answerString .= $sAns . <span class="stringliteral">&quot;\t&quot;</span>;
                        $scores .= $answerHash{$_}-&gt;{score}&gt;=1 ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;0&quot;</span> <span class="keywordflow">if</span> ( $submitAnswers );
                    }
                } <span class="keywordflow">else</span> {
                    my $prefix = sprintf(<span class="stringliteral">&#39;Q%04d_&#39;</span>, ($probOrder[$i]+1));
                    my @fields = sort grep {/^$prefix/} (keys %{$self-&gt;{formFields}});
                    <span class="keywordflow">foreach</span> ( @fields ) {
                        $answerString .= $self-&gt;{formFields}-&gt;{$_} . <span class="stringliteral">&quot;\t&quot;</span>;
                        $scores .= $self-&gt;{formFields}-&gt;{<span class="stringliteral">&quot;probstatus&quot;</span> . ($probOrder[$i]+1)} &gt;= 1 ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;0&quot;</span> <span class="keywordflow">if</span> ( $submitAnswers );
                    }
                }
                $answerString =~ s/\t+$/\t/;

                my $answerPrefix;
                <span class="keywordflow">if</span> ( $submitAnswers ) { 
                    $answerPrefix = <span class="stringliteral">&quot;[submit] &quot;</span>;  
                } elsif ( $previewAnswers ) { 
                    $answerPrefix = <span class="stringliteral">&quot;[preview] &quot;</span>; 
                } <span class="keywordflow">else</span> { 
                    $answerPrefix = <span class="stringliteral">&quot;[newPage] &quot;</span>; 
                }

                <span class="keywordflow">if</span> ( ! $answerString || 
                     $answerString =~ /^\t$/ ) {
                    $answerString = <span class="stringliteral">&quot;$answerPrefix&quot;</span> . 
                        <span class="stringliteral">&quot;No answer entered\t&quot;</span>;
                } <span class="keywordflow">else</span> {
                    $answerString = <span class="stringliteral">&quot;$answerPrefix&quot;</span> .
                        <span class="stringliteral">&quot;$answerString&quot;</span>;
                }

                writeCourseLog( $self-&gt;{ce}, <span class="stringliteral">&quot;answer_log&quot;</span>,
                        join(<span class="stringliteral">&quot;&quot;</span>, <span class="charliteral">&#39;|&#39;</span>, 
                             $problems[$i]-&gt;user_id,
                             <span class="charliteral">&#39;|&#39;</span>, $setVName,
                             <span class="charliteral">&#39;|&#39;</span>, ($i+1), <span class="charliteral">&#39;|&#39;</span>, $scores, 
                             <span class="stringliteral">&quot;\t$timeNow\t&quot;</span>,
                             <span class="stringliteral">&quot;$answerString&quot;</span>), 
                        );
            }
        }
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ac936647c88bff907b815e763e40a005e"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::can_checkAnswers" ref="ac936647c88bff907b815e763e40a005e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::can_checkAnswers </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-can_checkAnswers' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-can_checkAnswers-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-can_checkAnswers-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-can_checkAnswers-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in can_checkAnswers: 55</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#ac936647c88bff907b815e763e40a005e">can_checkAnswers</a> {
    my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem,
        $tmplSet, $submitAnswers) = @_;
    my $authz = $self-&gt;r-&gt;authz;

    my $timeNow = ( defined($self-&gt;{timeNow}) ) ? $self-&gt;{timeNow} : time();
<span class="preprocessor">   # get the sag time after the due date in which we&#39;ll still grade the test</span>
<span class="preprocessor"></span>    my $grace = $self-&gt;{ce}-&gt;{gatewayGracePeriod};
    
    my $submitTime = ( defined($Set-&gt;version_last_attempt_time()) &amp;&amp;
               $Set-&gt;version_last_attempt_time() ) ? 
               $Set-&gt;version_last_attempt_time() : $timeNow;

<span class="preprocessor">    # this is further complicated by trying to address hiding scores by </span>
<span class="preprocessor"></span><span class="preprocessor">    #    problem---that is, if $set-&gt;hide_score_by_problem and </span>
<span class="preprocessor"></span><span class="preprocessor">    #    $set-&gt;hide_score are both set, then we should allow scores to </span>
<span class="preprocessor"></span><span class="preprocessor">    #    be shown, but not show the score on any individual problem.  </span>
<span class="preprocessor"></span><span class="preprocessor">    #    to deal with this, we use the least restrictive view of hiding </span>
<span class="preprocessor"></span><span class="preprocessor">    #    here, and then filter for the problems themselves later</span>
<span class="preprocessor"></span>    my $canShowScores = ( $Set-&gt;hide_score eq <span class="charliteral">&#39;N&#39;</span> ||
                  $Set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;Y&#39;</span> ||
                  ( $Set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp;
                after($tmplSet-&gt;answer_date) ) );

    <span class="keywordflow">if</span> (before($Set-&gt;open_date, $submitTime)) {
        <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_before_open_date&quot;</span>);
    } elsif (between($Set-&gt;open_date, ($Set-&gt;due_date + $grace), $submitTime)) {

<span class="preprocessor"># gateway change here; we look at maximum attempts per version, not for the set,</span>
<span class="preprocessor"></span><span class="preprocessor">#   to determine the number of attempts allowed</span>
<span class="preprocessor"></span><span class="preprocessor"># $addOne allows us to count the current submission</span>
<span class="preprocessor"></span>        my $addOne = (defined( $submitAnswers ) &amp;&amp; $submitAnswers) ? 
        1 : 0;
        my $attempts_per_version = $Set-&gt;attempts_per_version()||0;
        my $attempts_used = $Problem-&gt;num_correct+$Problem-&gt;num_incorrect+$addOne;

        <span class="keywordflow">if</span> ($attempts_per_version == -1 or $attempts_used &lt; $attempts_per_version) {
            <span class="keywordflow">return</span> ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_open_date_with_attempts&quot;</span>) &amp;&amp;
                 ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
                   $canShowScores ) );
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">return</span> ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_open_date_without_attempts&quot;</span>) &amp;&amp; 
                 ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
                   $canShowScores ) );
        }
    } elsif (between(($Set-&gt;due_date + $grace), $Set-&gt;answer_date, $submitTime)) {
        <span class="keywordflow">return</span> ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_due_date&quot;</span>)  &amp;&amp;
             ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
               $canShowScores ) );
    } elsif (after($Set-&gt;answer_date, $submitTime)) {
        <span class="keywordflow">return</span> ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_answer_date&quot;</span>) &amp;&amp;
             ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
               $canShowScores ) );
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2d069ab43d45eafa609a372dd10bb5ab"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::can_recordAnswers" ref="a2d069ab43d45eafa609a372dd10bb5ab" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::can_recordAnswers </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-can_recordAnswers' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-can_recordAnswers-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-can_recordAnswers-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-can_recordAnswers-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in can_recordAnswers: 57</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a2d069ab43d45eafa609a372dd10bb5ab">can_recordAnswers</a> {
    my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem, 
        $tmplSet, $submitAnswers) = @_;
    my $authz = $self-&gt;r-&gt;authz;

<span class="preprocessor"># easy first case: never record answers for undefined sets</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> ( $Set-&gt;set_id eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> );

    my $timeNow = ( defined($self-&gt;{timeNow}) ) ? $self-&gt;{timeNow} : time();
<span class="preprocessor">   # get the sag time after the due date in which we&#39;ll still grade the test</span>
<span class="preprocessor"></span>    my $grace = $self-&gt;{ce}-&gt;{gatewayGracePeriod};

    my $submitTime = ( defined($Set-&gt;version_last_attempt_time()) &amp;&amp;
               $Set-&gt;version_last_attempt_time() ) ? 
               $Set-&gt;version_last_attempt_time() : $timeNow;

    <span class="keywordflow">if</span> ($User-&gt;user_id ne $EffectiveUser-&gt;user_id) {
        my $recordAsOther = $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_when_acting_as_student&quot;</span>);
        my $recordVersionsAsOther = $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_set_version_answers_when_acting_as_student&quot;</span>);

        <span class="keywordflow">if</span> ( $recordAsOther ) {
            <span class="keywordflow">return</span> $recordAsOther;
        } elsif ( ! $recordVersionsAsOther ) {
            <span class="keywordflow">return</span> $recordVersionsAsOther;
        }
<span class="preprocessor">        ## if we&#39;re not allowed to record answers as another user,</span>
<span class="preprocessor"></span><span class="preprocessor">        ##    return that permission.  if we&#39;re allowed to record</span>
<span class="preprocessor"></span><span class="preprocessor">        ##    only set version answers, then we allow that between</span>
<span class="preprocessor"></span><span class="preprocessor">        ##    the open and close dates, and so drop out of this</span>
<span class="preprocessor"></span><span class="preprocessor">        ##    conditional to the usual one.</span>
<span class="preprocessor"></span><span class="preprocessor">        ## it isn&#39;t clear if this is the correct behavior, but I</span>
<span class="preprocessor"></span><span class="preprocessor">        ##    think it&#39;s probably reasonable.</span>
<span class="preprocessor"></span>    }

    <span class="keywordflow">if</span> (before($Set-&gt;open_date, $submitTime)) {
<span class="preprocessor">        #    warn(&quot;case 0\n&quot;);</span>
<span class="preprocessor"></span>        <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_before_open_date&quot;</span>);
    } elsif (between($Set-&gt;open_date, ($Set-&gt;due_date + $grace), $submitTime)) {

<span class="preprocessor"># gateway change here; we look at maximum attempts per version, not for the set,</span>
<span class="preprocessor"></span><span class="preprocessor">#   to determine the number of attempts allowed</span>
<span class="preprocessor"></span><span class="preprocessor"># $addOne allows us to count the current submission</span>
<span class="preprocessor"></span>        my $addOne = ( defined( $submitAnswers ) &amp;&amp; $submitAnswers ) ? 
        1 : 0;
        my $attempts_per_version = $Set-&gt;attempts_per_version() || 0;
        my $attempts_used = $Problem-&gt;num_correct+$Problem-&gt;num_incorrect+$addOne;
        <span class="keywordflow">if</span> ($attempts_per_version == -1 or $attempts_used &lt; $attempts_per_version) {
            <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_open_date_with_attempts&quot;</span>);
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_open_date_without_attempts&quot;</span>);
        }
    } elsif (between(($Set-&gt;due_date + $grace), $Set-&gt;answer_date, $submitTime)) {
        <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_due_date&quot;</span>);
    } elsif (after($Set-&gt;answer_date, $submitTime)) {
        <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_answer_date&quot;</span>);
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2e48d49a5c26dee9d38f3d026528a93f"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::can_showCorrectAnswers" ref="a2e48d49a5c26dee9d38f3d026528a93f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::can_showCorrectAnswers </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-can_showCorrectAnswers' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-can_showCorrectAnswers-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-can_showCorrectAnswers-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-can_showCorrectAnswers-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in can_showCorrectAnswers: 32</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a2e48d49a5c26dee9d38f3d026528a93f">can_showCorrectAnswers</a> {
    my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem, 
        $tmplSet, $submitAnswers) = @_;
    my $authz = $self-&gt;r-&gt;authz;
    
<span class="preprocessor"># gateway change here to allow correct answers to be viewed after all attempts</span>
<span class="preprocessor"></span><span class="preprocessor">#   at a version are exhausted as well as if it&#39;s after the answer date</span>
<span class="preprocessor"></span><span class="preprocessor"># $addOne allows us to count the current submission</span>
<span class="preprocessor"></span>    my $addOne = defined( $submitAnswers ) ? $submitAnswers : 0;
    my $maxAttempts = $Set-&gt;attempts_per_version() || 0;
    my $attemptsUsed = $Problem-&gt;num_correct + $Problem-&gt;num_incorrect + 
        $addOne || 0;

<span class="preprocessor"># this is complicated by trying to address hiding scores by problem---that</span>
<span class="preprocessor"></span><span class="preprocessor">#    is, if $set-&gt;hide_score_by_problem and $set-&gt;hide_score are both set, </span>
<span class="preprocessor"></span><span class="preprocessor">#    then we should allow scores to be shown, but not show the score on </span>
<span class="preprocessor"></span><span class="preprocessor">#    any individual problem.  to deal with this, we make </span>
<span class="preprocessor"></span><span class="preprocessor">#    can_showCorrectAnswers give the least restrictive view of hiding, and </span>
<span class="preprocessor"></span><span class="preprocessor">#    then filter scores for the problems themselves later</span>
<span class="preprocessor"></span>    my $canShowScores = ( $Set-&gt;hide_score eq <span class="charliteral">&#39;N&#39;</span> ||
                  $Set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;Y&#39;</span> ||
                  ( $Set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp;
                after($tmplSet-&gt;answer_date) ) );

    <span class="keywordflow">return</span> ( ( ( after( $Set-&gt;answer_date ) || 
             ( $attemptsUsed &gt;= $maxAttempts &amp;&amp; 
               $Set-&gt;due_date() == $Set-&gt;answer_date() ) ) ||
           $authz-&gt;hasPermissions($User-&gt;user_id, 
                <span class="stringliteral">&quot;show_correct_answers_before_answer_date&quot;</span>) ) &amp;&amp;
         ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
           $canShowScores ) );
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a293e2d14f51a3b7553b70cf5ac1683d5"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::can_showHints" ref="a293e2d14f51a3b7553b70cf5ac1683d5" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::can_showHints </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-can_showHints' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-can_showHints-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-can_showHints-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-can_showHints-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in can_showHints: 5</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a293e2d14f51a3b7553b70cf5ac1683d5">can_showHints</a> {
<span class="preprocessor">    #my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem) = @_;</span>
<span class="preprocessor"></span>    
    <span class="keywordflow">return</span> 1;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ac5b90f00068e1a1cb89ac054fa9c780a"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::can_showOldAnswers" ref="ac5b90f00068e1a1cb89ac054fa9c780a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::can_showOldAnswers </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-can_showOldAnswers' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-can_showOldAnswers-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-can_showOldAnswers-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-can_showOldAnswers-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in can_showOldAnswers: 11</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#ac5b90f00068e1a1cb89ac054fa9c780a">can_showOldAnswers</a> {
    my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem, $tmplSet ) = @_;
    my $authz = $self-&gt;r-&gt;authz;
<span class="preprocessor"># we&#39;d like to use &quot;! $Set-&gt;hide_work()&quot;, but that hides students&#39; work </span>
<span class="preprocessor"></span><span class="preprocessor"># as they&#39;re working on the set, which isn&#39;t quite right.  so use instead:</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span>( before( $Set-&gt;due_date() ) || 
        
        $authz-&gt;hasPermissions($User-&gt;user_id,<span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
        ( $Set-&gt;hide_work() eq <span class="charliteral">&#39;N&#39;</span> || 
          ( $Set-&gt;hide_work() eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp; time &gt; $tmplSet-&gt;answer_date ) ) );
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="adf0e6c5b7c11c901dbbe574d09354050"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::can_showScore" ref="adf0e6c5b7c11c901dbbe574d09354050" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::can_showScore </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-can_showScore' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-can_showScore-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-can_showScore-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-can_showScore-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in can_showScore: 16</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#adf0e6c5b7c11c901dbbe574d09354050">can_showScore</a> {
    my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem,
        $tmplSet, $submitAnswers) = @_;
    my $authz = $self-&gt;r-&gt;authz;

    my $timeNow = ( defined($self-&gt;{timeNow}) ) ? $self-&gt;{timeNow} : time();

<span class="preprocessor">    # address hiding scores by problem</span>
<span class="preprocessor"></span>    my $canShowScores = ( $Set-&gt;hide_score eq <span class="charliteral">&#39;N&#39;</span> ||
                  $Set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;Y&#39;</span> ||
                  ( $Set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp;
                after($tmplSet-&gt;answer_date) ) );

    <span class="keywordflow">return</span>( $authz-&gt;hasPermissions($User-&gt;user_id,<span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
        $canShowScores );
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a51093cea9e6da90f9b5506f281b8bebc"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::can_showSolutions" ref="a51093cea9e6da90f9b5506f281b8bebc" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::can_showSolutions </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-can_showSolutions' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-can_showSolutions-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-can_showSolutions-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-can_showSolutions-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in can_showSolutions: 32</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a51093cea9e6da90f9b5506f281b8bebc">can_showSolutions</a> {
    my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem, 
        $tmplSet, $submitAnswers) = @_;
    my $authz = $self-&gt;r-&gt;authz;

<span class="preprocessor"># this is the same as can_showCorrectAnswers    </span>
<span class="preprocessor"></span><span class="preprocessor"># gateway change here to allow correct answers to be viewed after all attempts</span>
<span class="preprocessor"></span><span class="preprocessor">#   at a version are exhausted as well as if it&#39;s after the answer date</span>
<span class="preprocessor"></span><span class="preprocessor"># $addOne allows us to count the current submission</span>
<span class="preprocessor"></span>    my $addOne = defined( $submitAnswers ) ? $submitAnswers : 0;
    my $attempts_per_version = $Set-&gt;attempts_per_version() || 0;
    my $attemptsUsed = $Problem-&gt;num_correct+$Problem-&gt;num_incorrect+$addOne || 0;

<span class="preprocessor"># this is complicated by trying to address hiding scores by problem---that</span>
<span class="preprocessor"></span><span class="preprocessor">#    is, if $set-&gt;hide_score_by_problem and $set-&gt;hide_score are both set, </span>
<span class="preprocessor"></span><span class="preprocessor">#    then we should allow scores to be shown, but not show the score on </span>
<span class="preprocessor"></span><span class="preprocessor">#    any individual problem.  to deal with this, we make can_showSolutions </span>
<span class="preprocessor"></span><span class="preprocessor">#    give the least restrictive view of hiding, and then filter scores for </span>
<span class="preprocessor"></span><span class="preprocessor">#    the problems themselves later</span>
<span class="preprocessor"></span>    my $canShowScores = ( $Set-&gt;hide_score eq <span class="charliteral">&#39;N&#39;</span> ||
                  $Set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;Y&#39;</span> ||
                  ( $Set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp;
                after($tmplSet-&gt;answer_date) ) );

    <span class="keywordflow">return</span> ( ( ( after( $Set-&gt;answer_date ) || 
             ( $attemptsUsed &gt;= $attempts_per_version &amp;&amp; 
               $Set-&gt;due_date() == $Set-&gt;answer_date() ) ) ||
           $authz-&gt;hasPermissions($User-&gt;user_id, 
                <span class="stringliteral">&quot;show_correct_answers_before_answer_date&quot;</span>) ) &amp;&amp;
         ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
           $canShowScores ) );
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a516fc752fc5b49b1a983b0aaa66a2b2e"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::getProblemHTML" ref="a516fc752fc5b49b1a983b0aaa66a2b2e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::getProblemHTML </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-getProblemHTML' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-getProblemHTML-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-getProblemHTML-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-getProblemHTML-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in getProblemHTML: 87</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a516fc752fc5b49b1a983b0aaa66a2b2e">getProblemHTML</a> {
    my ( $self, $EffectiveUser, $set, $formFields,
         $mergedProblem, $pgFile ) = @_;
<span class="preprocessor"># in:  $EffectiveUser is the effective user we&#39;re working as, $set is the</span>
<span class="preprocessor"></span><span class="preprocessor">#      merged set version, %$formFields the form fields from the input form</span>
<span class="preprocessor"></span><span class="preprocessor">#      that we need to worry about putting into the HTML we&#39;re generating,</span>
<span class="preprocessor"></span><span class="preprocessor">#      and $mergedProblem and $pgFile are what we&#39;d expect.</span>
<span class="preprocessor"></span><span class="preprocessor">#      $pgFile is optional</span>
<span class="preprocessor"></span><span class="preprocessor"># out: the translated problem is returned</span>
<span class="preprocessor"></span>
    my $r = $self-&gt;r;
    my $ce = $r-&gt;ce;
    my $db = $r-&gt;db;
    my $key =  $r-&gt;param(<span class="stringliteral">&#39;key&#39;</span>);
    my $setName = $set-&gt;set_id;
    my $setVersionNumber = $set-&gt;version_id;
    my $permissionLevel = $self-&gt;{permissionLevel};
    my $psvn = $set-&gt;psvn();

    <span class="keywordflow">if</span> ( defined($mergedProblem) &amp;&amp; $mergedProblem-&gt;problem_id ) {
<span class="preprocessor"># nothing needs to be done</span>
<span class="preprocessor"></span>
    } elsif ($pgFile) {
        $mergedProblem = 
            <a class="code" href="classWeBWorK_1_1DB_1_1Record_1_1ProblemVersion.html">WeBWorK::DB::Record::ProblemVersion</a>-&gt;new(
                    set_id =&gt; $setName,
                    version_id =&gt; $setVersionNumber,
                    problem_id =&gt; 0,
                    login_id =&gt; $EffectiveUser-&gt;user_id,
                    source_file =&gt; $pgFile,
            # the rest of Problem<span class="stringliteral">&#39;s fields are not needed, i think</span>
<span class="stringliteral">                                 );</span>
<span class="stringliteral">    }</span>
<span class="stringliteral"># figure out if we&#39;</span>re allowed to <span class="keyword">get</span> solutions and call PG-&gt;new accordingly.
    my $showCorrectAnswers = $self-&gt;{will}-&gt;{showCorrectAnswers};
    my $showHints          = $self-&gt;{will}-&gt;{showHints};
    my $showSolutions      = $self-&gt;{will}-&gt;{showSolutions};
    my $processAnswers     = $self-&gt;{will}-&gt;{checkAnswers};

<span class="preprocessor"># FIXME  I&#39;m not sure that problem_id is what we want here  FIXME</span>
<span class="preprocessor"></span>    my $problemNumber = $mergedProblem-&gt;problem_id;

    my $pg = 
        <a class="code" href="classWeBWorK_1_1PG.html">WeBWorK::PG</a>-&gt;new(
             $ce,
             $EffectiveUser,
             $key,
             $set,
             $mergedProblem,
             $psvn,
             $formFields, 
             { # translation options
                 displayMode     =&gt; $self-&gt;{displayMode},
                 showHints       =&gt; $showHints,
                 showSolutions   =&gt; $showSolutions,
                 refreshMath2img =&gt; $showHints || $showSolutions,
                 processAnswers  =&gt; 1,
                 QUIZ_PREFIX     =&gt; <span class="charliteral">&#39;Q&#39;</span> . 
                 sprintf(<span class="stringliteral">&quot;%04d&quot;</span>,$problemNumber) . <span class="charliteral">&#39;_&#39;</span>,
                 },
                 );
    
<span class="preprocessor"># FIXME  is problem_id the correct thing in the following two stanzas?</span>
<span class="preprocessor"></span><span class="preprocessor"># FIXME  the original version had &quot;problem number&quot;, which is what we want.</span>
<span class="preprocessor"></span><span class="preprocessor"># FIXME  I think problem_id will work, too</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ($pg-&gt;{warnings} ne <span class="stringliteral">&quot;&quot;</span>) {
        push @{$self-&gt;{warnings}}, {
            <span class="keyword">set</span>     =&gt; <span class="stringliteral">&quot;$setName,v$setVersionNumber&quot;</span>,
            problem =&gt; $mergedProblem-&gt;problem_id,
            <a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a> =&gt; $pg-&gt;{warnings},
        };
    }

    <span class="keywordflow">if</span> ($pg-&gt;{flags}-&gt;{error_flag}) {
        push @{$self-&gt;{errors}}, {
            <span class="keyword">set</span>     =&gt; <span class="stringliteral">&quot;$setName,v$setVersionNumber&quot;</span>,
            problem =&gt; $mergedProblem-&gt;problem_id,
            <a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a> =&gt; $pg-&gt;{errors},
            context =&gt; $pg-&gt;{body_text},
        };
<span class="preprocessor">    # if there was an error, body_text contains</span>
<span class="preprocessor"></span><span class="preprocessor">    # the error context, not TeX code</span>
<span class="preprocessor"></span>        $pg-&gt;{body_text} = undef;
    }

    <span class="keywordflow">return</span>    $pg;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a38e35306aec2a93393b9817579c93670"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::nav" ref="a38e35306aec2a93393b9817579c93670" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::nav </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-nav' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-nav-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-nav-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-nav-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in nav: 13</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a38e35306aec2a93393b9817579c93670">nav</a> {
    my ($self, $args) = @_;
    
    my $r = $self-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a>};
    my $setName = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
    my $ce = $self-&gt;{ce};
    my $root = $ce-&gt;{webworkURLs}-&gt;{root};
    my $courseName = $ce-&gt;{courseName};
    my @links = (<span class="stringliteral">&quot;Problem Sets&quot;</span> , <span class="stringliteral">&quot;$root/$courseName&quot;</span>, <span class="stringliteral">&quot;navUp&quot;</span>);
    my $tail = <span class="stringliteral">&quot;&quot;</span>;
    
    <span class="keywordflow">return</span> $self-&gt;navMacro($args, $tail, @links);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aee8845a5fa3c2cd056f3cc380e02f794"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::options" ref="aee8845a5fa3c2cd056f3cc380e02f794" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::options </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-options' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-options-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-options-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-options-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in options: 20</span>
<span class="preprocessor"></span>sub options {
    my ($self) = @_;
<span class="preprocessor">    #warn &quot;doing options in GatewayQuiz&quot;;</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    # don&#39;t show options if we don&#39;t have anything to show</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{invalidSet} or $self-&gt;{invalidProblem};
    <span class="keywordflow">return</span> unless $self-&gt;{isOpen};
    
    my $displayMode = $self-&gt;{displayMode};
    my %can = %{ $self-&gt;{can} };
    
    my @options_to_show = <span class="stringliteral">&quot;displayMode&quot;</span>;
    push @options_to_show, <span class="stringliteral">&quot;showOldAnswers&quot;</span> <span class="keywordflow">if</span> $can{showOldAnswers};
    push @options_to_show, <span class="stringliteral">&quot;showHints&quot;</span> <span class="keywordflow">if</span> $can{showHints};
    push @options_to_show, <span class="stringliteral">&quot;showSolutions&quot;</span> <span class="keywordflow">if</span> $can{showSolutions};
    
    <span class="keywordflow">return</span> $self-&gt;optionsMacro(
        options_to_show =&gt; \@options_to_show,
    );
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a005727b2bfd1db0b8e2fb2f2f3c60937"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::path" ref="a005727b2bfd1db0b8e2fb2f2f3c60937" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::path </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-path' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-path-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-path-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-path-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in path: 13</span>
<span class="preprocessor"></span>sub path {
    my ( $self, $args ) = @_;

    my $r = $self-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a>};
    my $setName = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
    my $ce = $self-&gt;{ce};
    my $root = $ce-&gt;{webworkURLs}-&gt;{root};
    my $courseName = $ce-&gt;{courseName};
 
    <span class="keywordflow">return</span> $self-&gt;pathMacro( $args, <span class="stringliteral">&quot;Home&quot;</span> =&gt; <span class="stringliteral">&quot;$root&quot;</span>, 
                 $courseName =&gt; <span class="stringliteral">&quot;$root/$courseName&quot;</span>,
                 $setName =&gt; <span class="stringliteral">&quot;&quot;</span> );
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1ContentGenerator.html#a0d6e37ff9d1e8ad720dc4ed5f63fa773">WeBWorK::ContentGenerator</a>.</p>

</div>
</div>
<a class="anchor" id="aee77b0d8b0c428ee0673a3b74fe2c2d8"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::pre_header_initialize" ref="aee77b0d8b0c428ee0673a3b74fe2c2d8" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::pre_header_initialize </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-pre_header_initialize' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-pre_header_initialize-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-pre_header_initialize-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-pre_header_initialize-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in pre_header_initialize: 737</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#aee77b0d8b0c428ee0673a3b74fe2c2d8">pre_header_initialize</a> {
    my ($self)     = @_;

    my $r = $self-&gt;r;
    my $ce = $r-&gt;ce;
    my $db = $r-&gt;db;
    my $authz = $r-&gt;authz;
    my $urlpath = $r-&gt;urlpath;

    my $setName = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
    my $userName = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
    my $effectiveUserName = $r-&gt;param(<span class="stringliteral">&#39;effectiveUser&#39;</span>);
    my $key = $r-&gt;param(<span class="stringliteral">&#39;key&#39;</span>);

<span class="preprocessor">    # should we allow a new version to be created when</span>
<span class="preprocessor"></span><span class="preprocessor">    #    acting as a user?</span>
<span class="preprocessor"></span>    my $verCreateOK = ( defined( $r-&gt;param(<span class="stringliteral">&#39;createnew_ok&#39;</span>) ) ) ?
        $r-&gt;param(<span class="stringliteral">&#39;createnew_ok&#39;</span>) : 0;

<span class="preprocessor">    # user checks</span>
<span class="preprocessor"></span>    my $User = $db-&gt;getUser($userName);
    die <span class="stringliteral">&quot;record for user $userName (real user) does not exist.&quot;</span> 
        unless defined $User;
    my $EffectiveUser = $db-&gt;getUser($effectiveUserName);
    die <span class="stringliteral">&quot;record for user $effectiveUserName (effective user) does &quot;</span> .
        <span class="stringliteral">&quot;not exist.&quot;</span> unless defined $EffectiveUser;

    my $PermissionLevel = $db-&gt;getPermissionLevel($userName);
    die <span class="stringliteral">&quot;permission level record for $userName does not exist (but the &quot;</span> .
        <span class="stringliteral">&quot;user does? odd...)&quot;</span> unless defined($PermissionLevel);
    my $permissionLevel = $PermissionLevel-&gt;permission;

<span class="preprocessor"># we could be coming in with $setName = the versioned or nonversioned set</span>
<span class="preprocessor"></span><span class="preprocessor"># deal with that first</span>
<span class="preprocessor"></span>    my $requestedVersion = ( $setName =~ /,v(\d+)$/ ) ? $1 : 0;
    $setName =~ s/,v\d+$<span class="comment">//;</span>
<span class="preprocessor"># note that if we&#39;re already working with a version we want to be sure to stick</span>
<span class="preprocessor"></span><span class="preprocessor"># with that version.  we do this after we&#39;ve validated that the user is</span>
<span class="preprocessor"></span><span class="preprocessor"># assigned the set, below</span>
<span class="preprocessor"></span>
<span class="preprocessor">###################################</span>
<span class="preprocessor"></span><span class="preprocessor"># gateway set and problem collection</span>
<span class="preprocessor"></span><span class="preprocessor">###################################</span>
<span class="preprocessor"></span>
<span class="preprocessor"># we need the template (user) set, the merged set-version, and a </span>
<span class="preprocessor"></span><span class="preprocessor">#    problem from the set to be able to test whether we&#39;re creating a </span>
<span class="preprocessor"></span><span class="preprocessor">#    new set version.  assemble these</span>
<span class="preprocessor"></span>    my ( $tmplSet, $set, $Problem ) = ( 0, 0, 0 );

<span class="preprocessor"># if the set comes in as &quot;Undefined_Set&quot;, then we&#39;re trying/editing a </span>
<span class="preprocessor"></span><span class="preprocessor">#    single problem in a set, and so create a fake set with which to work</span>
<span class="preprocessor"></span><span class="preprocessor">#    if the user has the authorization to do that.</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $setName eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> ) {

<span class="preprocessor">        # make sure these are defined</span>
<span class="preprocessor"></span>        $requestedVersion = 1;
        $self-&gt;{assignment_type} = <span class="stringliteral">&#39;gateway&#39;</span>;

        <span class="keywordflow">if</span> ( ! $authz-&gt;hasPermissions($userName,
                          <span class="stringliteral">&quot;modify_problem_sets&quot;</span>) ) {
            $self-&gt;{invalidSet} = <span class="stringliteral">&quot;You do not have the &quot;</span> .
                <span class="stringliteral">&quot;authorization level required to view/&quot;</span> .
                <span class="stringliteral">&quot;edit undefined sets.&quot;</span>;

<span class="preprocessor">            # define these so that we can drop through</span>
<span class="preprocessor"></span><span class="preprocessor">            #    to report the error in body()</span>
<span class="preprocessor"></span>            $tmplSet = fake_set( $db );
            $set     = fake_set_version( $db );
            $Problem = fake_problem( $db );
        } <span class="keywordflow">else</span> {
<span class="preprocessor">    # in this case we&#39;re creating a fake set from the input, so</span>
<span class="preprocessor"></span><span class="preprocessor">    #    the input must include a source file.</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ( ! $r-&gt;param(<span class="stringliteral">&quot;sourceFilePath&quot;</span>) ) {
                $self-&gt;{invalidSet} = <span class="stringliteral">&quot;An Undefined_Set &quot;</span> .
                    <span class="stringliteral">&quot;was requested, but no source &quot;</span> .
                    <span class="stringliteral">&quot;file for the contained problem &quot;</span> .
                    <span class="stringliteral">&quot;was provided.&quot;</span>;

<span class="preprocessor">                # define these so that we can drop through</span>
<span class="preprocessor"></span><span class="preprocessor">                #    to report the error in body()</span>
<span class="preprocessor"></span>                $tmplSet = fake_set( $db );
                $set     = fake_set_version( $db );
                $Problem = fake_problem( $db );

            } <span class="keywordflow">else</span> {
                my $sourceFPath = $r-&gt;param(<span class="stringliteral">&quot;sourceFilePath&quot;</span>);
                die(<span class="stringliteral">&quot;sourceFilePath is unsafe!&quot;</span>) unless
                    path_is_subdir($sourceFPath,
                        $ce-&gt;{courseDirs}-&gt;{templates},
                        1);

                $tmplSet = fake_set( $db );
                $set     = fake_set_version( $db );
                $Problem = fake_problem( $db );

                $tmplSet-&gt;assignment_type( <span class="stringliteral">&quot;gateway&quot;</span> );
                $tmplSet-&gt;attempts_per_version( 0 );
                $tmplSet-&gt;time_interval( 0 );
                $tmplSet-&gt;versions_per_interval(1);
                $tmplSet-&gt;version_time_limit( 0 );
                $tmplSet-&gt;version_creation_time( time() );
                $tmplSet-&gt;problem_randorder( 0 );
                $tmplSet-&gt;problems_per_page( 1 );
                $tmplSet-&gt;hide_score(<span class="charliteral">&#39;N&#39;</span>);
                $tmplSet-&gt;hide_score_by_problem(<span class="charliteral">&#39;N&#39;</span>);
                $tmplSet-&gt;hide_work(<span class="charliteral">&#39;N&#39;</span>);
                $tmplSet-&gt;time_limit_cap(<span class="charliteral">&#39;0&#39;</span>);
                $tmplSet-&gt;restrict_ip(<span class="stringliteral">&#39;No&#39;</span>);

                $set-&gt;assignment_type( <span class="stringliteral">&quot;gateway&quot;</span> );
                $set-&gt;time_interval( 0 );
                $set-&gt;versions_per_interval(1);
                $set-&gt;version_time_limit( 0 );
                $set-&gt;version_creation_time( time() );
                $set-&gt;time_limit_cap(<span class="charliteral">&#39;0&#39;</span>);

                $Problem-&gt;problem_id(1);
                $Problem-&gt;source_file($sourceFPath);
                $Problem-&gt;user_id($effectiveUserName);
                $Problem-&gt;value(1);
                $Problem-&gt;problem_seed( $r-&gt;param(<span class="stringliteral">&quot;problemSeed&quot;</span>) ) <span class="keywordflow">if</span> ( $r-&gt;param(<span class="stringliteral">&quot;problemSeed&quot;</span>) );
            }
        }
    } <span class="keywordflow">else</span> {

<span class="preprocessor"># get template set: the non-versioned set that&#39;s assigned to the user</span>
<span class="preprocessor"></span><span class="preprocessor">#    if this fails/failed in authz-&gt;checkSet, then $self-&gt;{invalidSet} is</span>
<span class="preprocessor"></span><span class="preprocessor">#    set</span>
<span class="preprocessor"></span>        $tmplSet = $db-&gt;getMergedSet( $effectiveUserName, $setName );

<span class="preprocessor">    # now we know that we&#39;re in a gateway test, save the assignment test </span>
<span class="preprocessor"></span><span class="preprocessor">    #    for the processing of proctor keys for graded proctored tests; </span>
<span class="preprocessor"></span><span class="preprocessor">    #    if we failed to get the set from the database, we store a fake </span>
<span class="preprocessor"></span><span class="preprocessor">    #    value here to be able to continue</span>
<span class="preprocessor"></span>        $self-&gt;{<span class="stringliteral">&#39;assignment_type&#39;</span>} = $tmplSet-&gt;assignment_type() ||
            <span class="stringliteral">&#39;gateway&#39;</span>;

<span class="preprocessor">    # next, get the latest (current) version of the set if we don&#39;t have a </span>
<span class="preprocessor"></span><span class="preprocessor">    #     requested version number</span>
<span class="preprocessor"></span>        my @allVersionIds = $db-&gt;listSetVersions($effectiveUserName,
                             $setName);
        my $latestVersion = (@allVersionIds ? $allVersionIds[-1] : 0);

<span class="preprocessor">    # double check that any requested version makes sense</span>
<span class="preprocessor"></span>        $requestedVersion = $latestVersion 
          <span class="keywordflow">if</span> ( $requestedVersion !~ /^\d+$/ ||
               $requestedVersion &gt; $latestVersion ||
               $requestedVersion &lt; 0 );

        die(<span class="stringliteral">&quot;No requested version when returning to problem?!&quot;</span>) 
            if ( ( $r-&gt;param(&quot;previewAnswers&quot;) ||
                   $r-&gt;param(&quot;checkAnswers&quot;) ||
                   $r-&gt;param(&quot;submitAnswers&quot;) ||
                   $r-&gt;param(&quot;newPage&quot;) ) &amp;&amp; ! $requestedVersion );

    <span class="preprocessor"># to test for a proctored test, we need the set version, not the </span>
<span class="preprocessor"></span><span class="preprocessor">    #    template, to allow a finished proctored test to be checked as an </span>
<span class="preprocessor"></span><span class="preprocessor">    #    unproctored test.  so we get the versioned set here</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $requestedVersion ) {
<span class="preprocessor">    # if a specific set version was requested, it was stored in the $authz</span>
<span class="preprocessor"></span><span class="preprocessor">    #    object when we did the set check</span>
<span class="preprocessor"></span>            $set = $db-&gt;getMergedSetVersion($effectiveUserName,
                            $setName,
                            $requestedVersion);
        } elsif ( $latestVersion ) {
<span class="preprocessor">    # otherwise, if there&#39;s a current version, which we take to be the </span>
<span class="preprocessor"></span><span class="preprocessor">    #    latest version taken, we use that</span>
<span class="preprocessor"></span>            $set = $db-&gt;getMergedSetVersion($effectiveUserName,
                            $setName,
                            $latestVersion);
        } <span class="keywordflow">else</span> {
<span class="preprocessor">    # and if neither of those work, get a dummy set so that we have </span>
<span class="preprocessor"></span><span class="preprocessor">    #    something to work with</span>
<span class="preprocessor"></span>            my $userSetClass = $ce-&gt;{dbLayout}-&gt;{set_version}-&gt;{record};
<span class="preprocessor"># FIXME RETURN TO: should this be global2version?</span>
<span class="preprocessor"></span>            $set = global2user($userSetClass, 
                       $db-&gt;getGlobalSet($setName));
            die <span class="stringliteral">&quot;set  $setName  not found.&quot;</span>  unless $set;
            $set-&gt;user_id($effectiveUserName);
            $set-&gt;psvn(<span class="stringliteral">&#39;000&#39;</span>);
            $set-&gt;set_id(<span class="stringliteral">&quot;$setName&quot;</span>);  # redundant?
            $set-&gt;version_id(0);
        }
    }
    my $setVersionNumber = ($set) ? $set-&gt;version_id() : 0;

<span class="preprocessor">    #################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # assemble gateway parameters</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # we get the open/close dates for the gateway from the template set.</span>
<span class="preprocessor"></span><span class="preprocessor">    #    note $isOpen/Closed give the open/close dates for the gateway</span>
<span class="preprocessor"></span><span class="preprocessor">    #    as a whole (that is, the merged user|global set).  because the</span>
<span class="preprocessor"></span><span class="preprocessor">    #    set could be bad (if $self-&gt;{invalidSet}), we check -&gt;open_date</span>
<span class="preprocessor"></span><span class="preprocessor">    #    before actually testing the date</span>
<span class="preprocessor"></span>    my $isOpen = $tmplSet &amp;&amp; $tmplSet-&gt;open_date &amp;&amp; 
        ( after($tmplSet-&gt;open_date()) || 
          $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;view_unopened_sets&quot;</span>) );

<span class="preprocessor">    # FIXME for $isClosed, &quot;record_answers_after_due_date&quot; isn&#39;t quite</span>
<span class="preprocessor"></span><span class="preprocessor">    #    the right description, but it seems reasonable</span>
<span class="preprocessor"></span>    my $isClosed = $tmplSet &amp;&amp; $tmplSet-&gt;due_date &amp;&amp;
        ( after($tmplSet-&gt;due_date()) &amp;&amp;
          ! $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;record_answers_after_due_date&quot;</span>) );

<span class="preprocessor">    # to determine if we need a new version, we need to know whether this </span>
<span class="preprocessor"></span><span class="preprocessor">    #    version exceeds the number of attempts per version.  (among other</span>
<span class="preprocessor"></span><span class="preprocessor">    #    things,) the number of attempts is a property of the problem, so </span>
<span class="preprocessor"></span><span class="preprocessor">    #    get a problem to check that.  note that for a gateway/quiz all </span>
<span class="preprocessor"></span><span class="preprocessor">    #    problems will have the same number of attempts.  This means that </span>
<span class="preprocessor"></span><span class="preprocessor">    #    if the set doesn&#39;t have any problems we&#39;re up a creek, so check </span>
<span class="preprocessor"></span><span class="preprocessor">    #    for that here and bail if it&#39;s the case</span>
<span class="preprocessor"></span>    my @setPNum = $setName eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> ? ( 1 ) :
        $db-&gt;listUserProblems($EffectiveUser-&gt;user_id, $setName);
    die(<span class="stringliteral">&quot;Set $setName contains no problems.&quot;</span>) if ( ! @setPNum );

    <span class="preprocessor"># if we assigned a fake problem above, $Problem is already defined.</span>
<span class="preprocessor"></span><span class="preprocessor">    #    otherwise, we get the Problem, or define it to be undefined if</span>
<span class="preprocessor"></span><span class="preprocessor">    #    the set hasn&#39;t been versioned to the user yet--this gets fixed</span>
<span class="preprocessor"></span><span class="preprocessor">    #    when we assign the setVersion</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! $Problem ) {
        $Problem = $setVersionNumber ?
            $db-&gt;getMergedProblemVersion($EffectiveUser-&gt;user_id,
                $setName, $setVersionNumber, $setPNum[0]) :
                undef;
    }

<span class="preprocessor">    # note that having $maxAttemptsPerVersion set to an infinite/0 value is</span>
<span class="preprocessor"></span><span class="preprocessor">    #    nonsensical; if we did that, why have versions? (might want to do it for one individual?)</span>
<span class="preprocessor"></span>    my $maxAttemptsPerVersion = $tmplSet-&gt;attempts_per_version() || 0;
    my $timeInterval          = $tmplSet-&gt;time_interval() || 0;
    my $versionsPerInterval   = $tmplSet-&gt;versions_per_interval() || 0;
    my $timeLimit             = $tmplSet-&gt;version_time_limit() || 0;

<span class="preprocessor">    # what happens if someone didn&#39;t set one of these?  I think this can</span>
<span class="preprocessor"></span><span class="preprocessor">    # happen if we&#39;re handed a malformed set, where the values in the</span>
<span class="preprocessor"></span><span class="preprocessor">    # database are null.</span>
<span class="preprocessor"></span>    $timeInterval = 0 <span class="keywordflow">if</span> (! defined($timeInterval) || $timeInterval eq <span class="stringliteral">&#39;&#39;</span>);
    $versionsPerInterval = 0 <span class="keywordflow">if</span> (! defined($versionsPerInterval) ||
                     $versionsPerInterval eq <span class="stringliteral">&#39;&#39;</span>);

<span class="preprocessor">    # every problem in the set must have the same submission characteristics</span>
<span class="preprocessor"></span>    my $currentNumAttempts    = ( defined($Problem) &amp;&amp; 
                      $Problem-&gt;num_correct() ne <span class="stringliteral">&#39;&#39;</span> ) ? 
                      $Problem-&gt;num_correct() +
                      $Problem-&gt;num_incorrect() : 0;

<span class="preprocessor">    # $maxAttempts turns into the maximum number of versions we can create;</span>
<span class="preprocessor"></span><span class="preprocessor">    #    if $Problem isn&#39;t defined, we can&#39;t have made any attempts, so it</span>
<span class="preprocessor"></span><span class="preprocessor">    #    doesn&#39;t matter</span>
<span class="preprocessor"></span>    my $maxAttempts           = ( defined($Problem) &amp;&amp; 
                      defined($Problem-&gt;max_attempts()) &amp;&amp;
                      $Problem-&gt;max_attempts() ) ? 
                      $Problem-&gt;max_attempts() : -1;

<span class="preprocessor">    # finding the number of versions per time interval is a little harder.</span>
<span class="preprocessor"></span><span class="preprocessor">    #    we interpret the time interval as a rolling interval: that is,</span>
<span class="preprocessor"></span><span class="preprocessor">    #    if we allow two sets per day, that&#39;s two sets in any 24 hour</span>
<span class="preprocessor"></span><span class="preprocessor">    #    period.  this is probably not what we really want, but it&#39;s</span>
<span class="preprocessor"></span><span class="preprocessor">    #    more extensible to a limitation like &quot;one version per hour&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">    #    and we can set it to two sets per 12 hours for most &quot;2ce daily&quot;</span>
<span class="preprocessor"></span><span class="preprocessor">    #    type applications</span>
<span class="preprocessor"></span>    my $timeNow = time();
    my $grace = $ce-&gt;{gatewayGracePeriod};

    my $currentNumVersions = 0;  # <span class="keyword">this</span> is the number of versions in the
<span class="preprocessor">                                 #    time interval</span>
<span class="preprocessor"></span>    my $totalNumVersions = 0;

<span class="preprocessor">    # we don&#39;t need to check this if $self-&gt;{invalidSet} is already set,</span>
<span class="preprocessor"></span><span class="preprocessor">    #    or if we&#39;re working with an Undefined_Set</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $setVersionNumber &amp;&amp; ! $self-&gt;{invalidSet} &amp;&amp;
         $setName ne <span class="stringliteral">&quot;Undefined_Set&quot;</span> ) {
        my @setVersionIDs = $db-&gt;listSetVersions($effectiveUserName, $setName);
        my @setVersions = $db-&gt;getSetVersions(map {[$effectiveUserName, $setName,, $_]} @setVersionIDs);
        <span class="keywordflow">foreach</span> ( @setVersions ) {
            $totalNumVersions++;
            $currentNumVersions++
                <span class="keywordflow">if</span> ( ! $timeInterval ||
                 $_-&gt;version_creation_time() &gt; ($timeNow - $timeInterval) );
        }
    }

<span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # new version creation conditional</span>
<span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span>
    my $versionIsOpen = 0;  # can we <span class="keywordflow">do</span> anything to <span class="keyword">this</span> version?

<span class="preprocessor">    # recall $isOpen = timeNow &gt; openDate [for the merged userset] and </span>
<span class="preprocessor"></span><span class="preprocessor">    #    $isClosed = timeNow &gt; dueDate [for the merged userset]</span>
<span class="preprocessor"></span><span class="preprocessor">    #    again, if $self-&gt;{invalidSet} is already set, we don&#39;t need to </span>
<span class="preprocessor"></span><span class="preprocessor">    #    to check this</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $isOpen &amp;&amp; ! $isClosed &amp;&amp; ! $self-&gt;{invalidSet} ) {

<span class="preprocessor">    # if no specific version is requested, we can create a new one if </span>
<span class="preprocessor"></span><span class="preprocessor">    #    need be</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( ! $requestedVersion ) {
            <span class="keywordflow">if</span> ( ( $maxAttempts == -1 ||
                   $totalNumVersions &lt; $maxAttempts )
                 &amp;&amp;
                 ( $setVersionNumber == 0 ||
                   (
                 ( $currentNumAttempts&gt;=$maxAttemptsPerVersion
                   ||
                   $timeNow &gt;= $set-&gt;due_date + $grace )
                 &amp;&amp;
                 ( ! $versionsPerInterval 
                   ||
                   $currentNumVersions &lt; $versionsPerInterval )
                 )
                 )
                 &amp;&amp;
                 ( $effectiveUserName eq $userName ||
                    ( $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;record_answers_when_acting_as_student&quot;</span>) ||
                  ( $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;create_new_set_version_when_acting_as_student&quot;</span>) &amp;&amp; $verCreateOK ) ) )

               ) {
<span class="preprocessor">                # assign set, get the right name, version </span>
<span class="preprocessor"></span><span class="preprocessor">                #    number, etc., and redefine the $set </span>
<span class="preprocessor"></span><span class="preprocessor">                #    and $Problem we&#39;re working with</span>
<span class="preprocessor"></span>                my $setTmpl = $db-&gt;getUserSet($effectiveUserName,$setName);
                <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html#aa844361e81ea9f247686fb1d63251d16">WeBWorK::ContentGenerator::Instructor::assignSetVersionToUser</a>($self, $effectiveUserName, $setTmpl);
                $setVersionNumber++;

<span class="preprocessor">                # get a clean version of the set to save,</span>
<span class="preprocessor"></span><span class="preprocessor">                #    and the merged version to use in the </span>
<span class="preprocessor"></span><span class="preprocessor">                #    rest of the routine</span>
<span class="preprocessor"></span>                my $cleanSet = $db-&gt;getSetVersion(
                    $effectiveUserName, $setName,
                    $setVersionNumber);
                $set = $db-&gt;getMergedSetVersion(
                    $effectiveUserName, $setName,
                    $setVersionNumber );

                $Problem = $db-&gt;getMergedProblemVersion(
                    $effectiveUserName, $setName, 
                    $setVersionNumber, 1);

<span class="preprocessor">                # because we&#39;re creating this on the fly, </span>
<span class="preprocessor"></span><span class="preprocessor">                #    it should be visible</span>
<span class="preprocessor"></span>                $set-&gt;visible(1);
<span class="preprocessor">                # set up creation time, open and due dates</span>
<span class="preprocessor"></span>                my $ansOffset = $set-&gt;answer_date() - 
                    $set-&gt;due_date();
                $set-&gt;version_creation_time( $timeNow );
                $set-&gt;open_date( $timeNow );
<span class="preprocessor">                # figure out the due date, taking into account</span>
<span class="preprocessor"></span><span class="preprocessor">                #    any time limit cap</span>
<span class="preprocessor"></span>                my $dueTime = 
                    ( $set-&gt;time_limit_cap &amp;&amp;
                      $timeNow+$timeLimit &gt; $set-&gt;due_date ) ?
                      $set-&gt;due_date : $timeNow+$timeLimit;
                $set-&gt;due_date( $dueTime );
                $set-&gt;answer_date($set-&gt;due_date + $ansOffset);
                $set-&gt;version_last_attempt_time( 0 );

<span class="preprocessor">                # put this new info into the database.  we </span>
<span class="preprocessor"></span><span class="preprocessor">                #    put back that data which we need for the</span>
<span class="preprocessor"></span><span class="preprocessor">                #    version, and leave blank any information</span>
<span class="preprocessor"></span><span class="preprocessor">                #    that we&#39;d like to inherit from the user</span>
<span class="preprocessor"></span><span class="preprocessor">                #    set or global set.  we set the data which</span>
<span class="preprocessor"></span><span class="preprocessor">                #    determines if a set is open, because we</span>
<span class="preprocessor"></span><span class="preprocessor">                #    don&#39;t want the set version to reopen after</span>
<span class="preprocessor"></span><span class="preprocessor">                #    it&#39;s complete</span>
<span class="preprocessor"></span>                $cleanSet-&gt;version_creation_time( $set-&gt;version_creation_time );
                $cleanSet-&gt;open_date( $set-&gt;open_date );
                $cleanSet-&gt;due_date( $set-&gt;due_date );
                $cleanSet-&gt;answer_date( $set-&gt;answer_date );
                $cleanSet-&gt;version_last_attempt_time( $set-&gt;version_last_attempt_time );
                $cleanSet-&gt;version_time_limit( $set-&gt;version_time_limit );
                $cleanSet-&gt;attempts_per_version( $set-&gt;attempts_per_version );
                $cleanSet-&gt;assignment_type( $set-&gt;assignment_type );
                $db-&gt;putSetVersion( $cleanSet );

<span class="preprocessor">                # we have a new set version, so it&#39;s open</span>
<span class="preprocessor"></span>                $versionIsOpen = 1;

<span class="preprocessor">                # also reset the number of attempts for this </span>
<span class="preprocessor"></span><span class="preprocessor">                #    set to zero</span>
<span class="preprocessor"></span>                $currentNumAttempts = 0;

            } elsif ( $maxAttempts != -1 &amp;&amp; 
                  $totalNumVersions &gt; $maxAttempts ) {
                $self-&gt;{invalidSet} = <span class="stringliteral">&quot;No new versions of &quot;</span> .
                    <span class="stringliteral">&quot;this assignment are available,\n&quot;</span> .
                    <span class="stringliteral">&quot;because you have already taken the &quot;</span> .
                    <span class="stringliteral">&quot;maximum number\nallowed.&quot;</span>;

            } elsif ( $effectiveUserName ne $userName &amp;&amp;
                  $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;create_new_set_version_when_acting_as_student&quot;</span>) ) {
                $self-&gt;{invalidSet} = <span class="stringliteral">&quot;User &quot;</span> .
                    <span class="stringliteral">&quot;$effectiveUserName is being acted &quot;</span> .
                    <span class="stringliteral">&quot;as.  If you continue, you will &quot;</span> .
                    <span class="stringliteral">&quot;create a new version of this set &quot;</span> .
                    <span class="stringliteral">&quot;for that user, which will count &quot;</span> .
                    <span class="stringliteral">&quot;against their allowed maximum &quot;</span> .
                    <span class="stringliteral">&quot;number of versions for the current &quot;</span> .
                    <span class="stringliteral">&quot;time interval.  IN GENERAL, THIS &quot;</span> .
                    <span class="stringliteral">&quot;IS NOT WHAT YOU WANT TO DO.  &quot;</span> .
                    <span class="stringliteral">&quot;Please be sure that you want to &quot;</span> .
                    <span class="stringliteral">&quot;do this before clicking the \&quot;&quot;</span> .
                    <span class="stringliteral">&quot;Create new set version\&quot; link &quot;</span> .
                    <span class="stringliteral">&quot;below.  Alternately, PRESS THE &quot;</span> .
                    <span class="stringliteral">&quot;\&quot;BACK\&quot; BUTTON and continue.&quot;</span>;
                $self-&gt;{invalidVersionCreation} = 1;

            } elsif ( $effectiveUserName ne $userName ) {
                $self-&gt;{invalidSet} = <span class="stringliteral">&quot;User &quot;</span> .
                    <span class="stringliteral">&quot;$effectiveUserName is being acted &quot;</span> .
                    <span class="stringliteral">&quot;as.  When acting as another user, &quot;</span> .
                    <span class="stringliteral">&quot;new versions of the set cannot be &quot;</span> .
                    <span class="stringliteral">&quot;created.&quot;</span>;
                $self-&gt;{invalidVersionCreation} = 2;

            } elsif ($currentNumAttempts &lt; $maxAttemptsPerVersion &amp;&amp;
                 $timeNow &lt; $set-&gt;due_date() + $grace ) {
                <span class="keywordflow">if</span> ( between($set-&gt;open_date(), 
                         $set-&gt;due_date() + $grace, 
                         $timeNow) ) {
                    $versionIsOpen = 1;
                } <span class="keywordflow">else</span> {
                    $versionIsOpen = 0;  # redundant
                    $self-&gt;{invalidSet} = <span class="stringliteral">&quot;No new &quot;</span> .
                        <span class="stringliteral">&quot; versions of this assignment&quot;</span> .
                        <span class="stringliteral">&quot; are available,\nbecause the&quot;</span> .
                        <span class="stringliteral">&quot; set is not open or its time&quot;</span> .
                        <span class="stringliteral">&quot; limit has expired.\n&quot;</span>;
                }

            } elsif ($versionsPerInterval &amp;&amp; 
                 ($currentNumVersions &gt;= $versionsPerInterval)){
                $self-&gt;{invalidSet} = <span class="stringliteral">&quot;You have already taken&quot;</span> .
                    <span class="stringliteral">&quot; all available versions of this\n&quot;</span> .
                    <span class="stringliteral">&quot;test in the current time interval.  &quot;</span> .
                    <span class="stringliteral">&quot;You may take the\ntest again after &quot;</span> .
                    <span class="stringliteral">&quot;the time interval has expired.&quot;</span>;

            }

        } <span class="keywordflow">else</span> {
<span class="preprocessor">        # (we&#39;re still in the $isOpen &amp;&amp; ! $isClosed conditional here)</span>
<span class="preprocessor"></span><span class="preprocessor">        #    if a specific version is requested, then we only check to </span>
<span class="preprocessor"></span><span class="preprocessor">        #    see if it&#39;s open</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ( 
                 ( $currentNumAttempts &lt; $maxAttemptsPerVersion )
                 &amp;&amp; 
                 ( $effectiveUserName eq $userName ||
                   $authz-&gt;hasPermissions($userName,
                              <span class="stringliteral">&quot;record_set_version_answers_when_acting_as_student&quot;</span>) )
               ) {
                <span class="keywordflow">if</span> ( between($set-&gt;open_date(), 
                         $set-&gt;due_date() + $grace,
                         $timeNow) ) {
                    $versionIsOpen = 1;
                } <span class="keywordflow">else</span> {
                    $versionIsOpen = 0;  # redundant
                }
            }
        }

<span class="preprocessor">    # closed set, with attempt at a new one</span>
<span class="preprocessor"></span>    } elsif ( ! $self-&gt;{invalidSet} &amp;&amp; ! $requestedVersion ) {
        $self-&gt;{invalidSet} = <span class="stringliteral">&quot;This set is closed.  No new set &quot;</span> .
            <span class="stringliteral">&quot;versions may be taken.&quot;</span>;
    }


<span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # save problem and user data</span>
<span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span>
    my $psvn = $set-&gt;psvn();
    $self-&gt;{tmplSet} = $tmplSet;
    $self-&gt;{<span class="keyword">set</span>} = $set;
    $self-&gt;{problem} = $Problem;
    $self-&gt;{requestedVersion} = $requestedVersion;

    $self-&gt;{userName} = $userName;
    $self-&gt;{effectiveUserName} = $effectiveUserName;
    $self-&gt;{user} = $User;
    $self-&gt;{effectiveUser}   = $EffectiveUser;
    $self-&gt;{permissionLevel} = $permissionLevel;

    $self-&gt;{isOpen} = $isOpen;
    $self-&gt;{isClosed} = $isClosed;
    $self-&gt;{versionIsOpen} = $versionIsOpen;

    $self-&gt;{timeNow} = $timeNow;

<span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # form processing</span>
<span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # this is the same as the following, but doesn&#39;t appear in Problem.pm</span>
<span class="preprocessor"></span>    my $newPage = $r-&gt;param(<span class="stringliteral">&quot;newPage&quot;</span>);
    $self-&gt;{newPage} = $newPage;

<span class="preprocessor">    # also get the current page, if it&#39;s given</span>
<span class="preprocessor"></span>    my $currentPage = $r-&gt;param(<span class="stringliteral">&quot;currentPage&quot;</span>) || 1;

<span class="preprocessor">    # this is a hack manage previewing a page.  we set previewAnswers to </span>
<span class="preprocessor"></span><span class="preprocessor">    # yes if either of the following are true:</span>
<span class="preprocessor"></span><span class="preprocessor">    #  1. the &quot;previewAnswers&quot; input is set (the &quot;preview&quot; button was</span>
<span class="preprocessor"></span><span class="preprocessor">    #     clicked), or </span>
<span class="preprocessor"></span><span class="preprocessor">    #  2. the &quot;previewHack&quot; input is set (a preview link was used)</span>
<span class="preprocessor"></span>    my $prevOr = $r-&gt;param(<span class="stringliteral">&#39;previewAnswers&#39;</span>) || $r-&gt;param(<span class="stringliteral">&#39;previewHack&#39;</span>);
    $r-&gt;param(<span class="stringliteral">&#39;previewAnswers&#39;</span>, $prevOr) <span class="keywordflow">if</span> ( defined( $prevOr ) );

<span class="preprocessor">        # [This section lifted from Problem.pm] ##############################</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # set options from form fields (see comment at top of file for names)</span>
<span class="preprocessor"></span>    my $displayMode      = $r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>) || 
        $ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};
    my $redisplay        = $r-&gt;param(<span class="stringliteral">&quot;redisplay&quot;</span>);
    my $submitAnswers    = $r-&gt;param(<span class="stringliteral">&quot;submitAnswers&quot;</span>);
    my $checkAnswers     = $r-&gt;param(<span class="stringliteral">&quot;checkAnswers&quot;</span>);
    my $previewAnswers   = $r-&gt;param(<span class="stringliteral">&quot;previewAnswers&quot;</span>);

    my $formFields = { <a class="code" href="classWeBWorK_1_1Form.html">WeBWorK::Form</a>-&gt;new_from_paramable($r)-&gt;Vars };

    $self-&gt;{displayMode}    = $displayMode;
    $self-&gt;{redisplay}      = $redisplay;
    $self-&gt;{submitAnswers}  = $submitAnswers;
    $self-&gt;{checkAnswers}   = $checkAnswers;
    $self-&gt;{previewAnswers} = $previewAnswers;
    $self-&gt;{formFields}     = $formFields;

<span class="preprocessor">    # now that we&#39;ve set all the necessary variables quit out if the set or </span>
<span class="preprocessor"></span><span class="preprocessor">    #    problem is invalid</span>
<span class="preprocessor"></span>
    <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{invalidSet} || $self-&gt;{invalidProblem};

<span class="preprocessor">    # [End lifted section] ###############################################</span>
<span class="preprocessor"></span>
<span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # permissions</span>
<span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # bail without doing anything if the set isn&#39;t yet open for this user</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! ( $self-&gt;{isOpen} ||
         $authz-&gt;hasPermissions($userName,<span class="stringliteral">&quot;view_unopened_sets&quot;</span>) ) ) {
        $self-&gt;{invalidSet} = <span class="stringliteral">&quot;This set is not yet open.&quot;</span>;
        <span class="keywordflow">return</span>;
    }

<span class="preprocessor">    # what does the user want to do?</span>
<span class="preprocessor"></span>    my %want = 
        (showOldAnswers     =&gt; $r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>) || 
                   $ce-&gt;{pg}-&gt;{options}-&gt;{showOldAnswers},
         showCorrectAnswers =&gt; ($r-&gt;param(<span class="stringliteral">&quot;showCorrectAnswers&quot;</span>) || 
                               $ce-&gt;{pg}-&gt;{options}-&gt;{showCorrectAnswers}) &amp;&amp;
                                   ($submitAnswers || $checkAnswers),
         showHints          =&gt; $r-&gt;param(<span class="stringliteral">&quot;showHints&quot;</span>) || 
                           $ce-&gt;{pg}-&gt;{options}-&gt;{showHints},
         showSolutions      =&gt; ($r-&gt;param(<span class="stringliteral">&quot;showSolutions&quot;</span>) || 
                           $ce-&gt;{pg}-&gt;{options}-&gt;{showSolutions}) &amp;&amp;
                                   ($submitAnswers || $checkAnswers),
         recordAnswers      =&gt; $submitAnswers,
<span class="preprocessor">    # we also want to check answers if we were checking answers and are</span>
<span class="preprocessor"></span><span class="preprocessor">    #    switching between pages</span>
<span class="preprocessor"></span>         checkAnswers       =&gt; $checkAnswers,
         );

<span class="preprocessor">    # are certain options enforced?</span>
<span class="preprocessor"></span>    my %must = 
        (showOldAnswers     =&gt; 0,
         showCorrectAnswers =&gt; 0,
         showHints          =&gt; 0,
         showSolutions      =&gt; 0,
         recordAnswers      =&gt; ! $authz-&gt;hasPermissions($userName, 
                                <span class="stringliteral">&quot;avoid_recording_answers&quot;</span>),
         checkAnswers       =&gt; 0,
         );

<span class="preprocessor">    # does the user have permission to use certain options?</span>
<span class="preprocessor"></span>    my @args = ($User, $PermissionLevel, $EffectiveUser, $set, $Problem, 
            $tmplSet);
    my $sAns = ( $submitAnswers ? 1 : 0 );
    my %can = 
        (showOldAnswers     =&gt; $self-&gt;can_showOldAnswers(@args), 
         showCorrectAnswers =&gt; $self-&gt;can_showCorrectAnswers(@args, $sAns),
         showHints          =&gt; $self-&gt;can_showHints(@args),
         showSolutions      =&gt; $self-&gt;can_showSolutions(@args, $sAns),
         recordAnswers      =&gt; $self-&gt;can_recordAnswers(@args),
         checkAnswers       =&gt; $self-&gt;can_checkAnswers(@args),
         recordAnswersNextTime =&gt; $self-&gt;can_recordAnswers(@args, $sAns),
         checkAnswersNextTime  =&gt; $self-&gt;can_checkAnswers(@args, $sAns),
         showScore          =&gt; $self-&gt;can_showScore(@args),
         );

<span class="preprocessor">    # final values for options</span>
<span class="preprocessor"></span>    my %will;
    <span class="keywordflow">foreach</span> (keys %must) {
        $will{$_} = $can{$_} &amp;&amp; ($must{$_} || $want{$_}) ;
    }

<span class="preprocessor">    ##### store fields #####</span>
<span class="preprocessor"></span>
<span class="preprocessor">## FIXME: the following is present in Problem.pm, but missing here.  how do we </span>
<span class="preprocessor"></span><span class="preprocessor">##   deal with it in the context of multiple problems with possible hints?</span>
<span class="preprocessor"></span><span class="preprocessor">## ##### fix hint/solution options #####</span>
<span class="preprocessor"></span><span class="preprocessor">## $can{showHints}     &amp;&amp;= $pg-&gt;{flags}-&gt;{hintExists}  </span>
<span class="preprocessor"></span><span class="preprocessor">##                     &amp;&amp;= $pg-&gt;{flags}-&gt;{showHintLimit}&lt;=$pg-&gt;{state}-&gt;{num_of_incorrect_ans};</span>
<span class="preprocessor"></span><span class="preprocessor">##    $can{showSolutions} &amp;&amp;= $pg-&gt;{flags}-&gt;{solutionExists};</span>
<span class="preprocessor"></span>    
    $self-&gt;{want} = \%want;
    $self-&gt;{must} = \%must;
    $self-&gt;{can}  = \%can;
    $self-&gt;{will} = \%will;


<span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # set up problem numbering and multipage variables</span>
<span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span>
    my @problemNumbers;
    <span class="keywordflow">if</span> ( $setName eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> ) {
        @problemNumbers = ( 1 );
    } <span class="keywordflow">else</span> {
        @problemNumbers = $db-&gt;listProblemVersions($effectiveUserName,
                               $setName,
                               $setVersionNumber);
    }

<span class="preprocessor">    # to speed up processing of long (multi-page) tests, we want to only </span>
<span class="preprocessor"></span><span class="preprocessor">    #    translate those problems that are being submitted or are currently </span>
<span class="preprocessor"></span><span class="preprocessor">    #    being displayed.  so work out here which problems are on the </span>
<span class="preprocessor"></span><span class="preprocessor">    #    current page.</span>
<span class="preprocessor"></span>    my ( $numPages, $pageNumber, $numProbPerPage ) = ( 1, 0, 0 );
    my ( $startProb, $endProb ) = ( 0, $#problemNumbers );

<span class="preprocessor">    # update startProb and endProb for multipage tests</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( defined($set-&gt;problems_per_page) &amp;&amp; $set-&gt;problems_per_page ) {
        $numProbPerPage = $set-&gt;problems_per_page;
        $pageNumber = ($newPage) ? $newPage : $currentPage;

        $numPages = scalar(@problemNumbers)/$numProbPerPage;
        $numPages = int($numPages) + 1 <span class="keywordflow">if</span> (<span class="keywordtype">int</span>($numPages) != $numPages);

        $startProb = ($pageNumber - 1)*$numProbPerPage;
        $startProb = 0 <span class="keywordflow">if</span> ( $startProb &lt; 0 || 
                    $startProb &gt; $#problemNumbers );
        $endProb = ($startProb + $numProbPerPage &gt; $#problemNumbers) ? 
            $#problemNumbers : $startProb + $numProbPerPage - 1;
    }


<span class="preprocessor">    # set up problem list for randomly ordered tests</span>
<span class="preprocessor"></span>    my @probOrder = (0..$#problemNumbers);

<span class="preprocessor">    # there&#39;s a routine to do this somewhere, I think...</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $set-&gt;problem_randorder ) {
        my @newOrder = ();
<span class="preprocessor">    # we need to keep the random order the same each time the set is loaded!</span>
<span class="preprocessor"></span><span class="preprocessor">    #    this requires either saving the order in the set definition, or </span>
<span class="preprocessor"></span><span class="preprocessor">    #    being sure that the random seed that we use is the same each time </span>
<span class="preprocessor"></span><span class="preprocessor">    #    the same set is called.  we&#39;ll do the latter by setting the seed </span>
<span class="preprocessor"></span><span class="preprocessor">    #    to the psvn of the problem set.  we use a local PGrandom object </span>
<span class="preprocessor"></span><span class="preprocessor">    #    to avoid mucking with the system seed.</span>
<span class="preprocessor"></span>        my $pgrand = PGrandom-&gt;new();
        $pgrand-&gt;srand( $set-&gt;psvn );
        <span class="keywordflow">while</span> ( @probOrder ) { 
            my $i = int($pgrand-&gt;rand(scalar(@probOrder)));
            push( @newOrder, $probOrder[$i] );
            splice(@probOrder, $i, 1);
        }
        @probOrder = @newOrder;
    }
<span class="preprocessor">    # now $probOrder[i] = the problem number, numbered from zero, that&#39;s </span>
<span class="preprocessor"></span><span class="preprocessor">    #    displayed in the ith position on the test</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # make a list of those problems we&#39;re displaying</span>
<span class="preprocessor"></span>    my @probsToDisplay = ();
    <span class="keywordflow">for</span> ( my $i=0; $i&lt;@probOrder; $i++ ) {
        push(@probsToDisplay, $probOrder[$i]) 
            <span class="keywordflow">if</span> ( $i &gt;= $startProb &amp;&amp; $i &lt;= $endProb );
    }

<span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # process problems</span>
<span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<span class="preprocessor"></span>
    my @problems = ();
    my @pg_results = ();
<span class="preprocessor">    # pg errors are stored here; initialize it to empty to start</span>
<span class="preprocessor"></span>    $self-&gt;{errors} = [ ];

<span class="preprocessor">    # process the problems as needed</span>
<span class="preprocessor"></span>    my @mergedProblems;
    <span class="keywordflow">if</span> ( $setName eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> ) {
        @mergedProblems = ( $Problem );
    } <span class="keywordflow">else</span> {
        @mergedProblems = $db-&gt;getAllMergedProblemVersions($effectiveUserName, $setName, $setVersionNumber);
    }

    <span class="keywordflow">foreach</span> my $problemNumber (sort {$a&lt;=&gt;$b } @problemNumbers) {

<span class="preprocessor">        # pIndex numbers from zero</span>
<span class="preprocessor"></span>        my $pIndex = $problemNumber - 1;
        <span class="keywordflow">if</span> ( ! defined( $mergedProblems[$pIndex] ) ) {
            $self-&gt;{invalidSet} = <span class="stringliteral">&quot;One or more of the problems &quot;</span> .
                <span class="stringliteral">&quot;in this set have not been assigned to you.&quot;</span>;
            <span class="keywordflow">return</span>;
        }
        my $ProblemN = $mergedProblems[$pIndex];

<span class="preprocessor">        # sticky answers are set up here</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( not ( $submitAnswers or $previewAnswers or $checkAnswers or
               $newPage ) and $will{showOldAnswers} ) {

            my %oldAnswers = decodeAnswers( $ProblemN-&gt;last_answer);
            $formFields-&gt;{$_} = $oldAnswers{$_} <span class="keywordflow">foreach</span> ( keys %oldAnswers );
        }
        push( @problems, $ProblemN );

<span class="preprocessor">        # if we don&#39;t have to translate this problem, just save the </span>
<span class="preprocessor"></span><span class="preprocessor">        #    problem number</span>
<span class="preprocessor"></span>        my $pg = $problemNumber;
<span class="preprocessor">        # this is the actual translation of each problem.  errors are </span>
<span class="preprocessor"></span><span class="preprocessor">        #    stored in @{$self-&gt;{errors}} in each case</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( (grep /^$pIndex$/, @probsToDisplay) || $submitAnswers ) {
            $pg = $self-&gt;getProblemHTML($self-&gt;{effectiveUser},
                            $set, $formFields,
                            $ProblemN);
        }
        push(@pg_results, $pg);
    }
    $self-&gt;{ra_problems} = \@problems;
    $self-&gt;{ra_pg_results}=\@pg_results;

    $self-&gt;{startProb} = $startProb;
    $self-&gt;{endProb} = $endProb;
    $self-&gt;{numPages} = $numPages;
    $self-&gt;{pageNumber} = $pageNumber;
    $self-&gt;{ra_probOrder} = \@probOrder;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a749618bb96db7d27de560704d2534849"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::previewAnswer" ref="a749618bb96db7d27de560704d2534849" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::previewAnswer </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-previewAnswer' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-previewAnswer-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-previewAnswer-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-previewAnswer-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in previewAnswer: 41</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a749618bb96db7d27de560704d2534849">previewAnswer</a> {
    my ($self, $answerResult, $imgGen) = @_;
    my $ce            = $self-&gt;r-&gt;ce;
    my $EffectiveUser = $self-&gt;{effectiveUser};
    my $set           = $self-&gt;{<span class="keyword">set</span>};
    my $problem       = $self-&gt;{problem};
    my $displayMode   = $self-&gt;{displayMode};
    
<span class="preprocessor">    # note: right now, we have to do things completely differently when we are</span>
<span class="preprocessor"></span><span class="preprocessor">    # rendering math from INSIDE the translator and from OUTSIDE the translator.</span>
<span class="preprocessor"></span><span class="preprocessor">    # so we&#39;ll just deal with each case explicitly here. there&#39;s some code</span>
<span class="preprocessor"></span><span class="preprocessor">    # duplication that can be dealt with later by abstracting out tth/dvipng/etc.</span>
<span class="preprocessor"></span>    
    my $tex = $answerResult-&gt;{preview_latex_string};
    
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless defined $tex and $tex ne <span class="stringliteral">&quot;&quot;</span>;
    
    <span class="keywordflow">if</span> ($displayMode eq <span class="stringliteral">&quot;plainText&quot;</span>) {
        <span class="keywordflow">return</span> $tex;
    } elsif ($displayMode eq <span class="stringliteral">&quot;formattedText&quot;</span>) {
        my $tthCommand = $ce-&gt;{externalPrograms}-&gt;{tth}
            . <span class="stringliteral">&quot; -L -f5 -r 2&gt; /dev/null &lt;&lt;END_OF_INPUT; echo &gt; /dev/null\n&quot;</span>
            . <span class="stringliteral">&quot;\\(&quot;</span>.$tex.<span class="stringliteral">&quot;\\)\n&quot;</span>
            . <span class="stringliteral">&quot;END_OF_INPUT\n&quot;</span>;
        
<span class="preprocessor">        # call tth</span>
<span class="preprocessor"></span>        my $result = `$tthCommand`;
        <span class="keywordflow">if</span> ($?) {
            <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;b&gt;[tth failed: $? $@]&lt;/b&gt;&quot;</span>;
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">return</span> $result;
        }
    } elsif ($displayMode eq <span class="stringliteral">&quot;images&quot;</span>) {
        $imgGen-&gt;add($tex);
    } elsif ($displayMode eq <span class="stringliteral">&quot;MathJax&quot;</span>) {
        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;span class=&quot;MathJax_Preview&quot;&gt;[math]&lt;/span&gt;&lt;script type=&quot;math/tex; mode=display&quot;&gt;&#39;</span>.$tex.<span class="stringliteral">&#39;&lt;/script&gt;&#39;</span>;
    } elsif ($displayMode eq <span class="stringliteral">&quot;jsMath&quot;</span>) {
        $tex =~ s/&amp;/&amp;amp;/g; $tex =~ s/&lt;/&amp;lt;/g; $tex =~ s/&gt;/&amp;gt;/g;
        <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;SPAN CLASS=&quot;math&quot;&gt;\\displaystyle{&#39;</span>.$tex.<span class="stringliteral">&#39;}&lt;/SPAN&gt;&#39;</span>;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a5454d55f0f8816366691cbc6bce91051"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::problemListRow" ref="a5454d55f0f8816366691cbc6bce91051" args="($$$)()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::problemListRow </td>
          <td>(</td>
          <td class="paramtype">$$$&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-problemListRow($$$)' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-problemListRow($$$)-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-problemListRow($$$)-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-problemListRow($$$)-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in problemListRow($$$): 21</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a5454d55f0f8816366691cbc6bce91051">problemListRow</a>($$$) {
    my $self = shift;
    my $set = shift;
    my $Problem = shift;
    
    my $name = $Problem-&gt;problem_id;
    my $interactiveURL = <span class="stringliteral">&quot;$name/?&quot;</span> . $self-&gt;url_authen_args;
    my $interactive = CGI::a({-href=&gt;$interactiveURL}, <span class="stringliteral">&quot;Problem $name&quot;</span>);
    my $attempts = $Problem-&gt;num_correct + $Problem-&gt;num_incorrect;
    my $remaining = $Problem-&gt;max_attempts &lt; 0
        ? <span class="stringliteral">&quot;unlimited&quot;</span>
        : $Problem-&gt;max_attempts - $attempts;
    my $status = sprintf(<span class="stringliteral">&quot;%.0f%%&quot;</span>, $Problem-&gt;status * 100); # round to whole number
    
    <span class="keywordflow">return</span> CGI::Tr(CGI::td({-nowrap=&gt;1}, [
        $interactive,
        $attempts,
        $remaining,
        $status,
    ]));
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a8384f7308f34576e315347b3da570fb6"></a><!-- doxytag: member="WeBWorK::ContentGenerator::GatewayQuiz::templateName" ref="a8384f7308f34576e315347b3da570fb6" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::GatewayQuiz::templateName </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-templateName' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-templateName-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-templateName-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-templateName-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in templateName: 3</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html#a8384f7308f34576e315347b3da570fb6">templateName</a> {
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;gateway&quot;</span>;
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="GatewayQuiz_8pm_source.html">GatewayQuiz.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:57:19 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
