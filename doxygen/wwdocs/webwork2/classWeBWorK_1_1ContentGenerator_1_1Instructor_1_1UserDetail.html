<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::ContentGenerator::Instructor::UserDetail Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator.html">ContentGenerator</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">Instructor</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html">UserDetail</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::ContentGenerator::Instructor::UserDetail Class Reference</h1><!-- doxytag: class="WeBWorK::ContentGenerator::Instructor::UserDetail" --><!-- doxytag: inherits="WeBWorK::ContentGenerator::Instructor" --><div class="dynheader">
Inheritance diagram for WeBWorK::ContentGenerator::Instructor::UserDetail:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail__inherit__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail_inherit__map" id="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail_inherit__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html" title="WeBWorK::ContentGenerator::Instructor" alt="" coords="39,155,295,181"/><area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="71,80,263,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="125,5,208,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::ContentGenerator::Instructor::UserDetail:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail__coll__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail_coll__map" id="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail_coll__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html" title="WeBWorK::ContentGenerator::Instructor" alt="" coords="39,155,295,181"/><area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="71,80,263,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="125,5,208,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html#a4520c514ebe10b179bf6e003a535c11b">body</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html#a0b3c8d6848552dc6febbf5a554fbdd06">checkDates</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html#a8b9061e904af1cd0d0ddfdfbe9d8b1d2">DBFieldTable</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html#a81bbc60b048267d57fd094ac61cf8f39">initialize</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html">WeBWorK::ContentGenerator::Instructor::UserDetail</a> - Detailed User specific information </p>

<p>Definition at line <a class="el" href="UserDetail_8pm_source.html#l00020">20</a> of file <a class="el" href="UserDetail_8pm_source.html">UserDetail.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a4520c514ebe10b179bf6e003a535c11b"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::UserDetail::body" ref="a4520c514ebe10b179bf6e003a535c11b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::UserDetail::body </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-body' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-body-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-body-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-body-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in body: 327</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html#a4520c514ebe10b179bf6e003a535c11b">body</a> {
    my ($self) = @_;
    my $r = $self-&gt;r;
    my $urlpath = $r-&gt;urlpath;
    my $db = $r-&gt;db;
    my $ce = $r-&gt;ce;
    my $authz = $r-&gt;authz;
    my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
    my $editForUserID = $urlpath-&gt;arg(<span class="stringliteral">&quot;userID&quot;</span>);
    my $userID = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
    
    my @editForSets = $r-&gt;param(<span class="stringliteral">&quot;editForSets&quot;</span>);
    
    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class </span>=&gt; &quot;ResultsWithError&quot;}, &quot;You are not authorized to edit user specific information.&quot;)
        unless $authz-&gt;hasPermissions($userID, &quot;access_instructor_tools&quot;);
    
    my $UserRecord = $db-&gt;getUser($editForUserID);
    my $PermissionRecord = $db-&gt;getPermissionLevel($editForUserID);
    my @UserSetIDs = $db-&gt;listUserSets($editForUserID);
    
    my $userName = $UserRecord-&gt;first_name . <span class="stringliteral">&quot; &quot;</span> . $UserRecord-&gt;last_name;

<span class="preprocessor">    # templates for getting field names</span>
<span class="preprocessor"></span>    my $userTemplate = $self-&gt;{userTemplate};
    my $permissionLevelTemplate = $self-&gt;{permissionLevelTemplate};
    
<span class="preprocessor">    # This table can be consulted when display-ready forms of field names are needed.</span>
<span class="preprocessor"></span>    my %prettyFieldNames = map { $_ =&gt; $_ } 
        $userTemplate-&gt;FIELDS();
    
<span class="preprocessor">#   @prettyFieldNames{qw(</span>
<span class="preprocessor"></span><span class="preprocessor">#       #user_id</span>
<span class="preprocessor"></span><span class="preprocessor">#       first_name</span>
<span class="preprocessor"></span><span class="preprocessor">#       last_name</span>
<span class="preprocessor"></span><span class="preprocessor">#       email_address</span>
<span class="preprocessor"></span><span class="preprocessor">#       student_id</span>
<span class="preprocessor"></span><span class="preprocessor">#       status</span>
<span class="preprocessor"></span><span class="preprocessor">#       section</span>
<span class="preprocessor"></span><span class="preprocessor">#       recitation</span>
<span class="preprocessor"></span><span class="preprocessor">#       comment</span>
<span class="preprocessor"></span><span class="preprocessor">#       permission</span>
<span class="preprocessor"></span><span class="preprocessor">#   )} = (</span>
<span class="preprocessor"></span><span class="preprocessor">#       #&quot;Login Name&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;First Name&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;Last Name&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;Email&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;Student ID&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;Status&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;Section&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;Recitation&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;Comment&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;Permission Level&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#   );</span>
<span class="preprocessor"></span>    
    my @dateFields         = @{DATE_FIELDS_ORDER()};
    my $rh_dateFieldLabels =  DATE_FIELDS();


<span class="preprocessor">    # create a link to the SetsAssignedToUser page</span>
<span class="preprocessor"></span><span class="preprocessor">#   my $editSetsPath = $urlpath-&gt;newFromModule(</span>
<span class="preprocessor"></span><span class="preprocessor">#       &quot;WeBWorK::ContentGenerator::Instructor::SetsAssignedToUser&quot;, $r, </span>
<span class="preprocessor"></span><span class="preprocessor">#       courseID =&gt; $courseID,</span>
<span class="preprocessor"></span><span class="preprocessor">#       userID =&gt; $userID,</span>
<span class="preprocessor"></span><span class="preprocessor">#   );</span>
<span class="preprocessor"></span><span class="preprocessor">#   my $editSetsAssignedToUserURL = $self-&gt;systemLink($editSetsPath);</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    # create a message about how many sets have been assigned to this user</span>
<span class="preprocessor"></span>    my $setCount = $db-&gt;countUserSets($editForUserID);
<span class="preprocessor">#   my $userCountMessage =  CGI::a({href=&gt;$editSetsAssignedToUserURL}, $setCount . &quot; sets.&quot;);</span>
<span class="preprocessor"></span><span class="preprocessor">#   $userCountMessage = &quot;The user &quot; . CGI::b($userName . &quot; ($editForUserID)&quot;) . &quot; has been assigned &quot; . $userCountMessage;</span>
<span class="preprocessor"></span>    my $basicInfoPage = $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;instructor_user_list&#39;</span>,
                    args =&gt;{
                        courseID =&gt; $courseID,
                    }
        );
        my $basicInfoUrl = $self-&gt;systemLink($basicInfoPage,
                                             params =&gt;{visible_users =&gt; $editForUserID,
                                                       editMode      =&gt; 1,
                                                      }
        );

    print CGI::h4({align=&gt;<span class="stringliteral">&#39;center&#39;</span>},<span class="stringliteral">&quot;Edit &quot;</span>,CGI::a({href=&gt;$basicInfoUrl},<span class="stringliteral">&#39;class list data&#39;</span>),<span class="stringliteral">&quot; for  $userName ($editForUserID) who has been assigned $setCount sets.&quot;</span>);
    
<span class="preprocessor">    #print CGI::h4(&quot;User Data&quot;);</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::start_table({ align=&gt;&#39;center&#39;, border=&gt;1,cellpadding=&gt;5});</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(</span>
<span class="preprocessor"></span><span class="preprocessor">#       CGI::th(CGI::checkbox({ type =&gt; &#39;checkbox&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">#                               name =&gt; &quot;edit.basic.info&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#                               label =&gt; &#39;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">#                               checked =&gt; 0</span>
<span class="preprocessor"></span><span class="preprocessor">#         }),&quot;Edit class list data for $editForUserID&quot;),</span>
<span class="preprocessor"></span><span class="preprocessor">#         CGI::th(CGI::checkbox({ type =&gt; &#39;checkbox&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">#                               name =&gt; &quot;change.password&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#                               label =&gt; &#39;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">#                               checked =&gt; 0</span>
<span class="preprocessor"></span><span class="preprocessor">#         }),&quot;Change Password for $editForUserID&quot;));</span>
<span class="preprocessor"></span><span class="preprocessor">#         </span>
<span class="preprocessor"></span><span class="preprocessor">#   print &quot;&lt;tr&gt;&lt;td rowspan=\&quot;2\&quot;&gt;&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">#   ########################################</span>
<span class="preprocessor"></span><span class="preprocessor">#   # Basic student data</span>
<span class="preprocessor"></span><span class="preprocessor">#   ########################################</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::start_table();</span>
<span class="preprocessor"></span><span class="preprocessor">#   foreach ($userTemplate-&gt;FIELDS()) {</span>
<span class="preprocessor"></span><span class="preprocessor">#       next if $_ eq &#39;user_id&#39;;   # don&#39;t print login name</span>
<span class="preprocessor"></span><span class="preprocessor">#       print CGI::Tr(</span>
<span class="preprocessor"></span><span class="preprocessor">#           CGI::td([</span>
<span class="preprocessor"></span><span class="preprocessor">#                   $prettyFieldNames{$_}, </span>
<span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $UserRecord-&gt;$_, -size =&gt; 25 })</span>
<span class="preprocessor"></span><span class="preprocessor">#           ])</span>
<span class="preprocessor"></span><span class="preprocessor">#       );</span>
<span class="preprocessor"></span><span class="preprocessor">#   }</span>
<span class="preprocessor"></span><span class="preprocessor">#   foreach ($permissionLevelTemplate-&gt;FIELDS()) {</span>
<span class="preprocessor"></span><span class="preprocessor">#       print CGI::Tr(</span>
<span class="preprocessor"></span><span class="preprocessor">#           CGI::td([</span>
<span class="preprocessor"></span><span class="preprocessor">#                   $prettyFieldNames{$_}, </span>
<span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $PermissionRecord-&gt;$_, -size =&gt; 25 })</span>
<span class="preprocessor"></span><span class="preprocessor">#           ])</span>
<span class="preprocessor"></span><span class="preprocessor">#       );</span>
<span class="preprocessor"></span><span class="preprocessor">#   }</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::end_table();</span>
<span class="preprocessor"></span><span class="preprocessor">#   </span>
<span class="preprocessor"></span><span class="preprocessor">#   #print CGI::br();</span>
<span class="preprocessor"></span><span class="preprocessor">#   print &quot;&lt;/td&gt;&lt;td valign=\&quot;top\&quot;&gt;&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">#   ########################################</span>
<span class="preprocessor"></span><span class="preprocessor">#   # Change password section</span>
<span class="preprocessor"></span><span class="preprocessor">#   ########################################</span>
<span class="preprocessor"></span><span class="preprocessor">#   my $profRecord = $db-&gt;getUser($userID);</span>
<span class="preprocessor"></span><span class="preprocessor">#   my $profName = $profRecord-&gt;first_name . &quot; &quot; . $profRecord-&gt;last_name;</span>
<span class="preprocessor"></span><span class="preprocessor">#   my $poss = &quot;&#39;s &quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">#   my $pass = &quot; password &quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">#   </span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::start_table();</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(CGI::td([&quot;&lt;b&gt;$profName&lt;/b&gt;$poss$pass&quot;, CGI::input({ -type =&gt; &quot;password&quot;, -name =&gt; &quot;$userID.password&quot;})]));</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(CGI::td([&quot;&lt;b&gt;$userName&lt;/b&gt;$poss new $pass&quot;, CGI::input({ -type =&gt; &quot;password&quot;, -name =&gt; &quot;$editForUserID.password.1&quot;})]));</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(CGI::td([&quot;Confirm &lt;b&gt;$userName&lt;/b&gt;$poss new $pass&quot;, CGI::input({ -type =&gt; &quot;password&quot;, -name =&gt; &quot;$editForUserID.password.2&quot;})]));</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::end_table();</span>
<span class="preprocessor"></span><span class="preprocessor">#   print &quot;&lt;/td&gt;&lt;/tr&gt;&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(CGI::th(  #FIXME  enable this once it can be handled</span>
<span class="preprocessor"></span><span class="preprocessor"># #         CGI::checkbox({ type =&gt; &#39;checkbox&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor"># #                                 name =&gt; &quot;change.login&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor"># #                                 label =&gt; &#39;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor"># #                                 checked =&gt; 0</span>
<span class="preprocessor"></span><span class="preprocessor"># #         }),</span>
<span class="preprocessor"></span><span class="preprocessor">#         &quot;Change login name $editForUserID to &quot;, CGI::input({-name=&gt;&#39;new_login&#39;, -value=&gt;&#39;&#39;  ,-size=&gt;25})</span>
<span class="preprocessor"></span><span class="preprocessor">#   ));</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::end_table();</span>
<span class="preprocessor"></span>    
    print CGI::br();

<span class="preprocessor">    #print CGI::h4(&quot;Sets assigned to $userName&quot;);</span>
<span class="preprocessor"></span><span class="preprocessor">    # construct url for the form</span>
<span class="preprocessor"></span>    my $userDetailPage = $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;instructor_user_detail&#39;</span>,
                                           args =&gt;{
                                                     courseID =&gt; $courseID,
                                                     userID   =&gt; $editForUserID, #FIXME eventually <span class="keyword">this</span> should be a list??
                    }
    );
    my $userDetailUrl = $self-&gt;systemLink($userDetailPage,authen=&gt;0);

<span class="preprocessor">    # DBFIXME all we need here is set IDs</span>
<span class="preprocessor"></span><span class="preprocessor">    # DBFIXME do sorting in DB</span>
<span class="preprocessor"></span>    my %GlobalSetRecords = map { $_-&gt;set_id =&gt; $_ } $db-&gt;getGlobalSets($db-&gt;listGlobalSets());
    my @UserSetRefs = map { [$editForUserID, $_] } sortByName(undef, @UserSetIDs);
    my %UserSetRecords = map { $_-&gt;set_id =&gt; $_ } $db-&gt;getUserSets(@UserSetRefs);
    my @MergedSetRefs = map { [$editForUserID, $_] } sortByName(undef, @UserSetIDs);
    my %MergedSetRecords = map { $_-&gt;set_id =&gt; $_ } $db-&gt;getMergedSets(@MergedSetRefs);

<span class="preprocessor">    # get set versions of versioned sets</span>
<span class="preprocessor"></span>    my %UserSetVersionRecords;
    my %UserSetMergedVersionRecords;
    <span class="keywordflow">foreach</span> my $setid ( keys( %UserSetRecords ) ) {
        <span class="keywordflow">if</span> ( $GlobalSetRecords{$setid}-&gt;assignment_type =~ /gateway/ ) {
            my @setVersionRefs = map { [$editForUserID, $setid, $_] }
                $db-&gt;listSetVersions( $editForUserID, $setid );
            <span class="keywordflow">if</span> ( @setVersionRefs ) {
                $UserSetVersionRecords{$setid} = [ $db-&gt;getSetVersions(@setVersionRefs) ];
                $UserSetMergedVersionRecords{$setid} = [ $db-&gt;getMergedSetVersions(@setVersionRefs) ];
            }
        }
    }
    
<span class="preprocessor">    ########################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Print warning</span>
<span class="preprocessor"></span><span class="preprocessor">    ########################################</span>
<span class="preprocessor"></span>    print CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},
               <span class="stringliteral">&quot;Do not uncheck a set unless you know what you are doing.&quot;</span>, CGI::br(),
               <span class="stringliteral">&quot;There is NO undo for unassigning a set.&quot;</span>);

    print CGI::p(<span class="stringliteral">&quot;To change status (scores or grades) for this student for one</span>
<span class="stringliteral">                  set, click on the individual set link.&quot;</span>);

    print CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},<span class="stringliteral">&quot;When you uncheck a homework set (and save the changes), you destroy all</span>
<span class="stringliteral">              of the data for that set for this student.   If you</span>
<span class="stringliteral">              reassign the set, the student will receive a new version of each problem.</span>
<span class="stringliteral">              Make sure this is what you want to do before unchecking sets.&quot;</span>
    );
<span class="preprocessor">    ########################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Assigned sets form</span>
<span class="preprocessor"></span><span class="preprocessor">    ########################################</span>
<span class="preprocessor"></span>
    print CGI::start_form( {method=&gt;<span class="stringliteral">&#39;post&#39;</span>,action=&gt;$userDetailUrl, name=&gt;<span class="stringliteral">&#39;UserDetail&#39;</span>}),<span class="stringliteral">&quot;\n&quot;</span>;
    print $self-&gt;hidden_authen_fields();
    print CGI::p(CGI::submit(-name=&gt;<span class="stringliteral">&#39;save_button&#39;</span>,-label=&gt;<span class="stringliteral">&#39;Save changes&#39;</span>,));
    
    print CGI::start_table({ border=&gt; 1,cellpadding=&gt;5}),<span class="stringliteral">&quot;\n&quot;</span>;
    print CGI::Tr(
        CGI::th({align=&gt;<span class="stringliteral">&#39;center&#39;</span>,colspan=&gt;3}, <span class="stringliteral">&quot;Sets assigned to $userName ($editForUserID)&quot;</span>)
    ),<span class="stringliteral">&quot;\n&quot;</span>;
    print CGI::Tr(
        CGI::th({ -align =&gt; <span class="stringliteral">&quot;center&quot;</span>}, [
            <span class="stringliteral">&quot;Assigned&quot;</span>,
            <span class="stringliteral">&quot;Edit set for $editForUserID&quot;</span>,
            <span class="stringliteral">&quot;Dates&quot;</span>,
        ])
    ),<span class="stringliteral">&quot;\n&quot;</span>;

<span class="preprocessor">    # get a list of sets to show</span>
<span class="preprocessor"></span><span class="preprocessor">    # DBFIXME already have this data</span>
<span class="preprocessor"></span>    my @setsToShow = sortByName( undef, $db-&gt;listGlobalSets() );
<span class="preprocessor">    # insert any set versions that we have</span>
<span class="preprocessor"></span>    my $i = $#setsToShow;
    <span class="keywordflow">if</span> ( defined( $UserSetVersionRecords{$setsToShow[$i]} ) ) {
        push( @setsToShow, map{ $_-&gt;set_id . <span class="stringliteral">&quot;,v&quot;</span> . $_-&gt;version_id }
            @{$UserSetVersionRecords{$setsToShow[$i]}} );
    }
    $i--;
    my $numit = 0;
    <span class="keywordflow">while</span> ( $i&gt;=0 ) {
        <span class="keywordflow">if</span> ( defined( $UserSetVersionRecords{$setsToShow[$i]} ) ) {
            splice( @setsToShow, $i+1, 0,
                map{ $_-&gt;set_id . <span class="stringliteral">&quot;,v&quot;</span> . $_-&gt;version_id }
                @{$UserSetVersionRecords{$setsToShow[$i]}} );
        }
        $i--;
        $numit++;
<span class="preprocessor">        # just to be safe</span>
<span class="preprocessor"></span>        last <span class="keywordflow">if</span> $numit &gt;= 150;
    }
    warn(<span class="stringliteral">&quot;Truncated display of sets at 150 in UserDetail.pm.  This is a &quot;</span> .
         <span class="stringliteral">&quot;brake to avoid spiraling into the abyss.  If you really have &quot;</span> .
         <span class="stringliteral">&quot;more than 150 sets in your course, reset the limit at about line &quot;</span> .
         <span class="stringliteral">&quot;370 in webwork/lib/WeBWorK/ContentGenerator/Instructor/UserDetail.pm.&quot;</span>)
        if ( $numit == 150 );


    foreach my $setID ( @setsToShow ) {
<span class="preprocessor">        # catch the versioned sets that we just added</span>
<span class="preprocessor"></span>        my $setVersion = 0;
        my $fullSetID = $setID;
        <span class="keywordflow">if</span> ( $setID =~ /,v(\d+)$/ ) {
            $setVersion = $1;
            $setID =~ s/,v\d+$<span class="comment">//;</span>
        }

        my $GlobalSetRecord = $GlobalSetRecords{$setID};
        my $UserSetRecord = (! $setVersion) ? $UserSetRecords{$setID} :
            $UserSetVersionRecords{$setID}-&gt;[$setVersion-1];
        my $MergedSetRecord = (! $setVersion) ?  $MergedSetRecords{$setID} :
            $UserSetMergedVersionRecords{$setID}-&gt;[$setVersion-1];
        my $setListPage = $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;instructor_set_detail&#39;</span>,
                    args =&gt;{
                        courseID =&gt; $courseID,
                        setID    =&gt; $fullSetID
                    }
        );
        my $url = $self-&gt;systemLink($setListPage,
                              params =&gt;{effectiveUser =&gt; $editForUserID,
                                        editForUser   =&gt; $editForUserID,
        });

        my $setName = ( $setVersion ) ? <span class="stringliteral">&quot;test $setVersion&quot;</span> : $setID;

        print CGI::Tr(
            CGI::td({ -align =&gt; <span class="stringliteral">&quot;center&quot;</span> }, [
                ($setVersion) ? <span class="stringliteral">&quot;&quot;</span> : CGI::checkbox({ type =&gt; <span class="stringliteral">&#39;checkbox&#39;</span>,
                                name =&gt; <span class="stringliteral">&quot;set.$fullSetID.assignment&quot;</span>,
                                label =&gt; <span class="stringliteral">&#39;&#39;</span>,
                                value =&gt; <span class="stringliteral">&#39;assigned&#39;</span>,
                                checked =&gt; (defined $MergedSetRecord)}),
                defined($MergedSetRecord) ? CGI::b(CGI::a({href=&gt;$url},$setName, ) ) : CGI::b($setID, ),
                join <span class="stringliteral">&quot;\n&quot;</span>, $self-&gt;<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html#a8b9061e904af1cd0d0ddfdfbe9d8b1d2">DBFieldTable</a>($GlobalSetRecord, $UserSetRecord, $MergedSetRecord, <span class="stringliteral">&quot;set&quot;</span>, $setID, \@dateFields, $rh_dateFieldLabels),
            ])
        ),<span class="stringliteral">&quot;\n&quot;</span>;
    }
    print CGI::end_table(),<span class="stringliteral">&quot;\n&quot;</span>;
    print CGI::p(CGI::submit(-name=&gt;<span class="stringliteral">&#39;save_button&#39;</span>,-label=&gt;<span class="stringliteral">&#39;Save changes&#39;</span>,));
    print CGI::end_form(),<span class="stringliteral">&quot;\n&quot;</span>;
<span class="preprocessor">    ########################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Print warning</span>
<span class="preprocessor"></span><span class="preprocessor">    ########################################</span>
<span class="preprocessor"></span>
    CGI::div( {<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},
                <span class="stringliteral">&quot;There is NO undo for this function.  </span>
<span class="stringliteral">                 Do not use it unless you know what you are doing!  When you unassign</span>
<span class="stringliteral">                 sets using this button, or by unchecking their set names, you destroy all</span>
<span class="stringliteral">                 of the data for those sets for this student.&quot;</span>
    );


<span class="preprocessor">#   print CGI::start_table();</span>
<span class="preprocessor"></span><span class="preprocessor">#   print CGI::Tr(</span>
<span class="preprocessor"></span><span class="preprocessor">#       CGI::th({ -align =&gt; &quot;center&quot;},[</span>
<span class="preprocessor"></span><span class="preprocessor">#           &quot;Assigned&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           &quot;Set Name&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           &quot;Opens&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           &quot;Answers Due&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           &quot;Answers Available&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       ])</span>
<span class="preprocessor"></span><span class="preprocessor">#   );</span>
<span class="preprocessor"></span>                
<span class="preprocessor">#   foreach my $setID (sortByName(undef, @UserSetIDs)) {</span>
<span class="preprocessor"></span><span class="preprocessor">#       my $MergedSetRecord = $MergedSetRecords{$setID};</span>
<span class="preprocessor"></span><span class="preprocessor">#       print CGI::Tr(</span>
<span class="preprocessor"></span><span class="preprocessor">#           CGI::td({ -align =&gt; &quot;center&quot; }, [</span>
<span class="preprocessor"></span><span class="preprocessor">#               CGI::checkbox({checked =&gt; (defined $MergedSetRecord)}),</span>
<span class="preprocessor"></span><span class="preprocessor">#               $setID,</span>
<span class="preprocessor"></span><span class="preprocessor">#               CGI::checkbox() .</span>
<span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $self-&gt;formatDateTime($MergedSetRecord-&gt;open_date), -size =&gt; 25}),</span>
<span class="preprocessor"></span><span class="preprocessor">#               CGI::checkbox() .</span>
<span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $self-&gt;formatDateTime($MergedSetRecord-&gt;due_date), -size =&gt; 25}),</span>
<span class="preprocessor"></span><span class="preprocessor">#               CGI::checkbox() .</span>
<span class="preprocessor"></span><span class="preprocessor">#               CGI::input({ -value =&gt; $self-&gt;formatDateTime($MergedSetRecord-&gt;answer_date), -size =&gt; 25}),</span>
<span class="preprocessor"></span><span class="preprocessor">#           ])</span>
<span class="preprocessor"></span><span class="preprocessor">#       );</span>
<span class="preprocessor"></span><span class="preprocessor">#   }</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a0b3c8d6848552dc6febbf5a554fbdd06"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::UserDetail::checkDates" ref="a0b3c8d6848552dc6febbf5a554fbdd06" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::UserDetail::checkDates </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-checkDates' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-checkDates-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-checkDates-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-checkDates-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in checkDates: 64</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html#a0b3c8d6848552dc6febbf5a554fbdd06">checkDates</a> { 
    my $self         = shift;
    my $setRecord    = shift;
    my $setID        = shift;
    my $r            = $self-&gt;r;
    my %dates = ();
    my $error_undefined_override = 0;
    my $numerical_date=0;
    my $error        = 0;
    <span class="keywordflow">foreach</span> my $field (@{DATE_FIELDS_ORDER()}) {  # check that <span class="keyword">override</span> dates can be parsed and are not blank
        $dates{$field} = $setRecord-&gt;$field;
        <span class="keywordflow">if</span> (defined  $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field.override&quot;</span>) ){
            eval{ $numerical_date = $self-&gt;parseDateTime($r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field&quot;</span>))};
            unless( $@  ) {
                    $dates{$field}=$numerical_date;
            } <span class="keywordflow">else</span> {
                    $self-&gt;addbadmessage(<span class="stringliteral">&quot;&amp;nbsp;&amp;nbsp;* Badly defined time for set $setID $field. No date changes made:&lt;br/&gt;$@&quot;</span>);
                    $error = 1;
            }
        }
            

    }
    <span class="keywordflow">return</span> {%dates,error=&gt;1} <span class="keywordflow">if</span> $error;    # no point in going on <span class="keywordflow">if</span> the dates can<span class="stringliteral">&#39;t be parsed.</span>
<span class="stringliteral">    </span>
<span class="stringliteral">    my ($open_date, $due_date, $answer_date) = map { $dates{$_} } @{DATE_FIELDS_ORDER()};</span>
<span class="stringliteral"></span>
<span class="stringliteral">    unless ($answer_date &amp;&amp; $due_date &amp;&amp; $open_date) {</span>
<span class="stringliteral">        $self-&gt;addbadmessage(&quot;set $setID has errors in its dates: answer_date |$answer_date|, </span>
<span class="stringliteral">         due date |$due_date|, open_date |$open_date|&quot;);</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    if ($answer_date &lt; $due_date || $answer_date &lt; $open_date) {        </span>
<span class="stringliteral">        $self-&gt;addbadmessage(&quot;Answers cannot be made available until on or after the due date in set $setID!&quot;);</span>
<span class="stringliteral">        $error = 1;</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    </span>
<span class="stringliteral">    if ($due_date &lt; $open_date) {</span>
<span class="stringliteral">        $self-&gt;addbadmessage(&quot;Answers cannot be due until on or after the open date in set $setID!&quot;);</span>
<span class="stringliteral">        $error = 1;</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    </span>
<span class="stringliteral">    # make sure the dates are not more than 10 years in the future</span>
<span class="stringliteral">    my $curr_time = time;</span>
<span class="stringliteral">    my $seconds_per_year = 31_556_926;</span>
<span class="stringliteral">    my $cutoff = $curr_time + $seconds_per_year*10;</span>
<span class="stringliteral">    if ($open_date &gt; $cutoff) {</span>
<span class="stringliteral">        $self-&gt;addbadmessage(&quot;Error: open date cannot be more than 10 years from now in set $setID&quot;);</span>
<span class="stringliteral">        $error = 1;</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    if ($due_date &gt; $cutoff) {</span>
<span class="stringliteral">        $self-&gt;addbadmessage(&quot;Error: due date cannot be more than 10 years from now in set $setID&quot;);</span>
<span class="stringliteral">        $error = 1;</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    if ($answer_date &gt; $cutoff) {</span>
<span class="stringliteral">        $self-&gt;addbadmessage(&quot;Error: answer date cannot be more than 10 years from now in set $setID&quot;);</span>
<span class="stringliteral">        $error = 1;</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    </span>
<span class="stringliteral">    </span>
<span class="stringliteral">    if ($error) {</span>
<span class="stringliteral">        $self-&gt;addbadmessage(&quot;No date changes were saved!&quot;);</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    return {%dates,error=&gt;$error};</span>
<span class="stringliteral">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a8b9061e904af1cd0d0ddfdfbe9d8b1d2"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::UserDetail::DBFieldTable" ref="a8b9061e904af1cd0d0ddfdfbe9d8b1d2" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::UserDetail::DBFieldTable </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-DBFieldTable' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-DBFieldTable-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-DBFieldTable-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-DBFieldTable-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in DBFieldTable: 48</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html#a8b9061e904af1cd0d0ddfdfbe9d8b1d2">DBFieldTable</a> {
    my ($self, $GlobalRecord, $UserRecord, $MergedRecord, $recordType,
        $recordID, $fieldsRef, $rh_fieldLabels) = @_;
    
    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class </span>=&gt; &quot;ResultsWithError&quot;}, &quot;No record exists for $recordType $recordID&quot;) unless defined $GlobalRecord;
    
<span class="preprocessor">    # modify record name if we&#39;re dealing with versioned sets</span>
<span class="preprocessor"></span>    my $isVersioned = 0;
    <span class="keywordflow">if</span> ( $recordType eq <span class="stringliteral">&quot;set&quot;</span> &amp;&amp; defined($MergedRecord) &amp;&amp;
         $MergedRecord-&gt;assignment_type =~ /gateway/ &amp;&amp;
         $MergedRecord-&gt;can( <span class="stringliteral">&quot;version_id&quot;</span> ) ) {
        $recordID .= <span class="stringliteral">&quot;,v&quot;</span> . $MergedRecord-&gt;version_id;
        $isVersioned = 1;
    }
    my $r = $self-&gt;r;
    my @fields = @$fieldsRef;
    my @results;
    <span class="keywordflow">foreach</span> my $field (@fields) {
        my $globalValue = $GlobalRecord-&gt;$field;
        my $userValue = defined $UserRecord ? $UserRecord-&gt;$field : $globalValue;
        my $mergedValue  = defined $MergedRecord ? $MergedRecord-&gt;$field : $globalValue;
        push @results, 
            [$rh_fieldLabels-&gt;{$field},
             defined $UserRecord ? 
                CGI::checkbox({
                    type =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>,
                    name =&gt; <span class="stringliteral">&quot;$recordType.$recordID.$field.override&quot;</span>,
                    label =&gt; <span class="stringliteral">&quot;&quot;</span>,
                    value =&gt; $field,
                    checked =&gt; ($r-&gt;param(<span class="stringliteral">&quot;$recordType.$recordID.$field.override&quot;</span>) || $mergedValue ne $globalValue || $isVersioned) ? 1 : 0
                }) : <span class="stringliteral">&quot;&quot;</span>,
                defined $UserRecord ? 
                    (CGI::input({ -name=&gt;<span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>,
                                  -value =&gt; $userValue ? $self-&gt;formatDateTime($userValue) : <span class="stringliteral">&quot;&quot;</span>, 
                                  -size =&gt; 25})
                    ) : <span class="stringliteral">&quot;&quot;</span>,
                $self-&gt;formatDateTime($globalValue),                
            ]
            
    }

    my @table;
    <span class="keywordflow">foreach</span> my $row (@results) {
        push @table, CGI::Tr(CGI::td({-align =&gt; <span class="stringliteral">&quot;center&quot;</span>}, $row));
    }
    
    <span class="keywordflow">return</span> (CGI::start_table({border =&gt; 0}), @table, CGI::end_table());
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a81bbc60b048267d57fd094ac61cf8f39"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::UserDetail::initialize" ref="a81bbc60b048267d57fd094ac61cf8f39" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::UserDetail::initialize </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-initialize' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-initialize-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-initialize-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-initialize-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in initialize: 118</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1UserDetail.html#a81bbc60b048267d57fd094ac61cf8f39">initialize</a> {
    my ($self) = @_;
    my $r = $self-&gt;r;
    my $urlpath = $r-&gt;urlpath;
    my $db = $r-&gt;db;
    my $authz = $r-&gt;authz;
    my $userID = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
    my $editForUserID = $urlpath-&gt;arg(<span class="stringliteral">&quot;userID&quot;</span>);

    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class </span>=&gt; &quot;ResultsWithError&quot;}, &quot;You are not authorized to edit user specific information.&quot;)
        unless $authz-&gt;hasPermissions($userID, &quot;access_instructor_tools&quot;);

<span class="preprocessor">    # templates for getting field names</span>
<span class="preprocessor"></span>    my $userTemplate = $self-&gt;{userTemplate} = $db-&gt;newUser;
    my $permissionLevelTemplate = $self-&gt;{permissionLevelTemplate} = $db-&gt;newPermissionLevel;
    
<span class="preprocessor">    # first check to see if a save form has been submitted</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span> unless $r-&gt;param(<span class="stringliteral">&#39;save_button&#39;</span>);
    
<span class="preprocessor">    # As it stands we need to check each set to see if it is still assigned </span>
<span class="preprocessor"></span><span class="preprocessor">    # the forms are not currently set up to simply transmit changes</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    #Get the list of sets and the global set records</span>
<span class="preprocessor"></span><span class="preprocessor">    # DBFIXME shouldn&#39;t need set IDs to get records</span>
<span class="preprocessor"></span>    my @setIDs = $db-&gt;listGlobalSets;
    my @setRecords = grep { defined $_ } $db-&gt;getGlobalSets(@setIDs);
    
    my @assignedSets = ();
    <span class="keywordflow">foreach</span> my $setID (@setIDs) {
        push @assignedSets, $setID <span class="keywordflow">if</span> defined($r-&gt;param(<span class="stringliteral">&quot;set.$setID.assignment&quot;</span>));
    }

<span class="preprocessor">    # note: assignedSets are those sets that are assigned in the submitted form</span>
<span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;assignedSets&quot;</span>, join(<span class="stringliteral">&quot; &quot;</span>, @assignedSets));

    my %selectedSets = map { $_ =&gt; 1 } @assignedSets;

<span class="preprocessor">    #debug ##########################</span>
<span class="preprocessor"></span><span class="preprocessor">        #print STDERR (&quot;aSsigned sets&quot;, join(&quot; &quot;,@assignedSets));</span>
<span class="preprocessor"></span><span class="preprocessor">        #my @params = $r-&gt;param();</span>
<span class="preprocessor"></span><span class="preprocessor">        #print STDERR &quot; parameters &quot;, join(&quot; &quot;, @params);</span>
<span class="preprocessor"></span><span class="preprocessor">    ###############</span>
<span class="preprocessor"></span>
<span class="preprocessor">    #Get the user(s) whose records are to be modified</span>
<span class="preprocessor"></span><span class="preprocessor">    #  for now: $editForUserID</span>
<span class="preprocessor"></span><span class="preprocessor">    # check the user exists?  Is this necessary?</span>
<span class="preprocessor"></span>    my $editUserRecord = $db-&gt;getUser($editForUserID);
    die <span class="stringliteral">&quot;record not found for $editForUserID.\n&quot;</span> unless $editUserRecord;

<span class="preprocessor">    #Perform the desired assignments or deletions</span>
<span class="preprocessor"></span>    my %userSets = map { $_ =&gt; 1 } $db-&gt;listUserSets($editForUserID);

<span class="preprocessor">    # go through each possible set</span>
<span class="preprocessor"></span>    debug(<span class="stringliteral">&quot; parameters &quot;</span>, join(<span class="stringliteral">&quot; &quot;</span>, $r-&gt;param()) );
    <span class="keywordflow">foreach</span> my $setRecord (@setRecords) {
        my $setID = $setRecord-&gt;set_id;
<span class="preprocessor">        # does the user want it to be assigned to the selected user</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (exists $selectedSets{$setID}) {
<span class="preprocessor">            # change by glarose, 2007/02/07: only assign set if the </span>
<span class="preprocessor"></span><span class="preprocessor">            # user doesn&#39;t already have the set assigned.</span>
<span class="preprocessor"></span>            $self-&gt;assignSetToUser($editForUserID, $setRecord) <span class="keywordflow">if</span> ( ! $userSets{$setID} );

<span class="preprocessor">            #override dates</span>
<span class="preprocessor"></span>            my $userSetRecord = $db-&gt;getUserSet($editForUserID, $setID);
<span class="preprocessor">            # get the dates</span>
<span class="preprocessor"></span><span class="preprocessor">            #do checks to see if new dates meet criteria</span>
<span class="preprocessor"></span>            my $rh_dates = $self-&gt;checkDates($setRecord,$setID);
            unless  ( $rh_dates-&gt;{error} ) { #returns 1 <span class="keywordflow">if</span> error
<span class="preprocessor">                # if no error update database</span>
<span class="preprocessor"></span>                <span class="keywordflow">foreach</span> my $field (keys %{DATE_FIELDS()}) {
                    <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field.override&quot;</span>)) {
                        $userSetRecord-&gt;$field($rh_dates-&gt;{$field});
                    } <span class="keywordflow">else</span> {
                        $userSetRecord-&gt;$field(undef); #stop <span class="keyword">override</span>
                    }
                }
                $db-&gt;putUserSet($userSetRecord);
            }

<span class="preprocessor">            # if the set is a gateway set, also check to see if we&#39;re</span>
<span class="preprocessor"></span><span class="preprocessor">            #    resetting the dates for any of the assigned set versions</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $setRecord-&gt;assignment_type =~ /gateway/ ) {
                my @setVer = $db-&gt;listSetVersions( $editForUserID,
                                   $setID );
                <span class="keywordflow">foreach</span> my $ver ( @setVer ) {
                    my $setVersionRecord =
                        $db-&gt;getSetVersion( $editForUserID,
                                    $setID, $ver );
                    my $rh_dates = $self-&gt;checkDates($setVersionRecord,
                                     <span class="stringliteral">&quot;$setID,v$ver&quot;</span>);
                    unless ( $rh_dates-&gt;{error} ) {
                        <span class="keywordflow">foreach</span> my $field ( keys %{DATE_FIELDS()} ) {
                            <span class="keywordflow">if</span> ( defined( $r-&gt;param(<span class="stringliteral">&quot;set.$setID,v$ver.$field.override&quot;</span>) ) ) {
                                $setVersionRecord-&gt;$field($rh_dates-&gt;{$field});
                            } <span class="keywordflow">else</span> {
                                $setVersionRecord-&gt;$field(undef);
                            }
                        }
                        $db-&gt;putSetVersion( $setVersionRecord );
                    }
                }
            }

        } <span class="keywordflow">else</span> {
<span class="preprocessor">            # user asked to NOT have the set assigned to the selected user</span>
<span class="preprocessor"></span><span class="preprocessor">            # debug(&quot;deleteUserSet($editForUserID, $setID)&quot;);</span>
<span class="preprocessor"></span><span class="preprocessor">            # change by glarose, 2007/02/07: only do delete if user</span>
<span class="preprocessor"></span><span class="preprocessor">            # had the set previously assigned</span>
<span class="preprocessor"></span>            $db-&gt;deleteUserSet($editForUserID, $setID) <span class="keywordflow">if</span> ( $userSets{$setID} );
<span class="preprocessor">            # debug(&quot;done deleteUserSet($editForUserID, $setID)&quot;);</span>
<span class="preprocessor"></span>        }
    }
    
    <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
    
    
    
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="UserDetail_8pm_source.html">UserDetail.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:58:26 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
