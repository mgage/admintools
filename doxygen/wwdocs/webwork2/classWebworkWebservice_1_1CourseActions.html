<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WebworkWebservice::CourseActions Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWebworkWebservice.html">WebworkWebservice</a>::<a class="el" href="classWebworkWebservice_1_1CourseActions.html">CourseActions</a>
  </div>
</div>
<div class="contents">
<h1>WebworkWebservice::CourseActions Class Reference</h1><!-- doxytag: class="WebworkWebservice::CourseActions" --><!-- doxytag: inherits="WebworkWebservice" --><div class="dynheader">
Inheritance diagram for WebworkWebservice::CourseActions:</div>
<div class="dynsection">
<div class="center"><img src="classWebworkWebservice_1_1CourseActions__inherit__graph.png" border="0" usemap="#WebworkWebservice_1_1CourseActions_inherit__map" alt="Inheritance graph"/></div>
<map name="WebworkWebservice_1_1CourseActions_inherit__map" id="WebworkWebservice_1_1CourseActions_inherit__map">
<area shape="rect" href="classWebworkWebservice.html" title="WebworkWebservice" alt="" coords="52,5,193,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WebworkWebservice::CourseActions:</div>
<div class="dynsection">
<div class="center"><img src="classWebworkWebservice_1_1CourseActions__coll__graph.png" border="0" usemap="#WebworkWebservice_1_1CourseActions_coll__map" alt="Collaboration graph"/></div>
<map name="WebworkWebservice_1_1CourseActions_coll__map" id="WebworkWebservice_1_1CourseActions_coll__map">
<area shape="rect" href="classWebworkWebservice.html" title="WebworkWebservice" alt="" coords="52,5,193,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWebworkWebservice_1_1CourseActions-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWebworkWebservice_1_1CourseActions.html#a8cb9ea278c2e5abc67afb10cd515c63c">addLog</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWebworkWebservice_1_1CourseActions.html#ac4d0716afc0521dcd89919d96490d417">create</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWebworkWebservice_1_1CourseActions.html#a2d673429f0639538bb5ecf7e0618a80d">dropUser</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWebworkWebservice_1_1CourseActions.html#a1a82cd47544984982e532f53320917ce">addUser</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWebworkWebservice_1_1CourseActions.html#a5f794ffc6957beb74e567021e239995c">assignVisibleSets</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>

<p>Definition at line <a class="el" href="CourseActions_8pm_source.html#l00019">19</a> of file <a class="el" href="CourseActions_8pm_source.html">CourseActions.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a8cb9ea278c2e5abc67afb10cd515c63c"></a><!-- doxytag: member="WebworkWebservice::CourseActions::addLog" ref="a8cb9ea278c2e5abc67afb10cd515c63c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WebworkWebservice::CourseActions::addLog </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-addLog' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-addLog-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-addLog-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-addLog-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in addLog: 21</span>
<span class="preprocessor"></span>sub <a class="code" href="classWebworkWebservice_1_1CourseActions.html#a8cb9ea278c2e5abc67afb10cd515c63c">addLog</a> {
    my ($ce, $msg) = @_;
    <span class="keywordflow">if</span> (!$ce-&gt;{webservices}{enableCourseActionsLog}) {
        <span class="keywordflow">return</span>;
    }
    my ($sec, $msec) = gettimeofday;
    my $date = time2str(<span class="stringliteral">&quot;%a %b %d %H:%M:%S.$msec %Y&quot;</span>, $sec);

    $msg = <span class="stringliteral">&quot;[$date] $msg\n&quot;</span>;

    my $logfile = $ce-&gt;{webservices}{courseActionsLogfile};
    <span class="keywordflow">if</span> (open my $f, <span class="stringliteral">&quot;&gt;&gt;&quot;</span>, $logfile) {
        print $f $msg;
        close $f;
    }
    <span class="keywordflow">else</span> {
        debug(<span class="stringliteral">&quot;Error, unable to open student updates log file &#39;$logfile&#39; in&quot;</span>.
            <span class="stringliteral">&quot;append mode: $!&quot;</span>);
    }
    <span class="keywordflow">return</span>;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a1a82cd47544984982e532f53320917ce"></a><!-- doxytag: member="WebworkWebservice::CourseActions::addUser" ref="a1a82cd47544984982e532f53320917ce" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WebworkWebservice::CourseActions::addUser </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-addUser' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-addUser-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-addUser-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-addUser-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in addUser: 103</span>
<span class="preprocessor"></span>sub <a class="code" href="classWebworkWebservice_1_1CourseActions.html#a1a82cd47544984982e532f53320917ce">addUser</a> {
    my ($self, $params) = @_;
    my $out = {};
    my $db = $self-&gt;{db};
    my $ce = $self-&gt;{ce};
    debug(<span class="stringliteral">&quot;Webservices add user request.&quot;</span>);

<span class="preprocessor">    # make sure course actions are enabled</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (!$ce-&gt;{webservices}{enableCourseActions}) {
        $out-&gt;{status} = <span class="stringliteral">&quot;failure&quot;</span>;
        $out-&gt;{message} = <span class="stringliteral">&quot;Course actions disabled by configuration.&quot;</span>;
        <span class="keywordflow">return</span> $out
    }

<span class="preprocessor">    # Two scenarios</span>
<span class="preprocessor"></span><span class="preprocessor">    # 1. New user</span>
<span class="preprocessor"></span><span class="preprocessor">    # 2. Dropped user deciding to re-enrol</span>
<span class="preprocessor"></span>
    my $olduser = $db-&gt;getUser($params-&gt;{<span class="keywordtype">id</span>});
    my $id = $params-&gt;{<span class="stringliteral">&#39;id&#39;</span>};
    my $permission; # stores user<span class="stringliteral">&#39;s permission level</span>
<span class="stringliteral">    if ($olduser) { </span>
<span class="stringliteral">        # a dropped user decided to re-enrol</span>
<span class="stringliteral">        my $enrolled = $self-&gt;{ce}-&gt;{statuses}-&gt;{Enrolled}-&gt;{abbrevs}-&gt;[0];</span>
<span class="stringliteral">        $olduser-&gt;status($enrolled);</span>
<span class="stringliteral">        $db-&gt;putUser($olduser);</span>
<span class="stringliteral">        addLog($ce, &quot;User &quot;. $id . &quot; re-enrolled in &quot; . </span>
<span class="stringliteral">            $ce-&gt;{courseName});</span>
<span class="stringliteral">        $out-&gt;{status} = &#39;</span>success<span class="stringliteral">&#39;;</span>
<span class="stringliteral">        $permission = $db-&gt;getPermissionLevel($id);</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    else {</span>
<span class="stringliteral">        # a new user showed up</span>
<span class="stringliteral">        my $ce = $self-&gt;{ce};</span>
<span class="stringliteral">        </span>
<span class="stringliteral">        # student record</span>
<span class="stringliteral">        my $enrolled = $ce-&gt;{statuses}-&gt;{Enrolled}-&gt;{abbrevs}-&gt;[0];</span>
<span class="stringliteral">        my $new_student = $db-&gt;{user}-&gt;{record}-&gt;new();</span>
<span class="stringliteral">        $new_student-&gt;user_id($id);</span>
<span class="stringliteral">        $new_student-&gt;first_name($params-&gt;{&#39;</span>firstname<span class="stringliteral">&#39;});</span>
<span class="stringliteral">        $new_student-&gt;last_name($params-&gt;{&#39;</span>lastname<span class="stringliteral">&#39;});</span>
<span class="stringliteral">        $new_student-&gt;status($enrolled);</span>
<span class="stringliteral">        $new_student-&gt;student_id($params-&gt;{&#39;</span>studentid<span class="stringliteral">&#39;});</span>
<span class="stringliteral">        $new_student-&gt;email_address($params-&gt;{&#39;</span>email<span class="stringliteral">&#39;});</span>
<span class="stringliteral">        </span>
<span class="stringliteral">        # password record</span>
<span class="stringliteral">        my $cryptedpassword = &quot;&quot;;</span>
<span class="stringliteral">        if ($params-&gt;{&#39;</span>userpassword<span class="stringliteral">&#39;}) {</span>
<span class="stringliteral">            $cryptedpassword = cryptPassword($params-&gt;{&#39;</span>userpassword<span class="stringliteral">&#39;});</span>
<span class="stringliteral">        }</span>
<span class="stringliteral">        elsif ($new_student-&gt;student_id()) {</span>
<span class="stringliteral">            $cryptedpassword = cryptPassword($new_student-&gt;student_id());</span>
<span class="stringliteral">        }</span>
<span class="stringliteral">        my $password = $db-&gt;newPassword(user_id =&gt; $id);</span>
<span class="stringliteral">        $password-&gt;password($cryptedpassword);</span>
<span class="stringliteral">        </span>
<span class="stringliteral">        # permission record</span>
<span class="stringliteral">        $permission = $params-&gt;{&#39;</span>permission<span class="stringliteral">&#39;};</span>
<span class="stringliteral">        if (defined($ce-&gt;{userRoles}{$permission})) {</span>
<span class="stringliteral">            $permission = $db-&gt;newPermissionLevel(</span>
<span class="stringliteral">                user_id =&gt; $id, </span>
<span class="stringliteral">                permission =&gt; $ce-&gt;{userRoles}{$permission});</span>
<span class="stringliteral">        }</span>
<span class="stringliteral">        else {</span>
<span class="stringliteral">            $permission = $db-&gt;newPermissionLevel(user_id =&gt; $id, </span>
<span class="stringliteral">                permission =&gt; $ce-&gt;{userRoles}{student});</span>
<span class="stringliteral">        }</span>
<span class="stringliteral"></span>
<span class="stringliteral">        # commit changes to db</span>
<span class="stringliteral">        $out-&gt;{status} = &#39;</span>success<span class="stringliteral">&#39;;</span>
<span class="stringliteral">        eval{ $db-&gt;addUser($new_student); };</span>
<span class="stringliteral">        if ($@) {</span>
<span class="stringliteral">            $out-&gt;{status} = &#39;</span>failure<span class="stringliteral">&#39;;</span>
<span class="stringliteral">            $out-&gt;{message} = &quot;Add user for $id failed!\n&quot;;</span>
<span class="stringliteral">        }</span>
<span class="stringliteral">        eval { $db-&gt;addPassword($password); };</span>
<span class="stringliteral">        if ($@) {</span>
<span class="stringliteral">            $out-&gt;{status} = &#39;</span>failure<span class="stringliteral">&#39;;</span>
<span class="stringliteral">            $out-&gt;{message} = &quot;Add password for $id failed!\n&quot;;</span>
<span class="stringliteral">        }</span>
<span class="stringliteral">        eval { $db-&gt;addPermissionLevel($permission); };</span>
<span class="stringliteral">        if ($@) {</span>
<span class="stringliteral">            $out-&gt;{status} = &#39;</span>failure<span class="stringliteral">&#39;;</span>
<span class="stringliteral">            $out-&gt;{message} = &quot;Add permission for $id failed!\n&quot;;</span>
<span class="stringliteral">        }</span>
<span class="stringliteral"></span>
<span class="stringliteral">        addLog($ce, &quot;User &quot;. $id . &quot; newly added in &quot; . </span>
<span class="stringliteral">            $ce-&gt;{courseName});</span>
<span class="stringliteral">    }</span>
<span class="stringliteral"></span>
<span class="stringliteral">    # only students are assigned homework</span>
<span class="stringliteral">    if ($ce-&gt;{webservices}{courseActionsAssignHomework} &amp;&amp;</span>
<span class="stringliteral">        $permission-&gt;{permission} == $ce-&gt;{userRoles}{student}) {</span>
<span class="stringliteral">        debug(&quot;Assigning homework.&quot;);</span>
<span class="stringliteral">        my $ret = assignVisibleSets($db, $id);</span>
<span class="stringliteral">        if ($ret) {</span>
<span class="stringliteral">            $out-&gt;{status} = &#39;</span>failure<span class="stringliteral">&#39;;</span>
<span class="stringliteral">            $out-&gt;{message} = &quot;User created but unable to assign sets. $ret&quot;;</span>
<span class="stringliteral">        }</span>
<span class="stringliteral">    }</span>
<span class="stringliteral"></span>
<span class="stringliteral">    return $out;</span>
<span class="stringliteral">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a5f794ffc6957beb74e567021e239995c"></a><!-- doxytag: member="WebworkWebservice::CourseActions::assignVisibleSets" ref="a5f794ffc6957beb74e567021e239995c" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WebworkWebservice::CourseActions::assignVisibleSets </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-assignVisibleSets' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-assignVisibleSets-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-assignVisibleSets-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-assignVisibleSets-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in assignVisibleSets: 46</span>
<span class="preprocessor"></span>sub <a class="code" href="classWebworkWebservice_1_1CourseActions.html#a5f794ffc6957beb74e567021e239995c">assignVisibleSets</a> {
    my ($db, $userID) = @_;
    my @globalSetIDs = $db-&gt;listGlobalSets;
    my @GlobalSets = $db-&gt;getGlobalSets(@globalSetIDs);

    my $i = -1;
    <span class="keywordflow">foreach</span> my $GlobalSet (@GlobalSets) {
        $i++;
        <span class="keywordflow">if</span> (not defined $GlobalSet) {
            debug(<span class="stringliteral">&quot;Record not found for global set $globalSetIDs[$i]&quot;</span>);
            next;
        } 
        <span class="keywordflow">if</span> (!$GlobalSet-&gt;visible) {
            next;
        }

<span class="preprocessor">        # assign set to user</span>
<span class="preprocessor"></span>        my $setID = $GlobalSet-&gt;set_id;
        my $UserSet = $db-&gt;newUserSet;
        $UserSet-&gt;user_id($userID);
        $UserSet-&gt;set_id($setID);
        my @results;
        my $set_assigned = 0;
        eval { $db-&gt;addUserSet($UserSet) }; 
        <span class="keywordflow">if</span> ( $@ &amp;&amp; !($@ =~ m/user <span class="keyword">set</span> exists/)) {
            <span class="keywordflow">return</span> <span class="stringliteral">&quot;Failed to assign set to user $userID&quot;</span>;
        }

<span class="preprocessor">        # assign problem</span>
<span class="preprocessor"></span>        my @GlobalProblems = grep { defined $_ } $db-&gt;getAllGlobalProblems($setID);
        <span class="keywordflow">foreach</span> my $GlobalProblem (@GlobalProblems) {
            my $seed = int( rand( 2423) ) + 36;
            my $UserProblem = $db-&gt;newUserProblem;
            $UserProblem-&gt;user_id($userID);
            $UserProblem-&gt;set_id($GlobalProblem-&gt;set_id);
            $UserProblem-&gt;problem_id($GlobalProblem-&gt;problem_id);
            initializeUserProblem($UserProblem, $seed);
            eval { $db-&gt;addUserProblem($UserProblem) };
            <span class="keywordflow">if</span> ($@ &amp;&amp; !($@ =~ m/user problem exists/)) {
                <span class="keywordflow">return</span> <span class="stringliteral">&quot;Failed to assign problems to user $userID&quot;</span>;
            }
        }
    }

    <span class="keywordflow">return</span> 0;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ac4d0716afc0521dcd89919d96490d417"></a><!-- doxytag: member="WebworkWebservice::CourseActions::create" ref="ac4d0716afc0521dcd89919d96490d417" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WebworkWebservice::CourseActions::create </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-create' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-create-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-create-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-create-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in create: 77</span>
<span class="preprocessor"></span>sub <a class="code" href="classWebworkWebservice_1_1CourseActions.html#ac4d0716afc0521dcd89919d96490d417">create</a> {
    my ($self, $params) = @_;
    my $newcourse = $params-&gt;{<span class="stringliteral">&#39;name&#39;</span>};
<span class="preprocessor">    # note this ce is different from $self-&gt;{ce}!</span>
<span class="preprocessor"></span>    my $ce = <a class="code" href="classWeBWorK_1_1CourseEnvironment.html">WeBWorK::CourseEnvironment</a>-&gt;new({
            webwork_dir =&gt; $self-&gt;{ce}-&gt;{webwork_dir},
            courseName =&gt; $newcourse
        });
    my $db = $self-&gt;{db};
    my $authz = $self-&gt;{authz};
    my $out = {};

    debug(<span class="stringliteral">&quot;Webservices course creation request.&quot;</span>);
<span class="preprocessor">    # make sure course actions are enabled</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (!$ce-&gt;{webservices}{enableCourseActions}) {
        debug(<span class="stringliteral">&quot;Course actions disabled by configuration.&quot;</span>);
        $out-&gt;{status} = <span class="stringliteral">&quot;failure&quot;</span>;
        $out-&gt;{message} = <span class="stringliteral">&quot;Course actions disabled by configuration.&quot;</span>;
        <span class="keywordflow">return</span> $out
    }
<span class="preprocessor">    # only users from the admin course with appropriate permissions allowed</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (!($self-&gt;{ce}-&gt;{courseName} eq <span class="stringliteral">&#39;admin&#39;</span>)) {
        debug(<span class="stringliteral">&quot;Course creation attempt when not logged into admin course.&quot;</span>);
        $out-&gt;{status} = <span class="stringliteral">&quot;failure&quot;</span>;
        $out-&gt;{message} = <span class="stringliteral">&quot;Course creation allowed only for admin course users.&quot;</span>;
        <span class="keywordflow">return</span> $out
    }
<span class="preprocessor">    # prof check is actually done when initiating session, this is just in case</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (!$self-&gt;{authz}-&gt;hasPermissions($params-&gt;{<span class="stringliteral">&#39;userID&#39;</span>}, 
            <span class="stringliteral">&#39;create_and_delete_courses&#39;</span>)) {
        debug(<span class="stringliteral">&quot;Course creation attempt with insufficient permission level.&quot;</span>);
        $out-&gt;{status} = <span class="stringliteral">&quot;failure&quot;</span>;
        $out-&gt;{message} = <span class="stringliteral">&quot;Insufficient permission level.&quot;</span>;
        <span class="keywordflow">return</span> $out
    }
    
<span class="preprocessor">    # declare params</span>
<span class="preprocessor"></span>    my @professors = ();
    my $dbLayout = $ce-&gt;{dbLayoutName};
    my %courseOptions = ( dbLayoutName =&gt; $dbLayout );
    my %dbOptions;
    my @users;
    my %optional_arguments;

    my $userClass = $ce-&gt;{dbLayouts}-&gt;{$dbLayout}-&gt;{user}-&gt;{record};
    my $passwordClass = $ce-&gt;{dbLayouts}-&gt;{$dbLayout}-&gt;{password}-&gt;{record};
    my $permissionClass = $ce-&gt;{dbLayouts}-&gt;{$dbLayout}-&gt;{permission}-&gt;{record};

<span class="preprocessor">    # copy instructors from admin course</span>
<span class="preprocessor"></span><span class="preprocessor">    # modified from do_add_course in WeBWorK::ContentGenerator::CourseAdmin</span>
<span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $userID ($db-&gt;listUsers) {
        my $User            = $db-&gt;getUser($userID);
        my $Password        = $db-&gt;getPassword($userID);
        my $PermissionLevel = $db-&gt;getPermissionLevel($userID);
        push @users, [ $User, $Password, $PermissionLevel ] 
            <span class="keywordflow">if</span> $authz-&gt;hasPermissions($userID,<span class="stringliteral">&quot;create_and_delete_courses&quot;</span>);  
    }

<span class="preprocessor">    # all data prepped, try to actually add the course</span>
<span class="preprocessor"></span>    eval {
        addCourse(
            courseID =&gt; $newcourse,
            ce =&gt; $ce,
            courseOptions =&gt; \%courseOptions,
            dbOptions =&gt; \%dbOptions,
            users =&gt; \@users,
            %optional_arguments,
        );
        <a class="code" href="classWebworkWebservice_1_1CourseActions.html#a8cb9ea278c2e5abc67afb10cd515c63c">addLog</a>($ce, <span class="stringliteral">&quot;New course created: &quot;</span> . $newcourse);
        $out-&gt;{status} = <span class="stringliteral">&quot;success&quot;</span>;
    } or <span class="keywordflow">do</span> {
        $out-&gt;{status} = <span class="stringliteral">&quot;failure&quot;</span>;
        $out-&gt;{message} = $@;
    };
    
    <span class="keywordflow">return</span> $out;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2d673429f0639538bb5ecf7e0618a80d"></a><!-- doxytag: member="WebworkWebservice::CourseActions::dropUser" ref="a2d673429f0639538bb5ecf7e0618a80d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WebworkWebservice::CourseActions::dropUser </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-dropUser' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-dropUser-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-dropUser-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-dropUser-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in dropUser: 31</span>
<span class="preprocessor"></span>sub <a class="code" href="classWebworkWebservice_1_1CourseActions.html#a2d673429f0639538bb5ecf7e0618a80d">dropUser</a> {
    my ($self, $params) = @_;
    my $db = $self-&gt;{db};
    my $ce = $self-&gt;{ce};
    my $out = {};
    debug(<span class="stringliteral">&quot;Webservices drop user request.&quot;</span>);

<span class="preprocessor">    # make sure course actions are enabled</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (!$ce-&gt;{webservices}{enableCourseActions}) {
        $out-&gt;{status} = <span class="stringliteral">&quot;failure&quot;</span>;
        $out-&gt;{message} = <span class="stringliteral">&quot;Course actions disabled by configuration.&quot;</span>;
        <span class="keywordflow">return</span> $out
    }

<span class="preprocessor">    # Mark user as dropped</span>
<span class="preprocessor"></span>    my $drop = $self-&gt;{ce}-&gt;{statuses}-&gt;{Drop}-&gt;{abbrevs}-&gt;[0];
    my $person = $db-&gt;getUser($params-&gt;{<span class="stringliteral">&#39;id&#39;</span>});
    <span class="keywordflow">if</span> ($person) {
        $person-&gt;status($drop);
        $db-&gt;putUser($person);
        <a class="code" href="classWebworkWebservice_1_1CourseActions.html#a8cb9ea278c2e5abc67afb10cd515c63c">addLog</a>($ce, <span class="stringliteral">&quot;User &quot;</span>. $person-&gt;user_id() . <span class="stringliteral">&quot; dropped from &quot;</span> . 
            $ce-&gt;{courseName});
        $out-&gt;{status} = <span class="stringliteral">&#39;success&#39;</span>;
    }
    <span class="keywordflow">else</span> {
        $out-&gt;{status} = <span class="stringliteral">&#39;failure&#39;</span>;
        $out-&gt;{message} = <span class="stringliteral">&#39;Could not find user&#39;</span>;
    }

    <span class="keywordflow">return</span> $out;
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="CourseActions_8pm_source.html">CourseActions.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 23:00:45 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
