<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::Utils::CourseManagement::sql_single Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1Utils.html">Utils</a>::<a class="el" href="classWeBWorK_1_1Utils_1_1CourseManagement.html">CourseManagement</a>::<a class="el" href="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single.html">sql_single</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::Utils::CourseManagement::sql_single Class Reference</h1><!-- doxytag: class="WeBWorK::Utils::CourseManagement::sql_single" --><!-- doxytag: inherits="WeBWorK::Utils::CourseManagement" --><div class="dynheader">
Inheritance diagram for WeBWorK::Utils::CourseManagement::sql_single:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single__inherit__graph.png" border="0" usemap="#WeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single_inherit__map" id="WeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single_inherit__map">
<area shape="rect" href="classWeBWorK_1_1Utils_1_1CourseManagement.html" title="WeBWorK::Utils::CourseManagement" alt="" coords="39,155,279,181"/><area shape="rect" href="classWeBWorK_1_1Utils.html" title="WeBWorK::Utils" alt="" coords="100,80,217,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="117,5,200,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::Utils::CourseManagement::sql_single:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single__coll__graph.png" border="0" usemap="#WeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single_coll__map" id="WeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single_coll__map">
<area shape="rect" href="classWeBWorK_1_1Utils_1_1CourseManagement.html" title="WeBWorK::Utils::CourseManagement" alt="" coords="39,155,279,181"/><area shape="rect" href="classWeBWorK_1_1Utils.html" title="WeBWorK::Utils" alt="" coords="100,80,217,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="117,5,200,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">private method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single.html#aea9d76e285c980ec274f4cce0bfa1695">_get_db_info</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single.html#aab707f5c7077faf0b239e8c28d4ec624">unarchiveCourseHelper</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single.html">WeBWorK::Utils::CourseManagement::sql_single</a> - create and delete courses using the <a class="el" href="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single.html">sql_single</a> database layout. </p>
<p># DBFIXME this whole process should be through an abstraction layer # DBFIXME (we shouldn't be calling mysqldump here sub archiveCourseHelper { my ($courseID, $ce, $dbLayoutName, %options) = @_; debug("courseID=$courseID, ce=$ce dbLayoutName=$dbLayoutName\\n"); </p>
<pre>	##### get list of tables to archive #####</pre><pre>	my $dbLayout    = $ce-&gt;{dbLayouts}-&gt;{$dbLayoutName};
	debug("dbLayout=$dbLayout\\n");
	my %sources     = dbLayoutSQLSources($dbLayout);
	debug("fSources: ", Dumper(\%sources));
	my $source    = mostPopularSource(%sources);
	debug("source=$source\\n");
	my %source = %{ $sources{$source} };
	my @tables = @{ $source{tables} };
	my $username = $source{username};
	my $password = $source{password};
	my $archiveDatabasePath = $options{archiveDatabasePath};</pre><pre>	##### construct SQL statements to copy the data in each table #####</pre><pre>	my @stmts;
	my @dataTables = ();
	foreach my $table (@tables) {
		debug("Table: $table\\n");</pre><pre>		if ($dbLayout-&gt;{$table}{params}{non_native}) {
			debug("$table: marked non-native, skipping\\n");
			next;
		}</pre><pre>		my $table = do {
			my $paramsRef = $dbLayout-&gt;{$table}-&gt;{params};
			if ($paramsRef) {
				if (exists $paramsRef-&gt;{tableOverride}) {
					$paramsRef-&gt;{tableOverride}
				} else {
					""; # no override
				}
			} else {
				""; # no params
			}
		} || $table;
		debug("sql \\"real\" table name: $table\\n");</pre><pre>        # this method would be mysql specific but it's a start
		# mysqldump  --user=$username   --password=$password database   tables
#		my $stmt = "DUMP SELECT * FROM `$fromTable`";
#		debug("stmt = $stmt\\n");
#		push @stmts, $stmt;
	    push @dataTables, $table;
	}
	debug("Database tables to export are ",join(" ", @dataTables));
	# this method would be mysql specific but it's a start
	my $mysqldumpCommand = $ce-&gt;{externalPrograms}{mysqldump};
	my $exportStatement = " $mysqldumpCommand  --user=$username  ".
	"--password=$password " .
	" webwork   ".
	join(" ", @dataTables).
	"   &amp;gt;$archiveDatabasePath";
	debug($exportStatement);
	my $exportResult = system $exportStatement;
	$exportResult and die "Failed to export database with command: '$exportStatement ' (errno: $exportResult): $!
	\\n\\n Check server error log for more information.";</pre><pre>	##### issue SQL statements #####</pre><p># my $dbh = DBI-&gt;connect($source, $username, $password); # unless (defined $dbh) { # die "sql_single: failed to connect to DBI source '$source': $DBI::errstr\\n"; # } # # foreach my $stmt (@stmts) { # my $rows = $dbh-&gt;do($stmt); # unless (defined $rows) { # die "sql_single: failed to execute SQL statement '$stmt': $DBI::errstr\\n"; # } # } # # $dbh-&gt;disconnect; </p>
<pre>	return 1;
}</pre><p># DBFIXME this whole process should be through an abstraction layer # DBFIXME (we shouldn't be calling mysqldump here!) sub unarchiveCourseHelper { my ($courseID, $ce, $dbLayoutName, %options) = @_; debug("courseID=$courseID, ce=$ce dbLayoutName=$dbLayoutName\\n"); </p>
<pre>	##### get list of tables to archive #####</pre><pre>	my $dbLayout    = $ce-&gt;{dbLayouts}-&gt;{$dbLayoutName};
	debug("dbLayout=$dbLayout\\n");
	my %sources     = dbLayoutSQLSources($dbLayout);
	debug("fSources: ", Dumper(\%sources));
	my $source    = mostPopularSource(%sources);
	debug("source=$source\\n");
	my %source = %{ $sources{$source} };
	my @tables = @{ $source{tables} };
	my $username = $source{username};
	my $password = $source{password};
	my $unarchiveDatabasePath = $options{unarchiveDatabasePath};
	debug( "unarchive database Path is $unarchiveDatabasePath");
	##### construct SQL statements to copy the data in each table #####</pre><pre>	# this method would be mysql specific but it's a start
	my $mysqlCommand = $ce-&gt;{externalPrograms}{mysql};
	my $importStatement = " $mysqlCommand  --user=$username  ".
	"--password=$password " .
	"-D webwork".        # specifies database name
	"   &amp;lt;$unarchiveDatabasePath";
	debug($importStatement);
	my $importResult = system $importStatement;
	$importResult and die "&lt;pre&gt;Failed to import database with command: \n
	'$importStatement ' \n
	(errno: $importResult): $!
	\n Check server error log for more information.\n&lt;/pre&gt;";
	#FIXME  -- what should the return be??
	return 1;
}</pre><p># returns the name of the source with the most tables sub mostPopularSource { my (%sources) = @_; </p>
<pre>	my $source;
	if (keys %sources &gt; 1) {
		# more than one -- warn and select the most popular source
 		debug("more than one SQL source defined.\\n");
		foreach my $curr (keys %sources) {
			$source = $curr if not defined $source or @{ $sources{$curr}-&gt;{tables} } &gt; @{ $sources{$source}-&gt;{tables} };
 		}
 		debug("only handling tables with source \\"$source\".\\n");
 		debug("others will have to be handled manually (or not at all).\\n");
 	} else {
		# there's only one
		($source) = keys %sources;
	}</pre><pre>	return $source;
}</pre> 
<p>Definition at line <a class="el" href="sql__single_8pm_source.html#l00162">162</a> of file <a class="el" href="sql__single_8pm_source.html">sql_single.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="aea9d76e285c980ec274f4cce0bfa1695"></a><!-- doxytag: member="WeBWorK::Utils::CourseManagement::sql_single::_get_db_info" ref="aea9d76e285c980ec274f4cce0bfa1695" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">private method WeBWorK::Utils::CourseManagement::sql_single::_get_db_info </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-_get_db_info' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-_get_db_info-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-_get_db_info-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-_get_db_info-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in _get_db_info: 28</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single.html#aea9d76e285c980ec274f4cce0bfa1695">_get_db_info</a> {
    my ($ce) = @_;
    my $dsn = $ce-&gt;{database_dsn};
    my $username = $ce-&gt;{database_username};
    my $password = $ce-&gt;{database_password};
    
    die <span class="stringliteral">&quot;Can&#39;t call dump_table or restore_table on a table with a non-MySQL source&quot;</span>
        unless $dsn =~ s/^dbi:mysql:<span class="comment">//i;</span>
    
<span class="preprocessor">    # this is an internal function which we probably shouldn&#39;t be using here</span>
<span class="preprocessor"></span><span class="preprocessor">    # but it&#39;s quick and gets us what we want (FIXME what about sockets, etc?)</span>
<span class="preprocessor"></span>    my %dsn;
    <a class="code" href="classWeBWorK_1_1Utils.html#a6662b8474a5bfd16c7b4efe4d817a8ee">runtime_use</a> <span class="stringliteral">&quot;DBD::mysql&quot;</span>;
    DBD::mysql-&gt;_OdbcParse($dsn, \%dsn, [<span class="stringliteral">&#39;database&#39;</span>, <span class="stringliteral">&#39;host&#39;</span>, <span class="stringliteral">&#39;port&#39;</span>]);
    die <span class="stringliteral">&quot;no database specified in DSN!&quot;</span> unless defined $dsn{database};
    
<span class="preprocessor">    # doing this securely is kind of a hassle...</span>
<span class="preprocessor"></span>    my $my_cnf = <span class="keyword">new</span> File::Temp;
    $my_cnf-&gt;unlink_on_destroy(1);
    chmod 0600, $my_cnf or die <span class="stringliteral">&quot;failed to chmod 0600 $my_cnf: $!&quot;</span>; # File::Temp objects stringify with -&gt;filename
    print $my_cnf <span class="stringliteral">&quot;[client]\n&quot;</span>;
    print $my_cnf <span class="stringliteral">&quot;user=$username\n&quot;</span> <span class="keywordflow">if</span> defined $username and length($username) &gt; 0;
    print $my_cnf <span class="stringliteral">&quot;password=$password\n&quot;</span> <span class="keywordflow">if</span> defined $password and length($password) &gt; 0;
    print $my_cnf <span class="stringliteral">&quot;host=$dsn{host}\n&quot;</span> <span class="keywordflow">if</span> defined $dsn{host} and length($dsn{host}) &gt; 0;
    print $my_cnf <span class="stringliteral">&quot;port=$dsn{port}\n&quot;</span> <span class="keywordflow">if</span> defined $dsn{port} and length($dsn{port}) &gt; 0;
    
    <span class="keywordflow">return</span> ($my_cnf, $dsn{database});
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aab707f5c7077faf0b239e8c28d4ec624"></a><!-- doxytag: member="WeBWorK::Utils::CourseManagement::sql_single::unarchiveCourseHelper" ref="aab707f5c7077faf0b239e8c28d4ec624" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Utils::CourseManagement::sql_single::unarchiveCourseHelper </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-unarchiveCourseHelper' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-unarchiveCourseHelper-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-unarchiveCourseHelper-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-unarchiveCourseHelper-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in unarchiveCourseHelper: 21</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single.html#aab707f5c7077faf0b239e8c28d4ec624">unarchiveCourseHelper</a> {
    my ($courseID, $ce,  $dbLayoutName, %options) = @_;
    my $dumpfile_path = $options{unarchiveDatabasePath};
    
    my ($my_cnf, $database) = <a class="code" href="classWeBWorK_1_1Utils_1_1CourseManagement_1_1sql__single.html#aea9d76e285c980ec274f4cce0bfa1695">_get_db_info</a>($ce);
    my $mysql = $ce-&gt;{externalPrograms}{mysql};
    
    my $restore_cmd = <span class="stringliteral">&quot;2&gt;&amp;1 &quot;</span> . shell_quote($mysql)
        . <span class="stringliteral">&quot; --defaults-extra-file=&quot;</span> . shell_quote($my_cnf-&gt;filename)
        . <span class="stringliteral">&quot; &quot;</span> . shell_quote($database)
        . <span class="stringliteral">&quot; &lt; &quot;</span> . shell_quote($dumpfile_path);
    my $restore_out = readpipe $restore_cmd;
    <span class="keywordflow">if</span> ($?) {
        my $exit = $? &gt;&gt; 8;
        my $signal = $? &amp; 127;
        my $core = $? &amp; 128;
        die <span class="stringliteral">&quot;Failed to restore database for course &#39;$courseID&#39; with command &#39;$restore_cmd&#39; (exit=$exit signal=$signal core=$core): $restore_out\n&quot;</span>;
    }
    
    <span class="keywordflow">return</span> 1;
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1Utils_1_1CourseManagement.html#a885849d795b1ed78a5755453ebb72d51">WeBWorK::Utils::CourseManagement</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="sql__single_8pm_source.html">sql_single.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 23:00:15 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
