<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: ProblemSet.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>ProblemSet.pm</h1><a href="ProblemSet_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/ProblemSet.pm,v 1.94 2009/11/02 16:54:15 apizer Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::ProblemSet;
<a name="l00018"></a>00018 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator.html">WeBWorK::ContentGenerator</a>);
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 =head1 NAME
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1ProblemSet.html">00022</a> <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1ProblemSet.html">WeBWorK::ContentGenerator::ProblemSet</a> - display an index of the problems in a 
<a name="l00023"></a>00023 problem <span class="keyword">set</span>.
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 =cut
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 use strict;
<a name="l00028"></a>00028 use warnings;
<a name="l00029"></a>00029 <span class="preprocessor">#use CGI qw(-nosticky *ul *li);</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00031"></a>00031 use <a class="code" href="classWeBWorK_1_1PG.html">WeBWorK::PG</a>;
<a name="l00032"></a>00032 use URI::Escape;
<a name="l00033"></a>00033 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00034"></a>00034 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(sortByName path_is_subdir);
<a name="l00035"></a>00035 use <a class="code" href="classWeBWorK_1_1Localize.html">WeBWorK::Localize</a>;
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 sub initialize {
<a name="l00038"></a>00038     my ($self) = @_;
<a name="l00039"></a>00039     my $r = $self-&gt;r;
<a name="l00040"></a>00040     my $db = $r-&gt;db;
<a name="l00041"></a>00041     my $urlpath = $r-&gt;urlpath;
<a name="l00042"></a>00042     my $authz = $r-&gt;authz;
<a name="l00043"></a>00043     
<a name="l00044"></a>00044     my $setName = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l00045"></a>00045     my $userName = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00046"></a>00046     my $effectiveUserName = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>);
<a name="l00047"></a>00047     $self-&gt;{displayMode}  = $r-&gt;param(<span class="stringliteral">&#39;displayMode&#39;</span>) || $r-&gt;ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};
<a name="l00048"></a>00048     
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     my $user            = $db-&gt;getUser($userName); # checked
<a name="l00051"></a>00051     my $effectiveUser   = $db-&gt;getUser($effectiveUserName); # checked
<a name="l00052"></a>00052     my $set             = $db-&gt;getMergedSet($effectiveUserName, $setName); # checked
<a name="l00053"></a>00053     
<a name="l00054"></a>00054     die <span class="stringliteral">&quot;user $user (real user) not found.&quot;</span>  unless $user;
<a name="l00055"></a>00055     die <span class="stringliteral">&quot;effective user $effectiveUserName  not found. One &#39;acts as&#39; the effective user.&quot;</span>  unless $effectiveUser;
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">    # FIXME: some day it would be nice to take out this code and consolidate the two checks</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>    
<a name="l00059"></a>00059 <span class="preprocessor">    # get result and send to message</span>
<a name="l00060"></a>00060 <span class="preprocessor"></span>    my $status_message = $r-&gt;param(<span class="stringliteral">&quot;status_message&quot;</span>);
<a name="l00061"></a>00061     $self-&gt;addmessage(CGI::p(<span class="stringliteral">&quot;$status_message&quot;</span>)) <span class="keywordflow">if</span> $status_message;
<a name="l00062"></a>00062     
<a name="l00063"></a>00063 <span class="preprocessor">    # $self-&gt;{invalidSet} is set by ContentGenerator.pm</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{invalidSet};
<a name="l00065"></a>00065     <span class="keywordflow">return</span> unless defined($set);
<a name="l00066"></a>00066     
<a name="l00067"></a>00067 <span class="preprocessor">    # Database fix (in case of undefined visible values)</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">    # this is only necessary because some people keep holding to ww1.9 which did not have a visible field</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">    # make sure visible is set to 0 or 1</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span>
<a name="l00071"></a>00071     <span class="keywordflow">if</span> ($set-&gt;visible ne <span class="stringliteral">&quot;0&quot;</span> and $set-&gt;visible ne <span class="stringliteral">&quot;1&quot;</span>) {
<a name="l00072"></a>00072         my $globalSet = $db-&gt;getGlobalSet($set-&gt;set_id);
<a name="l00073"></a>00073         $globalSet-&gt;visible(<span class="stringliteral">&quot;1&quot;</span>);   # defaults to visible
<a name="l00074"></a>00074         $db-&gt;putGlobalSet($globalSet);
<a name="l00075"></a>00075         $set = $db-&gt;getMergedSet($effectiveUserName, $set-&gt;set_id);
<a name="l00076"></a>00076     }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="preprocessor">    # When a set is created enable_reduced_scoring is null, so we have to set it </span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($set-&gt;enable_reduced_scoring ne <span class="stringliteral">&quot;0&quot;</span> and $set-&gt;enable_reduced_scoring ne <span class="stringliteral">&quot;1&quot;</span>) {
<a name="l00080"></a>00080         my $globalSet = $db-&gt;getGlobalSet($set-&gt;set_id);
<a name="l00081"></a>00081         $globalSet-&gt;enable_reduced_scoring(<span class="stringliteral">&quot;0&quot;</span>);    # defaults to disabled
<a name="l00082"></a>00082         $db-&gt;putGlobalSet($globalSet);
<a name="l00083"></a>00083         $set = $db-&gt;getMergedSet($effectiveUserName, $set-&gt;set_id);
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     my $visiblityStateText = ($set-&gt;visible) ? $r-&gt;maketext(<span class="stringliteral">&quot;visible to students&quot;</span>).<span class="stringliteral">&quot;.&quot;</span> : $r-&gt;maketext(<span class="stringliteral">&quot;hidden from students&quot;</span>).<span class="stringliteral">&quot;.&quot;</span>;
<a name="l00087"></a>00087     my $visiblityStateClass = ($set-&gt;visible) ? <span class="stringliteral">&quot;visible&quot;</span> : <span class="stringliteral">&quot;hidden&quot;</span>;
<a name="l00088"></a>00088     $self-&gt;addmessage(CGI::span($r-&gt;maketext(<span class="stringliteral">&quot;This set is [_1]&quot;</span>, CGI::font({<span class="keyword">class</span>=&gt;$visiblityStateClass}, $visiblityStateText)))) <span class="keywordflow">if</span> $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;view_hidden_sets&quot;</span>);
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 
<a name="l00091"></a>00091     $self-&gt;{userName}        = $userName;
<a name="l00092"></a>00092     $self-&gt;{user}            = $user;
<a name="l00093"></a>00093     $self-&gt;{effectiveUser}   = $effectiveUser;
<a name="l00094"></a>00094     $self-&gt;{<span class="keyword">set</span>}             = $set;
<a name="l00095"></a>00095     
<a name="l00096"></a>00096 <span class="preprocessor">    ##### permissions #####</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>    
<a name="l00098"></a>00098     $self-&gt;{isOpen} = time &gt;= $set-&gt;open_date || $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;view_unopened_sets&quot;</span>);
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 sub nav {
<a name="l00102"></a>00102     my ($self, $args) = @_;
<a name="l00103"></a>00103     my $r = $self-&gt;r;
<a name="l00104"></a>00104     my $urlpath = $r-&gt;urlpath;
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00107"></a>00107 <span class="preprocessor">    #my $problemSetsPage = $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::ProblemSets&quot;,  $r, courseID =&gt; $courseID);</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>    my $problemSetsPage = $urlpath-&gt;parent;
<a name="l00109"></a>00109     
<a name="l00110"></a>00110     my @links = ($r-&gt;maketext(<span class="stringliteral">&quot;Homework Sets&quot;</span>) , $r-&gt;location . $problemSetsPage-&gt;path, $r-&gt;maketext(<span class="stringliteral">&quot;navUp&quot;</span>));
<a name="l00111"></a>00111 <span class="preprocessor">    # CRAP ALERT: this line relies on the hacky options() implementation in ContentGenerator.</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span><span class="preprocessor">    # we need to find a better way to do this -- long range dependencies like this are dangerous!</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span><span class="preprocessor">    #my $tail = &quot;&amp;displayMode=&quot;.$self-&gt;{displayMode}.&quot;&amp;showOldAnswers=&quot;.$self-&gt;{will}-&gt;{showOldAnswers};</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span><span class="preprocessor">    # here is a hack to get some functionality back, but I don&#39;t even think it&#39;s that important to</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span><span class="preprocessor">    # have this, since there are SO MANY PLACES where we lose the displayMode, etc.</span>
<a name="l00116"></a>00116 <span class="preprocessor"></span><span class="preprocessor">    # (oh boy, do we need a session table in the database!)</span>
<a name="l00117"></a>00117 <span class="preprocessor"></span>    my $displayMode = $r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>) || <span class="stringliteral">&quot;&quot;</span>;
<a name="l00118"></a>00118     my $showOldAnswers = $r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>) || <span class="stringliteral">&quot;&quot;</span>;
<a name="l00119"></a>00119     my $tail = <span class="stringliteral">&quot;&amp;displayMode=$displayMode&amp;showOldAnswers=$showOldAnswers&quot;</span>;
<a name="l00120"></a>00120     <span class="keywordflow">return</span> $self-&gt;navMacro($args, $tail, @links);
<a name="l00121"></a>00121 }
<a name="l00122"></a>00122 
<a name="l00123"></a>00123 sub siblings {
<a name="l00124"></a>00124     my ($self) = @_;
<a name="l00125"></a>00125     my $r = $self-&gt;r;
<a name="l00126"></a>00126     my $db = $r-&gt;db;
<a name="l00127"></a>00127     my $authz = $r-&gt;authz;
<a name="l00128"></a>00128     my $urlpath = $r-&gt;urlpath;
<a name="l00129"></a>00129     
<a name="l00130"></a>00130     
<a name="l00131"></a>00131     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00132"></a>00132     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00133"></a>00133     my $eUserID = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>);
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="preprocessor"># note that listUserSets does not list versioned sets</span>
<a name="l00136"></a>00136 <span class="preprocessor"></span><span class="preprocessor">    # DBFIXME do filtering in WHERE clause, use iterator for results :)</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>    my @setIDs = sortByName(undef, $db-&gt;listUserSets($eUserID));
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="preprocessor">    # do not show hidden siblings unless user is allowed to view hidden sets, and </span>
<a name="l00140"></a>00140 <span class="preprocessor"></span><span class="preprocessor">        # exclude gateway tests in all cases</span>
<a name="l00141"></a>00141 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_hidden_sets&quot;</span>) ) {
<a name="l00142"></a>00142         @setIDs    = grep {my $gs = $db-&gt;getGlobalSet( $_ ); 
<a name="l00143"></a>00143                    $gs-&gt;assignment_type() !~ /gateway/} @setIDs;
<a name="l00144"></a>00144 
<a name="l00145"></a>00145     } <span class="keywordflow">else</span> {
<a name="l00146"></a>00146         @setIDs    = grep {my $gs = $db-&gt;getGlobalSet( $_ ); 
<a name="l00147"></a>00147                             $gs-&gt;assignment_type() !~ /gateway/ &amp;&amp; 
<a name="l00148"></a>00148                             ( defined($gs-&gt;visible()) ? $gs-&gt;visible() : 1 )
<a name="l00149"></a>00149                            }   @setIDs;
<a name="l00150"></a>00150     }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152     print CGI::start_div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;info-box&quot;</span>, <span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;fisheye&quot;</span>});
<a name="l00153"></a>00153     print CGI::h2($r-&gt;maketext(<span class="stringliteral">&quot;Sets&quot;</span>));
<a name="l00154"></a>00154     print CGI::start_ul();
<a name="l00155"></a>00155 
<a name="l00156"></a>00156         debug(<span class="stringliteral">&quot;Begin printing sets from listUserSets()&quot;</span>);
<a name="l00157"></a>00157     <span class="keywordflow">foreach</span> my $setID (@setIDs) {
<a name="l00158"></a>00158         my $setPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::ProblemSet&quot;</span>, $r, 
<a name="l00159"></a>00159             courseID =&gt; $courseID, setID =&gt; $setID);
<a name="l00160"></a>00160         my $pretty_set_id = $setID;
<a name="l00161"></a>00161         $pretty_set_id =~ s/_/ /g;
<a name="l00162"></a>00162         print CGI::li(
<a name="l00163"></a>00163                  CGI::a({  href=&gt;$self-&gt;systemLink($setPage,
<a name="l00164"></a>00164                             params=&gt;{
<a name="l00165"></a>00165                                 displayMode    =&gt; $self-&gt;{displayMode}, 
<a name="l00166"></a>00166                                 showOldAnswers =&gt; $self-&gt;{will}-&gt;{showOldAnswers},
<a name="l00167"></a>00167                             },
<a name="l00168"></a>00168                         ),
<a name="l00169"></a>00169                         <span class="keywordtype">id</span>=&gt;$pretty_set_id,
<a name="l00170"></a>00170                       }, $pretty_set_id)
<a name="l00171"></a>00171               ) ;
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     debug(<span class="stringliteral">&quot;End printing sets from listUserSets()&quot;</span>);
<a name="l00174"></a>00174 
<a name="l00175"></a>00175 <span class="preprocessor">    # FIXME: when database calls are faster, this will get rid of hidden sibling links</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span><span class="preprocessor">    #debug(&quot;Begin printing sets from getMergedSets()&quot;); </span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="preprocessor">    #my @userSetIDs = map {[$eUserID, $_]} @setIDs;</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span><span class="preprocessor">    #my @sets = $db-&gt;getMergedSets(@userSetIDs);</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span><span class="preprocessor">    #foreach my $set (@sets) {</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="preprocessor">    #   my $setPage = $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::ProblemSet&quot;,  $r, courseID =&gt; $courseID, setID =&gt; $set-&gt;set_id);</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span><span class="preprocessor">    #   print CGI::li(CGI::a({href=&gt;$self-&gt;systemLink($setPage)}, $set-&gt;set_id)) unless !(defined $set &amp;&amp; ($set-&gt;published || $authz-&gt;hasPermissions($user, &quot;view_unpublished_sets&quot;));</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span><span class="preprocessor">    #}</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span><span class="preprocessor">    #debug(&quot;Begin printing sets from getMergedSets()&quot;);</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>    
<a name="l00185"></a>00185     print CGI::end_ul();
<a name="l00186"></a>00186 <span class="preprocessor">    #print CGI::end_li();</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span><span class="preprocessor">    #print CGI::end_ul();</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span>    print CGI::end_div();
<a name="l00189"></a>00189     
<a name="l00190"></a>00190     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 sub info {
<a name="l00194"></a>00194     my ($self) = @_;
<a name="l00195"></a>00195     my $r = $self-&gt;r;
<a name="l00196"></a>00196     my $ce = $r-&gt;ce;
<a name="l00197"></a>00197     my $db = $r-&gt;db;
<a name="l00198"></a>00198     my $authz = $r-&gt;authz;
<a name="l00199"></a>00199     my $urlpath = $r-&gt;urlpath;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> ( $self-&gt;{invalidSet} );
<a name="l00202"></a>00202     
<a name="l00203"></a>00203     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00204"></a>00204     my $setID = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     my $userID = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00207"></a>00207     my $eUserID = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>);
<a name="l00208"></a>00208     
<a name="l00209"></a>00209     my $effectiveUser = $db-&gt;getUser($eUserID); # checked 
<a name="l00210"></a>00210     my $set  = $db-&gt;getMergedSet($eUserID, $setID); # checked
<a name="l00211"></a>00211     
<a name="l00212"></a>00212     die <span class="stringliteral">&quot;effective user $eUserID not found. One &#39;acts as&#39; the effective user.&quot;</span> unless $effectiveUser;
<a name="l00213"></a>00213 <span class="preprocessor">    # FIXME: this was already caught in initialize()</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span>    die <span class="stringliteral">&quot;set $setID for effectiveUser $eUserID not found.&quot;</span> unless $set;
<a name="l00215"></a>00215     
<a name="l00216"></a>00216     my $psvn = $set-&gt;psvn();
<a name="l00217"></a>00217 <span class="preprocessor">    # hack to prevent errors from uninitialized set_headers.</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span>    $set-&gt;set_header(<span class="stringliteral">&quot;defaultHeader&quot;</span>) unless $set-&gt;set_header =~/\S/; # (some non-white space character required)
<a name="l00219"></a>00219     my $screenSetHeader = ($set-&gt;set_header eq <span class="stringliteral">&quot;defaultHeader&quot;</span>) ?
<a name="l00220"></a>00220           $ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{setHeader} :
<a name="l00221"></a>00221           $set-&gt;set_header;
<a name="l00222"></a>00222 
<a name="l00223"></a>00223     my $displayMode     = $r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>) || $ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};
<a name="l00224"></a>00224     
<a name="l00225"></a>00225     <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>)) {
<a name="l00226"></a>00226         <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&quot;editMode&quot;</span>) and $r-&gt;param(<span class="stringliteral">&quot;editMode&quot;</span>) eq <span class="stringliteral">&quot;temporaryFile&quot;</span>) {
<a name="l00227"></a>00227             $screenSetHeader = $r-&gt;param(<span class="stringliteral">&#39;sourceFilePath&#39;</span>);
<a name="l00228"></a>00228             $screenSetHeader = $ce-&gt;{courseDirs}{templates}.<span class="charliteral">&#39;/&#39;</span>.$screenSetHeader unless $screenSetHeader =~ m!^/!;
<a name="l00229"></a>00229             die <span class="stringliteral">&quot;sourceFilePath is unsafe!&quot;</span> unless path_is_subdir($screenSetHeader, $ce-&gt;{courseDirs}-&gt;{templates});
<a name="l00230"></a>00230             $self-&gt;addmessage(CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;temporaryFile&#39;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Viewing temporary file&quot;</span>).<span class="stringliteral">&quot;: &quot;</span>,
<a name="l00231"></a>00231                         $screenSetHeader));
<a name="l00232"></a>00232             $displayMode = $r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>) <span class="keywordflow">if</span> $r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>);
<a name="l00233"></a>00233         }
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235     
<a name="l00236"></a>00236     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless defined $screenSetHeader and $screenSetHeader;
<a name="l00237"></a>00237     
<a name="l00238"></a>00238 <span class="preprocessor">    # decide what to do about problem number</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span>    my $problem = <a class="code" href="classWeBWorK_1_1DB_1_1Record_1_1UserProblem.html">WeBWorK::DB::Record::UserProblem</a>-&gt;new(
<a name="l00240"></a>00240         problem_id =&gt; 0,
<a name="l00241"></a>00241         set_id =&gt; $set-&gt;set_id,
<a name="l00242"></a>00242         login_id =&gt; $effectiveUser-&gt;user_id,
<a name="l00243"></a>00243         source_file =&gt; $screenSetHeader,
<a name="l00244"></a>00244         # the rest of Problem<span class="stringliteral">&#39;s fields are not needed, i think</span>
<a name="l00245"></a>00245 <span class="stringliteral">    );</span>
<a name="l00246"></a>00246 <span class="stringliteral">    </span>
<a name="l00247"></a>00247 <span class="stringliteral">    my $pg = WeBWorK::PG-&gt;new(</span>
<a name="l00248"></a>00248 <span class="stringliteral">        $ce,</span>
<a name="l00249"></a>00249 <span class="stringliteral">        $effectiveUser,</span>
<a name="l00250"></a>00250 <span class="stringliteral">        $r-&gt;param(&#39;</span>key<span class="stringliteral">&#39;),</span>
<a name="l00251"></a>00251 <span class="stringliteral">        $set,</span>
<a name="l00252"></a>00252 <span class="stringliteral">        $problem,</span>
<a name="l00253"></a>00253 <span class="stringliteral">        $psvn,</span>
<a name="l00254"></a>00254 <span class="stringliteral">        {}, # no form fields!</span>
<a name="l00255"></a>00255 <span class="stringliteral">        { # translation options</span>
<a name="l00256"></a>00256 <span class="stringliteral">            displayMode     =&gt; $displayMode,</span>
<a name="l00257"></a>00257 <span class="stringliteral">            showHints       =&gt; 0,</span>
<a name="l00258"></a>00258 <span class="stringliteral">            showSolutions   =&gt; 0,</span>
<a name="l00259"></a>00259 <span class="stringliteral">            processAnswers  =&gt; 0,</span>
<a name="l00260"></a>00260 <span class="stringliteral">        },</span>
<a name="l00261"></a>00261 <span class="stringliteral">    );</span>
<a name="l00262"></a>00262 <span class="stringliteral">    </span>
<a name="l00263"></a>00263 <span class="stringliteral">    my $editorURL;</span>
<a name="l00264"></a>00264 <span class="stringliteral">    if (defined($set) and $authz-&gt;hasPermissions($userID, &quot;modify_problem_sets&quot;)) {  </span>
<a name="l00265"></a>00265 <span class="stringliteral">        my $editorPage = $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Instructor::PGProblemEditor&quot;, $r, </span>
<a name="l00266"></a>00266 <span class="stringliteral">            courseID =&gt; $courseID, setID =&gt; $set-&gt;set_id, problemID =&gt; 0);</span>
<a name="l00267"></a>00267 <span class="stringliteral">        $editorURL = $self-&gt;systemLink($editorPage, params =&gt; { file_type =&gt; &#39;</span>set_header<span class="stringliteral">&#39;});</span>
<a name="l00268"></a>00268 <span class="stringliteral">    }</span>
<a name="l00269"></a>00269 <span class="stringliteral">    </span>
<a name="l00270"></a>00270 <span class="stringliteral">    print CGI::start_div({class=&gt;&quot;info-box&quot;, id=&gt;&quot;InfoPanel&quot;});</span>
<a name="l00271"></a>00271 <span class="stringliteral">    </span>
<a name="l00272"></a>00272 <span class="stringliteral">    if ($editorURL) {</span>
<a name="l00273"></a>00273 <span class="stringliteral">        print CGI::h2({},$r-&gt;maketext(&quot;Set Info&quot;), CGI::a({href=&gt;$editorURL, target=&gt;&quot;WW_Editor&quot;}, $r-&gt;maketext(&quot;~[edit~]&quot;)));</span>
<a name="l00274"></a>00274 <span class="stringliteral">    } else {</span>
<a name="l00275"></a>00275 <span class="stringliteral">        print CGI::h2($r-&gt;maketext(&quot;Set Info&quot;));</span>
<a name="l00276"></a>00276 <span class="stringliteral">    }</span>
<a name="l00277"></a>00277 <span class="stringliteral">    </span>
<a name="l00278"></a>00278 <span class="stringliteral">    if ($pg-&gt;{flags}-&gt;{error_flag}) {</span>
<a name="l00279"></a>00279 <span class="stringliteral">        print CGI::div({class=&gt;&quot;ResultsWithError&quot;}, $self-&gt;errorOutput($pg-&gt;{errors}, $pg-&gt;{body_text}));</span>
<a name="l00280"></a>00280 <span class="stringliteral">    } else {</span>
<a name="l00281"></a>00281 <span class="stringliteral">        print $pg-&gt;{body_text};</span>
<a name="l00282"></a>00282 <span class="stringliteral">    }</span>
<a name="l00283"></a>00283 <span class="stringliteral">    </span>
<a name="l00284"></a>00284 <span class="stringliteral">    print CGI::end_div();</span>
<a name="l00285"></a>00285 <span class="stringliteral">    </span>
<a name="l00286"></a>00286 <span class="stringliteral">    return &quot;&quot;;</span>
<a name="l00287"></a>00287 <span class="stringliteral">}</span>
<a name="l00288"></a>00288 <span class="stringliteral"></span>
<a name="l00289"></a>00289 <span class="stringliteral">sub options { shift-&gt;optionsMacro }</span>
<a name="l00290"></a>00290 <span class="stringliteral"></span>
<a name="l00291"></a>00291 <span class="stringliteral">sub body {</span>
<a name="l00292"></a>00292 <span class="stringliteral">    my ($self) = @_;</span>
<a name="l00293"></a>00293 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00294"></a>00294 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00295"></a>00295 <span class="stringliteral">    my $db = $r-&gt;db;</span>
<a name="l00296"></a>00296 <span class="stringliteral">    my $urlpath = $r-&gt;urlpath;</span>
<a name="l00297"></a>00297 <span class="stringliteral"></span>
<a name="l00298"></a>00298 <span class="stringliteral">    my $courseID = $urlpath-&gt;arg(&quot;courseID&quot;);</span>
<a name="l00299"></a>00299 <span class="stringliteral">    my $setName = $urlpath-&gt;arg(&quot;setID&quot;);</span>
<a name="l00300"></a>00300 <span class="stringliteral">    my $effectiveUser = $r-&gt;param(&#39;</span>effectiveUser<span class="stringliteral">&#39;);</span>
<a name="l00301"></a>00301 <span class="stringliteral"></span>
<a name="l00302"></a>00302 <span class="stringliteral">    my $set = $db-&gt;getMergedSet($effectiveUser, $setName);  # checked</span>
<a name="l00303"></a>00303 <span class="stringliteral">    # FIXME: this was already caught in initialize()</span>
<a name="l00304"></a>00304 <span class="stringliteral">    # die &quot;set $setName for user $effectiveUser not found&quot; unless $set;</span>
<a name="l00305"></a>00305 <span class="stringliteral"></span>
<a name="l00306"></a>00306 <span class="stringliteral">    if ( $self-&gt;{invalidSet} ) { </span>
<a name="l00307"></a>00307 <span class="stringliteral">        return CGI::div({class=&gt;&quot;ResultsWithError&quot;},</span>
<a name="l00308"></a>00308 <span class="stringliteral">                CGI::p($r-&gt;maketext(&quot;The selected problem set ([_1]) is not a valid set for [_2]&quot;,$setName,$effectiveUser).&quot;:&quot;),</span>
<a name="l00309"></a>00309 <span class="stringliteral">                CGI::p($self-&gt;{invalidSet}));</span>
<a name="l00310"></a>00310 <span class="stringliteral">    }</span>
<a name="l00311"></a>00311 <span class="stringliteral">    </span>
<a name="l00312"></a>00312 <span class="stringliteral">    #my $hardcopyURL =</span>
<a name="l00313"></a>00313 <span class="stringliteral">    #   $ce-&gt;{webworkURLs}-&gt;{root} . &quot;/&quot;</span>
<a name="l00314"></a>00314 <span class="stringliteral">    #   . $ce-&gt;{courseName} . &quot;/&quot;</span>
<a name="l00315"></a>00315 <span class="stringliteral">    #   . &quot;hardcopy/$setName/?&quot; . $self-&gt;url_authen_args;</span>
<a name="l00316"></a>00316 <span class="stringliteral">    </span>
<a name="l00317"></a>00317 <span class="stringliteral">    my $hardcopyPage = $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Hardcopy&quot;, $r, </span>
<a name="l00318"></a>00318 <span class="stringliteral">        courseID =&gt; $courseID, setID =&gt; $setName);</span>
<a name="l00319"></a>00319 <span class="stringliteral">    my $hardcopyURL = $self-&gt;systemLink($hardcopyPage);</span>
<a name="l00320"></a>00320 <span class="stringliteral">    </span>
<a name="l00321"></a>00321 <span class="stringliteral">    # print CGI::div({-class=&gt;&quot;problem_set_options&quot;}, CGI::a({href=&gt;$hardcopyURL}, $r-&gt;maketext(&quot;Download PDF or TeX Hardcopy for Current Set&quot;)));</span>
<a name="l00322"></a>00322 <span class="stringliteral"></span>
<a name="l00323"></a>00323 <span class="stringliteral"></span>
<a name="l00324"></a>00324 <span class="stringliteral">    my $enable_reduced_scoring = $set-&gt;enable_reduced_scoring;</span>
<a name="l00325"></a>00325 <span class="stringliteral">    my $reducedScoringPeriod = $ce-&gt;{pg}-&gt;{ansEvalDefaults}-&gt;{reducedScoringPeriod};</span>
<a name="l00326"></a>00326 <span class="stringliteral">    if ($reducedScoringPeriod &gt; 0 and $enable_reduced_scoring) {</span>
<a name="l00327"></a>00327 <span class="stringliteral">        my $dueDate = $self-&gt;formatDateTime($set-&gt;due_date());</span>
<a name="l00328"></a>00328 <span class="stringliteral">        my $reducedScoringPeriodSec = $reducedScoringPeriod*60;   # $reducedScoringPeriod is in minutes</span>
<a name="l00329"></a>00329 <span class="stringliteral">        my $reducedScoringValue = $ce-&gt;{pg}-&gt;{ansEvalDefaults}-&gt;{reducedScoringValue};</span>
<a name="l00330"></a>00330 <span class="stringliteral">        my $reducedScoringPerCent = int(100*$reducedScoringValue+.5);</span>
<a name="l00331"></a>00331 <span class="stringliteral">        my $beginReducedScoringPeriod =  $self-&gt;formatDateTime($set-&gt;due_date() - $reducedScoringPeriodSec);</span>
<a name="l00332"></a>00332 <span class="stringliteral">        if (time &lt; $set-&gt;due_date()) {</span>
<a name="l00333"></a>00333 <span class="stringliteral">            print CGI::div({class=&gt;&quot;ResultsAlert&quot;},$r-&gt;maketext(&quot;_REDUCED_CREDIT_MESSAGE_1&quot;,$beginReducedScoringPeriod,$dueDate,$reducedScoringPerCent));</span>
<a name="l00334"></a>00334 <span class="stringliteral">        } else {</span>
<a name="l00335"></a>00335 <span class="stringliteral">            print CGI::div({class=&gt;&quot;ResultsAlert&quot;},$r-&gt;maketext(&quot;_REDUCED_CREDIT_MESSAGE_2&quot;,$beginReducedScoringPeriod,$dueDate,$reducedScoringPerCent));</span>
<a name="l00336"></a>00336 <span class="stringliteral">        }</span>
<a name="l00337"></a>00337 <span class="stringliteral">    }</span>
<a name="l00338"></a>00338 <span class="stringliteral">    </span>
<a name="l00339"></a>00339 <span class="stringliteral">    # DBFIXME use iterator</span>
<a name="l00340"></a>00340 <span class="stringliteral">    my @problemNumbers = WeBWorK::remove_duplicates($db-&gt;listUserProblems($effectiveUser, $setName));</span>
<a name="l00341"></a>00341 <span class="stringliteral">    </span>
<a name="l00342"></a>00342 <span class="stringliteral">    if (@problemNumbers) {</span>
<a name="l00343"></a>00343 <span class="stringliteral">        # UPDATE - ghe3</span>
<a name="l00344"></a>00344 <span class="stringliteral">        # This table now contains a summary, a caption, and scope variables for the columns.</span>
<a name="l00345"></a>00345 <span class="stringliteral">        print CGI::start_table({-summary=&gt;&quot;This table shows the problems that are in this problem set.  The columns from left to right are: name of the problem, current number of attempts made, number of attempts remaining, the point worth, and the completion status.  Click on the link on the name of the problem to take you to the problem page.&quot;, -class=&gt;&quot;problem_set_table&quot;});</span>
<a name="l00346"></a>00346 <span class="stringliteral">        print CGI::caption($r-&gt;maketext(&quot;Problems&quot;));</span>
<a name="l00347"></a>00347 <span class="stringliteral">        print CGI::Tr({},</span>
<a name="l00348"></a>00348 <span class="stringliteral"></span>
<a name="l00349"></a>00349 <span class="stringliteral">            CGI::th($r-&gt;maketext(&quot;Name&quot;)),</span>
<a name="l00350"></a>00350 <span class="stringliteral">            CGI::th($r-&gt;maketext(&quot;Attempts&quot;)),</span>
<a name="l00351"></a>00351 <span class="stringliteral">            CGI::th($r-&gt;maketext(&quot;Remaining&quot;)),</span>
<a name="l00352"></a>00352 <span class="stringliteral">            CGI::th($r-&gt;maketext(&quot;Worth&quot;)),</span>
<a name="l00353"></a>00353 <span class="stringliteral">            CGI::th($r-&gt;maketext(&quot;Status&quot;)),</span>
<a name="l00354"></a>00354 <span class="stringliteral"></span>
<a name="l00355"></a>00355 <span class="stringliteral">        );</span>
<a name="l00356"></a>00356 <span class="stringliteral">        </span>
<a name="l00357"></a>00357 <span class="stringliteral">        foreach my $problemNumber (sort { $a &lt;=&gt; $b } @problemNumbers) {</span>
<a name="l00358"></a>00358 <span class="stringliteral">            my $problem = $db-&gt;getMergedProblem($effectiveUser, $setName, $problemNumber); # checked</span>
<a name="l00359"></a>00359 <span class="stringliteral">            die &quot;problem $problemNumber in set $setName for user $effectiveUser not found.&quot; unless $problem;</span>
<a name="l00360"></a>00360 <span class="stringliteral">            print $self-&gt;problemListRow($set, $problem);</span>
<a name="l00361"></a>00361 <span class="stringliteral">        }</span>
<a name="l00362"></a>00362 <span class="stringliteral">        </span>
<a name="l00363"></a>00363 <span class="stringliteral">        print CGI::end_table();</span>
<a name="l00364"></a>00364 <span class="stringliteral">    } else {</span>
<a name="l00365"></a>00365 <span class="stringliteral">        print CGI::p($r-&gt;maketext(&quot;This homework set contains no problems.&quot;));</span>
<a name="l00366"></a>00366 <span class="stringliteral">    }</span>
<a name="l00367"></a>00367 <span class="stringliteral">    </span>
<a name="l00368"></a>00368 <span class="stringliteral">    ## feedback form url</span>
<a name="l00369"></a>00369 <span class="stringliteral">    #my $feedbackPage = $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Feedback&quot;, $r, </span>
<a name="l00370"></a>00370 <span class="stringliteral">    #   courseID =&gt; $courseID);</span>
<a name="l00371"></a>00371 <span class="stringliteral">    #my $feedbackURL = $self-&gt;systemLink($feedbackPage, authen =&gt; 0); # no authen info for form action</span>
<a name="l00372"></a>00372 <span class="stringliteral">    #</span>
<a name="l00373"></a>00373 <span class="stringliteral">    ##print feedback form</span>
<a name="l00374"></a>00374 <span class="stringliteral">    #print</span>
<a name="l00375"></a>00375 <span class="stringliteral">    #   CGI::start_form(-method=&gt;&quot;POST&quot;, -action=&gt;$feedbackURL),&quot;\n&quot;,</span>
<a name="l00376"></a>00376 <span class="stringliteral">    #   $self-&gt;hidden_authen_fields,&quot;\n&quot;,</span>
<a name="l00377"></a>00377 <span class="stringliteral">    #   CGI::hidden(&quot;module&quot;,             __PACKAGE__),&quot;\n&quot;,</span>
<a name="l00378"></a>00378 <span class="stringliteral">    #   CGI::hidden(&quot;set&quot;,                $self-&gt;{set}-&gt;set_id),&quot;\n&quot;,</span>
<a name="l00379"></a>00379 <span class="stringliteral">    #   CGI::hidden(&quot;problem&quot;,            &#39;</span><span class="stringliteral">&#39;),&quot;\n&quot;,</span>
<a name="l00380"></a>00380 <span class="stringliteral">    #   CGI::hidden(&quot;displayMode&quot;,        $self-&gt;{displayMode}),&quot;\n&quot;,</span>
<a name="l00381"></a>00381 <span class="stringliteral">    #   CGI::hidden(&quot;showOldAnswers&quot;,     &#39;</span><span class="stringliteral">&#39;),&quot;\n&quot;,</span>
<a name="l00382"></a>00382 <span class="stringliteral">    #   CGI::hidden(&quot;showCorrectAnswers&quot;, &#39;</span><span class="stringliteral">&#39;),&quot;\n&quot;,</span>
<a name="l00383"></a>00383 <span class="stringliteral">    #   CGI::hidden(&quot;showHints&quot;,          &#39;</span><span class="stringliteral">&#39;),&quot;\n&quot;,</span>
<a name="l00384"></a>00384 <span class="stringliteral">    #   CGI::hidden(&quot;showSolutions&quot;,      &#39;</span><span class="stringliteral">&#39;),&quot;\n&quot;,</span>
<a name="l00385"></a>00385 <span class="stringliteral">    #   CGI::p({-align=&gt;&quot;left&quot;},</span>
<a name="l00386"></a>00386 <span class="stringliteral">    #       CGI::submit(-name=&gt;&quot;feedbackForm&quot;, -label=&gt;&quot;Email instructor&quot;)</span>
<a name="l00387"></a>00387 <span class="stringliteral">    #   ),</span>
<a name="l00388"></a>00388 <span class="stringliteral">    #   CGI::endform(),&quot;\n&quot;;</span>
<a name="l00389"></a>00389 <span class="stringliteral">    </span>
<a name="l00390"></a>00390 <span class="stringliteral">    print CGI::start_div({-class=&gt;&quot;problem_set_options&quot;});</span>
<a name="l00391"></a>00391 <span class="stringliteral">    print $self-&gt;feedbackMacro(</span>
<a name="l00392"></a>00392 <span class="stringliteral">        module =&gt; __PACKAGE__,</span>
<a name="l00393"></a>00393 <span class="stringliteral">        set =&gt; $self-&gt;{set}-&gt;set_id,</span>
<a name="l00394"></a>00394 <span class="stringliteral">        problem =&gt; &quot;&quot;,</span>
<a name="l00395"></a>00395 <span class="stringliteral">        displayMode =&gt; $self-&gt;{displayMode},</span>
<a name="l00396"></a>00396 <span class="stringliteral">        showOldAnswers =&gt; &quot;&quot;,</span>
<a name="l00397"></a>00397 <span class="stringliteral">        showCorrectAnswers =&gt; &quot;&quot;,</span>
<a name="l00398"></a>00398 <span class="stringliteral">        showHints =&gt; &quot;&quot;,</span>
<a name="l00399"></a>00399 <span class="stringliteral">        showSolutions =&gt; &quot;&quot;,</span>
<a name="l00400"></a>00400 <span class="stringliteral">    );</span>
<a name="l00401"></a>00401 <span class="stringliteral">    print CGI::end_div();</span>
<a name="l00402"></a>00402 <span class="stringliteral">    </span>
<a name="l00403"></a>00403 <span class="stringliteral">    print CGI::div({-class=&gt;&quot;problem_set_options&quot;}, CGI::a({href=&gt;$hardcopyURL}, $r-&gt;maketext(&quot;Download PDF or TeX Hardcopy for Current Set&quot;))).CGI::br();</span>
<a name="l00404"></a>00404 <span class="stringliteral">    </span>
<a name="l00405"></a>00405 <span class="stringliteral">    return &quot;&quot;;</span>
<a name="l00406"></a>00406 <span class="stringliteral">}</span>
<a name="l00407"></a>00407 <span class="stringliteral"></span>
<a name="l00408"></a>00408 <span class="stringliteral">sub problemListRow($$$) {</span>
<a name="l00409"></a>00409 <span class="stringliteral">    my ($self, $set, $problem) = @_;</span>
<a name="l00410"></a>00410 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00411"></a>00411 <span class="stringliteral">    my $urlpath = $r-&gt;urlpath;</span>
<a name="l00412"></a>00412 <span class="stringliteral">    </span>
<a name="l00413"></a>00413 <span class="stringliteral">    my $courseID = $urlpath-&gt;arg(&quot;courseID&quot;);</span>
<a name="l00414"></a>00414 <span class="stringliteral">    my $setID = $set-&gt;set_id;</span>
<a name="l00415"></a>00415 <span class="stringliteral">    my $problemID = $problem-&gt;problem_id;</span>
<a name="l00416"></a>00416 <span class="stringliteral">    </span>
<a name="l00417"></a>00417 <span class="stringliteral">    my $interactiveURL = $self-&gt;systemLink(</span>
<a name="l00418"></a>00418 <span class="stringliteral">        $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Problem&quot;, $r, </span>
<a name="l00419"></a>00419 <span class="stringliteral">            courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt; $problemID</span>
<a name="l00420"></a>00420 <span class="stringliteral">        ),</span>
<a name="l00421"></a>00421 <span class="stringliteral">        params=&gt;{  displayMode =&gt; $self-&gt;{displayMode}, </span>
<a name="l00422"></a>00422 <span class="stringliteral">                   showOldAnswers =&gt; $self-&gt;{will}-&gt;{showOldAnswers}</span>
<a name="l00423"></a>00423 <span class="stringliteral">        }</span>
<a name="l00424"></a>00424 <span class="stringliteral">    );</span>
<a name="l00425"></a>00425 <span class="stringliteral">    </span>
<a name="l00426"></a>00426 <span class="stringliteral">    my $interactive = CGI::a({-href=&gt;$interactiveURL}, $r-&gt;maketext(&quot;Problem [_1]&quot;,$problemID));</span>
<a name="l00427"></a>00427 <span class="stringliteral">    my $attempts = $problem-&gt;num_correct + $problem-&gt;num_incorrect;</span>
<a name="l00428"></a>00428 <span class="stringliteral">    my $remaining = (($problem-&gt;max_attempts||-1) &lt; 0) #a blank yields &#39;</span>infinite<span class="stringliteral">&#39; because it evaluates as false with out giving warnings about comparing non-numbers</span>
<a name="l00429"></a>00429 <span class="stringliteral">        ? $r-&gt;maketext(&quot;unlimited&quot;)</span>
<a name="l00430"></a>00430 <span class="stringliteral">        : $problem-&gt;max_attempts - $attempts;</span>
<a name="l00431"></a>00431 <span class="stringliteral">    my $rawStatus = $problem-&gt;status || 0;</span>
<a name="l00432"></a>00432 <span class="stringliteral">    my $status;</span>
<a name="l00433"></a>00433 <span class="stringliteral">    $status = eval{ sprintf(&quot;%.0f%%&quot;, $rawStatus * 100)}; # round to whole number</span>
<a name="l00434"></a>00434 <span class="stringliteral">    $status = &#39;</span>unknown(FIXME)<span class="stringliteral">&#39; if $@; # use a blank if problem status was not defined or not numeric.</span>
<a name="l00435"></a>00435 <span class="stringliteral">                                      # FIXME  -- this may not cover all cases.</span>
<a name="l00436"></a>00436 <span class="stringliteral">    </span>
<a name="l00437"></a>00437 <span class="stringliteral">#   my $msg = ($problem-&gt;value) ? &quot;&quot; : &quot;(This problem will not count towards your grade.)&quot;;</span>
<a name="l00438"></a>00438 <span class="stringliteral">    </span>
<a name="l00439"></a>00439 <span class="stringliteral">    return CGI::Tr({},</span>
<a name="l00440"></a>00440 <span class="stringliteral">        CGI::td({-nowrap=&gt;1, -align=&gt;&quot;left&quot;},$interactive),</span>
<a name="l00441"></a>00441 <span class="stringliteral">        CGI::td({-nowrap=&gt;1, -align=&gt;&quot;center&quot;},</span>
<a name="l00442"></a>00442 <span class="stringliteral">            [</span>
<a name="l00443"></a>00443 <span class="stringliteral">                $attempts,</span>
<a name="l00444"></a>00444 <span class="stringliteral">                $remaining,</span>
<a name="l00445"></a>00445 <span class="stringliteral">                $problem-&gt;value,</span>
<a name="l00446"></a>00446 <span class="stringliteral">                $status,</span>
<a name="l00447"></a>00447 <span class="stringliteral">            ]));</span>
<a name="l00448"></a>00448 <span class="stringliteral">}</span>
<a name="l00449"></a>00449 <span class="stringliteral"></span>
<a name="l00450"></a>00450 <span class="stringliteral">1;</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:35 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
