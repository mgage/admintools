<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: ContentGenerator.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>ContentGenerator.pm</h1><a href="ContentGenerator_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright Â© 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator.pm,v 1.196 2009/06/04 01:33:15 gage Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator;
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 =head1 NAME
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <a class="code" href="classWeBWorK_1_1ContentGenerator.html">WeBWorK::ContentGenerator</a> - base <span class="keyword">class </span>for modules that generate page content.
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 =head1 SYNOPSIS
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 <span class="preprocessor"> # start with a WeBWorK::Request object: $r</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span> 
<a name="l00027"></a>00027  use WeBWorK::ContentGenerator::SomeSubclass;
<a name="l00028"></a>00028  
<a name="l00029"></a>00029  my $cg = WeBWorK::ContentGenerator::SomeSubclass-&gt;new($r);
<a name="l00030"></a>00030  my $result = $cg-&gt;go();
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 =head1 DESCRIPTION
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <a class="code" href="classWeBWorK_1_1ContentGenerator.html">WeBWorK::ContentGenerator</a> provides the framework <span class="keywordflow">for</span> generating page content.
<a name="l00035"></a>00035 <span class="stringliteral">&quot;Content generators&quot;</span> are subclasses of <span class="keyword">this</span> <span class="keyword">class </span>which provide content for
<a name="l00036"></a>00036 particular parts of the system.
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 Default versions of methods used by the templating system are provided. Several
<a name="l00039"></a>00039 useful methods are provided for rendering common output idioms and some
<a name="l00040"></a>00040 miscellaneous utilities are provided.
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 =cut
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 use strict;
<a name="l00045"></a>00045 use warnings;
<a name="l00046"></a>00046 use Carp;
<a name="l00047"></a>00047 <span class="preprocessor">#use CGI qw(-nosticky *ul *li escapeHTML);</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00049"></a>00049 use WeBWorK::File::Scoring qw/parse_scoring_file/;
<a name="l00050"></a>00050 use Date::Format;
<a name="l00051"></a>00051 use URI::Escape;
<a name="l00052"></a>00052 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00053"></a>00053 use <a class="code" href="classWeBWorK_1_1PG.html">WeBWorK::PG</a>;
<a name="l00054"></a>00054 use MIME::Base64;
<a name="l00055"></a>00055 use <a class="code" href="classWeBWorK_1_1Template.html">WeBWorK::Template</a> qw(<span class="keyword">template</span>);
<a name="l00056"></a>00056 use <a class="code" href="classWeBWorK_1_1Localize.html">WeBWorK::Localize</a>;
<a name="l00057"></a>00057 use mod_perl;
<a name="l00058"></a>00058 use constant MP2 =&gt; ( exists $ENV{MOD_PERL_API_VERSION} and $ENV{MOD_PERL_API_VERSION} &gt;= 2 );
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 BEGIN {
<a name="l00064"></a>00064     <span class="keywordflow">if</span> (MP2) {
<a name="l00065"></a>00065         require Apache2::Const;
<a name="l00066"></a>00066         Apache2::Const-&gt;import(-compile =&gt; qw/OK NOT_FOUND FORBIDDEN SERVER_ERROR REDIRECT/);
<a name="l00067"></a>00067     } <span class="keywordflow">else</span> {
<a name="l00068"></a>00068         require Apache::Constants;
<a name="l00069"></a>00069         Apache::Constants-&gt;import(qw/OK NOT_FOUND FORBIDDEN SERVER_ERROR REDIRECT/);
<a name="l00070"></a>00070     }
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="preprocessor">###############################################################################</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>
<a name="l00075"></a>00075 =head1 CONSTRUCTOR
<a name="l00076"></a>00076 
<a name="l00077"></a>00077 =over
<a name="l00078"></a>00078 
<a name="l00079"></a>00079 =item <span class="keyword">new</span>($r)
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 Creates a <span class="keyword">new</span> instance of a content generator. Supply a <a class="code" href="classWeBWorK_1_1Request.html">WeBWorK::Request</a> <span class="keywordtype">object</span>
<a name="l00082"></a>00082 $r.
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 =cut
<a name="l00085"></a>00085 
<a name="l00086"></a>00086 sub <span class="keyword">new</span> {
<a name="l00087"></a>00087     my ($invocant, $r) = @_;
<a name="l00088"></a>00088     my $class = ref($invocant) || $invocant;
<a name="l00089"></a>00089     my $self = {
<a name="l00090"></a>00090         r =&gt; $r, # <span class="keyword">this</span> is now a <a class="code" href="classWeBWorK_1_1Request.html">WeBWorK::Request</a>
<a name="l00091"></a>00091         ce =&gt; $r-&gt;ce(),       # these three are here <span class="keywordflow">for</span>
<a name="l00092"></a>00092         db =&gt; $r-&gt;db(),       # backward-compatability
<a name="l00093"></a>00093         authz =&gt; $r-&gt;authz(), # with unconverted CGs
<a name="l00094"></a>00094         noContent =&gt; undef, # FIXME <span class="keyword">this</span> should <span class="keyword">get</span> clobbered at some point
<a name="l00095"></a>00095     };
<a name="l00096"></a>00096     bless $self, $class;
<a name="l00097"></a>00097     <span class="keywordflow">return</span> $self;
<a name="l00098"></a>00098 }
<a name="l00099"></a>00099 
<a name="l00100"></a>00100 =back
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 =cut
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 <span class="preprocessor">################################################################################</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span>
<a name="l00106"></a>00106 =head1 INVOCATION
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 =over
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 =item go()
<a name="l00111"></a>00111 
<a name="l00112"></a>00112 Generates a page, using methods from the particular subclass of ContentGenerator
<a name="l00113"></a>00113 that is instantiated. Generatoion is broken up into several steps, to give
<a name="l00114"></a>00114 subclasses ample control over the process.
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 =over
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 =item 1
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 go() will attempt to call the method pre_header_initialize(). This method may be
<a name="l00121"></a>00121 implemented in subclasses which must do processing before the HTTP header is
<a name="l00122"></a>00122 emitted.
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 =item 2
<a name="l00125"></a>00125 
<a name="l00126"></a>00126 go() will attempt to call the method header(). This method emits the HTTP
<a name="l00127"></a>00127 header. It is defined in this class (see below), but may be overridden in
<a name="l00128"></a>00128 subclasses which need to send different header information. For some reason, the
<a name="l00129"></a>00129 return value of header() will be used as the result of this function, if it is
<a name="l00130"></a>00130 defined.
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 FIXME: figure out what the deal is with the return value of header(). If we sent
<a name="l00133"></a>00133 a header, it&#39;s too late to set the status by returning. If we didn&#39;t, header()
<a name="l00134"></a>00134 didn&#39;t perform its function!
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 =item 3
<a name="l00137"></a>00137 
<a name="l00138"></a>00138 At this point, go() will terminate if the request is a HEAD request or if the
<a name="l00139"></a>00139 field $self-&gt;{noContent} contains a <span class="keyword">true</span> value.
<a name="l00140"></a>00140 
<a name="l00141"></a>00141 FIXME: I don<span class="stringliteral">&#39;t think we&#39;</span>ll need noContent after reply_with_redirect() is
<a name="l00142"></a>00142 adopted by all modules.
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 =item 4
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 go() then attempts to call the method initialize(). This method may be
<a name="l00147"></a>00147 implemented in subclasses which must do processing after the HTTP header is sent
<a name="l00148"></a>00148 but before any content is sent.
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 =item 6
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 The method content() is called to send the page content to client.
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 =back
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 =cut
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 sub go {
<a name="l00159"></a>00159     my ($self) = @_;
<a name="l00160"></a>00160     my $r = $self-&gt;r;
<a name="l00161"></a>00161     my $ce = $r-&gt;ce;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="preprocessor">    # check to verify if there are set-level problems with running</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span><span class="preprocessor">    #    this content generator (individual content generators must</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span><span class="preprocessor">    #    check $self-&gt;{invalidSet} and react correctly)</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>    my $authz = $r-&gt;authz;
<a name="l00167"></a>00167     $self-&gt;{invalidSet} = $authz-&gt;checkSet();
<a name="l00168"></a>00168     
<a name="l00169"></a>00169     my $returnValue = MP2 ? Apache2::Const::OK : Apache::Constants::OK;
<a name="l00170"></a>00170     
<a name="l00171"></a>00171 <span class="preprocessor">    # We only write to the activity log if it has been defined and if</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span><span class="preprocessor">    # we are in a specific course.  The latter check is to prevent attempts</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span><span class="preprocessor">    # to write to a course log file when viewing the top-level list of</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span><span class="preprocessor">    # courses page.</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span>    <a class="code" href="classWeBWorK_1_1Utils.html#a4f5080514ceba779811c23bceafce5b0">WeBWorK::Utils::writeCourseLog</a>($ce, <span class="stringliteral">&#39;activity_log&#39;</span>,
<a name="l00176"></a>00176         $self-&gt;prepare_activity_entry) if ( $r-&gt;urlpath-&gt;arg(&quot;courseID&quot;) and
<a name="l00177"></a>00177             $r-&gt;ce-&gt;{courseFiles}-&gt;{logs}-&gt;{activity_log});
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     $self-&gt;pre_header_initialize(@_) <span class="keywordflow">if</span> $self-&gt;can(<span class="stringliteral">&quot;pre_header_initialize&quot;</span>);
<a name="l00180"></a>00180     
<a name="l00181"></a>00181 <span class="preprocessor">    # send a file instead of a normal reply (reply_with_file() sets this field)</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>    defined $self-&gt;{reply_with_file} and <span class="keywordflow">do</span> {
<a name="l00183"></a>00183         <span class="keywordflow">return</span> $self-&gt;do_reply_with_file($self-&gt;{reply_with_file});
<a name="l00184"></a>00184     };
<a name="l00185"></a>00185     
<a name="l00186"></a>00186 <span class="preprocessor">    # send a Location: header instead of a normal reply (reply_with_redirect() sets this field)</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>    defined $self-&gt;{reply_with_redirect} and <span class="keywordflow">do</span> {
<a name="l00188"></a>00188         <span class="keywordflow">return</span> $self-&gt;do_reply_with_redirect($self-&gt;{reply_with_redirect});
<a name="l00189"></a>00189     };
<a name="l00190"></a>00190     
<a name="l00191"></a>00191     my $headerReturn = $self-&gt;header(@_);
<a name="l00192"></a>00192     $returnValue = $headerReturn <span class="keywordflow">if</span> defined $headerReturn;
<a name="l00193"></a>00193 <span class="preprocessor">    # FIXME: we won&#39;t need noContent after reply_with_redirect() is adopted</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>    <span class="keywordflow">return</span> $returnValue <span class="keywordflow">if</span> $r-&gt;header_only or $self-&gt;{noContent};
<a name="l00195"></a>00195     
<a name="l00196"></a>00196     $self-&gt;initialize() <span class="keywordflow">if</span> $self-&gt;can(<span class="stringliteral">&quot;initialize&quot;</span>);
<a name="l00197"></a>00197     
<a name="l00198"></a>00198     $self-&gt;content();
<a name="l00199"></a>00199     
<a name="l00200"></a>00200     <span class="keywordflow">return</span> $returnValue;
<a name="l00201"></a>00201 }
<a name="l00202"></a>00202 
<a name="l00203"></a>00203 =item r()
<a name="l00204"></a>00204 
<a name="l00205"></a>00205 Returns a reference to the <a class="code" href="classWeBWorK.html">WeBWorK</a>::Request <span class="keywordtype">object</span> associated with this
<a name="l00206"></a>00206 instance.
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 =cut
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 sub r {
<a name="l00211"></a>00211     my ($self) = @_;
<a name="l00212"></a>00212     
<a name="l00213"></a>00213     <span class="keywordflow">return</span> $self-&gt;{r};
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 =item do_reply_with_file($fileHash)
<a name="l00217"></a>00217 
<a name="l00218"></a>00218 Handler for reply_with_file(), used by go(). DO NOT CALL THIS METHOD DIRECTLY.
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 =cut
<a name="l00221"></a>00221 
<a name="l00222"></a>00222 sub do_reply_with_file {
<a name="l00223"></a>00223     my ($self, $fileHash) = @_;
<a name="l00224"></a>00224     my $r = $self-&gt;r;
<a name="l00225"></a>00225     
<a name="l00226"></a>00226     my $type = $fileHash-&gt;{type};
<a name="l00227"></a>00227     my $source = $fileHash-&gt;{source};
<a name="l00228"></a>00228     my $name = $fileHash-&gt;{name};
<a name="l00229"></a>00229     my $delete_after = $fileHash-&gt;{delete_after};
<a name="l00230"></a>00230     
<a name="l00231"></a>00231 <span class="preprocessor">    # if there was a problem, we return here and let go() worry about sending the reply</span>
<a name="l00232"></a>00232 <span class="preprocessor"></span>    <span class="keywordflow">return</span> MP2 ? Apache2::Const::NOT_FOUND : Apache::Constants::NOT_FOUND unless -e $source;
<a name="l00233"></a>00233     <span class="keywordflow">return</span> MP2 ? Apache2::Const::FORBIDDEN : Apache::Constants::FORBIDDEN unless -r $source;
<a name="l00234"></a>00234     
<a name="l00235"></a>00235     my $fh;
<a name="l00236"></a>00236     <span class="keywordflow">if</span> (!MP2) {
<a name="l00237"></a>00237 <span class="preprocessor">        # open the file now, so we can send the proper error status is we fail</span>
<a name="l00238"></a>00238 <span class="preprocessor"></span>        open $fh, <span class="stringliteral">&quot;&lt;&quot;</span>, $source or <span class="keywordflow">return</span> Apache::Constants::SERVER_ERROR;
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240     
<a name="l00241"></a>00241 <span class="preprocessor">    # send our custom HTTP header</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span>    $r-&gt;content_type($type);
<a name="l00243"></a>00243     $r-&gt;headers_out-&gt;{<span class="stringliteral">&quot;Content-Disposition&quot;</span>} = <span class="stringliteral">&quot;attachment; filename=\&quot;$name\&quot;&quot;</span>;
<a name="l00244"></a>00244     $r-&gt;send_http_header unless MP2;
<a name="l00245"></a>00245     
<a name="l00246"></a>00246 <span class="preprocessor">    # send the file</span>
<a name="l00247"></a>00247 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MP2) {
<a name="l00248"></a>00248         $r-&gt;sendfile($source);
<a name="l00249"></a>00249     } <span class="keywordflow">else</span> {
<a name="l00250"></a>00250         $r-&gt;send_fd($fh);
<a name="l00251"></a>00251     }
<a name="l00252"></a>00252     
<a name="l00253"></a>00253     <span class="keywordflow">if</span> (!MP2) {
<a name="l00254"></a>00254 <span class="preprocessor">        # close the file and go home</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span>        close $fh;
<a name="l00256"></a>00256     }
<a name="l00257"></a>00257     
<a name="l00258"></a>00258     <span class="keywordflow">if</span> ($delete_after) {
<a name="l00259"></a>00259         unlink $source or warn <span class="stringliteral">&quot;failed to unlink $source after sending: $!&quot;</span>;
<a name="l00260"></a>00260     }
<a name="l00261"></a>00261     
<a name="l00262"></a>00262     <span class="keywordflow">return</span>; # (see comment on <span class="keywordflow">return</span> statement in do_reply_with_redirect, below.)
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00265"></a>00265 =item do_reply_with_redirect($url)
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 Handler for reply_with_redirect(), used by go(). DO NOT CALL THIS METHOD DIRECTLY.
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 =cut
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 sub do_reply_with_redirect {
<a name="l00272"></a>00272     my ($self, $url) = @_;
<a name="l00273"></a>00273     my $r = $self-&gt;r;
<a name="l00274"></a>00274     
<a name="l00275"></a>00275     $r-&gt;status(MP2 ? Apache2::Const::REDIRECT : Apache::Constants::REDIRECT);
<a name="l00276"></a>00276     $r-&gt;headers_out-&gt;{<span class="stringliteral">&quot;Location&quot;</span>} = $url;
<a name="l00277"></a>00277     $r-&gt;send_http_header unless MP2;
<a name="l00278"></a>00278     
<a name="l00279"></a>00279     <span class="keywordflow">return</span>; # we need to explicitly <span class="keywordflow">return</span> noting here, otherwise we <span class="keywordflow">return</span> $url under Apache2.
<a name="l00280"></a>00280             # the <span class="keywordflow">return</span> value from the mod_perl handler is used to <span class="keyword">set</span> the HTTP status code,
<a name="l00281"></a>00281 <span class="preprocessor">            # but we&#39;re setting it explicitly above. i think we should dispense with setting it</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">            # with the return value altogether, and always do it with $r-&gt;status. the other way</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span><span class="preprocessor">            # is too oblique and error-prone. this is probably a FIXME.</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span><span class="preprocessor">            # </span>
<a name="l00285"></a>00285 <span class="preprocessor"></span><span class="preprocessor">            # Apache::WeBWorK::handler always returns the value it got from WeBWorK::dispatch</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span><span class="preprocessor">            # WeBWorK::dispatch always returns the value it got from WW::ContentGenerator::go</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span><span class="preprocessor">            # WW::ContentGenerator::go works like this:</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span><span class="preprocessor">            #       - if reply_with_file, return the return value from do_reply_with_file</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span><span class="preprocessor">            #         (do_reply_with_file actually uses this to return NOT_FOUND/FORBIDDEN)</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span><span class="preprocessor">            #       - if reply_with_redirect, return the return value from do_reply_with_redirect</span>
<a name="l00291"></a>00291 <span class="preprocessor"></span><span class="preprocessor">            #         (do_reply_with_redirect does NOT use this -- it sets $r-&gt;status instead!)</span>
<a name="l00292"></a>00292 <span class="preprocessor"></span><span class="preprocessor">            #       - if header returns a defined value, return that</span>
<a name="l00293"></a>00293 <span class="preprocessor"></span><span class="preprocessor">            #         (CG::header always returns OK!)</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span><span class="preprocessor">            #       - otherwise, return OK (this never happens!)</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span><span class="preprocessor">            # there are no longer any legitimate header() methods other than the one in CG.pm</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span>}
<a name="l00297"></a>00297 
<a name="l00298"></a>00298 =back
<a name="l00299"></a>00299 
<a name="l00300"></a>00300 =cut
<a name="l00301"></a>00301 
<a name="l00302"></a>00302 <span class="preprocessor">################################################################################</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span>
<a name="l00304"></a>00304 =head1 DATA MODIFIERS
<a name="l00305"></a>00305 
<a name="l00306"></a>00306 Modifiers allow the caller to <span class="keyword">register</span> a piece of data <span class="keywordflow">for</span> later retrieval in a
<a name="l00307"></a>00307 standard way.
<a name="l00308"></a>00308 
<a name="l00309"></a>00309 =over
<a name="l00310"></a>00310 
<a name="l00311"></a>00311 =item reply_with_file($type, $source, $name, $delete_after)
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 Enables file sending mode, causing go() to send the file specified by $source to
<a name="l00314"></a>00314 the client after calling pre_header_initialize(). The content type sent is
<a name="l00315"></a>00315 $type, and the suggested client-side file name is $name. If $delete_after is
<a name="l00316"></a>00316 true, $source is deleted after it is sent.
<a name="l00317"></a>00317 
<a name="l00318"></a>00318 Must be called before the HTTP header is sent. Usually called from
<a name="l00319"></a>00319 pre_header_initialize().
<a name="l00320"></a>00320 
<a name="l00321"></a>00321 =cut
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 sub reply_with_file {
<a name="l00324"></a>00324     my ($self, $type, $source, $name, $delete_after) = @_;
<a name="l00325"></a>00325     $delete_after ||= <span class="stringliteral">&quot;&quot;</span>;
<a name="l00326"></a>00326     
<a name="l00327"></a>00327     $self-&gt;{reply_with_file} = {
<a name="l00328"></a>00328         type =&gt; $type,
<a name="l00329"></a>00329         source =&gt; $source,
<a name="l00330"></a>00330         name =&gt; $name,
<a name="l00331"></a>00331         delete_after =&gt; $delete_after,
<a name="l00332"></a>00332     };
<a name="l00333"></a>00333 }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 =item reply_with_redirect($url)
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 Enables redirect mode, causing go() to redirect to the given URL after calling
<a name="l00338"></a>00338 pre_header_initialize().
<a name="l00339"></a>00339 
<a name="l00340"></a>00340 Must be called before the HTTP header is sent. Usually called from
<a name="l00341"></a>00341 pre_header_initialize().
<a name="l00342"></a>00342 
<a name="l00343"></a>00343 =cut
<a name="l00344"></a>00344 
<a name="l00345"></a>00345 sub reply_with_redirect {
<a name="l00346"></a>00346     my ($self, $url) = @_;
<a name="l00347"></a>00347     
<a name="l00348"></a>00348     $self-&gt;{reply_with_redirect} = $url;
<a name="l00349"></a>00349 }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351 =item addmessage($message)
<a name="l00352"></a>00352 
<a name="l00353"></a>00353 Adds a message to the list of messages to be printed by the message() template
<a name="l00354"></a>00354 escape handler.
<a name="l00355"></a>00355 
<a name="l00356"></a>00356 Must be called before the message() template escape is invoked.
<a name="l00357"></a>00357 
<a name="l00358"></a>00358 =cut
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 
<a name="l00361"></a>00361 
<a name="l00362"></a>00362 sub addmessage {
<a name="l00363"></a>00363     my ($self, $message) = @_;
<a name="l00364"></a>00364     $self-&gt;{status_message} .= $message;
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 =item addgoodmessage($message)
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 Adds a success message to the list of messages to be printed by the
<a name="l00370"></a>00370 message() template escape handler.
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 =cut
<a name="l00373"></a>00373 
<a name="l00374"></a>00374 
<a name="l00375"></a>00375 sub addgoodmessage {
<a name="l00376"></a>00376     my ($self, $message) = @_;
<a name="l00377"></a>00377     $self-&gt;addmessage(CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithoutError&quot;</span>}, $message));
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380 =item addbadmessage($message)
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 Adds a failure message to the list of messages to be printed by the
<a name="l00383"></a>00383 message() template escape handler.
<a name="l00384"></a>00384 
<a name="l00385"></a>00385 =cut
<a name="l00386"></a>00386 
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 sub addbadmessage {
<a name="l00389"></a>00389     my ($self, $message) = @_;
<a name="l00390"></a>00390     $self-&gt;addmessage(CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $message));
<a name="l00391"></a>00391 }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 =item prepare_activity_entry()
<a name="l00394"></a>00394                                                                                 
<a name="l00395"></a>00395 Prepare a <span class="keywordtype">string</span> to be sent to the activity log, if it is turned on.
<a name="l00396"></a>00396 This can be overriden by different modules.
<a name="l00397"></a>00397                                                                                 
<a name="l00398"></a>00398 =cut                                                                            
<a name="l00399"></a>00399 
<a name="l00400"></a>00400 
<a name="l00401"></a>00401 sub prepare_activity_entry {
<a name="l00402"></a>00402     my $self = shift;
<a name="l00403"></a>00403     my $r = $self-&gt;r;
<a name="l00404"></a>00404     my $string = $r-&gt;urlpath-&gt;path . <span class="stringliteral">&quot;  ---&gt;  &quot;</span>.
<a name="l00405"></a>00405         join(<span class="stringliteral">&quot;\t&quot;</span>, (map { $_ eq <span class="stringliteral">&#39;key&#39;</span> || $_ eq <span class="stringliteral">&#39;passwd&#39;</span> ? <span class="stringliteral">&#39;&#39;</span> : $_ .<span class="stringliteral">&quot; =&gt; &quot;</span> . $r-&gt;param($_) } $r-&gt;param()));
<a name="l00406"></a>00406     $string =~ s/\t+/\t/g;
<a name="l00407"></a>00407     <span class="keywordflow">return</span>($string);
<a name="l00408"></a>00408 }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 =back
<a name="l00411"></a>00411 
<a name="l00412"></a>00412 =cut
<a name="l00413"></a>00413 
<a name="l00414"></a>00414 <span class="preprocessor">################################################################################</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>
<a name="l00416"></a>00416 =head1 STANDARD METHODS
<a name="l00417"></a>00417 
<a name="l00418"></a>00418 The following are the standard content generator methods. Some are defined here,
<a name="l00419"></a>00419 but may be overridden in a subclass. Others are not defined unless they are
<a name="l00420"></a>00420 defined in a subclass.
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 =over
<a name="l00423"></a>00423 
<a name="l00424"></a>00424 =item pre_header_initialize()
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 Not defined in this package.
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 May be defined by a subclass to perform any processing that must occur before
<a name="l00429"></a>00429 the HTTP header is sent.
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 =cut
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="preprocessor">#sub pre_header_initialize {  }</span>
<a name="l00434"></a>00434 <span class="preprocessor"></span>
<a name="l00435"></a>00435 =item header()
<a name="l00436"></a>00436 
<a name="l00437"></a>00437 Defined in this package.
<a name="l00438"></a>00438 
<a name="l00439"></a>00439 Generates and sends a default HTTP header, specifying the &quot;text/html&quot; content
<a name="l00440"></a>00440 type.
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 =cut
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 sub header {
<a name="l00445"></a>00445     my $self = shift;
<a name="l00446"></a>00446     my $r = $self-&gt;r;
<a name="l00447"></a>00447     
<a name="l00448"></a>00448     $r-&gt;content_type(<span class="stringliteral">&quot;text/html; charset=utf-8&quot;</span>);
<a name="l00449"></a>00449     $r-&gt;send_http_header unless MP2;
<a name="l00450"></a>00450     <span class="keywordflow">return</span> MP2 ? Apache2::Const::OK : Apache::Constants::OK;
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453 =item initialize()
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 Not defined in this package.
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 May be defined by a subclass to perform any processing that must occur after the
<a name="l00458"></a>00458 HTTP header is sent but before any content is sent.
<a name="l00459"></a>00459 
<a name="l00460"></a>00460 =cut
<a name="l00461"></a>00461 
<a name="l00462"></a>00462 <span class="preprocessor">#sub initialize {  }</span>
<a name="l00463"></a>00463 <span class="preprocessor"></span>
<a name="l00464"></a>00464 =item content()
<a name="l00465"></a>00465 
<a name="l00466"></a>00466 Defined in this package.
<a name="l00467"></a>00467 
<a name="l00468"></a>00468 Print the content of the generated page.
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 The implementation in this package uses <a class="code" href="classWeBWorK.html">WeBWorK</a>::Template to define the content
<a name="l00471"></a>00471 of the page. See <a class="code" href="classWeBWorK.html">WeBWorK</a>::Template for details.
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 If a method named templateName() exists, it it called to determine the name of
<a name="l00474"></a>00474 the template to use. If not, the default template, &quot;system&quot;, is used. The
<a name="l00475"></a>00475 location of the template is looked up in the course environment.
<a name="l00476"></a>00476 
<a name="l00477"></a>00477 =cut
<a name="l00478"></a>00478 
<a name="l00479"></a>00479 sub content {
<a name="l00480"></a>00480     my ($self) = @_;
<a name="l00481"></a>00481     my $r = $self-&gt;r;
<a name="l00482"></a>00482     my $ce = $r-&gt;ce;
<a name="l00483"></a>00483     
<a name="l00484"></a>00484     my $themesDir = $ce-&gt;{webworkDirs}{templates};
<a name="l00485"></a>00485     my $theme = $r-&gt;param(<span class="stringliteral">&quot;theme&quot;</span>) || $ce-&gt;{defaultTheme};
<a name="l00486"></a>00486     $theme = $ce-&gt;{defaultTheme} <span class="keywordflow">if</span> $theme =~ m!(?:^|/)\.\.(?:/|$)!;
<a name="l00487"></a>00487 <span class="preprocessor">    #$ce-&gt;{webworkURLs}-&gt;{stylesheet} = ($ce-&gt;{webworkURLs}-&gt;{htdocs}).&quot;/css/$theme.css&quot;;   # reset the style sheet</span>
<a name="l00488"></a>00488 <span class="preprocessor"></span><span class="preprocessor">    # the line above is clever -- but I think it is better to link directly to the style sheet from the system.template</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span><span class="preprocessor">    # then the link between template and css is made in .template file instead of hard coded as above</span>
<a name="l00490"></a>00490 <span class="preprocessor"></span><span class="preprocessor">    # this means that the {stylesheet} option in global.conf is never used</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>    my $template = $self-&gt;can(<span class="stringliteral">&quot;templateName&quot;</span>) ? $self-&gt;templateName : $ce-&gt;{defaultThemeTemplate};
<a name="l00492"></a>00492     my $templateFile = <span class="stringliteral">&quot;$themesDir/$theme/$template.template&quot;</span>;
<a name="l00493"></a>00493     
<a name="l00494"></a>00494     <span class="keyword">template</span>($templateFile, $self);
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 =back
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 =cut
<a name="l00500"></a>00500 
<a name="l00501"></a>00501 <span class="preprocessor"># ------------------------------------------------------------------------------</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span>
<a name="l00503"></a>00503 =head2 Template escape handlers
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 Template escape handlers are invoked when the <span class="keyword">template</span> processor encounters a
<a name="l00506"></a>00506 matching escape sequence in the <span class="keyword">template</span>. The escapse sequence<span class="stringliteral">&#39;s arguments are</span>
<a name="l00507"></a>00507 <span class="stringliteral">passed to the methods as a reference to a hash.</span>
<a name="l00508"></a>00508 <span class="stringliteral"></span>
<a name="l00509"></a>00509 <span class="stringliteral">For more information, refer to WeBWorK::Template.</span>
<a name="l00510"></a>00510 <span class="stringliteral"></span>
<a name="l00511"></a>00511 <span class="stringliteral">The following template escapes handlers are defined here or may be defined in</span>
<a name="l00512"></a>00512 <span class="stringliteral">subclasses. For methods that are not defined in this package, the documentation</span>
<a name="l00513"></a>00513 <span class="stringliteral">defines the interface and behavior that any subclass implementation must follow.</span>
<a name="l00514"></a>00514 <span class="stringliteral"></span>
<a name="l00515"></a>00515 <span class="stringliteral">=over</span>
<a name="l00516"></a>00516 <span class="stringliteral"></span>
<a name="l00517"></a>00517 <span class="stringliteral">=item head()</span>
<a name="l00518"></a>00518 <span class="stringliteral"></span>
<a name="l00519"></a>00519 <span class="stringliteral">Not defined in this package.</span>
<a name="l00520"></a>00520 <span class="stringliteral"></span>
<a name="l00521"></a>00521 <span class="stringliteral">Any tags that should appear in the HEAD of the document.</span>
<a name="l00522"></a>00522 <span class="stringliteral"></span>
<a name="l00523"></a>00523 <span class="stringliteral">=cut</span>
<a name="l00524"></a>00524 <span class="stringliteral"></span>
<a name="l00525"></a>00525 <span class="stringliteral">#sub head {  }</span>
<a name="l00526"></a>00526 <span class="stringliteral"></span>
<a name="l00527"></a>00527 <span class="stringliteral">=item info()</span>
<a name="l00528"></a>00528 <span class="stringliteral"></span>
<a name="l00529"></a>00529 <span class="stringliteral">Not defined in this package.</span>
<a name="l00530"></a>00530 <span class="stringliteral"></span>
<a name="l00531"></a>00531 <span class="stringliteral">Auxiliary information related to the content displayed in the C&lt;body&gt;.</span>
<a name="l00532"></a>00532 <span class="stringliteral"></span>
<a name="l00533"></a>00533 <span class="stringliteral">=cut</span>
<a name="l00534"></a>00534 <span class="stringliteral"></span>
<a name="l00535"></a>00535 <span class="stringliteral">#sub info {  }</span>
<a name="l00536"></a>00536 <span class="stringliteral"></span>
<a name="l00537"></a>00537 <span class="stringliteral">=item links()</span>
<a name="l00538"></a>00538 <span class="stringliteral"></span>
<a name="l00539"></a>00539 <span class="stringliteral">Defined in this package.</span>
<a name="l00540"></a>00540 <span class="stringliteral"></span>
<a name="l00541"></a>00541 <span class="stringliteral">Links that should appear on every page.</span>
<a name="l00542"></a>00542 <span class="stringliteral"></span>
<a name="l00543"></a>00543 <span class="stringliteral">=cut</span>
<a name="l00544"></a>00544 <span class="stringliteral"></span>
<a name="l00545"></a><a class="code" href="classWeBWorK_1_1ContentGenerator.html">00545</a> <span class="stringliteral">sub links {</span>
<a name="l00546"></a>00546 <span class="stringliteral">    my ($self) = @_;</span>
<a name="l00547"></a>00547 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00548"></a>00548 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00549"></a>00549 <span class="stringliteral">    my $db = $r-&gt;db;</span>
<a name="l00550"></a>00550 <span class="stringliteral">    my $authen = $r-&gt;authen;</span>
<a name="l00551"></a>00551 <span class="stringliteral">    my $authz = $r-&gt;authz;</span>
<a name="l00552"></a>00552 <span class="stringliteral">    my $urlpath = $r-&gt;urlpath;</span>
<a name="l00553"></a>00553 <span class="stringliteral">    </span>
<a name="l00554"></a>00554 <span class="stringliteral">    # we don&#39;</span>t currently have any links to display <span class="keywordflow">if</span> the user<span class="stringliteral">&#39;s not logged in. this may change, though.</span>
<a name="l00555"></a>00555 <span class="stringliteral">    #return &quot;&quot; unless $authen-&gt;was_verified;</span>
<a name="l00556"></a>00556 <span class="stringliteral">    </span>
<a name="l00557"></a>00557 <span class="stringliteral">    # grab some interesting data from the request</span>
<a name="l00558"></a>00558 <span class="stringliteral">    my $courseID = $urlpath-&gt;arg(&quot;courseID&quot;);</span>
<a name="l00559"></a>00559 <span class="stringliteral">    my $userID = $r-&gt;param(&#39;</span>user<span class="stringliteral">&#39;);</span>
<a name="l00560"></a>00560 <span class="stringliteral">    my $eUserID   = $r-&gt;param(&quot;effectiveUser&quot;);</span>
<a name="l00561"></a>00561 <span class="stringliteral">    my $setID     = $urlpath-&gt;arg(&quot;setID&quot;);</span>
<a name="l00562"></a>00562 <span class="stringliteral">    my $problemID = $urlpath-&gt;arg(&quot;problemID&quot;);</span>
<a name="l00563"></a>00563 <span class="stringliteral">    </span>
<a name="l00564"></a>00564 <span class="stringliteral">    my $prettySetID = $setID;</span>
<a name="l00565"></a>00565 <span class="stringliteral">    $prettySetID =~ s/_/ /g if defined $prettySetID;</span>
<a name="l00566"></a>00566 <span class="stringliteral">    </span>
<a name="l00567"></a>00567 <span class="stringliteral">    # it&#39;</span>s possible that the setID and the problemID are invalid, since they<span class="stringliteral">&#39;re just taken from the URL path info</span>
<a name="l00568"></a>00568 <span class="stringliteral">    if ($authen-&gt;was_verified) {</span>
<a name="l00569"></a>00569 <span class="stringliteral">        # DBFIXME testing for existence by keyfields -- don&#39;</span>t need fetch record
<a name="l00570"></a>00570         <span class="keywordflow">if</span> (defined $setID and $db-&gt;getUserSet($eUserID, $setID)) {
<a name="l00571"></a>00571             <span class="keywordflow">if</span> (defined $problemID and $db-&gt;getUserProblem($eUserID, $setID, $problemID)) {
<a name="l00572"></a>00572 <span class="preprocessor">                # both set and poblem exist -- do nothing</span>
<a name="l00573"></a>00573 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> {
<a name="l00574"></a>00574                 $problemID = undef;
<a name="l00575"></a>00575             }
<a name="l00576"></a>00576         } <span class="keywordflow">else</span> {
<a name="l00577"></a>00577             $setID = undef;
<a name="l00578"></a>00578             $problemID = undef;
<a name="l00579"></a>00579         }
<a name="l00580"></a>00580     }
<a name="l00581"></a>00581     
<a name="l00582"></a>00582 <span class="preprocessor">    # experimental subroutine for generating links, to clean up the rest of the</span>
<a name="l00583"></a>00583 <span class="preprocessor"></span><span class="preprocessor">    # code. ignore for now. (this is a closure over $self.)</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span>    my $makelink = sub {
<a name="l00585"></a>00585         my ($module, %options) = @_;
<a name="l00586"></a>00586         
<a name="l00587"></a>00587         my $urlpath_args = $options{urlpath_args} || {};
<a name="l00588"></a>00588         my $systemlink_args = $options{systemlink_args} || {};
<a name="l00589"></a>00589         my $text = $options{text};
<a name="l00590"></a>00590         my $active = $options{active};
<a name="l00591"></a>00591         my %target = ($options{target} ? (target =&gt; $options{target}) : ());
<a name="l00592"></a>00592         
<a name="l00593"></a>00593         my $new_urlpath = $self-&gt;r-&gt;urlpath-&gt;newFromModule($module, $r, %$urlpath_args);
<a name="l00594"></a>00594         my $new_systemlink = $self-&gt;systemLink($new_urlpath, %$systemlink_args);
<a name="l00595"></a>00595         
<a name="l00596"></a>00596         defined $text or $text = $new_urlpath-&gt;name;  #too clever
<a name="l00597"></a>00597         
<a name="l00598"></a>00598         my $id = $text;
<a name="l00599"></a>00599         $id =~ s/\W/\_/g; 
<a name="l00600"></a>00600 <span class="preprocessor">        #$text = sp2nbsp($text); # ugly hack to prevent text from wrapping</span>
<a name="l00601"></a>00601 <span class="preprocessor"></span>        
<a name="l00602"></a>00602 <span class="preprocessor">        # try to set $active automatically by comparing </span>
<a name="l00603"></a>00603 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (not defined $active) {
<a name="l00604"></a>00604             <span class="keywordflow">if</span> ($urlpath-&gt;module eq $new_urlpath-&gt;module) {
<a name="l00605"></a>00605                 my @args = sort keys %{{$urlpath-&gt;args}};
<a name="l00606"></a>00606                 my @new_args = sort keys %{{$new_urlpath-&gt;args}};
<a name="l00607"></a>00607                 <span class="keywordflow">if</span> (@args == @new_args) {
<a name="l00608"></a>00608                     <span class="keywordflow">foreach</span> my $i (0 .. $#args) {
<a name="l00609"></a>00609                         $active = 0;
<a name="l00610"></a>00610                         last <span class="keywordflow">if</span> $args[$i] ne $new_args[$i];
<a name="l00611"></a>00611                         $active = 1;
<a name="l00612"></a>00612                     }
<a name="l00613"></a>00613                 } <span class="keywordflow">else</span> {
<a name="l00614"></a>00614                     $active = 0;
<a name="l00615"></a>00615                 }
<a name="l00616"></a>00616             } <span class="keywordflow">else</span> {
<a name="l00617"></a>00617                 $active = 0;
<a name="l00618"></a>00618             }
<a name="l00619"></a>00619         }
<a name="l00620"></a>00620         
<a name="l00621"></a>00621         my $new_anchor;
<a name="l00622"></a>00622         <span class="keywordflow">if</span> ($active) {
<a name="l00623"></a>00623 <span class="preprocessor">            # add &lt;strong&gt; for old browsers</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span>            $new_anchor = CGI::strong(CGI::a({href=&gt;$new_systemlink, <span class="keywordtype">id</span>=&gt;$id, <span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;active&quot;</span>, %target}, $text));
<a name="l00625"></a>00625         } <span class="keywordflow">else</span> {
<a name="l00626"></a>00626             $new_anchor = CGI::a({href=&gt;$new_systemlink, <span class="keywordtype">id</span>=&gt;$id, %target}, <span class="stringliteral">&quot;$text&quot;</span>);
<a name="l00627"></a>00627         }
<a name="l00628"></a>00628         
<a name="l00629"></a>00629         <span class="keywordflow">return</span> $new_anchor;
<a name="l00630"></a>00630     };
<a name="l00631"></a>00631     
<a name="l00632"></a>00632 <span class="preprocessor">    # to make things more concise</span>
<a name="l00633"></a>00633 <span class="preprocessor"></span>    my $pfx = <span class="stringliteral">&quot;WeBWorK::ContentGenerator::&quot;</span>;
<a name="l00634"></a>00634     my %args = ( courseID =&gt; $courseID );
<a name="l00635"></a>00635     
<a name="l00636"></a>00636 <span class="preprocessor">    # we&#39;d like to preserve displayMode and showOldAnswers between pages, and we</span>
<a name="l00637"></a>00637 <span class="preprocessor"></span><span class="preprocessor">    # don&#39;t have a general way of preserving non-authen params between requests,</span>
<a name="l00638"></a>00638 <span class="preprocessor"></span><span class="preprocessor">    # so here is the hack:</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span>    my %params;
<a name="l00640"></a>00640     $params{displayMode} = $r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>) <span class="keywordflow">if</span> defined $r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>);
<a name="l00641"></a>00641     $params{showOldAnswers} = $r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>) <span class="keywordflow">if</span> defined $r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>);
<a name="l00642"></a>00642 <span class="preprocessor">    # in the past, we were checking $self-&gt;{displayMode} and $self-&gt;{will}-&gt;{showOldAnswers}</span>
<a name="l00643"></a>00643 <span class="preprocessor"></span><span class="preprocessor">    # to set these args, but I don&#39;t wanna do that anymore, since it relies on</span>
<a name="l00644"></a>00644 <span class="preprocessor"></span><span class="preprocessor">    # fields specific to Problem.pm (pretty sure). The only differences in this</span>
<a name="l00645"></a>00645 <span class="preprocessor"></span><span class="preprocessor">    # approach are:</span>
<a name="l00646"></a>00646 <span class="preprocessor"></span><span class="preprocessor">    # (a) displayMode will not be set if it wasn&#39;t set in the current request,</span>
<a name="l00647"></a>00647 <span class="preprocessor"></span><span class="preprocessor">    # but this is ok since the resulting page will just use the default value</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span><span class="preprocessor">    # (b) showOldAnswers will get set to the value specified in the current</span>
<a name="l00649"></a>00649 <span class="preprocessor"></span><span class="preprocessor">    # request, regardless of whether it is allowed, but this is OK since we</span>
<a name="l00650"></a>00650 <span class="preprocessor"></span><span class="preprocessor">    # always this value before using it.</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span>    my %systemlink_args;
<a name="l00652"></a>00652     $systemlink_args{params} = \%params <span class="keywordflow">if</span> %params;
<a name="l00653"></a>00653     
<a name="l00654"></a>00654     print CGI::h2($r-&gt;maketext(<span class="stringliteral">&quot;Main Menu&quot;</span>));
<a name="l00655"></a>00655     print CGI::start_ul();
<a name="l00656"></a>00656     print CGI::start_li(); # Courses
<a name="l00657"></a>00657     print &amp;$makelink(<span class="stringliteral">&quot;${pfx}Home&quot;</span>, text=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Courses&quot;</span>), systemlink_args=&gt;{authen=&gt;0});
<a name="l00658"></a>00658     
<a name="l00659"></a>00659     <span class="keywordflow">if</span> (defined $courseID) {
<a name="l00660"></a>00660 <span class="preprocessor">        #print CGI::start_ul();</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span><span class="preprocessor">        #print CGI::start_li(); # $courseID</span>
<a name="l00662"></a>00662 <span class="preprocessor"></span><span class="preprocessor">        #print CGI::strong(CGI::span({class=&gt;&quot;active&quot;}, $courseID));</span>
<a name="l00663"></a>00663 <span class="preprocessor"></span>        
<a name="l00664"></a>00664         <span class="keywordflow">if</span> ($authen-&gt;was_verified) {
<a name="l00665"></a>00665             print CGI::start_ul();
<a name="l00666"></a>00666             print CGI::start_li(); # Homework Sets
<a name="l00667"></a>00667             print &amp;$makelink(<span class="stringliteral">&quot;${pfx}ProblemSets&quot;</span>, text=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Homework Sets&quot;</span>), urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args);
<a name="l00668"></a>00668             
<a name="l00669"></a>00669             <span class="keywordflow">if</span> (defined $setID) {
<a name="l00670"></a>00670                 print CGI::start_ul();
<a name="l00671"></a>00671                 print CGI::start_li(); # $setID
<a name="l00672"></a>00672 <span class="preprocessor">                # show a link if we&#39;re displaying a homework set, or a version</span>
<a name="l00673"></a>00673 <span class="preprocessor"></span><span class="preprocessor">                #    of a gateway assignment; to know if it&#39;s a gateway</span>
<a name="l00674"></a>00674 <span class="preprocessor"></span><span class="preprocessor">                #    assignment, we have to get the set record.</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span>                my ($globalSetID) = ( $setID =~ /(.+?)(,v\d+)?$/ );
<a name="l00676"></a>00676                 my $setRecord = $db-&gt;getGlobalSet( $globalSetID );
<a name="l00677"></a>00677                 <span class="keywordflow">if</span> ( $setRecord-&gt;assignment_type !~ /gateway/ ) {
<a name="l00678"></a>00678                     print &amp;$makelink(<span class="stringliteral">&quot;${pfx}ProblemSet&quot;</span>, text=&gt;<span class="stringliteral">&quot;$prettySetID&quot;</span>, urlpath_args=&gt;{%args,setID=&gt;$setID}, systemlink_args=&gt;\%systemlink_args);
<a name="l00679"></a>00679                 } elsif ($setID =~ /,v(\d)+$/) {
<a name="l00680"></a>00680                     print &amp;$makelink(<span class="stringliteral">&quot;${pfx}GatewayQuiz&quot;</span>, text=&gt;<span class="stringliteral">&quot;$prettySetID&quot;</span>, urlpath_args=&gt;{%args,setID=&gt;$setID}, systemlink_args=&gt;\%systemlink_args);
<a name="l00681"></a>00681                 }
<a name="l00682"></a>00682 
<a name="l00683"></a>00683                 <span class="keywordflow">if</span> (defined $problemID) {
<a name="l00684"></a>00684                     print CGI::start_ul();
<a name="l00685"></a>00685                     print CGI::start_li(); # $problemID
<a name="l00686"></a>00686                     print &amp;$makelink(<span class="stringliteral">&quot;${pfx}Problem&quot;</span>, text=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Problem [_1]&quot;</span>, $problemID), urlpath_args=&gt;{%args,setID=&gt;$setID,problemID=&gt;$problemID}, systemlink_args=&gt;\%systemlink_args);
<a name="l00687"></a>00687                     
<a name="l00688"></a>00688                     print CGI::end_li(); # end $problemID
<a name="l00689"></a>00689                     print CGI::end_ul();
<a name="l00690"></a>00690                 }
<a name="l00691"></a>00691                 print CGI::end_li(); # end $setID
<a name="l00692"></a>00692                 print CGI::end_ul();
<a name="l00693"></a>00693             }
<a name="l00694"></a>00694             print CGI::end_li(); # end Homework Sets
<a name="l00695"></a>00695             
<a name="l00696"></a>00696             <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;change_password&quot;</span>) or $authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;change_email_address&quot;</span>)) {
<a name="l00697"></a>00697                 print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}Options&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args));
<a name="l00698"></a>00698             }
<a name="l00699"></a>00699             
<a name="l00700"></a>00700             print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}Grades&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args));
<a name="l00701"></a>00701             
<a name="l00702"></a>00702             <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>)) {
<a name="l00703"></a>00703                 $pfx .= <span class="stringliteral">&quot;Instructor::&quot;</span>;
<a name="l00704"></a>00704                 
<a name="l00705"></a>00705                 print CGI::start_li(); # Instructor Tools
<a name="l00706"></a>00706                 print &amp;$makelink(<span class="stringliteral">&quot;${pfx}Index&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args);
<a name="l00707"></a>00707                 print CGI::start_ul();
<a name="l00708"></a>00708                 
<a name="l00709"></a>00709                 print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}UserList&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args))
<a name="l00710"></a>00710                     if $ce-&gt;{showeditors}-&gt;{classlisteditor1};
<a name="l00711"></a>00711                 print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}UserList2&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args))
<a name="l00712"></a>00712                     if $ce-&gt;{showeditors}-&gt;{classlisteditor2};;
<a name="l00713"></a>00713                 
<a name="l00714"></a>00714                 print CGI::start_li(); # Homework Set Editor
<a name="l00715"></a>00715                 print &amp;$makelink(<span class="stringliteral">&quot;${pfx}ProblemSetList&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args)
<a name="l00716"></a>00716                     <span class="keywordflow">if</span> $ce-&gt;{showeditors}-&gt;{homeworkseteditor1};
<a name="l00717"></a>00717                 print <span class="stringliteral">&quot;&lt;br/&gt;&quot;</span>;
<a name="l00718"></a>00718                 print &amp;$makelink(<span class="stringliteral">&quot;${pfx}ProblemSetList2&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args)
<a name="l00719"></a>00719                     <span class="keywordflow">if</span> $ce-&gt;{showeditors}-&gt;{homeworkseteditor2};;
<a name="l00720"></a>00720                 
<a name="l00721"></a>00721 <span class="preprocessor">                ## only show editor link for non-versioned sets</span>
<a name="l00722"></a>00722 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (defined $setID &amp;&amp; $setID !~ /,v\d+$/ ) {
<a name="l00723"></a>00723                     print CGI::start_ul();
<a name="l00724"></a>00724                     print CGI::start_li(); # $setID
<a name="l00725"></a>00725                     print &amp;$makelink(<span class="stringliteral">&quot;${pfx}ProblemSetDetail&quot;</span>, text=&gt;<span class="stringliteral">&quot;$prettySetID&quot;</span>, urlpath_args=&gt;{%args,setID=&gt;$setID}, systemlink_args=&gt;\%systemlink_args);
<a name="l00726"></a>00726                     
<a name="l00727"></a>00727                     <span class="keywordflow">if</span> (defined $problemID) {
<a name="l00728"></a>00728                         print CGI::start_ul();
<a name="l00729"></a>00729                         print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}PGProblemEditor&quot;</span>, text=&gt;<span class="stringliteral">&quot;$problemID&quot;</span>, urlpath_args=&gt;{%args,setID=&gt;$setID,problemID=&gt;$problemID}, systemlink_args=&gt;\%systemlink_args, target=&gt;<span class="stringliteral">&quot;WW_Editor&quot;</span>))
<a name="l00730"></a>00730                             if $ce-&gt;{showeditors}-&gt;{pgproblemeditor1};
<a name="l00731"></a>00731                         print CGI::end_ul();
<a name="l00732"></a>00732                     }
<a name="l00733"></a>00733                     <span class="keywordflow">if</span> (defined $problemID) {
<a name="l00734"></a>00734                         print CGI::start_ul();
<a name="l00735"></a>00735                         print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}PGProblemEditor2&quot;</span>, text=&gt;<span class="stringliteral">&quot;--$problemID&quot;</span>, urlpath_args=&gt;{%args,setID=&gt;$setID,problemID=&gt;$problemID}, systemlink_args=&gt;\%systemlink_args, target=&gt;<span class="stringliteral">&quot;WW_Editor2&quot;</span>))
<a name="l00736"></a>00736                             if $ce-&gt;{showeditors}-&gt;{pgproblemeditor2};;
<a name="l00737"></a>00737                         print CGI::end_ul();
<a name="l00738"></a>00738                     }
<a name="l00739"></a>00739                     
<a name="l00740"></a>00740                     print CGI::end_li(); # end $setID
<a name="l00741"></a>00741                     print CGI::end_ul();
<a name="l00742"></a>00742                 }
<a name="l00743"></a>00743                 print CGI::end_li(); # end Homework Set Editor
<a name="l00744"></a>00744                 
<a name="l00745"></a>00745                 print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}SetMaker&quot;</span>, text=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Library Browser&quot;</span>), urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args))
<a name="l00746"></a>00746                     if $ce-&gt;{showeditors}-&gt;{librarybrowser1};
<a name="l00747"></a>00747                 print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}SetMaker2&quot;</span>, text=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Library Browser 2&quot;</span>), urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args))
<a name="l00748"></a>00748                     if $ce-&gt;{showeditors}-&gt;{librarybrowser2};
<a name="l00749"></a>00749                 print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}SetMaker3&quot;</span>, text=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Library Browser 3&quot;</span>), urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args))
<a name="l00750"></a>00750                     if $ce-&gt;{showeditors}-&gt;{librarybrowser3};
<a name="l00751"></a>00751                 print CGI::start_li(); # Stats
<a name="l00752"></a>00752                 print &amp;$makelink(<span class="stringliteral">&quot;${pfx}Stats&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args);
<a name="l00753"></a>00753                 <span class="keywordflow">if</span> ($userID ne $eUserID or defined $setID) {
<a name="l00754"></a>00754                     print CGI::start_ul();
<a name="l00755"></a>00755                     <span class="keywordflow">if</span> ($userID ne $eUserID) {
<a name="l00756"></a>00756                         print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}Stats&quot;</span>, text=&gt;<span class="stringliteral">&quot;$eUserID&quot;</span>, urlpath_args=&gt;{%args,statType=&gt;<span class="stringliteral">&quot;student&quot;</span>,userID=&gt;$eUserID}, systemlink_args=&gt;\%systemlink_args));
<a name="l00757"></a>00757                     }
<a name="l00758"></a>00758                     <span class="keywordflow">if</span> (defined $setID) {
<a name="l00759"></a>00759 <span class="preprocessor">                        # make sure we don&#39;t try to send a versioned</span>
<a name="l00760"></a>00760 <span class="preprocessor"></span><span class="preprocessor">                        #    set id in to the stats link</span>
<a name="l00761"></a>00761 <span class="preprocessor"></span>                        my ( $nvSetID ) = ( $setID =~ /(.+?)(,v\d+)?$/ );
<a name="l00762"></a>00762                         my ( $nvPretty ) = ( $prettySetID =~ /(.+?)(,v\d+)?$/ );
<a name="l00763"></a>00763                         print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}Stats&quot;</span>, text=&gt;<span class="stringliteral">&quot;$nvPretty&quot;</span>, urlpath_args=&gt;{%args,statType=&gt;<span class="stringliteral">&quot;set&quot;</span>,setID=&gt;$nvSetID}, systemlink_args=&gt;\%systemlink_args));
<a name="l00764"></a>00764                     }
<a name="l00765"></a>00765                     print CGI::end_ul();
<a name="l00766"></a>00766                 }
<a name="l00767"></a>00767                 print CGI::end_li(); # end Stats
<a name="l00768"></a>00768                 
<a name="l00769"></a>00769                 print CGI::start_li(); # Student Progress
<a name="l00770"></a>00770                 print &amp;$makelink(<span class="stringliteral">&quot;${pfx}StudentProgress&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args);
<a name="l00771"></a>00771                 <span class="keywordflow">if</span> ($userID ne $eUserID or defined $setID) {
<a name="l00772"></a>00772                     print CGI::start_ul();
<a name="l00773"></a>00773                     <span class="keywordflow">if</span> ($userID ne $eUserID) {
<a name="l00774"></a>00774                         print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}StudentProgress&quot;</span>, text=&gt;<span class="stringliteral">&quot;$eUserID&quot;</span>, urlpath_args=&gt;{%args,statType=&gt;<span class="stringliteral">&quot;student&quot;</span>,userID=&gt;$eUserID}, systemlink_args=&gt;\%systemlink_args));
<a name="l00775"></a>00775                     }
<a name="l00776"></a>00776                     <span class="keywordflow">if</span> (defined $setID) {
<a name="l00777"></a>00777 <span class="preprocessor">                        # make sure we don&#39;t try to send a versioned</span>
<a name="l00778"></a>00778 <span class="preprocessor"></span><span class="preprocessor">                        #    set id in to the stats link</span>
<a name="l00779"></a>00779 <span class="preprocessor"></span>                        my ( $nvSetID ) = ( $setID =~ /(.+?)(,v\d+)?$/ );
<a name="l00780"></a>00780                         my ( $nvPretty ) = ( $prettySetID =~ /(.+?)(,v\d+)?$/ );
<a name="l00781"></a>00781                         print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}StudentProgress&quot;</span>, text=&gt;<span class="stringliteral">&quot;$nvPretty&quot;</span>, urlpath_args=&gt;{%args,statType=&gt;<span class="stringliteral">&quot;set&quot;</span>,setID=&gt;$nvSetID}, systemlink_args=&gt;\%systemlink_args));
<a name="l00782"></a>00782                     }
<a name="l00783"></a>00783                     print CGI::end_ul();
<a name="l00784"></a>00784                 }
<a name="l00785"></a>00785                 print CGI::end_li(); # end Student Progress
<a name="l00786"></a>00786                 
<a name="l00787"></a>00787                 <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;score_sets&quot;</span>)) {
<a name="l00788"></a>00788                     print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}Scoring&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args));
<a name="l00789"></a>00789                 }
<a name="l00790"></a>00790                 
<a name="l00791"></a>00791                 <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;send_mail&quot;</span>)) {
<a name="l00792"></a>00792                     print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}SendMail&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args));
<a name="l00793"></a>00793                 }
<a name="l00794"></a>00794                 
<a name="l00795"></a>00795                 <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;manage_course_files&quot;</span>)) {
<a name="l00796"></a>00796                     print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}FileManager&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args));
<a name="l00797"></a>00797                 }
<a name="l00798"></a>00798                 
<a name="l00799"></a>00799                 <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;manage_course_files&quot;</span>)) {
<a name="l00800"></a>00800                     print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}Config&quot;</span>, urlpath_args=&gt;{%args}, systemlink_args=&gt;\%systemlink_args));
<a name="l00801"></a>00801                 }
<a name="l00802"></a>00802                 print CGI::li({}, $self-&gt;helpMacro(<span class="stringliteral">&#39;instructor_links&#39;</span>,<span class="stringliteral">&#39;Help&#39;</span>),$self-&gt;help() );
<a name="l00803"></a>00803                 <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;manage_course_files&quot;</span>) # show <span class="keyword">this</span> only on the FileManager page
<a name="l00804"></a>00804                      &amp;&amp; $r-&gt;urlpath-&gt;module eq <span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::FileManager&quot;</span>) {
<a name="l00805"></a>00805                     my %augmentedSystemLinks = %systemlink_args;
<a name="l00806"></a>00806                     $augmentedSystemLinks{params}-&gt;{archiveCourse}=1;
<a name="l00807"></a>00807                     print CGI::li(&amp;$makelink(<span class="stringliteral">&quot;${pfx}FileManager&quot;</span>, text=&gt;<span class="stringliteral">&quot;Archive this Course&quot;</span>,urlpath_args=&gt;{%args}, systemlink_args=&gt;\%augmentedSystemLinks));
<a name="l00808"></a>00808                 }
<a name="l00809"></a>00809                 print CGI::end_ul();
<a name="l00810"></a>00810                 print CGI::end_li(); # end Instructor Tools
<a name="l00811"></a>00811             } # <span class="comment">/* access_instructor_tools */</span>
<a name="l00812"></a>00812             
<a name="l00813"></a>00813             print CGI::end_ul();
<a name="l00814"></a>00814             
<a name="l00815"></a>00815             print CGI::start_ul();
<a name="l00816"></a>00816             <span class="keywordflow">if</span> (exists $ce-&gt;{webworkURLs}{bugReporter} and $ce-&gt;{webworkURLs}{bugReporter} ne <span class="stringliteral">&quot;&quot;</span>
<a name="l00817"></a>00817                 and $authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;report_bugs&quot;</span>)) {
<a name="l00818"></a>00818                 print CGI::li(CGI::a({style=&gt;<span class="stringliteral">&#39;font-size:larger&#39;</span>, href=&gt;$ce-&gt;{webworkURLs}{bugReporter}}, $r-&gt;maketext(<span class="stringliteral">&quot;Report bugs&quot;</span>)));
<a name="l00819"></a>00819             }
<a name="l00820"></a>00820     
<a name="l00821"></a>00821     print CGI::end_ul();
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         } # <span class="comment">/* authentication was_verified */</span>
<a name="l00824"></a>00824         
<a name="l00825"></a>00825 <span class="preprocessor">        #print CGI::end_li(); # end $courseID</span>
<a name="l00826"></a>00826 <span class="preprocessor"></span><span class="preprocessor">        #print CGI::end_ul();</span>
<a name="l00827"></a>00827 <span class="preprocessor"></span>    } # <span class="comment">/* defined $courseID */</span>
<a name="l00828"></a>00828     
<a name="l00829"></a>00829     print CGI::end_li(); # end Courses
<a name="l00830"></a>00830     print CGI::end_ul();
<a name="l00831"></a>00831     
<a name="l00832"></a>00832     
<a name="l00833"></a>00833 
<a name="l00834"></a>00834     
<a name="l00835"></a>00835     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00836"></a>00836 }
<a name="l00837"></a>00837 
<a name="l00838"></a>00838 =item loginstatus()
<a name="l00839"></a>00839 
<a name="l00840"></a>00840 Defined in this package.
<a name="l00841"></a>00841 
<a name="l00842"></a>00842 Print a notification message announcing the current real user and effective
<a name="l00843"></a>00843 user, a link to stop acting as the effective user, and a link to logout.
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 =cut
<a name="l00846"></a>00846 
<a name="l00847"></a>00847 sub loginstatus {
<a name="l00848"></a>00848     my ($self) = @_;
<a name="l00849"></a>00849     my $r = $self-&gt;r;
<a name="l00850"></a>00850     my $authen = $r-&gt;authen;
<a name="l00851"></a>00851     my $urlpath = $r-&gt;urlpath;
<a name="l00852"></a>00852     
<a name="l00853"></a>00853     <span class="keywordflow">if</span> ($authen and $authen-&gt;was_verified) {
<a name="l00854"></a>00854         my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00855"></a>00855         my $userID = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00856"></a>00856         my $eUserID = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>);
<a name="l00857"></a>00857         
<a name="l00858"></a>00858         my $stopActingURL = $self-&gt;systemLink($urlpath, # current path
<a name="l00859"></a>00859             params =&gt; { effectiveUser =&gt; $userID },
<a name="l00860"></a>00860         );
<a name="l00861"></a>00861         my $logoutURL = $self-&gt;systemLink($urlpath-&gt;newFromModule(__PACKAGE__ . <span class="stringliteral">&quot;::Logout&quot;</span>, $r, courseID =&gt; $courseID));
<a name="l00862"></a>00862         
<a name="l00863"></a>00863         <span class="keywordflow">if</span> ($eUserID eq $userID) {
<a name="l00864"></a>00864             print $r-&gt;maketext(<span class="stringliteral">&quot;Logged in as [_1]. &quot;</span>, $userID) . CGI::br() . CGI::a({href=&gt;$logoutURL}, $r-&gt;maketext(<span class="stringliteral">&quot;Log Out&quot;</span>));
<a name="l00865"></a>00865         } <span class="keywordflow">else</span> {
<a name="l00866"></a>00866             print $r-&gt;maketext(<span class="stringliteral">&quot;Logged in as [_1]. &quot;</span>, $userID) . CGI::a({href=&gt;$logoutURL}, $r-&gt;maketext(<span class="stringliteral">&quot;Log Out&quot;</span>)) . CGI::br();
<a name="l00867"></a>00867             print $r-&gt;maketext(<span class="stringliteral">&quot;Acting as [_1]. &quot;</span>, $eUserID) . CGI::a({href=&gt;$stopActingURL}, $r-&gt;maketext(<span class="stringliteral">&quot;Stop Acting&quot;</span>));
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869     } <span class="keywordflow">else</span> {
<a name="l00870"></a>00870         print $r-&gt;maketext(<span class="stringliteral">&quot;Not logged in.&quot;</span>);
<a name="l00871"></a>00871     }
<a name="l00872"></a>00872     
<a name="l00873"></a>00873     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00874"></a>00874 }
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 =item nav($args)
<a name="l00877"></a>00877 
<a name="l00878"></a>00878 Not defined in this package.
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 Links to the previous, next, and parent objects.
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 $args is a reference to a hash containing the following fields:
<a name="l00883"></a>00883 
<a name="l00884"></a>00884  style       =&gt; text|image
<a name="l00885"></a>00885  imageprefix =&gt; prefix to prepend to base image URL
<a name="l00886"></a>00886  imagesuffix =&gt; suffix to append to base image URL
<a name="l00887"></a>00887  separator   =&gt; <a class="code" href="classWeBWorK_1_1HTML.html">HTML</a> to place in between links
<a name="l00888"></a>00888 
<a name="l00889"></a>00889 If C&lt;style&gt; is &quot;image&quot;, image URLs are constructed by prepending C&lt;imageprefix&gt;
<a name="l00890"></a>00890 and postpending C&lt;imagesuffix&gt; to the image base names defined by the
<a name="l00891"></a>00891 implementor. (Examples of base names include &quot;Prev&quot;, &quot;Next&quot;, &quot;ProbSet&quot;, and
<a name="l00892"></a>00892 &quot;Up&quot;). Each concatenated <span class="keywordtype">string</span> should form an absolute URL to an image file.
<a name="l00893"></a>00893 For example:
<a name="l00894"></a>00894 
<a name="l00895"></a>00895  &lt;!--<span class="preprocessor">#nav style=&quot;images&quot; imageprefix=&quot;/webwork2_files/images/nav&quot;</span>
<a name="l00896"></a>00896 <span class="preprocessor"></span>          imagesuffix=<span class="stringliteral">&quot;.gif&quot;</span> separator=<span class="stringliteral">&quot;  &quot;</span>--&gt;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898 =cut
<a name="l00899"></a>00899 
<a name="l00900"></a>00900 <span class="preprocessor">#sub nav {  }</span>
<a name="l00901"></a>00901 <span class="preprocessor"></span>
<a name="l00902"></a>00902 =item options()
<a name="l00903"></a>00903 
<a name="l00904"></a>00904 Not defined in this package.
<a name="l00905"></a>00905 
<a name="l00906"></a>00906 View options related to the content displayed in the body or info areas. See also
<a name="l00907"></a>00907 optionsMacro().
<a name="l00908"></a>00908 
<a name="l00909"></a>00909 =cut
<a name="l00910"></a>00910 
<a name="l00911"></a>00911 <span class="preprocessor">#sub options {  }</span>
<a name="l00912"></a>00912 <span class="preprocessor"></span>
<a name="l00913"></a>00913 =item path($args)
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 Defined in this package.
<a name="l00916"></a>00916 
<a name="l00917"></a>00917 Print &quot;breadcrubs&quot; from the root of the virtual hierarchy to the current page.
<a name="l00918"></a>00918 $args is a reference to a hash containing the following fields:
<a name="l00919"></a>00919 
<a name="l00920"></a>00920  style    =&gt; type of separator: text|image
<a name="l00921"></a>00921  image    =&gt; if style=image, URL of image to use as path separator
<a name="l00922"></a>00922  text     =&gt; if style=text, text to use as path separator
<a name="l00923"></a>00923              if style=image, the ALT text of each separator image
<a name="l00924"></a>00924  textonly =&gt; suppress all <a class="code" href="classWeBWorK_1_1HTML.html">HTML</a>, return only plain text
<a name="l00925"></a>00925 
<a name="l00926"></a>00926 The implementation in this package takes information from the <a class="code" href="classWeBWorK.html">WeBWorK</a>::URLPath
<a name="l00927"></a>00927 associated with the current request.
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 =cut
<a name="l00930"></a>00930 
<a name="l00931"></a>00931 sub path {
<a name="l00932"></a>00932     my ($self, $args) = @_;
<a name="l00933"></a>00933     my $r = $self-&gt;r;
<a name="l00934"></a>00934     
<a name="l00935"></a>00935     my @path;
<a name="l00936"></a>00936     
<a name="l00937"></a>00937     my $urlpath = $r-&gt;urlpath;
<a name="l00938"></a>00938     <span class="keywordflow">do</span> {
<a name="l00939"></a>00939         unshift @path, $urlpath-&gt;name, $r-&gt;location . $urlpath-&gt;path;
<a name="l00940"></a>00940     } <span class="keywordflow">while</span> ($urlpath = $urlpath-&gt;parent);
<a name="l00941"></a>00941     
<a name="l00942"></a>00942     $path[$#path] = <span class="stringliteral">&quot;&quot;</span>; # we don<span class="stringliteral">&#39;t want the last path element to be a link</span>
<a name="l00943"></a>00943 <span class="stringliteral">    </span>
<a name="l00944"></a>00944 <span class="stringliteral">    #print &quot;\n&lt;!-- BEGIN &quot; . __PACKAGE__ . &quot;::path --&gt;\n&quot;;</span>
<a name="l00945"></a>00945 <span class="stringliteral">    print $self-&gt;pathMacro($args, @path);</span>
<a name="l00946"></a>00946 <span class="stringliteral">    #print &quot;&lt;!-- END &quot; . __PACKAGE__ . &quot;::path --&gt;\n&quot;;</span>
<a name="l00947"></a>00947 <span class="stringliteral">    </span>
<a name="l00948"></a>00948 <span class="stringliteral">    return &quot;&quot;;</span>
<a name="l00949"></a>00949 <span class="stringliteral">}</span>
<a name="l00950"></a>00950 <span class="stringliteral"></span>
<a name="l00951"></a>00951 <span class="stringliteral">=item siblings()</span>
<a name="l00952"></a>00952 <span class="stringliteral"></span>
<a name="l00953"></a>00953 <span class="stringliteral">Not defined in this package.</span>
<a name="l00954"></a>00954 <span class="stringliteral"></span>
<a name="l00955"></a>00955 <span class="stringliteral">Print links to siblings of the current object.</span>
<a name="l00956"></a>00956 <span class="stringliteral"></span>
<a name="l00957"></a>00957 <span class="stringliteral">=cut</span>
<a name="l00958"></a>00958 <span class="stringliteral"></span>
<a name="l00959"></a>00959 <span class="stringliteral">#sub siblings {  }</span>
<a name="l00960"></a>00960 <span class="stringliteral"></span>
<a name="l00961"></a>00961 <span class="stringliteral">=item footer()</span>
<a name="l00962"></a>00962 <span class="stringliteral"></span>
<a name="l00963"></a>00963 <span class="stringliteral">    -by ghe3</span>
<a name="l00964"></a>00964 <span class="stringliteral">    </span>
<a name="l00965"></a>00965 <span class="stringliteral">    combines timestamp() and other elements of the footer, including the copyright, into one output subroutine,</span>
<a name="l00966"></a>00966 <span class="stringliteral">=cut</span>
<a name="l00967"></a>00967 <span class="stringliteral"></span>
<a name="l00968"></a>00968 <span class="stringliteral">sub footer(){</span>
<a name="l00969"></a>00969 <span class="stringliteral">    my $self = shift;</span>
<a name="l00970"></a>00970 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00971"></a>00971 <span class="stringliteral">    </span>
<a name="l00972"></a>00972 <span class="stringliteral">    print CGI::p({-id=&gt;&quot;last-modified&quot;}, $r-&gt;maketext(&quot;Page generated at [_1]&quot;, timestamp($self)));</span>
<a name="l00973"></a>00973 <span class="stringliteral">    print CGI::div({-id=&gt;&quot;copyright&quot;}, &quot;WeBWorK &amp;#169; 1996-2011&quot;, CGI::a({-href=&gt;&quot;http://webwork.maa.org/&quot;}, $r-&gt;maketext(&quot;The WeBWorK Project&quot;)));</span>
<a name="l00974"></a>00974 <span class="stringliteral">    </span>
<a name="l00975"></a>00975 <span class="stringliteral">    return &quot;&quot;;</span>
<a name="l00976"></a>00976 <span class="stringliteral">}</span>
<a name="l00977"></a>00977 <span class="stringliteral"></span>
<a name="l00978"></a>00978 <span class="stringliteral"> </span>
<a name="l00979"></a>00979 <span class="stringliteral">=item timestamp()</span>
<a name="l00980"></a>00980 <span class="stringliteral"></span>
<a name="l00981"></a>00981 <span class="stringliteral">Defined in this package.</span>
<a name="l00982"></a>00982 <span class="stringliteral"></span>
<a name="l00983"></a>00983 <span class="stringliteral">Display the current time and date using default format &quot;3:37pm on Jan 7, 2004&quot;.</span>
<a name="l00984"></a>00984 <span class="stringliteral">The display format can be adjusted by giving a style in the template.</span>
<a name="l00985"></a>00985 <span class="stringliteral">For example,</span>
<a name="l00986"></a>00986 <span class="stringliteral"></span>
<a name="l00987"></a>00987 <span class="stringliteral">  &lt;!--#timestamp style=&quot;%m/%d/%y at %I:%M%P&quot;--&gt;</span>
<a name="l00988"></a>00988 <span class="stringliteral"></span>
<a name="l00989"></a>00989 <span class="stringliteral">will give standard WeBWorK time format.  Wording and other formatting</span>
<a name="l00990"></a>00990 <span class="stringliteral">can be done in the template itself.</span>
<a name="l00991"></a>00991 <span class="stringliteral">=cut</span>
<a name="l00992"></a>00992 <span class="stringliteral"></span>
<a name="l00993"></a>00993 <span class="stringliteral"># sub timestamp {</span>
<a name="l00994"></a>00994 <span class="stringliteral">#   my ($self, $args) = @_;</span>
<a name="l00995"></a>00995 <span class="stringliteral">#   my $formatstring = &quot;%l:%M%P on %b %e, %Y&quot;;</span>
<a name="l00996"></a>00996 <span class="stringliteral">#   $formatstring = $args-&gt;{style} if(defined($args-&gt;{style}));</span>
<a name="l00997"></a>00997 <span class="stringliteral">#   return(Date::Format::time2str($formatstring, time()));</span>
<a name="l00998"></a>00998 <span class="stringliteral"># }</span>
<a name="l00999"></a>00999 <span class="stringliteral">sub timestamp {</span>
<a name="l01000"></a>01000 <span class="stringliteral">    my ($self, $args) = @_;</span>
<a name="l01001"></a>01001 <span class="stringliteral">#   my $r = $self-&gt;r;</span>
<a name="l01002"></a>01002 <span class="stringliteral">#   my $ce = $r-&gt;ce;</span>
<a name="l01003"></a>01003 <span class="stringliteral">#   my $tz = $ce-&gt;{siteDefaults}{timezone};</span>
<a name="l01004"></a>01004 <span class="stringliteral">#   warn &quot;testing&quot;, $r, $ce, $tz;</span>
<a name="l01005"></a>01005 <span class="stringliteral">    # need to use the formatDateTime in this file (some subclasses access Util&#39;</span>s version.
<a name="l01006"></a>01006     <span class="keywordflow">return</span>( $self-&gt;formatDateTime( time() ) );
<a name="l01007"></a>01007 }
<a name="l01008"></a>01008 =item message()
<a name="l01009"></a>01009 
<a name="l01010"></a>01010 Defined in this package.
<a name="l01011"></a>01011 
<a name="l01012"></a>01012 Print any messages (error or non-error) resulting from the last form submission.
<a name="l01013"></a>01013 This could be used to give Sucess and Failure messages after an action is performed by a module.
<a name="l01014"></a>01014 
<a name="l01015"></a>01015 The implementation in this package prints the value of the field
<a name="l01016"></a>01016 $self-&gt;{status_message}, <span class="keywordflow">if</span> it is present.
<a name="l01017"></a>01017 
<a name="l01018"></a>01018 =cut
<a name="l01019"></a>01019 
<a name="l01020"></a>01020 sub message {
<a name="l01021"></a>01021     my ($self) = @_;
<a name="l01022"></a>01022     
<a name="l01023"></a>01023     print <span class="stringliteral">&quot;\n&lt;!-- BEGIN &quot;</span> . __PACKAGE__ . <span class="stringliteral">&quot;::message --&gt;\n&quot;</span>;
<a name="l01024"></a>01024     print $self-&gt;{status_message} <span class="keywordflow">if</span> exists $self-&gt;{status_message};
<a name="l01025"></a>01025     
<a name="l01026"></a>01026     print <span class="stringliteral">&quot;&lt;!-- END &quot;</span> . __PACKAGE__ . <span class="stringliteral">&quot;::message --&gt;\n&quot;</span>;
<a name="l01027"></a>01027     
<a name="l01028"></a>01028     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01029"></a>01029 }
<a name="l01030"></a>01030 
<a name="l01031"></a>01031 =item title()
<a name="l01032"></a>01032 
<a name="l01033"></a>01033 Defined in this package.
<a name="l01034"></a>01034 
<a name="l01035"></a>01035 Print the title of the current page.
<a name="l01036"></a>01036 
<a name="l01037"></a>01037 The implementation in this package takes information from the <a class="code" href="classWeBWorK.html">WeBWorK</a>::URLPath
<a name="l01038"></a>01038 associated with the current request.
<a name="l01039"></a>01039 
<a name="l01040"></a>01040 =cut
<a name="l01041"></a>01041 
<a name="l01042"></a>01042 sub title {
<a name="l01043"></a>01043     my ($self, $args) = @_;
<a name="l01044"></a>01044     my $r = $self-&gt;r;
<a name="l01045"></a>01045     
<a name="l01046"></a>01046 <span class="preprocessor">    #print &quot;\n&lt;!-- BEGIN &quot; . __PACKAGE__ . &quot;::title --&gt;\n&quot;;</span>
<a name="l01047"></a>01047 <span class="preprocessor"></span><span class="preprocessor">    #print underscore2nbsp($r-&gt;urlpath-&gt;name);</span>
<a name="l01048"></a>01048 <span class="preprocessor"></span>    my $name = $r-&gt;urlpath-&gt;name;
<a name="l01049"></a>01049 <span class="preprocessor">    # $name =~ s/_/ /g;</span>
<a name="l01050"></a>01050 <span class="preprocessor"></span>    print $name;
<a name="l01051"></a>01051 <span class="preprocessor">    #print &quot;&lt;!-- END &quot; . __PACKAGE__ . &quot;::title --&gt;\n&quot;;</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span>    
<a name="l01053"></a>01053     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01054"></a>01054 }
<a name="l01055"></a>01055 
<a name="l01056"></a>01056 =item warnings()
<a name="l01057"></a>01057 
<a name="l01058"></a>01058 Defined in this package.
<a name="l01059"></a>01059 
<a name="l01060"></a>01060 Print accumulated warnings.
<a name="l01061"></a>01061 
<a name="l01062"></a>01062 The implementation in this package checks for a note in the request named
<a name="l01063"></a>01063 &quot;warnings&quot;. If present, its contents are formatted and returned.
<a name="l01064"></a>01064 
<a name="l01065"></a>01065 =cut
<a name="l01066"></a>01066 
<a name="l01067"></a>01067 sub warnings {
<a name="l01068"></a>01068     my ($self) = @_;
<a name="l01069"></a>01069     my $r = $self-&gt;r;
<a name="l01070"></a>01070     print CGI::p(<span class="stringliteral">&quot;Entering ContentGenerator::warnings&quot;</span>);
<a name="l01071"></a>01071     print <span class="stringliteral">&quot;\n&lt;!-- BEGIN &quot;</span> . __PACKAGE__ . <span class="stringliteral">&quot;::warnings --&gt;\n&quot;</span>;
<a name="l01072"></a>01072     my $warnings = MP2 ? $r-&gt;notes-&gt;get(<span class="stringliteral">&quot;warnings&quot;</span>) : $r-&gt;notes(<span class="stringliteral">&quot;warnings&quot;</span>);
<a name="l01073"></a>01073     print $self-&gt;warningOutput($warnings) <span class="keywordflow">if</span> $warnings;
<a name="l01074"></a>01074     print <span class="stringliteral">&quot;&lt;!-- END &quot;</span> . __PACKAGE__ . <span class="stringliteral">&quot;::warnings --&gt;\n&quot;</span>;
<a name="l01075"></a>01075     
<a name="l01076"></a>01076     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01077"></a>01077 }
<a name="l01078"></a>01078 
<a name="l01079"></a>01079 =item help()
<a name="l01080"></a>01080 
<a name="l01081"></a>01081 Display a link to context-sensitive help. If the argument C&lt;name&gt; is defined,
<a name="l01082"></a>01082 the link will be to the help document for that name. Otherwise the module of the
<a name="l01083"></a>01083 <a class="code" href="classWeBWorK.html">WeBWorK</a>::URLPath node for the current system location will be used.
<a name="l01084"></a>01084 
<a name="l01085"></a>01085 =cut
<a name="l01086"></a>01086 
<a name="l01087"></a>01087 sub help {
<a name="l01088"></a>01088     my $self = shift;
<a name="l01089"></a>01089     my $args = shift;
<a name="l01090"></a>01090     my $name = $args-&gt;{name};
<a name="l01091"></a>01091 
<a name="l01092"></a>01092 <span class="preprocessor">    # old naming scheme</span>
<a name="l01093"></a>01093 <span class="preprocessor"></span><span class="preprocessor">    #$name = lc($self-&gt;r-&gt;urlpath-&gt;name) unless defined($name);</span>
<a name="l01094"></a>01094 <span class="preprocessor"></span><span class="preprocessor">    #$name =~ s/\s/_/g;</span>
<a name="l01095"></a>01095 <span class="preprocessor"></span>
<a name="l01096"></a>01096     $name = $self-&gt;r-&gt;urlpath-&gt;module unless defined($name);
<a name="l01097"></a>01097     $name =~ s/<a class="code" href="classWeBWorK_1_1ContentGenerator.html">WeBWorK::ContentGenerator</a>::<span class="comment">//;</span>
<a name="l01098"></a>01098     $name =~ s/:<span class="comment">//g;</span>
<a name="l01099"></a>01099 
<a name="l01100"></a>01100     $self-&gt;helpMacro($name);
<a name="l01101"></a>01101 }
<a name="l01102"></a>01102 
<a name="l01103"></a>01103 =item url($args)
<a name="l01104"></a>01104 
<a name="l01105"></a>01105 Defined in this package.
<a name="l01106"></a>01106 
<a name="l01107"></a>01107 Returns the specified URL from either %webworkURLs or %courseURLs in the course
<a name="l01108"></a>01108 environment. $args is a reference to a hash containing the following fields:
<a name="l01109"></a>01109 
<a name="l01110"></a>01110  type =&gt; type of URL: webwork|course
<a name="l01111"></a>01111  name =&gt; name of URL (key in URL hash)
<a name="l01112"></a>01112 
<a name="l01113"></a>01113 =cut
<a name="l01114"></a>01114 
<a name="l01115"></a>01115 sub url {
<a name="l01116"></a>01116     my ($self, $args) = @_;
<a name="l01117"></a>01117     my $ce = $self-&gt;r-&gt;ce;
<a name="l01118"></a>01118     my $type = $args-&gt;{type};
<a name="l01119"></a>01119     my $name = $args-&gt;{name};
<a name="l01120"></a>01120     
<a name="l01121"></a>01121     <span class="keywordflow">if</span> ($type eq <span class="stringliteral">&quot;webwork&quot;</span>) {
<a name="l01122"></a>01122         <span class="keywordflow">return</span> $ce-&gt;{webworkURLs}-&gt;{$name};
<a name="l01123"></a>01123     } elsif ($type eq <span class="stringliteral">&quot;course&quot;</span>) {
<a name="l01124"></a>01124         <span class="keywordflow">return</span> $ce-&gt;{courseURLs}-&gt;{$name};
<a name="l01125"></a>01125     } <span class="keywordflow">else</span> {
<a name="l01126"></a>01126         warn __PACKAGE__.<span class="stringliteral">&quot;::url: unrecognized type &#39;$type&#39;.\n&quot;</span>;
<a name="l01127"></a>01127     }
<a name="l01128"></a>01128 }
<a name="l01129"></a>01129 
<a name="l01130"></a>01130 =back
<a name="l01131"></a>01131 
<a name="l01132"></a>01132 =cut
<a name="l01133"></a>01133 
<a name="l01134"></a>01134 <span class="preprocessor"># ------------------------------------------------------------------------------</span>
<a name="l01135"></a>01135 <span class="preprocessor"></span>
<a name="l01136"></a>01136 =head2 Conditional predicates
<a name="l01137"></a>01137 
<a name="l01138"></a>01138 Conditional predicate methods are invoked when the C&lt;#if&gt; escape sequence is
<a name="l01139"></a>01139 encountered in the <span class="keyword">template</span>. If a method named C&lt;if_predicate&gt; is defined in
<a name="l01140"></a>01140 here or in the instantiated subclass, it is invoked.
<a name="l01141"></a>01141 
<a name="l01142"></a>01142 The following predicates are currently defined:
<a name="l01143"></a>01143 
<a name="l01144"></a>01144 =over
<a name="l01145"></a>01145 
<a name="l01146"></a>01146 =item if_can($function)
<a name="l01147"></a>01147 
<a name="l01148"></a>01148 If a function named $function is present in the current content generator (or
<a name="l01149"></a>01149 any superclass), a true value is returned. Otherwise, a false value is returned.
<a name="l01150"></a>01150 
<a name="l01151"></a>01151 The implementation in this package uses the method UNIVERSAL-&gt;can(function) to
<a name="l01152"></a>01152 arrive at the result.
<a name="l01153"></a>01153 
<a name="l01154"></a>01154 A subclass could redefine this method to, for example, &quot;hide&quot; a method from the
<a name="l01155"></a>01155 template:
<a name="l01156"></a>01156 
<a name="l01157"></a>01157  sub if_can {
<a name="l01158"></a>01158     my ($self, $arg) = @_;
<a name="l01159"></a>01159     
<a name="l01160"></a>01160     <span class="keywordflow">if</span> ($arg eq <span class="stringliteral">&quot;floobar&quot;</span>) {
<a name="l01161"></a>01161         <span class="keywordflow">return</span> 0;
<a name="l01162"></a>01162     } <span class="keywordflow">else</span> {
<a name="l01163"></a>01163         <span class="keywordflow">return</span> $self-&gt;SUPER::if_can($arg);
<a name="l01164"></a>01164     }
<a name="l01165"></a>01165  }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167 =cut
<a name="l01168"></a>01168 
<a name="l01169"></a>01169 sub if_can {
<a name="l01170"></a>01170     my ($self, $arg) = @_;
<a name="l01171"></a>01171     
<a name="l01172"></a>01172     <span class="keywordflow">return</span> $self-&gt;can($arg) ? 1 : 0;
<a name="l01173"></a>01173 }
<a name="l01174"></a>01174 
<a name="l01175"></a>01175 =item if_loggedin($arg)
<a name="l01176"></a>01176 
<a name="l01177"></a>01177 If the user is currently logged in, $arg is returned. Otherwise, the inverse of
<a name="l01178"></a>01178 $arg is returned.
<a name="l01179"></a>01179 
<a name="l01180"></a>01180 <span class="preprocessor">#The implementation in this package always returns $arg, since most content</span>
<a name="l01181"></a>01181 <span class="preprocessor"></span><span class="preprocessor">#generators are only reachable when the user is authenticated. It is up to</span>
<a name="l01182"></a>01182 <span class="preprocessor"></span><span class="preprocessor">#classes that can be reached without logging in to override this method and</span>
<a name="l01183"></a>01183 <span class="preprocessor"></span><span class="preprocessor">#provide the correct behavior.</span>
<a name="l01184"></a>01184 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01185"></a>01185 <span class="preprocessor"></span><span class="preprocessor">#This is suboptimal, and may change in the future.</span>
<a name="l01186"></a>01186 <span class="preprocessor"></span>
<a name="l01187"></a>01187 The implementation in <span class="keyword">this</span> <span class="keyword">package </span>uses WeBWorK::Authen::was_verified() to
<a name="l01188"></a>01188 retrieve the result of the last call to WeBWorK::Authen::verify().
<a name="l01189"></a>01189 
<a name="l01190"></a>01190 =cut
<a name="l01191"></a>01191 
<a name="l01192"></a>01192 sub if_loggedin {
<a name="l01193"></a>01193     my ($self, $arg) = @_;
<a name="l01194"></a>01194     
<a name="l01195"></a>01195 <span class="preprocessor">    #return $arg;</span>
<a name="l01196"></a>01196 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0 unless $self-&gt;r-&gt;authen;
<a name="l01197"></a>01197     <span class="keywordflow">return</span> $self-&gt;r-&gt;authen-&gt;was_verified() ? $arg : !$arg;
<a name="l01198"></a>01198 }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 =item if_message($arg)
<a name="l01201"></a>01201 
<a name="l01202"></a>01202 If the last form submission generated a message, $arg is returned. Otherwise, the
<a name="l01203"></a>01203 inverse of $arg is returned.
<a name="l01204"></a>01204 
<a name="l01205"></a>01205 The implementation in this package checks for the field $self-&gt;{status_message} to
<a name="l01206"></a>01206 determine <span class="keywordflow">if</span> a message is present.
<a name="l01207"></a>01207 
<a name="l01208"></a>01208 If a subclass uses some other method to classify submission results, <span class="keyword">this</span> method could be
<a name="l01209"></a>01209 redefined to handle that variance:
<a name="l01210"></a>01210 
<a name="l01211"></a>01211  sub if_message {
<a name="l01212"></a>01212     my ($self, $arg) = @_;
<a name="l01213"></a>01213     
<a name="l01214"></a>01214     my $status = $self-&gt;{processReturnValue};
<a name="l01215"></a>01215     <span class="keywordflow">if</span> ($status != 0) {
<a name="l01216"></a>01216         <span class="keywordflow">return</span> $arg;
<a name="l01217"></a>01217     } <span class="keywordflow">else</span> {
<a name="l01218"></a>01218         <span class="keywordflow">return</span> !$arg;
<a name="l01219"></a>01219     }
<a name="l01220"></a>01220  }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222 =cut
<a name="l01223"></a>01223 
<a name="l01224"></a>01224 sub if_message {
<a name="l01225"></a>01225     my ($self, $arg) = @_;
<a name="l01226"></a>01226     
<a name="l01227"></a>01227     <span class="keywordflow">if</span> (exists $self-&gt;{status_message}) {
<a name="l01228"></a>01228         <span class="keywordflow">return</span> $arg;
<a name="l01229"></a>01229     } <span class="keywordflow">else</span> {
<a name="l01230"></a>01230         <span class="keywordflow">return</span> !$arg;
<a name="l01231"></a>01231     }
<a name="l01232"></a>01232 }
<a name="l01233"></a>01233 
<a name="l01234"></a>01234 =item if_warnings
<a name="l01235"></a>01235 
<a name="l01236"></a>01236 If warnings have been emitted <span class="keywordflow">while</span> handling <span class="keyword">this</span> request, $arg is returned.
<a name="l01237"></a>01237 Otherwise, the inverse of $arg is returned.
<a name="l01238"></a>01238 
<a name="l01239"></a>01239 The implementation in <span class="keyword">this</span> <span class="keyword">package </span>checks for a note in the request named
<a name="l01240"></a>01240 &quot;warnings&quot;. This is set by the WARN handler in Apache::WeBWorK when a warning is
<a name="l01241"></a>01241 handled.
<a name="l01242"></a>01242 
<a name="l01243"></a>01243 =cut
<a name="l01244"></a>01244 
<a name="l01245"></a>01245 sub if_warnings {
<a name="l01246"></a>01246     my ($self, $arg) = @_;
<a name="l01247"></a>01247     my $r = $self-&gt;r;
<a name="l01248"></a>01248 
<a name="l01249"></a>01249     <span class="keywordflow">if</span> ( (MP2 ? $r-&gt;notes-&gt;get(<span class="stringliteral">&quot;warnings&quot;</span>) : $r-&gt;notes(<span class="stringliteral">&quot;warnings&quot;</span>)) 
<a name="l01250"></a>01250          or ($self-&gt;{pgerrors}) )  
<a name="l01251"></a>01251     {
<a name="l01252"></a>01252         <span class="keywordflow">return</span> $arg;
<a name="l01253"></a>01253     } <span class="keywordflow">else</span> {
<a name="l01254"></a>01254         !$arg;
<a name="l01255"></a>01255     }
<a name="l01256"></a>01256 }
<a name="l01257"></a>01257 
<a name="l01258"></a>01258 =back
<a name="l01259"></a>01259 
<a name="l01260"></a>01260 =cut
<a name="l01261"></a>01261 
<a name="l01262"></a>01262 <span class="preprocessor">################################################################################</span>
<a name="l01263"></a>01263 <span class="preprocessor"></span>
<a name="l01264"></a>01264 =head1 <a class="code" href="classWeBWorK_1_1HTML.html">HTML</a> MACROS
<a name="l01265"></a>01265 
<a name="l01266"></a>01266 Various routines are defined in <span class="keyword">this</span> <span class="keyword">package </span>for rendering common WeBWorK
<a name="l01267"></a>01267 idioms.
<a name="l01268"></a>01268 
<a name="l01269"></a>01269 FIXME: some of these should be moved to WeBWorK::HTML:: modules!
<a name="l01270"></a>01270 
<a name="l01271"></a>01271 # ------------------------------------------------------------------------------
<a name="l01272"></a>01272 
<a name="l01273"></a>01273 =head2 Template escape handler macros
<a name="l01274"></a>01274 
<a name="l01275"></a>01275 These methods are used by implementations of the escape sequence handlers to
<a name="l01276"></a>01276 maintain a consistent style.
<a name="l01277"></a>01277 
<a name="l01278"></a>01278 =over
<a name="l01279"></a>01279 
<a name="l01280"></a>01280 =item pathMacro($args, @path)
<a name="l01281"></a>01281 
<a name="l01282"></a>01282 Helper macro for the C&lt;#path&gt; escape sequence: $args is a hash reference
<a name="l01283"></a>01283 containing the &quot;style&quot;, &quot;image&quot;, &quot;text&quot;, and &quot;textonly&quot; arguments to the escape.
<a name="l01284"></a>01284 @path consists of ordered key-value pairs of the form:
<a name="l01285"></a>01285 
<a name="l01286"></a>01286  &quot;Page Name&quot; =&gt; URL
<a name="l01287"></a>01287 
<a name="l01288"></a>01288 If the page should not have a link associated with it, the URL should be left
<a name="l01289"></a>01289 empty. Authentication data is added to each URL so you don&#39;t have to. A fully-
<a name="l01290"></a>01290 formed path line is returned, suitable for returning by a function implementing
<a name="l01291"></a>01291 the C&lt;#path&gt; escape.
<a name="l01292"></a>01292 
<a name="l01293"></a>01293 FIXME: authentication data probably shouldn&#39;t be added here any more, now that
<a name="l01294"></a>01294 we have systemLink().
<a name="l01295"></a>01295 
<a name="l01296"></a>01296 =cut
<a name="l01297"></a>01297 
<a name="l01298"></a>01298 sub pathMacro {
<a name="l01299"></a>01299     my ($self, $args, @path) = @_;
<a name="l01300"></a>01300     my $r = $self-&gt;r;
<a name="l01301"></a>01301     my %args = %$args;
<a name="l01302"></a>01302     $args{style} = <span class="stringliteral">&quot;text&quot;</span> <span class="keywordflow">if</span> $args{textonly};
<a name="l01303"></a>01303     
<a name="l01304"></a>01304     my $auth = $self-&gt;url_authen_args;
<a name="l01305"></a>01305     my $sep;
<a name="l01306"></a>01306     <span class="keywordflow">if</span> ($args{style} eq <span class="stringliteral">&quot;image&quot;</span>) {
<a name="l01307"></a>01307         $sep = CGI::img({-src=&gt;$args{image}, -alt=&gt;$args{text}});
<a name="l01308"></a>01308     } <span class="keywordflow">else</span> {
<a name="l01309"></a>01309         $sep = $args{text};
<a name="l01310"></a>01310     }
<a name="l01311"></a>01311     
<a name="l01312"></a>01312     my @result;
<a name="l01313"></a>01313     <span class="keywordflow">while</span> (@path) {
<a name="l01314"></a>01314         my $name = shift @path;
<a name="l01315"></a>01315         my $url = shift @path;
<a name="l01316"></a>01316         <span class="keywordflow">if</span> ($url and not $args{textonly}) {
<a name="l01317"></a>01317             push @result, CGI::a({-href=&gt;<span class="stringliteral">&quot;$url?$auth&quot;</span>}, $r-&gt;maketext(lc($name)));
<a name="l01318"></a>01318         } <span class="keywordflow">else</span> {
<a name="l01319"></a>01319             push @result, $r-&gt;maketext($name);
<a name="l01320"></a>01320         }
<a name="l01321"></a>01321     }
<a name="l01322"></a>01322     
<a name="l01323"></a>01323     <span class="keywordflow">return</span> join($sep, @result), <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01324"></a>01324 }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326 =item siblingsMacro(@siblings)
<a name="l01327"></a>01327 
<a name="l01328"></a>01328 Helper macro for the C&lt;<span class="preprocessor">#siblings&gt; escape sequence. @siblings consists of ordered</span>
<a name="l01329"></a>01329 <span class="preprocessor"></span>key-value pairs of the form:
<a name="l01330"></a>01330 
<a name="l01331"></a>01331  <span class="stringliteral">&quot;Sibling Name&quot;</span> =&gt; URL
<a name="l01332"></a>01332 
<a name="l01333"></a>01333 If the sibling should not have a link associated with it, the URL should be left
<a name="l01334"></a>01334 empty. Authentication data is added to each URL so you don<span class="stringliteral">&#39;t have to. A fully-</span>
<a name="l01335"></a>01335 <span class="stringliteral">formed siblings block is returned, suitable for returning by a function</span>
<a name="l01336"></a>01336 <span class="stringliteral">implementing the C&lt;#siblings&gt; escape.</span>
<a name="l01337"></a>01337 <span class="stringliteral"></span>
<a name="l01338"></a>01338 <span class="stringliteral">FIXME: authentication data probably shouldn&#39;</span>t be added here any more, now that
<a name="l01339"></a>01339 we have systemLink().
<a name="l01340"></a>01340 
<a name="l01341"></a>01341 =cut
<a name="l01342"></a>01342 
<a name="l01343"></a>01343 sub siblingsMacro {
<a name="l01344"></a>01344     my ($self, @siblings) = @_;
<a name="l01345"></a>01345     
<a name="l01346"></a>01346     my $auth = $self-&gt;url_authen_args;
<a name="l01347"></a>01347     my $sep = CGI::br();
<a name="l01348"></a>01348     
<a name="l01349"></a>01349     my @result;
<a name="l01350"></a>01350     <span class="keywordflow">while</span> (@siblings) {
<a name="l01351"></a>01351         my $name = shift @siblings;
<a name="l01352"></a>01352         my $url = shift @siblings;
<a name="l01353"></a>01353         my $id = $name;
<a name="l01354"></a>01354         $id =~ s/\W/\_/g;
<a name="l01355"></a>01355         push @result, $url
<a name="l01356"></a>01356             ? CGI::span( {<span class="keywordtype">id</span>=&gt;$id}, CGI::a({-href=&gt;<span class="stringliteral">&quot;$url?$auth&quot;</span>}, $name) )
<a name="l01357"></a>01357             : CGI::span( {<span class="keywordtype">id</span>=&gt;$id},$name );
<a name="l01358"></a>01358     }
<a name="l01359"></a>01359     
<a name="l01360"></a>01360     <span class="keywordflow">return</span> join($sep, @result) . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01361"></a>01361 }
<a name="l01362"></a>01362 
<a name="l01363"></a>01363 
<a name="l01364"></a>01364 
<a name="l01365"></a>01365 =item navMacro($args, $tail, @links)
<a name="l01366"></a>01366 
<a name="l01367"></a>01367 Helper macro for the C&lt;<span class="preprocessor">#nav&gt; escape sequence: $args is a hash reference</span>
<a name="l01368"></a>01368 <span class="preprocessor"></span>containing the <span class="stringliteral">&quot;style&quot;</span>, <span class="stringliteral">&quot;imageprefix&quot;</span>, <span class="stringliteral">&quot;imagesuffix&quot;</span>, and <span class="stringliteral">&quot;separator&quot;</span> arguments
<a name="l01369"></a>01369 to the escape. @siblings consists of ordered tuples of the form:
<a name="l01370"></a>01370 
<a name="l01371"></a>01371  <span class="stringliteral">&quot;Link Name&quot;</span>, URL, ImageBaseName
<a name="l01372"></a>01372 
<a name="l01373"></a>01373 If the sibling should not have a link associated with it, the URL should be left
<a name="l01374"></a>01374 empty. ImageBaseName is placed between the C&lt;imageprefix&gt; and C&lt;imagesuffix&gt;.
<a name="l01375"></a>01375 Authentication data is added to each URL so you don<span class="stringliteral">&#39;t have to. $tail is appended</span>
<a name="l01376"></a>01376 <span class="stringliteral">to each URL, after the authentication information. A fully-formed nav line is</span>
<a name="l01377"></a>01377 <span class="stringliteral">returned, suitable for returning by a function implementing the C&lt;#nav&gt; escape.</span>
<a name="l01378"></a>01378 <span class="stringliteral"></span>
<a name="l01379"></a>01379 <span class="stringliteral">=cut</span>
<a name="l01380"></a>01380 <span class="stringliteral"></span>
<a name="l01381"></a>01381 <span class="stringliteral">sub navMacro {</span>
<a name="l01382"></a>01382 <span class="stringliteral">    my ($self, $args, $tail, @links) = @_;</span>
<a name="l01383"></a>01383 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l01384"></a>01384 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l01385"></a>01385 <span class="stringliteral">    my %args = %$args;</span>
<a name="l01386"></a>01386 <span class="stringliteral"></span>
<a name="l01387"></a>01387 <span class="stringliteral">    my $auth = $self-&gt;url_authen_args;</span>
<a name="l01388"></a>01388 <span class="stringliteral">    my $prefix = $ce-&gt;{webworkURLs}-&gt;{htdocs}.&quot;/images&quot;;</span>
<a name="l01389"></a>01389 <span class="stringliteral"></span>
<a name="l01390"></a>01390 <span class="stringliteral">    my @result;</span>
<a name="l01391"></a>01391 <span class="stringliteral">    while (@links) {</span>
<a name="l01392"></a>01392 <span class="stringliteral">        my $name = shift @links;</span>
<a name="l01393"></a>01393 <span class="stringliteral">        my $url = shift @links;</span>
<a name="l01394"></a>01394 <span class="stringliteral">        my $direction = shift @links;</span>
<a name="l01395"></a>01395 <span class="stringliteral">        my $html = ($direction &amp;&amp; $args{style} eq &quot;buttons&quot;) ? $direction : $name;</span>
<a name="l01396"></a>01396 <span class="stringliteral">            # ($img &amp;&amp; $args{style} eq &quot;images&quot;)</span>
<a name="l01397"></a>01397 <span class="stringliteral">            # ? CGI::img(</span>
<a name="l01398"></a>01398 <span class="stringliteral">                # {src=&gt;($prefix.&quot;/&quot;.$img.$args{imagesuffix}),</span>
<a name="l01399"></a>01399 <span class="stringliteral">                # border=&gt;&quot;&quot;,</span>
<a name="l01400"></a>01400 <span class="stringliteral">                # alt=&gt;&quot;$name&quot;})</span>
<a name="l01401"></a>01401 <span class="stringliteral">            # : $name.&quot;lol&quot;;</span>
<a name="l01402"></a>01402 <span class="stringliteral">#       unless($img &amp;&amp; !$url) {  ## these are now &quot;disabled&quot; versions in grey -- DPVC</span>
<a name="l01403"></a>01403 <span class="stringliteral">            push @result, $url</span>
<a name="l01404"></a>01404 <span class="stringliteral">                ? CGI::a({-href=&gt;&quot;$url?$auth$tail&quot;, -class=&gt;&quot;nav_button&quot;}, $html)</span>
<a name="l01405"></a>01405 <span class="stringliteral">                : CGI::span({-class=&gt;&quot;gray_button&quot;}, $html);</span>
<a name="l01406"></a>01406 <span class="stringliteral">#       }</span>
<a name="l01407"></a>01407 <span class="stringliteral">    }</span>
<a name="l01408"></a>01408 <span class="stringliteral"></span>
<a name="l01409"></a>01409 <span class="stringliteral">    return join($args{separator}, @result) . &quot;\n&quot;;</span>
<a name="l01410"></a>01410 <span class="stringliteral">}</span>
<a name="l01411"></a>01411 <span class="stringliteral"></span>
<a name="l01412"></a>01412 <span class="stringliteral">=item helpMacro($name)</span>
<a name="l01413"></a>01413 <span class="stringliteral"></span>
<a name="l01414"></a>01414 <span class="stringliteral">This escape is represented by a question mark which links to an html page in the</span>
<a name="l01415"></a>01415 <span class="stringliteral">helpFiles  directory.  Currently the link is made to the file $name.html</span>
<a name="l01416"></a>01416 <span class="stringliteral"></span>
<a name="l01417"></a>01417 <span class="stringliteral">=cut</span>
<a name="l01418"></a>01418 <span class="stringliteral"></span>
<a name="l01419"></a>01419 <span class="stringliteral">sub helpMacro {</span>
<a name="l01420"></a>01420 <span class="stringliteral">    my $self = shift;</span>
<a name="l01421"></a>01421 <span class="stringliteral">    my $name = shift;</span>
<a name="l01422"></a>01422 <span class="stringliteral">    my $label  = shift; #optional</span>
<a name="l01423"></a>01423 <span class="stringliteral">    my $ce   = $self-&gt;r-&gt;ce;</span>
<a name="l01424"></a>01424 <span class="stringliteral">    my $basePath = $ce-&gt;{webworkDirs}-&gt;{local_help};</span>
<a name="l01425"></a>01425 <span class="stringliteral">    $name        = &#39;</span>no_help<span class="stringliteral">&#39; unless -e &quot;$basePath/$name.html&quot;;</span>
<a name="l01426"></a>01426 <span class="stringliteral">    my $path     = &quot;$basePath/$name.html&quot;;</span>
<a name="l01427"></a>01427 <span class="stringliteral">    my $url = $ce-&gt;{webworkURLs}-&gt;{local_help}.&quot;/$name.html&quot;;</span>
<a name="l01428"></a>01428 <span class="stringliteral">    my $imageURL = $ce-&gt;{webworkURLs}-&gt;{htdocs}.&quot;/images/question_mark.png&quot;;</span>
<a name="l01429"></a>01429 <span class="stringliteral">    $label    = CGI::img({src=&gt;$imageURL, alt=&gt;&quot; ? &quot;}) unless defined $label;</span>
<a name="l01430"></a>01430 <span class="stringliteral">    return CGI::a({href      =&gt; $url,</span>
<a name="l01431"></a>01431 <span class="stringliteral">                   target    =&gt; &#39;</span>ww_help<span class="stringliteral">&#39;,</span>
<a name="l01432"></a>01432 <span class="stringliteral">                   onclick   =&gt; &quot;window.open(this.href,this.target,&#39;</span>width=550,height=350,scrollbars=yes,resizable=yes<span class="stringliteral">&#39;)&quot;},</span>
<a name="l01433"></a>01433 <span class="stringliteral">                   $label);</span>
<a name="l01434"></a>01434 <span class="stringliteral">}</span>
<a name="l01435"></a>01435 <span class="stringliteral"></span>
<a name="l01436"></a>01436 <span class="stringliteral">=item optionsMacro(options_to_show =&gt; \@options_to_show, extra_params =&gt; \@extra_params)</span>
<a name="l01437"></a>01437 <span class="stringliteral"></span>
<a name="l01438"></a>01438 <span class="stringliteral">Helper macro for displaying the View Options panel.</span>
<a name="l01439"></a>01439 <span class="stringliteral"></span>
<a name="l01440"></a>01440 <span class="stringliteral">@options_to_show lists the options to show, from among this list &quot;displayMode&quot;,</span>
<a name="l01441"></a>01441 <span class="stringliteral">&quot;showOldAnswers&quot;, &quot;showHints&quot;, &quot;showSolutions&quot;. If no options are given,</span>
<a name="l01442"></a>01442 <span class="stringliteral">&quot;displayMode&quot; is assumed.</span>
<a name="l01443"></a>01443 <span class="stringliteral"></span>
<a name="l01444"></a>01444 <span class="stringliteral">@extraParams is dereferenced and passed to the hidden_fields() method. Use this</span>
<a name="l01445"></a>01445 <span class="stringliteral">to preserve state from the content generator calling optionsMacro().</span>
<a name="l01446"></a>01446 <span class="stringliteral"></span>
<a name="l01447"></a>01447 <span class="stringliteral">This macro is intended to be called from an implementation of the options()</span>
<a name="l01448"></a>01448 <span class="stringliteral">method. The simplest way to to this is:</span>
<a name="l01449"></a>01449 <span class="stringliteral"></span>
<a name="l01450"></a>01450 <span class="stringliteral"> sub options { shift-&gt;optionsMacro }</span>
<a name="l01451"></a>01451 <span class="stringliteral"></span>
<a name="l01452"></a>01452 <span class="stringliteral">=cut</span>
<a name="l01453"></a>01453 <span class="stringliteral"></span>
<a name="l01454"></a>01454 <span class="stringliteral">sub optionsMacro {</span>
<a name="l01455"></a>01455 <span class="stringliteral">    my ($self, %options) = @_;</span>
<a name="l01456"></a>01456 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l01457"></a>01457 <span class="stringliteral">    </span>
<a name="l01458"></a>01458 <span class="stringliteral">    my @options_to_show = @{$options{options_to_show}} if exists $options{options_to_show};</span>
<a name="l01459"></a>01459 <span class="stringliteral">    @options_to_show = &quot;displayMode&quot; unless @options_to_show;  #FIXME -- I don&#39;</span>t understant <span class="keyword">this</span> -- type seems wrong
<a name="l01460"></a>01460     my %options_to_show; @options_to_show{@options_to_show} = (); # make hash <span class="keywordflow">for</span> easy lookups
<a name="l01461"></a>01461     my @extra_params = @{$options{extra_params}} <span class="keywordflow">if</span> exists $options{extra_params};
<a name="l01462"></a>01462     
<a name="l01463"></a>01463     print CGI::h2($r-&gt;maketext(<span class="stringliteral">&quot;Display Options&quot;</span>));
<a name="l01464"></a>01464     
<a name="l01465"></a>01465     my $result = CGI::start_form(<span class="stringliteral">&quot;POST&quot;</span>, $self-&gt;r-&gt;uri);
<a name="l01466"></a>01466     $result .= $self-&gt;hidden_authen_fields;
<a name="l01467"></a>01467     $result .= $self-&gt;hidden_fields(@extra_params) <span class="keywordflow">if</span> @extra_params;
<a name="l01468"></a>01468     $result .= CGI::start_div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;viewOptions&quot;</span>});
<a name="l01469"></a>01469     
<a name="l01470"></a>01470     <span class="keywordflow">if</span> (exists $options_to_show{displayMode}) {
<a name="l01471"></a>01471         my $curr_displayMode = $self-&gt;r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>) || $self-&gt;r-&gt;ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};
<a name="l01472"></a>01472         my %display_modes = %{WeBWorK::PG::DISPLAY_MODES()};
<a name="l01473"></a>01473         my @active_modes = grep { exists $display_modes{$_} } @{$self-&gt;r-&gt;ce-&gt;{pg}-&gt;{displayModes}};
<a name="l01474"></a>01474         <span class="keywordflow">if</span> (@active_modes &gt; 1) {
<a name="l01475"></a>01475             $result .= <span class="stringliteral">&quot;View&amp;nbsp;equations&amp;nbsp;as:&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&quot;</span>;
<a name="l01476"></a>01476             $result .= CGI::br();
<a name="l01477"></a>01477             $result .= CGI::radio_group(
<a name="l01478"></a>01478                 -name =&gt; <span class="stringliteral">&quot;displayMode&quot;</span>,
<a name="l01479"></a>01479                 -values =&gt; \@active_modes,
<a name="l01480"></a>01480                 -<span class="keywordflow">default</span> =&gt; $curr_displayMode,
<a name="l01481"></a>01481                 -linebreak=&gt;<span class="stringliteral">&#39;true&#39;</span>,
<a name="l01482"></a>01482             );
<a name="l01483"></a>01483             $result .= CGI::br();
<a name="l01484"></a>01484         }
<a name="l01485"></a>01485     }
<a name="l01486"></a>01486     
<a name="l01487"></a>01487     <span class="keywordflow">if</span> (exists $options_to_show{showOldAnswers}) {
<a name="l01488"></a>01488 <span class="preprocessor">        # Note, 0 is a legal value, so we can&#39;t use || in setting this</span>
<a name="l01489"></a>01489 <span class="preprocessor"></span>        my $curr_showOldAnswers = defined($self-&gt;r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>)) ?
<a name="l01490"></a>01490             $self-&gt;r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>) : $self-&gt;r-&gt;ce-&gt;{pg}-&gt;{options}-&gt;{showOldAnswers};
<a name="l01491"></a>01491         $result .= <span class="stringliteral">&quot;Show&amp;nbsp;saved&amp;nbsp;answers?&quot;</span>;
<a name="l01492"></a>01492         $result .= CGI::br();
<a name="l01493"></a>01493         $result .= CGI::radio_group(
<a name="l01494"></a>01494             -name =&gt; <span class="stringliteral">&quot;showOldAnswers&quot;</span>,
<a name="l01495"></a>01495             -values =&gt; [1,0],
<a name="l01496"></a>01496             -<span class="keywordflow">default</span> =&gt; $curr_showOldAnswers,
<a name="l01497"></a>01497             -labels =&gt; { 0=&gt;<span class="stringliteral">&#39;No&#39;</span>, 1=&gt;<span class="stringliteral">&#39;Yes&#39;</span> },
<a name="l01498"></a>01498         );
<a name="l01499"></a>01499         $result .= CGI::br();
<a name="l01500"></a>01500     }
<a name="l01501"></a>01501     
<a name="l01502"></a>01502     $result .= CGI::submit(-name=&gt;<span class="stringliteral">&quot;redisplay&quot;</span>, -label=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Apply Options&quot;</span>));
<a name="l01503"></a>01503     $result .= CGI::end_div();
<a name="l01504"></a>01504     $result .= CGI::end_form();
<a name="l01505"></a>01505     
<a name="l01506"></a>01506     <span class="keywordflow">return</span> $result;
<a name="l01507"></a>01507 }
<a name="l01508"></a>01508 
<a name="l01509"></a>01509 =item feedbackMacro(%params)
<a name="l01510"></a>01510 
<a name="l01511"></a>01511 Helper macro for displaying the feedback form. Returns a button named &quot;Email
<a name="l01512"></a>01512 Instructor&quot;. %params contains the request parameters accepted by the Feedback
<a name="l01513"></a>01513 module and their values.
<a name="l01514"></a>01514 
<a name="l01515"></a>01515 =cut
<a name="l01516"></a>01516 
<a name="l01517"></a>01517 sub feedbackMacro {
<a name="l01518"></a>01518     my ($self, %params) = @_;
<a name="l01519"></a>01519     my $r = $self-&gt;r;
<a name="l01520"></a>01520     my $authz = $r-&gt;authz;
<a name="l01521"></a>01521     my $userID = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l01522"></a>01522     
<a name="l01523"></a>01523 <span class="preprocessor">    # don&#39;t do anything unless the user has permission to</span>
<a name="l01524"></a>01524 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless $authz-&gt;hasPermissions($userID, <span class="stringliteral">&quot;submit_feedback&quot;</span>);
<a name="l01525"></a>01525     
<a name="l01526"></a>01526     my $feedbackURL = $r-&gt;ce-&gt;{courseURLs}{feedbackURL};
<a name="l01527"></a>01527     my $feedbackFormURL = $r-&gt;ce-&gt;{courseURLs}{feedbackFormURL};
<a name="l01528"></a>01528     <span class="keywordflow">if</span> (defined $feedbackURL and $feedbackURL ne <span class="stringliteral">&quot;&quot;</span>) {
<a name="l01529"></a>01529         <span class="keywordflow">return</span> $self-&gt;feedbackMacro_url($feedbackURL);
<a name="l01530"></a>01530     } elsif (defined $feedbackFormURL and $feedbackFormURL ne <span class="stringliteral">&quot;&quot;</span>) {
<a name="l01531"></a>01531         <span class="keywordflow">return</span> $self-&gt;feedbackMacro_form($feedbackFormURL,%params);
<a name="l01532"></a>01532     } <span class="keywordflow">else</span> {
<a name="l01533"></a>01533         <span class="keywordflow">return</span> $self-&gt;feedbackMacro_email(%params);
<a name="l01534"></a>01534     }
<a name="l01535"></a>01535 }
<a name="l01536"></a>01536 
<a name="l01537"></a>01537 sub feedbackMacro_email {
<a name="l01538"></a>01538     my ($self, %params) = @_;
<a name="l01539"></a>01539     my $r = $self-&gt;r;
<a name="l01540"></a>01540     my $ce = $r-&gt;ce;
<a name="l01541"></a>01541     my $urlpath = $r-&gt;urlpath;
<a name="l01542"></a>01542     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l01543"></a>01543     
<a name="l01544"></a>01544 <span class="preprocessor">    # feedback form url</span>
<a name="l01545"></a>01545 <span class="preprocessor"></span>    my $feedbackPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Feedback&quot;</span>,  $r, courseID =&gt; $courseID);
<a name="l01546"></a>01546     my $feedbackURL = $self-&gt;systemLink($feedbackPage, authen =&gt; 0); # no authen info <span class="keywordflow">for</span> form action
<a name="l01547"></a>01547     my $feedbackName = $r-&gt;maketext($ce-&gt;{feedback_button_name}) || $r-&gt;maketext(<span class="stringliteral">&quot;Email instructor&quot;</span>);
<a name="l01548"></a>01548     
<a name="l01549"></a>01549     my $result = CGI::start_form(-method=&gt;<span class="stringliteral">&quot;POST&quot;</span>, -action=&gt;$feedbackURL) . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01550"></a>01550     $result .= $self-&gt;hidden_authen_fields . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01551"></a>01551     
<a name="l01552"></a>01552     <span class="keywordflow">while</span> (my ($key, $value) = each %params) {
<a name="l01553"></a>01553         next <span class="keywordflow">if</span> $key eq <span class="stringliteral">&#39;pg_object&#39;</span>;    # not used in <span class="keyword">internal</span> feedback mechanism
<a name="l01554"></a>01554         $result .= CGI::hidden($key, $value) . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01555"></a>01555     }
<a name="l01556"></a>01556     $result .= CGI::p({-align=&gt;<span class="stringliteral">&quot;left&quot;</span>}, CGI::submit(-name=&gt;<span class="stringliteral">&quot;feedbackForm&quot;</span>, -value=&gt;$feedbackName));
<a name="l01557"></a>01557     $result .= CGI::endform() . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01558"></a>01558     
<a name="l01559"></a>01559     <span class="keywordflow">return</span> $result;
<a name="l01560"></a>01560 }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562 sub feedbackMacro_form {
<a name="l01563"></a>01563     my ($self, $feedbackFormURL, %params) = @_;
<a name="l01564"></a>01564     my $r = $self-&gt;r;
<a name="l01565"></a>01565     my $ce = $r-&gt;ce;
<a name="l01566"></a>01566     my $urlpath = $r-&gt;urlpath;
<a name="l01567"></a>01567     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l01568"></a>01568     
<a name="l01569"></a>01569 <span class="preprocessor">    # feedback form url</span>
<a name="l01570"></a>01570 <span class="preprocessor"></span>    my $feedbackName = $r-&gt;maketext($ce-&gt;{feedback_button_name}) || $r-&gt;maketext(<span class="stringliteral">&quot;Email instructor&quot;</span>);
<a name="l01571"></a>01571     
<a name="l01572"></a>01572     my $result = CGI::start_form(-method=&gt;<span class="stringliteral">&quot;POST&quot;</span>, -action=&gt;$feedbackFormURL,-target=&gt;<span class="stringliteral">&quot;WW_info&quot;</span>) . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01573"></a>01573     $result .= $self-&gt;hidden_authen_fields . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01574"></a>01574     
<a name="l01575"></a>01575     <span class="keywordflow">while</span> (my ($key, $value) = each %params) {
<a name="l01576"></a>01576         <span class="keywordflow">if</span> ($key eq <span class="stringliteral">&#39;pg_object&#39;</span>) {
<a name="l01577"></a>01577             my $tmp = $value-&gt;{body_text}; 
<a name="l01578"></a>01578             $tmp .= CGI::p(CGI::b(<span class="stringliteral">&quot;Note: &quot;</span>). CGI::i($value-&gt;{result}-&gt;{msg})) if $value-&gt;{result}-&gt;{msg} ;
<a name="l01579"></a>01579             $result .= CGI::hidden($key, encode_base64($tmp, <span class="stringliteral">&quot;&quot;</span>) );
<a name="l01580"></a>01580         } <span class="keywordflow">else</span> {
<a name="l01581"></a>01581             $result .= CGI::hidden($key, $value) . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01582"></a>01582         }
<a name="l01583"></a>01583     }
<a name="l01584"></a>01584     $result .= CGI::p({-align=&gt;<span class="stringliteral">&quot;left&quot;</span>}, CGI::submit(-name=&gt;<span class="stringliteral">&quot;feedbackForm&quot;</span>, -value=&gt;$feedbackName));
<a name="l01585"></a>01585     $result .= CGI::endform() . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01586"></a>01586     
<a name="l01587"></a>01587     <span class="keywordflow">return</span> $result;
<a name="l01588"></a>01588 }
<a name="l01589"></a>01589 
<a name="l01590"></a>01590 sub feedbackMacro_url {
<a name="l01591"></a>01591     my ($self, $url) = @_;
<a name="l01592"></a>01592     my $r = $self-&gt;r;
<a name="l01593"></a>01593     my $feedbackName = $r-&gt;maketext($r-&gt;ce-&gt;{feedback_button_name}) || $r-&gt;maketext(<span class="stringliteral">&quot;Email instructor&quot;</span>);
<a name="l01594"></a>01594     <span class="keywordflow">return</span> CGI::a({-href=&gt;$url}, $feedbackName);
<a name="l01595"></a>01595 }
<a name="l01596"></a>01596 
<a name="l01597"></a>01597 =back
<a name="l01598"></a>01598 
<a name="l01599"></a>01599 =cut
<a name="l01600"></a>01600 
<a name="l01601"></a>01601 <span class="preprocessor"># ------------------------------------------------------------------------------</span>
<a name="l01602"></a>01602 <span class="preprocessor"></span>
<a name="l01603"></a>01603 =head2 Parameter management
<a name="l01604"></a>01604 
<a name="l01605"></a>01605 Methods <span class="keywordflow">for</span> formatting request parameters as hidden form fields or query <span class="keywordtype">string</span>
<a name="l01606"></a>01606 fragments.
<a name="l01607"></a>01607 
<a name="l01608"></a>01608 =over
<a name="l01609"></a>01609 
<a name="l01610"></a>01610 =item hidden_fields(@fields)
<a name="l01611"></a>01611 
<a name="l01612"></a>01612 Return hidden &lt;INPUT&gt; tags for each field mentioned in @fields (or all fields if
<a name="l01613"></a>01613 list is empty), taking data from the current request.
<a name="l01614"></a>01614 
<a name="l01615"></a>01615 =cut
<a name="l01616"></a>01616 
<a name="l01617"></a>01617 sub hidden_fields {
<a name="l01618"></a>01618     my ($self, @fields) = @_;
<a name="l01619"></a>01619     my $r = $self-&gt;r;
<a name="l01620"></a>01620     
<a name="l01621"></a>01621     @fields = $r-&gt;param unless @fields;
<a name="l01622"></a>01622     
<a name="l01623"></a>01623     my $html = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01624"></a>01624     <span class="keywordflow">foreach</span> my $param (@fields) {
<a name="l01625"></a>01625 <span class="preprocessor">#       my @values = $r-&gt;param($param);</span>
<a name="l01626"></a>01626 <span class="preprocessor"></span><span class="preprocessor">#       $html .= CGI::hidden($param, @values);  #MEG</span>
<a name="l01627"></a>01627 <span class="preprocessor"></span><span class="preprocessor">#        warn &quot;$param &quot;, join(&quot; &quot;, @values) if @values &gt;1; #this should never happen!!!</span>
<a name="l01628"></a>01628 <span class="preprocessor"></span>        my $value  = $r-&gt;param($param);
<a name="l01629"></a>01629 <span class="preprocessor">#       $html .= CGI::hidden($param, $value); # (can&#39;t name these items when using real CGI) </span>
<a name="l01630"></a>01630 <span class="preprocessor"></span>        $html .= CGI::hidden(-name=&gt;$param, -<span class="keywordflow">default</span>=&gt;$value, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;hidden_&quot;</span>.$param); # (can<span class="stringliteral">&#39;t name these items when using real CGI) </span>
<a name="l01631"></a>01631 <span class="stringliteral"></span>
<a name="l01632"></a>01632 <span class="stringliteral">    }</span>
<a name="l01633"></a>01633 <span class="stringliteral">    return $html;</span>
<a name="l01634"></a>01634 <span class="stringliteral">}</span>
<a name="l01635"></a>01635 <span class="stringliteral"></span>
<a name="l01636"></a>01636 <span class="stringliteral">=item hidden_authen_fields()</span>
<a name="l01637"></a>01637 <span class="stringliteral"></span>
<a name="l01638"></a>01638 <span class="stringliteral">Use hidden_fields to return hidden &lt;INPUT&gt; tags for request fields used in</span>
<a name="l01639"></a>01639 <span class="stringliteral">authentication.</span>
<a name="l01640"></a>01640 <span class="stringliteral"></span>
<a name="l01641"></a>01641 <span class="stringliteral">=cut</span>
<a name="l01642"></a>01642 <span class="stringliteral"></span>
<a name="l01643"></a>01643 <span class="stringliteral">sub hidden_authen_fields {</span>
<a name="l01644"></a>01644 <span class="stringliteral">    my ($self) = @_;</span>
<a name="l01645"></a>01645 <span class="stringliteral">    </span>
<a name="l01646"></a>01646 <span class="stringliteral">    return $self-&gt;hidden_fields(&quot;user&quot;, &quot;effectiveUser&quot;, &quot;key&quot;, &quot;theme&quot;);</span>
<a name="l01647"></a>01647 <span class="stringliteral">}</span>
<a name="l01648"></a>01648 <span class="stringliteral"></span>
<a name="l01649"></a>01649 <span class="stringliteral">=item hidden_proctor_authen_fields()</span>
<a name="l01650"></a>01650 <span class="stringliteral"></span>
<a name="l01651"></a>01651 <span class="stringliteral">Use hidden_fields to return hidden &lt;INPUT&gt; tags for request fields used in</span>
<a name="l01652"></a>01652 <span class="stringliteral">proctor authentication.</span>
<a name="l01653"></a>01653 <span class="stringliteral"></span>
<a name="l01654"></a>01654 <span class="stringliteral">=cut</span>
<a name="l01655"></a>01655 <span class="stringliteral"></span>
<a name="l01656"></a>01656 <span class="stringliteral">sub hidden_proctor_authen_fields {</span>
<a name="l01657"></a>01657 <span class="stringliteral">    my $self = shift;</span>
<a name="l01658"></a>01658 <span class="stringliteral">    if ( $self-&gt;r-&gt;param(&#39;</span>proctor_user<span class="stringliteral">&#39;) ) {</span>
<a name="l01659"></a>01659 <span class="stringliteral">        return $self-&gt;hidden_fields(&quot;proctor_user&quot;, &quot;proctor_key&quot;);</span>
<a name="l01660"></a>01660 <span class="stringliteral">    } else {</span>
<a name="l01661"></a>01661 <span class="stringliteral">        return &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l01662"></a>01662 <span class="stringliteral">    }</span>
<a name="l01663"></a>01663 <span class="stringliteral">}</span>
<a name="l01664"></a>01664 <span class="stringliteral"></span>
<a name="l01665"></a>01665 <span class="stringliteral">=item hidden_state_fields()</span>
<a name="l01666"></a>01666 <span class="stringliteral"></span>
<a name="l01667"></a>01667 <span class="stringliteral">Use hidden_fields to return hidden &lt;INPUT&gt; tags for request fields used to</span>
<a name="l01668"></a>01668 <span class="stringliteral">maintain state. Currently includes authentication fields and display option</span>
<a name="l01669"></a>01669 <span class="stringliteral">fields.</span>
<a name="l01670"></a>01670 <span class="stringliteral"></span>
<a name="l01671"></a>01671 <span class="stringliteral">=cut</span>
<a name="l01672"></a>01672 <span class="stringliteral"></span>
<a name="l01673"></a>01673 <span class="stringliteral">sub hidden_state_fields {</span>
<a name="l01674"></a>01674 <span class="stringliteral">    my ($self) = @_;</span>
<a name="l01675"></a>01675 <span class="stringliteral">    </span>
<a name="l01676"></a>01676 <span class="stringliteral">    return $self-&gt;hidden_authen_fields();</span>
<a name="l01677"></a>01677 <span class="stringliteral">    </span>
<a name="l01678"></a>01678 <span class="stringliteral">    # other things that may be state data:</span>
<a name="l01679"></a>01679 <span class="stringliteral">    #$self-&gt;hidden_fields(&quot;displayMode&quot;, &quot;showOldAnswers&quot;, &quot;showCorrectAnswers&quot;, &quot;showHints&quot;, &quot;showSolutions&quot;);</span>
<a name="l01680"></a>01680 <span class="stringliteral">}</span>
<a name="l01681"></a>01681 <span class="stringliteral"></span>
<a name="l01682"></a>01682 <span class="stringliteral">=item url_args(@fields)</span>
<a name="l01683"></a>01683 <span class="stringliteral"></span>
<a name="l01684"></a>01684 <span class="stringliteral">Return a URL query string (without the leading `?&#39;</span>) containing values <span class="keywordflow">for each</span>
<a name="l01685"></a>01685 field mentioned in @fields, or all fields <span class="keywordflow">if</span> list is empty. Data is taken from
<a name="l01686"></a>01686 the current request.
<a name="l01687"></a>01687 
<a name="l01688"></a>01688 =cut
<a name="l01689"></a>01689 
<a name="l01690"></a>01690 sub url_args {
<a name="l01691"></a>01691     my ($self, @fields) = @_;
<a name="l01692"></a>01692     my $r = $self-&gt;r;
<a name="l01693"></a>01693     
<a name="l01694"></a>01694     @fields = $r-&gt;param unless @fields;
<a name="l01695"></a>01695     
<a name="l01696"></a>01696     my @pairs;
<a name="l01697"></a>01697     <span class="keywordflow">foreach</span> my $param (@fields) {
<a name="l01698"></a>01698         my @values = $r-&gt;param($param);
<a name="l01699"></a>01699         <span class="keywordflow">foreach</span> my $value (@values) {
<a name="l01700"></a>01700             push @pairs, uri_escape($param) . <span class="stringliteral">&quot;=&quot;</span> . uri_escape($value);
<a name="l01701"></a>01701         }
<a name="l01702"></a>01702     }
<a name="l01703"></a>01703     
<a name="l01704"></a>01704     <span class="keywordflow">return</span> join(<span class="stringliteral">&quot;&amp;&quot;</span>, @pairs);
<a name="l01705"></a>01705 }
<a name="l01706"></a>01706 
<a name="l01707"></a>01707 =item url_authen_args()
<a name="l01708"></a>01708 
<a name="l01709"></a>01709 Use url_args to return a URL query <span class="keywordtype">string</span> for request fields used in
<a name="l01710"></a>01710 authentication.
<a name="l01711"></a>01711 
<a name="l01712"></a>01712 =cut
<a name="l01713"></a>01713 
<a name="l01714"></a>01714 sub url_authen_args {
<a name="l01715"></a>01715     my ($self) = @_;
<a name="l01716"></a>01716     
<a name="l01717"></a>01717     <span class="keywordflow">return</span> $self-&gt;url_args(<span class="stringliteral">&quot;user&quot;</span>, <span class="stringliteral">&quot;effectiveUser&quot;</span>, <span class="stringliteral">&quot;key&quot;</span>, <span class="stringliteral">&quot;theme&quot;</span>);
<a name="l01718"></a>01718 }
<a name="l01719"></a>01719 
<a name="l01720"></a>01720 =item url_state_args()
<a name="l01721"></a>01721 
<a name="l01722"></a>01722 Use url_args to return a URL query <span class="keywordtype">string</span> for request fields used to maintain
<a name="l01723"></a>01723 state. Currently includes authentication fields and display option fields.
<a name="l01724"></a>01724 
<a name="l01725"></a>01725 =cut
<a name="l01726"></a>01726 
<a name="l01727"></a>01727 sub url_state_args {
<a name="l01728"></a>01728     my ($self) = @_;
<a name="l01729"></a>01729     
<a name="l01730"></a>01730     <span class="keywordflow">return</span> $self-&gt;url_authen_args;
<a name="l01731"></a>01731     
<a name="l01732"></a>01732 <span class="preprocessor">    # other things that may be state data:</span>
<a name="l01733"></a>01733 <span class="preprocessor"></span><span class="preprocessor">    #$self-&gt;url_args(&quot;displayMode&quot;, &quot;showOldAnswers&quot;, &quot;showCorrectAnswers&quot;, &quot;showHints&quot;, &quot;showSolutions&quot;);</span>
<a name="l01734"></a>01734 <span class="preprocessor"></span>}
<a name="l01735"></a>01735 
<a name="l01736"></a>01736 <span class="preprocessor"># This method is not used anywhere! --sam(1-Aug-05)</span>
<a name="l01737"></a>01737 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01738"></a>01738 <span class="preprocessor"></span><span class="preprocessor">#=item url_display_args()</span>
<a name="l01739"></a>01739 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01740"></a>01740 <span class="preprocessor"></span><span class="preprocessor">#Use url_args to return a URL query string for request fields used in</span>
<a name="l01741"></a>01741 <span class="preprocessor"></span><span class="preprocessor">#authentication.</span>
<a name="l01742"></a>01742 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01743"></a>01743 <span class="preprocessor"></span><span class="preprocessor">#=cut</span>
<a name="l01744"></a>01744 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01745"></a>01745 <span class="preprocessor"></span><span class="preprocessor">#sub url_display_args {</span>
<a name="l01746"></a>01746 <span class="preprocessor"></span><span class="preprocessor">#   my ($self) = @_;</span>
<a name="l01747"></a>01747 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l01748"></a>01748 <span class="preprocessor"></span><span class="preprocessor">#   return $self-&gt;url_args(&quot;displayMode&quot;, &quot;showOldAnswer&quot;);</span>
<a name="l01749"></a>01749 <span class="preprocessor"></span><span class="preprocessor">#}</span>
<a name="l01750"></a>01750 <span class="preprocessor"></span>
<a name="l01751"></a>01751 <span class="preprocessor"># This method is not used anywhere! --sam(1-Aug-05)</span>
<a name="l01752"></a>01752 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01753"></a>01753 <span class="preprocessor"></span><span class="preprocessor">#=item print_form_data($begin, $middle, $end, $omit)</span>
<a name="l01754"></a>01754 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01755"></a>01755 <span class="preprocessor"></span><span class="preprocessor">#Return a string containing every request field not matched by the quoted reguar</span>
<a name="l01756"></a>01756 <span class="preprocessor"></span><span class="preprocessor">#expression $omit, placing $begin before each field name, $middle between each</span>
<a name="l01757"></a>01757 <span class="preprocessor"></span><span class="preprocessor">#field name and its value, and $end after each value. Values are taken from the</span>
<a name="l01758"></a>01758 <span class="preprocessor"></span><span class="preprocessor">#current request.</span>
<a name="l01759"></a>01759 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01760"></a>01760 <span class="preprocessor"></span><span class="preprocessor">#=cut</span>
<a name="l01761"></a>01761 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01762"></a>01762 <span class="preprocessor"></span><span class="preprocessor">#sub print_form_data {</span>
<a name="l01763"></a>01763 <span class="preprocessor"></span><span class="preprocessor">#   my ($self, $begin, $middle, $end, $qr_omit) = @_;</span>
<a name="l01764"></a>01764 <span class="preprocessor"></span><span class="preprocessor">#   my $r=$self-&gt;r;</span>
<a name="l01765"></a>01765 <span class="preprocessor"></span><span class="preprocessor">#   my @form_data = $r-&gt;param;</span>
<a name="l01766"></a>01766 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l01767"></a>01767 <span class="preprocessor"></span><span class="preprocessor">#   my $return_string = &quot;&quot;;</span>
<a name="l01768"></a>01768 <span class="preprocessor"></span><span class="preprocessor">#   foreach my $name (@form_data) {</span>
<a name="l01769"></a>01769 <span class="preprocessor"></span><span class="preprocessor">#       next if ($qr_omit and $name =~ /$qr_omit/);</span>
<a name="l01770"></a>01770 <span class="preprocessor"></span><span class="preprocessor">#       my @values = $r-&gt;param($name);</span>
<a name="l01771"></a>01771 <span class="preprocessor"></span><span class="preprocessor">#       foreach my $variable (qw(begin name middle value end)) {</span>
<a name="l01772"></a>01772 <span class="preprocessor"></span><span class="preprocessor">#           # FIXME: can this loop be moved out of the enclosing loop?</span>
<a name="l01773"></a>01773 <span class="preprocessor"></span><span class="preprocessor">#           no strict &#39;refs&#39;;</span>
<a name="l01774"></a>01774 <span class="preprocessor"></span><span class="preprocessor">#           ${$variable} = &quot;&quot; unless defined ${$variable};</span>
<a name="l01775"></a>01775 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l01776"></a>01776 <span class="preprocessor"></span><span class="preprocessor">#       foreach my $value (@values) {</span>
<a name="l01777"></a>01777 <span class="preprocessor"></span><span class="preprocessor">#           $return_string .= &quot;$begin$name$middle$value$end&quot;;</span>
<a name="l01778"></a>01778 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l01779"></a>01779 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l01780"></a>01780 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l01781"></a>01781 <span class="preprocessor"></span><span class="preprocessor">#   return $return_string;</span>
<a name="l01782"></a>01782 <span class="preprocessor"></span><span class="preprocessor">#}</span>
<a name="l01783"></a>01783 <span class="preprocessor"></span>
<a name="l01784"></a>01784 =back
<a name="l01785"></a>01785 
<a name="l01786"></a>01786 =cut
<a name="l01787"></a>01787 
<a name="l01788"></a>01788 <span class="preprocessor"># ------------------------------------------------------------------------------</span>
<a name="l01789"></a>01789 <span class="preprocessor"></span>
<a name="l01790"></a>01790 =head2 Utilities
<a name="l01791"></a>01791 
<a name="l01792"></a>01792 =over
<a name="l01793"></a>01793 
<a name="l01794"></a>01794 =item systemLink($urlpath, %options)
<a name="l01795"></a>01795 
<a name="l01796"></a>01796 Generate a link to another part of the system. $urlpath is <a class="code" href="classWeBWorK.html">WeBWorK</a>::URLPath
<a name="l01797"></a>01797 <span class="keywordtype">object</span> from which the base path will be taken. %options can consist of:
<a name="l01798"></a>01798 
<a name="l01799"></a>01799 =over
<a name="l01800"></a>01800 
<a name="l01801"></a>01801 =item params
<a name="l01802"></a>01802 
<a name="l01803"></a>01803 Can be either a reference to an array or a reference to a hash.
<a name="l01804"></a>01804 
<a name="l01805"></a>01805 If it is a reference to a hash, it maps parmaeter names to values. These
<a name="l01806"></a>01806 parameters will be included in the generated link. If a value is an arrayref,
<a name="l01807"></a>01807 the values of the array referenced will be used. If a value is undefined, the
<a name="l01808"></a>01808 value from the current request will be used.
<a name="l01809"></a>01809 
<a name="l01810"></a>01810 If C&lt;params&gt; is an arrayref, it is interpreted as a list of parameter names.
<a name="l01811"></a>01811 These parameters will be included in the generated link, using the values from
<a name="l01812"></a>01812 the current request.
<a name="l01813"></a>01813 
<a name="l01814"></a>01814 Unless C&lt;authen&gt; is false (see below), the authentication parameters (C&lt;user&gt;,
<a name="l01815"></a>01815 C&lt;effectiveUser&gt;, and C&lt;key&gt;) are included with their default values.
<a name="l01816"></a>01816 
<a name="l01817"></a>01817 =item authen
<a name="l01818"></a>01818 
<a name="l01819"></a>01819 If set to a false value, the authentication parameters (C&lt;user&gt;,
<a name="l01820"></a>01820 C&lt;effectiveUser&gt;, and C&lt;key&gt;) are included in the the generated link unless
<a name="l01821"></a>01821 explicitly listed in C&lt;params&gt;.
<a name="l01822"></a>01822 
<a name="l01823"></a>01823 =item use_abs_url
<a name="l01824"></a>01824 
<a name="l01825"></a>01825 If set to a true value, the scheme, host, and port are prepended to the URL.
<a name="l01826"></a>01826 This is useful for links which must be usable on their own, such as those sent
<a name="l01827"></a>01827 via email.
<a name="l01828"></a>01828 
<a name="l01829"></a>01829 =back
<a name="l01830"></a>01830 
<a name="l01831"></a>01831 =cut
<a name="l01832"></a>01832 
<a name="l01833"></a>01833 <span class="preprocessor"># FIXME: there should probably be an option for prepending &quot;http://hostname:port&quot;</span>
<a name="l01834"></a>01834 <span class="preprocessor"></span>sub systemLink {
<a name="l01835"></a>01835     my ($self, $urlpath, %options) = @_;
<a name="l01836"></a>01836     my $r = $self-&gt;r;
<a name="l01837"></a>01837     
<a name="l01838"></a>01838     my %params = ();
<a name="l01839"></a>01839     <span class="keywordflow">if</span> (exists $options{params}) {
<a name="l01840"></a>01840         <span class="keywordflow">if</span> (ref $options{params} eq <span class="stringliteral">&quot;HASH&quot;</span>) {
<a name="l01841"></a>01841             %params = %{ $options{params} };
<a name="l01842"></a>01842         } elsif (ref $options{params} eq <span class="stringliteral">&quot;ARRAY&quot;</span>) {
<a name="l01843"></a>01843             my @names = @{ $options{params} };
<a name="l01844"></a>01844             @params{@names} = ();
<a name="l01845"></a>01845         } <span class="keywordflow">else</span> {
<a name="l01846"></a>01846             croak <span class="stringliteral">&quot;option &#39;params&#39; is not a hashref or an arrayref&quot;</span>;
<a name="l01847"></a>01847         }
<a name="l01848"></a>01848     }
<a name="l01849"></a>01849     
<a name="l01850"></a>01850     my $authen = exists $options{authen} ? $options{authen} : 1;
<a name="l01851"></a>01851     <span class="keywordflow">if</span> ($authen) {
<a name="l01852"></a>01852         $params{user}          = undef unless exists $params{user};
<a name="l01853"></a>01853         $params{effectiveUser} = undef unless exists $params{effectiveUser};
<a name="l01854"></a>01854         $params{key}           = undef unless exists $params{key};
<a name="l01855"></a>01855         $params{theme}         = undef unless exists $params{theme};
<a name="l01856"></a>01856     }
<a name="l01857"></a>01857     
<a name="l01858"></a>01858     my $url;
<a name="l01859"></a>01859     
<a name="l01860"></a>01860     $url = $r-&gt;ce-&gt;{apache_root_url} <span class="keywordflow">if</span> $options{use_abs_url};
<a name="l01861"></a>01861     $url .= $r-&gt;location . $urlpath-&gt;path;
<a name="l01862"></a>01862     my $first = 1;
<a name="l01863"></a>01863     
<a name="l01864"></a>01864     <span class="keywordflow">foreach</span> my $name (keys %params) {
<a name="l01865"></a>01865         my $value = $params{$name};
<a name="l01866"></a>01866         
<a name="l01867"></a>01867         my @values;
<a name="l01868"></a>01868         <span class="keywordflow">if</span> (defined $value) {
<a name="l01869"></a>01869             <span class="keywordflow">if</span> (ref $value eq <span class="stringliteral">&quot;ARRAY&quot;</span>) {
<a name="l01870"></a>01870                 @values = @$value;
<a name="l01871"></a>01871             } <span class="keywordflow">else</span> {
<a name="l01872"></a>01872                 @values = $value;
<a name="l01873"></a>01873             }
<a name="l01874"></a>01874         } elsif (defined $r-&gt;param($name)) {
<a name="l01875"></a>01875             @values = $r-&gt;param($name);
<a name="l01876"></a>01876         }
<a name="l01877"></a>01877 <span class="preprocessor">        #FIXME  -- evntually we&#39;d like to catch where this happens</span>
<a name="l01878"></a>01878 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ($name eq <span class="stringliteral">&#39;user&#39;</span> and @values &gt;1 )    {
<a name="l01879"></a>01879             warn <span class="stringliteral">&quot;internal error --  user has been multiply defined! You may need to logout and log back in to correct this.&quot;</span>;
<a name="l01880"></a>01880             my $user = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l01881"></a>01881             $r-&gt;param(user =&gt; $user);
<a name="l01882"></a>01882             @values = ($user);
<a name="l01883"></a>01883             warn <span class="stringliteral">&quot;requesting page is &quot;</span>, $r-&gt;headers_in-&gt;{<span class="stringliteral">&#39;Referer&#39;</span>};
<a name="l01884"></a>01884             warn <span class="stringliteral">&quot;Parameters are &quot;</span>, join(<span class="stringliteral">&quot;|&quot;</span>,$r-&gt;param());
<a name="l01885"></a>01885 
<a name="l01886"></a>01886         }
<a name="l01887"></a>01887          
<a name="l01888"></a>01888         <span class="keywordflow">if</span> (@values) {
<a name="l01889"></a>01889             <span class="keywordflow">if</span> ($first) {
<a name="l01890"></a>01890                 $url .= <span class="stringliteral">&quot;?&quot;</span>;
<a name="l01891"></a>01891                 $first = 0;
<a name="l01892"></a>01892             } <span class="keywordflow">else</span> {
<a name="l01893"></a>01893                 $url .= <span class="stringliteral">&quot;&amp;&quot;</span>;
<a name="l01894"></a>01894             }
<a name="l01895"></a>01895             $url .= join <span class="stringliteral">&quot;&amp;&quot;</span>, map { <span class="stringliteral">&quot;$name=$_&quot;</span> } @values;
<a name="l01896"></a>01896         }
<a name="l01897"></a>01897     }
<a name="l01898"></a>01898     
<a name="l01899"></a>01899     <span class="keywordflow">return</span> $url;
<a name="l01900"></a>01900 }
<a name="l01901"></a>01901 
<a name="l01902"></a>01902 =item nbsp($string)
<a name="l01903"></a>01903 
<a name="l01904"></a>01904 If <span class="keywordtype">string</span> consists of only whitespace, the <a class="code" href="classWeBWorK_1_1HTML.html">HTML</a> entity C&lt;&amp;nbsp;&gt; is returned.
<a name="l01905"></a>01905 Otherwise $string is returned.
<a name="l01906"></a>01906 
<a name="l01907"></a>01907 =cut
<a name="l01908"></a>01908 
<a name="l01909"></a>01909 sub nbsp {
<a name="l01910"></a>01910     my ($self, $str) = @_;
<a name="l01911"></a>01911     <span class="keywordflow">return</span> (defined $str &amp;&amp; $str =~/\S/) ? $str : <span class="stringliteral">&quot;&amp;nbsp;&quot;</span>;
<a name="l01912"></a>01912 }
<a name="l01913"></a>01913 
<a name="l01914"></a>01914 =item sp2nbsp($string)
<a name="l01915"></a>01915 
<a name="l01916"></a>01916 A copy of $string is returned with each space character replaced by the
<a name="l01917"></a>01917 C&lt;&amp;nbsp;&gt; entity.
<a name="l01918"></a>01918 
<a name="l01919"></a>01919 =cut
<a name="l01920"></a>01920 
<a name="l01921"></a>01921 sub sp2nbsp {
<a name="l01922"></a>01922     my ($str) = @_;
<a name="l01923"></a>01923     <span class="keywordflow">return</span> unless defined $str;
<a name="l01924"></a>01924     $str =~ s/\s/&amp;nbsp;/g;
<a name="l01925"></a>01925     <span class="keywordflow">return</span> $str;
<a name="l01926"></a>01926 }
<a name="l01927"></a>01927 
<a name="l01928"></a>01928 =item underscore2nbsp($string)
<a name="l01929"></a>01929 
<a name="l01930"></a>01930 A copy of $string is returned with each underscore character replaced by the
<a name="l01931"></a>01931 C&lt;&amp;nbsp;&gt; entity.
<a name="l01932"></a>01932 
<a name="l01933"></a>01933 =cut
<a name="l01934"></a>01934 
<a name="l01935"></a>01935 sub underscore2nbsp {
<a name="l01936"></a>01936     my ($str) = @_;
<a name="l01937"></a>01937     <span class="keywordflow">return</span> unless defined $str;
<a name="l01938"></a>01938     $str =~ s/_/&amp;nbsp;/g;
<a name="l01939"></a>01939     <span class="keywordflow">return</span> $str;
<a name="l01940"></a>01940 }
<a name="l01941"></a>01941 
<a name="l01942"></a>01942 =item errorOutput($error, $details)
<a name="l01943"></a>01943 
<a name="l01944"></a>01944 Used by Problem, ProblemSet, and Hardcopy to report errors encountered during
<a name="l01945"></a>01945 problem rendering.
<a name="l01946"></a>01946 
<a name="l01947"></a>01947 =cut
<a name="l01948"></a>01948 
<a name="l01949"></a>01949 sub errorOutput($$$) {
<a name="l01950"></a>01950     my ($self, $error, $details) = @_;
<a name="l01951"></a>01951     my $r = $self-&gt;{r};
<a name="l01952"></a>01952     print <span class="stringliteral">&quot;Entering ContentGenerator::errorOutput subroutine&lt;/br&gt;&quot;</span>;
<a name="l01953"></a>01953     my $time = time2str(<span class="stringliteral">&quot;%a %b %d %H:%M:%S %Y&quot;</span>, time);
<a name="l01954"></a>01954     my $method = $r-&gt;method;
<a name="l01955"></a>01955     my $uri = $r-&gt;uri;
<a name="l01956"></a>01956     my $headers = <span class="keywordflow">do</span> {
<a name="l01957"></a>01957         my %headers = %{$r-&gt;headers_in};
<a name="l01958"></a>01958         join(<span class="stringliteral">&quot;&quot;</span>, map { CGI::Tr({},CGI::td(CGI::small($_)), CGI::td(CGI::small($headers{$_}))) } keys %headers);
<a name="l01959"></a>01959     };
<a name="l01960"></a>01960 
<a name="l01961"></a>01961 <span class="preprocessor">    # if it is a long report pass details by reference rather than by value</span>
<a name="l01962"></a>01962 <span class="preprocessor"></span><span class="preprocessor">    # for consistency we automatically convert all forms of $details into</span>
<a name="l01963"></a>01963 <span class="preprocessor"></span><span class="preprocessor">    # a reference to an array.</span>
<a name="l01964"></a>01964 <span class="preprocessor"></span>
<a name="l01965"></a>01965     <span class="keywordflow">if</span> (ref($details) =~ /SCALAR/i) {
<a name="l01966"></a>01966         $details = [$$details];
<a name="l01967"></a>01967     } elsif (ref($details) =~/ARRAY/i) {
<a name="l01968"></a>01968 <span class="preprocessor">        # no change needed  </span>
<a name="l01969"></a>01969 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
<a name="l01970"></a>01970        $details = [$details];
<a name="l01971"></a>01971     }
<a name="l01972"></a>01972     <span class="keywordflow">return</span>
<a name="l01973"></a>01973         CGI::h2(<span class="stringliteral">&quot;WeBWorK Error&quot;</span>),
<a name="l01974"></a>01974         CGI::p($r-&gt;maketext(<span class="stringliteral">&quot;_REQUEST_ERROR&quot;</span>)),
<a name="l01975"></a>01975 
<a name="l01976"></a>01976         CGI::h3(<span class="stringliteral">&quot;Error messages&quot;</span>),
<a name="l01977"></a>01977 
<a name="l01978"></a>01978         CGI::p(CGI::code($error)),
<a name="l01979"></a>01979         CGI::h3(<span class="stringliteral">&quot;Error details&quot;</span>),
<a name="l01980"></a>01980         
<a name="l01981"></a>01981         CGI::start_code(), CGI::start_p(),
<a name="l01982"></a>01982         @{ $details },
<a name="l01983"></a>01983 <span class="preprocessor">        #CGI::code(CGI::p(@expandedDetails)), </span>
<a name="l01984"></a>01984 <span class="preprocessor"></span><span class="preprocessor">        # not using inclusive CGI calls here saves about 30Meg of memory!</span>
<a name="l01985"></a>01985 <span class="preprocessor"></span>        CGI::end_p(),CGI::end_code(),
<a name="l01986"></a>01986         
<a name="l01987"></a>01987         CGI::h3(<span class="stringliteral">&quot;Request information&quot;</span>),
<a name="l01988"></a>01988         CGI::table({border=&gt;<span class="stringliteral">&quot;1&quot;</span>},
<a name="l01989"></a>01989             CGI::Tr({},CGI::td(<span class="stringliteral">&quot;Time&quot;</span>), CGI::td($time)),
<a name="l01990"></a>01990             CGI::Tr({},CGI::td(<span class="stringliteral">&quot;Method&quot;</span>), CGI::td($method)),
<a name="l01991"></a>01991             CGI::Tr({},CGI::td(<span class="stringliteral">&quot;URI&quot;</span>), CGI::td($uri)),
<a name="l01992"></a>01992             CGI::Tr({},CGI::td(<span class="stringliteral">&quot;HTTP Headers&quot;</span>), CGI::td(
<a name="l01993"></a>01993                 CGI::table($headers),
<a name="l01994"></a>01994             )),
<a name="l01995"></a>01995         ),
<a name="l01996"></a>01996     ;  
<a name="l01997"></a>01997     
<a name="l01998"></a>01998 }
<a name="l01999"></a>01999 
<a name="l02000"></a>02000 =item warningOutput($warnings)
<a name="l02001"></a>02001 
<a name="l02002"></a>02002 Used by warnings() in this class to report warnings caught during dispatching
<a name="l02003"></a>02003 and content generation.
<a name="l02004"></a>02004 
<a name="l02005"></a>02005 =cut
<a name="l02006"></a>02006 
<a name="l02007"></a>02007 sub warningOutput($$) {
<a name="l02008"></a>02008     my ($self, $warnings) = @_;
<a name="l02009"></a>02009     my $r = $self-&gt;{r};
<a name="l02010"></a>02010     print <span class="stringliteral">&quot;Entering ContentGenerator::warningOutput subroutine&lt;/br&gt;&quot;</span>;
<a name="l02011"></a>02011     my @warnings = split m/\n+/, $warnings;
<a name="l02012"></a>02012     <span class="keywordflow">foreach</span> my $warning (@warnings) {
<a name="l02013"></a>02013 <span class="preprocessor">        #$warning = escapeHTML($warning);  # this would prevent using tables in output from answer evaluators</span>
<a name="l02014"></a>02014 <span class="preprocessor"></span>        $warning = CGI::li(CGI::code($warning));
<a name="l02015"></a>02015     }
<a name="l02016"></a>02016     $warnings = join(<span class="stringliteral">&quot;&quot;</span>, @warnings);
<a name="l02017"></a>02017     
<a name="l02018"></a>02018     my $time = time2str(<span class="stringliteral">&quot;%a %b %d %H:%M:%S %Y&quot;</span>, time);
<a name="l02019"></a>02019     my $method = $r-&gt;method;
<a name="l02020"></a>02020     my $uri = $r-&gt;uri;
<a name="l02021"></a>02021 <span class="preprocessor">    #my $headers = do {</span>
<a name="l02022"></a>02022 <span class="preprocessor"></span><span class="preprocessor">    #   my %headers = $r-&gt;headers_in;</span>
<a name="l02023"></a>02023 <span class="preprocessor"></span><span class="preprocessor">    #   join(&quot;&quot;, map { CGI::Tr(CGI::td(CGI::small($_)), CGI::td(CGI::small($headers{$_}))) } keys %headers);</span>
<a name="l02024"></a>02024 <span class="preprocessor"></span><span class="preprocessor">    #};</span>
<a name="l02025"></a>02025 <span class="preprocessor"></span>    
<a name="l02026"></a>02026     <span class="keywordflow">return</span>
<a name="l02027"></a>02027         CGI::h2(<span class="stringliteral">&quot;WeBWorK Warnings&quot;</span>),
<a name="l02028"></a>02028         CGI::p(&lt;&lt;EOF),
<a name="l02029"></a>02029 <a class="code" href="classWeBWorK.html">WeBWorK</a> has encountered warnings <span class="keywordflow">while</span> processing your request. If <span class="keyword">this</span> occured
<a name="l02030"></a>02030 when viewing a problem, it was likely caused by an error or ambiguity in that
<a name="l02031"></a>02031 problem. Otherwise, it may indicate a problem with the <a class="code" href="classWeBWorK.html">WeBWorK</a> system itself. If
<a name="l02032"></a>02032 you are a student, report these warnings to your professor to have them
<a name="l02033"></a>02033 corrected. If you are a professor, please consult the warning output below <span class="keywordflow">for</span>
<a name="l02034"></a>02034 more information.
<a name="l02035"></a>02035 EOF
<a name="l02036"></a>02036         CGI::h3(<span class="stringliteral">&quot;Warning messages&quot;</span>),
<a name="l02037"></a>02037         CGI::ul($warnings),
<a name="l02038"></a>02038         CGI::h3(<span class="stringliteral">&quot;Request information&quot;</span>),
<a name="l02039"></a>02039         CGI::table({border=&gt;<span class="stringliteral">&quot;1&quot;</span>},
<a name="l02040"></a>02040             CGI::Tr({},CGI::td(<span class="stringliteral">&quot;Time&quot;</span>), CGI::td($time)),
<a name="l02041"></a>02041             CGI::Tr({},CGI::td(<span class="stringliteral">&quot;Method&quot;</span>), CGI::td($method)),
<a name="l02042"></a>02042             CGI::Tr({},CGI::td(<span class="stringliteral">&quot;URI&quot;</span>), CGI::td($uri)),
<a name="l02043"></a>02043             #CGI::Tr(CGI::td(<span class="stringliteral">&quot;HTTP Headers&quot;</span>), CGI::td(
<a name="l02044"></a>02044             #   CGI::table($headers),
<a name="l02045"></a>02045             #)),
<a name="l02046"></a>02046         );
<a name="l02047"></a>02047 }
<a name="l02048"></a>02048 
<a name="l02049"></a>02049 =item $dateTime = parseDateTime($string, $display_tz)
<a name="l02050"></a>02050 
<a name="l02051"></a>02051 Parses $string as a datetime. If $display_tz is given, $string is assumed to be
<a name="l02052"></a>02052 in that timezone. Otherwise, the timezone defined in the course environment
<a name="l02053"></a>02053 variable $siteDefaults{timezone} is used. The result, $dateTime, is an integer
<a name="l02054"></a>02054 UNIX datetime (epoch) in the server&#39;s timezone.
<a name="l02055"></a>02055 
<a name="l02056"></a>02056 =cut
<a name="l02057"></a>02057 
<a name="l02058"></a>02058 sub parseDateTime {
<a name="l02059"></a>02059     my ($self, $string, $display_tz) = @_;
<a name="l02060"></a>02060     my $ce = $self-&gt;r-&gt;ce;
<a name="l02061"></a>02061     $display_tz ||= $ce-&gt;{siteDefaults}{timezone};
<a name="l02062"></a>02062     <span class="keywordflow">return</span> <a class="code" href="classWeBWorK_1_1Utils.html#a379691d7aa3ce757b71427a64bfb8f8f">WeBWorK::Utils::parseDateTime</a>($string, $display_tz);
<a name="l02063"></a>02063 };
<a name="l02064"></a>02064 
<a name="l02065"></a>02065 =item $string = formatDateTime($dateTime, $display_tz)
<a name="l02066"></a>02066 
<a name="l02067"></a>02067 Formats the UNIX datetime $dateTime in the standard <a class="code" href="classWeBWorK.html">WeBWorK</a> datetime format.
<a name="l02068"></a>02068 $dateTime is assumed to be in the server&#39;s time zone. If $display_tz is given,
<a name="l02069"></a>02069 the datetime is converted from the server&#39;s timezone to the timezone specified.
<a name="l02070"></a>02070 Otherwise, the timezone defined in the course environment variable
<a name="l02071"></a>02071 $siteDefaults{timezone} is used.
<a name="l02072"></a>02072 
<a name="l02073"></a>02073 =cut
<a name="l02074"></a>02074 
<a name="l02075"></a>02075 sub formatDateTime {
<a name="l02076"></a>02076     my ($self, $dateTime, $display_tz) = @_;
<a name="l02077"></a>02077     my $ce = $self-&gt;r-&gt;ce;
<a name="l02078"></a>02078     $display_tz ||= $ce-&gt;{siteDefaults}{timezone};
<a name="l02079"></a>02079     <span class="keywordflow">return</span> <a class="code" href="classWeBWorK_1_1Utils.html#aea0bf7fdfeed770c8eb3ddd69d319f08">WeBWorK::Utils::formatDateTime</a>($dateTime, $display_tz);
<a name="l02080"></a>02080 }
<a name="l02081"></a>02081 
<a name="l02082"></a>02082 =item read_scoring_file($fileName)
<a name="l02083"></a>02083 
<a name="l02084"></a>02084 Wrapper for <a class="code" href="classWeBWorK.html">WeBWorK</a>::<a class="code" href="classWeBWorK_1_1File.html">File</a>::Scoring that no-ops if $fileName is &quot;None&quot; and
<a name="l02085"></a>02085 prepends the path to the scoring directory.
<a name="l02086"></a>02086 
<a name="l02087"></a>02087 =cut
<a name="l02088"></a>02088 
<a name="l02089"></a>02089 sub read_scoring_file {
<a name="l02090"></a>02090     my ($self, $fileName) = @_;
<a name="l02091"></a>02091     <span class="keywordflow">return</span> {} <span class="keywordflow">if</span> $fileName eq <span class="stringliteral">&quot;None&quot;</span>; # callers expect a hashref in all cases
<a name="l02092"></a>02092     <span class="keywordflow">return</span> parse_scoring_file($self-&gt;r-&gt;ce-&gt;{courseDirs}{scoring}.<span class="stringliteral">&quot;/$fileName&quot;</span>);
<a name="l02093"></a>02093 }
<a name="l02094"></a>02094 
<a name="l02095"></a>02095 =back
<a name="l02096"></a>02096 
<a name="l02097"></a>02097 =head1 AUTHOR
<a name="l02098"></a>02098 
<a name="l02099"></a>02099 Written by Dennis Lambe Jr., malsyned (at) math.rochester.edu and Sam Hathaway,
<a name="l02100"></a>02100 sh002i (at) math.rochester.edu.
<a name="l02101"></a>02101 
<a name="l02102"></a>02102 =cut
<a name="l02103"></a>02103 
<a name="l02104"></a>02104 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:34 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
