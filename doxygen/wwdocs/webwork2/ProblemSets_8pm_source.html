<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: ProblemSets.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>ProblemSets.pm</h1><a href="ProblemSets_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/ProblemSets.pm,v 1.94 2010/01/31 02:31:04 apizer Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::ProblemSets;
<a name="l00018"></a>00018 use base qw(<a class="code" href="classWeBWorK.html">WeBWorK</a>);
<a name="l00019"></a>00019 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator.html">WeBWorK::ContentGenerator</a>);
<a name="l00020"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1ProblemSets.html">00020</a> 
<a name="l00021"></a>00021 =head1 NAME
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1ProblemSets.html">WeBWorK::ContentGenerator::ProblemSets</a> - Display a list of built problem sets.
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 =cut
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 use strict;
<a name="l00028"></a>00028 use warnings;
<a name="l00029"></a>00029 <span class="preprocessor">#use CGI qw(-nosticky );</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00031"></a>00031 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00032"></a>00032 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(readFile sortByName path_is_subdir);
<a name="l00033"></a>00033 use <a class="code" href="classWeBWorK_1_1Localize.html">WeBWorK::Localize</a>;
<a name="l00034"></a>00034 <span class="preprocessor"># what do we consider a &quot;recent&quot; problem set?</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>use constant RECENT =&gt; 2*7*24*60*60 ; # Two-Weeks in seconds
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 sub info {
<a name="l00038"></a>00038     my ($self) = @_;
<a name="l00039"></a>00039     my $r = $self-&gt;r;
<a name="l00040"></a>00040     my $ce = $r-&gt;ce;
<a name="l00041"></a>00041     my $db = $r-&gt;db;
<a name="l00042"></a>00042     my $urlpath = $r-&gt;urlpath;
<a name="l00043"></a>00043     my $authz = $r-&gt;authz;
<a name="l00044"></a>00044     
<a name="l00045"></a>00045     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00046"></a>00046     my $user = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00047"></a>00047     
<a name="l00048"></a>00048     my $course_info = $ce-&gt;{courseFiles}-&gt;{course_info};
<a name="l00049"></a>00049     
<a name="l00050"></a>00050     <span class="keywordflow">if</span> (defined $course_info and $course_info) {
<a name="l00051"></a>00051         my $course_info_path = $ce-&gt;{courseDirs}-&gt;{templates} . <span class="stringliteral">&quot;/$course_info&quot;</span>;
<a name="l00052"></a>00052         
<a name="l00053"></a>00053         print CGI::start_div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;info-wrapper&quot;</span>});
<a name="l00054"></a>00054         print CGI::start_div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;info-box&quot;</span>, <span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;InfoPanel&quot;</span>});
<a name="l00055"></a>00055         
<a name="l00056"></a>00056 <span class="preprocessor">        # deal with instructor crap</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span>        my $editorURL;
<a name="l00058"></a>00058         <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>)) {
<a name="l00059"></a>00059             <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&quot;editMode&quot;</span>) and $r-&gt;param(<span class="stringliteral">&quot;editMode&quot;</span>) eq <span class="stringliteral">&quot;temporaryFile&quot;</span>) {
<a name="l00060"></a>00060                 $course_info_path = $r-&gt;param(<span class="stringliteral">&quot;sourceFilePath&quot;</span>);
<a name="l00061"></a>00061                 $course_info_path = $ce-&gt;{courseDirs}{templates}.<span class="charliteral">&#39;/&#39;</span>.$course_info_path unless $course_info_path =~ m!^/!;
<a name="l00062"></a>00062                 die <span class="stringliteral">&quot;sourceFilePath is unsafe!&quot;</span> unless path_is_subdir($course_info_path, $ce-&gt;{courseDirs}-&gt;{templates});
<a name="l00063"></a>00063                 $self-&gt;addmessage(CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;temporaryFile&#39;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Viewing temporary file: &quot;</span>), $course_info_path));
<a name="l00064"></a>00064             }
<a name="l00065"></a>00065             
<a name="l00066"></a>00066             my $editorPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::PGProblemEditor&quot;</span>,  $r, courseID =&gt; $courseID);
<a name="l00067"></a>00067             $editorURL = $self-&gt;systemLink($editorPage, params =&gt; { file_type =&gt; <span class="stringliteral">&quot;course_info&quot;</span> });
<a name="l00068"></a>00068         }
<a name="l00069"></a>00069         
<a name="l00070"></a>00070         <span class="keywordflow">if</span> ($editorURL) {
<a name="l00071"></a>00071             print CGI::h2($r-&gt;maketext(<span class="stringliteral">&quot;Course Info&quot;</span>), CGI::a({href=&gt;$editorURL, target=&gt;<span class="stringliteral">&quot;WW_Editor&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;~[edit~]&quot;</span>)));
<a name="l00072"></a>00072         } <span class="keywordflow">else</span> {
<a name="l00073"></a>00073             print CGI::h2($r-&gt;maketext(<span class="stringliteral">&quot;Course Info&quot;</span>));
<a name="l00074"></a>00074         }
<a name="l00075"></a>00075         
<a name="l00076"></a>00076         <span class="keywordflow">if</span> (-f $course_info_path) { #check that it<span class="stringliteral">&#39;s a plain  file</span>
<a name="l00077"></a>00077 <span class="stringliteral">            my $text = eval { readFile($course_info_path) };</span>
<a name="l00078"></a>00078 <span class="stringliteral">            if ($@) {</span>
<a name="l00079"></a>00079 <span class="stringliteral">                print CGI::div({class=&gt;&quot;ResultsWithError&quot;},</span>
<a name="l00080"></a>00080 <span class="stringliteral">                    CGI::p(&quot;$@&quot;),</span>
<a name="l00081"></a>00081 <span class="stringliteral">                );</span>
<a name="l00082"></a>00082 <span class="stringliteral">            } else {</span>
<a name="l00083"></a>00083 <span class="stringliteral">                print $text;</span>
<a name="l00084"></a>00084 <span class="stringliteral">            }</span>
<a name="l00085"></a>00085 <span class="stringliteral">        }</span>
<a name="l00086"></a>00086 <span class="stringliteral"></span>
<a name="l00087"></a>00087 <span class="stringliteral">        print CGI::end_div();</span>
<a name="l00088"></a>00088 <span class="stringliteral">        print CGI::end_div();</span>
<a name="l00089"></a>00089 <span class="stringliteral">        </span>
<a name="l00090"></a>00090 <span class="stringliteral">        return &quot;&quot;;</span>
<a name="l00091"></a>00091 <span class="stringliteral">    }</span>
<a name="l00092"></a>00092 <span class="stringliteral">}</span>
<a name="l00093"></a>00093 <span class="stringliteral">sub help {   # non-standard help, since the file path includes the course name</span>
<a name="l00094"></a>00094 <span class="stringliteral">    my $self = shift;</span>
<a name="l00095"></a>00095 <span class="stringliteral">    my $args = shift;</span>
<a name="l00096"></a>00096 <span class="stringliteral">    my $name = $args-&gt;{name};</span>
<a name="l00097"></a>00097 <span class="stringliteral">    $name = lc(&#39;</span>course home<span class="stringliteral">&#39;) unless defined($name);</span>
<a name="l00098"></a>00098 <span class="stringliteral">    $name =~ s/\s/_/g;</span>
<a name="l00099"></a>00099 <span class="stringliteral">    $self-&gt;helpMacro($name);</span>
<a name="l00100"></a>00100 <span class="stringliteral">}</span>
<a name="l00101"></a>00101 <span class="stringliteral">sub initialize {</span>
<a name="l00102"></a>00102 <span class="stringliteral"></span>
<a name="l00103"></a>00103 <span class="stringliteral"></span>
<a name="l00104"></a>00104 <span class="stringliteral"></span>
<a name="l00105"></a>00105 <span class="stringliteral"># get result and send to message</span>
<a name="l00106"></a>00106 <span class="stringliteral">    my ($self) = @_;</span>
<a name="l00107"></a>00107 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00108"></a>00108 <span class="stringliteral">    my $authz = $r-&gt;authz;</span>
<a name="l00109"></a>00109 <span class="stringliteral">    my $urlpath = $r-&gt;urlpath;</span>
<a name="l00110"></a>00110 <span class="stringliteral">    </span>
<a name="l00111"></a>00111 <span class="stringliteral">    my $user               = $r-&gt;param(&quot;user&quot;);</span>
<a name="l00112"></a>00112 <span class="stringliteral">    my $effectiveUser      = $r-&gt;param(&quot;effectiveUser&quot;);</span>
<a name="l00113"></a>00113 <span class="stringliteral">    if ($authz-&gt;hasPermissions($user, &quot;access_instructor_tools&quot;)) {</span>
<a name="l00114"></a>00114 <span class="stringliteral">        # get result and send to message</span>
<a name="l00115"></a>00115 <span class="stringliteral">        my $status_message = $r-&gt;param(&quot;status_message&quot;);</span>
<a name="l00116"></a>00116 <span class="stringliteral">        $self-&gt;addmessage(CGI::p(&quot;$status_message&quot;)) if $status_message;</span>
<a name="l00117"></a>00117 <span class="stringliteral">    </span>
<a name="l00118"></a>00118 <span class="stringliteral"></span>
<a name="l00119"></a>00119 <span class="stringliteral">    }</span>
<a name="l00120"></a>00120 <span class="stringliteral">}</span>
<a name="l00121"></a>00121 <span class="stringliteral">sub body {</span>
<a name="l00122"></a>00122 <span class="stringliteral">    my ($self) = @_;</span>
<a name="l00123"></a>00123 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00124"></a>00124 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00125"></a>00125 <span class="stringliteral">    my $db = $r-&gt;db;</span>
<a name="l00126"></a>00126 <span class="stringliteral">    my $authz = $r-&gt;authz;</span>
<a name="l00127"></a>00127 <span class="stringliteral">    my $urlpath = $r-&gt;urlpath;</span>
<a name="l00128"></a>00128 <span class="stringliteral">    </span>
<a name="l00129"></a>00129 <span class="stringliteral">    my $user            = $r-&gt;param(&quot;user&quot;);</span>
<a name="l00130"></a>00130 <span class="stringliteral">    my $effectiveUser   = $r-&gt;param(&quot;effectiveUser&quot;);</span>
<a name="l00131"></a>00131 <span class="stringliteral">    my $sort            = $r-&gt;param(&quot;sort&quot;) || &quot;status&quot;;</span>
<a name="l00132"></a>00132 <span class="stringliteral">    </span>
<a name="l00133"></a>00133 <span class="stringliteral">    my $courseName      = $urlpath-&gt;arg(&quot;courseID&quot;);</span>
<a name="l00134"></a>00134 <span class="stringliteral">    </span>
<a name="l00135"></a>00135 <span class="stringliteral">    my $hardcopyPage = $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Hardcopy&quot;,  $r, courseID =&gt; $courseName);</span>
<a name="l00136"></a>00136 <span class="stringliteral">    my $actionURL = $self-&gt;systemLink($hardcopyPage, authen =&gt; 0); # no authen info for form action</span>
<a name="l00137"></a>00137 <span class="stringliteral">    </span>
<a name="l00138"></a>00138 <span class="stringliteral"># we have to get sets and versioned sets separately</span>
<a name="l00139"></a>00139 <span class="stringliteral">    # DBFIXME don&#39;</span>t <span class="keyword">get</span> ID lists, use WHERE clauses and iterators
<a name="l00140"></a>00140     my @setIDs = $db-&gt;listUserSets($effectiveUser);
<a name="l00141"></a>00141     my @userSetIDs = map {[$effectiveUser, $_]} @setIDs;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     debug(<span class="stringliteral">&quot;Begin collecting merged sets&quot;</span>);
<a name="l00144"></a>00144     my @sets = $db-&gt;getMergedSets( @userSetIDs );
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     debug(<span class="stringliteral">&quot;Begin fixing merged sets&quot;</span>);
<a name="l00147"></a>00147     
<a name="l00148"></a>00148 <span class="preprocessor">    # Database fix (in case of undefined visible values)</span>
<a name="l00149"></a>00149 <span class="preprocessor"></span><span class="preprocessor">    # this may take some extra time the first time but should NEVER need to be run twice</span>
<a name="l00150"></a>00150 <span class="preprocessor"></span><span class="preprocessor">    # this is only necessary because some people keep holding to ww1.9 which did not have a visible field</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span><span class="preprocessor">    # DBFIXME this should be in the database layer (along with other &quot;fixes&quot; of its ilk)</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $set (@sets) {
<a name="l00153"></a>00153 <span class="preprocessor">        # make sure visible is set to 0 or 1</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $set and $set-&gt;visible ne <span class="stringliteral">&quot;0&quot;</span> and $set-&gt;visible ne <span class="stringliteral">&quot;1&quot;</span>) {
<a name="l00155"></a>00155             my $globalSet = $db-&gt;getGlobalSet($set-&gt;set_id);
<a name="l00156"></a>00156             $globalSet-&gt;visible(<span class="stringliteral">&quot;1&quot;</span>);   # defaults to visible
<a name="l00157"></a>00157             $db-&gt;putGlobalSet($globalSet);
<a name="l00158"></a>00158             $set = $db-&gt;getMergedSet($effectiveUser, $set-&gt;set_id);
<a name="l00159"></a>00159         } <span class="keywordflow">else</span> {
<a name="l00160"></a>00160             die <span class="stringliteral">&quot;set $set not defined&quot;</span> unless $set;
<a name="l00161"></a>00161         }
<a name="l00162"></a>00162     }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164     <span class="keywordflow">foreach</span> my $set (@sets) {
<a name="l00165"></a>00165 <span class="preprocessor">        # make sure enable_reduced_scoring is set to 0 or 1</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $set and $set-&gt;enable_reduced_scoring ne <span class="stringliteral">&quot;0&quot;</span> and $set-&gt;enable_reduced_scoring ne <span class="stringliteral">&quot;1&quot;</span>) {
<a name="l00167"></a>00167             my $globalSet = $db-&gt;getGlobalSet($set-&gt;set_id);
<a name="l00168"></a>00168             $globalSet-&gt;enable_reduced_scoring(<span class="stringliteral">&quot;0&quot;</span>);    # defaults to disabled
<a name="l00169"></a>00169             $db-&gt;putGlobalSet($globalSet);
<a name="l00170"></a>00170             $set = $db-&gt;getMergedSet($effectiveUser, $set-&gt;set_id);
<a name="l00171"></a>00171         } <span class="keywordflow">else</span> {
<a name="l00172"></a>00172             die <span class="stringliteral">&quot;set $set not defined&quot;</span> unless $set;
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174     }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="preprocessor"># gateways/versioned sets require dealing with output data slightly </span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="preprocessor"># differently, so check for those here  </span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;Begin set-type check&quot;</span>);
<a name="l00179"></a>00179     my $existVersions = 0;
<a name="l00180"></a>00180     my @gwSets = ();
<a name="l00181"></a>00181     my @nonGWsets = ();
<a name="l00182"></a>00182     my %gwSetNames = ();  # <span class="keyword">this</span> is necessary because we <span class="keyword">get</span> a setname
<a name="l00183"></a>00183 <span class="preprocessor">                          #    for all versions of g/w tests</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> ( @sets ) {
<a name="l00185"></a>00185         <span class="keywordflow">if</span> ( defined( $_-&gt;assignment_type() ) &amp;&amp; 
<a name="l00186"></a>00186          $_-&gt;assignment_type() =~ /gateway/ ) {
<a name="l00187"></a>00187         $existVersions = 1; 
<a name="l00188"></a>00188 
<a name="l00189"></a>00189         push( @gwSets, $_ ) if ( ! defined($gwSetNames{$_-&gt;set_id}) );
<a name="l00190"></a>00190         $gwSetNames{$_-&gt;set_id} = 1;
<a name="l00191"></a>00191         } <span class="keywordflow">else</span> {
<a name="l00192"></a>00192         push( @nonGWsets, $_ );
<a name="l00193"></a>00193         }
<a name="l00194"></a>00194     }
<a name="l00195"></a>00195 <span class="preprocessor"># now get all user set versions that we need</span>
<a name="l00196"></a>00196 <span class="preprocessor"></span>    my @vSets = ();
<a name="l00197"></a>00197 <span class="preprocessor"># we need the template sets below, so also make an indexed list of those</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span>    my %gwSetsBySetID = ();
<a name="l00199"></a>00199     <span class="keywordflow">foreach</span> my $set ( @gwSets ) {
<a name="l00200"></a>00200         $gwSetsBySetID{$set-&gt;set_id} = $set;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202         my @setVer = $db-&gt;listSetVersions( $effectiveUser, $set-&gt;set_id );
<a name="l00203"></a>00203         my @setVerIDs = map { [ $effectiveUser, $set-&gt;set_id, $_ ] } @setVer;
<a name="l00204"></a>00204         push( @vSets, $db-&gt;getMergedSetVersions( @setVerIDs ) );
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 <span class="preprocessor"># set sort method</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span>    $sort = <span class="stringliteral">&quot;status&quot;</span> unless $sort eq <span class="stringliteral">&quot;status&quot;</span> or $sort eq <span class="stringliteral">&quot;name&quot;</span>;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 <span class="preprocessor"># now set the headers for the table</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span>    my $nameHeader = $sort eq <span class="stringliteral">&quot;name&quot;</span>
<a name="l00212"></a>00212         ? CGI::u($r-&gt;maketext(<span class="stringliteral">&quot;Name&quot;</span>))
<a name="l00213"></a>00213         : CGI::a({href=&gt;$self-&gt;systemLink($urlpath, params=&gt;{sort=&gt;<span class="stringliteral">&quot;name&quot;</span>})}, $r-&gt;maketext(<span class="stringliteral">&quot;Name&quot;</span>));
<a name="l00214"></a>00214     my $statusHeader = $sort eq <span class="stringliteral">&quot;status&quot;</span>
<a name="l00215"></a>00215         ? CGI::u($r-&gt;maketext(<span class="stringliteral">&quot;Status&quot;</span>))
<a name="l00216"></a>00216         : CGI::a({href=&gt;$self-&gt;systemLink($urlpath, params=&gt;{sort=&gt;<span class="stringliteral">&quot;status&quot;</span>})}, $r-&gt;maketext(<span class="stringliteral">&quot;Status&quot;</span>));
<a name="l00217"></a>00217 <span class="preprocessor"># print the start of the form</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span>
<a name="l00219"></a>00219     print CGI::start_form(-method=&gt;<span class="stringliteral">&quot;POST&quot;</span>,-action=&gt;$actionURL),
<a name="l00220"></a>00220           $self-&gt;hidden_authen_fields;
<a name="l00221"></a>00221     
<a name="l00222"></a>00222 <span class="preprocessor"># and send the start of the table</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span><span class="preprocessor"># UPDATE - ghe3</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span><span class="preprocessor"># This table now contains a summary and a caption, scope attributes for the column headers, and no longer prints a column for &#39;Sel.&#39; (due to it having been merged with the second column for accessibility purposes).</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span>    print CGI::start_table({ -<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;problem_set_table&quot;</span>, -summary=&gt;<span class="stringliteral">&quot;This table lists out the available homework sets for this class, along with its current status. Click on the link on the name of the homework sets to take you to the problems in that homework set.  Clicking on the links in the table headings will sort the table by the field it corresponds to.  You can also select sets for download to PDF or TeX format using the radio buttons or checkboxes next to the problem set names, and then clicking on the &#39;Download PDF or TeX Hardcopy for Selected Sets&#39; button at the end of the table.  There is also a clear button and an Email instructor button at the end of the table.&quot;</span>});
<a name="l00226"></a>00226     print CGI::caption($r-&gt;maketext(<span class="stringliteral">&quot;Homework Sets&quot;</span>));
<a name="l00227"></a>00227     <span class="keywordflow">if</span> ( ! $existVersions ) {
<a name="l00228"></a>00228         print CGI::Tr({},
<a name="l00229"></a>00229             CGI::th({-scope=&gt;<span class="stringliteral">&quot;col&quot;</span>},$nameHeader),
<a name="l00230"></a>00230             CGI::th({-scope=&gt;<span class="stringliteral">&quot;col&quot;</span>},$statusHeader),
<a name="l00231"></a>00231             );
<a name="l00232"></a>00232     } <span class="keywordflow">else</span> {
<a name="l00233"></a>00233         print CGI::Tr(
<a name="l00234"></a>00234             CGI::th({-scope=&gt;<span class="stringliteral">&quot;col&quot;</span>},$nameHeader),
<a name="l00235"></a>00235             CGI::th({-scope=&gt;<span class="stringliteral">&quot;col&quot;</span>},$r-&gt;maketext(<span class="stringliteral">&quot;Test Score&quot;</span>)),
<a name="l00236"></a>00236             CGI::th({-scope=&gt;<span class="stringliteral">&quot;col&quot;</span>},$r-&gt;maketext(<span class="stringliteral">&quot;Test Date&quot;</span>)),
<a name="l00237"></a>00237             CGI::th({-scope=&gt;<span class="stringliteral">&quot;col&quot;</span>},$statusHeader),
<a name="l00238"></a>00238             );
<a name="l00239"></a>00239     }
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     debug(<span class="stringliteral">&quot;Begin sorting merged sets&quot;</span>);
<a name="l00242"></a>00242 
<a name="l00243"></a>00243 <span class="preprocessor"># before building final set lists, exclude proctored gateway sets </span>
<a name="l00244"></a>00244 <span class="preprocessor"></span><span class="preprocessor">#    for users without permission to view them</span>
<a name="l00245"></a>00245 <span class="preprocessor"></span>    my $viewPr = $authz-&gt;hasPermissions( $user, <span class="stringliteral">&quot;view_proctored_tests&quot;</span> );
<a name="l00246"></a>00246     @gwSets = grep {$_-&gt;assignment_type !~ /proctored/ || $viewPr} @gwSets;
<a name="l00247"></a>00247     
<a name="l00248"></a>00248     <span class="keywordflow">if</span> ( $sort eq <span class="stringliteral">&#39;name&#39;</span> ) {
<a name="l00249"></a>00249         @nonGWsets = sortByName(<span class="stringliteral">&quot;set_id&quot;</span>, @nonGWsets);
<a name="l00250"></a>00250         @gwSets = sortByName(<span class="stringliteral">&quot;set_id&quot;</span>, @gwSets);
<a name="l00251"></a>00251     } elsif ( $sort eq <span class="stringliteral">&#39;status&#39;</span> ) {
<a name="l00252"></a>00252         @nonGWsets = sort byUrgency  @nonGWsets;
<a name="l00253"></a>00253         @gwSets = sort byUrgency @gwSets;
<a name="l00254"></a>00254     }
<a name="l00255"></a>00255 <span class="preprocessor"># we sort set versions by name</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span>    @vSets = sortByName([<span class="stringliteral">&quot;set_id&quot;</span>, <span class="stringliteral">&quot;version_id&quot;</span>], @vSets);
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="preprocessor"># put together a complete list of sorted sets to consider</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>    @sets = (@nonGWsets, @gwSets );
<a name="l00260"></a>00260     
<a name="l00261"></a>00261     debug(<span class="stringliteral">&quot;End preparing merged sets&quot;</span>);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263 <span class="preprocessor"># we do regular sets and the gateway set templates separately</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span><span class="preprocessor"># from the actual set-versions, to avoid managing a tricky test</span>
<a name="l00265"></a>00265 <span class="preprocessor"></span><span class="preprocessor"># for a version number that may not exist</span>
<a name="l00266"></a>00266 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> my $set (@sets) {
<a name="l00267"></a>00267         die <span class="stringliteral">&quot;set $set not defined&quot;</span> unless $set;
<a name="l00268"></a>00268         
<a name="l00269"></a>00269         <span class="keywordflow">if</span> ($set-&gt;visible || $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_hidden_sets&quot;</span>)) {
<a name="l00270"></a>00270             print $self-&gt;setListRow($set, $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_multiple_sets&quot;</span>), $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_unopened_sets&quot;</span>),$existVersions,$db);
<a name="l00271"></a>00271         }
<a name="l00272"></a>00272     }
<a name="l00273"></a>00273     <span class="keywordflow">foreach</span> my $set (@vSets) {
<a name="l00274"></a>00274         die <span class="stringliteral">&quot;set $set not defined&quot;</span> unless $set;
<a name="l00275"></a>00275         
<a name="l00276"></a>00276         <span class="keywordflow">if</span> ($set-&gt;visible || $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_hidden_sets&quot;</span>)) {
<a name="l00277"></a>00277             print $self-&gt;setListRow($set, $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_multiple_sets&quot;</span>), $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_unopened_sets&quot;</span>),$existVersions,$db,1, $gwSetsBySetID{$set-&gt;{set_id}}, <span class="stringliteral">&quot;ethet&quot;</span> );  # 1 = gateway, versioned <span class="keyword">set</span>
<a name="l00278"></a>00278         }
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280     
<a name="l00281"></a>00281     print CGI::end_table();
<a name="l00282"></a>00282     my $pl = ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_multiple_sets&quot;</span>) ? <span class="stringliteral">&quot;s&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00283"></a>00283 <span class="preprocessor">#   print CGI::p(CGI::submit(-name=&gt;&quot;hardcopy&quot;, -label=&gt;$r-&gt;maketext(&quot;Download Hardcopy for Selected [plural,_1,Set,Sets]&quot;,$pl)));</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span>
<a name="l00285"></a>00285 <span class="preprocessor">    # UPDATE - ghe3</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span><span class="preprocessor">    # Added reset button to form.</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span>    print CGI::start_div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;problem_set_options&quot;</span>});
<a name="l00288"></a>00288     print CGI::p(<a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;reset&quot;</span>, -input_attr=&gt;{-value=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Clear&quot;</span>)}));
<a name="l00289"></a>00289     print CGI::p(<a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, -input_attr=&gt;{-name=&gt;<span class="stringliteral">&quot;hardcopy&quot;</span>, -value=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Download PDF or TeX Hardcopy for Selected Sets&quot;</span>)}));
<a name="l00290"></a>00290     print CGI::endform();
<a name="l00291"></a>00291     
<a name="l00292"></a>00292 <span class="preprocessor">    ## feedback form url</span>
<a name="l00293"></a>00293 <span class="preprocessor"></span><span class="preprocessor">    #my $feedbackPage = $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Feedback&quot;,  $r, courseID =&gt; $courseName);</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span><span class="preprocessor">    #my $feedbackURL = $self-&gt;systemLink($feedbackPage, authen =&gt; 0); # no authen info for form action</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span><span class="preprocessor">    ##print feedback form</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span><span class="preprocessor">    #print</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::start_form(-method=&gt;&quot;POST&quot;, -action=&gt;$feedbackURL),&quot;\n&quot;,</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span><span class="preprocessor">    #   $self-&gt;hidden_authen_fields,&quot;\n&quot;,</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::hidden(&quot;module&quot;,             __PACKAGE__),&quot;\n&quot;,</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::hidden(&quot;set&quot;,                &#39;&#39;),&quot;\n&quot;,</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::hidden(&quot;problem&quot;,            &#39;&#39;),&quot;\n&quot;,</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::hidden(&quot;displayMode&quot;,        &#39;&#39;),&quot;\n&quot;,</span>
<a name="l00304"></a>00304 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::hidden(&quot;showOldAnswers&quot;,     &#39;&#39;),&quot;\n&quot;,</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::hidden(&quot;showCorrectAnswers&quot;, &#39;&#39;),&quot;\n&quot;,</span>
<a name="l00306"></a>00306 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::hidden(&quot;showHints&quot;,          &#39;&#39;),&quot;\n&quot;,</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::hidden(&quot;showSolutions&quot;,      &#39;&#39;),&quot;\n&quot;,</span>
<a name="l00308"></a>00308 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::p({-align=&gt;&quot;left&quot;},</span>
<a name="l00309"></a>00309 <span class="preprocessor"></span><span class="preprocessor">    #       CGI::submit(-name=&gt;&quot;feedbackForm&quot;, -label=&gt;&quot;Email instructor&quot;)</span>
<a name="l00310"></a>00310 <span class="preprocessor"></span><span class="preprocessor">    #   ),</span>
<a name="l00311"></a>00311 <span class="preprocessor"></span><span class="preprocessor">    #   CGI::endform(),&quot;\n&quot;;</span>
<a name="l00312"></a>00312 <span class="preprocessor"></span>    
<a name="l00313"></a>00313     print $self-&gt;feedbackMacro(
<a name="l00314"></a>00314         module =&gt; __PACKAGE__,
<a name="l00315"></a>00315         <span class="keyword">set</span> =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00316"></a>00316         problem =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00317"></a>00317         displayMode =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00318"></a>00318         showOldAnswers =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00319"></a>00319         showCorrectAnswers =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00320"></a>00320         showHints =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00321"></a>00321         showSolutions =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00322"></a>00322     );
<a name="l00323"></a>00323     print CGI::end_div();
<a name="l00324"></a>00324     
<a name="l00325"></a>00325     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 <span class="preprocessor"># UPDATE - ghe3</span>
<a name="l00329"></a>00329 <span class="preprocessor"></span><span class="preprocessor"># this subroutine now combines the $control and $interactive elements, by using the $interactive element as the $control element&#39;s label.</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>
<a name="l00331"></a>00331 sub setListRow {
<a name="l00332"></a>00332     my ($self, $set, $multiSet, $preOpenSets, $existVersions, $db,
<a name="l00333"></a>00333         $gwtype, $tmplSet) = @_;
<a name="l00334"></a>00334     my $r = $self-&gt;r;
<a name="l00335"></a>00335     my $ce = $r-&gt;ce;
<a name="l00336"></a>00336     my $authz = $r-&gt;authz;
<a name="l00337"></a>00337     my $user = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00338"></a>00338     my $urlpath = $r-&gt;urlpath;
<a name="l00339"></a>00339     $gwtype = 0 <span class="keywordflow">if</span> ( ! defined( $gwtype ) );
<a name="l00340"></a>00340     $tmplSet = $set <span class="keywordflow">if</span> ( ! defined( $tmplSet ) );
<a name="l00341"></a>00341     
<a name="l00342"></a>00342     my $name = $set-&gt;set_id;
<a name="l00343"></a>00343     my $urlname = ( $gwtype == 1 ) ? <span class="stringliteral">&quot;$name,v&quot;</span> . $set-&gt;version_id : $name;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     my $courseName      = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00346"></a>00346     
<a name="l00347"></a>00347     my $problemSetPage;
<a name="l00348"></a>00348 
<a name="l00349"></a>00349     <span class="keywordflow">if</span> ( ! defined( $set-&gt;assignment_type() ) || 
<a name="l00350"></a>00350          $set-&gt;assignment_type() !~ /gateway/ ) {
<a name="l00351"></a>00351         $problemSetPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::ProblemSet&quot;</span>, $r, 
<a name="l00352"></a>00352                       courseID =&gt; $courseName, setID =&gt; $urlname);
<a name="l00353"></a>00353     } elsif( $set-&gt;assignment_type() !~ /proctored/ ) {
<a name="l00354"></a>00354 
<a name="l00355"></a>00355         $problemSetPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::GatewayQuiz&quot;</span>, $r, 
<a name="l00356"></a>00356                       courseID =&gt; $courseName, setID =&gt; $urlname);
<a name="l00357"></a>00357     } <span class="keywordflow">else</span> {
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         $problemSetPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::GatewayQuiz&quot;</span>, $r, 
<a name="l00360"></a>00360                       courseID =&gt; $courseName, setID =&gt; $urlname);
<a name="l00361"></a>00361     }
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     my $interactiveURL = $self-&gt;systemLink($problemSetPage,
<a name="l00364"></a>00364                                            params=&gt;{  displayMode =&gt; $self-&gt;{displayMode}, 
<a name="l00365"></a>00365                                                       showOldAnswers =&gt; $self-&gt;{will}-&gt;{showOldAnswers}
<a name="l00366"></a>00366                                            }
<a name="l00367"></a>00367     );
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 <span class="preprocessor">  # check to see if this is a template gateway assignment</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span>    $gwtype = 2 <span class="keywordflow">if</span> ( defined( $set-&gt;assignment_type() ) &amp;&amp; 
<a name="l00371"></a>00371              $set-&gt;assignment_type() =~ /gateway/ &amp;&amp; ! $gwtype );
<a name="l00372"></a>00372 <span class="preprocessor">  # and get problemRecords if we&#39;re dealing with a versioned set, so that</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span><span class="preprocessor">  #    we can test status and scores</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span><span class="preprocessor">  # FIXME: should we really have to get the merged </span>
<a name="l00375"></a>00375 <span class="preprocessor"></span><span class="preprocessor">  # problem_versions here?  it looks that way, because</span>
<a name="l00376"></a>00376 <span class="preprocessor"></span><span class="preprocessor">  # otherwise we don&#39;t inherit things like the problem</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span><span class="preprocessor">  # value properly.</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span>    my @problemRecords = 
<a name="l00379"></a>00379         $db-&gt;getAllProblemVersions($set-&gt;user_id(), $set-&gt;set_id(),
<a name="l00380"></a>00380                        $set-&gt;version_id()) 
<a name="l00381"></a>00381         <span class="keywordflow">if</span> ( $gwtype == 1 );
<a name="l00382"></a>00382 
<a name="l00383"></a>00383 <span class="preprocessor">  # the conditional here should be redundant.  ah well.</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span>    $interactiveURL =~ s|/quiz_mode/|/proctored_quiz_mode/| <span class="keywordflow">if</span> 
<a name="l00385"></a>00385         ( defined( $set-&gt;assignment_type() ) &amp;&amp; 
<a name="l00386"></a>00386           $set-&gt;assignment_type() eq <span class="stringliteral">&#39;proctored_gateway&#39;</span> );
<a name="l00387"></a>00387     
<a name="l00388"></a>00388     $name =~ s/_/&amp;nbsp;/g;
<a name="l00389"></a>00389 <span class="preprocessor"># this is the link to the homework assignment</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>    my $interactive = CGI::a({-href=&gt;$interactiveURL}, <span class="stringliteral">&quot;$name&quot;</span>);
<a name="l00391"></a>00391     
<a name="l00392"></a>00392     my $control = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00393"></a>00393     
<a name="l00394"></a>00394     my $setIsOpen = 0;
<a name="l00395"></a>00395     my $status = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00396"></a>00396     <span class="keywordflow">if</span> ( $gwtype ) {
<a name="l00397"></a>00397         <span class="keywordflow">if</span> ( $gwtype == 1 ) {
<a name="l00398"></a>00398           unless (ref($problemRecords[0]) ) {warn <span class="stringliteral">&quot;Error: problem not defined in set $name&quot;</span>; <span class="keywordflow">return</span>()}
<a name="l00399"></a>00399             <span class="keywordflow">if</span> ( $problemRecords[0]-&gt;num_correct() + 
<a name="l00400"></a>00400                  $problemRecords[0]-&gt;num_incorrect() &gt;= 
<a name="l00401"></a>00401                  ( ( !($set-&gt;attempts_per_version()) ) ? 0 : $set-&gt;attempts_per_version() ) ) {
<a name="l00402"></a>00402                 $status = $r-&gt;maketext(<span class="stringliteral">&quot;completed.&quot;</span>);
<a name="l00403"></a>00403             } elsif ( time() &gt; $set-&gt;due_date() + 
<a name="l00404"></a>00404                   $self-&gt;r-&gt;ce-&gt;{gatewayGracePeriod} ) {
<a name="l00405"></a>00405                 $status = $r-&gt;maketext(<span class="stringliteral">&quot;over time: closed.&quot;</span>);
<a name="l00406"></a>00406             } <span class="keywordflow">else</span> {
<a name="l00407"></a>00407                 $status = $r-&gt;maketext(<span class="stringliteral">&quot;open: complete by [_1]&quot;</span>,  
<a name="l00408"></a>00408                     $self-&gt;formatDateTime($set-&gt;due_date()));
<a name="l00409"></a>00409             }
<a name="l00410"></a>00410 <span class="preprocessor">            # we let people go back to old tests</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span>            $setIsOpen = 1;
<a name="l00412"></a>00412 
<a name="l00413"></a>00413 <span class="preprocessor">            # reset the link to give the test number</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span>            my $vnum = $set-&gt;version_id;
<a name="l00415"></a>00415             $interactive = CGI::a({-href=&gt;$interactiveURL},
<a name="l00416"></a>00416                           $r-&gt;maketext(<span class="stringliteral">&quot;[_1] (test [_2])&quot;</span>, $name, $vnum));
<a name="l00417"></a>00417         } <span class="keywordflow">else</span> {
<a name="l00418"></a>00418             my $t = time();
<a name="l00419"></a>00419             <span class="keywordflow">if</span> ( $t &lt; $set-&gt;open_date() ) {
<a name="l00420"></a>00420                 $status = $r-&gt;maketext(<span class="stringliteral">&quot;will open on [_1]&quot;</span>, $self-&gt;formatDateTime($set-&gt;open_date));
<a name="l00421"></a>00421                 <span class="keywordflow">if</span> ( $preOpenSets ) {
<a name="l00422"></a>00422 <span class="preprocessor">                    # reset the link</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>                    $interactive = CGI::a({-href=&gt;$interactiveURL},
<a name="l00424"></a>00424                                   $r-&gt;maketext(<span class="stringliteral">&quot;Take [_1] test&quot;</span>, $name));
<a name="l00425"></a>00425                 } <span class="keywordflow">else</span> {
<a name="l00426"></a>00426                     $control = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00427"></a>00427                     $interactive = $r-&gt;maketext(<span class="stringliteral">&quot;[_1] test&quot;</span>, $name);
<a name="l00428"></a>00428                 }
<a name="l00429"></a>00429             } elsif ( $t &lt; $set-&gt;due_date() ) {
<a name="l00430"></a>00430                 $status = $r-&gt;maketext(<span class="stringliteral">&quot;now open, due &quot;</span>) . $self-&gt;formatDateTime($set-&gt;due_date);
<a name="l00431"></a>00431                 $setIsOpen = 1;
<a name="l00432"></a>00432                 $interactive = CGI::a({-href=&gt;$interactiveURL},
<a name="l00433"></a>00433                               $r-&gt;maketext(<span class="stringliteral">&quot;Take [_1] test&quot;</span>, $name));
<a name="l00434"></a>00434             } <span class="keywordflow">else</span> {
<a name="l00435"></a>00435                 $status = $r-&gt;maketext(<span class="stringliteral">&quot;Closed&quot;</span>);
<a name="l00436"></a>00436 
<a name="l00437"></a>00437                 <span class="keywordflow">if</span> ( $authz-&gt;hasPermissions( $user, <span class="stringliteral">&quot;record_answers_after_due_date&quot;</span> ) ) {
<a name="l00438"></a>00438                     $interactive = CGI::a({-href=&gt;$interactiveURL},
<a name="l00439"></a>00439                                   $r-&gt;maketext(<span class="stringliteral">&quot;Take [_1] test&quot;</span>, $name));
<a name="l00440"></a>00440                 } <span class="keywordflow">else</span> {
<a name="l00441"></a>00441                     $interactive = $r-&gt;maketext(<span class="stringliteral">&quot;[_1] test&quot;</span>, $name);
<a name="l00442"></a>00442                 }
<a name="l00443"></a>00443             }
<a name="l00444"></a>00444         }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 <span class="preprocessor"># old conditional</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span>    } elsif (time &lt; $set-&gt;open_date) {
<a name="l00448"></a>00448         $status = $r-&gt;maketext(<span class="stringliteral">&quot;will open on [_1]&quot;</span>, $self-&gt;formatDateTime($set-&gt;open_date));
<a name="l00449"></a>00449         $control = <span class="stringliteral">&quot;&quot;</span> unless $preOpenSets;
<a name="l00450"></a>00450         $interactive = $name unless $preOpenSets;
<a name="l00451"></a>00451     } elsif (time &lt; $set-&gt;due_date) {
<a name="l00452"></a>00452             $status = $r-&gt;maketext(<span class="stringliteral">&quot;now open, due &quot;</span>) . $self-&gt;formatDateTime($set-&gt;due_date);
<a name="l00453"></a>00453             my $enable_reduced_scoring = $set-&gt;enable_reduced_scoring;
<a name="l00454"></a>00454             my $reducedScoringPeriod = $ce-&gt;{pg}-&gt;{ansEvalDefaults}-&gt;{reducedScoringPeriod};
<a name="l00455"></a>00455             <span class="keywordflow">if</span> ($reducedScoringPeriod &gt; 0 and $enable_reduced_scoring ) {
<a name="l00456"></a>00456                 my $reducedScoringPeriodSec = $reducedScoringPeriod*60;   # $reducedScoringPeriod is in minutes
<a name="l00457"></a>00457                 my $beginReducedScoringPeriod =  $self-&gt;formatDateTime($set-&gt;due_date() - $reducedScoringPeriodSec);
<a name="l00458"></a>00458 <span class="preprocessor">#               $status .= &#39;. &lt;FONT COLOR=&quot;#cc6600&quot;&gt;Reduced Credit starts &#39; . $beginReducedScoringPeriod . &#39;&lt;/FONT&gt;&#39;;</span>
<a name="l00459"></a>00459 <span class="preprocessor"></span>                $status .= CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsAlert&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Reduced Credit Starts: [_1]&quot;</span>, $beginReducedScoringPeriod));
<a name="l00460"></a>00460 
<a name="l00461"></a>00461             }
<a name="l00462"></a>00462         $setIsOpen = 1;
<a name="l00463"></a>00463     } elsif (time &lt; $set-&gt;answer_date) {
<a name="l00464"></a>00464         $status = $r-&gt;maketext(<span class="stringliteral">&quot;closed, answers on [_1]&quot;</span>, $self-&gt;formatDateTime($set-&gt;answer_date));
<a name="l00465"></a>00465     } elsif ($set-&gt;answer_date &lt;= time and time &lt; $set-&gt;answer_date +RECENT ) {
<a name="l00466"></a>00466         $status = $r-&gt;maketext(<span class="stringliteral">&quot;closed, answers recently available&quot;</span>);
<a name="l00467"></a>00467     } <span class="keywordflow">else</span> {
<a name="l00468"></a>00468         $status = $r-&gt;maketext(<span class="stringliteral">&quot;closed, answers available&quot;</span>);
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470     
<a name="l00471"></a>00471     <span class="keywordflow">if</span> ($multiSet) {
<a name="l00472"></a>00472         <span class="keywordflow">if</span> ( $gwtype &lt; 2 ) {
<a name="l00473"></a>00473             $control = <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(
<a name="l00474"></a>00474                 -type=&gt;<span class="stringliteral">&quot;checkbox&quot;</span>,
<a name="l00475"></a>00475                 -<span class="keywordtype">id</span>=&gt;$name . ($gwtype ? <span class="stringliteral">&quot;,v&quot;</span> . $set-&gt;version_id : <span class="stringliteral">&#39;&#39;</span>),
<a name="l00476"></a>00476                 -label_text=&gt;$interactive,
<a name="l00477"></a>00477                 -input_attr=&gt;{
<a name="l00478"></a>00478                     -name=&gt;<span class="stringliteral">&quot;selected_sets&quot;</span>,
<a name="l00479"></a>00479                     -value=&gt;$name . ($gwtype ? <span class="stringliteral">&quot;,v&quot;</span> . $set-&gt;version_id : <span class="stringliteral">&#39;&#39;</span>)
<a name="l00480"></a>00480                     }
<a name="l00481"></a>00481             );
<a name="l00482"></a>00482         } <span class="keywordflow">else</span> {
<a name="l00483"></a>00483             $control = $interactive;
<a name="l00484"></a>00484         }
<a name="l00485"></a>00485     } <span class="keywordflow">else</span> {
<a name="l00486"></a>00486         <span class="keywordflow">if</span> ( $gwtype &lt; 2 ) {
<a name="l00487"></a>00487             my $n = $name  . ($gwtype ? <span class="stringliteral">&quot;,v&quot;</span> . $set-&gt;version_id : <span class="stringliteral">&#39;&#39;</span>);
<a name="l00488"></a>00488             $control = <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(
<a name="l00489"></a>00489                 -type=&gt;<span class="stringliteral">&quot;radio&quot;</span>,
<a name="l00490"></a>00490                 -<span class="keywordtype">id</span>=&gt;$n,
<a name="l00491"></a>00491                 -label_text=&gt;$interactive,
<a name="l00492"></a>00492                 -input_attr=&gt;{
<a name="l00493"></a>00493                     -name=&gt;<span class="stringliteral">&quot;selected_sets&quot;</span>,
<a name="l00494"></a>00494                     -value=&gt;$n
<a name="l00495"></a>00495                     }
<a name="l00496"></a>00496             );
<a name="l00497"></a>00497         } <span class="keywordflow">else</span> {
<a name="l00498"></a>00498             $control = $interactive;
<a name="l00499"></a>00499         }
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     my $visiblityStateClass = ($set-&gt;visible) ? <span class="stringliteral">&quot;visible&quot;</span> : <span class="stringliteral">&quot;hidden&quot;</span>;
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     $status = CGI::font({<span class="keyword">class</span>=&gt;$visiblityStateClass}, $status) <span class="keywordflow">if</span> $preOpenSets;
<a name="l00505"></a>00505     
<a name="l00506"></a>00506 <span class="preprocessor"># check to see if we need to return a score and a date column</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! $existVersions ) {
<a name="l00508"></a>00508         <span class="keywordflow">return</span> CGI::Tr(CGI::td([
<a name="l00509"></a>00509                  $control,
<a name="l00510"></a>00510                      $status,
<a name="l00511"></a>00511         ]));
<a name="l00512"></a>00512     } <span class="keywordflow">else</span> {
<a name="l00513"></a>00513         my ( $startTime, $score );
<a name="l00514"></a>00514 
<a name="l00515"></a>00515         <span class="keywordflow">if</span> ( defined( $set-&gt;assignment_type() ) &amp;&amp; 
<a name="l00516"></a>00516              $set-&gt;assignment_type() =~ /gateway/ &amp;&amp; $gwtype == 1 ) {
<a name="l00517"></a>00517             $startTime = localtime($set-&gt;version_creation_time() || 0); #fixes error message <span class="keywordflow">for</span> undefined creation_time
<a name="l00518"></a>00518 
<a name="l00519"></a>00519             <span class="keywordflow">if</span> ( $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) || 
<a name="l00520"></a>00520                  $set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;Y&#39;</span> ||
<a name="l00521"></a>00521                  $set-&gt;hide_score() eq <span class="charliteral">&#39;N&#39;</span> || 
<a name="l00522"></a>00522                  ( $set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp; time &gt; $tmplSet-&gt;answer_date() ) ) {
<a name="l00523"></a>00523 <span class="preprocessor">                # find score</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span>
<a name="l00525"></a>00525 <span class="preprocessor">            # DBFIXME we can do this math in the database, i think</span>
<a name="l00526"></a>00526 <span class="preprocessor"></span>                my $possible = 0;
<a name="l00527"></a>00527                 $score = 0;
<a name="l00528"></a>00528                 <span class="keywordflow">foreach</span> my $pRec ( @problemRecords ) {
<a name="l00529"></a>00529                     my $pval = $pRec-&gt;value() ? $pRec-&gt;value() : 1;
<a name="l00530"></a>00530                         <span class="keywordflow">if</span> ( defined( $pRec ) &amp;&amp; 
<a name="l00531"></a>00531                          $score ne <span class="stringliteral">&#39;undef&#39;</span> ) {
<a name="l00532"></a>00532                         $score += $pRec-&gt;status()*$pval || 0;
<a name="l00533"></a>00533                     } <span class="keywordflow">else</span> {
<a name="l00534"></a>00534                         $score = <span class="stringliteral">&#39;undef&#39;</span>;
<a name="l00535"></a>00535                     }
<a name="l00536"></a>00536                     $possible += $pval;
<a name="l00537"></a>00537                 }
<a name="l00538"></a>00538                 $score = <span class="stringliteral">&quot;$score/$possible&quot;</span>;
<a name="l00539"></a>00539             } <span class="keywordflow">else</span> {
<a name="l00540"></a>00540                 $score = <span class="stringliteral">&quot;n/a&quot;</span>;
<a name="l00541"></a>00541             }
<a name="l00542"></a>00542         } <span class="keywordflow">else</span> {
<a name="l00543"></a>00543             $startTime = <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>;
<a name="l00544"></a>00544             $score = $startTime;
<a name="l00545"></a>00545         }
<a name="l00546"></a>00546         <span class="keywordflow">return</span> CGI::Tr(CGI::td([
<a name="l00547"></a>00547                              $control,
<a name="l00548"></a>00548                              $score,
<a name="l00549"></a>00549                              $startTime,
<a name="l00550"></a>00550                              $status,
<a name="l00551"></a>00551         ]));
<a name="l00552"></a>00552     }
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a>00555 sub byname { $a-&gt;set_id cmp $b-&gt;set_id; }
<a name="l00556"></a>00556 
<a name="l00557"></a>00557 sub byUrgency {
<a name="l00558"></a>00558     my $mytime = time;
<a name="l00559"></a>00559     my @a_parts = ($a-&gt;answer_date + RECENT &lt;= $mytime) ?  (4, $a-&gt;open_date, $a-&gt;due_date, $a-&gt;set_id) 
<a name="l00560"></a>00560         : ($a-&gt;answer_date &lt;= $mytime and $mytime &lt; $a-&gt;answer_date + RECENT) ? (3, $a-&gt; answer_date, $a-&gt; due_date, $a-&gt;set_id)
<a name="l00561"></a>00561         : ($a-&gt;due_date &lt;= $mytime and $mytime &lt; $a-&gt;answer_date ) ? (2, $a-&gt;answer_date, $a-&gt;due_date, $a-&gt;set_id)
<a name="l00562"></a>00562         : ($mytime &lt; $a-&gt;open_date) ? (1, $a-&gt;open_date, $a-&gt;due_date, $a-&gt;set_id) 
<a name="l00563"></a>00563         : (0, $a-&gt;due_date, $a-&gt;open_date, $a-&gt;set_id);
<a name="l00564"></a>00564     my @b_parts = ($b-&gt;answer_date + RECENT &lt;= $mytime) ?  (4, $b-&gt;open_date, $b-&gt;due_date, $b-&gt;set_id) 
<a name="l00565"></a>00565         : ($b-&gt;answer_date &lt;= $mytime and $mytime &lt; $b-&gt;answer_date + RECENT) ? (3, $b-&gt; answer_date, $b-&gt; due_date, $b-&gt;set_id)
<a name="l00566"></a>00566         : ($b-&gt;due_date &lt;= $mytime and $mytime &lt; $b-&gt;answer_date ) ? (2, $b-&gt;answer_date, $b-&gt;due_date, $b-&gt;set_id)
<a name="l00567"></a>00567         : ($mytime &lt; $b-&gt;open_date) ? (1, $b-&gt;open_date, $b-&gt;due_date, $b-&gt;set_id) 
<a name="l00568"></a>00568         : (0, $b-&gt;due_date, $b-&gt;open_date, $b-&gt;set_id);
<a name="l00569"></a>00569     my $returnIt=0;
<a name="l00570"></a>00570     <span class="keywordflow">while</span> (scalar(@a_parts) &gt; 1) {
<a name="l00571"></a>00571         <span class="keywordflow">if</span> ($returnIt = ( (shift @a_parts) &lt;=&gt; (shift @b_parts) ) ) {
<a name="l00572"></a>00572             <span class="keywordflow">return</span>($returnIt);
<a name="l00573"></a>00573         }
<a name="l00574"></a>00574     }
<a name="l00575"></a>00575     <span class="keywordflow">return</span> (  $a_parts[0] cmp  $b_parts[0] );
<a name="l00576"></a>00576 }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:35 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
