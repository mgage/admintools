<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: SendMail.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>SendMail.pm</h1><a href="SendMail_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/Instructor/SendMail.pm,v 1.64 2007/08/13 22:59:55 sh002i Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::Instructor::SendMail;
<a name="l00018"></a>00018 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">WeBWorK::ContentGenerator::Instructor</a>);
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 =head1 NAME
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html">WeBWorK::ContentGenerator::Instructor::SendMail</a> - Entry point <span class="keywordflow">for</span> User-specific data editing
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 =cut
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1SendMail.html">00026</a> use strict;
<a name="l00027"></a>00027 use warnings;
<a name="l00028"></a>00028 <span class="preprocessor">#use CGI qw(-nosticky );</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00030"></a>00030 use Email::Address;
<a name="l00031"></a>00031 use HTML::Entities;
<a name="l00032"></a>00032 use Mail::Sender;
<a name="l00033"></a>00033 use Socket qw/unpack_sockaddr_in inet_ntoa/; # <span class="keywordflow">for</span> remote host/port info
<a name="l00034"></a>00034 use Text::Wrap qw(wrap);
<a name="l00035"></a>00035 use WeBWorK::HTML::ScrollingRecordList qw/scrollingRecordList/;
<a name="l00036"></a>00036 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw/readFile readDirectory/;
<a name="l00037"></a>00037 use <a class="code" href="classWeBWorK_1_1Utils_1_1FilterRecords.html">WeBWorK::Utils::FilterRecords</a> qw/filterRecords/;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 use mod_perl;
<a name="l00040"></a>00040 use constant MP2 =&gt; ( exists $ENV{MOD_PERL_API_VERSION} and $ENV{MOD_PERL_API_VERSION} &gt;= 2 );
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#my $REFRESH_RESIZE_BUTTON = &quot;Set preview to: &quot;;  # handle submit value idiocy</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span>my $UPDATE_SETTINGS_BUTTON = <span class="stringliteral">&quot;Update settings and refresh page&quot;</span>; # handle submit value idiocy
<a name="l00044"></a>00044 sub initialize {
<a name="l00045"></a>00045     my ($self) = @_;
<a name="l00046"></a>00046     my $r      = $self-&gt;r;
<a name="l00047"></a>00047     my $db     = $r-&gt;db;
<a name="l00048"></a>00048     my $ce     = $r-&gt;ce;
<a name="l00049"></a>00049     my $authz  = $r-&gt;authz;
<a name="l00050"></a>00050     my $user   = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00051"></a>00051 
<a name="l00052"></a>00052     my @selected_filters;
<a name="l00053"></a>00053     <span class="keywordflow">if</span> (defined ($r-&gt;param(<span class="stringliteral">&#39;classList!filter&#39;</span>))){ @selected_filters = $r-&gt;param(<span class="stringliteral">&#39;classList!filter&#39;</span>);}
<a name="l00054"></a>00054     <span class="keywordflow">else</span> {@selected_filters = (<span class="stringliteral">&quot;all&quot;</span>);}
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">    # Check permissions</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>    <span class="keywordflow">return</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
<a name="l00059"></a>00059     <span class="keywordflow">return</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;send_mail&quot;</span>);
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 <span class="preprocessor">    #############################################################################################</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor">    #   gather directory data</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>    my $emailDirectory    =    $ce-&gt;{courseDirs}-&gt;{email};
<a name="l00065"></a>00065     my $scoringDirectory  =    $ce-&gt;{courseDirs}-&gt;{scoring};
<a name="l00066"></a>00066     my $templateDirectory =    $ce-&gt;{courseDirs}-&gt;{templates};
<a name="l00067"></a>00067     
<a name="l00068"></a>00068     my $action            =    $r-&gt;param(<span class="stringliteral">&#39;action&#39;</span>) ; 
<a name="l00069"></a>00069     my $openfilename      =    $r-&gt;param(<span class="stringliteral">&#39;openfilename&#39;</span>);
<a name="l00070"></a>00070     my $savefilename      =    $r-&gt;param(<span class="stringliteral">&#39;savefilename&#39;</span>);
<a name="l00071"></a>00071     
<a name="l00072"></a>00072     
<a name="l00073"></a>00073 <span class="preprocessor">    #FIXME  get these values from global course environment (see subroutines as well)</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>    my $default_msg_file       =    <span class="stringliteral">&#39;default.msg&#39;</span>;  
<a name="l00075"></a>00075     my $old_default_msg_file   =    <span class="stringliteral">&#39;old_default.msg&#39;</span>;
<a name="l00076"></a>00076     
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="preprocessor">    #  get user record</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span>    my $ur = $self-&gt;{db}-&gt;getUser($user);
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="preprocessor">    # store data</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>    $self-&gt;{defaultFrom}            =   $ur-&gt;rfc822_mailbox;
<a name="l00083"></a>00083     $self-&gt;{defaultReply}           =   $ur-&gt;rfc822_mailbox;
<a name="l00084"></a>00084     $self-&gt;{defaultSubject}         =   $self-&gt;r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>) . <span class="stringliteral">&quot; notice&quot;</span>;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     $self-&gt;{rows}                   =   (defined($r-&gt;param(<span class="stringliteral">&#39;rows&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;rows&#39;</span>) : $ce-&gt;{mail}-&gt;{editor_window_rows};
<a name="l00087"></a>00087     $self-&gt;{columns}                =   (defined($r-&gt;param(<span class="stringliteral">&#39;columns&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;columns&#39;</span>) : $ce-&gt;{mail}-&gt;{editor_window_columns};
<a name="l00088"></a>00088     $self-&gt;{default_msg_file}       =   $default_msg_file;
<a name="l00089"></a>00089     $self-&gt;{old_default_msg_file}   =   $old_default_msg_file;
<a name="l00090"></a>00090     $self-&gt;{merge_file}             =   (defined($r-&gt;param(<span class="stringliteral">&#39;merge_file&#39;</span>  )))    ? $r-&gt;param(<span class="stringliteral">&#39;merge_file&#39;</span>)   : <span class="stringliteral">&#39;None&#39;</span>;
<a name="l00091"></a>00091 <span class="preprocessor">    #$self-&gt;{preview_user}           =   (defined($r-&gt;param(&#39;preview_user&#39;)))    ? $r-&gt;param(&#39;preview_user&#39;) : $user;</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">    # an expermiment -- share the scrolling list for preivew and sendTo actions.</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span>    my <span class="keyword">@class</span>List                   =   (defined($r-&gt;param(<span class="stringliteral">&#39;classList&#39;</span>)))    ? $r-&gt;param(<span class="stringliteral">&#39;classList&#39;</span>) : ($user);
<a name="l00094"></a>00094     $self-&gt;{preview_user}           =   $classList[0] || $user;
<a name="l00095"></a>00095     
<a name="l00096"></a>00096 <span class="preprocessor">    #############################################################################################</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="preprocessor">    #   gather database data</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="preprocessor">    # FIXME  this might be better done in body? We don&#39;t always need all of this data. or do we?</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span><span class="preprocessor">    # DBFIXME shouldn&#39;t need ID list</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="preprocessor">    # DBFIXME do filtering in database</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span>    my @users =  $db-&gt;listUsers;
<a name="l00103"></a>00103     my @Users = $db-&gt;getUsers(@users);
<a name="l00104"></a>00104 <span class="preprocessor">    # filter out users who don&#39;t get included in email (fixes bug #938)</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span>    @Users = grep { $ce-&gt;status_abbrev_has_behavior($_-&gt;status, <span class="stringliteral">&quot;include_in_email&quot;</span>) } @Users;
<a name="l00106"></a>00106     my @user_records = ();
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="preprocessor">    ## Mark&#39;s code to prefilter userlist</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span><span class="preprocessor">    # DBFIXME more filtering that we can do in the database</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span>
<a name="l00111"></a>00111     
<a name="l00112"></a>00112     my (@viewable_sections,@viewable_recitations);
<a name="l00113"></a>00113     
<a name="l00114"></a>00114     <span class="keywordflow">if</span> (defined @{$ce-&gt;{viewable_sections}-&gt;{$user}})
<a name="l00115"></a>00115         {@viewable_sections = @{$ce-&gt;{viewable_sections}-&gt;{$user}};}
<a name="l00116"></a>00116     <span class="keywordflow">if</span> (defined @{$ce-&gt;{viewable_recitations}-&gt;{$user}})
<a name="l00117"></a>00117         {@viewable_recitations = @{$ce-&gt;{viewable_recitations}-&gt;{$user}};}
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <span class="keywordflow">if</span> (@viewable_sections or @viewable_recitations){
<a name="l00120"></a>00120         <span class="keywordflow">foreach</span> my $student (@Users){
<a name="l00121"></a>00121             my $keep = 0;
<a name="l00122"></a>00122             <span class="keywordflow">foreach</span> my $sec (@viewable_sections){
<a name="l00123"></a>00123                 <span class="keywordflow">if</span> ($student-&gt;section() eq $sec){$keep = 1;}
<a name="l00124"></a>00124             }
<a name="l00125"></a>00125             <span class="keywordflow">foreach</span> my $rec (@viewable_recitations){
<a name="l00126"></a>00126                 <span class="keywordflow">if</span> ($student-&gt;recitation() eq $rec){$keep = 1;}
<a name="l00127"></a>00127             }
<a name="l00128"></a>00128             <span class="keywordflow">if</span> ($keep) {push @user_records, $student;}
<a name="l00129"></a>00129         }
<a name="l00130"></a>00130     }
<a name="l00131"></a>00131     <span class="keywordflow">else</span> {@user_records = @Users;}
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 <span class="preprocessor">    ## End Mark&#39;s code</span>
<a name="l00134"></a>00134 <span class="preprocessor"></span>    
<a name="l00135"></a>00135 
<a name="l00136"></a>00136 <span class="preprocessor">    # replace the user names by a sorted version.</span>
<a name="l00137"></a>00137 <span class="preprocessor"></span>    @users                         =  map {$_-&gt;user_id} @user_records;
<a name="l00138"></a>00138 <span class="preprocessor">    # store data</span>
<a name="l00139"></a>00139 <span class="preprocessor"></span>    $self-&gt;{ra_users}              =   \@users;
<a name="l00140"></a>00140     $self-&gt;{ra_user_records}       =   \@user_records;
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 <span class="preprocessor">    #############################################################################################</span>
<a name="l00143"></a>00143 <span class="preprocessor"></span><span class="preprocessor">    #   gather list of recipients</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<a name="l00145"></a>00145 <span class="preprocessor"></span>    my @send_to                    =   ();  
<a name="l00146"></a>00146 <span class="preprocessor">    #FIXME  this (radio) is a lousy name</span>
<a name="l00147"></a>00147 <span class="preprocessor"></span>    my $recipients                 = $r-&gt;param(<span class="stringliteral">&#39;radio&#39;</span>);
<a name="l00148"></a>00148     <span class="keywordflow">if</span> (defined($recipients) and $recipients eq <span class="stringliteral">&#39;all_students&#39;</span>) {  #only active students #FIXME status check??
<a name="l00149"></a>00149         
<a name="l00150"></a>00150 <span class="preprocessor">        ## Add code so that only people who pass the current filters are added to our list of recipients.       </span>
<a name="l00151"></a>00151 <span class="preprocessor"></span><span class="preprocessor">        #   @user_records = filterRecords({filter=\@selected_filters},@user_records);</span>
<a name="l00152"></a>00152 <span class="preprocessor"></span><span class="preprocessor">        #  I wasn&#39;t able to make this work</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span><span class="preprocessor">        #  I edited the selection button to make that clear.</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span><span class="preprocessor">        #</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>
<a name="l00156"></a>00156         <span class="keywordflow">foreach</span> my $ur (@user_records) {
<a name="l00157"></a>00157             push(@send_to,$ur-&gt;user_id)
<a name="l00158"></a>00158                 if $ce-&gt;status_abbrev_has_behavior($ur-&gt;status, &quot;include_in_email&quot;)
<a name="l00159"></a>00159                     and not $ur-&gt;user_id =~ /practice/;
<a name="l00160"></a>00160         }
<a name="l00161"></a>00161     } elsif (defined($recipients) and $recipients eq &#39;studentID&#39; ) {
<a name="l00162"></a>00162         @send_to                   = $r-&gt;param(<span class="stringliteral">&#39;classList&#39;</span>);
<a name="l00163"></a>00163     } <span class="keywordflow">else</span> {
<a name="l00164"></a>00164 <span class="preprocessor">        # no recipients have been defined -- probably the first time on the page</span>
<a name="l00165"></a>00165 <span class="preprocessor"></span>    }   
<a name="l00166"></a>00166     $self-&gt;{ra_send_to}               = \@send_to;
<a name="l00167"></a>00167 <span class="preprocessor">    #################################################################</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span><span class="preprocessor">    # Check the validity of the input file name</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span><span class="preprocessor">    #################################################################</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span>    my $input_file = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00171"></a>00171 <span class="preprocessor">    #make sure an input message file was submitted and exists</span>
<a name="l00172"></a>00172 <span class="preprocessor"></span><span class="preprocessor">    #else use the default message       </span>
<a name="l00173"></a>00173 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( defined($openfilename) ) {
<a name="l00174"></a>00174         <span class="keywordflow">if</span> ( -e <span class="stringliteral">&quot;${emailDirectory}/$openfilename&quot;</span>) {
<a name="l00175"></a>00175             <span class="keywordflow">if</span> ( -R <span class="stringliteral">&quot;${emailDirectory}/$openfilename&quot;</span>) {
<a name="l00176"></a>00176                 $input_file = $openfilename;
<a name="l00177"></a>00177             } <span class="keywordflow">else</span> {
<a name="l00178"></a>00178                 $self-&gt;addbadmessage(CGI::p(join(<span class="stringliteral">&quot;&quot;</span>,
<a name="l00179"></a>00179                     <span class="stringliteral">&quot;The file ${emailDirectory}/$openfilename is not readable by the webserver.&quot;</span>,CGI::br(),
<a name="l00180"></a>00180                     <span class="stringliteral">&quot;Check that it&#39;s permissions are set correctly.&quot;</span>,
<a name="l00181"></a>00181                 )));
<a name="l00182"></a>00182             }
<a name="l00183"></a>00183         } <span class="keywordflow">else</span> {
<a name="l00184"></a>00184             $input_file = $default_msg_file;
<a name="l00185"></a>00185             $self-&gt;addbadmessage(CGI::p(join(<span class="stringliteral">&quot;&quot;</span>,
<a name="l00186"></a>00186                   <span class="stringliteral">&quot;The file ${emailDirectory}/$openfilename cannot be found.&quot;</span>,CGI::br(),
<a name="l00187"></a>00187                   <span class="stringliteral">&quot;Check whether it exists and whether the directory $emailDirectory can be read by the webserver.&quot;</span>,CGI::br(),
<a name="l00188"></a>00188                   <span class="stringliteral">&quot;Using contents of the default message $default_msg_file instead.&quot;</span>,
<a name="l00189"></a>00189             )));
<a name="l00190"></a>00190         }
<a name="l00191"></a>00191     } <span class="keywordflow">else</span> {
<a name="l00192"></a>00192         $input_file     = $default_msg_file;
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194     $self-&gt;{input_file} =$input_file;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196 <span class="preprocessor">    #################################################################</span>
<a name="l00197"></a>00197 <span class="preprocessor"></span><span class="preprocessor">    # Determine the file name to save message into</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span><span class="preprocessor">    #################################################################</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span>    my $output_file      = <span class="stringliteral">&#39;FIXME no output file specified&#39;</span>;    
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (defined($action) and $action eq <span class="stringliteral">&#39;Save as Default&#39;</span>) {
<a name="l00201"></a>00201         $output_file  = $default_msg_file;
<a name="l00202"></a>00202     } elsif ( defined($action) and ($action =~/save/i)) {
<a name="l00203"></a>00203         <span class="keywordflow">if</span> (defined($savefilename) and $savefilename ) {
<a name="l00204"></a>00204             $output_file  = $savefilename;
<a name="l00205"></a>00205         } <span class="keywordflow">else</span> {
<a name="l00206"></a>00206             $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;No filename was specified for saving!  The message was not saved.&quot;</span>));
<a name="l00207"></a>00207         }
<a name="l00208"></a>00208     } elsif ( defined($input_file) ) {
<a name="l00209"></a>00209         $output_file  = $input_file;
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 <span class="preprocessor">    #################################################################</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span><span class="preprocessor">    # Sanity check on save file name</span>
<a name="l00214"></a>00214 <span class="preprocessor"></span><span class="preprocessor">    #################################################################</span>
<a name="l00215"></a>00215 <span class="preprocessor"></span>
<a name="l00216"></a>00216     <span class="keywordflow">if</span> ($output_file =~ /^[~.]/ || $output_file =~ /\.\./) {
<a name="l00217"></a>00217         $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;For security reasons, you cannot specify a message file from a directory&quot;</span>, 
<a name="l00218"></a>00218                         <span class="stringliteral">&quot;higher than the email directory (you can&#39;t use ../blah/blah for example). &quot;</span>, 
<a name="l00219"></a>00219                         <span class="stringliteral">&quot;Please specify a different file or move the needed file to the email directory&quot;</span>,));
<a name="l00220"></a>00220     } 
<a name="l00221"></a>00221     unless ($output_file =~ m|\.msg$| ) {
<a name="l00222"></a>00222         $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Invalid file name.&quot;</span>, 
<a name="l00223"></a>00223                                 <span class="stringliteral">&quot;The file name \&quot;$output_file\&quot; does not have a \&quot;.msg\&quot; extension&quot;</span>,
<a name="l00224"></a>00224                                 <span class="stringliteral">&quot;All email file names must end in the extension \&quot;.msg\&quot;&quot;</span>,
<a name="l00225"></a>00225                                 <span class="stringliteral">&quot;choose a file name with a \&quot;.msg\&quot; extension.&quot;</span>,
<a name="l00226"></a>00226                                 <span class="stringliteral">&quot;The message was not saved.&quot;</span>,));
<a name="l00227"></a>00227     }
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     $self-&gt;{output_file} = $output_file;  # <span class="keyword">this</span> is ok.  It will be put back in the text input box <span class="keywordflow">for</span> re-editing.
<a name="l00230"></a>00230 
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     #############################################################################################
<a name="l00233"></a>00233 <span class="preprocessor">    # Determine input source</span>
<a name="l00234"></a>00234 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################</span>
<a name="l00235"></a>00235 <span class="preprocessor"></span><span class="preprocessor">    #warn &quot;Action = $action&quot;;</span>
<a name="l00236"></a>00236 <span class="preprocessor"></span>    my $input_source;
<a name="l00237"></a>00237     <span class="keywordflow">if</span> ($action){   
<a name="l00238"></a>00238         $input_source =  ( defined( $r-&gt;param(<span class="stringliteral">&#39;body&#39;</span>) ) and $action ne <span class="stringliteral">&#39;Open&#39;</span> ) ? <span class="stringliteral">&#39;form&#39;</span> : <span class="stringliteral">&#39;file&#39;</span>;}
<a name="l00239"></a>00239     <span class="keywordflow">else</span> { $input_source = ( defined($r-&gt;param(<span class="stringliteral">&#39;body&#39;</span>)) ) ? <span class="stringliteral">&#39;form&#39;</span> : <span class="stringliteral">&#39;file&#39;</span>;}
<a name="l00240"></a>00240 
<a name="l00241"></a>00241 <span class="preprocessor">    #############################################################################################</span>
<a name="l00242"></a>00242 <span class="preprocessor"></span><span class="preprocessor">    # Get inputs</span>
<a name="l00243"></a>00243 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################</span>
<a name="l00244"></a>00244 <span class="preprocessor"></span>    my($from, $replyTo, $r_text, $subject);
<a name="l00245"></a>00245     <span class="keywordflow">if</span> ($input_source eq <span class="stringliteral">&#39;file&#39;</span>) {
<a name="l00246"></a>00246 
<a name="l00247"></a>00247         ($from, $replyTo,$subject,$r_text) = $self-&gt;read_input_file(<span class="stringliteral">&quot;$emailDirectory/$input_file&quot;</span>);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     } elsif ($input_source eq <span class="stringliteral">&#39;form&#39;</span>) {
<a name="l00251"></a>00251 <span class="preprocessor">        # read info from the form</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span><span class="preprocessor">        # bail if there is no message body</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>        
<a name="l00254"></a>00254         $from              =    $r-&gt;param(<span class="stringliteral">&#39;from&#39;</span>);
<a name="l00255"></a>00255         $replyTo           =    $r-&gt;param(<span class="stringliteral">&#39;replyTo&#39;</span>);
<a name="l00256"></a>00256         $subject           =    $r-&gt;param(<span class="stringliteral">&#39;subject&#39;</span>);
<a name="l00257"></a>00257         my $body           =    $r-&gt;param(<span class="stringliteral">&#39;body&#39;</span>);
<a name="l00258"></a>00258 <span class="preprocessor">        # Sanity check: body must contain non-white space</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>        $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&#39;You didn\&#39;t enter any message.&#39;</span>)) unless ($r-&gt;param(<span class="stringliteral">&#39;body&#39;</span>) =~ /\S/);
<a name="l00260"></a>00260         $r_text               =    \$body;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263     
<a name="l00264"></a>00264     my $remote_host;
<a name="l00265"></a>00265     <span class="keywordflow">if</span> (MP2) {
<a name="l00266"></a>00266         $remote_host = $r-&gt;connection-&gt;remote_addr-&gt;ip_get || <span class="stringliteral">&quot;UNKNOWN&quot;</span>;
<a name="l00267"></a>00267     } <span class="keywordflow">else</span> {
<a name="l00268"></a>00268         (undef, $remote_host) = unpack_sockaddr_in($r-&gt;connection-&gt;remote_addr);
<a name="l00269"></a>00269         $remote_host = defined $remote_host ? inet_ntoa($remote_host) : <span class="stringliteral">&quot;UNKNOWN&quot;</span>;
<a name="l00270"></a>00270     }
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="preprocessor">    # store data</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span>    $self-&gt;{from}                   =    $from;
<a name="l00274"></a>00274     $self-&gt;{replyTo}                =    $replyTo;
<a name="l00275"></a>00275     $self-&gt;{subject}                =    $subject;
<a name="l00276"></a>00276     $self-&gt;{remote_host}            =    $remote_host;
<a name="l00277"></a>00277     $self-&gt;{r_text}                 =    $r_text;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 
<a name="l00281"></a>00281 <span class="preprocessor">    ###################################################################################</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">    #Determine the appropriate script action from the buttons</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span><span class="preprocessor">    ###################################################################################</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span><span class="preprocessor">    #     first time actions</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span><span class="preprocessor">    #          open new file</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span><span class="preprocessor">    #          open default file </span>
<a name="l00287"></a>00287 <span class="preprocessor"></span><span class="preprocessor">    #     choose merge file actions</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span><span class="preprocessor">    #          chose merge button</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span><span class="preprocessor">    #     option actions</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span><span class="preprocessor">    #       &#39;reset rows&#39;</span>
<a name="l00291"></a>00291 <span class="preprocessor"></span>    
<a name="l00292"></a>00292 <span class="preprocessor">    #     save actions</span>
<a name="l00293"></a>00293 <span class="preprocessor"></span><span class="preprocessor">    #       &quot;save&quot; button</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span><span class="preprocessor">    #       &quot;save as&quot; button</span>
<a name="l00295"></a>00295 <span class="preprocessor"></span><span class="preprocessor">    #       &quot;save as default&quot; button</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span><span class="preprocessor">    #     preview actions</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span><span class="preprocessor">    #       &#39;preview&#39; button</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span><span class="preprocessor">    #     email actions</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span><span class="preprocessor">    #       &#39;entire class&#39;</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span><span class="preprocessor">    #       &#39;selected studentIDs&#39;</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span><span class="preprocessor">    #     error actions (various)</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span>
<a name="l00303"></a>00303 
<a name="l00304"></a>00304 <span class="preprocessor">    #############################################################################################</span>
<a name="l00305"></a>00305 <span class="preprocessor"></span><span class="preprocessor">    # if no form is submitted, gather data needed to produce the mail form and return</span>
<a name="l00306"></a>00306 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################</span>
<a name="l00307"></a>00307 <span class="preprocessor"></span>    my $to                =    $r-&gt;param(<span class="stringliteral">&#39;To&#39;</span>);
<a name="l00308"></a>00308     my $script_action     = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00309"></a>00309     
<a name="l00310"></a>00310     
<a name="l00311"></a>00311     <span class="keywordflow">if</span>(not defined($action) or $action eq <span class="stringliteral">&#39;Open&#39;</span>  
<a name="l00312"></a>00312        or $action eq $UPDATE_SETTINGS_BUTTON ){  
<a name="l00313"></a>00313 
<a name="l00314"></a>00314         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     
<a name="l00320"></a>00320 
<a name="l00321"></a>00321 <span class="preprocessor">    #############################################################################################</span>
<a name="l00322"></a>00322 <span class="preprocessor"></span><span class="preprocessor">    # If form is submitted deal with filled out forms </span>
<a name="l00323"></a>00323 <span class="preprocessor"></span><span class="preprocessor">    # and various actions resulting from different buttons</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span>
<a name="l00326"></a>00326 
<a name="l00327"></a>00327     <span class="keywordflow">if</span> ($action eq <span class="stringliteral">&#39;Save&#39;</span> or $action eq <span class="stringliteral">&#39;Save as:&#39;</span> or $action eq <span class="stringliteral">&#39;Save as Default&#39;</span>) {
<a name="l00328"></a>00328     
<a name="l00329"></a>00329 <span class="preprocessor">        #warn &quot;FIXME Saving files  action = $action  outputFileName=$output_file&quot;;</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>        
<a name="l00331"></a>00331 <span class="preprocessor">        #################################################################</span>
<a name="l00332"></a>00332 <span class="preprocessor"></span><span class="preprocessor">        # construct message body</span>
<a name="l00333"></a>00333 <span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<a name="l00334"></a>00334 <span class="preprocessor"></span>        my $temp_body = ${ $r_text };
<a name="l00335"></a>00335         $temp_body =~ s/\r\n/\n/g;
<a name="l00336"></a>00336         $temp_body = join(<span class="stringliteral">&quot;&quot;</span>,
<a name="l00337"></a>00337                    <span class="stringliteral">&quot;From: $from \nReply-To: $replyTo\n&quot;</span> ,
<a name="l00338"></a>00338                    <span class="stringliteral">&quot;Subject: $subject\n&quot;</span> ,
<a name="l00339"></a>00339                    <span class="stringliteral">&quot;Message: \n    $temp_body&quot;</span>);
<a name="l00340"></a>00340 <span class="preprocessor">        #warn &quot;FIXME from $from | subject $subject |reply $replyTo|msg $temp_body&quot;;</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<a name="l00342"></a>00342 <span class="preprocessor"></span><span class="preprocessor">        # overwrite protection</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<a name="l00344"></a>00344 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ($action eq <span class="stringliteral">&#39;Save as:&#39;</span> and -e <span class="stringliteral">&quot;$emailDirectory/$output_file&quot;</span>) {
<a name="l00345"></a>00345             $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;The file $emailDirectory/$output_file already exists and cannot be overwritten&quot;</span>,
<a name="l00346"></a>00346                                      <span class="stringliteral">&quot;The message was not saved&quot;</span>));
<a name="l00347"></a>00347             <span class="keywordflow">return</span>;
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349  
<a name="l00350"></a>00350 <span class="preprocessor">        #################################################################</span>
<a name="l00351"></a>00351 <span class="preprocessor"></span><span class="preprocessor">        # Back up existing file?</span>
<a name="l00352"></a>00352 <span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ($action eq <span class="stringliteral">&#39;Save as Default&#39;</span> and -e <span class="stringliteral">&quot;$emailDirectory/$default_msg_file&quot;</span>) {
<a name="l00354"></a>00354             rename(<span class="stringliteral">&quot;$emailDirectory/$default_msg_file&quot;</span>,<span class="stringliteral">&quot;$emailDirectory/$old_default_msg_file&quot;</span>) or 
<a name="l00355"></a>00355                    die &quot;Can&#39;t rename $emailDirectory/$default_msg_file to $emailDirectory/$old_default_msg_file &quot;,
<a name="l00356"></a>00356                        &quot;Check permissions for webserver on directory $emailDirectory. $!&quot;;
<a name="l00357"></a>00357             $self-&gt;addgoodmessage(CGI::p(&quot;Backup file &lt;code&gt;$emailDirectory/$old_default_msg_file&lt;/code&gt; created.&quot; . CGI::br()));
<a name="l00358"></a>00358         }
<a name="l00359"></a>00359         <span class="preprocessor">#################################################################</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span><span class="preprocessor">        # Save the message</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span><span class="preprocessor">        #################################################################</span>
<a name="l00362"></a>00362 <span class="preprocessor"></span>        $self-&gt;saveProblem($temp_body, <span class="stringliteral">&quot;${emailDirectory}/$output_file&quot;</span> ) unless ($output_file =~ /^[~.]/ || $output_file =~ /\.\./ || not $output_file =~ m|\.msg$|);
<a name="l00363"></a>00363         unless ( $self-&gt;{submit_message} or not -w <span class="stringliteral">&quot;${emailDirectory}/$output_file&quot;</span> )  {  # <span class="keywordflow">if</span> there are no errors report success
<a name="l00364"></a>00364             $self-&gt;addgoodmessage(CGI::p(<span class="stringliteral">&quot;Message saved to file &lt;code&gt;${emailDirectory}/$output_file&lt;/code&gt;.&quot;</span>));
<a name="l00365"></a>00365         }    
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     } elsif ($action eq <span class="stringliteral">&#39;Preview message&#39;</span>) {
<a name="l00368"></a>00368         $self-&gt;{response}         = <span class="stringliteral">&#39;preview&#39;</span>;
<a name="l00369"></a>00369     
<a name="l00370"></a>00370     } elsif ($action eq <span class="stringliteral">&#39;Send Email&#39;</span>) {
<a name="l00371"></a>00371 <span class="preprocessor">        # verify format of From address (one valid rfc2822 address)</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span>        my @parsed_from_addrs = Email::Address-&gt;parse($self-&gt;{from});
<a name="l00373"></a>00373         unless (@parsed_from_addrs == 1) {
<a name="l00374"></a>00374             $self-&gt;addbadmessage(<span class="stringliteral">&quot;From field must contain one valid email address.&quot;</span>);
<a name="l00375"></a>00375             <span class="keywordflow">return</span>;
<a name="l00376"></a>00376         }
<a name="l00377"></a>00377         
<a name="l00378"></a>00378 <span class="preprocessor">        # verify format of Reply-to address (zero or more valid rfc2822 addresses)</span>
<a name="l00379"></a>00379 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (defined $self-&gt;{replyTo} and $self-&gt;{replyTo} ne <span class="stringliteral">&quot;&quot;</span>) {
<a name="l00380"></a>00380             my @parsed_replyto_addrs = Email::Address-&gt;parse($self-&gt;{replyTo});
<a name="l00381"></a>00381             unless (@parsed_replyto_addrs &gt; 0) {
<a name="l00382"></a>00382                 $self-&gt;addbadmessage(<span class="stringliteral">&quot;Invalid Reply-to address.&quot;</span>);
<a name="l00383"></a>00383                 <span class="keywordflow">return</span>;
<a name="l00384"></a>00384             }
<a name="l00385"></a>00385         }
<a name="l00386"></a>00386         
<a name="l00387"></a>00387 <span class="preprocessor">        # check that recipients have been selected.</span>
<a name="l00388"></a>00388 <span class="preprocessor"></span>        my @recipients            = @{$self-&gt;{ra_send_to}};
<a name="l00389"></a>00389         unless (@recipients) {
<a name="l00390"></a>00390             $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;No recipients selected. Please select one or more recipients from the list below.&quot;</span>));
<a name="l00391"></a>00391             <span class="keywordflow">return</span>;
<a name="l00392"></a>00392         }
<a name="l00393"></a>00393         
<a name="l00394"></a>00394 <span class="preprocessor">        #  get merge file</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span>        my $merge_file      = ( defined($self-&gt;{merge_file}) ) ? $self-&gt;{merge_file} : <span class="stringliteral">&#39;None&#39;</span>;
<a name="l00396"></a>00396         my $delimiter       = <span class="charliteral">&#39;,&#39;</span>;
<a name="l00397"></a>00397         my $rh_merge_data   = $self-&gt;read_scoring_file(<span class="stringliteral">&quot;$merge_file&quot;</span>, <span class="stringliteral">&quot;$delimiter&quot;</span>);
<a name="l00398"></a>00398         unless (ref($rh_merge_data) ) {
<a name="l00399"></a>00399             $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;No merge data file&quot;</span>));
<a name="l00400"></a>00400             $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Can&#39;t read merge file $merge_file. No message sent&quot;</span>));
<a name="l00401"></a>00401             <span class="keywordflow">return</span>;
<a name="l00402"></a>00402         } ;
<a name="l00403"></a>00403         $self-&gt;{rh_merge_data} = $rh_merge_data;
<a name="l00404"></a>00404         
<a name="l00405"></a>00405 <span class="preprocessor">        # we don&#39;t set the response until we&#39;re sure that email can be sent</span>
<a name="l00406"></a>00406 <span class="preprocessor"></span>        $self-&gt;{response}         = <span class="stringliteral">&#39;send_email&#39;</span>;
<a name="l00407"></a>00407         
<a name="l00408"></a>00408 <span class="preprocessor">        # FIXME i&#39;m not sure why we&#39;re pulling this out here -- mail_message_to_recipients does have</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span><span class="preprocessor">        # access to the course environment and should just grab it directly</span>
<a name="l00410"></a>00410 <span class="preprocessor"></span>        $self-&gt;{smtpServer}    = $ce-&gt;{mail}-&gt;{smtpServer};
<a name="l00411"></a>00411         
<a name="l00412"></a>00412 <span class="preprocessor">        # do actual mailing in the cleanup phase, since it could take a long time</span>
<a name="l00413"></a>00413 <span class="preprocessor"></span><span class="preprocessor">        # FIXME we need to do a better job providing status notifications for long-running email jobs</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span>        my $post_connection_action = sub {
<a name="l00415"></a>00415             my $r = shift; 
<a name="l00416"></a>00416 <span class="preprocessor">            # catch exceptions generated during the sending process</span>
<a name="l00417"></a>00417 <span class="preprocessor"></span>            my $result_message = eval { $self-&gt;mail_message_to_recipients() };
<a name="l00418"></a>00418             <span class="keywordflow">if</span> ($@) {
<a name="l00419"></a>00419 <span class="preprocessor">                # add the die message to the result message</span>
<a name="l00420"></a>00420 <span class="preprocessor"></span>                $result_message = <span class="stringliteral">&quot;An error occurred while trying to send email.\n&quot;</span>
<a name="l00421"></a>00421                     . <span class="stringliteral">&quot;The error message is:\n\n$@\n\n&quot;</span>;
<a name="l00422"></a>00422 <span class="preprocessor">                # and also write it to the apache log</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>                $self-&gt;r-&gt;log-&gt;error(<span class="stringliteral">&quot;An error occurred while trying to send email: $@&quot;</span>);
<a name="l00424"></a>00424             }
<a name="l00425"></a>00425 <span class="preprocessor">            # this could fail too...</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span>            eval { $self-&gt;email_notification($result_message) };
<a name="l00427"></a>00427             <span class="keywordflow">if</span> ($@) {
<a name="l00428"></a>00428                 $self-&gt;r-&gt;log-&gt;error(<span class="stringliteral">&quot;An error occured while trying to send the email notification: $@&quot;</span>);
<a name="l00429"></a>00429             }
<a name="l00430"></a>00430         };
<a name="l00431"></a>00431         <span class="keywordflow">if</span> (MP2) {
<a name="l00432"></a>00432             $r-&gt;connection-&gt;pool-&gt;cleanup_register($post_connection_action);
<a name="l00433"></a>00433         } <span class="keywordflow">else</span> {
<a name="l00434"></a>00434             $r-&gt;post_connection($post_connection_action);
<a name="l00435"></a>00435         }
<a name="l00436"></a>00436     } <span class="keywordflow">else</span> {
<a name="l00437"></a>00437         $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Didn&#39;t recognize button $action&quot;</span>));
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439 
<a name="l00440"></a>00440 
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 }  #end initialize
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 sub body {
<a name="l00449"></a>00449     my ($self)          = @_;
<a name="l00450"></a>00450     my $r               = $self-&gt;r;
<a name="l00451"></a>00451     my $urlpath         = $r-&gt;urlpath;
<a name="l00452"></a>00452     my $authz           = $r-&gt;authz;
<a name="l00453"></a>00453     my $setID           = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);    
<a name="l00454"></a>00454     my $response        = (defined($self-&gt;{response}))? $self-&gt;{response} : <span class="stringliteral">&#39;&#39;</span>;
<a name="l00455"></a>00455     my $user            = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00456"></a>00456 
<a name="l00457"></a>00457 <span class="preprocessor">    # Check permissions</span>
<a name="l00458"></a>00458 <span class="preprocessor"></span>    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, CGI::p(<span class="stringliteral">&quot;You are not authorized to access instructor tools&quot;</span>))
<a name="l00459"></a>00459         unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
<a name="l00460"></a>00460 
<a name="l00461"></a>00461     <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, CGI::p(<span class="stringliteral">&quot;You are not authorized to send mail to students&quot;</span>))
<a name="l00462"></a>00462         unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;send_mail&quot;</span>);
<a name="l00463"></a>00463 
<a name="l00464"></a>00464     <span class="keywordflow">if</span> ($response eq <span class="stringliteral">&#39;preview&#39;</span>) {
<a name="l00465"></a>00465         $self-&gt;print_preview($setID);
<a name="l00466"></a>00466     } elsif ($response eq <span class="stringliteral">&#39;send_email&#39;</span> and $self-&gt;{ra_send_to} and @{$self-&gt;{ra_send_to}}){
<a name="l00467"></a>00467         my $message = CGI::i(<span class="stringliteral">&quot;Email is being sent to &quot;</span>.  scalar(@{$self-&gt;{ra_send_to}}).<span class="stringliteral">&quot; recipient(s). You will be notified&quot;</span>
<a name="l00468"></a>00468                      .<span class="stringliteral">&quot; by email when the task is completed.  This may take several minutes if the class is large.&quot;</span>
<a name="l00469"></a>00469         );
<a name="l00470"></a>00470         $self-&gt;addgoodmessage($message);
<a name="l00471"></a>00471         $self-&gt;{message} .= $message;
<a name="l00472"></a>00472         
<a name="l00473"></a>00473         $self-&gt;print_form($setID);
<a name="l00474"></a>00474     } <span class="keywordflow">else</span> {
<a name="l00475"></a>00475         $self-&gt;print_form($setID);
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 sub print_preview {
<a name="l00481"></a>00481     my ($self)          = @_;
<a name="l00482"></a>00482     my $r               = $self-&gt;r;
<a name="l00483"></a>00483     my $urlpath         = $r-&gt;urlpath;
<a name="l00484"></a>00484     my $setID           = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);    
<a name="l00485"></a>00485 
<a name="l00486"></a>00486 <span class="preprocessor">    #  get preview user</span>
<a name="l00487"></a>00487 <span class="preprocessor"></span>    my $ur      = $r-&gt;db-&gt;getUser($self-&gt;{preview_user}); #checked
<a name="l00488"></a>00488     die <span class="stringliteral">&quot;record for preview user &quot;</span>.$self-&gt;{preview_user}. <span class="stringliteral">&quot; not found.&quot;</span> unless $ur;
<a name="l00489"></a>00489     
<a name="l00490"></a>00490 <span class="preprocessor">    #  get merge file</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span>    my $merge_file      = ( defined($self-&gt;{merge_file}) ) ? $self-&gt;{merge_file} : <span class="stringliteral">&#39;None&#39;</span>;
<a name="l00492"></a>00492     my $delimiter       = <span class="charliteral">&#39;,&#39;</span>;
<a name="l00493"></a>00493     my $rh_merge_data   = $self-&gt;read_scoring_file(<span class="stringliteral">&quot;$merge_file&quot;</span>, <span class="stringliteral">&quot;$delimiter&quot;</span>);
<a name="l00494"></a>00494 
<a name="l00495"></a>00495     my ($msg, $preview_header) = $self-&gt;process_message($ur,$rh_merge_data,1); # 1 == <span class="keywordflow">for</span> preview
<a name="l00496"></a>00496     
<a name="l00497"></a>00497     my $recipients  = join(<span class="stringliteral">&quot; &quot;</span>,@{$self-&gt;{ra_send_to} });
<a name="l00498"></a>00498     my $errorMessage =  defined($self-&gt;{submit_message}) ?  CGI::i($self-&gt;{submit_message} ) : <span class="stringliteral">&#39;&#39;</span> ; 
<a name="l00499"></a>00499     
<a name="l00500"></a>00500 <span class="preprocessor">    # Format message keeping the preview_header lined up</span>
<a name="l00501"></a>00501 <span class="preprocessor"></span>    $errorMessage = wrap(<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,$errorMessage);
<a name="l00502"></a>00502     $msg = wrap(<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,$msg);
<a name="l00503"></a>00503     
<a name="l00504"></a>00504     $msg = join(<span class="stringliteral">&quot;&quot;</span>,
<a name="l00505"></a>00505        $errorMessage,
<a name="l00506"></a>00506        $preview_header,
<a name="l00507"></a>00507        <span class="stringliteral">&quot;To: &quot;</span>             , $ur-&gt;email_address,<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00508"></a>00508        <span class="stringliteral">&quot;From: &quot;</span>           , $self-&gt;{from} , <span class="stringliteral">&quot;\n&quot;</span> ,
<a name="l00509"></a>00509        <span class="stringliteral">&quot;Reply-To: &quot;</span>       , $self-&gt;{replyTo} , <span class="stringliteral">&quot;\n&quot;</span> ,
<a name="l00510"></a>00510        <span class="stringliteral">&quot;Subject:  &quot;</span>       , $self-&gt;{subject} , <span class="stringliteral">&quot;\n&quot;</span> ,<span class="stringliteral">&quot;\n&quot;</span> , 
<a name="l00511"></a>00511        $msg , <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00512"></a>00512     );
<a name="l00513"></a>00513 
<a name="l00514"></a>00514 <span class="preprocessor">#   return join(&quot;&quot;, &#39;&lt;pre&gt;&#39;,wrap(&quot;&quot;,&quot;&quot;,$msg),&quot;\n&quot;,&quot;\n&quot;,</span>
<a name="l00515"></a>00515 <span class="preprocessor"></span>    <span class="keywordflow">return</span> join(<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&#39;&lt;pre&gt;&#39;</span>,$msg,<span class="stringliteral">&quot;\n&quot;</span>,<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00516"></a>00516                    <span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>, 
<a name="l00517"></a>00517                    CGI::p(<span class="stringliteral">&#39;Use browser back button to return from preview mode&#39;</span>),
<a name="l00518"></a>00518                    CGI::h3(<span class="stringliteral">&#39;Emails to be sent to the following:&#39;</span>), 
<a name="l00519"></a>00519                    $recipients, <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00520"></a>00520                    
<a name="l00521"></a>00521     );
<a name="l00522"></a>00522 
<a name="l00523"></a>00523 }
<a name="l00524"></a>00524 sub print_form {
<a name="l00525"></a>00525     my ($self)          = @_;
<a name="l00526"></a>00526     my $r               = $self-&gt;r;
<a name="l00527"></a>00527     my $urlpath         = $r-&gt;urlpath;
<a name="l00528"></a>00528     my $authz           = $r-&gt;authz;    
<a name="l00529"></a>00529     my $db              = $r-&gt;db;
<a name="l00530"></a>00530     my $ce              = $r-&gt;ce;
<a name="l00531"></a>00531     my $courseName      = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00532"></a>00532     my $setID           = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);    
<a name="l00533"></a>00533     my $user            = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     my $root            = $ce-&gt;{webworkURLs}-&gt;{root};
<a name="l00536"></a>00536     my $sendMailPage    = $urlpath-&gt;newFromModule($urlpath-&gt;module, $r, courseID=&gt;$courseName);
<a name="l00537"></a>00537     my $sendMailURL     = $self-&gt;systemLink($sendMailPage, authen =&gt; 0);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539         <span class="keywordflow">return</span> CGI::em(<span class="stringliteral">&quot;You are not authorized to access the Instructor tools.&quot;</span>) unless $authz-&gt;hasPermissions($user, &quot;access_instructor_tools&quot;);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     my $userTemplate = $db-&gt;newUser;
<a name="l00542"></a>00542     my $permissionLevelTemplate = $db-&gt;newPermissionLevel;
<a name="l00543"></a>00543     
<a name="l00544"></a>00544     <span class="preprocessor"># This code will require changing if the permission and user tables ever have different keys.</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span>    my @users                 = sort @{ $self-&gt;{ra_users} };
<a name="l00546"></a>00546     my $ra_user_records       = $self-&gt;{ra_user_records};
<a name="l00547"></a>00547     my %classlistLabels       = ();#  %$hr_classlistLabels;
<a name="l00548"></a>00548     <span class="keywordflow">foreach</span> my $ur (@{ $ra_user_records }) {
<a name="l00549"></a>00549         $classlistLabels{$ur-&gt;user_id} = $ur-&gt;user_id.<span class="stringliteral">&#39;: &#39;</span>.$ur-&gt;last_name. <span class="stringliteral">&#39;, &#39;</span>. $ur-&gt;first_name.<span class="stringliteral">&#39; -- &#39;</span>.$ur-&gt;section.<span class="stringliteral">&quot; / &quot;</span>.$ur-&gt;recitation;
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="preprocessor">    ## Mark edit define scrolling list</span>
<a name="l00553"></a>00553 <span class="preprocessor"></span>    my $scrolling_user_list = scrollingRecordList({
<a name="l00554"></a>00554         name =&gt; <span class="stringliteral">&quot;classList&quot;</span>,            ## changed from classList to action
<a name="l00555"></a>00555         request =&gt; $r,
<a name="l00556"></a>00556         default_sort =&gt; <span class="stringliteral">&quot;lnfn&quot;</span>,
<a name="l00557"></a>00557         default_format =&gt; <span class="stringliteral">&quot;lnfn_uid&quot;</span>,
<a name="l00558"></a>00558         default_filters =&gt; [<span class="stringliteral">&quot;all&quot;</span>],
<a name="l00559"></a>00559         size =&gt; 5,
<a name="l00560"></a>00560         multiple =&gt; 1,
<a name="l00561"></a>00561         refresh_button_name =&gt;<span class="stringliteral">&#39;Update settings and refresh page&#39;</span>,
<a name="l00562"></a>00562     }, @{$ra_user_records});
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="preprocessor">    ##############################################################################################################</span>
<a name="l00565"></a>00565 <span class="preprocessor"></span>    
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     my $from            = $self-&gt;{from};
<a name="l00568"></a>00568     my $subject         = $self-&gt;{subject};
<a name="l00569"></a>00569     my $replyTo         = $self-&gt;{replyTo};
<a name="l00570"></a>00570     my $columns         = $self-&gt;{columns};
<a name="l00571"></a>00571     my $rows            = $self-&gt;{rows};
<a name="l00572"></a>00572     my $text            = defined($self-&gt;{r_text}) ? ${ $self-&gt;{r_text} }: <span class="stringliteral">&#39;FIXME no text was produced by initialization!!&#39;</span>;
<a name="l00573"></a>00573     my $input_file      = $self-&gt;{input_file};
<a name="l00574"></a>00574     my $output_file     = $self-&gt;{output_file};
<a name="l00575"></a>00575     my @sorted_messages = $self-&gt;get_message_file_names;
<a name="l00576"></a>00576     my @sorted_merge_files = $self-&gt;get_merge_file_names;
<a name="l00577"></a>00577     my $merge_file      = ( defined($self-&gt;{merge_file}) ) ? $self-&gt;{merge_file} : <span class="stringliteral">&#39;None&#39;</span>;
<a name="l00578"></a>00578     my $delimiter       = <span class="charliteral">&#39;,&#39;</span>;
<a name="l00579"></a>00579     my $rh_merge_data   = $self-&gt;read_scoring_file(<span class="stringliteral">&quot;$merge_file&quot;</span>, <span class="stringliteral">&quot;$delimiter&quot;</span>);
<a name="l00580"></a>00580     my @merge_keys      = keys %$rh_merge_data;
<a name="l00581"></a>00581     my $preview_user    = $self-&gt;{preview_user};
<a name="l00582"></a>00582     my $preview_record   = $db-&gt;getUser($preview_user); # checked
<a name="l00583"></a>00583     die <span class="stringliteral">&quot;record for preview user &quot;</span>.$self-&gt;{preview_user}. <span class="stringliteral">&quot; not found.&quot;</span> unless $preview_record;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585 
<a name="l00586"></a>00586 <span class="preprocessor">    #############################################################################################       </span>
<a name="l00587"></a>00587 <span class="preprocessor"></span>
<a name="l00588"></a>00588     print CGI::start_form({method=&gt;<span class="stringliteral">&quot;post&quot;</span>, action=&gt;$sendMailURL});
<a name="l00589"></a>00589     print $self-&gt;hidden_authen_fields();
<a name="l00590"></a>00590 <span class="preprocessor">    #############################################################################################</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span><span class="preprocessor">    #   begin upper table</span>
<a name="l00592"></a>00592 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<a name="l00593"></a>00593 <span class="preprocessor"></span>
<a name="l00594"></a>00594     print CGI::start_table({-border=&gt;<span class="charliteral">&#39;2&#39;</span>, -cellpadding=&gt;<span class="charliteral">&#39;4&#39;</span>});
<a name="l00595"></a>00595     print CGI::Tr({-align=&gt;<span class="stringliteral">&#39;left&#39;</span>,-valign=&gt;<span class="stringliteral">&#39;top&#39;</span>},
<a name="l00596"></a>00596 <span class="preprocessor">    #############################################################################################</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span><span class="preprocessor">    #   first column</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<a name="l00599"></a>00599 <span class="preprocessor"></span>
<a name="l00600"></a>00600              CGI::td({},
<a name="l00601"></a>00601                  CGI::strong(<span class="stringliteral">&quot;Message file: &quot;</span>), $input_file,<span class="stringliteral">&quot;\n&quot;</span>,CGI::br(),
<a name="l00602"></a>00602                  CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Open&#39;</span>), <span class="stringliteral">&#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</span>,<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00603"></a>00603                  CGI::popup_menu(-name=&gt;<span class="stringliteral">&#39;openfilename&#39;</span>, 
<a name="l00604"></a>00604                                  -values=&gt;\@sorted_messages, 
<a name="l00605"></a>00605                                  -<span class="keywordflow">default</span>=&gt;$input_file
<a name="l00606"></a>00606                  ), 
<a name="l00607"></a>00607                  <span class="stringliteral">&quot;\n&quot;</span>,CGI::br(),
<a name="l00608"></a>00608                  CGI::strong(<span class="stringliteral">&quot;Save file to: &quot;</span>), $output_file,
<a name="l00609"></a>00609                  <span class="stringliteral">&quot;\n&quot;</span>,CGI::br(),
<a name="l00610"></a>00610                  CGI::strong(<span class="stringliteral">&#39;Merge file: &#39;</span>), $merge_file, 
<a name="l00611"></a>00611                  CGI::br(),
<a name="l00612"></a>00612                  CGI::popup_menu(-name=&gt;<span class="stringliteral">&#39;merge_file&#39;</span>, 
<a name="l00613"></a>00613                                  -values=&gt;\@sorted_merge_files, 
<a name="l00614"></a>00614                                  -<span class="keywordflow">default</span>=&gt;$merge_file,
<a name="l00615"></a>00615                  ), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00616"></a>00616                  <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00617"></a>00617 <span class="preprocessor">                 #CGI::hr(),</span>
<a name="l00618"></a>00618 <span class="preprocessor"></span>                 CGI::div({style=&gt;<span class="stringliteral">&quot;background-color: #CCCCCC&quot;</span>},
<a name="l00619"></a>00619                      <span class="stringliteral">&quot;\n&quot;</span>, <span class="stringliteral">&#39;From:&#39;</span>,<span class="stringliteral">&#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</span>,  CGI::textfield(-name=&gt;<span class="stringliteral">&quot;from&quot;</span>, -size=&gt;30, -value=&gt;$from, -<span class="keyword">override</span>=&gt;1),    
<a name="l00620"></a>00620                      <span class="stringliteral">&quot;\n&quot;</span>, CGI::br(),<span class="stringliteral">&#39;Reply-To: &#39;</span>, CGI::textfield(-name=&gt;<span class="stringliteral">&quot;replyTo&quot;</span>, -size=&gt;30, -value=&gt;$replyTo, -<span class="keyword">override</span>=&gt;1), 
<a name="l00621"></a>00621                      <span class="stringliteral">&quot;\n&quot;</span>, CGI::br(),<span class="stringliteral">&#39;Subject:  &#39;</span>, CGI::br(), CGI::textarea(-name=&gt;<span class="stringliteral">&#39;subject&#39;</span>, -<span class="keywordflow">default</span>=&gt;$subject, -rows=&gt;3,-cols=&gt;30, -<span class="keyword">override</span>=&gt;1),  
<a name="l00622"></a>00622                 ),
<a name="l00623"></a>00623                 #CGI::hr(),
<a name="l00624"></a>00624                 <span class="stringliteral">&quot;Editor rows: &quot;</span>, CGI::textfield(-name=&gt;<span class="stringliteral">&#39;rows&#39;</span>, -size=&gt;3, -value=&gt;$rows),
<a name="l00625"></a>00625                 <span class="stringliteral">&quot; columns: &quot;</span>, CGI::textfield(-name=&gt;<span class="stringliteral">&#39;columns&#39;</span>, -size=&gt;3, -value=&gt;$columns),
<a name="l00626"></a>00626                 CGI::br(),
<a name="l00627"></a>00627                 CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;$UPDATE_SETTINGS_BUTTON),
<a name="l00628"></a>00628                  
<a name="l00629"></a>00629             ),
<a name="l00630"></a>00630     #############################################################################################
<a name="l00631"></a>00631     #   second column
<a name="l00632"></a>00632     #############################################################################################   
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     ## Edit by Mark to insert scrolling list
<a name="l00635"></a>00635                     CGI::td({-style=&gt;<span class="stringliteral">&quot;width:33%&quot;</span>},
<a name="l00636"></a>00636                          CGI::strong(<span class="stringliteral">&quot;Send to:&quot;</span>),
<a name="l00637"></a>00637                           CGI::radio_group(-name=&gt;<span class="stringliteral">&#39;radio&#39;</span>, 
<a name="l00638"></a>00638                                            -values=&gt;[<span class="stringliteral">&#39;all_students&#39;</span>,<span class="stringliteral">&#39;studentID&#39;</span>],
<a name="l00639"></a>00639                                            -labels=&gt;{all_students=&gt;<span class="stringliteral">&#39;All students in course&#39;</span>,studentID =&gt; <span class="stringliteral">&#39;Selected students&#39;</span>},
<a name="l00640"></a>00640                                            -<span class="keywordflow">default</span>=&gt;<span class="stringliteral">&#39;studentID&#39;</span>, -linebreak=&gt;0), 
<a name="l00641"></a>00641                             CGI::br(),$scrolling_user_list,
<a name="l00642"></a>00642                             CGI::i(<span class="stringliteral">&quot;Preview set to: &quot;</span>), $preview_record-&gt;last_name,<span class="charliteral">&#39;(&#39;</span>, $preview_record-&gt;user_id,<span class="charliteral">&#39;)&#39;</span>,
<a name="l00643"></a>00643                             CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;preview&#39;</span>,-label=&gt;<span class="stringliteral">&#39;Preview message&#39;</span>),<span class="stringliteral">&#39;&amp;nbsp;&amp;nbsp;&#39;</span>,
<a name="l00644"></a>00644                     ),
<a name="l00645"></a>00645     ); # end Tr
<a name="l00646"></a>00646     
<a name="l00647"></a>00647 <span class="preprocessor">    # second row, for reference popup menu</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span>    print CGI::Tr(
<a name="l00649"></a>00649             CGI::td({align=&gt;<span class="stringliteral">&#39;center&#39;</span>,colspan=&gt;2},
<a name="l00650"></a>00650 
<a name="l00651"></a>00651                 
<a name="l00652"></a>00652 <span class="preprocessor">                #CGI::i(&#39;Press any action button to update display&#39;),CGI::br(),</span>
<a name="l00653"></a>00653 <span class="preprocessor"></span><span class="preprocessor">            #show available macros</span>
<a name="l00654"></a>00654 <span class="preprocessor"></span>                CGI::popup_menu(
<a name="l00655"></a>00655                         -name=&gt;<span class="stringliteral">&#39;dummyName&#39;</span>,
<a name="l00656"></a>00656                         -values=&gt;[<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;$SID&#39;</span>, <span class="stringliteral">&#39;$FN&#39;</span>, <span class="stringliteral">&#39;$LN&#39;</span>, <span class="stringliteral">&#39;$SECTION&#39;</span>, <span class="stringliteral">&#39;$RECITATION&#39;</span>,<span class="stringliteral">&#39;$STATUS&#39;</span>, <span class="stringliteral">&#39;$EMAIL&#39;</span>, <span class="stringliteral">&#39;$LOGIN&#39;</span>, <span class="stringliteral">&#39;$COL[3]&#39;</span>, <span class="stringliteral">&#39;$COL[-1]&#39;</span>],
<a name="l00657"></a>00657                         -labels=&gt;{<span class="stringliteral">&#39;&#39;</span>=&gt;<span class="stringliteral">&#39;list of insertable macros&#39;</span>,
<a name="l00658"></a>00658                             <span class="stringliteral">&#39;$SID&#39;</span>=&gt;<span class="stringliteral">&#39;$SID - Student ID&#39;</span>,
<a name="l00659"></a>00659                             <span class="stringliteral">&#39;$FN&#39;</span>=&gt;<span class="stringliteral">&#39;$FN - First name&#39;</span>,
<a name="l00660"></a>00660                             <span class="stringliteral">&#39;$LN&#39;</span>=&gt;<span class="stringliteral">&#39;$LN - Last name&#39;</span>,
<a name="l00661"></a>00661                             <span class="stringliteral">&#39;$SECTION&#39;</span>=&gt;<span class="stringliteral">&#39;$SECTION&#39;</span>,
<a name="l00662"></a>00662                             <span class="stringliteral">&#39;$RECITATION&#39;</span>=&gt;<span class="stringliteral">&#39;$RECITATION&#39;</span>,
<a name="l00663"></a>00663                             <span class="stringliteral">&#39;$STATUS&#39;</span>=&gt;<span class="stringliteral">&#39;$STATUS - C, Audit, Drop, etc.&#39;</span>,
<a name="l00664"></a>00664                             <span class="stringliteral">&#39;$EMAIL&#39;</span>=&gt;<span class="stringliteral">&#39;$EMAIL - Email address&#39;</span>,
<a name="l00665"></a>00665                             <span class="stringliteral">&#39;$LOGIN&#39;</span>=&gt;<span class="stringliteral">&#39;$LOGIN - Login&#39;</span>,
<a name="l00666"></a>00666                             <span class="stringliteral">&#39;$COL[3]&#39;</span>=&gt;<span class="stringliteral">&#39;$COL[3] - 3rd col&#39;</span>,
<a name="l00667"></a>00667                             <span class="stringliteral">&#39;$COL[-1]&#39;</span>=&gt;<span class="stringliteral">&#39;$COL[-1] - Last column&#39;</span>
<a name="l00668"></a>00668                             }
<a name="l00669"></a>00669                 ), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00670"></a>00670             ),
<a name="l00671"></a>00671     );
<a name="l00672"></a>00672     
<a name="l00673"></a>00673     print CGI::end_table(); 
<a name="l00674"></a>00674 <span class="preprocessor">    #############################################################################################</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span><span class="preprocessor">    #   end upper table</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<a name="l00677"></a>00677 <span class="preprocessor"></span> 
<a name="l00678"></a>00678 <span class="preprocessor">    #############################################################################################</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span><span class="preprocessor">    #   merge file fragment and message text area field</span>
<a name="l00680"></a>00680 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<a name="l00681"></a>00681 <span class="preprocessor"></span>    my @tmp2;
<a name="l00682"></a>00682     eval{  @tmp2= @{$rh_merge_data-&gt;{ $db-&gt;getUser($preview_user)-&gt;student_id  }  };}; # checked
<a name="l00683"></a>00683     <span class="keywordflow">if</span> ($@ and $merge_file ne <span class="stringliteral">&#39;None&#39;</span>) {
<a name="l00684"></a>00684         print <span class="stringliteral">&quot;No merge data for $preview_user in merge file: &amp;lt;$merge_file&amp;gt;&quot;</span>,CGI::br();
<a name="l00685"></a>00685     } <span class="keywordflow">else</span> {
<a name="l00686"></a>00686         print CGI::pre(<span class="stringliteral">&quot;&quot;</span>,data_format(1..($#tmp2+1)),<span class="stringliteral">&quot;&lt;br&gt;&quot;</span>, data_format2(@tmp2));
<a name="l00687"></a>00687     }
<a name="l00688"></a>00688 <span class="preprocessor">    #create a textbox with the subject and a textarea with the message</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span><span class="preprocessor">    #print actual body of message</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span>
<a name="l00691"></a>00691     print  <span class="stringliteral">&quot;\n&quot;</span>, CGI::p( $self-&gt;{message}) <span class="keywordflow">if</span> defined($self-&gt;{message});  
<a name="l00692"></a>00692     print  <span class="stringliteral">&quot;\n&quot;</span>, CGI::p( CGI::textarea(-name=&gt;<span class="stringliteral">&#39;body&#39;</span>, -<span class="keywordflow">default</span>=&gt;$text, -rows=&gt;$rows, -cols=&gt;$columns, -<span class="keyword">override</span>=&gt;1));
<a name="l00693"></a>00693 
<a name="l00694"></a>00694 <span class="preprocessor">    #############################################################################################</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span><span class="preprocessor">    #   action button table</span>
<a name="l00696"></a>00696 <span class="preprocessor"></span><span class="preprocessor">    #############################################################################################   </span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>    print    CGI::table( { -border=&gt;2,-cellpadding=&gt;4},
<a name="l00698"></a>00698                  CGI::Tr( {},
<a name="l00699"></a>00699                      CGI::td({}, CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Send Email&#39;</span>) ), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00700"></a>00700                      CGI::td({}, CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Save&#39;</span>),<span class="stringliteral">&quot; to $output_file&quot;</span>), <span class="stringliteral">&quot; \n&quot;</span>,
<a name="l00701"></a>00701                      CGI::td({}, CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Save as:&#39;</span>),
<a name="l00702"></a>00702                              CGI::textfield(-name=&gt;<span class="stringliteral">&#39;savefilename&#39;</span>, -size =&gt; 20, -value=&gt; <span class="stringliteral">&quot;$output_file&quot;</span>, -<span class="keyword">override</span>=&gt;1)
<a name="l00703"></a>00703                      ), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00704"></a>00704                      CGI::td(CGI::submit(-name=&gt;<span class="stringliteral">&#39;action&#39;</span>, -value=&gt;<span class="stringliteral">&#39;Save as Default&#39;</span>)),
<a name="l00705"></a>00705                 ) 
<a name="l00706"></a>00706     );
<a name="l00707"></a>00707                
<a name="l00708"></a>00708 <span class="preprocessor">    ##############################################################################################################</span>
<a name="l00709"></a>00709 <span class="preprocessor"></span>
<a name="l00710"></a>00710     print CGI::end_form();  
<a name="l00711"></a>00711     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00712"></a>00712 }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714 <span class="preprocessor">##############################################################################</span>
<a name="l00715"></a>00715 <span class="preprocessor"></span><span class="preprocessor"># Utility methods</span>
<a name="l00716"></a>00716 <span class="preprocessor"></span><span class="preprocessor">##############################################################################</span>
<a name="l00717"></a>00717 <span class="preprocessor"></span>
<a name="l00718"></a>00718 sub saveProblem {     
<a name="l00719"></a>00719     my $self      = shift;
<a name="l00720"></a>00720     my ($body, $probFileName)= @_;
<a name="l00721"></a>00721     local(*PROBLEM);
<a name="l00722"></a>00722     open (PROBLEM, <span class="stringliteral">&quot;&gt;$probFileName&quot;</span>) ||
<a name="l00723"></a>00723         $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Could not open $probFileName for writing.</span>
<a name="l00724"></a>00724 <span class="stringliteral">                        Check that the  permissions for this problem are 660 (-rw-rw----)&quot;</span>));
<a name="l00725"></a>00725     print PROBLEM $body <span class="keywordflow">if</span> -w $probFileName;
<a name="l00726"></a>00726     close PROBLEM;
<a name="l00727"></a>00727     chmod 0660, <span class="stringliteral">&quot;$probFileName&quot;</span> ||
<a name="l00728"></a>00728                  $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;CAN&#39;T CHANGE PERMISSIONS ON FILE $probFileName&quot;</span>));
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731 sub read_input_file {
<a name="l00732"></a>00732     my $self         = shift;
<a name="l00733"></a>00733     my $filePath     = shift;
<a name="l00734"></a>00734     my ($text, @text);
<a name="l00735"></a>00735     my $header = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00736"></a>00736     my ($subject, $from, $replyTo);
<a name="l00737"></a>00737     local(*FILE);
<a name="l00738"></a>00738     <span class="keywordflow">if</span> (-e <span class="stringliteral">&quot;$filePath&quot;</span> and -r <span class="stringliteral">&quot;$filePath&quot;</span>) {
<a name="l00739"></a>00739         open FILE, <span class="stringliteral">&quot;$filePath&quot;</span> || <span class="keywordflow">do</span> { $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Can&#39;t open $filePath&quot;</span>)); <span class="keywordflow">return</span>};
<a name="l00740"></a>00740         <span class="keywordflow">while</span> ($header !~ s/Message:\s*$<span class="comment">//m and not eof(FILE)) { </span>
<a name="l00741"></a>00741             $header .= &lt;FILE&gt;; 
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743         $text = join( <span class="stringliteral">&#39;&#39;</span>, &lt;FILE&gt;);
<a name="l00744"></a>00744         $text =~ s/^\s*<span class="comment">//; # remove initial white space if any.</span>
<a name="l00745"></a>00745         $header         =~ /^From:\s(.*)$/m;
<a name="l00746"></a>00746         $from           = $1 or $from = $self-&gt;{defaultFrom}; 
<a name="l00747"></a>00747         
<a name="l00748"></a>00748         $header         =~ /^Reply-To:\s(.*)$/m;
<a name="l00749"></a>00749         $replyTo        = $1 or $replyTo = $self-&gt;{defaultReply};
<a name="l00750"></a>00750         
<a name="l00751"></a>00751         $header         =~ /^Subject:\s(.*)$/m;
<a name="l00752"></a>00752         $subject        = $1;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754     } <span class="keywordflow">else</span> {
<a name="l00755"></a>00755         $from           = $self-&gt;{defaultFrom};
<a name="l00756"></a>00756         $replyTo        = $self-&gt;{defaultReply};
<a name="l00757"></a>00757         $text           =  (-e <span class="stringliteral">&quot;$filePath&quot;</span>) ? <span class="stringliteral">&quot;FIXME file $filePath can&#39;t be read&quot;</span> :<span class="stringliteral">&quot;FIXME file $filePath doesn&#39;t exist&quot;</span>;
<a name="l00758"></a>00758         $subject        = $self-&gt;{defaultSubject};
<a name="l00759"></a>00759     }
<a name="l00760"></a>00760     <span class="keywordflow">return</span> ($from, $replyTo, $subject, \$text);
<a name="l00761"></a>00761 }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 
<a name="l00764"></a>00764 sub get_message_file_names {
<a name="l00765"></a>00765     my $self         = shift;
<a name="l00766"></a>00766     <span class="keywordflow">return</span> $self-&gt;read_dir($self-&gt;{ce}-&gt;{courseDirs}-&gt;{email}, <span class="stringliteral">&#39;\\.msg$&#39;</span>);
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 sub get_merge_file_names   {
<a name="l00769"></a>00769     my $self         = shift;
<a name="l00770"></a>00770     <span class="keywordflow">return</span> <span class="stringliteral">&#39;None&#39;</span>, $self-&gt;read_dir($self-&gt;{ce}-&gt;{courseDirs}-&gt;{scoring}, <span class="stringliteral">&#39;\\.csv$&#39;</span>); #FIXME ? check that only readable files are listed.
<a name="l00771"></a>00771 }
<a name="l00772"></a>00772 
<a name="l00773"></a>00773 sub mail_message_to_recipients {
<a name="l00774"></a>00774     my $self                  = shift;
<a name="l00775"></a>00775     my $r                     = $self-&gt;r;
<a name="l00776"></a>00776     my $ce                    = $r-&gt;ce;
<a name="l00777"></a>00777     my $subject               = $self-&gt;{subject};
<a name="l00778"></a>00778     my $from                  = $self-&gt;{from};
<a name="l00779"></a>00779     my @recipients            = @{$self-&gt;{ra_send_to}};
<a name="l00780"></a>00780     my $rh_merge_data         = $self-&gt;{rh_merge_data};
<a name="l00781"></a>00781     my $merge_file            = $self-&gt;{merge_file};  
<a name="l00782"></a>00782     my $result_message        = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00783"></a>00783     my $failed_messages        = 0;
<a name="l00784"></a>00784     
<a name="l00785"></a>00785     <span class="keywordflow">foreach</span> my $recipient (@recipients) {
<a name="l00786"></a>00786 <span class="preprocessor">            # warn &quot;FIXME sending email to $recipient&quot;;</span>
<a name="l00787"></a>00787 <span class="preprocessor"></span>            my $error_messages = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00788"></a>00788             my $ur      = $self-&gt;{db}-&gt;getUser($recipient); #checked
<a name="l00789"></a>00789             unless ($ur) {
<a name="l00790"></a>00790                 $error_messages .= <span class="stringliteral">&quot;Record for user $recipient not found\n&quot;</span>;
<a name="l00791"></a>00791                 next;
<a name="l00792"></a>00792             }
<a name="l00793"></a>00793             unless ($ur-&gt;email_address) {
<a name="l00794"></a>00794                 $error_messages .=<span class="stringliteral">&quot;User $recipient does not have an email address -- skipping\n&quot;</span>;
<a name="l00795"></a>00795                 next;
<a name="l00796"></a>00796             }
<a name="l00797"></a>00797             my $msg = eval { $self-&gt;process_message($ur,$rh_merge_data) };
<a name="l00798"></a>00798             $error_messages .= <span class="stringliteral">&quot;There were errors in processing user $recipient, merge file $merge_file. \n$@\n&quot;</span> <span class="keywordflow">if</span> $@;
<a name="l00799"></a>00799             my $mailer = Mail::Sender-&gt;new({
<a name="l00800"></a>00800                 from      =&gt; $ce-&gt;{mail}{smtpSender},
<a name="l00801"></a>00801                 fake_from =&gt; $from,
<a name="l00802"></a>00802                 to        =&gt; $ur-&gt;email_address,
<a name="l00803"></a>00803                 smtp      =&gt; $self-&gt;{smtpServer},
<a name="l00804"></a>00804                 subject   =&gt; $subject,
<a name="l00805"></a>00805                 headers   =&gt; <span class="stringliteral">&quot;X-Remote-Host: &quot;</span>.$self-&gt;{remote_host},
<a name="l00806"></a>00806             });
<a name="l00807"></a>00807             unless (ref $mailer) {
<a name="l00808"></a>00808                 $error_messages .= <span class="stringliteral">&quot;Failed to create a mailer for user $recipient: $Mail::Sender::Error\n&quot;</span>;
<a name="l00809"></a>00809                 next;
<a name="l00810"></a>00810             }
<a name="l00811"></a>00811             unless (ref $mailer-&gt;Open()) {
<a name="l00812"></a>00812                 $error_messages .= <span class="stringliteral">&quot;Failed to open the mailer for user $recipient: $Mail::Sender::Error\n&quot;</span>;
<a name="l00813"></a>00813                 next;
<a name="l00814"></a>00814             }
<a name="l00815"></a>00815             my $MAIL         = $mailer-&gt;GetHandle() || ($error_messages .= <span class="stringliteral">&quot;Couldn&#39;t get mailer handle \n&quot;</span>);
<a name="l00816"></a>00816             print $MAIL        $msg                 || ($error_messages .= <span class="stringliteral">&quot;Couldn&#39;t print to $MAIL&quot;</span>);
<a name="l00817"></a>00817             close $MAIL                             || ($error_messages .= <span class="stringliteral">&quot;Couldn&#39;t close $MAIL&quot;</span>);
<a name="l00818"></a>00818 <span class="preprocessor">            #warn &quot;FIXME mailed to $recipient: &quot;, $ur-&gt;email_address, &quot; from $from subject $subject Errors: $error_messages&quot;;</span>
<a name="l00819"></a>00819 <span class="preprocessor"></span>            $failed_messages++ <span class="keywordflow">if</span> $error_messages;
<a name="l00820"></a>00820             $result_message .= $error_messages;          
<a name="l00821"></a>00821         } 
<a name="l00822"></a>00822         my $courseName = $self-&gt;r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00823"></a>00823         my $number_of_recipients = scalar(@recipients) - $failed_messages;
<a name="l00824"></a>00824         $result_message = &lt;&lt;EndText.$result_message;
<a name="l00825"></a>00825         
<a name="l00826"></a>00826             A message with the subject line 
<a name="l00827"></a>00827                          $subject 
<a name="l00828"></a>00828             has been sent to 
<a name="l00829"></a>00829             $number_of_recipients recipient(s) in the class $courseName. 
<a name="l00830"></a>00830             There were $failed_messages message(s) that could not be delivered. 
<a name="l00831"></a>00831         
<a name="l00832"></a>00832 EndText
<a name="l00833"></a>00833 
<a name="l00834"></a>00834 }
<a name="l00835"></a>00835 sub email_notification {
<a name="l00836"></a>00836     my $self = shift;
<a name="l00837"></a>00837     my $result_message = shift;
<a name="l00838"></a>00838 <span class="preprocessor">    # find info on mailer and sender</span>
<a name="l00839"></a>00839 <span class="preprocessor"></span><span class="preprocessor">    # use the defaultFrom address.</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span>
<a name="l00841"></a>00841 <span class="preprocessor">    # find info on instructor recipient and message</span>
<a name="l00842"></a>00842 <span class="preprocessor"></span>    my $subject=<span class="stringliteral">&quot;WeBWorK email sent&quot;</span>;
<a name="l00843"></a>00843     
<a name="l00844"></a>00844     my $mailing_errors = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00845"></a>00845 <span class="preprocessor">    # open MAIL handle</span>
<a name="l00846"></a>00846 <span class="preprocessor"></span>    my $mailer = Mail::Sender-&gt;new({
<a name="l00847"></a>00847         from =&gt; $self-&gt;{defaultFrom},
<a name="l00848"></a>00848         to   =&gt; $self-&gt;{defaultFrom},
<a name="l00849"></a>00849         smtp    =&gt; $self-&gt;{smtpServer},
<a name="l00850"></a>00850         subject =&gt; $subject,
<a name="l00851"></a>00851         headers =&gt; <span class="stringliteral">&quot;X-Remote-Host: &quot;</span>.$self-&gt;{remote_host},
<a name="l00852"></a>00852     });
<a name="l00853"></a>00853     unless (ref $mailer) {
<a name="l00854"></a>00854         $mailing_errors .= <span class="stringliteral">&quot;Failed to create a mailer: $Mail::Sender::Error&quot;</span>;
<a name="l00855"></a>00855         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00856"></a>00856     }
<a name="l00857"></a>00857     unless (ref $mailer-&gt;Open()) {
<a name="l00858"></a>00858         $mailing_errors .= <span class="stringliteral">&quot;Failed to open the mailer: $Mail::Sender::Error&quot;</span>;
<a name="l00859"></a>00859         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00860"></a>00860     }
<a name="l00861"></a>00861     my $MAIL = $mailer-&gt;GetHandle();
<a name="l00862"></a>00862 <span class="preprocessor">    # print message</span>
<a name="l00863"></a>00863 <span class="preprocessor"></span>    print $MAIL $result_message;
<a name="l00864"></a>00864 <span class="preprocessor">    # clean up</span>
<a name="l00865"></a>00865 <span class="preprocessor"></span>    close $MAIL;
<a name="l00866"></a>00866     
<a name="l00867"></a>00867     warn <span class="stringliteral">&quot;instructor message sent to &quot;</span>, $self-&gt;{defaultFrom};
<a name="l00868"></a>00868 
<a name="l00869"></a>00869 }
<a name="l00870"></a>00870 sub getRecord {
<a name="l00871"></a>00871     my $self    = shift;
<a name="l00872"></a>00872     my $line    = shift;
<a name="l00873"></a>00873     my $delimiter   = shift;
<a name="l00874"></a>00874     $delimiter       = <span class="charliteral">&#39;,&#39;</span> unless defined($delimiter);
<a name="l00875"></a>00875 
<a name="l00876"></a>00876 <span class="preprocessor">        #       Takes a delimited line as a parameter and returns an</span>
<a name="l00877"></a>00877 <span class="preprocessor"></span><span class="preprocessor">        #       array.  Note that all white space is removed.  If the</span>
<a name="l00878"></a>00878 <span class="preprocessor"></span><span class="preprocessor">        #       last field is empty, the last element of the returned</span>
<a name="l00879"></a>00879 <span class="preprocessor"></span><span class="preprocessor">        #       array is also empty (unlike what the perl split command</span>
<a name="l00880"></a>00880 <span class="preprocessor"></span><span class="preprocessor">        #       would return).  E.G. @lineArray=&amp;getRecord(\$delimitedLine).</span>
<a name="l00881"></a>00881 <span class="preprocessor"></span>
<a name="l00882"></a>00882         my(@lineArray);
<a name="l00883"></a>00883         $line.=<span class="stringliteral">&quot;${delimiter}___&quot;</span>;                       # add <span class="keyword">final</span> field which must be non-empty
<a name="l00884"></a>00884         @lineArray = split(/\s*${delimiter}\s*/,$line); # split line into fields
<a name="l00885"></a>00885         $lineArray[0] =~s/^\s*<span class="comment">//;                       # remove white space from first element</span>
<a name="l00886"></a>00886         pop @lineArray;                                 # <span class="keyword">remove</span> the last artificial field
<a name="l00887"></a>00887         @lineArray;
<a name="l00888"></a>00888 }
<a name="l00889"></a>00889 
<a name="l00890"></a>00890 sub process_message {
<a name="l00891"></a>00891     my $self          = shift;
<a name="l00892"></a>00892     my $ur            = shift;
<a name="l00893"></a>00893     my $rh_merge_data = shift;
<a name="l00894"></a>00894     my $for_preview   = shift;
<a name="l00895"></a>00895     my $text          = defined($self-&gt;{r_text}) ? ${ $self-&gt;{r_text} }:
<a name="l00896"></a>00896                             <span class="stringliteral">&#39;FIXME no text was produced by initialization!!&#39;</span>;   
<a name="l00897"></a>00897     my $merge_file      = ( defined($self-&gt;{merge_file}) ) ? $self-&gt;{merge_file} : <span class="stringliteral">&#39;None&#39;</span>;  
<a name="l00898"></a>00898     
<a name="l00899"></a>00899     my $status_name = $self-&gt;r-&gt;ce-&gt;status_abbrev_to_name($ur-&gt;status);
<a name="l00900"></a>00900     $status_name = $ur-&gt;status unless defined $status_name;
<a name="l00901"></a>00901     
<a name="l00902"></a>00902 <span class="preprocessor">    #user macros that can be used in the email message</span>
<a name="l00903"></a>00903 <span class="preprocessor"></span>    my $SID           = $ur-&gt;student_id;
<a name="l00904"></a>00904     my $FN            = $ur-&gt;first_name;
<a name="l00905"></a>00905     my $LN            = $ur-&gt;last_name;
<a name="l00906"></a>00906     my $SECTION       = $ur-&gt;section;
<a name="l00907"></a>00907     my $RECITATION    = $ur-&gt;recitation;
<a name="l00908"></a>00908     my $STATUS        = $status_name;
<a name="l00909"></a>00909     my $EMAIL         = $ur-&gt;email_address;
<a name="l00910"></a>00910     my $LOGIN         = $ur-&gt;user_id;
<a name="l00911"></a>00911     
<a name="l00912"></a>00912 <span class="preprocessor">    # get record from merge file</span>
<a name="l00913"></a>00913 <span class="preprocessor"></span><span class="preprocessor">    # FIXME this is inefficient.  The info should be cached</span>
<a name="l00914"></a>00914 <span class="preprocessor"></span>    my @COL            = defined($rh_merge_data-&gt;{$SID}) ? @{$rh_merge_data-&gt;{$SID} } : ();
<a name="l00915"></a>00915     <span class="keywordflow">if</span> ($merge_file ne <span class="stringliteral">&#39;None&#39;</span> and not defined($rh_merge_data-&gt;{$SID}) and $for_preview) {
<a name="l00916"></a>00916         $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;No merge data for student id:$SID; name:$FN $LN; login:$LOGIN&quot;</span>));
<a name="l00917"></a>00917     }
<a name="l00918"></a>00918     unshift(@COL,<span class="stringliteral">&quot;&quot;</span>);           ## <span class="keyword">this</span> makes COL[1] the first column
<a name="l00919"></a>00919     my $endCol = @COL;
<a name="l00920"></a>00920 <span class="preprocessor">    # for safety, only evaluate special variables</span>
<a name="l00921"></a>00921 <span class="preprocessor"></span>    my $msg = $text;    
<a name="l00922"></a>00922     $msg =~ s/\$SID/$SID/ge;
<a name="l00923"></a>00923     $msg =~ s/\$LN/$LN/ge;
<a name="l00924"></a>00924     $msg =~ s/\$FN/$FN/ge;
<a name="l00925"></a>00925     $msg =~ s/\$STATUS/$STATUS/ge;
<a name="l00926"></a>00926     $msg =~ s/\$SECTION/$SECTION/ge;
<a name="l00927"></a>00927     $msg =~ s/\$RECITATION/$RECITATION/ge;
<a name="l00928"></a>00928     $msg =~ s/\$EMAIL/$EMAIL/ge;
<a name="l00929"></a>00929     $msg =~ s/\$LOGIN/$LOGIN/ge;
<a name="l00930"></a>00930     <span class="keywordflow">if</span> (defined($COL[1])) {     # prevents extraneous error messages.  
<a name="l00931"></a>00931         $msg =~ s/\$COL\[(\-?\d+)\]/$COL[$1]/ge
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933     <span class="keywordflow">else</span> {                      # prevents extraneous $COL<span class="stringliteral">&#39;s in email message </span>
<a name="l00934"></a>00934 <span class="stringliteral">        $msg =~ s/\$COL\[(\-?\d+)\]//g</span>
<a name="l00935"></a>00935 <span class="stringliteral">    }           </span>
<a name="l00936"></a>00936 <span class="stringliteral">             </span>
<a name="l00937"></a>00937 <span class="stringliteral">    $msg =~ s/\r//g;</span>
<a name="l00938"></a>00938 <span class="stringliteral">    </span>
<a name="l00939"></a>00939 <span class="stringliteral">    if ($for_preview) {</span>
<a name="l00940"></a>00940 <span class="stringliteral">        my @preview_COL = @COL;</span>
<a name="l00941"></a>00941 <span class="stringliteral">        shift @preview_COL; ## shift back for preview</span>
<a name="l00942"></a>00942 <span class="stringliteral">        my $preview_header =    CGI::p(&#39;</span><span class="stringliteral">&#39;,data_format(1..($#COL)),&quot;&lt;br&gt;&quot;, data_format2(@preview_COL)).</span>
<a name="l00943"></a>00943 <span class="stringliteral">                                CGI::h3( &quot;This sample mail would be sent to $EMAIL&quot;);</span>
<a name="l00944"></a>00944 <span class="stringliteral">        return $msg, $preview_header;</span>
<a name="l00945"></a>00945 <span class="stringliteral">    } else {</span>
<a name="l00946"></a>00946 <span class="stringliteral">        return $msg;</span>
<a name="l00947"></a>00947 <span class="stringliteral">    }</span>
<a name="l00948"></a>00948 <span class="stringliteral">}</span>
<a name="l00949"></a>00949 <span class="stringliteral"></span>
<a name="l00950"></a>00950 <span class="stringliteral"></span>
<a name="l00951"></a>00951 <span class="stringliteral"># Ý sub data_format {</span>
<a name="l00952"></a>00952 <span class="stringliteral"># </span>
<a name="l00953"></a>00953 <span class="stringliteral"># Ý Ý Ý Ý Ýmap {$_ =~s/\s/\./g;$_} Ý Ý map {sprintf(&#39;</span>%-8.8s<span class="stringliteral">&#39;,$_);} Ý@_;</span>
<a name="l00954"></a>00954 <span class="stringliteral"> sub data_format {</span>
<a name="l00955"></a>00955 <span class="stringliteral">        map {&quot;COL[$_]&quot;.&#39;</span>&amp;nbsp;<span class="stringliteral">&#39;x(3-length($_));}  @_;  # problems if $_ has length bigger than 4</span>
<a name="l00956"></a>00956 <span class="stringliteral"> }</span>
<a name="l00957"></a>00957 <span class="stringliteral">  sub data_format2 {</span>
<a name="l00958"></a>00958 <span class="stringliteral">    map {$_ =~s/\s/&amp;nbsp;/g;$_}  map {sprintf(&#39;</span>%-8.8s<span class="stringliteral">&#39;,$_);} @_;</span>
<a name="l00959"></a>00959 <span class="stringliteral"> }</span>
<a name="l00960"></a>00960 <span class="stringliteral">1;</span>
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:35 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
