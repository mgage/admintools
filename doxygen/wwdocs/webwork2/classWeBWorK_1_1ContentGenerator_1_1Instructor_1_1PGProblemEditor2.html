<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::ContentGenerator::Instructor::PGProblemEditor2 Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator.html">ContentGenerator</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">Instructor</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html">PGProblemEditor2</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::ContentGenerator::Instructor::PGProblemEditor2 Class Reference</h1><!-- doxytag: class="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2" --><!-- doxytag: inherits="WeBWorK::ContentGenerator::Instructor" --><div class="dynheader">
Inheritance diagram for WeBWorK::ContentGenerator::Instructor::PGProblemEditor2:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2__inherit__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2_inherit__map" id="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2_inherit__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html" title="WeBWorK::ContentGenerator::Instructor" alt="" coords="63,155,319,181"/><area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="95,80,287,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="149,5,232,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::ContentGenerator::Instructor::PGProblemEditor2:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2__coll__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2_coll__map" id="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2_coll__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html" title="WeBWorK::ContentGenerator::Instructor" alt="" coords="63,155,319,181"/><area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="95,80,287,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="149,5,232,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#ae65daf12893fa707a864beb679053300">determineTempEditFilePath</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a93e8b63262af1b909be9e32e1603639e">add_problem_handler</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a5910c09b0977cf22be2365409ea7ca08">getTempEditFileDirectory</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a106d602baf5e6b0bdd251c41b4d53cdd">getRelativeSourceFilePath</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a39ca2e1108a6added2cb5b6af94e189e">initialize</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2aae0e640103dd76c965844a310fbd38">pre_header_initialize</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2c260324e41d5d4fc2c9a2db93d8876a">determineLocalFilePath</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a5f417ad7794fa8ba7e38d57594230899">getFilePaths</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2d455974b9b58a960a1dba0c8f948013">save_handler</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#aa363b2e899a25aa68daa8b0517e82452">body</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#aaadd413f259419b198483c7e55b78054">shortPath</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a484292878ba4c69d9d27eede639b1e4e">save_form</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a43856bccffca3d51e5bf23d30f7c1529">revert_handler</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#accbc9cfa29bc5d94c525920ebe79b74d">revert_form</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2bc5183b8cb0ca2a4e9fb4d005a242dc">view_form</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a02e024195d5a3b057520886a18ca198d">save_as_handler</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a65e39ca89fd80c5dc94fb165df272148">add_problem_form</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a1e77700d6d2c48c23f57ae30adc672b7">saveFileChanges</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#aa5272e56eb36e37e794af9cfdc5acc61">isTempEditFilePath</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a4a3487ac6022901ee8c5610d3b3c6a68">fresh_edit_handler</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a25ea344aa463666f0a943be46c72141b">getActionParams</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a193df41426478b834556f8ed9885dfd5">output_tabber_CSS</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a05371de252fbae39cc0bf36b9aae4f54">path</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a8b850b44bcd4a4090664338cd8589a5a">determineOriginalEditFilePath</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#acb746e654fb81f6d32f621e5a848faaa">view_handler</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#ace9ad8ee32d78fc044edc35d75defdfd">fixProblemContents</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#adbf8e96ef1d246b231d64dc82035b674">output_JS</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2670d9a9d68115f2fe7d155c422791fb">title</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#aea4ea2b51439c92ecb416103e7395af9">save_as_form</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html">WeBWorK::ContentGenerator::Instructor::PGProblemEditor2</a> - Edit a pg file </p>

<p>Definition at line <a class="el" href="PGProblemEditor2_8pm_source.html#l00027">27</a> of file <a class="el" href="PGProblemEditor2_8pm_source.html">PGProblemEditor2.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a65e39ca89fd80c5dc94fb165df272148"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::add_problem_form" ref="a65e39ca89fd80c5dc94fb165df272148" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::add_problem_form </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-add_problem_form' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-add_problem_form-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-add_problem_form-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-add_problem_form-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in add_problem_form: 29</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a65e39ca89fd80c5dc94fb165df272148">add_problem_form</a> {
   my $self            = shift;
    my ($onChange, %actionParams) = @_;
    my $r               = $self-&gt;r;
    my $setName         = $self-&gt;{setID} ;
    my $problemNumber   = $self-&gt;{problemID} ;
    $setName            = defined($setName) ? $setName : <span class="stringliteral">&#39;&#39;</span>;  # we need <span class="keyword">this</span> instead of <span class="keyword">using</span> the || construction 
<span class="preprocessor">                                                              # to keep set 0 from being set to the </span>
<span class="preprocessor"></span><span class="preprocessor">                                                              # empty string.</span>
<span class="preprocessor"></span>    my $filePath        = $self-&gt;{inputFilePath};
    $setName   =~ s|^<span class="keyword">set</span>||;
    my @allSetNames = sort $r-&gt;db-&gt;listGlobalSets;
    <span class="keywordflow">for</span> (my $j=0; $j&lt;scalar(@allSetNames); $j++) {
        $allSetNames[$j] =~ s|^<span class="keyword">set</span>||;
        $allSetNames[$j] =~ s|\.def||;
    }
    my $labels = {
        problem         =&gt; <span class="stringliteral">&#39;problem&#39;</span>,
        set_header      =&gt; <span class="stringliteral">&#39;set header&#39;</span>,
        hardcopy_header =&gt; <span class="stringliteral">&#39;hardcopy header&#39;</span>,
    };
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $self-&gt;{file_type} eq <span class="stringliteral">&#39;course_info&#39;</span> || $self-&gt;{file_type} eq <span class="stringliteral">&#39;options_info&#39;</span>;
    <span class="keywordflow">return</span> join(<span class="stringliteral">&quot; &quot;</span>,
        <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;select&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;action_add_problem_target_set_id&quot;</span>, -label_text=&gt;<span class="stringliteral">&quot;Add to what set?: &quot;</span>, -input_attr=&gt;{name=&gt;<span class="stringliteral">&#39;action.add_problem.target_set&#39;</span>, values=&gt;\@allSetNames, <span class="keywordflow">default</span>=&gt;$setName, onmousedown=&gt;$onChange}),CGI::br(),
        <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;select&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;action_add_problem_file_type_id&quot;</span>, -label_text=&gt;<span class="stringliteral">&quot;Add as what filetype?: &quot;</span>, -input_attr=&gt;{name=&gt;<span class="stringliteral">&#39;action.add_problem.file_type&#39;</span>, values=&gt;[<span class="stringliteral">&#39;problem&#39;</span>,<span class="stringliteral">&#39;set_header&#39;</span>, <span class="stringliteral">&#39;hardcopy_header&#39;</span>], labels=&gt;$labels, <span class="keywordflow">default</span>=&gt;$self-&gt;{file_type}, onmousedown=&gt;$onChange}),
        CGI::br()
    );  #FIXME  add -lables to the pop up menu
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a93e8b63262af1b909be9e32e1603639e"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::add_problem_handler" ref="a93e8b63262af1b909be9e32e1603639e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::add_problem_handler </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-add_problem_handler' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-add_problem_handler-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-add_problem_handler-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-add_problem_handler-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in add_problem_handler: 87</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a93e8b63262af1b909be9e32e1603639e">add_problem_handler</a> {
    my ($self, $genericParams, $actionParams, $tableParams) = @_;
    my $r=&gt;$self-&gt;r;
<span class="preprocessor">    #$self-&gt;addgoodmessage(&quot;add_problem_handler called&quot;);</span>
<span class="preprocessor"></span>    my $courseName      =  $self-&gt;{courseID};
    my $setName         =  $self-&gt;{setID};
    my $problemNumber   =  $self-&gt;{problemID};
    my $sourceFilePath  =  $self-&gt;{editFilePath};
    my $displayMode     =  $self-&gt;{displayMode};
    my $problemSeed     =  $self-&gt;{problemSeed};
            
    my $targetSetName         =  $actionParams-&gt;{<span class="stringliteral">&#39;action.add_problem.target_set&#39;</span>}-&gt;[0];
    my $targetFileType        =  $actionParams-&gt;{<span class="stringliteral">&#39;action.add_problem.file_type&#39;</span>}-&gt;[0];
    my $templatesPath         =  $self-&gt;r-&gt;ce-&gt;{courseDirs}-&gt;{templates};
    $sourceFilePath    =~ s|^$templatesPath/||;
    
    my $edit_level = $self-&gt;r-&gt;param(<span class="stringliteral">&quot;edit_level&quot;</span>) || 0;
    $edit_level++;

    my $viewURL =<span class="stringliteral">&#39;&#39;</span>;
    <span class="keywordflow">if</span> ($targetFileType eq <span class="stringliteral">&#39;problem&#39;</span>) {
        my $targetProblemNumber   =  1+ <a class="code" href="classWeBWorK_1_1Utils.html#a3d364a4d0cb81eef75c34845afb179e3">WeBWorK::Utils::max</a>( $self-&gt;r-&gt;db-&gt;listGlobalProblems($targetSetName));
        
<span class="preprocessor">        #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Update problem record</span>
<span class="preprocessor"></span><span class="preprocessor">        #################################################</span>
<span class="preprocessor"></span>        my $problemRecord  = $self-&gt;addProblemToSet(
                               setName        =&gt; $targetSetName,
                               sourceFile     =&gt; $sourceFilePath, 
                               problemID      =&gt; $targetProblemNumber, #added to end of <span class="keyword">set</span>
        );
        $self-&gt;assignProblemToAllSetUsers($problemRecord);
        $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Added $sourceFilePath to &quot;</span>. $targetSetName. <span class="stringliteral">&quot; as problem $targetProblemNumber&quot;</span>) ;
        $self-&gt;{file_type}   = <span class="stringliteral">&#39;problem&#39;</span>; # change file type to problem -- <span class="keywordflow">if</span> it<span class="stringliteral">&#39;s not already that</span>
<span class="stringliteral"></span>
<span class="stringliteral">        #################################################</span>
<span class="stringliteral">        # Set up redirect Problem.pm</span>
<span class="stringliteral">        #################################################</span>
<span class="stringliteral">        my $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Problem&quot;,$r,</span>
<span class="stringliteral">            courseID  =&gt; $courseName, </span>
<span class="stringliteral">            setID     =&gt; $targetSetName, </span>
<span class="stringliteral">            problemID =&gt; $targetProblemNumber, </span>
<span class="stringliteral">        );</span>
<span class="stringliteral">        my $relativeSourceFilePath = $self-&gt;getRelativeSourceFilePath($sourceFilePath);</span>
<span class="stringliteral">        $viewURL = $self-&gt;systemLink($problemPage,</span>
<span class="stringliteral">                params =&gt; {</span>
<span class="stringliteral">                    displayMode        =&gt; $displayMode,</span>
<span class="stringliteral">                    problemSeed        =&gt; $problemSeed,</span>
<span class="stringliteral">                    editMode           =&gt; &quot;savedFile&quot;,</span>
<span class="stringliteral">                    edit_level         =&gt; $edit_level,</span>
<span class="stringliteral">                    sourceFilePath     =&gt; $relativeSourceFilePath,</span>
<span class="stringliteral">                    status_message     =&gt; uri_escape($self-&gt;{status_message})</span>
<span class="stringliteral">    </span>
<span class="stringliteral">                }</span>
<span class="stringliteral">        );</span>
<span class="stringliteral">    } elsif ($targetFileType eq &#39;</span>set_header<span class="stringliteral">&#39;)  {</span>
<span class="stringliteral">        #################################################</span>
<span class="stringliteral">        # Update set record</span>
<span class="stringliteral">        #################################################</span>
<span class="stringliteral">        my $setRecord  = $self-&gt;r-&gt;db-&gt;getGlobalSet($targetSetName);</span>
<span class="stringliteral">        $setRecord-&gt;set_header($sourceFilePath);</span>
<span class="stringliteral">        if(  $self-&gt;r-&gt;db-&gt;putGlobalSet($setRecord) ) {</span>
<span class="stringliteral">            $self-&gt;addgoodmessage(&quot;Added &#39;</span><span class="stringliteral">&quot;.$self-&gt;shortPath($sourceFilePath).&quot;</span><span class="stringliteral">&#39; to &quot;. $targetSetName. &quot; as new set header &quot;) ;</span>
<span class="stringliteral">        } else {</span>
<span class="stringliteral">            $self-&gt;addbadmessage(&quot;Unable to make &#39;</span><span class="stringliteral">&quot;.$self-&gt;shortPath($sourceFilePath).&quot;</span><span class="stringliteral">&#39; the set header for $targetSetName&quot;);</span>
<span class="stringliteral">        }</span>
<span class="stringliteral">        $self-&gt;{file_type} = &#39;</span>set_header<span class="stringliteral">&#39;; # change file type to set_header if it not already so</span>
<span class="stringliteral">        #################################################</span>
<span class="stringliteral">        # Set up redirect</span>
<span class="stringliteral">        #################################################</span>
<span class="stringliteral">        my $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::ProblemSet&quot;,$r,</span>
<span class="stringliteral">            courseID =&gt; $courseName, setID =&gt; $targetSetName</span>
<span class="stringliteral">        );</span>
<span class="stringliteral">        $viewURL = $self-&gt;systemLink($problemPage,</span>
<span class="stringliteral">                params =&gt; {</span>
<span class="stringliteral">                    displayMode        =&gt; $displayMode,</span>
<span class="stringliteral">                    editMode           =&gt; &quot;savedFile&quot;,</span>
<span class="stringliteral">                    edit_level         =&gt; $edit_level,</span>
<span class="stringliteral">                    status_message     =&gt; uri_escape($self-&gt;{status_message})</span>
<span class="stringliteral">                }</span>
<span class="stringliteral">        );</span>
<span class="stringliteral">    } else {</span>
<span class="stringliteral">        die &quot;Don&#39;</span>t know what to <span class="keywordflow">do</span> with target file type $targetFileType<span class="stringliteral">&quot;;</span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    </span>
<span class="stringliteral">    $self-&gt;reply_with_redirect($viewURL);</span>
<span class="stringliteral">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aa363b2e899a25aa68daa8b0517e82452"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::body" ref="aa363b2e899a25aa68daa8b0517e82452" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::body </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-body' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-body-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-body-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-body-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in body: 332</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#aa363b2e899a25aa68daa8b0517e82452">body</a> {
    my ($self) = @_;
    my $r = $self-&gt;r;
    my $db = $r-&gt;db;
    my $ce = $r-&gt;ce;
    my $authz = $r-&gt;authz;
    my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
    my $make_local_copy = $r-&gt;param(<span class="stringliteral">&#39;make_local_copy&#39;</span>);
 
<span class="preprocessor">    # Check permissions</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, <span class="stringliteral">&quot;You are not authorized to access the Instructor tools.&quot;</span>)
        unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
    
    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, <span class="stringliteral">&quot;You are not authorized to modify problems.&quot;</span>)
        unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;modify_student_data&quot;</span>);

    
    
    
<span class="preprocessor">    # Gathering info</span>
<span class="preprocessor"></span>    my $editFilePath    = $self-&gt;{editFilePath}; # path to the permanent file to be edited
    my $tempFilePath    = $self-&gt;{tempFilePath}; # path to the file currently being worked with (might be a .tmp file)
    my $inputFilePath   = $self-&gt;{inputFilePath};   # path to the file <span class="keywordflow">for</span> input, (might be a .tmp file)
    my $setName         = $self-&gt;{setID} ;
    my $problemNumber   = $self-&gt;{problemID} ;
    $setName            = defined($setName) ? $setName : <span class="stringliteral">&#39;&#39;</span>;  # we need <span class="keyword">this</span> instead of <span class="keyword">using</span> the || construction 
<span class="preprocessor">                                                              # to keep set 0 from being set to the </span>
<span class="preprocessor"></span><span class="preprocessor">                                                              # empty string.</span>
<span class="preprocessor"></span>    my $fullSetName = defined( $self-&gt;{fullSetID} ) ? $self-&gt;{fullSetID} : $setName;
    $problemNumber      = defined($problemNumber) ? $problemNumber : <span class="stringliteral">&#39;&#39;</span>;
    
    
    
<span class="preprocessor">    #########################################################################    </span>
<span class="preprocessor"></span><span class="preprocessor">    # Construct url for reporting bugs:</span>
<span class="preprocessor"></span><span class="preprocessor">    #########################################################################</span>
<span class="preprocessor"></span>
    my $libraryName = <span class="stringliteral">&#39;&#39;</span>;
    <span class="keywordflow">if</span> ($editFilePath =~ m|([^/]*)Library|)   {  #find the path to the file
<span class="preprocessor">        # find the library, if any exists in the path name (first library is picked)</span>
<span class="preprocessor"></span>        my $tempLibraryName = $1;
        $libraryName = ( not_blank($tempLibraryName) ) ? 
                        $tempLibraryName : <span class="stringliteral">&quot;Library&quot;</span>; 
<span class="preprocessor">        # things that start /Library/setFoo/probBar  are labeled as component &quot;Library&quot;</span>
<span class="preprocessor"></span><span class="preprocessor">        # which refers to the SQL based problem library. (is nationalLibrary a better name?)</span>
<span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
        $libraryName = <span class="stringliteral">&#39;Library&#39;</span>;  # make sure there is some <span class="keywordflow">default</span> component defined.
    }

    my $BUGZILLA = <span class="stringliteral">&quot;$ce-&gt;{webworkURLs}{bugReporter}?product=Problem%20libraries&quot;</span>.
                   <span class="stringliteral">&quot;&amp;component=$libraryName&amp;bug_file_loc=${editFilePath}_with_problemSeed=&quot;</span>.$self-&gt;{problemSeed};
<span class="preprocessor">    #FIXME  # The construction of this URL is somewhat fragile.  A separate module could be devoted to </span>
<span class="preprocessor"></span><span class="preprocessor">    # intelligent bug reporting.</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    #########################################################################    </span>
<span class="preprocessor"></span><span class="preprocessor">    # Construct reference row for PGproblemEditor.</span>
<span class="preprocessor"></span><span class="preprocessor">    #########################################################################</span>
<span class="preprocessor"></span>    
       my @PG_Editor_Reference_Links = (
        {label      =&gt;  <span class="stringliteral">&#39;Problem Techniques&#39;</span>    ,
         <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad408331e3a459441e5c724646b04c8fb">url</a>        =&gt;  <span class="stringliteral">&#39;http://webwork.maa.org/wiki/Category:Problem_Techniques&#39;</span>   ,
         target     =&gt;  <span class="stringliteral">&#39;techniques_window&#39;</span> ,
         tooltip    =&gt;  <span class="stringliteral">&#39;Snippets of PG code illustrating specific techniques&#39;</span>  ,
        },
        {label      =&gt;  <span class="stringliteral">&#39;Math Objects&#39;</span>  ,
         <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad408331e3a459441e5c724646b04c8fb">url</a>        =&gt;   <span class="stringliteral">&#39;http://webwork.maa.org/wiki/Category:MathObjects&#39;</span>     ,
         target     =&gt;  <span class="stringliteral">&#39;math_objects&#39;</span>  ,
         tooltip    =&gt;  <span class="stringliteral">&#39;Wiki summary page for MathObjects&#39;</span> ,
        },          
        {label      =&gt;  <span class="stringliteral">&#39;POD&#39;</span>   ,
         <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad408331e3a459441e5c724646b04c8fb">url</a>        =&gt;  <span class="stringliteral">&#39;http://webwork.maa.org/pod/pg_TRUNK/&#39;</span>      ,
         target     =&gt;  <span class="stringliteral">&#39;pod_docs&#39;</span>  ,
         tooltip    =&gt;  <span class="stringliteral">&#39;Documentation from source code for PG modules and macro files. Often the most up-to-date information.&#39;</span> ,
        },
        {label      =&gt;  <span class="stringliteral">&#39;PGLab&#39;</span> ,
         <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad408331e3a459441e5c724646b04c8fb">url</a>        =&gt;  <span class="stringliteral">&#39;http://hosted2.webwork.rochester.edu/webwork2/wikiExamples/MathObjectsLabs2/2/?login_practice_user=true&#39;</span>   ,
         target     =&gt;  <span class="stringliteral">&#39;PGLab&#39;</span> ,
         tooltip    =&gt;  <span class="stringliteral">&#39;Test snippets of PG code in interactive lab.  Good way to learn PG language.&#39;</span>  ,
        },
        {label      =&gt;  <span class="stringliteral">&#39;PGML&#39;</span>  ,
         <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad408331e3a459441e5c724646b04c8fb">url</a>        =&gt;  <span class="stringliteral">&#39;https://courses.webwork.maa.org/webwork2/cervone_course/PGML/1/?login_practice_user=true&#39;</span>,
         target     =&gt;  <span class="stringliteral">&#39;PGML&#39;</span>  ,
         tooltip    =&gt;  <span class="stringliteral">&#39;PG mark down syntax used to format WeBWorK questions. This interactive lab can help you to learn the techniques.&#39;</span>  ,
        },
        {label      =&gt;  <span class="stringliteral">&#39;Author Info&#39;</span>   ,
         <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad408331e3a459441e5c724646b04c8fb">url</a>        =&gt;  <span class="stringliteral">&#39;http://webwork.maa.org/wiki/Category:Authors&#39;</span>      ,
         target     =&gt;  <span class="stringliteral">&#39;author_info&#39;</span>   ,
         tooltip    =&gt;  <span class="stringliteral">&#39;Top level of author information on the wiki.&#39;</span>  ,
        },
        {label      =&gt;  <span class="stringliteral">&#39;report bugs in this problem&#39;</span>   ,
         <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad408331e3a459441e5c724646b04c8fb">url</a>        =&gt;  $BUGZILLA   ,
         target     =&gt;  <span class="stringliteral">&#39;bug_report&#39;</span>    ,
         tooltip    =&gt;  <span class="stringliteral">&#39;Report bugs in a WeBWorK question/problem using this link. &lt;br/&gt; The very first time you do this you will need to register with an email address so that information on the bug fix can be reported back to you.&#39;</span>  ,
        },
   
   
   
   );
   my $PG_Editor_Reference_String = <span class="stringliteral">&#39;&#39;</span>;
   <span class="keywordflow">foreach</span> my $link (@PG_Editor_Reference_Links) {
        $PG_Editor_Reference_String .= <span class="stringliteral">&#39; | &#39;</span>. 
           CGI::a({-href=&gt;$link-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad408331e3a459441e5c724646b04c8fb">url</a>} ,-target=&gt; $link-&gt;{target},
           -onmouseover=&gt;q!Tip(<span class="stringliteral">&#39;! .  $link-&gt;{tooltip} . </span>
<span class="stringliteral">                            q!&#39;</span>,SHADOW, <span class="keyword">true</span>, 
                            DELAY, 100, FADEIN, 300, FADEOUT, 300, STICKY, 0, OFFSETX, -20,  CLICKCLOSE, <span class="keyword">true</span>, 
                            BGCOLOR, <span class="stringliteral">&#39;#F4FF91&#39;</span>, TITLE, <span class="stringliteral">&#39;Reference:&#39;</span>,TITLEBGCOLOR, <span class="stringliteral">&#39;#F4FF91&#39;</span>, TITLEFONTCOLOR, <span class="stringliteral">&#39;#000000&#39;</span>)!
                },
        <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>.$link-&gt;{label}.<span class="stringliteral">&#39;&amp;nbsp;&#39;</span>);   
   }
   $PG_Editor_Reference_String .=<span class="stringliteral">&#39; | &#39;</span>;
<span class="preprocessor">    #########################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Find the text for the problem, either in the tmp file, if it exists</span>
<span class="preprocessor"></span><span class="preprocessor">    # or in the original file in the template directory</span>
<span class="preprocessor"></span><span class="preprocessor">    # or in the problem contents gathered in the initialization phase.</span>
<span class="preprocessor"></span><span class="preprocessor">    #########################################################################</span>
<span class="preprocessor"></span>    
    my $problemContents = ${$self-&gt;{r_problemContents}};

    unless ( $problemContents =~/\S/)   { # non-empty contents
        <span class="keywordflow">if</span> (-<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a> $tempFilePath and not -d $tempFilePath) {
            die <span class="stringliteral">&quot;tempFilePath is unsafe!&quot;</span> unless path_is_subdir($tempFilePath, $ce-&gt;{courseDirs}-&gt;{templates}, 1); # 1==path can be relative to dir
            eval { $problemContents = <a class="code" href="classWeBWorK_1_1Utils.html#a7aa337cd97110ff3e5c7536bfb1a84e8">WeBWorK::Utils::readFile</a>($tempFilePath) };
            $problemContents = $@ <span class="keywordflow">if</span> $@;
            $inputFilePath = $tempFilePath;
        } elsif  (-<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a> $editFilePath and not -d $editFilePath) {
            die <span class="stringliteral">&quot;editFilePath is unsafe!&quot;</span> unless path_is_subdir($editFilePath, $ce-&gt;{courseDirs}-&gt;{templates}, 1)  # 1==path can be relative to dir
                || $editFilePath eq $ce-&gt;{webworkFiles}{screenSnippets}{setHeader}
                || $editFilePath eq $ce-&gt;{webworkFiles}{hardcopySnippets}{setHeader}
                || $editFilePath eq $ce-&gt;{webworkFiles}{screenSnippets}{blankProblem};
            eval { $problemContents = <a class="code" href="classWeBWorK_1_1Utils.html#a7aa337cd97110ff3e5c7536bfb1a84e8">WeBWorK::Utils::readFile</a>($editFilePath) };
            $problemContents = $@ <span class="keywordflow">if</span> $@;
            $inputFilePath = $editFilePath;
        } <span class="keywordflow">else</span> { # file not existing is not an error
<span class="preprocessor">            #warn &quot;No file exists&quot;;</span>
<span class="preprocessor"></span>            $problemContents = <span class="stringliteral">&#39;&#39;</span>;
        }
    } <span class="keywordflow">else</span> {
<span class="preprocessor">        #warn &quot;obtaining input from r_problemContents&quot;;</span>
<span class="preprocessor"></span>    }

    my $protected_file = not -w $inputFilePath;

    my $file_type = $self-&gt;{file_type};
    my %titles = (
        problem         =&gt; CGI::b(<span class="stringliteral">&quot;set $fullSetName/problem $problemNumber&quot;</span>),
        blank_problem   =&gt; <span class="stringliteral">&quot;blank problem&quot;</span>,
        set_header      =&gt; <span class="stringliteral">&quot;header file&quot;</span>,
        hardcopy_header =&gt; <span class="stringliteral">&quot;hardcopy header file&quot;</span>,
        course_info     =&gt; <span class="stringliteral">&quot;course information&quot;</span>,
        options_info    =&gt; <span class="stringliteral">&quot;options information&quot;</span>,
        <span class="stringliteral">&#39;&#39;</span>              =&gt; <span class="stringliteral">&#39;Unknown file type&#39;</span>,
        source_path_for_problem_file =&gt; <span class="stringliteral">&quot; unassigned problem file:  &quot;</span>.CGI::b(<span class="stringliteral">&quot;set $setName/problem $problemNumber&quot;</span>),
    );
    my $header = CGI::i(<span class="stringliteral">&quot;Editing $titles{$file_type} in file &#39;&quot;</span>.$self-&gt;shortPath($inputFilePath).<span class="stringliteral">&quot;&#39;&quot;</span>);
    $header = ($self-&gt;isTempEditFilePath($inputFilePath)  ) ? CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;temporaryFile&#39;</span>},$header) : $header;  # use colors <span class="keywordflow">if</span> temporary file
    
<span class="preprocessor">    #########################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Format the page</span>
<span class="preprocessor"></span><span class="preprocessor">    #########################################################################</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    # Define parameters for textarea</span>
<span class="preprocessor"></span><span class="preprocessor">    # FIXME </span>
<span class="preprocessor"></span><span class="preprocessor">    # Should the seed be set from some particular user instance??</span>
<span class="preprocessor"></span>    my $rows            = 20;
    my $columns         = 80;
    my $mode_list       = $ce-&gt;{pg}-&gt;{displayModes};
    my $displayMode     = $self-&gt;{displayMode};
    my $problemSeed     = $self-&gt;{problemSeed}; 
    my $uri             = $r-&gt;uri;
    my $edit_level      = $r-&gt;param(<span class="stringliteral">&#39;edit_level&#39;</span>) || 0;
    
    my $force_field = (not_blank( $self-&gt;{sourceFilePath}) ) ? # path is  a non-blank <span class="keywordtype">string</span>
        CGI::hidden(-name=&gt;<span class="stringliteral">&#39;sourceFilePath&#39;</span>,
                    -<span class="keywordflow">default</span>=&gt;$self-&gt;{sourceFilePath}) : <span class="stringliteral">&#39;&#39;</span>;

<span class="preprocessor">    # FIXME this isn&#39;t used at all! --sam</span>
<span class="preprocessor"></span>    my @allSetNames = sort $db-&gt;listGlobalSets;
    <span class="keywordflow">for</span> (my $j=0; $j&lt;scalar(@allSetNames); $j++) {
        $allSetNames[$j] =~ s|^<span class="keyword">set</span>||;
        $allSetNames[$j] =~ s|\.def||;
    }
    my $target = <span class="stringliteral">&#39;WW_View&#39;</span>; #<span class="stringliteral">&quot;problem$edit_level&quot;</span>; # increasing edit_level gives you a <span class="keyword">new</span> window with each edit.
    my $site_url = $ce-&gt;{webworkURLs}-&gt;{htdocs};
    print qq!&lt;script type=<span class="stringliteral">&quot;text/javascript&quot;</span> src=<span class="stringliteral">&quot;$site_url/js/wz_tooltip.js&quot;</span>&gt;&lt;/script&gt;!;
    print CGI::script(&lt;&lt;EOF);
        function setTarget(inWindow) {
          document.getElementById(<span class="stringliteral">&quot;newWindow&quot;</span>).checked = inWindow;
          updateTarget();
        }
        function updateTarget() {
          var inWindow = document.getElementById(<span class="stringliteral">&quot;newWindow&quot;</span>).checked;
          document.getElementById(<span class="stringliteral">&quot;editor&quot;</span>).target = (inWindow? <span class="stringliteral">&quot;WW_View&quot;</span>: <span class="stringliteral">&quot;&quot;</span>);
        }
        function setRadio(i,nw) {
          document.getElementById(<span class="stringliteral">&#39;action&#39;</span>+i).checked = <span class="keyword">true</span>;
          setTarget(nw);
        }
EOF
    

   
    print CGI::p($header),

        CGI::start_form({method=&gt;<span class="stringliteral">&quot;POST&quot;</span>, <span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;editor&quot;</span>, name=&gt;<span class="stringliteral">&quot;editor&quot;</span>, action=&gt;<span class="stringliteral">&quot;$uri&quot;</span>, enctype=&gt;<span class="stringliteral">&quot;application/x-www-form-urlencoded&quot;</span>}),

        $self-&gt;hidden_authen_fields,
        $force_field,
        CGI::hidden(-name=&gt;<span class="stringliteral">&#39;file_type&#39;</span>,-<span class="keywordflow">default</span>=&gt;$self-&gt;{file_type}),
        CGI::div({},$PG_Editor_Reference_String),
#           CGI::a({-href=&gt;<span class="stringliteral">&#39;http://webwork.math.rochester.edu/docs/docs/pglanguage/manpages/&#39;</span>,-target=&gt;<span class="stringliteral">&quot;manpage_window&quot;</span>},
<span class="preprocessor">#               &#39;&amp;nbsp;Manpages&amp;nbsp;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           ),&quot; | &quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           CGI::a({-href=&gt;&#39;http://devel.webwork.rochester.edu/twiki/bin/view/Webwork/PGmacrosByFile&#39;,-target=&gt;&quot;manpage_window&quot;},</span>
<span class="preprocessor"></span><span class="preprocessor">#               &#39;&amp;nbsp;macro list&amp;nbsp;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           ),&quot; | &quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           CGI::a({-href=&gt;&#39;http://webwork.maa.org/wiki/Category:Authors&#39;,-target=&gt;&quot;wiki_window&quot;},</span>
<span class="preprocessor"></span><span class="preprocessor">#               &#39;&amp;nbsp;authoring&amp;nbsp;info&amp;nbsp;&amp;amp; help&amp;nbsp;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           ),&quot; | &quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           CGI::a({-href=&gt;&#39;http://hosted2.webwork.rochester.edu/webwork2/wikiExamples/MathObjectsLabs2/2/?login_practice_user=true&#39;,-target=&gt;&quot;lab_window&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#                },</span>
<span class="preprocessor"></span><span class="preprocessor">#               &#39;&amp;nbsp;testing&amp;nbsp;lab&amp;nbsp;&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">#           ),&quot; | &quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           CGI::a({-href=&gt;&#39;http://devel.webwork.rochester.edu/doc/cvs/pg_HEAD/&#39;,-target=&gt;&quot;doc_window&quot;},</span>
<span class="preprocessor"></span><span class="preprocessor">#               &#39;&amp;nbsp;pod docs&amp;nbsp;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           ),&quot; | &quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           CGI::a({-href=&gt;$BUGZILLA,-target=&gt;&quot;bugs_window&quot;},</span>
<span class="preprocessor"></span><span class="preprocessor">#               &#39;&amp;nbsp;report problem bugs&amp;nbsp;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">#           ),&quot; | &quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#       ),</span>
<span class="preprocessor"></span>        CGI::p(
            CGI::textarea(
                -name =&gt; <span class="stringliteral">&#39;problemContents&#39;</span>, -<span class="keywordflow">default</span> =&gt; $problemContents,
                -rows =&gt; $rows, -cols =&gt; $columns, -<span class="keyword">override</span> =&gt; 1,
            ),
        );


    
<span class="preprocessor">######### print action forms</span>
<span class="preprocessor"></span>        
<span class="preprocessor">            #print CGI::Tr({}, CGI::td({-colspan=&gt;2}, &quot;Select an action to perform:&quot;));</span>
<span class="preprocessor"></span>            
            my @formsToShow = @{ ACTION_FORMS() };
            my $default_choice = $formsToShow[0];
            my $i = 0;
            
<span class="preprocessor">###################################################################COLUMN STYLE BEGIN###############################################################</span>
<span class="preprocessor"></span>            
<span class="preprocessor">            # foreach my $actionID (@formsToShow) {</span>
<span class="preprocessor"></span><span class="preprocessor">                # # Check permissions</span>
<span class="preprocessor"></span><span class="preprocessor">                # #next if FORM_PERMS()-&gt;{$actionID} and not $authz-&gt;hasPermissions($user, FORM_PERMS()-&gt;{$actionID});</span>
<span class="preprocessor"></span><span class="preprocessor">                # my $actionForm = &quot;${actionID}_form&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">                # my $newWindow = ($actionID =~ m/^(view|add_problem|save)$/)? 1: 0;</span>
<span class="preprocessor"></span><span class="preprocessor">                # my $onChange = &quot;setRadio($i,$newWindow)&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">                # my %actionParams = $self-&gt;getActionParams($actionID);</span>
<span class="preprocessor"></span><span class="preprocessor">                # my $line_contents = $self-&gt;$actionForm($onChange, %actionParams);</span>
<span class="preprocessor"></span><span class="preprocessor">                # my $radio_params = {-type=&gt;&quot;radio&quot;, -name=&gt;&quot;action&quot;, -value=&gt;$actionID};</span>
<span class="preprocessor"></span><span class="preprocessor">                # $radio_params-&gt;{checked}=1 if ($actionID eq $default_choice) ;</span>
<span class="preprocessor"></span><span class="preprocessor">                # $radio_params-&gt;{onclick} = &quot;setTarget($newWindow)&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">                # $radio_params-&gt;{id} = &quot;action$i&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">                # # print CGI::Tr({-valign=&gt;&quot;top&quot;},</span>
<span class="preprocessor"></span><span class="preprocessor">                    # # CGI::td({}, CGI::input($radio_params)),</span>
<span class="preprocessor"></span><span class="preprocessor">                    # # CGI::td({}, $line_contents)</span>
<span class="preprocessor"></span><span class="preprocessor">                # # ) if $line_contents;</span>
<span class="preprocessor"></span><span class="preprocessor">                # if($line_contents){</span>
<span class="preprocessor"></span><span class="preprocessor">                    # print CGI::start_div({-class=&gt;&quot;column&quot;});</span>
<span class="preprocessor"></span><span class="preprocessor">                    # print CGI::div({-class=&gt;&quot;pg_editor_input_span&quot;},WeBWorK::CGI_labeled_input(-type=&gt;&quot;radio&quot;, -id=&gt;$actionForm.&quot;_id&quot;, -label_text=&gt;ucfirst(WeBWorK::underscore_to_whitespace($actionForm)), -input_attr=&gt;$radio_params),CGI::br());</span>
<span class="preprocessor"></span><span class="preprocessor">                    # print CGI::div({-class=&gt;&quot;pg_editor_input_div&quot;},$line_contents);</span>
<span class="preprocessor"></span><span class="preprocessor">                    # print CGI::br();</span>
<span class="preprocessor"></span><span class="preprocessor">                    # print CGI::end_div();</span>
<span class="preprocessor"></span><span class="preprocessor">                # }</span>
<span class="preprocessor"></span><span class="preprocessor">                # $i++;</span>
<span class="preprocessor"></span><span class="preprocessor">            # }</span>
<span class="preprocessor"></span><span class="preprocessor">            # my $checkbox = WeBWorK::CGI_labeled_input(-type=&gt;&quot;checkbox&quot;, -id=&gt;&quot;newWindow&quot;, -label_text=&gt;&quot;Open in new window&quot;, -input_attr=&gt;{-checked=&gt;&quot;checked&quot;, -onchange=&gt;&quot;updateTarget()&quot;});</span>
<span class="preprocessor"></span><span class="preprocessor">            # $checkbox =~ s/\n//; # remove unwanted linebreak</span>
<span class="preprocessor"></span><span class="preprocessor">            # print CGI::div({-class=&gt;&quot;pd_editor_input_div&quot;, -id=&gt;&quot;submit_input_div&quot;}, $checkbox, CGI::br(), WeBWorK::CGI_labeled_input(-type=&gt;&quot;submit&quot;, -id=&gt;&quot;submit_button_id&quot;, -input_attr=&gt;{-name=&gt;&#39;submit&#39;, -value=&gt;&quot;Take Action!&quot;}));</span>
<span class="preprocessor"></span>            
<span class="preprocessor">########################################################COLUMN STYLE END###########################################################################</span>
<span class="preprocessor"></span>

<span class="preprocessor">########################################################TABBER STYLE BEGIN#########################################################################         </span>
<span class="preprocessor"></span>            
            my @divArr = ();
            
            <span class="keywordflow">foreach</span> my $actionID (@formsToShow) {
<span class="preprocessor">                # Check permissions</span>
<span class="preprocessor"></span><span class="preprocessor">                #next if FORM_PERMS()-&gt;{$actionID} and not $authz-&gt;hasPermissions($user, FORM_PERMS()-&gt;{$actionID});</span>
<span class="preprocessor"></span>                my $actionForm = <span class="stringliteral">&quot;${actionID}_form&quot;</span>;
                my $newWindow = ($actionID =~ m/^(view|add_problem|save)$/)? 1: 0;
                my $onChange = <span class="stringliteral">&quot;setRadio($i,$newWindow)&quot;</span>;
                my %actionParams = $self-&gt;getActionParams($actionID);
                my $line_contents = $self-&gt;$actionForm($onChange, %actionParams);
                my $radio_params = {-type=&gt;<span class="stringliteral">&quot;radio&quot;</span>, -name=&gt;<span class="stringliteral">&quot;action&quot;</span>, -value=&gt;$actionID};
                $radio_params-&gt;{checked}=1 <span class="keywordflow">if</span> ($actionID eq $default_choice) ;
                $radio_params-&gt;{onclick} = <span class="stringliteral">&quot;setTarget($newWindow)&quot;</span>;
                $radio_params-&gt;{<span class="keywordtype">id</span>} = <span class="stringliteral">&quot;action$i&quot;</span>;
<span class="preprocessor">                # print CGI::Tr({-valign=&gt;&quot;top&quot;},</span>
<span class="preprocessor"></span><span class="preprocessor">                    # CGI::td({}, CGI::input($radio_params)),</span>
<span class="preprocessor"></span><span class="preprocessor">                    # CGI::td({}, $line_contents)</span>
<span class="preprocessor"></span><span class="preprocessor">                # ) if $line_contents;</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span>($line_contents){
                    my @titleArr = split(<span class="stringliteral">&quot; &quot;</span>, ucfirst(<a class="code" href="classWeBWorK.html#a18bc0de994370e680156ab17e475aec4">WeBWorK::underscore_to_whitespace</a>($actionForm)));
                    my $title = $titleArr[0];
                    push @divArr, join(<span class="stringliteral">&quot;&quot;</span>,
                    CGI::h3($title),
                    CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;pg_editor_input_span&quot;</span>},<a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;radio&quot;</span>, -<span class="keywordtype">id</span>=&gt;$actionForm.<span class="stringliteral">&quot;_id&quot;</span>, -label_text=&gt;ucfirst(<a class="code" href="classWeBWorK.html#a18bc0de994370e680156ab17e475aec4">WeBWorK::underscore_to_whitespace</a>($actionForm)), -input_attr=&gt;$radio_params),CGI::br()),
                    CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;pg_editor_input_div&quot;</span>},$line_contents),
                    CGI::br())
                }
                $i++;
            }
            
            my $divArrRef = \@divArr;
    
            print CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;tabber&quot;</span>},
                CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;tabbertab&quot;</span>},$divArrRef)
            );
            
<span class="preprocessor">###################################################TABBER STYLE END##############################################################################</span>
<span class="preprocessor"></span>            
            my $checkbox = <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;checkbox&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;newWindow&quot;</span>, -label_text=&gt;<span class="stringliteral">&quot;Open in new window&quot;</span>, -input_attr=&gt;{-checked=&gt;<span class="stringliteral">&quot;checked&quot;</span>, -onchange=&gt;<span class="stringliteral">&quot;updateTarget()&quot;</span>});
            $checkbox =~ s/\n<span class="comment">//; # remove unwanted linebreak</span>
            print CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;pd_editor_input_div&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;submit_input_div&quot;</span>}, $checkbox, CGI::br(), <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;submit_button_id&quot;</span>, -input_attr=&gt;{-name=&gt;<span class="stringliteral">&#39;submit&#39;</span>, -value=&gt;<span class="stringliteral">&quot;Take Action!&quot;</span>}));
    
    
    print  CGI::end_form();

    print CGI::script(<span class="stringliteral">&quot;updateTarget()&quot;</span>);
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;


}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2c260324e41d5d4fc2c9a2db93d8876a"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::determineLocalFilePath" ref="a2c260324e41d5d4fc2c9a2db93d8876a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::determineLocalFilePath </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-determineLocalFilePath' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-determineLocalFilePath-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-determineLocalFilePath-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-determineLocalFilePath-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in determineLocalFilePath: 20</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2c260324e41d5d4fc2c9a2db93d8876a">determineLocalFilePath</a> {
    my $self= shift;                die <span class="stringliteral">&quot;determineLocalFilePath is a method&quot;</span> unless ref($self);
    my $path = shift;
    my $default_screen_header_path   = $self-&gt;r-&gt;ce-&gt;{webworkFiles}-&gt;{hardcopySnippets}-&gt;{setHeader}; 
    my $default_hardcopy_header_path = $self-&gt;r-&gt;ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{setHeader};
    my $setID = $self-&gt;{setID};
    $setID = int(rand(1000)) unless $setID =~/\S/;  <span class="preprocessor"># setID can be 0</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ($path =~ /Library/) {
<span class="preprocessor">        #$path =~ s|^.*?Library/||;  # truncate the url up to a segment such as ...rochesterLibrary/.......</span>
<span class="preprocessor"></span>        $path  =~ s|^.*?Library/|local/|;  # truncate the <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad408331e3a459441e5c724646b04c8fb">url</a> up to a segment such as ...rochesterLibrary/....... and prepend local
    } elsif ($path eq $default_screen_header_path) {
        $path = <span class="stringliteral">&quot;set$setID/setHeader.pg&quot;</span>;
    } elsif ($path eq $default_hardcopy_header_path) {
        $path = <span class="stringliteral">&quot;set$setID/hardcopyHeader.tex&quot;</span>;
    } <span class="keywordflow">else</span> { # <span class="keywordflow">if</span> its not in a library we<span class="stringliteral">&#39;ll just save it locally</span>
<span class="stringliteral">        $path = &quot;new_problem_&quot;.int(rand(1000)).&quot;.pg&quot;;   #l hope there aren&#39;</span>t any collisions.
    }
    $path;

}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a8b850b44bcd4a4090664338cd8589a5a"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::determineOriginalEditFilePath" ref="a8b850b44bcd4a4090664338cd8589a5a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::determineOriginalEditFilePath </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-determineOriginalEditFilePath' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-determineOriginalEditFilePath-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-determineOriginalEditFilePath-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-determineOriginalEditFilePath-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in determineOriginalEditFilePath: 32</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a8b850b44bcd4a4090664338cd8589a5a">determineOriginalEditFilePath</a> {  # determine the original path to a file corresponding to a temporary edit file
<span class="preprocessor">                                     # returns path relative to the template directory</span>
<span class="preprocessor"></span>    my $self = shift;
    my $path = shift;
    my $user = $self-&gt;r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
    $self-&gt;addbadmessage(<span class="stringliteral">&quot;Can&#39;t determine user of temporary edit file $path.&quot;</span>) unless defined($user);
    my $templatesDirectory = $self-&gt;r-&gt;ce-&gt;{courseDirs} -&gt;{templates};
    my $tmpEditFileDirectory = $self-&gt;getTempEditFileDirectory();
<span class="preprocessor">    # unless path is absolute assume that it is relative to the template directory</span>
<span class="preprocessor"></span>    my $newpath = $path;
    unless ($path =~ m|^/| ) {
        $newpath = <span class="stringliteral">&quot;$templatesDirectory/$path&quot;</span>;
    }
    <span class="keywordflow">if</span> ($self-&gt;isTempEditFilePath($newpath) ) {
        $newpath =~ s|^$tmpEditFileDirectory/||; # <span class="keyword">delete</span> temp edit directory 
        <span class="keywordflow">if</span> ($newpath =~m|blank\.[^/]*$|) {                     # handle the <span class="keywordflow">case</span> of the blank problem 
            $newpath = $self-&gt;r-&gt;ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{blankProblem};
        } elsif (($newpath =~m|hardcopyHeader\.[^/]*$|)) {     # handle the <span class="keywordflow">case</span> of the hardcopy <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad1905f1621af61ea10def7aae24b7b8b">header</a> in snippets 
            $newpath = $self-&gt;r-&gt;ce-&gt;{webworkFiles}-&gt;{hardcopySnippets}-&gt;{setHeader};
        } elsif (($newpath =~m|screenHeader\.[^/]*$|)) {       # handle the <span class="keywordflow">case</span> of the screen <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad1905f1621af61ea10def7aae24b7b8b">header</a> in snippets
            $newpath = $self-&gt;r-&gt;ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{setHeader};
        } <span class="keywordflow">else</span> {
            $newpath =~ s|\.$user\.tmp$||;           # <span class="keyword">delete</span> suffix
            
        }
<span class="preprocessor">        #$self-&gt;addgoodmessage(&quot;Original file path is $newpath&quot;); #FIXME debug</span>
<span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
        $self-&gt;addbadmessage(<span class="stringliteral">&quot;This path |$newpath| is not the path to a temporary edit file.&quot;</span>);
<span class="preprocessor">        # returns original path</span>
<span class="preprocessor"></span>    }
    $newpath;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ae65daf12893fa707a864beb679053300"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::determineTempEditFilePath" ref="ae65daf12893fa707a864beb679053300" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::determineTempEditFilePath </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-determineTempEditFilePath' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-determineTempEditFilePath-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-determineTempEditFilePath-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-determineTempEditFilePath-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in determineTempEditFilePath: 37</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#ae65daf12893fa707a864beb679053300">determineTempEditFilePath</a> {  # <span class="keyword">this</span> does not create the directories in the path to the file
<span class="preprocessor">                                 # it  returns an absolute path to the file</span>
<span class="preprocessor"></span>    my $self = shift;  die <span class="stringliteral">&quot;determineTempEditFilePath is a method&quot;</span> unless ref($self);
    my $path =shift;    # <span class="keyword">this</span> should be an absolute path to the file
    my $user = $self-&gt;r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
    $user    = int(rand(1000)) unless defined $user;
    my $setID = $self-&gt;{setID} || int(rand(1000));
    my $courseDirectory = $self-&gt;r-&gt;ce-&gt;{courseDirs};
<span class="preprocessor">    ###############</span>
<span class="preprocessor"></span><span class="preprocessor">    # Calculate the location of the temporary file</span>
<span class="preprocessor"></span><span class="preprocessor">    ###############</span>
<span class="preprocessor"></span>    my $templatesDirectory           = $courseDirectory-&gt;{templates};
    my $blank_file_path              = $self-&gt;r-&gt;ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{blankProblem};
    my $default_screen_header_path   = $self-&gt;r-&gt;ce-&gt;{webworkFiles}-&gt;{hardcopySnippets}-&gt;{setHeader}; 
    my $default_hardcopy_header_path = $self-&gt;r-&gt;ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{setHeader};
    my $tmpEditFileDirectory = $self-&gt;getTempEditFileDirectory();
    $self-&gt;addbadmessage(<span class="stringliteral">&quot;The path to the original file should be absolute&quot;</span>) unless $path =~m|^/|;  # debug
    <span class="keywordflow">if</span> ($path =~/^$tmpEditFileDirectory/) {
        $self-&gt;addbadmessage(<span class="stringliteral">&quot;Error: This path is already in the temporary edit directory -- no new temporary file is created. path = $path&quot;</span>);
    
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">if</span> ($path =~ /^$templatesDirectory/ ) {
            $path =~ s|^$templatesDirectory||;
            $path =~ s|^/||;   # <span class="keyword">remove</span> the initial slash <span class="keywordflow">if</span> any
            $path = <span class="stringliteral">&quot;$tmpEditFileDirectory/$path.$user.tmp&quot;</span>;
        } elsif ($path eq $blank_file_path) {
            $path = <span class="stringliteral">&quot;$tmpEditFileDirectory/blank.$setID.$user.tmp&quot;</span>;  # handle the <span class="keywordflow">case</span> of the blank problem
        } elsif ($path eq $default_screen_header_path) {
            $path = <span class="stringliteral">&quot;$tmpEditFileDirectory/screenHeader.$setID.$user.tmp&quot;</span>;  # handle the <span class="keywordflow">case</span> of the screen <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad1905f1621af61ea10def7aae24b7b8b">header</a> in snippets 
        } elsif ($path eq $default_hardcopy_header_path) {
            $path = <span class="stringliteral">&quot;$tmpEditFileDirectory/hardcopyHeader.$setID.$user.tmp&quot;</span>;  # handle the <span class="keywordflow">case</span> of the hardcopy <a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad1905f1621af61ea10def7aae24b7b8b">header</a> in snippets 
        } <span class="keywordflow">else</span> {
            die <span class="stringliteral">&quot;determineTempEditFilePath should only be used on paths within the templates directory, not on $path&quot;</span>;
        }
    }
    $path;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ace9ad8ee32d78fc044edc35d75defdfd"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::fixProblemContents" ref="ace9ad8ee32d78fc044edc35d75defdfd" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::fixProblemContents </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-fixProblemContents' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-fixProblemContents-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-fixProblemContents-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-fixProblemContents-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in fixProblemContents: 10</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#ace9ad8ee32d78fc044edc35d75defdfd">fixProblemContents</a> {
<span class="preprocessor">        #NOT a method</span>
<span class="preprocessor"></span>        my $problemContents = shift;
<span class="preprocessor">        # Handle the problem of line endings.  </span>
<span class="preprocessor"></span><span class="preprocessor">        # Make sure that all of the line endings are of unix type.  </span>
<span class="preprocessor"></span><span class="preprocessor">        # Convert \r\n to \n</span>
<span class="preprocessor"></span>        $problemContents =~ s/\<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a>\n/\n/g;
        $problemContents =~ s/\<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a>/\n/g;
        $problemContents;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a4a3487ac6022901ee8c5610d3b3c6a68"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::fresh_edit_handler" ref="a4a3487ac6022901ee8c5610d3b3c6a68" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::fresh_edit_handler </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-fresh_edit_handler' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-fresh_edit_handler-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-fresh_edit_handler-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-fresh_edit_handler-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in fresh_edit_handler: 4</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a4a3487ac6022901ee8c5610d3b3c6a68">fresh_edit_handler</a> {
    my ($self, $genericParams, $actionParams, $tableParams) = @_;
<span class="preprocessor">    #$self-&gt;addgoodmessage(&quot;fresh_edit_handler called&quot;);</span>
<span class="preprocessor">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a25ea344aa463666f0a943be46c72141b"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::getActionParams" ref="a25ea344aa463666f0a943be46c72141b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::getActionParams </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-getActionParams' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-getActionParams-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-getActionParams-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-getActionParams-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in getActionParams: 11</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a25ea344aa463666f0a943be46c72141b">getActionParams</a> {
    my ($self, $actionID) = @_;
    my $r = $self-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a>};
    
    my %actionParams=();
    <span class="keywordflow">foreach</span> my $param ($r-&gt;param) {
        next unless $param =~ m/^action\.$actionID\./;
        $actionParams{$param} = [ $r-&gt;param($param) ];
    }
    <span class="keywordflow">return</span> %actionParams;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a5f417ad7794fa8ba7e38d57594230899"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::getFilePaths" ref="a5f417ad7794fa8ba7e38d57594230899" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::getFilePaths </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-getFilePaths' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-getFilePaths-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-getFilePaths-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-getFilePaths-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in getFilePaths: 168</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a5f417ad7794fa8ba7e38d57594230899">getFilePaths</a> {
    my ($self, $setName, $problemNumber, $file_type) = @_;
    my $r = $self-&gt;r;
    my $ce = $r-&gt;ce;
    my $db = $r-&gt;db;
    my $urlpath = $r-&gt;urlpath;
    my $courseName = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
    my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
    my $effectiveUserName = $r-&gt;param(<span class="stringliteral">&#39;effectiveUser&#39;</span>);
    
    $setName = <span class="stringliteral">&#39;&#39;</span> unless defined $setName;
    $problemNumber = <span class="stringliteral">&#39;&#39;</span> unless defined $problemNumber;

<span class="preprocessor">    # parse possibly versioned set names</span>
<span class="preprocessor"></span>    my $fullSetName = $setName;
    my $editSetVersion = 0;
    <span class="keywordflow">if</span> ( $setName =~ /,v(\d)+$/ ) {
        $editSetVersion = $1;
        $setName =~ s/,v\d+$<span class="comment">//;</span>
    }

    die <span class="stringliteral">&#39;Internal error to PGProblemEditor2 -- file type is not defined&#39;</span>  unless defined $file_type;
<span class="preprocessor">    #$self-&gt;addgoodmessage(&quot;file type is $file_type&quot;);  #FIXME remove</span>
<span class="preprocessor"></span><span class="preprocessor">    ##########################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Determine path to the input file to be edited. </span>
<span class="preprocessor"></span><span class="preprocessor">    #   The permanent path of the input file  == $editFilePath </span>
<span class="preprocessor"></span><span class="preprocessor">    #   A temporary path to the input file    == $tempFilePath</span>
<span class="preprocessor"></span><span class="preprocessor">    ##########################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Relevant parameters</span>
<span class="preprocessor"></span><span class="preprocessor">    #     $r-&gt;param(&quot;displayMode&quot;)</span>
<span class="preprocessor"></span><span class="preprocessor">    #     $r-&gt;param(&#39;problemSeed&#39;)</span>
<span class="preprocessor"></span><span class="preprocessor">    #     $r-&gt;param(&#39;submit&#39;)</span>
<span class="preprocessor"></span><span class="preprocessor">    #     $r-&gt;param(&#39;make_local_copy&#39;)</span>
<span class="preprocessor"></span><span class="preprocessor">    #     $r-&gt;param(&#39;sourceFilePath&#39;)</span>
<span class="preprocessor"></span><span class="preprocessor">    #     $r-&gt;param(&#39;problemContents&#39;)</span>
<span class="preprocessor"></span><span class="preprocessor">    #     $r-&gt;param(&#39;save_to_new_file&#39;)</span>
<span class="preprocessor"></span><span class="preprocessor">    ##########################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Define the following  variables</span>
<span class="preprocessor"></span><span class="preprocessor">    #       path to regular file -- $editFilePath;</span>
<span class="preprocessor"></span><span class="preprocessor">    #       path to file being read (temporary or permanent)    </span>
<span class="preprocessor"></span><span class="preprocessor">    #       contents of the file being read  --- $problemContents   </span>
<span class="preprocessor"></span><span class="preprocessor">    #       $self-&gt;{r_problemContents}        =   \$problemContents;</span>
<span class="preprocessor"></span><span class="preprocessor">    ###########################################################################</span>
<span class="preprocessor"></span>
    my $editFilePath = $ce-&gt;{courseDirs}-&gt;{templates};
    
<span class="preprocessor">    ##########################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Determine path to regular file, place it in $editFilePath</span>
<span class="preprocessor"></span><span class="preprocessor">    # problemSeed is defined for the file_type = &#39;problem&#39; and &#39;source_path_to_problem&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">    ##########################################################################</span>
<span class="preprocessor"></span>    CASE: 
    {
        ($file_type eq <span class="stringliteral">&#39;course_info&#39;</span>) and <span class="keywordflow">do</span> {
<span class="preprocessor">            # we are editing the course_info file</span>
<span class="preprocessor"></span><span class="preprocessor">            # value of courseFiles::course_info is relative to templates directory</span>
<span class="preprocessor"></span>            $editFilePath           .= <span class="charliteral">&#39;/&#39;</span> . $ce-&gt;{courseFiles}-&gt;{course_info};
            last CASE;
        };
        
        ($file_type eq <span class="stringliteral">&#39;options_info&#39;</span>) and <span class="keywordflow">do</span> {
<span class="preprocessor">            # we are editing the options_info file</span>
<span class="preprocessor"></span><span class="preprocessor">            # value of courseFiles::options_info is relative to templates directory</span>
<span class="preprocessor"></span>            $editFilePath           .= <span class="charliteral">&#39;/&#39;</span> . $ce-&gt;{courseFiles}-&gt;{options_info};
            last CASE;
        };
        
        ($file_type eq <span class="stringliteral">&#39;blank_problem&#39;</span>) and <span class="keywordflow">do</span> {
            $editFilePath = $ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{blankProblem};
            $self-&gt;addbadmessage(<span class="stringliteral">&quot;This is a blank problem template file and can not be edited directly. &quot;</span>
                                 .<span class="stringliteral">&quot;Use the &#39;Save as&#39; action below to create a local copy of the file and add it to the current problem set.&quot;</span>
            );
            last CASE;
        };
        
        ($file_type eq <span class="stringliteral">&#39;set_header&#39;</span> or $file_type eq <span class="stringliteral">&#39;hardcopy_header&#39;</span>) and <span class="keywordflow">do</span> {
<span class="preprocessor">            # first try getting the merged set for the effective user</span>
<span class="preprocessor"></span><span class="preprocessor">            # FIXME merged set is overwritten immediately with global value... WTF? --sam</span>
<span class="preprocessor"></span>            my $set_record = $db-&gt;getMergedSet($effectiveUserName, $setName); # checked
<span class="preprocessor">            # if that doesn&#39;t work (the set is not yet assigned), get the global record</span>
<span class="preprocessor"></span>            $set_record = $db-&gt;getGlobalSet($setName); # checked
<span class="preprocessor">            # bail if no set is found</span>
<span class="preprocessor"></span>            die <span class="stringliteral">&quot;Cannot find a set record for set $setName&quot;</span> unless defined($set_record);
                
            my $header_file = <span class="stringliteral">&quot;&quot;</span>;
            $header_file = $set_record-&gt;{$file_type};
            <span class="keywordflow">if</span> ($header_file &amp;&amp; $header_file ne <span class="stringliteral">&quot;&quot;</span> &amp;&amp; $header_file ne <span class="stringliteral">&quot;defaultHeader&quot;</span>) {
                    <span class="keywordflow">if</span> ( $header_file =~ m|^/| ) { # <span class="keywordflow">if</span> absolute address
                        $editFilePath  = $header_file;
                    } <span class="keywordflow">else</span> {
                        $editFilePath .= <span class="charliteral">&#39;/&#39;</span> . $header_file;
                    }
            } <span class="keywordflow">else</span> {
<span class="preprocessor">                    # if the set record doesn&#39;t specify the filename for a header</span>
<span class="preprocessor"></span><span class="preprocessor">                    # then the set uses the default from snippets</span>
<span class="preprocessor"></span>        
                        $editFilePath = $ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{setHeader} <span class="keywordflow">if</span> $file_type eq <span class="stringliteral">&#39;set_header&#39;</span>;
                        $editFilePath = $ce-&gt;{webworkFiles}-&gt;{hardcopySnippets}-&gt;{setHeader} <span class="keywordflow">if</span> $file_type eq <span class="stringliteral">&#39;hardcopy_header&#39;</span>;

<span class="preprocessor">#                       $self-&gt;addbadmessage(&quot;&#39;&quot;.$self-&gt;shortPath($editFilePath).&quot;&#39; is the default header file and cannot be edited directly.&quot;.CGI::br().&quot;Any changes you make will have to be saved as another file.&quot;);</span>
<span class="preprocessor"></span><span class="preprocessor">                    #}</span>
<span class="preprocessor"></span>
            }
            last CASE;
        }; #end <span class="stringliteral">&#39;set_header, hardcopy_header&#39;</span> <span class="keywordflow">case</span>
        
        ($file_type eq <span class="stringliteral">&#39;problem&#39;</span>) and <span class="keywordflow">do</span> {          
        
<span class="preprocessor">            # first try getting the merged problem for the effective user</span>
<span class="preprocessor"></span>            my $problem_record;
            <span class="keywordflow">if</span> ( $editSetVersion ) {
                $problem_record = $db-&gt;getMergedProblemVersion($effectiveUserName, $setName, $editSetVersion, $problemNumber); # checked
            } <span class="keywordflow">else</span> {
                $problem_record = $db-&gt;getMergedProblem($effectiveUserName, $setName, $problemNumber); # checked
            }
            
<span class="preprocessor">            # if that doesn&#39;t work (the problem is not yet assigned), get the global record</span>
<span class="preprocessor"></span>            $problem_record = $db-&gt;getGlobalProblem($setName, $problemNumber) unless defined($problem_record); # checked
<span class="preprocessor">            # bail if no source path for the problem is found ;</span>
<span class="preprocessor"></span>            die <span class="stringliteral">&quot;Cannot find a problem record for set $setName / problem $problemNumber&quot;</span> unless defined($problem_record);
            $editFilePath .= <span class="charliteral">&#39;/&#39;</span> . $problem_record-&gt;source_file;
<span class="preprocessor">            # define the problem seed for later use</span>
<span class="preprocessor"></span>            $self-&gt;{problemSeed}= $problem_record-&gt;problem_seed <span class="keywordflow">if</span>  defined($problem_record) and  $problem_record-&gt;can(&#39;problem_seed&#39;) ;  
            last CASE;
        };  <span class="preprocessor"># end &#39;problem&#39; case</span>
<span class="preprocessor"></span>        
        ($file_type eq <span class="stringliteral">&#39;source_path_for_problem_file&#39;</span>) and <span class="keywordflow">do</span> {
          my $forcedSourceFile = $self-&gt;{sourceFilePath};
<span class="preprocessor">          # if the source file is in the temporary edit directory find the original source file</span>
<span class="preprocessor"></span><span class="preprocessor">          # the source file is relative to the templates directory.</span>
<span class="preprocessor"></span>          <span class="keywordflow">if</span> ($self-&gt;isTempEditFilePath($forcedSourceFile) ) {
              $forcedSourceFile   = $self-&gt;determineOriginalEditFilePath($forcedSourceFile);     # original file path
              $self-&gt;addgoodmessage(<span class="stringliteral">&quot;the original path to the file is $forcedSourceFile&quot;</span>);  #FIXME debug
          }
<span class="preprocessor">          # bail if no source path for the problem is found ;</span>
<span class="preprocessor"></span>          die <span class="stringliteral">&quot;Cannot find a file path to save to&quot;</span> unless( not_blank($forcedSourceFile)   );
          $self-&gt;{problemSeed} = DEFAULT_SEED();
          $editFilePath .= <span class="charliteral">&#39;/&#39;</span> . $forcedSourceFile;
          last CASE;
        }; # end <span class="stringliteral">&#39;source_path_for_problem_file&#39;</span> <span class="keywordflow">case</span>
    }  # end CASE: statement

    
<span class="preprocessor">    # if a set record or problem record contains an empty blank for a header or problem source_file</span>
<span class="preprocessor"></span><span class="preprocessor">    # we could find ourselves trying to edit /blah/templates/.toenail.tmp or something similar</span>
<span class="preprocessor"></span><span class="preprocessor">    # which is almost undoubtedly NOT desirable</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> (-d $editFilePath) {
        my $msg = <span class="stringliteral">&quot;The file &#39;&quot;</span>.$self-&gt;shortPath($editFilePath).<span class="stringliteral">&quot;&#39; is a directory!&quot;</span>;
        $self-&gt;{failure} = 1;
        $self-&gt;addbadmessage($msg);
    }
    <span class="keywordflow">if</span> (-e $editFilePath and not -<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a> $editFilePath) {   #it<span class="stringliteral">&#39;s ok if the file doesn&#39;</span>t exist, perhaps we<span class="stringliteral">&#39;re going to create it</span>
<span class="stringliteral">                                                      # with save as</span>
<span class="stringliteral">        my $msg = &quot;The file &#39;</span><span class="stringliteral">&quot;.$self-&gt;shortPath($editFilePath).&quot;</span><span class="stringliteral">&#39; cannot be read!&quot;;</span>
<span class="stringliteral">        $self-&gt;{failure} = 1;</span>
<span class="stringliteral">        $self-&gt;addbadmessage($msg); </span>
<span class="stringliteral">    }</span>
<span class="stringliteral">    #################################################</span>
<span class="stringliteral">    # The path to the permanent file is now verified and stored in $editFilePath</span>
<span class="stringliteral">    # Whew!!!</span>
<span class="stringliteral">    #################################################</span>
<span class="stringliteral">    </span>
<span class="stringliteral">    my $tempFilePath = $self-&gt;determineTempEditFilePath($editFilePath);  #&quot;$editFilePath.$TEMPFILESUFFIX&quot;;</span>
<span class="stringliteral">    $self-&gt;{editFilePath}   = $editFilePath;</span>
<span class="stringliteral">    $self-&gt;{tempFilePath}   = $tempFilePath;</span>
<span class="stringliteral">    $self-&gt;{inputFilePath}  = (-r $tempFilePath) ? $tempFilePath : $editFilePath;</span>
<span class="stringliteral">    #warn &quot;editfile path is $editFilePath and tempFile is $tempFilePath and inputFilePath is &quot;. $self-&gt;{inputFilePath};</span>
<span class="stringliteral">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a106d602baf5e6b0bdd251c41b4d53cdd"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::getRelativeSourceFilePath" ref="a106d602baf5e6b0bdd251c41b4d53cdd" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::getRelativeSourceFilePath </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-getRelativeSourceFilePath' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-getRelativeSourceFilePath-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-getRelativeSourceFilePath-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-getRelativeSourceFilePath-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in getRelativeSourceFilePath: 8</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a106d602baf5e6b0bdd251c41b4d53cdd">getRelativeSourceFilePath</a> {
    my ($self, $sourceFilePath) = @_;
    
    my $templatesDir = $self-&gt;r-&gt;ce-&gt;{courseDirs}-&gt;{templates};
    $sourceFilePath =~ s|^$templatesDir<span class="comment">/*||; # remove templates path and any slashes that follow</span>
<span class="comment">    </span>
<span class="comment">    return $sourceFilePath;</span>
<span class="comment">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a5910c09b0977cf22be2365409ea7ca08"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::getTempEditFileDirectory" ref="a5910c09b0977cf22be2365409ea7ca08" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::getTempEditFileDirectory </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-getTempEditFileDirectory' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-getTempEditFileDirectory-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-getTempEditFileDirectory-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-getTempEditFileDirectory-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in getTempEditFileDirectory: 7</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a5910c09b0977cf22be2365409ea7ca08">getTempEditFileDirectory</a> {
    my $self = shift;
    my $courseDirectory       = $self-&gt;r-&gt;ce-&gt;{courseDirs};
    my $templatesDirectory    = $courseDirectory-&gt;{templates};
    my $tmpEditFileDirectory  = (defined ($courseDirectory-&gt;{tmpEditFileDir}) ) ? $courseDirectory-&gt;{tmpEditFileDir} : <span class="stringliteral">&quot;$templatesDirectory/tmpEdit&quot;</span>;
    $tmpEditFileDirectory;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a39ca2e1108a6added2cb5b6af94e189e"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::initialize" ref="a39ca2e1108a6added2cb5b6af94e189e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::initialize </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-initialize' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-initialize-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-initialize-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-initialize-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in initialize: 31</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a39ca2e1108a6added2cb5b6af94e189e">initialize</a>  {
    my ($self) = @_;
    my $r = $self-&gt;r;
    my $authz = $r-&gt;authz;
    my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
    
<span class="preprocessor">    # Check permissions</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> unless ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>));
    <span class="keywordflow">return</span> unless ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>));
    
    my $file_type       = $r-&gt;param(<span class="stringliteral">&#39;file_type&#39;</span>) || <span class="stringliteral">&quot;&quot;</span>;
    my $tempFilePath    = $self-&gt;{tempFilePath}; # path to the file currently being worked with (might be a .tmp file)
    my $inputFilePath   = $self-&gt;{inputFilePath};   # path to the file <span class="keywordflow">for</span> input, (might be a .tmp file)
    
    $self-&gt;addmessage($r-&gt;param(<span class="stringliteral">&#39;status_message&#39;</span>) ||<span class="stringliteral">&#39;&#39;</span>);  # record status messages carried over <span class="keywordflow">if</span> <span class="keyword">this</span> is a redirect
    $self-&gt;addbadmessage(<span class="stringliteral">&quot;Changes in this file have not yet been permanently saved.&quot;</span>) <span class="keywordflow">if</span> -<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a> $tempFilePath;
    <span class="keywordflow">if</span> ( not( -e $inputFilePath) ) {
        $self-&gt;addbadmessage(<span class="stringliteral">&quot;The file &#39;&quot;</span>.$self-&gt;shortPath($inputFilePath).<span class="stringliteral">&quot;&#39; cannot be found.&quot;</span>);
    } elsif ((not -w $inputFilePath) &amp;&amp; $file_type ne <span class="stringliteral">&#39;blank_problem&#39;</span> ) {

        $self-&gt;addbadmessage(<span class="stringliteral">&quot;The file &#39;&quot;</span>.$self-&gt;shortPath($inputFilePath).<span class="stringliteral">&quot;&#39; is protected! &quot;</span>.CGI::br().
        <span class="stringliteral">&quot;To edit this text you must first make a copy of this file using the &#39;Save as&#39; action below.&quot;</span>);

    }
    <span class="keywordflow">if</span> ($inputFilePath =~/$BLANKPROBLEM$/ &amp;&amp; $file_type ne <span class="stringliteral">&#39;blank_problem&#39;</span>) {
<span class="preprocessor">#       $self-&gt;addbadmessage(&quot;This file &#39;$inputFilePath&#39; is a blank problem! &quot;.CGI::br().&quot;To edit this text you must  </span>
<span class="preprocessor"></span>        $self-&gt;addbadmessage(<span class="stringliteral">&quot;The file &#39;&quot;</span>.$self-&gt;shortPath($inputFilePath).<span class="stringliteral">&quot;&#39; is a blank problem! &quot;</span>.CGI::br().<span class="stringliteral">&quot;To edit this text you must  </span>
<span class="stringliteral">                           use the &#39;Save AS&#39; action below to save it to another file.&quot;</span>);
    }
    
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aa5272e56eb36e37e794af9cfdc5acc61"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::isTempEditFilePath" ref="aa5272e56eb36e37e794af9cfdc5acc61" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::isTempEditFilePath </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-isTempEditFilePath' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-isTempEditFilePath-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-isTempEditFilePath-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-isTempEditFilePath-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in isTempEditFilePath: 12</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#aa5272e56eb36e37e794af9cfdc5acc61">isTempEditFilePath</a>  {
    my $self = shift;
    my $path = shift;
    my $templatesDirectory = $self-&gt;r-&gt;ce-&gt;{courseDirs} -&gt;{templates};
<span class="preprocessor">    # unless path is absolute assume that it is relative to the template directory</span>
<span class="preprocessor"></span>    unless ($path =~ m|^/| ) {
        $path = <span class="stringliteral">&quot;$templatesDirectory/$path&quot;</span>;
    }
    my $tmpEditFileDirectory = $self-&gt;getTempEditFileDirectory();

    ($path =~/^$tmpEditFileDirectory/) ? 1: 0;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="adbf8e96ef1d246b231d64dc82035b674"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::output_JS" ref="adbf8e96ef1d246b231d64dc82035b674" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::output_JS </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-output_JS' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-output_JS-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-output_JS-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-output_JS-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in output_JS: 11</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#adbf8e96ef1d246b231d64dc82035b674">output_JS</a>{
    my $self = shift;
    my $r = $self-&gt;r;
    my $ce = $r-&gt;ce;

    my $site_url = $ce-&gt;{webworkURLs}-&gt;{htdocs};
    print CGI::start_script({type=&gt;<span class="stringliteral">&quot;text/javascript&quot;</span>, src=&gt;<span class="stringliteral">&quot;$site_url/js/addOnLoadEvent.js&quot;</span>}), CGI::end_script();
    print CGI::start_script({type=&gt;<span class="stringliteral">&quot;text/javascript&quot;</span>, src=&gt;<span class="stringliteral">&quot;$site_url/js/tabber.js&quot;</span>}), CGI::end_script();
    
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a193df41426478b834556f8ed9885dfd5"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::output_tabber_CSS" ref="a193df41426478b834556f8ed9885dfd5" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::output_tabber_CSS </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-output_tabber_CSS' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-output_tabber_CSS-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-output_tabber_CSS-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-output_tabber_CSS-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in output_tabber_CSS: 3</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a193df41426478b834556f8ed9885dfd5">output_tabber_CSS</a>{
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a05371de252fbae39cc0bf36b9aae4f54"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::path" ref="a05371de252fbae39cc0bf36b9aae4f54" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::path </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-path' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-path-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-path-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-path-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in path: 23</span>
<span class="preprocessor"></span>sub path {
    my ($self, $args) = @_;
    my $r = $self-&gt;r;
    my $urlpath = $r-&gt;urlpath;
    my $courseName  = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
    my $setName = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>) || <span class="stringliteral">&#39;&#39;</span>;
    my $problemNumber = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;problemID&quot;</span>) || <span class="stringliteral">&#39;&#39;</span>;

<span class="preprocessor">    # we need to build a path to the problem being edited by hand, since it is not the same as the urlpath</span>
<span class="preprocessor"></span><span class="preprocessor">    # For this page the bread crum path leads back to the problem being edited, not to the Instructor tool.</span>
<span class="preprocessor"></span>    my @path = ( <span class="stringliteral">&#39;WeBWork&#39;</span>, $r-&gt;location,
              <span class="stringliteral">&quot;$courseName&quot;</span>, $r-&gt;location.<span class="stringliteral">&quot;/$courseName&quot;</span>,
              <span class="stringliteral">&quot;$setName&quot;</span>,    $r-&gt;location.<span class="stringliteral">&quot;/$courseName/$setName&quot;</span>,
              <span class="stringliteral">&quot;$problemNumber&quot;</span>, $r-&gt;location.<span class="stringliteral">&quot;/$courseName/$setName/$problemNumber&quot;</span>,
              <span class="stringliteral">&quot;Editor&quot;</span>, <span class="stringliteral">&quot;&quot;</span>
    );
    
<span class="preprocessor">    #print &quot;\n&lt;!-- BEGIN &quot; . __PACKAGE__ . &quot;::path --&gt;\n&quot;;</span>
<span class="preprocessor"></span>    print $self-&gt;pathMacro($args, @path);
<span class="preprocessor">    #print &quot;&lt;!-- END &quot; . __PACKAGE__ . &quot;::path --&gt;\n&quot;;</span>
<span class="preprocessor"></span>    
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1ContentGenerator.html#a0d6e37ff9d1e8ad720dc4ed5f63fa773">WeBWorK::ContentGenerator</a>.</p>

</div>
</div>
<a class="anchor" id="a2aae0e640103dd76c965844a310fbd38"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::pre_header_initialize" ref="a2aae0e640103dd76c965844a310fbd38" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::pre_header_initialize </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-pre_header_initialize' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-pre_header_initialize-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-pre_header_initialize-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-pre_header_initialize-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in pre_header_initialize: 219</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2aae0e640103dd76c965844a310fbd38">pre_header_initialize</a> {
    my ($self)         = @_;
    my $r              = $self-&gt;r;
    my $ce             = $r-&gt;ce;
    my $urlpath        = $r-&gt;urlpath;
    my $authz          = $r-&gt;authz;
    my $user           = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
    $self-&gt;{courseID}   = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
    $self-&gt;{setID}      = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>) ;  # <span class="keyword">using</span> $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>)  ||<span class="stringliteral">&#39;&#39;</span> causes trouble with <span class="keyword">set</span> 0!!!
    $self-&gt;{problemID}  = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;problemID&quot;</span>);

<span class="preprocessor">    # parse setID, which may come in with version data</span>
<span class="preprocessor"></span>    
    my $fullSetID = $self-&gt;{setID};
    <span class="keywordflow">if</span> (defined($fullSetID) ) {
        
        <span class="keywordflow">if</span> ( $fullSetID =~ /,v(\d+)$/ ) {
            $self-&gt;{versionID} = $1;
            $self-&gt;{setID} =~ s/,v\d+$<span class="comment">//;</span>
        }
        $self-&gt;{fullSetID} = $fullSetID;
    }
    my $submit_button   = $r-&gt;param(<span class="stringliteral">&#39;submit&#39;</span>);  # obtain submit command from form
    my $actionID        = $r-&gt;param(<span class="stringliteral">&#39;action&#39;</span>);
    my $file_type       = $r-&gt;param(<span class="stringliteral">&quot;file_type&quot;</span>) || <span class="stringliteral">&#39;&#39;</span>;
    my $setName         = $self-&gt;{setID};
    my $versionedSetName = $self-&gt;{fullSetID};
    my $problemNumber   = $self-&gt;{problemID};

<span class="preprocessor">    # Check permissions</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> unless ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>));
    <span class="keywordflow">return</span> unless ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>));

<span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # displayMode   and problemSeed</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    # Determine the display mode</span>
<span class="preprocessor"></span><span class="preprocessor">    # If $self-&gt;{problemSeed} was obtained within saveFileChanges from the problem_record</span>
<span class="preprocessor"></span><span class="preprocessor">    # then it can be overridden by the value obtained from the form.</span>
<span class="preprocessor"></span><span class="preprocessor">    # Insure that $self-&gt;{problemSeed} has some non-empty value</span>
<span class="preprocessor"></span><span class="preprocessor">    # displayMode and problemSeed </span>
<span class="preprocessor"></span><span class="preprocessor">    # will be needed for viewing the problem via redirect.</span>
<span class="preprocessor"></span><span class="preprocessor">    # They are also two of the parameters which can be set by the editor</span>
<span class="preprocessor"></span><span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span>    
    <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&#39;displayMode&#39;</span>)) {
        $self-&gt;{displayMode} = $r-&gt;param(<span class="stringliteral">&#39;displayMode&#39;</span>);
    } <span class="keywordflow">else</span> {
        $self-&gt;{displayMode} = $ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};
    }
    
<span class="preprocessor">    # form version of problemSeed overrides version obtained from the the problem_record</span>
<span class="preprocessor"></span><span class="preprocessor">    # inside saveFileChanges</span>
<span class="preprocessor"></span>    $self-&gt;{problemSeed} = $r-&gt;param(<span class="stringliteral">&#39;problemSeed&#39;</span>) <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&#39;problemSeed&#39;</span>));  
<span class="preprocessor">    # Make sure that the problem seed has some value</span>
<span class="preprocessor"></span>    $self-&gt;{problemSeed} = DEFAULT_SEED() unless not_blank($self-&gt;{problemSeed});
    
<span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Save file to permanent or temporary file, then redirect for viewing</span>
<span class="preprocessor"></span><span class="preprocessor">    #############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    #  Any file &quot;saved as&quot; should be assigned to &quot;Undefined_Set&quot; and redirectoed to be viewed again in the editor</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    #  Problems &quot;saved&quot; or &#39;refreshed&#39; are to be redirected to the Problem.pm module</span>
<span class="preprocessor"></span><span class="preprocessor">    #  Set headers which are &quot;saved&quot; are to be redirected to the ProblemSet.pm page</span>
<span class="preprocessor"></span><span class="preprocessor">    #  Hardcopy headers which are &quot;saved&quot; are also to be redirected to the ProblemSet.pm page</span>
<span class="preprocessor"></span><span class="preprocessor">    #  Course_info files are redirected to the ProblemSets.pm page</span>
<span class="preprocessor"></span><span class="preprocessor">    #  Options_info files are redirected to the Options.pm page</span>
<span class="preprocessor"></span><span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span>    


<span class="preprocessor">    ######################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Insure that file_type is defined</span>
<span class="preprocessor"></span><span class="preprocessor">    ######################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # We have already read in the file_type parameter from the form</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    # If this has not been defined we are  dealing with a set header</span>
<span class="preprocessor"></span><span class="preprocessor">    # or regular problem</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( not_blank($file_type) ) { #file_type is defined and is not blank
<span class="preprocessor">        # file type is already defined -- do nothing</span>
<span class="preprocessor"></span><span class="preprocessor">        #warn &quot;file type already defined as $file_type&quot;  #FIXME debug</span>
<span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
<span class="preprocessor">        # if &quot;sourceFilePath&quot; is defined in the form, then we are getting the path directly.</span>
<span class="preprocessor"></span><span class="preprocessor">        # if the problem number is defined and is 0</span>
<span class="preprocessor"></span><span class="preprocessor">        # then we are dealing with some kind of </span>
<span class="preprocessor"></span><span class="preprocessor">        # header file.  The default is &#39;set_header&#39; which prints properly</span>
<span class="preprocessor"></span><span class="preprocessor">        # to the screen.</span>
<span class="preprocessor"></span><span class="preprocessor">        # If the problem number is not zero, we are dealing with a real problem</span>
<span class="preprocessor"></span><span class="preprocessor">        ######################################</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( not_blank($r-&gt;param(<span class="stringliteral">&#39;sourceFilePath&#39;</span>) )  ) {
            $file_type =<span class="stringliteral">&#39;source_path_for_problem_file&#39;</span>;
            $file_type = <span class="stringliteral">&#39;set_header&#39;</span> <span class="keywordflow">if</span> $r-&gt;param(<span class="stringliteral">&#39;sourceFilePath&#39;</span>) =~ m!/headers/|Header\.pg$!; #FIXME <span class="keyword">this</span> need to be cleaned up
        } elsif ( defined($problemNumber) ) {
             <span class="keywordflow">if</span> ( $problemNumber =~/^\d+$/ and $problemNumber == 0 ) {  # <span class="keywordflow">if</span> problem number is numeric and zero
                $file_type = <span class="stringliteral">&#39;set_header&#39;</span> unless  $file_type eq <span class="stringliteral">&#39;set_header&#39;</span> 
                                               or $file_type eq <span class="stringliteral">&#39;hardcopy_header&#39;</span>;                                    
             } <span class="keywordflow">else</span> {
                $file_type = <span class="stringliteral">&#39;problem&#39;</span>;    
<span class="preprocessor">                #warn &quot;setting file type to &#39;problem&#39;\n&quot;;  #FIXME debug</span>
<span class="preprocessor"></span>             }
                       
        }
    }
    die <span class="stringliteral">&quot;The file_type variable |$file_type| has not been defined or is blank.&quot;</span> unless not_blank($file_type);
<span class="preprocessor">    # clean up sourceFilePath, just in case</span>
<span class="preprocessor"></span><span class="preprocessor">    # double check that sourceFilePath is relative to the templates file</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ($file_type eq <span class="stringliteral">&#39;source_path_for_problem_file&#39;</span> ) {    
        my $templatesDirectory = $ce-&gt;{courseDirs}-&gt;{templates};
        my $sourceFilePath = $r-&gt;param(<span class="stringliteral">&#39;sourceFilePath&#39;</span>);
        $sourceFilePath =~ s/$templatesDirectory<span class="comment">//;</span>
        $sourceFilePath =~ s|^/||;  # <span class="keyword">remove</span> intial /
        $self-&gt;{sourceFilePath} = $sourceFilePath;  
    }
    $self-&gt;{file_type} = $file_type;
<span class="preprocessor">    # $self-&gt;addgoodmessage(&quot;file type is $file_type&quot;);  #FIXME debug</span>
<span class="preprocessor"></span><span class="preprocessor">    # warn &quot;file type is $file_type\n parameter is &quot;.$self-&gt;r-&gt;param(&quot;file_type&quot;);</span>
<span class="preprocessor"></span><span class="preprocessor">    ##########################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # File type is one of:     blank_problem course_info options_info problem set_header hardcopy_header source_path_for_problem_file  </span>
<span class="preprocessor"></span><span class="preprocessor">    ##########################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    # Determine the path to the file</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    ###########################################</span>
<span class="preprocessor"></span>        $self-&gt;getFilePaths($versionedSetName, $problemNumber, $file_type);
<span class="preprocessor">        #defines $self-&gt;{editFilePath}   # path to the permanent file to be edited</span>
<span class="preprocessor"></span><span class="preprocessor">        #        $self-&gt;{tempFilePath}   # path to the permanent file to be edited  has .tmp suffix</span>
<span class="preprocessor"></span><span class="preprocessor">        #        $self-&gt;{inputFilePath}  # path to the file for input, (might be a .tmp file)</span>
<span class="preprocessor"></span>        
        
        
<span class="preprocessor">    ##########################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Default problem contents</span>
<span class="preprocessor"></span><span class="preprocessor">    ##########################################</span>
<span class="preprocessor"></span>    $self-&gt;{r_problemContents}= undef;
    
<span class="preprocessor">    ##########################################</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    # Determine action</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    ###########################################</span>
<span class="preprocessor"></span>
    <span class="keywordflow">if</span> ($actionID) {
        unless (grep { $_ eq $actionID } @{ ACTION_FORMS() } ) {
            die <span class="stringliteral">&quot;Action $actionID not found&quot;</span>;
        }
<span class="preprocessor">        # Check permissions</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (not FORM_PERMS()-&gt;{$actionID} or $authz-&gt;hasPermissions($user, FORM_PERMS()-&gt;{$actionID})) {
            my $actionHandler = <span class="stringliteral">&quot;${actionID}_handler&quot;</span>;
            my %genericParams =();
<span class="preprocessor">#           foreach my $param (qw(selected_users)) {</span>
<span class="preprocessor"></span><span class="preprocessor">#               $genericParams{$param} = [ $r-&gt;param($param) ];</span>
<span class="preprocessor"></span><span class="preprocessor">#           }</span>
<span class="preprocessor"></span>            my %actionParams = $self-&gt;getActionParams($actionID);
            my %tableParams = (); # $self-&gt;getTableParams();
            $self-&gt;{action}= $actionID;
            $self-&gt;$actionHandler(\%genericParams, \%actionParams, \%tableParams);
        } <span class="keywordflow">else</span> {
            $self-&gt;addbadmessage( <span class="stringliteral">&quot;You are not authorized to perform this action.&quot;</span>);
        }
    } <span class="keywordflow">else</span> {
        $self-&gt;{action}=<span class="stringliteral">&#39;fresh_edit&#39;</span>;
        my $actionHandler = <span class="stringliteral">&quot;fresh_edit_handler&quot;</span>;
        my %genericParams;
        my %actionParams = (); #$self-&gt;getActionParams($actionID);
        my %tableParams = (); # $self-&gt;getTableParams();
        my $problemContents = <span class="stringliteral">&#39;&#39;</span>;
        $self-&gt;{r_problemContents}=\$problemContents;
        $self-&gt;$actionHandler(\%genericParams, \%actionParams, \%tableParams);
    }
 
    
<span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # displayMode   and problemSeed</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    # Determine the display mode</span>
<span class="preprocessor"></span><span class="preprocessor">    # If $self-&gt;{problemSeed} was obtained within saveFileChanges from the problem_record</span>
<span class="preprocessor"></span><span class="preprocessor">    # then it can be overridden by the value obtained from the form.</span>
<span class="preprocessor"></span><span class="preprocessor">    # Insure that $self-&gt;{problemSeed} has some non-empty value</span>
<span class="preprocessor"></span><span class="preprocessor">    # displayMode and problemSeed </span>
<span class="preprocessor"></span><span class="preprocessor">    # will be needed for viewing the problem via redirect.</span>
<span class="preprocessor"></span><span class="preprocessor">    # They are also two of the parameters which can be set by the editor</span>
<span class="preprocessor"></span><span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span>    
    <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&#39;displayMode&#39;</span>)) {
        $self-&gt;{displayMode} = $r-&gt;param(<span class="stringliteral">&#39;displayMode&#39;</span>);
    } <span class="keywordflow">else</span> {
        $self-&gt;{displayMode} = $ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};
    }
    
<span class="preprocessor">    # form version of problemSeed overrides version obtained from the the problem_record</span>
<span class="preprocessor"></span><span class="preprocessor">    # inside saveFileChanges</span>
<span class="preprocessor"></span>    $self-&gt;{problemSeed} = $r-&gt;param(<span class="stringliteral">&#39;problemSeed&#39;</span>) <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&#39;problemSeed&#39;</span>));  
<span class="preprocessor">    # Make sure that the problem seed has some value</span>
<span class="preprocessor"></span>    $self-&gt;{problemSeed} = DEFAULT_SEED() unless not_blank( $self-&gt;{problemSeed});
    
<span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Return </span>
<span class="preprocessor"></span><span class="preprocessor">    #   If  file saving fails or </span>
<span class="preprocessor"></span><span class="preprocessor">    #   if no redirects are required. No further processing takes place in this subroutine.</span>
<span class="preprocessor"></span><span class="preprocessor">    #   Redirects are required only for the following submit values</span>
<span class="preprocessor"></span><span class="preprocessor">    #        &#39;Save&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">    #        &#39;Save as&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">    #        &#39;Refresh&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">    #        add problem to set</span>
<span class="preprocessor"></span><span class="preprocessor">    #        add set header to set</span>
<span class="preprocessor"></span><span class="preprocessor">    # </span>
<span class="preprocessor"></span><span class="preprocessor">    #########################################</span>
<span class="preprocessor"></span>    
    <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{failure};
<span class="preprocessor">    # FIXME: even with an error we still open a new page because of the target specified in the form</span>
<span class="preprocessor"></span>    

<span class="preprocessor">    # Some cases do not need a redirect: save, refresh, save_as, add_problem_to_set, add_header_to_set,make_local_copy</span>
<span class="preprocessor"></span>    my $action = $self-&gt;{action};
    return ;

}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="accbc9cfa29bc5d94c525920ebe79b74d"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::revert_form" ref="accbc9cfa29bc5d94c525920ebe79b74d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::revert_form </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-revert_form' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-revert_form-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-revert_form-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-revert_form-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in revert_form: 8</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#accbc9cfa29bc5d94c525920ebe79b74d">revert_form</a> {
    my ($self, $onChange, %actionParams) = @_;
    my $editFilePath    = $self-&gt;{editFilePath};
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Error: The original file $editFilePath cannot be read.&quot;</span> unless -<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a> $editFilePath;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless defined($self-&gt;{tempFilePath}) and -e $self-&gt;{tempFilePath} ;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Revert to &quot;</span>.$self-&gt;shortPath($editFilePath) ;

}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a43856bccffca3d51e5bf23d30f7c1529"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::revert_handler" ref="a43856bccffca3d51e5bf23d30f7c1529" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::revert_handler </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-revert_handler' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-revert_handler-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-revert_handler-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-revert_handler-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in revert_handler: 16</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a43856bccffca3d51e5bf23d30f7c1529">revert_handler</a> {
    my ($self, $genericParams, $actionParams, $tableParams) = @_;
    my $ce = $self-&gt;r-&gt;ce;
<span class="preprocessor">    #$self-&gt;addgoodmessage(&quot;revert_handler called&quot;);    </span>
<span class="preprocessor"></span>    my $editFilePath       = $self-&gt;{editFilePath};
    $self-&gt;{inputFilePath} = $editFilePath;
<span class="preprocessor">    # unlink the temp files;</span>
<span class="preprocessor"></span>    die <span class="stringliteral">&quot;tempFilePath is unsafe!&quot;</span> unless path_is_subdir($self-&gt;{tempFilePath}, $ce-&gt;{courseDirs}-&gt;{templates}, 1); # 1==path can be relative to dir
    unlink($self-&gt;{tempFilePath});
    $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Deleting temp file at &quot;</span> . $self-&gt;shortPath($self-&gt;{tempFilePath}));
    $self-&gt;{tempFilePath}  = <span class="stringliteral">&#39;&#39;</span>;
    my $problemContents    =<span class="stringliteral">&#39;&#39;</span>;
    $self-&gt;{r_problemContents} = \$problemContents;
    $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Reverting to original file &#39;&quot;</span>.$self-&gt;shortPath($editFilePath).<span class="stringliteral">&quot;&#39;&quot;</span>);
<span class="preprocessor">    # no redirect is needed</span>
<span class="preprocessor">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aea4ea2b51439c92ecb416103e7395af9"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::save_as_form" ref="aea4ea2b51439c92ecb416103e7395af9" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::save_as_form </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-save_as_form' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-save_as_form-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-save_as_form-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-save_as_form-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in save_as_form: 83</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#aea4ea2b51439c92ecb416103e7395af9">save_as_form</a> {  # calls the <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a02e024195d5a3b057520886a18ca198d">save_as_handler</a> 
    my ($self, $onChange, %actionParams) = @_;
    my $editFilePath  = $self-&gt;{editFilePath};
<span class="preprocessor">#   return &quot;&quot; unless -w $editFilePath;  ##  DPVC -- we don&#39;t need to be able to write the original in order to make a copy</span>
<span class="preprocessor"></span>    
    
    my $templatesDir  =  $self-&gt;r-&gt;ce-&gt;{courseDirs}-&gt;{templates};
    my $setID         = $self-&gt;{setID};
    my $fullSetID     = $self-&gt;{fullSetID};
    
    
    my $shortFilePath =  $editFilePath;
    $shortFilePath   =~ s|^$templatesDir/||;
    $shortFilePath   =  <span class="stringliteral">&#39;local/&#39;</span>.$shortFilePath unless( $shortFilePath =~m|^local/|);  # suggest that modifications be saved to the <span class="stringliteral">&quot;local&quot;</span> subdirectory
    $shortFilePath =~ s|^.*/|| <span class="keywordflow">if</span> $shortFilePath =~ m|^/|;  # <span class="keywordflow">if</span> it is still an absolute path don<span class="stringliteral">&#39;t suggest a file path to save to.</span>
<span class="stringliteral">   </span>
<span class="stringliteral"></span>
<span class="stringliteral">    my $probNum = ($self-&gt;{file_type} eq &#39;</span>problem<span class="stringliteral">&#39;)? &quot;/problem $self-&gt;{problemID}&quot; : &quot;&quot;;</span>
<span class="stringliteral">    my $andRelink = &#39;</span><span class="stringliteral">&#39;;</span>
<span class="stringliteral">#   $andRelink = CGI::br().&#39;</span> and <span class="stringliteral">&#39;.CGI::checkbox(</span>
<span class="stringliteral">#               -name =&gt; &quot;action.save_as.saveMode&quot;,</span>
<span class="stringliteral">#               -value =&gt; &quot;rename&quot;,</span>
<span class="stringliteral">#               -label =&gt; &quot;&quot;,</span>
<span class="stringliteral">#               -checked =&gt; 1,</span>
<span class="stringliteral">#               -onclick=&gt;$onChange</span>
<span class="stringliteral">#               ).</span>
<span class="stringliteral">#            &quot; use in &quot;.CGI::b(&quot;set $fullSetID$probNum&quot;)</span>
<span class="stringliteral">#                if not_blank($setID)  &amp;&amp; $setID ne &#39;</span>Undefined_Set<span class="stringliteral">&#39; &amp;&amp;</span>
<span class="stringliteral">#               $self-&gt;{file_type} ne &#39;</span>blank_problem<span class="stringliteral">&#39;;</span>
<span class="stringliteral"></span>
<span class="stringliteral">    my $can_add_problem_to_set = not_blank($setID)  &amp;&amp; $setID ne &#39;</span>Undefined_Set<span class="stringliteral">&#39; &amp;&amp; $self-&gt;{file_type} ne &#39;</span>blank_problem<span class="stringliteral">&#39;;</span>
<span class="stringliteral">    # don&#39;</span>t addor replace problems to sets <span class="keywordflow">if</span> the <span class="keyword">set</span> is the Undefined_Set or <span class="keywordflow">if</span> the problem is the blank_problem.
    
    my $replace_problem_in_set  = ($can_add_problem_to_set)?
             # CGI::input({
<span class="preprocessor">                 # -type      =&gt; &#39;radio&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">                 # -name      =&gt; &quot;action.save_as.saveMode&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">                 # -value     =&gt; &quot;rename&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">                 # -label     =&gt; &#39;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">             # },&quot;and replace &quot;.CGI::b(&quot;set $fullSetID$probNum&quot;).&#39;,&#39;) </span>
<span class="preprocessor"></span>             <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&#39;radio&#39;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&#39;action_save_as_saveMode_rename_id&#39;</span>, -label_text=&gt;<span class="stringliteral">&quot;Replace &quot;</span>.CGI::b(<span class="stringliteral">&quot;set $fullSetID$probNum&quot;</span>), -input_attr=&gt;{
             -name      =&gt; <span class="stringliteral">&quot;action.save_as.saveMode&quot;</span>,
             -value     =&gt; <span class="stringliteral">&quot;rename&quot;</span>,
             }).CGI::br() : <span class="stringliteral">&#39;&#39;</span>
    ;
    my $add_problem_to_set      = ($can_add_problem_to_set)?
             # CGI::input({
<span class="preprocessor">                 # -type      =&gt; &#39;radio&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">                 # -name      =&gt; &quot;action.save_as.saveMode&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">                 # -value     =&gt; &#39;add_to_set_as_new_problem&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">                 # -label     =&gt; &#39;&#39;,</span>
<span class="preprocessor"></span><span class="preprocessor">                 # -onfocus   =&gt; $onChange,</span>
<span class="preprocessor"></span><span class="preprocessor">             # },&quot;and append to end of set $fullSetID&quot;,) : &#39;&#39;</span>
<span class="preprocessor"></span>             <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&#39;radio&#39;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;action_save_as_saveMode_new_problem_id&quot;</span>, -label_text=&gt;<span class="stringliteral">&quot;Append to end of set $fullSetID&quot;</span>, -input_attr=&gt;{
                 -name      =&gt; <span class="stringliteral">&quot;action.save_as.saveMode&quot;</span>,
                 -value     =&gt; <span class="stringliteral">&#39;add_to_set_as_new_problem&#39;</span>,
                 -onfocus   =&gt; $onChange,
             }).CGI::br() : <span class="stringliteral">&#39;&#39;</span>
    ;  
    my $rh_new_problem_options = {
<span class="preprocessor">                # -type      =&gt; &#39;radio&#39;,</span>
<span class="preprocessor"></span>                 -name      =&gt; <span class="stringliteral">&quot;action.save_as.saveMode&quot;</span>,
                 -value     =&gt; <span class="stringliteral">&quot;new_independent_problem&quot;</span>,
                 -onfocus   =&gt; $onChange,
                 };
    $rh_new_problem_options-&gt;{checked}=1 unless $can_add_problem_to_set;
    my $create_new_problem       =  <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&#39;radio&#39;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;action_save_as_saveMode_independent_problem_id&quot;</span>, -label_text=&gt;<span class="stringliteral">&quot;Append as new independent problem&quot;</span>, -input_attr=&gt;$rh_new_problem_options).CGI::br(); #CGI::input($rh_new_problem_options,<span class="stringliteral">&quot;as a new independent problem&quot;</span>);
    
    $andRelink = CGI::br(). $replace_problem_in_set . $add_problem_to_set . $create_new_problem;
                 
    <span class="keywordflow">return</span> #<span class="stringliteral">&#39;Save AS [TMPL]/&#39;</span>.
            # CGI::textfield(
                   # -name=&gt;<span class="stringliteral">&#39;action.save_as.target_file&#39;</span>, -size=&gt;60, -value=&gt;<span class="stringliteral">&quot;$shortFilePath&quot;</span>,  
                   # -onfocus=&gt;$onChange
                  # ).<span class="stringliteral">&quot;,&quot;</span>.
            <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;text&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;action_save_as_target_file_id&quot;</span>, -label_text=&gt;<span class="stringliteral">&quot;Save AS [TMPL]/&quot;</span>, -input_attr=&gt;{
                -name=&gt;<span class="stringliteral">&#39;action.save_as.target_file&#39;</span>, -size=&gt;60, -value=&gt;<span class="stringliteral">&quot;$shortFilePath&quot;</span>,  
                -onfocus=&gt;$onChange
            }).
            CGI::hidden(-name=&gt;<span class="stringliteral">&#39;action.save_as.source_file&#39;</span>, -value=&gt;$editFilePath ).
            CGI::hidden(-name=&gt;<span class="stringliteral">&#39;action.save_as.file_type&#39;</span>,-value=&gt;$self-&gt;{file_type}).
            $andRelink;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a02e024195d5a3b057520886a18ca198d"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::save_as_handler" ref="a02e024195d5a3b057520886a18ca198d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::save_as_handler </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-save_as_handler' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-save_as_handler-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-save_as_handler-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-save_as_handler-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in save_as_handler: 177</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a02e024195d5a3b057520886a18ca198d">save_as_handler</a> {
    my ($self, $genericParams, $actionParams, $tableParams) = @_;
    my $r = $self-&gt;r;
<span class="preprocessor">    #$self-&gt;addgoodmessage(&quot;save_as_handler called&quot;);</span>
<span class="preprocessor"></span>    $self-&gt;{status_message} = <span class="stringliteral">&#39;&#39;</span>; ## DPVC -- <span class="keyword">remove</span> bogus old messages
    my $courseName      =  $self-&gt;{courseID};
    my $setName         =  $self-&gt;{setID};
    my $fullSetName     =  $self-&gt;{fullSetID};
    my $problemNumber   =  $self-&gt;{problemID};
    my $displayMode     =  $self-&gt;{displayMode};
    my $problemSeed     =  $self-&gt;{problemSeed};
    my $effectiveUserName = $self-&gt;r-&gt;param(<span class="stringliteral">&#39;effectiveUser&#39;</span>);
    
    my $do_not_save = 0;
    my $saveMode       = $actionParams-&gt;{<span class="stringliteral">&#39;action.save_as.saveMode&#39;</span>}-&gt;[0] || <span class="stringliteral">&#39;no_save_mode_selected&#39;</span>;
    my $new_file_name  = $actionParams-&gt;{<span class="stringliteral">&#39;action.save_as.target_file&#39;</span>}-&gt;[0] || <span class="stringliteral">&#39;&#39;</span>;
    my $sourceFilePath = $actionParams-&gt;{<span class="stringliteral">&#39;action.save_as.source_file&#39;</span>}-&gt;[0] || <span class="stringliteral">&#39;&#39;</span>;
    my $file_type      = $actionParams-&gt;{<span class="stringliteral">&#39;action.save_as.file_type&#39;</span>}-&gt;[0] || <span class="stringliteral">&#39;&#39;</span>;
    $self -&gt;{sourceFilePath} = $sourceFilePath;  # store <span class="keywordflow">for</span> use in <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a1e77700d6d2c48c23f57ae30adc672b7">saveFileChanges</a>
    $new_file_name =~ s/^\s*<span class="comment">//;  #remove initial and final white space</span>
    $new_file_name =~ s/\s*$<span class="comment">//;</span>
    <span class="keywordflow">if</span> ( $new_file_name !~ /\S/) { # need a non-blank file name
<span class="preprocessor">        # setting $self-&gt;{failure} stops saving and any redirects</span>
<span class="preprocessor"></span>        $do_not_save = 1;
        $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;Please specify a file to save to.&quot;</span>));
    }
    
<span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # grab the problemContents from the form in order to save it to a new permanent file</span>
<span class="preprocessor"></span><span class="preprocessor">    # later we will unlink (delete) the current temporary file</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span>    my $problemContents = <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#ace9ad8ee32d78fc044edc35d75defdfd">fixProblemContents</a>($self-&gt;r-&gt;param(<span class="stringliteral">&#39;problemContents&#39;</span>));
    $self-&gt;{r_problemContents} = \$problemContents;
    warn <span class="stringliteral">&quot;problem contents is empty&quot;</span> unless $problemContents;
<span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Rescue the user in case they forgot to end the file name with .pg</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span>    
    <span class="keywordflow">if</span>($file_type eq <span class="stringliteral">&#39;problem&#39;</span> 
      or $file_type eq <span class="stringliteral">&#39;blank_problem&#39;</span>
      or $file_type eq <span class="stringliteral">&#39;set_header&#39;</span>) {
            $new_file_name =~ s/\.pg$<span class="comment">//; # remove it if it is there</span>
            $new_file_name .= <span class="stringliteral">&#39;.pg&#39;</span>; # put it there
            
    }   
<span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Construct the output file path</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span>    my $outputFilePath = $self-&gt;r-&gt;ce-&gt;{courseDirs}-&gt;{templates} . <span class="charliteral">&#39;/&#39;</span> . 
                                 $new_file_name;        
    <span class="keywordflow">if</span> (defined $outputFilePath and -e $outputFilePath) {
<span class="preprocessor">        # setting $do_not_save stops saving and any redirects</span>
<span class="preprocessor"></span>        $do_not_save = 1;
        $self-&gt;addbadmessage(CGI::p(<span class="stringliteral">&quot;File &#39;&quot;</span>.$self-&gt;shortPath($outputFilePath).<span class="stringliteral">&quot;&#39; exists.  </span>
<span class="stringliteral">        File not saved. No changes have been made.</span>
<span class="stringliteral">        You can change the file path for this problem manually from the &#39;Hmwk Sets Editor&#39; page&quot;</span>));
        $self-&gt;addgoodmessage(CGI::p(<span class="stringliteral">&quot;The text box now contains the source of the original problem.&quot;</span>.
        <span class="stringliteral">&quot; You can recover lost edits by using the Back button on your browser.&quot;</span>));
    } <span class="keywordflow">else</span> {
        $self-&gt;{editFilePath} = $outputFilePath;
        $self-&gt;{tempFilePath} = <span class="stringliteral">&#39;&#39;</span>; # nothing needs to be unlinked.
        $self-&gt;{inputFilePath} = <span class="stringliteral">&#39;&#39;</span>;
    }


    unless ($do_not_save ) {
        $self-&gt;saveFileChanges($outputFilePath);

        <span class="keywordflow">if</span> ($saveMode eq <span class="stringliteral">&#39;rename&#39;</span> and -<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a> $outputFilePath) { 
<span class="preprocessor">        #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Modify source file path in problem</span>
<span class="preprocessor"></span><span class="preprocessor">        #################################################</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ($file_type eq <span class="stringliteral">&#39;set_header&#39;</span> ) {
                my $setRecord = $self-&gt;r-&gt;db-&gt;getGlobalSet($setName);
                $setRecord-&gt;set_header($new_file_name);
                <span class="keywordflow">if</span> ($self-&gt;r-&gt;db-&gt;putGlobalSet($setRecord)) {
                  $self-&gt;addgoodmessage(<span class="stringliteral">&quot;The set header for set $setName has been renamed to &#39;&quot;</span>.$self-&gt;shortPath($outputFilePath).<span class="stringliteral">&quot;&#39;.&quot;</span>) ;
                } <span class="keywordflow">else</span> {
                  $self-&gt;addbadmessage(<span class="stringliteral">&quot;Unable to change the set header for set $setName. Unknown error.&quot;</span>);
                }
            } elsif ($file_type eq <span class="stringliteral">&#39;hardcopy_header&#39;</span> ) {
                my $setRecord = $self-&gt;r-&gt;db-&gt;getGlobalSet($setName);
                $setRecord-&gt;hardcopy_header($new_file_name);
                <span class="keywordflow">if</span> ($self-&gt;r-&gt;db-&gt;putGlobalSet($setRecord)) {
                  $self-&gt;addgoodmessage(<span class="stringliteral">&quot;The hardcopy header for set $setName has been renamed to &#39;&quot;</span>.$self-&gt;shortPath($outputFilePath).<span class="stringliteral">&quot;&#39;.&quot;</span>) ;
                } <span class="keywordflow">else</span> {
                  $self-&gt;addbadmessage(<span class="stringliteral">&quot;Unable to change the hardcopy header for set $setName. Unknown error.&quot;</span>);
                }
            } <span class="keywordflow">else</span> {
                my $problemRecord;
                <span class="keywordflow">if</span> ( $fullSetName =~ /,v(\d+)$/ ) {
                    $problemRecord = $self-&gt;r-&gt;db-&gt;getMergedProblemVersion($effectiveUserName, $setName, $1, $problemNumber);
                } <span class="keywordflow">else</span> {
                    $problemRecord = $self-&gt;r-&gt;db-&gt;getGlobalProblem($setName,$problemNumber);
                }
                $problemRecord-&gt;source_file($new_file_name);
                my $result = ( $fullSetName =~ /,v(\d+)$/ ) ?
                    $self-&gt;r-&gt;db-&gt;putProblemVersion($problemRecord) :
                    $self-&gt;r-&gt;db-&gt;putGlobalProblem($problemRecord);
                <span class="keywordflow">if</span>  ( $result  ) {
                    $self-&gt;addgoodmessage(<span class="stringliteral">&quot;The source file for &#39;set $fullSetName / problem $problemNumber&#39; has been changed from &quot;</span>.
                    $self-&gt;shortPath($sourceFilePath).<span class="stringliteral">&quot; to &#39;&quot;</span>.$self-&gt;shortPath($outputFilePath).<span class="stringliteral">&quot;&#39;.&quot;</span>) ;
                } <span class="keywordflow">else</span> {
                    $self-&gt;addbadmessage(<span class="stringliteral">&quot;Unable to change the source file path for set $fullSetName, problem $problemNumber. Unknown error.&quot;</span>);
                }
            }
        } elsif ($saveMode eq <span class="stringliteral">&#39;add_to_set_as_new_problem&#39;</span>) {
            my $targetProblemNumber   =  1+ <a class="code" href="classWeBWorK_1_1Utils.html#a3d364a4d0cb81eef75c34845afb179e3">WeBWorK::Utils::max</a>( $self-&gt;r-&gt;db-&gt;listGlobalProblems($setName));
            my $problemRecord  = $self-&gt;addProblemToSet(
                       setName        =&gt; $setName,
                       sourceFile     =&gt; $new_file_name, 
                       problemID      =&gt; $targetProblemNumber, #added to end of <span class="keyword">set</span>
            );
            $self-&gt;assignProblemToAllSetUsers($problemRecord);
            $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Added $new_file_name to &quot;</span>. $setName. <span class="stringliteral">&quot; as problem $targetProblemNumber&quot;</span>) ;
        } elsif ($saveMode eq <span class="stringliteral">&#39;new_independent_problem&#39;</span>) {
<span class="preprocessor">        #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Don&#39;t modify source file path in problem -- just report </span>
<span class="preprocessor"></span><span class="preprocessor">        #################################################</span>
<span class="preprocessor"></span>
<span class="preprocessor">            #$self-&gt;{status_message} = &#39;&#39;;  ## DPVC remove old messages</span>
<span class="preprocessor"></span>            $self-&gt;addgoodmessage(<span class="stringliteral">&quot;A new file has been created at &#39;&quot;</span>.$self-&gt;shortPath($outputFilePath). 
            <span class="stringliteral">&quot;&#39; with the contents below. No changes have been made to set $setName.&quot;</span>);
        } <span class="keywordflow">else</span> {
            $self-&gt;addbadmessage(<span class="stringliteral">&quot;Don&#39;t recognize saveMode: |$saveMode|. Unknown error.&quot;</span>);
        }
      
    }
    my $edit_level = $self-&gt;r-&gt;param(<span class="stringliteral">&quot;edit_level&quot;</span>) || 0;
    $edit_level++;
    
<span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Set up redirect</span>
<span class="preprocessor"></span><span class="preprocessor">    # The redirect gives the server time to detect that the new file exists.</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span>    my $problemPage;
    my $new_file_type;

    <span class="keywordflow">if</span> ($saveMode eq <span class="stringliteral">&#39;new_independent_problem&#39;</span> ) {
        $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::PGProblemEditor2&quot;</span>,$r,
            courseID =&gt; $courseName, setID =&gt; <span class="stringliteral">&#39;Undefined_Set&#39;</span>, problemID =&gt; <span class="stringliteral">&#39;Undefined_Set&#39;</span>
        );
        $new_file_type = <span class="stringliteral">&#39;source_path_for_problem_file&#39;</span>;
    } elsif ($saveMode eq <span class="stringliteral">&#39;rename&#39;</span>) {
        $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::PGProblemEditor2&quot;</span>,$r,
            courseID =&gt; $courseName, setID =&gt; $setName, problemID =&gt; $problemNumber
        );
        $new_file_type = $file_type;
    } elsif ($saveMode eq <span class="stringliteral">&#39;add_to_set_as_new_problem&#39;</span>) {
        $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::PGProblemEditor2&quot;</span>,$r,
            courseID =&gt; $courseName, setID =&gt; $setName, problemID =&gt; $problemNumber
        );
        $new_file_type = $file_type;
    } <span class="keywordflow">else</span> {
        $self-&gt;addbadmessage(<span class="stringliteral">&quot; Please use radio buttons to choose the method for saving this file. Can&#39;t recognize saveMode: |$saveMode|.&quot;</span>);
<span class="preprocessor">        # can&#39;t continue since paths have not been properly defined.</span>
<span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
    }

<span class="preprocessor">    #warn &quot;save mode is $saveMode&quot;;</span>
<span class="preprocessor"></span>
    my $relativeOutputFilePath = $self-&gt;getRelativeSourceFilePath($outputFilePath);
    
    my $viewURL = $self-&gt;systemLink($problemPage, 
                                 params=&gt;{
                                     sourceFilePath     =&gt; $relativeOutputFilePath, #The path relative to the templates directory is required.
                                     problemSeed        =&gt; $problemSeed,
                                     edit_level         =&gt; $edit_level,
                                     file_type          =&gt; $new_file_type,
                                     status_message     =&gt; uri_escape($self-&gt;{status_message})

                                 }
    );
    
    $self-&gt;reply_with_redirect($viewURL);
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;  # no redirect needed
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a484292878ba4c69d9d27eede639b1e4e"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::save_form" ref="a484292878ba4c69d9d27eede639b1e4e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::save_form </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-save_form' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-save_form-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-save_form-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-save_form-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in save_form: 15</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a484292878ba4c69d9d27eede639b1e4e">save_form</a> {
    my ($self, $onChange, %actionParams) = @_;
    my $r =&gt; $self-&gt;r;
<span class="preprocessor">    #return &quot;&quot; unless defined($self-&gt;{tempFilePath}) and -e $self-&gt;{tempFilePath};</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ($self-&gt;{editFilePath} =~ /$BLANKPROBLEM$/ ) {
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;  #Can<span class="stringliteral">&#39;t save blank problems without changing names</span>
<span class="stringliteral">    } elsif (-w $self-&gt;{editFilePath}) {</span>
<span class="stringliteral"></span>
<span class="stringliteral">        return &quot;Save &quot;.CGI::b($self-&gt;shortPath($self-&gt;{editFilePath})).&quot; and View&quot;; </span>
<span class="stringliteral"></span>
<span class="stringliteral">    } else {</span>
<span class="stringliteral">        return &quot;&quot;; #&quot;Can&#39;</span>t save -- No write permission<span class="stringliteral">&quot;;</span>
<span class="stringliteral">    }</span>
<span class="stringliteral"></span>
<span class="stringliteral">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2d455974b9b58a960a1dba0c8f948013"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::save_handler" ref="a2d455974b9b58a960a1dba0c8f948013" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::save_handler </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-save_handler' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-save_handler-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-save_handler-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-save_handler-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in save_handler: 135</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2d455974b9b58a960a1dba0c8f948013">save_handler</a> {
    my ($self, $genericParams, $actionParams, $tableParams) = @_;
    my $r= $self-&gt;r;
<span class="preprocessor">    #$self-&gt;addgoodmessage(&quot;save_handler called&quot;);</span>
<span class="preprocessor"></span>    my $courseName      =  $self-&gt;{courseID};
    my $setName         =  $self-&gt;{setID};
    my $fullSetName     =  $self-&gt;{fullSetID};
    my $problemNumber   =  $self-&gt;{problemID};
    my $displayMode     =  $self-&gt;{displayMode};
    my $problemSeed     =  $self-&gt;{problemSeed};
    
<span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # grab the problemContents from the form in order to save it to a new permanent file</span>
<span class="preprocessor"></span><span class="preprocessor">    # later we will unlink (delete) the current temporary file</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span>    my $problemContents = <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#ace9ad8ee32d78fc044edc35d75defdfd">fixProblemContents</a>($self-&gt;r-&gt;param(<span class="stringliteral">&#39;problemContents&#39;</span>));
    $self-&gt;{r_problemContents} = \$problemContents;
    
<span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Construct the output file path</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span>    my $editFilePath        = $self-&gt;{editFilePath};
    my $outputFilePath      = $editFilePath;

    my $do_not_save = 0;
    my $file_type = $self-&gt;{file_type};
    $self-&gt;saveFileChanges($outputFilePath);    
<span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Set up redirect to Problem.pm</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################</span>
<span class="preprocessor"></span>    my $viewURL;
<span class="preprocessor">    ########################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # construct redirect URL and redirect</span>
<span class="preprocessor"></span><span class="preprocessor">    ########################################################</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ($file_type eq <span class="stringliteral">&#39;problem&#39;</span> || $file_type eq <span class="stringliteral">&#39;source_path_for_problem_file&#39;</span>) { # redirect to Problem.pm

<span class="preprocessor">        # we need to know if the set is a gateway set to determine the redirect</span>
<span class="preprocessor"></span>        my $globalSet = $self-&gt;r-&gt;db-&gt;getGlobalSet( $setName );
        my $problemPage;
        <span class="keywordflow">if</span> ( defined( $globalSet) &amp;&amp; $globalSet-&gt;assignment_type =~ /gateway/ ) {
            $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::GatewayQuiz&quot;</span>,$r,
            courseID =&gt; $courseName, setID =&gt; <span class="stringliteral">&quot;Undefined_Set&quot;</span>);
<span class="preprocessor">            # courseID =&gt; $courseName, setID =&gt; $fullSetName);</span>
<span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
            $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Problem&quot;</span>,$r,
                                    courseID =&gt; $courseName, setID =&gt; $setName, problemID =&gt; $problemNumber );
        }
        
        my $relativeEditFilePath = $self-&gt;getRelativeSourceFilePath($editFilePath);
        
        $viewURL = $self-&gt;systemLink($problemPage,
            params =&gt; {
                displayMode        =&gt; $displayMode,
                problemSeed        =&gt; $problemSeed,
                editMode           =&gt; <span class="stringliteral">&quot;savedFile&quot;</span>,
                edit_level         =&gt; 0,
                sourceFilePath     =&gt; $relativeEditFilePath,
                status_message     =&gt; uri_escape($self-&gt;{status_message})
    
            }
        );
    } elsif ($file_type eq <span class="stringliteral">&#39;set_header&#39;</span> ) { # redirect to ProblemSet
        my $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::ProblemSet&quot;</span>,$r,
            courseID =&gt; $courseName, setID =&gt; $setName, 
        );
        
        $viewURL = $self-&gt;systemLink($problemPage,
            params =&gt; {
                displayMode        =&gt; $displayMode,
                problemSeed        =&gt; $problemSeed,
                editMode           =&gt; <span class="stringliteral">&quot;savedFile&quot;</span>,
                edit_level         =&gt; 0,
                status_message     =&gt; uri_escape($self-&gt;{status_message})
    
            }
        );  
    } elsif ( $file_type eq <span class="stringliteral">&#39;hardcopy_header&#39;</span>) { # redirect to ProblemSet
        my $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&#39;WeBWorK::ContentGenerator::Hardcopy&#39;</span>,$r,
            courseID =&gt; $courseName, setID =&gt; $setName, 
        );
        
        $viewURL = $self-&gt;systemLink($problemPage,
            params =&gt; {
                displayMode        =&gt; $displayMode,
                problemSeed        =&gt; $problemSeed,
                editMode           =&gt; <span class="stringliteral">&quot;savedFile&quot;</span>,
                edit_level         =&gt; 0,
                status_message     =&gt; uri_escape($self-&gt;{status_message})
    
            }
        );  
    
    } elsif ($file_type eq <span class="stringliteral">&#39;course_info&#39;</span>) {  # redirect to ProblemSets.pm
        my $problemSetsPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::ProblemSets&quot;</span>,$r,
            courseID =&gt; $courseName);
        $viewURL = $self-&gt;systemLink($problemSetsPage,
            params =&gt; {
                editMode           =&gt; (<span class="stringliteral">&quot;savedFile&quot;</span>),
                edit_level         =&gt; 0,
                status_message     =&gt; uri_escape($self-&gt;{status_message})
            }
        );
    } elsif ($file_type eq <span class="stringliteral">&#39;options_info&#39;</span>) {  # redirect to Options.pm
        my $optionsPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Options&quot;</span>,$r,
            courseID =&gt; $courseName);
        $viewURL = $self-&gt;systemLink($optionsPage,
            params =&gt; {
                editMode           =&gt; (<span class="stringliteral">&quot;savedFile&quot;</span>),
                edit_level         =&gt; 0,
                status_message     =&gt; uri_escape($self-&gt;{status_message})
            }
        );
    } elsif ($file_type eq <span class="stringliteral">&#39;source_path_for_problem_file&#39;</span>) {  # redirect to ProblemSets.pm
        my $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::PGProblemEditor2&quot;</span>,$r,
        courseID =&gt; $courseName, setID =&gt; $setName, problemID =&gt; $problemNumber
        );
        my $viewURL = $self-&gt;systemLink($problemPage, 
             params=&gt;{
                displayMode        =&gt; $displayMode,
                problemSeed        =&gt; $problemSeed,
                editMode           =&gt; <span class="stringliteral">&quot;savedFile&quot;</span>,
                edit_level         =&gt; 0,
                sourceFilePath     =&gt; $outputFilePath, #The path relative to the templates directory is required.
                file_type          =&gt; <span class="stringliteral">&#39;source_path_for_problem_file&#39;</span>,
                status_message     =&gt; uri_escape($self-&gt;{status_message})

             }
    );

    } <span class="keywordflow">else</span> {
        die <span class="stringliteral">&quot;I don&#39;t know how to redirect this file type $file_type &quot;</span>;
    }
    
    $self-&gt;reply_with_redirect($viewURL);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a1e77700d6d2c48c23f57ae30adc672b7"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::saveFileChanges" ref="a1e77700d6d2c48c23f57ae30adc672b7" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::saveFileChanges </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-saveFileChanges' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-saveFileChanges-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-saveFileChanges-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-saveFileChanges-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in saveFileChanges: 163</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a1e77700d6d2c48c23f57ae30adc672b7">saveFileChanges</a> {

<span class="preprocessor">################################################################################</span>
<span class="preprocessor"></span><span class="preprocessor"># saveFileChanges does most of the work. it is a separate method so that it can</span>
<span class="preprocessor"></span><span class="preprocessor"># be called from either pre_header_initialize() or initilize(), depending on</span>
<span class="preprocessor"></span><span class="preprocessor"># whether a redirect is needed or not.</span>
<span class="preprocessor"></span><span class="preprocessor"># </span>
<span class="preprocessor"></span><span class="preprocessor"># it actually does a lot more than save changes to the file being edited, and</span>
<span class="preprocessor"></span><span class="preprocessor"># sometimes less.</span>
<span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<span class="preprocessor"></span>
    my ($self, $outputFilePath, $problemContents ) = @_;
    my $r             = $self-&gt;r;
    my $ce            = $r-&gt;ce;

    my $action          = $self-&gt;{action}||<span class="stringliteral">&#39;no action&#39;</span>;
<span class="preprocessor">    # my $editFilePath  = $self-&gt;{editFilePath}; # not used??</span>
<span class="preprocessor"></span>    my $sourceFilePath  = $self-&gt;{sourceFilePath};
    my $tempFilePath    = $self-&gt;{tempFilePath};    
    
    <span class="keywordflow">if</span> (defined($problemContents) and ref($problemContents) ) {
        $problemContents = ${$problemContents};
    } elsif( ! not_blank($problemContents)  ) {      # <span class="keywordflow">if</span> the problemContents is undefined or empty
        $problemContents = ${$self-&gt;{r_problemContents}};
    }
<span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # read and update the targetFile and targetFile.tmp files in the directory</span>
<span class="preprocessor"></span><span class="preprocessor">    # if a .tmp file already exists use that, unless the revert button has been pressed.</span>
<span class="preprocessor"></span><span class="preprocessor">    # The .tmp files are removed when the file is or when the revert occurs.</span>
<span class="preprocessor"></span><span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span>    

    unless (not_blank($outputFilePath) ) {
        $self-&gt;addbadmessage(<span class="stringliteral">&quot;You must specify an file name in order to save a new file.&quot;</span>);
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
    }
    my $do_not_save    = 0 ;       # flag to prevent saving of file
    my $editErrors = <span class="stringliteral">&#39;&#39;</span>;    

<span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # write changes to the approriate files</span>
<span class="preprocessor"></span><span class="preprocessor">    # FIXME  make sure that the permissions are set correctly!!!</span>
<span class="preprocessor"></span><span class="preprocessor">    # Make sure that the warning is being transmitted properly.</span>
<span class="preprocessor"></span><span class="preprocessor">    ##############################################################################</span>
<span class="preprocessor"></span>   
    my $writeFileErrors;
    <span class="keywordflow">if</span> ( not_blank($outputFilePath)  ) {   # save file
<span class="preprocessor">        # Handle the problem of line endings.  </span>
<span class="preprocessor"></span><span class="preprocessor">        # Make sure that all of the line endings are of unix type.  </span>
<span class="preprocessor"></span><span class="preprocessor">        # Convert \r\n to \n</span>
<span class="preprocessor"></span><span class="preprocessor">        #$problemContents =~ s/\r\n/\n/g;</span>
<span class="preprocessor"></span><span class="preprocessor">        #$problemContents =~ s/\r/\n/g;</span>
<span class="preprocessor"></span>
<span class="preprocessor">        # make sure any missing directories are created</span>
<span class="preprocessor"></span>        <a class="code" href="classWeBWorK_1_1Utils.html#aec74ceba9815c67c2d10f46fbe909063">WeBWorK::Utils::surePathToFile</a>($ce-&gt;{courseDirs}-&gt;{templates},
                                                                $outputFilePath);
        die <span class="stringliteral">&quot;outputFilePath is unsafe!&quot;</span> unless path_is_subdir($outputFilePath, $ce-&gt;{courseDirs}-&gt;{templates}, 1); # 1==path can be relative to dir

        eval {
            local *OUTPUTFILE;
            open OUTPUTFILE,  <span class="stringliteral">&quot;&gt;$outputFilePath&quot;</span>
                    or die <span class="stringliteral">&quot;Failed to open $outputFilePath&quot;</span>;
            print OUTPUTFILE $problemContents;
            close OUTPUTFILE;       
<span class="preprocessor">          # any errors are caught in the next block</span>
<span class="preprocessor"></span>        };

        $writeFileErrors = $@ <span class="keywordflow">if</span> $@;
    } 
 
<span class="preprocessor">    ###########################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Catch errors in saving files,  clean up temp files</span>
<span class="preprocessor"></span><span class="preprocessor">    ###########################################################</span>
<span class="preprocessor"></span>    
    $self-&gt;{saveError} = $do_not_save;    # don<span class="stringliteral">&#39;t do redirects if the file was not saved.</span>
<span class="stringliteral">                                        # don&#39;</span>t unlink files or send success messages

    <span class="keywordflow">if</span> ($writeFileErrors) {
<span class="preprocessor">        # get the current directory from the outputFilePath</span>
<span class="preprocessor"></span>        $outputFilePath =~ m|^(/.*?/)[^/]+$|;
        my $currentDirectory = $1;
    
        my $errorMessage;
<span class="preprocessor">        # check why we failed to give better error messages</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( not -w $ce-&gt;{courseDirs}-&gt;{templates} ) {
            $errorMessage = <span class="stringliteral">&quot;Write permissions have not been enabled in the templates directory.  No changes can be made.&quot;</span>;
        } elsif ( not -w $currentDirectory ) {
            $errorMessage = <span class="stringliteral">&quot;Write permissions have not been enabled in &#39;&quot;</span>.$self-&gt;shortPath($currentDirectory).<span class="stringliteral">&quot;&#39;.  Changes must be saved to a different directory for viewing.&quot;</span>;
        } elsif ( -e $outputFilePath and not -w $outputFilePath ) {
            $errorMessage = <span class="stringliteral">&quot;Write permissions have not been enabled for &#39;&quot;</span>.$self-&gt;shortPath($outputFilePath).<span class="stringliteral">&quot;&#39;.  Changes must be saved to another file for viewing.&quot;</span>;
        } <span class="keywordflow">else</span> {
            $errorMessage = <span class="stringliteral">&quot;Unable to write to &#39;&quot;</span>.$self-&gt;shortPath($outputFilePath).<span class="stringliteral">&quot;&#39;: $writeFileErrors&quot;</span>;
        }

        $self-&gt;{failure} = 1;
        $self-&gt;addbadmessage(CGI::p($errorMessage));
        
    } 
<span class="preprocessor">    ###########################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # FIXME if the file is accompanied by auxiliary files transfer them as well</span>
<span class="preprocessor"></span><span class="preprocessor">    # if the filepath ends in   foobar/foobar.pg  then we assume there are auxiliary files</span>
<span class="preprocessor"></span><span class="preprocessor">    # copy the contents of the original foobar directory to the new one</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span><span class="preprocessor">    ###########################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # If things have worked so far determine if the file might be accompanied by auxiliary files</span>
<span class="preprocessor"></span><span class="preprocessor">    # a path ending in    foo/foo.pg  is assumed to contain auxilliary files</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span>    my $auxiliaryFilesExist = has_aux_files($outputFilePath);

    <span class="keywordflow">if</span> ($auxiliaryFilesExist and not $do_not_save ) {
        my $sourceDirectory = $sourceFilePath;
        my $outputDirectory = $outputFilePath;
        $sourceDirectory =~ s|/[^/]+\.pg$||;
        $outputDirectory =~ s|/[^/]+\.pg$||;
<span class="preprocessor">##############</span>
<span class="preprocessor"></span><span class="preprocessor"># Transfer this to Utils::copyAuxiliaryFiles($sourceDirectory, $destinationDirectory)</span>
<span class="preprocessor"></span><span class="preprocessor">##############</span>
<span class="preprocessor"></span>        my @filesToCopy;
        @filesToCopy = <a class="code" href="classWeBWorK_1_1Utils.html#a908ab95f2f3b2874c63969f6da72877c">WeBWorK::Utils::readDirectory</a>($sourceDirectory) if -d $sourceDirectory;
        foreach my $file (@filesToCopy) {
            next <span class="keywordflow">if</span> $file =~ /\.pg$/;   # .pg file should already be transferred
            my $fromPath = <span class="stringliteral">&quot;$sourceDirectory/$file&quot;</span>;
            my $toPath   = <span class="stringliteral">&quot;$outputDirectory/$file&quot;</span>;
            <span class="keywordflow">if</span> (-f $fromPath and -r $fromPath and not -e $toPath) { # don<span class="stringliteral">&#39;t copy directories, don&#39;</span>t copy files that have already been copied
                copy($fromPath, $toPath) or $writeFileErrors.= &quot;&lt;br&gt; Error copying $fromPath to $toPath&quot;;
                <span class="preprocessor"># need to use binary transfer for gif files.  File::Copy does this.</span>
<span class="preprocessor"></span><span class="preprocessor">                #warn &quot;copied from $fromPath to $toPath&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">                #warn &quot;files are different &quot;,system(&quot;diff $fromPath $toPath&quot;);</span>
<span class="preprocessor"></span>            }
            $self-&gt;addbadmessage($writeFileErrors) <span class="keywordflow">if</span> not_blank($writeFileErrors);
            

        }
        $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Copied auxiliary files from $sourceDirectory to  new location at $outputDirectory&quot;</span>);
 
    }
<span class="preprocessor"> ##############</span>
<span class="preprocessor"></span><span class="preprocessor"> ##############</span>
<span class="preprocessor"></span>     
<span class="preprocessor">    ###########################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # clean up temp files on revert, save and save_as</span>
<span class="preprocessor"></span><span class="preprocessor">    ########################################################### </span>
<span class="preprocessor"></span>    unless( $writeFileErrors or $do_not_save) {  # everything worked!  unlink and announce success!
<span class="preprocessor">        # unlink the temporary file if there are no errors and the save button has been pushed</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (($action eq <span class="stringliteral">&#39;save&#39;</span> or $action eq <span class="stringliteral">&#39;save_as&#39;</span>) and (-w $self-&gt;{tempFilePath})  ) {
                     
                     $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Deleting temp file at &quot;</span> . $self-&gt;shortPath($self-&gt;{tempFilePath}));
                     die <span class="stringliteral">&quot;tempFilePath is unsafe!&quot;</span> unless path_is_subdir($self-&gt;{tempFilePath}, $ce-&gt;{courseDirs}-&gt;{templates}, 1); # 1==path can be relative to dir
                     unlink($self-&gt;{tempFilePath}) ;
        }

        <span class="keywordflow">if</span> ( defined($outputFilePath) and ! $self-&gt;{failure} and not $self-&gt;isTempEditFilePath($outputFilePath) ) {  
<span class="preprocessor">                    # don&#39;t announce saving of temporary editing files</span>
<span class="preprocessor"></span>            my $msg = <span class="stringliteral">&quot;Saved to file &#39;&quot;</span>.$self-&gt;shortPath($outputFilePath).<span class="stringliteral">&quot;&#39;.&quot;</span>;

            $self-&gt;addgoodmessage($msg);
<span class="preprocessor">            #$self-&gt;{inputFilePath} = $outputFilePath; ## DPVC -- avoid file-not-found message</span>
<span class="preprocessor"></span>        }

    }


}  # end saveFileChanges
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aaadd413f259419b198483c7e55b78054"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::shortPath" ref="aaadd413f259419b198483c7e55b78054" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::shortPath </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-shortPath' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-shortPath-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-shortPath-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-shortPath-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in shortPath: 8</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#aaadd413f259419b198483c7e55b78054">shortPath</a> {
  my $self = shift; my $file = shift;
  my $tmpl = $self-&gt;r-&gt;ce-&gt;{courseDirs}{templates};
  my $root = $self-&gt;r-&gt;ce-&gt;{courseDirs}{root};
  my $ww = $self-&gt;r-&gt;ce-&gt;{webworkDirs}{root};
  $file =~ s|^$tmpl|[TMPL]|; $file =~ s|^$root|[COURSE]|; $file =~ s|^$ww|[WW]|;
  <span class="keywordflow">return</span> $file;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a2670d9a9d68115f2fe7d155c422791fb"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::title" ref="a2670d9a9d68115f2fe7d155c422791fb" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::title </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-title' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-title-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-title-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-title-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in title: 15</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2670d9a9d68115f2fe7d155c422791fb">title</a> {
    my $self = shift;
    my $r = $self-&gt;r;
    my $courseName    = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
    my $setID         = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
    my $problemNumber = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;problemID&quot;</span>);
    my $file_type = $self-&gt;{<span class="stringliteral">&#39;file_type&#39;</span>} || <span class="stringliteral">&#39;&#39;</span>;

    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Set Header for  set $setID&quot;</span> <span class="keywordflow">if</span> ($file_type eq <span class="stringliteral">&#39;set_header&#39;</span>);
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Hardcopy Header for set $setID&quot;</span> <span class="keywordflow">if</span> ($file_type eq <span class="stringliteral">&#39;hardcopy_header&#39;</span>);
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Course Information for course $courseName&quot;</span> <span class="keywordflow">if</span> ($file_type eq <span class="stringliteral">&#39;course_info&#39;</span>);
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Options Information&quot;</span> <span class="keywordflow">if</span> ($file_type eq <span class="stringliteral">&#39;options_info&#39;</span>);

    <span class="keywordflow">return</span> <span class="stringliteral">&#39;Problem &#39;</span> . $r-&gt;{urlpath}-&gt;name;
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1ContentGenerator.html#ad83c346d1b3f70cf42ba4debe6239c9f">WeBWorK::ContentGenerator</a>.</p>

</div>
</div>
<a class="anchor" id="a2bc5183b8cb0ca2a4e9fb4d005a242dc"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::view_form" ref="a2bc5183b8cb0ca2a4e9fb4d005a242dc" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::view_form </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-view_form' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-view_form-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-view_form-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-view_form-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in view_form: 20</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#a2bc5183b8cb0ca2a4e9fb4d005a242dc">view_form</a> {
    my ($self, $onChange, %actionParams) = @_;
    my $file_type     = $self-&gt;{file_type};
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span>    $file_type eq <span class="stringliteral">&#39;hardcopy_header&#39;</span>;  # these can<span class="stringliteral">&#39;t yet be edited from temporary files #FIXME</span>
<span class="stringliteral">    my $output_string = &quot;&quot;;</span>
<span class="stringliteral">    unless ($file_type eq &#39;</span>course_info<span class="stringliteral">&#39; || $file_type eq &#39;</span>options_info<span class="stringliteral">&#39;) {</span>
<span class="stringliteral"></span>
<span class="stringliteral">        $output_string .= join(&quot; &quot;,</span>
<span class="stringliteral">            # &quot;Use what seed?: &quot;,</span>
<span class="stringliteral">            # CGI::textfield(-name=&gt;&#39;</span>action.view.seed<span class="stringliteral">&#39;,-value=&gt;$self-&gt;{problemSeed},-onfocus=&gt;$onChange),</span>
<span class="stringliteral">            WeBWorK::CGI_labeled_input(-type=&gt;&quot;text&quot;, -id=&gt;&quot;action_view_seed_id&quot;, -label_text=&gt;&quot;Using what seed?: &quot;, -input_attr=&gt;{-name=&gt;&#39;</span>action.view.seed<span class="stringliteral">&#39;,-value=&gt;$self-&gt;{problemSeed},-onfocus=&gt;$onChange}),CGI::br(),</span>
<span class="stringliteral">            # &quot;and display mode &quot;,</span>
<span class="stringliteral">            # CGI::popup_menu(-name=&gt;&#39;</span>action.view.displayMode<span class="stringliteral">&#39;, -values=&gt;$self-&gt;r-&gt;ce-&gt;{pg}-&gt;{displayModes}, </span>
<span class="stringliteral">              # -default=&gt;$self-&gt;{displayMode}, -onmousedown=&gt;$onChange)</span>
<span class="stringliteral">            WeBWorK::CGI_labeled_input(-type=&gt;&quot;select&quot;, -id=&gt;&quot;action_view_displayMode_id&quot;, -label_text=&gt;&quot;Using what display mode?: &quot;, -input_attr=&gt;{-name=&gt;&#39;</span>action.view.displayMode<span class="stringliteral">&#39;, -values=&gt;$self-&gt;r-&gt;ce-&gt;{pg}-&gt;{displayModes}, -default=&gt;$self-&gt;{displayMode}, -onmousedown=&gt;$onChange}),CGI::br(),</span>
<span class="stringliteral">        );</span>
<span class="stringliteral">    }</span>
<span class="stringliteral"></span>
<span class="stringliteral">    return $output_string;  #FIXME  add -labels to the pop up menu</span>
<span class="stringliteral">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="acb746e654fb81f6d32f621e5a848faaa"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::view_handler" ref="acb746e654fb81f6d32f621e5a848faaa" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::PGProblemEditor2::view_handler </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-view_handler' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-view_handler-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-view_handler-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-view_handler-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in view_handler: 128</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#acb746e654fb81f6d32f621e5a848faaa">view_handler</a> {
    my ($self, $genericParams, $actionParams, $tableParams) = @_;
    my $r = $self-&gt;r;
    my $courseName      =  $self-&gt;{courseID};
    my $setName         =  $self-&gt;{setID};
    my $fullSetName     =  $self-&gt;{fullSetID};
    my $problemNumber   =  $self-&gt;{problemID};
    my $problemSeed     = ($actionParams-&gt;{<span class="stringliteral">&#39;action.view.seed&#39;</span>}) ? 
                                    $actionParams-&gt;{<span class="stringliteral">&#39;action.view.seed&#39;</span>}-&gt;[0] 
                                    : DEFAULT_SEED();
    my $displayMode     = ($actionParams-&gt;{<span class="stringliteral">&#39;action.view.displayMode&#39;</span>}) ? 
                                    $actionParams-&gt;{<span class="stringliteral">&#39;action.view.displayMode&#39;</span>}-&gt;[0]  
                                    : $self-&gt;r-&gt;ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};
                                    
    my $editFilePath        = $self-&gt;{editFilePath};
    my $tempFilePath        = $self-&gt;{tempFilePath};
<span class="preprocessor">    ########################################################                               </span>
<span class="preprocessor"></span><span class="preprocessor">    # grab the problemContents from the form in order to save it to the tmp file</span>
<span class="preprocessor"></span><span class="preprocessor">    ######################################################## </span>
<span class="preprocessor"></span>    my $problemContents     = <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1PGProblemEditor2.html#ace9ad8ee32d78fc044edc35d75defdfd">fixProblemContents</a>($self-&gt;r-&gt;param(<span class="stringliteral">&#39;problemContents&#39;</span>));
    $self-&gt;{r_problemContents}    = \$problemContents;
    

    my $do_not_save = 0;
    my $file_type = $self-&gt;{file_type};                               
    $self-&gt;saveFileChanges($tempFilePath,);

<span class="preprocessor">    ########################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # construct redirect URL and redirect</span>
<span class="preprocessor"></span><span class="preprocessor">    ########################################################</span>
<span class="preprocessor"></span>    my $edit_level = $self-&gt;r-&gt;param(<span class="stringliteral">&quot;edit_level&quot;</span>) || 0;
    $edit_level++;
    my $viewURL;
    
    my $relativeTempFilePath = $self-&gt;getRelativeSourceFilePath($tempFilePath);
    
    <span class="keywordflow">if</span> ($file_type eq <span class="stringliteral">&#39;problem&#39;</span> or $file_type eq <span class="stringliteral">&#39;source_path_for_problem_file&#39;</span>) { # redirect to Problem.pm or GatewayQuiz.pm

<span class="preprocessor">        # we need to know if the set is a gateway set to determine the redirect</span>
<span class="preprocessor"></span>        my $globalSet = $self-&gt;r-&gt;db-&gt;getGlobalSet( $setName );

        my $problemPage;
        <span class="keywordflow">if</span> ( defined($globalSet) &amp;&amp; $globalSet-&gt;assignment_type =~ /gateway/ ) {
            $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::GatewayQuiz&quot;</span>,$r,
            courseID =&gt; $courseName, setID =&gt; <span class="stringliteral">&quot;Undefined_Set&quot;</span>);
        }  <span class="keywordflow">else</span> {
            $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Problem&quot;</span>,$r,
                                    courseID =&gt; $courseName, setID =&gt; $setName, problemID =&gt; $problemNumber
            );
        }

        $viewURL = $self-&gt;systemLink($problemPage,
            params =&gt; {
                displayMode        =&gt; $displayMode,
                problemSeed        =&gt; $problemSeed,
                editMode           =&gt; <span class="stringliteral">&quot;temporaryFile&quot;</span>,
                edit_level         =&gt; $edit_level,
                sourceFilePath     =&gt; $relativeTempFilePath,
                status_message     =&gt; uri_escape($self-&gt;{status_message})
    
            }
        );
    } elsif ($file_type eq <span class="stringliteral">&#39;set_header&#39;</span> ) { # redirect to ProblemSet
        my $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::ProblemSet&quot;</span>,$r,
            courseID =&gt; $courseName, setID =&gt; $setName, 
        );
        
        $viewURL = $self-&gt;systemLink($problemPage,
            params =&gt; {
                set_header         =&gt; $tempFilePath,
                displayMode        =&gt; $displayMode,
                problemSeed        =&gt; $problemSeed,
                editMode           =&gt; <span class="stringliteral">&quot;temporaryFile&quot;</span>,
                edit_level         =&gt; $edit_level,
                sourceFilePath     =&gt; $relativeTempFilePath,
                status_message     =&gt; uri_escape($self-&gt;{status_message})
    
            }
        );  
    } elsif ($file_type eq <span class="stringliteral">&#39;hardcopy_header&#39;</span>) { # redirect to ProblemSet?? # it<span class="stringliteral">&#39;s difficult to view temporary changes for hardcopy headers</span>
<span class="stringliteral">        my $problemPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::ProblemSet&quot;,$r,</span>
<span class="stringliteral">            courseID =&gt; $courseName, setID =&gt; $setName, </span>
<span class="stringliteral">        );</span>
<span class="stringliteral">        </span>
<span class="stringliteral">        $viewURL = $self-&gt;systemLink($problemPage,</span>
<span class="stringliteral">            params =&gt; {</span>
<span class="stringliteral">                set_header         =&gt; $tempFilePath,</span>
<span class="stringliteral">                displayMode        =&gt; $displayMode,</span>
<span class="stringliteral">                problemSeed        =&gt; $problemSeed,</span>
<span class="stringliteral">                editMode           =&gt; &quot;temporaryFile&quot;,</span>
<span class="stringliteral">                edit_level         =&gt; $edit_level,</span>
<span class="stringliteral">                sourceFilePath     =&gt; $relativeTempFilePath,</span>
<span class="stringliteral">                status_message     =&gt; uri_escape($self-&gt;{status_message})</span>
<span class="stringliteral">    </span>
<span class="stringliteral">            }</span>
<span class="stringliteral">        );  </span>
<span class="stringliteral">    </span>
<span class="stringliteral">    } elsif ($file_type eq &#39;</span>course_info<span class="stringliteral">&#39;) {  # redirec to ProblemSets.pm</span>
<span class="stringliteral">        my $problemSetsPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::ProblemSets&quot;,$r,</span>
<span class="stringliteral">            courseID =&gt; $courseName);</span>
<span class="stringliteral">        $viewURL = $self-&gt;systemLink($problemSetsPage,</span>
<span class="stringliteral">            params =&gt; {</span>
<span class="stringliteral"></span>
<span class="stringliteral">                course_info        =&gt; $tempFilePath,</span>
<span class="stringliteral">                editMode           =&gt; &quot;temporaryFile&quot;,</span>
<span class="stringliteral">                edit_level         =&gt; $edit_level,</span>
<span class="stringliteral">                sourceFilePath     =&gt; $relativeTempFilePath,</span>
<span class="stringliteral">                status_message     =&gt; uri_escape($self-&gt;{status_message})</span>
<span class="stringliteral">            }</span>
<span class="stringliteral">        );</span>
<span class="stringliteral">    } elsif ($file_type eq &#39;</span>options_info<span class="stringliteral">&#39;) {  # redirec to Options.pm</span>
<span class="stringliteral">        my $optionsPage = $self-&gt;r-&gt;urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Options&quot;,$r,</span>
<span class="stringliteral">            courseID =&gt; $courseName);</span>
<span class="stringliteral">        $viewURL = $self-&gt;systemLink($optionsPage,</span>
<span class="stringliteral">            params =&gt; {</span>
<span class="stringliteral">                options_info       =&gt; $tempFilePath,</span>
<span class="stringliteral">                editMode           =&gt; &quot;temporaryFile&quot;,</span>
<span class="stringliteral">                edit_level         =&gt; $edit_level,</span>
<span class="stringliteral">                sourceFilePath     =&gt; $relativeTempFilePath,</span>
<span class="stringliteral">                status_message     =&gt; uri_escape($self-&gt;{status_message})</span>
<span class="stringliteral">            }</span>
<span class="stringliteral">        );</span>
<span class="stringliteral">    } else {</span>
<span class="stringliteral">        die &quot;I don&#39;</span>t know how to redirect <span class="keyword">this</span> file type $file_type <span class="stringliteral">&quot;;</span>
<span class="stringliteral">    }</span>
<span class="stringliteral"></span>
<span class="stringliteral">    $self-&gt;reply_with_redirect($viewURL);</span>
<span class="stringliteral">} </span>
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="PGProblemEditor2_8pm_source.html">PGProblemEditor2.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:57:43 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
