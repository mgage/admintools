<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: Problem.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>Problem.pm</h1><a href="ContentGenerator_2Problem_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/Problem.pm,v 1.225 2010/05/28 21:29:48 gage Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::Problem;
<a name="l00018"></a>00018 use base qw(<a class="code" href="classWeBWorK.html">WeBWorK</a>);
<a name="l00019"></a>00019 <span class="preprocessor">#use base qw(WeBWorK::ContentGenerator);</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span>use base qw(WeBWorK::ContentGenerator::ProblemUtil::ProblemUtil);  # not needed?
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 =head1 NAME
<a name="l00023"></a>00023  
<a name="l00024"></a>00024 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Problem.html">WeBWorK::ContentGenerator::Problem</a> - Allow a student to interact with a problem.
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 =cut
<a name="l00027"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Problem.html">00027</a> 
<a name="l00028"></a>00028 use strict;
<a name="l00029"></a>00029 use warnings;
<a name="l00030"></a>00030 <span class="preprocessor">#use CGI qw(-nosticky );</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00032"></a>00032 use File::Path qw(rmtree);
<a name="l00033"></a>00033 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00034"></a>00034 use <a class="code" href="classWeBWorK_1_1Form.html">WeBWorK::Form</a>;
<a name="l00035"></a>00035 use <a class="code" href="classWeBWorK_1_1PG.html">WeBWorK::PG</a>;
<a name="l00036"></a>00036 use WeBWorK::PG::ImageGenerator;
<a name="l00037"></a>00037 use WeBWorK::PG::IO;
<a name="l00038"></a>00038 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(readFile writeLog writeCourseLog encodeAnswers decodeAnswers
<a name="l00039"></a>00039     ref2string makeTempDirectory path_is_subdir sortByName before after between);
<a name="l00040"></a>00040 use <a class="code" href="classWeBWorK_1_1DB_1_1Utils.html">WeBWorK::DB::Utils</a> qw(global2user user2global);
<a name="l00041"></a>00041 use URI::Escape;
<a name="l00042"></a>00042 use <a class="code" href="classWeBWorK_1_1Localize.html">WeBWorK::Localize</a>;
<a name="l00043"></a>00043 use <a class="code" href="classWeBWorK_1_1Utils_1_1Tasks.html">WeBWorK::Utils::Tasks</a> qw(fake_set fake_problem);
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">################################################################################</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span><span class="preprocessor"># CGI param interface to this module (up-to-date as of v1.153)</span>
<a name="l00047"></a>00047 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>
<a name="l00049"></a>00049 <span class="preprocessor"># Standard params:</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00051"></a>00051 <span class="preprocessor"></span><span class="preprocessor">#     user - user ID of real user</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor">#     key - session key</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">#     effectiveUser - user ID of effective user</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor"># Integration with PGProblemEditor:</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor">#     editMode - if set, indicates alternate problem source location.</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#                can be &quot;temporaryFile&quot; or &quot;savedFile&quot;.</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00060"></a>00060 <span class="preprocessor"></span><span class="preprocessor">#     sourceFilePath - path to file to be edited</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#     problemSeed - force problem seed to value</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor">#     success - success message to display</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span><span class="preprocessor">#     failure - failure message to display</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor"># Rendering options:</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">#     displayMode - name of display mode to use</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#     </span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#     showOldAnswers - request that last entered answer be shown (if allowed)</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#     showCorrectAnswers - request that correct answers be shown (if allowed)</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span><span class="preprocessor">#     showHints - request that hints be shown (if allowed)</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#     showSolutions - request that solutions be shown (if allowed)</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00074"></a>00074 <span class="preprocessor"></span><span class="preprocessor"># Problem interaction:</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#     AnSwEr# - answer blanks in problem</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#     </span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#     redisplay - name of the &quot;Redisplay Problem&quot; button</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#     submitAnswers - name of &quot;Submit Answers&quot; button</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="preprocessor">#     checkAnswers - name of the &quot;Check Answers&quot; button</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#     previewAnswers - name of the &quot;Preview Answers&quot; button</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>
<a name="l00083"></a>00083 <span class="preprocessor">################################################################################</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="preprocessor"># &quot;can&quot; methods</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>
<a name="l00087"></a>00087 <span class="preprocessor"># Subroutines to determine if a user &quot;can&quot; perform an action. Each subroutine is</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span><span class="preprocessor"># called with the following arguments:</span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00090"></a>00090 <span class="preprocessor"></span><span class="preprocessor">#     ($self, $User, $EffectiveUser, $Set, $Problem)</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>
<a name="l00092"></a>00092 <span class="preprocessor"># Note that significant parts of the &quot;can&quot; methods are lifted into the </span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor"># GatewayQuiz module.  It isn&#39;t direct, however, because of the necessity</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor"># of dealing with versioning there.</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>
<a name="l00096"></a>00096 sub can_showOldAnswers {
<a name="l00097"></a>00097 <span class="preprocessor">    #my ($self, $User, $EffectiveUser, $Set, $Problem) = @_;</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>    
<a name="l00099"></a>00099     <span class="keywordflow">return</span> 1;
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00102"></a>00102 sub can_showCorrectAnswers {
<a name="l00103"></a>00103     my ($self, $User, $EffectiveUser, $Set, $Problem) = @_;
<a name="l00104"></a>00104     my $authz = $self-&gt;r-&gt;authz;
<a name="l00105"></a>00105     
<a name="l00106"></a>00106     <span class="keywordflow">return</span>
<a name="l00107"></a>00107         after($Set-&gt;answer_date)
<a name="l00108"></a>00108             ||
<a name="l00109"></a>00109         $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;show_correct_answers_before_answer_date&quot;</span>)
<a name="l00110"></a>00110         ;
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a>00113 sub can_showHints {
<a name="l00114"></a>00114 <span class="preprocessor">    #my ($self, $User, $EffectiveUser, $Set, $Problem) = @_;</span>
<a name="l00115"></a>00115 <span class="preprocessor"></span>    
<a name="l00116"></a>00116     <span class="keywordflow">return</span> 1;
<a name="l00117"></a>00117 }
<a name="l00118"></a>00118 
<a name="l00119"></a>00119 sub can_showSolutions {
<a name="l00120"></a>00120     my ($self, $User, $EffectiveUser, $Set, $Problem) = @_;
<a name="l00121"></a>00121     my $authz = $self-&gt;r-&gt;authz;
<a name="l00122"></a>00122     
<a name="l00123"></a>00123     <span class="keywordflow">return</span>
<a name="l00124"></a>00124         after($Set-&gt;answer_date)
<a name="l00125"></a>00125             ||
<a name="l00126"></a>00126         $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;show_solutions_before_answer_date&quot;</span>)
<a name="l00127"></a>00127         ;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 sub can_recordAnswers {
<a name="l00131"></a>00131     my ($self, $User, $EffectiveUser, $Set, $Problem, $submitAnswers) = @_;
<a name="l00132"></a>00132     my $authz = $self-&gt;r-&gt;authz;
<a name="l00133"></a>00133     my $thisAttempt = $submitAnswers ? 1 : 0;
<a name="l00134"></a>00134     <span class="keywordflow">if</span> ($User-&gt;user_id ne $EffectiveUser-&gt;user_id) {
<a name="l00135"></a>00135         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_when_acting_as_student&quot;</span>);
<a name="l00136"></a>00136     }
<a name="l00137"></a>00137     <span class="keywordflow">if</span> (before($Set-&gt;open_date)) {
<a name="l00138"></a>00138         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_before_open_date&quot;</span>);
<a name="l00139"></a>00139     } elsif (between($Set-&gt;open_date, $Set-&gt;due_date)) {
<a name="l00140"></a>00140         my $max_attempts = $Problem-&gt;max_attempts;
<a name="l00141"></a>00141         my $attempts_used = $Problem-&gt;num_correct + $Problem-&gt;num_incorrect + $thisAttempt;
<a name="l00142"></a>00142         <span class="keywordflow">if</span> ($max_attempts == -1 or $attempts_used &lt; $max_attempts) {
<a name="l00143"></a>00143             <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_open_date_with_attempts&quot;</span>);
<a name="l00144"></a>00144         } <span class="keywordflow">else</span> {
<a name="l00145"></a>00145             <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_open_date_without_attempts&quot;</span>);
<a name="l00146"></a>00146         }
<a name="l00147"></a>00147     } elsif (between($Set-&gt;due_date, $Set-&gt;answer_date)) {
<a name="l00148"></a>00148         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_due_date&quot;</span>);
<a name="l00149"></a>00149     } elsif (after($Set-&gt;answer_date)) {
<a name="l00150"></a>00150         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_answer_date&quot;</span>);
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152 }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154 sub can_checkAnswers {
<a name="l00155"></a>00155     my ($self, $User, $EffectiveUser, $Set, $Problem, $submitAnswers) = @_;
<a name="l00156"></a>00156     my $authz = $self-&gt;r-&gt;authz;
<a name="l00157"></a>00157     my $thisAttempt = $submitAnswers ? 1 : 0;
<a name="l00158"></a>00158     
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (before($Set-&gt;open_date)) {
<a name="l00160"></a>00160         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_before_open_date&quot;</span>);
<a name="l00161"></a>00161     } elsif (between($Set-&gt;open_date, $Set-&gt;due_date)) {
<a name="l00162"></a>00162         my $max_attempts = $Problem-&gt;max_attempts;
<a name="l00163"></a>00163         my $attempts_used = $Problem-&gt;num_correct + $Problem-&gt;num_incorrect + $thisAttempt;
<a name="l00164"></a>00164         <span class="keywordflow">if</span> ($max_attempts == -1 or $attempts_used &lt; $max_attempts) {
<a name="l00165"></a>00165             <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_open_date_with_attempts&quot;</span>);
<a name="l00166"></a>00166         } <span class="keywordflow">else</span> {
<a name="l00167"></a>00167             <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_open_date_without_attempts&quot;</span>);
<a name="l00168"></a>00168         }
<a name="l00169"></a>00169     } elsif (between($Set-&gt;due_date, $Set-&gt;answer_date)) {
<a name="l00170"></a>00170         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_due_date&quot;</span>);
<a name="l00171"></a>00171     } elsif (after($Set-&gt;answer_date)) {
<a name="l00172"></a>00172         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_answer_date&quot;</span>);
<a name="l00173"></a>00173     }
<a name="l00174"></a>00174 }
<a name="l00175"></a>00175 
<a name="l00176"></a>00176 <span class="preprocessor"># Reset the default in some cases</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span>sub set_showOldAnswers_default {
<a name="l00178"></a>00178     my ($self, $ce, $userName, $authz, $set) = @_;
<a name="l00179"></a>00179 <span class="preprocessor">    # these people always use the system/course default, so don&#39;t</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="preprocessor">    # override the value of ...-&gt;{showOldAnswers}</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;can_always_use_show_old_answers_default&quot;</span>);
<a name="l00182"></a>00182 <span class="preprocessor">    # this person should always default to 0</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>    $ce-&gt;{pg}-&gt;{options}-&gt;{showOldAnswers} = 0
<a name="l00184"></a>00184         unless ($authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;can_show_old_answers_by_default&quot;</span>));
<a name="l00185"></a>00185 <span class="preprocessor">    # we are after the due date, so default to not showing it</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span>    $ce-&gt;{pg}-&gt;{options}-&gt;{showOldAnswers} = 0 <span class="keywordflow">if</span> $set-&gt;{due_date} &amp;&amp; after($set-&gt;{due_date});
<a name="l00187"></a>00187 }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="preprocessor">################################################################################</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="preprocessor"># output utilities</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>
<a name="l00193"></a>00193 <span class="preprocessor"># Note: the substance of attemptResults is lifted into GatewayQuiz.pm,</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span><span class="preprocessor"># with some changes to the output format</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>
<a name="l00196"></a>00196 sub attemptResults {
<a name="l00197"></a>00197     my $self = shift;
<a name="l00198"></a>00198     my $r = $self-&gt;r;
<a name="l00199"></a>00199     my $pg = shift;
<a name="l00200"></a>00200     my $showAttemptAnswers = shift;
<a name="l00201"></a>00201     my $showCorrectAnswers = shift;
<a name="l00202"></a>00202     my $showAttemptResults = $showAttemptAnswers &amp;&amp; shift;
<a name="l00203"></a>00203     my $showSummary = shift;
<a name="l00204"></a>00204     my $showAttemptPreview = shift || 0;
<a name="l00205"></a>00205     
<a name="l00206"></a>00206     my $ce = $self-&gt;r-&gt;ce;
<a name="l00207"></a>00207     
<a name="l00208"></a>00208 <span class="preprocessor">    # for color coding the responses.</span>
<a name="l00209"></a>00209 <span class="preprocessor"></span>    my @correct_ids = ();
<a name="l00210"></a>00210     my @incorrect_ids = ();
<a name="l00211"></a>00211 
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     my $problemResult = $pg-&gt;{result}; # the overall result of the problem
<a name="l00214"></a>00214     my @answerNames = @{ $pg-&gt;{flags}-&gt;{ANSWER_ENTRY_ORDER} };
<a name="l00215"></a>00215     
<a name="l00216"></a>00216     my $showMessages = $showAttemptAnswers &amp;&amp; grep { $pg-&gt;{answers}-&gt;{$_}-&gt;{ans_message} } @answerNames;
<a name="l00217"></a>00217     
<a name="l00218"></a>00218     my $basename = <span class="stringliteral">&quot;equation-&quot;</span> . $self-&gt;{<span class="keyword">set</span>}-&gt;psvn. <span class="stringliteral">&quot;.&quot;</span> . $self-&gt;{problem}-&gt;problem_id . <span class="stringliteral">&quot;-preview&quot;</span>;
<a name="l00219"></a>00219     
<a name="l00220"></a>00220 <span class="preprocessor">    # to make grabbing these options easier, we&#39;ll pull them out now...</span>
<a name="l00221"></a>00221 <span class="preprocessor"></span>    my %imagesModeOptions = %{$ce-&gt;{pg}-&gt;{displayModeOptions}-&gt;{images}};
<a name="l00222"></a>00222     
<a name="l00223"></a>00223     my $imgGen = WeBWorK::PG::ImageGenerator-&gt;new(
<a name="l00224"></a>00224         tempDir         =&gt; $ce-&gt;{webworkDirs}-&gt;{tmp},
<a name="l00225"></a>00225         latex           =&gt; $ce-&gt;{externalPrograms}-&gt;{latex},
<a name="l00226"></a>00226         dvipng          =&gt; $ce-&gt;{externalPrograms}-&gt;{dvipng},
<a name="l00227"></a>00227         useCache        =&gt; 1,
<a name="l00228"></a>00228         cacheDir        =&gt; $ce-&gt;{webworkDirs}-&gt;{equationCache},
<a name="l00229"></a>00229         cacheURL        =&gt; $ce-&gt;{webworkURLs}-&gt;{equationCache},
<a name="l00230"></a>00230         cacheDB         =&gt; $ce-&gt;{webworkFiles}-&gt;{equationCacheDB},
<a name="l00231"></a>00231         dvipng_align    =&gt; $imagesModeOptions{dvipng_align},
<a name="l00232"></a>00232         dvipng_depth_db =&gt; $imagesModeOptions{dvipng_depth_db},
<a name="l00233"></a>00233     );
<a name="l00234"></a>00234     
<a name="l00235"></a>00235     my $showEvaluatedAnswers = $ce-&gt;{pg}-&gt;{options}-&gt;{showEvaluatedAnswers};
<a name="l00236"></a>00236 
<a name="l00237"></a>00237     my $header;
<a name="l00238"></a>00238 <span class="preprocessor">    #$header .= CGI::th(&quot;Part&quot;);</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($showEvaluatedAnswers) {
<a name="l00240"></a>00240         $header .= $showAttemptAnswers ? CGI::th($r-&gt;maketext(<span class="stringliteral">&quot;Entered&quot;</span>))  : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00241"></a>00241     }   
<a name="l00242"></a>00242     $header .= $showAttemptPreview ? CGI::th($r-&gt;maketext(<span class="stringliteral">&quot;Answer Preview&quot;</span>))  : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00243"></a>00243     $header .= $showCorrectAnswers ? CGI::th($r-&gt;maketext(<span class="stringliteral">&quot;Correct&quot;</span>))  : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00244"></a>00244     $header .= $showAttemptResults ? CGI::th($r-&gt;maketext(<span class="stringliteral">&quot;Result&quot;</span>))   : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00245"></a>00245     $header .= $showMessages       ? CGI::th($r-&gt;maketext(<span class="stringliteral">&quot;Messages&quot;</span>)) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00246"></a>00246     my $fully = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00247"></a>00247     my @tableRows = ( $header );
<a name="l00248"></a>00248     my $numCorrect = 0;
<a name="l00249"></a>00249     my $numBlanks  =0;
<a name="l00250"></a>00250     my $tthPreambleCache;
<a name="l00251"></a>00251     <span class="keywordflow">foreach</span> my $name (@answerNames) {
<a name="l00252"></a>00252         my $answerResult  = $pg-&gt;{answers}-&gt;{$name};
<a name="l00253"></a>00253         my $studentAnswer = $answerResult-&gt;{student_ans}; # original_student_ans
<a name="l00254"></a>00254         my $preview       = ($showAttemptPreview
<a name="l00255"></a>00255                                 ? $self-&gt;previewAnswer($answerResult, $imgGen, \$tthPreambleCache)
<a name="l00256"></a>00256                                 : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00257"></a>00257         my $correctAnswerPreview = $self-&gt;previewCorrectAnswer($answerResult, $imgGen, \$tthPreambleCache);
<a name="l00258"></a>00258         my $correctAnswer = $answerResult-&gt;{correct_ans};
<a name="l00259"></a>00259         my $answerScore   = $answerResult-&gt;{score};
<a name="l00260"></a>00260         my $answerMessage = $showMessages ? $answerResult-&gt;{ans_message} : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00261"></a>00261         $answerMessage =~ s/\n/&lt;BR&gt;/g;
<a name="l00262"></a>00262         $numCorrect += $answerScore &gt;= 1;
<a name="l00263"></a>00263         $numBlanks++ unless $studentAnswer =~/\S/ || $answerScore &gt;= 1;   # unless student answer contains entry
<a name="l00264"></a>00264         my $resultString = $answerScore &gt;= 1 ? CGI::span({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithoutError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Correct&quot;</span>)) :
<a name="l00265"></a>00265                            $answerScore &gt; 0  ? $r-&gt;maketext(<span class="stringliteral">&quot;[_1]% correct&quot;</span>, <span class="keywordtype">int</span>($answerScore*100)) :
<a name="l00266"></a>00266                                                        CGI::span({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Incorrect&quot;</span>));
<a name="l00267"></a>00267         $fully = $r-&gt;maketext(<span class="stringliteral">&quot;completely&quot;</span>) <span class="keywordflow">if</span> $answerScore &gt;0 and $answerScore &lt; 1;
<a name="l00268"></a>00268         
<a name="l00269"></a>00269         push @correct_ids,   $name <span class="keywordflow">if</span> $answerScore == 1;
<a name="l00270"></a>00270         push @incorrect_ids, $name <span class="keywordflow">if</span> $answerScore &lt; 1;
<a name="l00271"></a>00271         
<a name="l00272"></a>00272 <span class="preprocessor">        # need to capture auxiliary answers as well and identify their ids.</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span>        
<a name="l00274"></a>00274         
<a name="l00275"></a>00275         my $row;
<a name="l00276"></a>00276 <span class="preprocessor">        #$row .= CGI::td($name);</span>
<a name="l00277"></a>00277 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ($showEvaluatedAnswers) {
<a name="l00278"></a>00278           $row .= $showAttemptAnswers ? CGI::td($self-&gt;nbsp($studentAnswer)) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00279"></a>00279         }
<a name="l00280"></a>00280         $row .= $showAttemptPreview ? CGI::td({onmouseover=&gt;qq!Tip(<span class="stringliteral">&#39;$studentAnswer&#39;</span>,SHADOW, <span class="keyword">true</span>, 
<a name="l00281"></a>00281                             DELAY, 1000, FADEIN, 300, FADEOUT, 300, STICKY, 1, OFFSETX, -20, CLOSEBTN, <span class="keyword">true</span>, CLICKCLOSE, <span class="keyword">false</span>, 
<a name="l00282"></a>00282                             BGCOLOR, <span class="stringliteral">&#39;#F4FF91&#39;</span>, TITLE, <span class="stringliteral">&#39;Entered:&#39;</span>,TITLEBGCOLOR, <span class="stringliteral">&#39;#F4FF91&#39;</span>, TITLEFONTCOLOR, <span class="stringliteral">&#39;#000000&#39;</span>)!},
<a name="l00283"></a>00283                             $self-&gt;nbsp($preview))       : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00284"></a>00284         $row .= $showCorrectAnswers ? CGI::td({onmouseover=&gt; qq!Tip(<span class="stringliteral">&#39;$correctAnswer&#39;</span>,SHADOW, <span class="keyword">true</span>, 
<a name="l00285"></a>00285                             DELAY, 1000, FADEIN, 300, FADEOUT, 300, STICKY, 1, OFFSETX, -20, CLOSEBTN, <span class="keyword">true</span>, CLICKCLOSE, <span class="keyword">false</span>, 
<a name="l00286"></a>00286                             BGCOLOR, <span class="stringliteral">&#39;#F4FF91&#39;</span>, TITLE, <span class="stringliteral">&#39;Entered:&#39;</span>,TITLEBGCOLOR, <span class="stringliteral">&#39;#F4FF91&#39;</span>, TITLEFONTCOLOR, <span class="stringliteral">&#39;#000000&#39;</span>)!},
<a name="l00287"></a>00287                           $self-&gt;nbsp($correctAnswerPreview)) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00288"></a>00288         $row .= $showAttemptResults ? CGI::td($self-&gt;nbsp($resultString))  : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00289"></a>00289         $row .= $showMessages       ? CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;Message&quot;</span>},$self-&gt;nbsp($answerMessage)) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00290"></a>00290         push @tableRows, $row;
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292     
<a name="l00293"></a>00293 <span class="preprocessor">    # render equation images</span>
<a name="l00294"></a>00294 <span class="preprocessor"></span>    $imgGen-&gt;render(refresh =&gt; 1);
<a name="l00295"></a>00295     
<a name="l00296"></a>00296 <span class="preprocessor">#   my $numIncorrectNoun = scalar @answerNames == 1 ? &quot;question&quot; : &quot;questions&quot;;</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>    my $scorePercent = sprintf(<span class="stringliteral">&quot;%.0f%%&quot;</span>, $problemResult-&gt;{score} * 100);
<a name="l00298"></a>00298 <span class="preprocessor">#   FIXME  -- I left the old code in in case we have to back out.</span>
<a name="l00299"></a>00299 <span class="preprocessor"></span><span class="preprocessor">#   my $summary = &quot;On this attempt, you answered $numCorrect out of &quot;</span>
<a name="l00300"></a>00300 <span class="preprocessor"></span><span class="preprocessor">#       . scalar @answerNames . &quot; $numIncorrectNoun correct, for a score of $scorePercent.&quot;;</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>    my $summary = <span class="stringliteral">&quot;&quot;</span>; 
<a name="l00302"></a>00302     unless (defined($problemResult-&gt;{summary}) and $problemResult-&gt;{summary} =~ /\S/) {
<a name="l00303"></a>00303         <span class="keywordflow">if</span> (scalar @answerNames == 1) {  #<span class="keywordflow">default</span> messages
<a name="l00304"></a>00304                 <span class="keywordflow">if</span> ($numCorrect == scalar @answerNames) {
<a name="l00305"></a>00305                     $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithoutError&quot;</span>},$r-&gt;maketext(<span class="stringliteral">&quot;The answer above is correct.&quot;</span>));
<a name="l00306"></a>00306                  } <span class="keywordflow">else</span> {
<a name="l00307"></a>00307                      $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>},$r-&gt;maketext(<span class="stringliteral">&quot;The answer above is NOT [_1]correct.&quot;</span>, $fully));
<a name="l00308"></a>00308                  }
<a name="l00309"></a>00309         } <span class="keywordflow">else</span> {
<a name="l00310"></a>00310                 <span class="keywordflow">if</span> ($numCorrect == scalar @answerNames) {
<a name="l00311"></a>00311                     $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithoutError&quot;</span>},$r-&gt;maketext(<span class="stringliteral">&quot;All of the answers above are correct.&quot;</span>));
<a name="l00312"></a>00312                  } 
<a name="l00313"></a>00313 <span class="preprocessor">                 #unless ($numCorrect + $numBlanks == scalar( @answerNames)) { # this allowed you to figure out if you got one answer right.</span>
<a name="l00314"></a>00314 <span class="preprocessor"></span>                 elsif ($numBlanks != scalar( @answerNames)) {
<a name="l00315"></a>00315                     $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>},$r-&gt;maketext(<span class="stringliteral">&quot;At least one of the answers above is NOT [_1]correct.&quot;</span>, $fully));
<a name="l00316"></a>00316                  }
<a name="l00317"></a>00317                  <span class="keywordflow">if</span> ($numBlanks) {
<a name="l00318"></a>00318                     my $s = ($numBlanks&gt;1)?<span class="stringliteral">&#39;&#39;</span>:<span class="charliteral">&#39;s&#39;</span>;
<a name="l00319"></a>00319                     $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsAlert&quot;</span>},$r-&gt;maketext(<span class="stringliteral">&quot;[quant,_1,of the questions remains,of the questions remain] unanswered.&quot;</span>, $numBlanks));
<a name="l00320"></a>00320                  }
<a name="l00321"></a>00321         }
<a name="l00322"></a>00322     } <span class="keywordflow">else</span> {
<a name="l00323"></a>00323         $summary = $problemResult-&gt;{summary};   # summary has been defined by grader
<a name="l00324"></a>00324     }
<a name="l00325"></a>00325     
<a name="l00326"></a>00326     $self-&gt;{correct_ids}=[@correct_ids]       <span class="keywordflow">if</span> @correct_ids;
<a name="l00327"></a>00327     $self-&gt;{incorrect_ids} = [@incorrect_ids] <span class="keywordflow">if</span> @incorrect_ids;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329     <span class="keywordflow">return</span>
<a name="l00330"></a>00330         CGI::table({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;attemptResults&quot;</span>}, CGI::Tr(\@tableRows))
<a name="l00331"></a>00331         . ($showSummary ? CGI::p({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;attemptResultsSummary&#39;</span>},$summary) : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00332"></a>00332 }
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 
<a name="l00335"></a>00335 <span class="preprocessor"># Note: previewAnswer is lifted into GatewayQuiz.pm</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span>
<a name="l00337"></a>00337 sub previewAnswer {
<a name="l00338"></a>00338     my ($self, $answerResult, $imgGen, $tthPreambleCache) = @_;
<a name="l00339"></a>00339     my $ce            = $self-&gt;r-&gt;ce;
<a name="l00340"></a>00340     my $effectiveUser = $self-&gt;{effectiveUser};
<a name="l00341"></a>00341     my $set           = $self-&gt;{<span class="keyword">set</span>};
<a name="l00342"></a>00342     my $problem       = $self-&gt;{problem};
<a name="l00343"></a>00343     my $displayMode   = $self-&gt;{displayMode};
<a name="l00344"></a>00344     
<a name="l00345"></a>00345 <span class="preprocessor">    # note: right now, we have to do things completely differently when we are</span>
<a name="l00346"></a>00346 <span class="preprocessor"></span><span class="preprocessor">    # rendering math from INSIDE the translator and from OUTSIDE the translator.</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span><span class="preprocessor">    # so we&#39;ll just deal with each case explicitly here. there&#39;s some code</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span><span class="preprocessor">    # duplication that can be dealt with later by abstracting out tth/dvipng/etc.</span>
<a name="l00349"></a>00349 <span class="preprocessor"></span>    
<a name="l00350"></a>00350     my $tex = $answerResult-&gt;{preview_latex_string};
<a name="l00351"></a>00351     
<a name="l00352"></a>00352     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless defined $tex and $tex ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l00353"></a>00353     
<a name="l00354"></a>00354     <span class="keywordflow">if</span> ($displayMode eq <span class="stringliteral">&quot;plainText&quot;</span>) {
<a name="l00355"></a>00355         <span class="keywordflow">return</span> $tex;
<a name="l00356"></a>00356     } elsif ($displayMode eq <span class="stringliteral">&quot;formattedText&quot;</span>) {
<a name="l00357"></a>00357         
<a name="l00358"></a>00358 <span class="preprocessor">        # read the TTH preamble, or use the cached copy passed in from the caller</span>
<a name="l00359"></a>00359 <span class="preprocessor"></span>        my $tthPreamble=<span class="stringliteral">&#39;&#39;</span>;
<a name="l00360"></a>00360         <span class="keywordflow">if</span> (defined $$tthPreambleCache) {
<a name="l00361"></a>00361             $tthPreamble = $$tthPreambleCache;
<a name="l00362"></a>00362         } <span class="keywordflow">else</span> {
<a name="l00363"></a>00363             my $tthPreambleFile = $ce-&gt;{courseDirs}-&gt;{templates} . <span class="stringliteral">&quot;/tthPreamble.tex&quot;</span>;
<a name="l00364"></a>00364             <span class="keywordflow">if</span> (-r $tthPreambleFile) {
<a name="l00365"></a>00365                 $tthPreamble = readFile($tthPreambleFile);
<a name="l00366"></a>00366 <span class="preprocessor">                # thanks to Jim Martino. each line in the definition file should end with</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span><span class="preprocessor">                #a % to prevent adding supurious paragraphs to output:</span>
<a name="l00368"></a>00368 <span class="preprocessor"></span>                $tthPreamble =~ s/(.)\n/$1%\n/g;
<a name="l00369"></a>00369 <span class="preprocessor">                # solves the problem if the file doesn&#39;t end with a return:</span>
<a name="l00370"></a>00370 <span class="preprocessor"></span>                $tthPreamble .=<span class="stringliteral">&quot;%\n&quot;</span>;
<a name="l00371"></a>00371 <span class="preprocessor">                # store preamble in cache:</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span>                $$tthPreambleCache = $tthPreamble;
<a name="l00373"></a>00373             } <span class="keywordflow">else</span> {
<a name="l00374"></a>00374             }
<a name="l00375"></a>00375         }
<a name="l00376"></a>00376         
<a name="l00377"></a>00377 <span class="preprocessor">        # construct TTH command line</span>
<a name="l00378"></a>00378 <span class="preprocessor"></span>        my $tthCommand = $ce-&gt;{externalPrograms}-&gt;{tth}
<a name="l00379"></a>00379             . <span class="stringliteral">&quot; -L -f5 -u -r  2&gt; /dev/null &lt;&lt;END_OF_INPUT; echo &gt; /dev/null\n&quot;</span>
<a name="l00380"></a>00380             . $tthPreamble . <span class="stringliteral">&quot;\\[&quot;</span> . $tex . <span class="stringliteral">&quot;\\]\n&quot;</span>
<a name="l00381"></a>00381             . <span class="stringliteral">&quot;END_OF_INPUT\n&quot;</span>;
<a name="l00382"></a>00382         
<a name="l00383"></a>00383 <span class="preprocessor">        # call tth</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span>        my $result = `$tthCommand`;
<a name="l00385"></a>00385         <span class="keywordflow">if</span> ($?) {
<a name="l00386"></a>00386             <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;b&gt;[tth failed: $? $@]&lt;/b&gt;&quot;</span>;
<a name="l00387"></a>00387         } <span class="keywordflow">else</span> {
<a name="l00388"></a>00388 <span class="preprocessor">            #  avoid border problems in tables and remove unneeded initial &lt;br&gt;</span>
<a name="l00389"></a>00389 <span class="preprocessor"></span>            $result =~ s/(&lt;table [^&gt;]*)&gt;/$1 CLASS=<span class="stringliteral">&quot;ArrayLayout&quot;</span>&gt;/gi;
<a name="l00390"></a>00390             $result =~ s!\s*&lt;br clear=<span class="stringliteral">&quot;all&quot;</span> /&gt;!!;
<a name="l00391"></a>00391             <span class="keywordflow">return</span> $result;
<a name="l00392"></a>00392         }
<a name="l00393"></a>00393         
<a name="l00394"></a>00394     } elsif ($displayMode eq <span class="stringliteral">&quot;images&quot;</span>) {
<a name="l00395"></a>00395         $imgGen-&gt;add($tex);
<a name="l00396"></a>00396     } elsif ($displayMode eq <span class="stringliteral">&quot;MathJax&quot;</span>) {
<a name="l00397"></a>00397         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;span class=&quot;MathJax_Preview&quot;&gt;[math]&lt;/span&gt;&lt;script type=&quot;math/tex; mode=display&quot;&gt;&#39;</span>.$tex.<span class="stringliteral">&#39;&lt;/script&gt;&#39;</span>;
<a name="l00398"></a>00398     } elsif ($displayMode eq <span class="stringliteral">&quot;jsMath&quot;</span>) {
<a name="l00399"></a>00399         $tex =~ s/&amp;/&amp;amp;/g; $tex =~ s/&lt;/&amp;lt;/g; $tex =~ s/&gt;/&amp;gt;/g;
<a name="l00400"></a>00400         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;SPAN CLASS=&quot;math&quot;&gt;\\displaystyle{&#39;</span>.$tex.<span class="stringliteral">&#39;}&lt;/SPAN&gt;&#39;</span>;
<a name="l00401"></a>00401     }
<a name="l00402"></a>00402 }
<a name="l00403"></a>00403 sub previewCorrectAnswer {
<a name="l00404"></a>00404     my ($self, $answerResult, $imgGen, $tthPreambleCache) = @_;
<a name="l00405"></a>00405     my $ce            = $self-&gt;r-&gt;ce;
<a name="l00406"></a>00406     my $effectiveUser = $self-&gt;{effectiveUser};
<a name="l00407"></a>00407     my $set           = $self-&gt;{<span class="keyword">set</span>};
<a name="l00408"></a>00408     my $problem       = $self-&gt;{problem};
<a name="l00409"></a>00409     my $displayMode   = $self-&gt;{displayMode};
<a name="l00410"></a>00410     
<a name="l00411"></a>00411 <span class="preprocessor">    # note: right now, we have to do things completely differently when we are</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span><span class="preprocessor">    # rendering math from INSIDE the translator and from OUTSIDE the translator.</span>
<a name="l00413"></a>00413 <span class="preprocessor"></span><span class="preprocessor">    # so we&#39;ll just deal with each case explicitly here. there&#39;s some code</span>
<a name="l00414"></a>00414 <span class="preprocessor"></span><span class="preprocessor">    # duplication that can be dealt with later by abstracting out tth/dvipng/etc.</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>    
<a name="l00416"></a>00416     my $tex = $answerResult-&gt;{correct_ans_latex_string};
<a name="l00417"></a>00417     <span class="keywordflow">return</span> $answerResult-&gt;{correct_ans} unless defined $tex and $tex=~/\S/;   # some answers don<span class="stringliteral">&#39;t have latex strings defined</span>
<a name="l00418"></a>00418 <span class="stringliteral">    # return &quot;&quot; unless defined $tex and $tex ne &quot;&quot;;</span>
<a name="l00419"></a>00419 <span class="stringliteral">    </span>
<a name="l00420"></a>00420 <span class="stringliteral">    if ($displayMode eq &quot;plainText&quot;) {</span>
<a name="l00421"></a>00421 <span class="stringliteral">        return $tex;</span>
<a name="l00422"></a>00422 <span class="stringliteral">    } elsif ($displayMode eq &quot;formattedText&quot;) {</span>
<a name="l00423"></a>00423 <span class="stringliteral">        </span>
<a name="l00424"></a>00424 <span class="stringliteral">        # read the TTH preamble, or use the cached copy passed in from the caller</span>
<a name="l00425"></a>00425 <span class="stringliteral">        my $tthPreamble=&#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00426"></a>00426 <span class="stringliteral">        if (defined $$tthPreambleCache) {</span>
<a name="l00427"></a>00427 <span class="stringliteral">            $tthPreamble = $$tthPreambleCache;</span>
<a name="l00428"></a>00428 <span class="stringliteral">        } else {</span>
<a name="l00429"></a>00429 <span class="stringliteral">            my $tthPreambleFile = $ce-&gt;{courseDirs}-&gt;{templates} . &quot;/tthPreamble.tex&quot;;</span>
<a name="l00430"></a>00430 <span class="stringliteral">            if (-r $tthPreambleFile) {</span>
<a name="l00431"></a>00431 <span class="stringliteral">                $tthPreamble = readFile($tthPreambleFile);</span>
<a name="l00432"></a>00432 <span class="stringliteral">                # thanks to Jim Martino. each line in the definition file should end with</span>
<a name="l00433"></a>00433 <span class="stringliteral">                #a % to prevent adding supurious paragraphs to output:</span>
<a name="l00434"></a>00434 <span class="stringliteral">                $tthPreamble =~ s/(.)\n/$1%\n/g;</span>
<a name="l00435"></a>00435 <span class="stringliteral">                # solves the problem if the file doesn&#39;</span>t end with a <span class="keywordflow">return</span>:
<a name="l00436"></a>00436                 $tthPreamble .=<span class="stringliteral">&quot;%\n&quot;</span>;
<a name="l00437"></a>00437 <span class="preprocessor">                # store preamble in cache:</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>                $$tthPreambleCache = $tthPreamble;
<a name="l00439"></a>00439             } <span class="keywordflow">else</span> {
<a name="l00440"></a>00440             }
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442         
<a name="l00443"></a>00443 <span class="preprocessor">        # construct TTH command line</span>
<a name="l00444"></a>00444 <span class="preprocessor"></span>        my $tthCommand = $ce-&gt;{externalPrograms}-&gt;{tth}
<a name="l00445"></a>00445             . <span class="stringliteral">&quot; -L -f5 -u -r  2&gt; /dev/null &lt;&lt;END_OF_INPUT; echo &gt; /dev/null\n&quot;</span>
<a name="l00446"></a>00446             . $tthPreamble . <span class="stringliteral">&quot;\\[&quot;</span> . $tex . <span class="stringliteral">&quot;\\]\n&quot;</span>
<a name="l00447"></a>00447             . <span class="stringliteral">&quot;END_OF_INPUT\n&quot;</span>;
<a name="l00448"></a>00448         
<a name="l00449"></a>00449 <span class="preprocessor">        # call tth</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span>        my $result = `$tthCommand`;
<a name="l00451"></a>00451         <span class="keywordflow">if</span> ($?) {
<a name="l00452"></a>00452             <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;b&gt;[tth failed: $? $@]&lt;/b&gt;&quot;</span>;
<a name="l00453"></a>00453         } <span class="keywordflow">else</span> {
<a name="l00454"></a>00454 <span class="preprocessor">            #  avoid border problems in tables and remove unneeded initial &lt;br&gt;</span>
<a name="l00455"></a>00455 <span class="preprocessor"></span>            $result =~ s/(&lt;table [^&gt;]*)&gt;/$1 CLASS=<span class="stringliteral">&quot;ArrayLayout&quot;</span>&gt;/gi;
<a name="l00456"></a>00456             $result =~ s!\s*&lt;br clear=<span class="stringliteral">&quot;all&quot;</span> /&gt;!!;
<a name="l00457"></a>00457             <span class="keywordflow">return</span> $result;
<a name="l00458"></a>00458         }
<a name="l00459"></a>00459         
<a name="l00460"></a>00460     } elsif ($displayMode eq <span class="stringliteral">&quot;images&quot;</span>) {
<a name="l00461"></a>00461         $imgGen-&gt;add($tex);
<a name="l00462"></a>00462     } elsif ($displayMode eq <span class="stringliteral">&quot;MathJax&quot;</span>) {
<a name="l00463"></a>00463         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;span class=&quot;MathJax_Preview&quot;&gt;[math]&lt;/span&gt;&lt;script type=&quot;math/tex; mode=display&quot;&gt;&#39;</span>.$tex.<span class="stringliteral">&#39;&lt;/script&gt;&#39;</span>;
<a name="l00464"></a>00464     } elsif ($displayMode eq <span class="stringliteral">&quot;jsMath&quot;</span>) {
<a name="l00465"></a>00465         $tex =~ s/&amp;/&amp;amp;/g; $tex =~ s/&lt;/&amp;lt;/g; $tex =~ s/&gt;/&amp;gt;/g;
<a name="l00466"></a>00466         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;SPAN CLASS=&quot;math&quot;&gt;\\displaystyle{&#39;</span>.$tex.<span class="stringliteral">&#39;}&lt;/SPAN&gt;&#39;</span>;
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468 }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470 <span class="preprocessor">################################################################################</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span><span class="preprocessor"># Template escape implementations</span>
<a name="l00472"></a>00472 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span>
<a name="l00474"></a>00474 sub pre_header_initialize {
<a name="l00475"></a>00475     my ($self) = @_;
<a name="l00476"></a>00476     my $r = $self-&gt;r;
<a name="l00477"></a>00477     my $ce = $r-&gt;ce;
<a name="l00478"></a>00478     my $db = $r-&gt;db;
<a name="l00479"></a>00479     my $authz = $r-&gt;authz;
<a name="l00480"></a>00480     my $urlpath = $r-&gt;urlpath;
<a name="l00481"></a>00481     
<a name="l00482"></a>00482     my $setName = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l00483"></a>00483     my $problemNumber = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;problemID&quot;</span>);
<a name="l00484"></a>00484     my $userName = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00485"></a>00485     my $effectiveUserName = $r-&gt;param(<span class="stringliteral">&#39;effectiveUser&#39;</span>);
<a name="l00486"></a>00486     my $key = $r-&gt;param(<span class="stringliteral">&#39;key&#39;</span>);
<a name="l00487"></a>00487     my $editMode = $r-&gt;param(<span class="stringliteral">&quot;editMode&quot;</span>);
<a name="l00488"></a>00488     
<a name="l00489"></a>00489     my $user = $db-&gt;getUser($userName); # checked
<a name="l00490"></a>00490     die <span class="stringliteral">&quot;record for user $userName (real user) does not exist.&quot;</span>
<a name="l00491"></a>00491         unless defined $user;
<a name="l00492"></a>00492     
<a name="l00493"></a>00493     my $effectiveUser = $db-&gt;getUser($effectiveUserName); # checked
<a name="l00494"></a>00494     die <span class="stringliteral">&quot;record for user $effectiveUserName (effective user) does not exist.&quot;</span>
<a name="l00495"></a>00495         unless defined $effectiveUser;
<a name="l00496"></a>00496     
<a name="l00497"></a>00497 <span class="preprocessor">    # obtain the merged set for $effectiveUser</span>
<a name="l00498"></a>00498 <span class="preprocessor"></span>    my $set = $db-&gt;getMergedSet($effectiveUserName, $setName); # checked
<a name="l00499"></a>00499 
<a name="l00500"></a>00500     $self-&gt;set_showOldAnswers_default($ce, $userName, $authz, $set);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 <span class="preprocessor">    # Database fix (in case of undefined visiblity state values)</span>
<a name="l00503"></a>00503 <span class="preprocessor"></span><span class="preprocessor">    # this is only necessary because some people keep holding to ww1.9 which did not have a visible field</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span><span class="preprocessor">    # make sure visible is set to 0 or 1</span>
<a name="l00505"></a>00505 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $set and $set-&gt;visible ne <span class="stringliteral">&quot;0&quot;</span> and $set-&gt;visible ne <span class="stringliteral">&quot;1&quot;</span>) {
<a name="l00506"></a>00506         my $globalSet = $db-&gt;getGlobalSet($set-&gt;set_id);
<a name="l00507"></a>00507         $globalSet-&gt;visible(<span class="stringliteral">&quot;1&quot;</span>);   # defaults to visible
<a name="l00508"></a>00508         $db-&gt;putGlobalSet($globalSet);
<a name="l00509"></a>00509         $set = $db-&gt;getMergedSet($effectiveUserName, $setName);
<a name="l00510"></a>00510     } <span class="keywordflow">else</span> {
<a name="l00511"></a>00511 <span class="preprocessor">        # don&#39;t do anything just yet, maybe we&#39;re a professor and we&#39;re</span>
<a name="l00512"></a>00512 <span class="preprocessor"></span><span class="preprocessor">        # fabricating a set or haven&#39;t assigned it to ourselves just yet</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span>    }
<a name="l00514"></a>00514 <span class="preprocessor">        # When a set is created enable_reduced_scoring is null, so we have to set it </span>
<a name="l00515"></a>00515 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $set and $set-&gt;enable_reduced_scoring ne <span class="stringliteral">&quot;0&quot;</span> and $set-&gt;enable_reduced_scoring ne <span class="stringliteral">&quot;1&quot;</span>) {
<a name="l00516"></a>00516         my $globalSet = $db-&gt;getGlobalSet($set-&gt;set_id);
<a name="l00517"></a>00517         $globalSet-&gt;enable_reduced_scoring(<span class="stringliteral">&quot;0&quot;</span>);    # defaults to disabled
<a name="l00518"></a>00518         $db-&gt;putGlobalSet($globalSet);
<a name="l00519"></a>00519         $set = $db-&gt;getMergedSet($effectiveUserName, $setName);
<a name="l00520"></a>00520     }
<a name="l00521"></a>00521     
<a name="l00522"></a>00522     
<a name="l00523"></a>00523 <span class="preprocessor">    # obtain the merged problem for $effectiveUser</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span>    my $problem = $db-&gt;getMergedProblem($effectiveUserName, $setName, $problemNumber); # checked
<a name="l00525"></a>00525     
<a name="l00526"></a>00526 <span class="preprocessor">    # A very hacky and temporary solution to the max_attempts problem</span>
<a name="l00527"></a>00527 <span class="preprocessor"></span><span class="preprocessor">    # if($problem-&gt;max_attempts == &quot;&quot;){</span>
<a name="l00528"></a>00528 <span class="preprocessor"></span><span class="preprocessor">        # $problem-&gt;max_attempts = -1;</span>
<a name="l00529"></a>00529 <span class="preprocessor"></span><span class="preprocessor">    # }</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span>    
<a name="l00531"></a>00531     <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>)) {
<a name="l00532"></a>00532 <span class="preprocessor">        # professors are allowed to fabricate sets and problems not</span>
<a name="l00533"></a>00533 <span class="preprocessor"></span><span class="preprocessor">        # assigned to them (or anyone). this allows them to use the</span>
<a name="l00534"></a>00534 <span class="preprocessor"></span><span class="preprocessor">        # editor to </span>
<a name="l00535"></a>00535 <span class="preprocessor"></span>
<a name="l00536"></a>00536 <span class="preprocessor">        # if a User Set does not exist for this user and this set</span>
<a name="l00537"></a>00537 <span class="preprocessor"></span><span class="preprocessor">        # then we check the Global Set</span>
<a name="l00538"></a>00538 <span class="preprocessor"></span><span class="preprocessor">        # if that does not exist we create a fake set</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span><span class="preprocessor">        # if it does, we add fake user data</span>
<a name="l00540"></a>00540 <span class="preprocessor"></span>        unless (defined $set) {
<a name="l00541"></a>00541             my $userSetClass = $db-&gt;{set_user}-&gt;{record};
<a name="l00542"></a>00542             my $globalSet = $db-&gt;getGlobalSet($setName); # checked
<a name="l00543"></a>00543 
<a name="l00544"></a>00544             <span class="keywordflow">if</span> (not defined $globalSet) {
<a name="l00545"></a>00545                 $set = fake_set($db);
<a name="l00546"></a>00546             } <span class="keywordflow">else</span> {
<a name="l00547"></a>00547                 $set = global2user($userSetClass, $globalSet);
<a name="l00548"></a>00548                 $set-&gt;psvn(0);
<a name="l00549"></a>00549             }
<a name="l00550"></a>00550         }
<a name="l00551"></a>00551         
<a name="l00552"></a>00552 <span class="preprocessor">        # if that is not yet defined obtain the global problem,</span>
<a name="l00553"></a>00553 <span class="preprocessor"></span><span class="preprocessor">        # convert it to a user problem, and add fake user data</span>
<a name="l00554"></a>00554 <span class="preprocessor"></span>        unless (defined $problem) {
<a name="l00555"></a>00555             my $userProblemClass = $db-&gt;{problem_user}-&gt;{record};
<a name="l00556"></a>00556             my $globalProblem = $db-&gt;getGlobalProblem($setName, $problemNumber); # checked
<a name="l00557"></a>00557 <span class="preprocessor">            # if the global problem doesn&#39;t exist either, bail!</span>
<a name="l00558"></a>00558 <span class="preprocessor"></span>            <span class="keywordflow">if</span>(not defined $globalProblem) {
<a name="l00559"></a>00559                 my $sourceFilePath = $r-&gt;param(<span class="stringliteral">&quot;sourceFilePath&quot;</span>);
<a name="l00560"></a>00560                 die <span class="stringliteral">&quot;sourceFilePath is unsafe!&quot;</span> unless path_is_subdir($sourceFilePath, $ce-&gt;{courseDirs}-&gt;{templates}, 1); # 1==path can be relative to dir
<a name="l00561"></a>00561 <span class="preprocessor">                # These are problems from setmaker.  If declared invalid, they won&#39;t come up</span>
<a name="l00562"></a>00562 <span class="preprocessor"></span>                $self-&gt;{invalidProblem} = $self-&gt;{invalidSet} = 1 unless defined $sourceFilePath;
<a name="l00563"></a>00563 <span class="preprocessor">#               die &quot;Problem $problemNumber in set $setName does not exist&quot; unless defined $sourceFilePath;</span>
<a name="l00564"></a>00564 <span class="preprocessor"></span>                $problem = fake_problem($db);
<a name="l00565"></a>00565                 $problem-&gt;problem_id(1);
<a name="l00566"></a>00566                 $problem-&gt;source_file($sourceFilePath);
<a name="l00567"></a>00567                 $problem-&gt;user_id($effectiveUserName);
<a name="l00568"></a>00568             } <span class="keywordflow">else</span> {
<a name="l00569"></a>00569                 $problem = global2user($userProblemClass, $globalProblem);
<a name="l00570"></a>00570                 $problem-&gt;user_id($effectiveUserName);
<a name="l00571"></a>00571                 $problem-&gt;problem_seed(0);
<a name="l00572"></a>00572                 $problem-&gt;status(0);
<a name="l00573"></a>00573                 $problem-&gt;attempted(0);
<a name="l00574"></a>00574                 $problem-&gt;last_answer(<span class="stringliteral">&quot;&quot;</span>);
<a name="l00575"></a>00575                 $problem-&gt;num_correct(0);
<a name="l00576"></a>00576                 $problem-&gt;num_incorrect(0);
<a name="l00577"></a>00577             }
<a name="l00578"></a>00578         }
<a name="l00579"></a>00579         
<a name="l00580"></a>00580 <span class="preprocessor">        # now we&#39;re sure we have valid UserSet and UserProblem objects</span>
<a name="l00581"></a>00581 <span class="preprocessor"></span><span class="preprocessor">        # yay!</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>        
<a name="l00583"></a>00583 <span class="preprocessor">        # now deal with possible editor overrides:</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span>        
<a name="l00585"></a>00585 <span class="preprocessor">        # if the caller is asking to override the source file, and</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span><span class="preprocessor">        # editMode calls for a temporary file, do so</span>
<a name="l00587"></a>00587 <span class="preprocessor"></span>        my $sourceFilePath = $r-&gt;param(<span class="stringliteral">&quot;sourceFilePath&quot;</span>);
<a name="l00588"></a>00588         <span class="keywordflow">if</span> (defined $editMode and $editMode eq <span class="stringliteral">&quot;temporaryFile&quot;</span> and defined $sourceFilePath) {
<a name="l00589"></a>00589             die <span class="stringliteral">&quot;sourceFilePath is unsafe!&quot;</span> unless path_is_subdir($sourceFilePath, $ce-&gt;{courseDirs}-&gt;{templates}, 1); # 1==path can be relative to dir
<a name="l00590"></a>00590             $problem-&gt;source_file($sourceFilePath);
<a name="l00591"></a>00591         }
<a name="l00592"></a>00592         
<a name="l00593"></a>00593 <span class="preprocessor">        # if the problem does not have a source file or no source file has been passed in </span>
<a name="l00594"></a>00594 <span class="preprocessor"></span><span class="preprocessor">        # then this is really an invalid problem (probably from a bad URL)</span>
<a name="l00595"></a>00595 <span class="preprocessor"></span>        $self-&gt;{invalidProblem} = not (defined $sourceFilePath or $problem-&gt;source_file);
<a name="l00596"></a>00596         
<a name="l00597"></a>00597 <span class="preprocessor">        # if the caller is asking to override the problem seed, do so</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span>        my $problemSeed = $r-&gt;param(<span class="stringliteral">&quot;problemSeed&quot;</span>);
<a name="l00599"></a>00599         <span class="keywordflow">if</span> (defined $problemSeed) {
<a name="l00600"></a>00600             $problem-&gt;problem_seed($problemSeed);
<a name="l00601"></a>00601         }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603         my $visiblityStateClass = ($set-&gt;visible) ? $r-&gt;maketext(<span class="stringliteral">&quot;Visible&quot;</span>) : $r-&gt;maketext(<span class="stringliteral">&quot;Hidden&quot;</span>);
<a name="l00604"></a>00604         my $visiblityStateText = ($set-&gt;visible) ? $r-&gt;maketext(<span class="stringliteral">&quot;visible to students&quot;</span>).<span class="stringliteral">&quot;.&quot;</span> : $r-&gt;maketext(<span class="stringliteral">&quot;hidden from students&quot;</span>).<span class="stringliteral">&quot;.&quot;</span>;
<a name="l00605"></a>00605         $self-&gt;addmessage(CGI::span($r-&gt;maketext(<span class="stringliteral">&quot;This set is [_1]&quot;</span>, CGI::font({<span class="keyword">class</span>=&gt;$visiblityStateClass}, $visiblityStateText))));
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 <span class="preprocessor">  # test for additional problem validity if it&#39;s not already invalid</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<a name="l00609"></a>00609         $self-&gt;{invalidProblem} = !(defined $problem and ($set-&gt;visible || $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;view_hidden_sets&quot;</span>)));
<a name="l00610"></a>00610         
<a name="l00611"></a>00611         $self-&gt;addbadmessage(CGI::p($r-&gt;maketext(<span class="stringliteral">&quot;This problem will not count towards your grade.&quot;</span>))) <span class="keywordflow">if</span> $problem and not $problem-&gt;value and not $self-&gt;{invalidProblem};
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     $self-&gt;{userName}          = $userName;
<a name="l00615"></a>00615     $self-&gt;{effectiveUserName} = $effectiveUserName;
<a name="l00616"></a>00616     $self-&gt;{user}              = $user;
<a name="l00617"></a>00617     $self-&gt;{effectiveUser}     = $effectiveUser;
<a name="l00618"></a>00618     $self-&gt;{<span class="keyword">set</span>}               = $set;
<a name="l00619"></a>00619     $self-&gt;{problem}           = $problem;
<a name="l00620"></a>00620     $self-&gt;{editMode}          = $editMode;
<a name="l00621"></a>00621     
<a name="l00622"></a>00622 <span class="preprocessor">    ##### form processing #####</span>
<a name="l00623"></a>00623 <span class="preprocessor"></span>    
<a name="l00624"></a>00624 <span class="preprocessor">    # set options from form fields (see comment at top of file for names)</span>
<a name="l00625"></a>00625 <span class="preprocessor"></span>    my $displayMode        = $r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>) || $ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};
<a name="l00626"></a>00626     my $redisplay          = $r-&gt;param(<span class="stringliteral">&quot;redisplay&quot;</span>);
<a name="l00627"></a>00627     my $submitAnswers      = $r-&gt;param(<span class="stringliteral">&quot;submitAnswers&quot;</span>);
<a name="l00628"></a>00628     my $checkAnswers       = $r-&gt;param(<span class="stringliteral">&quot;checkAnswers&quot;</span>);
<a name="l00629"></a>00629     my $previewAnswers     = $r-&gt;param(<span class="stringliteral">&quot;previewAnswers&quot;</span>);
<a name="l00630"></a>00630     
<a name="l00631"></a>00631     my $formFields = { <a class="code" href="classWeBWorK_1_1Form.html">WeBWorK::Form</a>-&gt;new_from_paramable($r)-&gt;Vars };
<a name="l00632"></a>00632     
<a name="l00633"></a>00633     $self-&gt;{displayMode}    = $displayMode;
<a name="l00634"></a>00634     $self-&gt;{redisplay}      = $redisplay;
<a name="l00635"></a>00635     $self-&gt;{submitAnswers}  = $submitAnswers;
<a name="l00636"></a>00636     $self-&gt;{checkAnswers}   = $checkAnswers;
<a name="l00637"></a>00637     $self-&gt;{previewAnswers} = $previewAnswers;
<a name="l00638"></a>00638     $self-&gt;{formFields}     = $formFields;
<a name="l00639"></a>00639 
<a name="l00640"></a>00640 <span class="preprocessor">    # get result and send to message</span>
<a name="l00641"></a>00641 <span class="preprocessor"></span>    my $status_message = $r-&gt;param(<span class="stringliteral">&quot;status_message&quot;</span>);
<a name="l00642"></a>00642     $self-&gt;addmessage(CGI::p(<span class="stringliteral">&quot;$status_message&quot;</span>)) <span class="keywordflow">if</span> $status_message;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644 <span class="preprocessor">    # now that we&#39;ve set all the necessary variables quit out if the set or problem is invalid</span>
<a name="l00645"></a>00645 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{invalidSet} || $self-&gt;{invalidProblem};
<a name="l00646"></a>00646     
<a name="l00647"></a>00647 <span class="preprocessor">    ##### permissions #####</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span>
<a name="l00649"></a>00649 <span class="preprocessor">    # what does the user want to do?</span>
<a name="l00650"></a>00650 <span class="preprocessor"></span><span class="preprocessor">    #FIXME  There is a problem with checkboxes -- if they are not checked they are invisible.  Hence if the default mode in $ce is 1</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span><span class="preprocessor">    # there is no way to override this.  Probably this is ok for the last three options, but it was definitely not ok for showing</span>
<a name="l00652"></a>00652 <span class="preprocessor"></span><span class="preprocessor">    # saved answers which is normally on, but you want to be able to turn it off!  This section should be moved to ContentGenerator</span>
<a name="l00653"></a>00653 <span class="preprocessor"></span><span class="preprocessor">    # so that you can set these options anywhere.  We also need mechanisms for making them sticky.</span>
<a name="l00654"></a>00654 <span class="preprocessor"></span><span class="preprocessor">    # Note: ProblemSet and ProblemSets might set showOldAnswers to &#39;&#39;, which</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span><span class="preprocessor">    #       needs to be treated as if it is not set.</span>
<a name="l00656"></a>00656 <span class="preprocessor"></span>    my %want = (
<a name="l00657"></a>00657         showOldAnswers     =&gt; (defined($r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>)) and $r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>) ne <span class="stringliteral">&#39;&#39;</span>) ? $r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>)  : $ce-&gt;{pg}-&gt;{options}-&gt;{showOldAnswers},
<a name="l00658"></a>00658         showCorrectAnswers =&gt; $r-&gt;param(<span class="stringliteral">&quot;showCorrectAnswers&quot;</span>) || $ce-&gt;{pg}-&gt;{options}-&gt;{showCorrectAnswers},
<a name="l00659"></a>00659         showHints          =&gt; $r-&gt;param(<span class="stringliteral">&quot;showHints&quot;</span>)          || $ce-&gt;{pg}-&gt;{options}-&gt;{showHints},
<a name="l00660"></a>00660         showSolutions      =&gt; $r-&gt;param(<span class="stringliteral">&quot;showSolutions&quot;</span>)      || $ce-&gt;{pg}-&gt;{options}-&gt;{showSolutions},
<a name="l00661"></a>00661         recordAnswers      =&gt; $submitAnswers,
<a name="l00662"></a>00662         checkAnswers       =&gt; $checkAnswers,
<a name="l00663"></a>00663         getSubmitButton    =&gt; 1,
<a name="l00664"></a>00664     );
<a name="l00665"></a>00665     
<a name="l00666"></a>00666 <span class="preprocessor">    # are certain options enforced?</span>
<a name="l00667"></a>00667 <span class="preprocessor"></span>    my %must = (
<a name="l00668"></a>00668         showOldAnswers     =&gt; 0,
<a name="l00669"></a>00669         showCorrectAnswers =&gt; 0,
<a name="l00670"></a>00670         showHints          =&gt; 0,
<a name="l00671"></a>00671         showSolutions      =&gt; 0,
<a name="l00672"></a>00672         recordAnswers      =&gt; ! $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;avoid_recording_answers&quot;</span>),
<a name="l00673"></a>00673         checkAnswers       =&gt; 0,
<a name="l00674"></a>00674         getSubmitButton    =&gt; 0,
<a name="l00675"></a>00675     );
<a name="l00676"></a>00676      
<a name="l00677"></a>00677 <span class="preprocessor">    # does the user have permission to use certain options?</span>
<a name="l00678"></a>00678 <span class="preprocessor"></span>    my @args = ($user, $effectiveUser, $set, $problem);
<a name="l00679"></a>00679     my %can = (
<a name="l00680"></a>00680         showOldAnswers     =&gt; $self-&gt;can_showOldAnswers(@args),
<a name="l00681"></a>00681         showCorrectAnswers =&gt; $self-&gt;can_showCorrectAnswers(@args),
<a name="l00682"></a>00682         showHints          =&gt; $self-&gt;can_showHints(@args),
<a name="l00683"></a>00683         showSolutions      =&gt; $self-&gt;can_showSolutions(@args),
<a name="l00684"></a>00684         recordAnswers      =&gt; $self-&gt;can_recordAnswers(@args, 0),
<a name="l00685"></a>00685         checkAnswers       =&gt; $self-&gt;can_checkAnswers(@args, $submitAnswers),
<a name="l00686"></a>00686         getSubmitButton    =&gt; $self-&gt;can_recordAnswers(@args, $submitAnswers),
<a name="l00687"></a>00687     );
<a name="l00688"></a>00688     
<a name="l00689"></a>00689 <span class="preprocessor">    # final values for options</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span>    my %will;
<a name="l00691"></a>00691     <span class="keywordflow">foreach</span> (keys %must) {
<a name="l00692"></a>00692         $will{$_} = $can{$_} &amp;&amp; ($want{$_} || $must{$_});
<a name="l00693"></a>00693 <span class="preprocessor">        #warn &quot;final values for options $_ is can $can{$_}, want $want{$_}, must $must{$_}, will $will{$_}&quot;;</span>
<a name="l00694"></a>00694 <span class="preprocessor"></span>    }
<a name="l00695"></a>00695     
<a name="l00696"></a>00696 <span class="preprocessor">    ##### sticky answers #####</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>    
<a name="l00698"></a>00698     <span class="keywordflow">if</span> (not ($submitAnswers or $previewAnswers or $checkAnswers) and $will{showOldAnswers}) {
<a name="l00699"></a>00699 <span class="preprocessor">        # do this only if new answers are NOT being submitted</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span>        my %oldAnswers = decodeAnswers($problem-&gt;last_answer);
<a name="l00701"></a>00701         $formFields-&gt;{$_} = $oldAnswers{$_} <span class="keywordflow">foreach</span> keys %oldAnswers;
<a name="l00702"></a>00702     }
<a name="l00703"></a>00703     
<a name="l00704"></a>00704 <span class="preprocessor">    ##### translation #####</span>
<a name="l00705"></a>00705 <span class="preprocessor"></span>
<a name="l00706"></a>00706     debug(<span class="stringliteral">&quot;begin pg processing&quot;</span>);
<a name="l00707"></a>00707     my $pg = <a class="code" href="classWeBWorK_1_1PG.html">WeBWorK::PG</a>-&gt;new(
<a name="l00708"></a>00708         $ce,
<a name="l00709"></a>00709         $effectiveUser,
<a name="l00710"></a>00710         $key,
<a name="l00711"></a>00711         $set,
<a name="l00712"></a>00712         $problem,
<a name="l00713"></a>00713         $set-&gt;psvn, # FIXME: <span class="keyword">this</span> field should be removed
<a name="l00714"></a>00714         $formFields,
<a name="l00715"></a>00715         { # translation options
<a name="l00716"></a>00716             displayMode     =&gt; $displayMode,
<a name="l00717"></a>00717             showHints       =&gt; $will{showHints},
<a name="l00718"></a>00718             showSolutions   =&gt; $will{showSolutions},
<a name="l00719"></a>00719             refreshMath2img =&gt; $will{showHints} || $will{showSolutions},
<a name="l00720"></a>00720             processAnswers  =&gt; 1,
<a name="l00721"></a>00721             permissionLevel =&gt; $db-&gt;getPermissionLevel($userName)-&gt;permission,
<a name="l00722"></a>00722             effectivePermissionLevel =&gt; $db-&gt;getPermissionLevel($effectiveUserName)-&gt;permission,
<a name="l00723"></a>00723         },
<a name="l00724"></a>00724     );
<a name="l00725"></a>00725 <span class="preprocessor">    # sometimes, for example if the file can&#39;t be read, $pg-&gt;{pgcore} won&#39;t be defined</span>
<a name="l00726"></a>00726 <span class="preprocessor"></span><span class="preprocessor">    # because the PG file is never run</span>
<a name="l00727"></a>00727 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00728"></a>00728 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (defined ($pg-&gt;{pgcore}) ) {
<a name="l00729"></a>00729         my $debug_msg = CGI::br().join( CGI::br(), @{ $pg-&gt;{pgcore}-&gt;get_debug_messages});
<a name="l00730"></a>00730         $self-&gt;addmessage($debug_msg ) <span class="keywordflow">if</span> $debug_msg;
<a name="l00731"></a>00731         $self-&gt;{pgdebug}          = $pg-&gt;{pgcore}-&gt;get_debug_messages;
<a name="l00732"></a>00732         $self-&gt;{pgwarning}        = $pg-&gt;{pgcore}-&gt;get_warning_messages;
<a name="l00733"></a>00733         $self-&gt;{pginternalerrors} = $pg-&gt;{pgcore}-&gt;get_internal_debug_messages ;
<a name="l00734"></a>00734         $self-&gt;{pgerrors} = @{$self-&gt;{pgdebug}} || @{$self-&gt;{pgwarning}} || @{$self-&gt;{pginternalerrors}}||0;
<a name="l00735"></a>00735     } <span class="keywordflow">else</span> {
<a name="l00736"></a>00736         $self-&gt;{pgerrors}=undef;  # unable to obtain errors
<a name="l00737"></a>00737     }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739     debug(<span class="stringliteral">&quot;end pg processing&quot;</span>);
<a name="l00740"></a>00740     
<a name="l00741"></a>00741 <span class="preprocessor">    ##### fix hint/solution options #####</span>
<a name="l00742"></a>00742 <span class="preprocessor"></span>    
<a name="l00743"></a>00743     $can{showHints}     &amp;&amp;= $pg-&gt;{flags}-&gt;{hintExists}  
<a name="l00744"></a>00744                         &amp;&amp;= $pg-&gt;{flags}-&gt;{showHintLimit}&lt;=$pg-&gt;{state}-&gt;{num_of_incorrect_ans};
<a name="l00745"></a>00745     $can{showSolutions} &amp;&amp;= $pg-&gt;{flags}-&gt;{solutionExists};
<a name="l00746"></a>00746     
<a name="l00747"></a>00747 <span class="preprocessor">    ##### store fields #####</span>
<a name="l00748"></a>00748 <span class="preprocessor"></span>    
<a name="l00749"></a>00749     $self-&gt;{want} = \%want;
<a name="l00750"></a>00750     $self-&gt;{must} = \%must;
<a name="l00751"></a>00751     $self-&gt;{can}  = \%can;
<a name="l00752"></a>00752     $self-&gt;{will} = \%will;
<a name="l00753"></a>00753     $self-&gt;{pg} = $pg;
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 sub warnings {
<a name="l00756"></a>00756     my $self = shift;
<a name="l00757"></a>00757 <span class="preprocessor">    # print &quot;entering warnings() subroutine internal messages = &quot;, $self-&gt;{pgerrors},CGI::br();</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span>    my $r  = $self-&gt;r;
<a name="l00759"></a>00759 <span class="preprocessor">#   my $pg = $self-&gt;{pg};</span>
<a name="l00760"></a>00760 <span class="preprocessor"></span><span class="preprocessor">#   warn &quot;type of pg is &quot;,ref($pg);</span>
<a name="l00761"></a>00761 <span class="preprocessor"></span><span class="preprocessor">#   my $pgerrordiv = $pgdebug||$pgwarning||$pginternalerrors;  # is 1 if any of these are non-empty</span>
<a name="l00762"></a>00762 <span class="preprocessor"></span><span class="preprocessor">    # print warning messages</span>
<a name="l00763"></a>00763 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (not defined $self-&gt;{pgerrors} ) {
<a name="l00764"></a>00764         print CGI::start_div();
<a name="l00765"></a>00765         print CGI::h3({style=&gt;<span class="stringliteral">&quot;color:red;&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;PG question failed to render&quot;</span>));
<a name="l00766"></a>00766         print CGI::p($r-&gt;maketext(<span class="stringliteral">&quot;Unable to obtain error messages from within the PG question.&quot;</span> ));
<a name="l00767"></a>00767         print CGI::end_div();
<a name="l00768"></a>00768     } elsif ( $self-&gt;{pgerrors} &gt; 0 ) {
<a name="l00769"></a>00769         my @pgdebug          = @{ $self-&gt;{pgdebug}           };
<a name="l00770"></a>00770         my @pgwarning        = @{ $self-&gt;{pgwarning}         };
<a name="l00771"></a>00771         my @pginternalerrors = @{ $self-&gt;{pginternalerrors}  };
<a name="l00772"></a>00772         print CGI::start_div();
<a name="l00773"></a>00773         print CGI::h3({style=&gt;<span class="stringliteral">&quot;color:red;&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;PG question processing error messages&quot;</span>));
<a name="l00774"></a>00774         print CGI::p(CGI::h3($r-&gt;maketext(<span class="stringliteral">&quot;PG debug messages&quot;</span> ) ),   CGI::br(), join(CGI::br(), @pgdebug  )  )  <span class="keywordflow">if</span> @pgdebug   ;
<a name="l00775"></a>00775         print CGI::p(CGI::h3($r-&gt;maketext(<span class="stringliteral">&quot;PG warning messages&quot;</span> ) ), CGI::br(), join(CGI::br(), @pgwarning)  )  <span class="keywordflow">if</span> @pgwarning ; 
<a name="l00776"></a>00776         print CGI::p(CGI::h3($r-&gt;maketext(<span class="stringliteral">&quot;PG internal errors&quot;</span> ) ),  CGI::br(), join(CGI::br(), @pginternalerrors )) <span class="keywordflow">if</span> @pginternalerrors;
<a name="l00777"></a>00777         print CGI::end_div();
<a name="l00778"></a>00778     } 
<a name="l00779"></a>00779 <span class="preprocessor">    # print &quot;proceeding to SUPER::warnings&quot;;</span>
<a name="l00780"></a>00780 <span class="preprocessor"></span>    $self-&gt;SUPER::warnings();
<a name="l00781"></a>00781     <span class="stringliteral">&quot;&quot;</span>;
<a name="l00782"></a>00782 }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784 <span class="preprocessor">### #FIXME  not clear this is ever used</span>
<a name="l00785"></a>00785 <span class="preprocessor"></span><span class="preprocessor"># sub if_errors($$) {</span>
<a name="l00786"></a>00786 <span class="preprocessor"></span><span class="preprocessor">#   my ($self, $arg) = @_;</span>
<a name="l00787"></a>00787 <span class="preprocessor"></span><span class="preprocessor">#   </span>
<a name="l00788"></a>00788 <span class="preprocessor"></span><span class="preprocessor">#   if ($self-&gt;{isOpen}) {</span>
<a name="l00789"></a>00789 <span class="preprocessor"></span><span class="preprocessor">#       return $self-&gt;{pg}-&gt;{flags}-&gt;{error_flag} ? $arg : !$arg;</span>
<a name="l00790"></a>00790 <span class="preprocessor"></span><span class="preprocessor">#   } else {</span>
<a name="l00791"></a>00791 <span class="preprocessor"></span><span class="preprocessor">#       return !$arg;</span>
<a name="l00792"></a>00792 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l00793"></a>00793 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span>
<a name="l00795"></a>00795 sub head {
<a name="l00796"></a>00796     my ($self) = @_;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> ( $self-&gt;{invalidSet} );
<a name="l00799"></a>00799     <span class="keywordflow">return</span> $self-&gt;{pg}-&gt;{head_text} <span class="keywordflow">if</span> $self-&gt;{pg}-&gt;{head_text};
<a name="l00800"></a>00800 }
<a name="l00801"></a>00801 
<a name="l00802"></a>00802 sub options {
<a name="l00803"></a>00803     my ($self) = @_;
<a name="l00804"></a>00804 <span class="preprocessor">    #warn &quot;doing options in Problem&quot;;</span>
<a name="l00805"></a>00805 <span class="preprocessor"></span>    
<a name="l00806"></a>00806 <span class="preprocessor">    # don&#39;t show options if we don&#39;t have anything to show</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $self-&gt;{invalidSet} or $self-&gt;{invalidProblem};
<a name="l00808"></a>00808     
<a name="l00809"></a>00809     my $displayMode = $self-&gt;{displayMode};
<a name="l00810"></a>00810     my %can = %{ $self-&gt;{can} };
<a name="l00811"></a>00811     
<a name="l00812"></a>00812     my @options_to_show = <span class="stringliteral">&quot;displayMode&quot;</span>;
<a name="l00813"></a>00813     push @options_to_show, <span class="stringliteral">&quot;showOldAnswers&quot;</span> <span class="keywordflow">if</span> $can{showOldAnswers};
<a name="l00814"></a>00814     push @options_to_show, <span class="stringliteral">&quot;showHints&quot;</span> <span class="keywordflow">if</span> $can{showHints};
<a name="l00815"></a>00815     push @options_to_show, <span class="stringliteral">&quot;showSolutions&quot;</span> <span class="keywordflow">if</span> $can{showSolutions};
<a name="l00816"></a>00816     
<a name="l00817"></a>00817     <span class="keywordflow">return</span> $self-&gt;optionsMacro(
<a name="l00818"></a>00818         options_to_show =&gt; \@options_to_show,
<a name="l00819"></a>00819         extra_params =&gt; [<span class="stringliteral">&quot;editMode&quot;</span>, <span class="stringliteral">&quot;sourceFilePath&quot;</span>],
<a name="l00820"></a>00820     );
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00823"></a>00823 sub siblings {
<a name="l00824"></a>00824     my ($self) = @_;
<a name="l00825"></a>00825     my $r = $self-&gt;r;
<a name="l00826"></a>00826     my $db = $r-&gt;db;
<a name="l00827"></a>00827     my $urlpath = $r-&gt;urlpath;
<a name="l00828"></a>00828     
<a name="l00829"></a>00829 <span class="preprocessor">    # can&#39;t show sibling problems if the set is invalid</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $self-&gt;{invalidSet};
<a name="l00831"></a>00831     
<a name="l00832"></a>00832     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00833"></a>00833     my $setID = $self-&gt;{<span class="keyword">set</span>}-&gt;set_id;
<a name="l00834"></a>00834     my $eUserID = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>);
<a name="l00835"></a>00835     my @problemIDs = sort { $a &lt;=&gt; $b } $db-&gt;listUserProblems($eUserID, $setID);
<a name="l00836"></a>00836     
<a name="l00837"></a>00837     print CGI::start_div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;info-box&quot;</span>, <span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;fisheye&quot;</span>});
<a name="l00838"></a>00838     print CGI::h2($r-&gt;maketext(<span class="stringliteral">&quot;Problems&quot;</span>));
<a name="l00839"></a>00839 <span class="preprocessor">    #print CGI::start_ul({class=&gt;&quot;LinksMenu&quot;});</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span><span class="preprocessor">    #print CGI::start_li();</span>
<a name="l00841"></a>00841 <span class="preprocessor"></span><span class="preprocessor">    #print CGI::span({style=&gt;&quot;font-size:larger&quot;}, &quot;Problems&quot;);</span>
<a name="l00842"></a>00842 <span class="preprocessor"></span>    print CGI::start_ul();
<a name="l00843"></a>00843 
<a name="l00844"></a>00844     <span class="keywordflow">foreach</span> my $problemID (@problemIDs) {
<a name="l00845"></a>00845         my $problemPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Problem&quot;</span>, $r, 
<a name="l00846"></a>00846             courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt; $problemID);
<a name="l00847"></a>00847         print CGI::li(CGI::a( {href=&gt;$self-&gt;systemLink($problemPage, 
<a name="l00848"></a>00848                                                     params=&gt;{  displayMode =&gt; $self-&gt;{displayMode}, 
<a name="l00849"></a>00849                                                                showOldAnswers =&gt; $self-&gt;{will}-&gt;{showOldAnswers}
<a name="l00850"></a>00850                                                             })},  $r-&gt;maketext(<span class="stringliteral">&quot;Problem [_1]&quot;</span>,$problemID))
<a name="l00851"></a>00851        );
<a name="l00852"></a>00852     }
<a name="l00853"></a>00853 
<a name="l00854"></a>00854     print CGI::end_ul();
<a name="l00855"></a>00855 <span class="preprocessor">    #print CGI::end_li();</span>
<a name="l00856"></a>00856 <span class="preprocessor"></span><span class="preprocessor">    #print CGI::end_ul();</span>
<a name="l00857"></a>00857 <span class="preprocessor"></span>    print CGI::end_div();
<a name="l00858"></a>00858 
<a name="l00859"></a>00859     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00860"></a>00860 }
<a name="l00861"></a>00861 
<a name="l00862"></a>00862 sub nav {
<a name="l00863"></a>00863     my ($self, $args) = @_;
<a name="l00864"></a>00864     my $r = $self-&gt;r;
<a name="l00865"></a>00865     my $db = $r-&gt;db;
<a name="l00866"></a>00866     my $urlpath = $r-&gt;urlpath;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> ( $self-&gt;{invalidSet} );
<a name="l00869"></a>00869 
<a name="l00870"></a>00870     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00871"></a>00871     my $setID = $self-&gt;{<span class="keyword">set</span>}-&gt;set_id <span class="keywordflow">if</span> !($self-&gt;{invalidSet});
<a name="l00872"></a>00872     my $problemID = $self-&gt;{problem}-&gt;problem_id <span class="keywordflow">if</span> !($self-&gt;{invalidProblem});
<a name="l00873"></a>00873     my $eUserID = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875     my ($prevID, $nextID);
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     <span class="keywordflow">if</span> (!$self-&gt;{invalidProblem}) {
<a name="l00878"></a>00878         my @problemIDs = $db-&gt;listUserProblems($eUserID, $setID);
<a name="l00879"></a>00879         <span class="keywordflow">foreach</span> my $id (@problemIDs) {
<a name="l00880"></a>00880             $prevID = $id <span class="keywordflow">if</span> $id &lt; $problemID
<a name="l00881"></a>00881                 and (not defined $prevID or $id &gt; $prevID);
<a name="l00882"></a>00882             $nextID = $id <span class="keywordflow">if</span> $id &gt; $problemID
<a name="l00883"></a>00883                 and (not defined $nextID or $id &lt; $nextID);
<a name="l00884"></a>00884         }
<a name="l00885"></a>00885     }
<a name="l00886"></a>00886 
<a name="l00887"></a>00887     my @links;
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <span class="keywordflow">if</span> ($prevID) {
<a name="l00890"></a>00890         my $prevPage = $urlpath-&gt;newFromModule(__PACKAGE__, $r, 
<a name="l00891"></a>00891             courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt; $prevID);
<a name="l00892"></a>00892         push @links, $r-&gt;maketext(<span class="stringliteral">&quot;Previous Problem&quot;</span>), $r-&gt;location . $prevPage-&gt;path, $r-&gt;maketext(<span class="stringliteral">&quot;navPrev&quot;</span>);
<a name="l00893"></a>00893     } <span class="keywordflow">else</span> {
<a name="l00894"></a>00894         push @links, $r-&gt;maketext(<span class="stringliteral">&quot;Previous Problem&quot;</span>), <span class="stringliteral">&quot;&quot;</span>, $r-&gt;maketext(<span class="stringliteral">&quot;navPrevGrey&quot;</span>);
<a name="l00895"></a>00895     }
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     <span class="keywordflow">if</span> (defined($setID) &amp;&amp; $setID ne <span class="stringliteral">&#39;Undefined_Set&#39;</span>) {
<a name="l00898"></a>00898         push @links, $r-&gt;maketext(<span class="stringliteral">&quot;Problem List&quot;</span>), $r-&gt;location . $urlpath-&gt;parent-&gt;path, $r-&gt;maketext(<span class="stringliteral">&quot;navProbList&quot;</span>);
<a name="l00899"></a>00899     } <span class="keywordflow">else</span> {
<a name="l00900"></a>00900         push @links, $r-&gt;maketext(<span class="stringliteral">&quot;Problem List&quot;</span>), <span class="stringliteral">&quot;&quot;</span>, $r-&gt;maketext(<span class="stringliteral">&quot;navProbListGrey&quot;</span>);
<a name="l00901"></a>00901     }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903     <span class="keywordflow">if</span> ($nextID) {
<a name="l00904"></a>00904         my $nextPage = $urlpath-&gt;newFromModule(__PACKAGE__, $r, 
<a name="l00905"></a>00905             courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt; $nextID);
<a name="l00906"></a>00906         push @links, $r-&gt;maketext(<span class="stringliteral">&quot;Next Problem&quot;</span>), $r-&gt;location . $nextPage-&gt;path, $r-&gt;maketext(<span class="stringliteral">&quot;navNext&quot;</span>);
<a name="l00907"></a>00907     } <span class="keywordflow">else</span> {
<a name="l00908"></a>00908         push @links, $r-&gt;maketext(<span class="stringliteral">&quot;Next Problem&quot;</span>), <span class="stringliteral">&quot;&quot;</span>, $r-&gt;maketext(<span class="stringliteral">&quot;navNextGrey&quot;</span>);
<a name="l00909"></a>00909     }
<a name="l00910"></a>00910 
<a name="l00911"></a>00911     my $tail = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     $tail .= <span class="stringliteral">&quot;&amp;displayMode=&quot;</span>.$self-&gt;{displayMode} <span class="keywordflow">if</span> defined $self-&gt;{displayMode};
<a name="l00914"></a>00914     $tail .= <span class="stringliteral">&quot;&amp;showOldAnswers=&quot;</span>.$self-&gt;{will}-&gt;{showOldAnswers}
<a name="l00915"></a>00915         <span class="keywordflow">if</span> defined $self-&gt;{will}-&gt;{showOldAnswers};
<a name="l00916"></a>00916     <span class="keywordflow">return</span> $self-&gt;navMacro($args, $tail, @links);
<a name="l00917"></a>00917 }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919 sub title {
<a name="l00920"></a>00920     my ($self) = @_;
<a name="l00921"></a>00921     my $r = $self-&gt;r;
<a name="l00922"></a>00922 <span class="preprocessor">    # using the url arguments won&#39;t break if the set/problem are invalid</span>
<a name="l00923"></a>00923 <span class="preprocessor"></span>    my $setID = <a class="code" href="classWeBWorK_1_1ContentGenerator.html#a773245b898171c74901ad1833b09b78d">WeBWorK::ContentGenerator::underscore2nbsp</a>($self-&gt;r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>));
<a name="l00924"></a>00924     my $problemID = $self-&gt;r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;problemID&quot;</span>);
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;[_1]: Problem [_2]&quot;</span>,$setID, $problemID);
<a name="l00927"></a>00927 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929 
<a name="l00930"></a>00930 <span class="preprocessor"># now altered to outsource most output operations to the template, main functions now are simply error checking and answer processing - ghe3</span>
<a name="l00931"></a>00931 <span class="preprocessor"></span>sub body {
<a name="l00932"></a>00932     my $self = shift;
<a name="l00933"></a>00933     my $set = $self-&gt;{<span class="keyword">set</span>};
<a name="l00934"></a>00934     my $problem = $self-&gt;{problem};
<a name="l00935"></a>00935     my $pg = $self-&gt;{pg};
<a name="l00936"></a>00936     print CGI::p(<span class="stringliteral">&quot;Entering Problem::body subroutine.  This indicates an older style system.template file -- consider upgrading. &quot;</span>);
<a name="l00937"></a>00937     my $valid = <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1ProblemUtil_1_1ProblemUtil.html#a50179aed1e96c8806589ed09516eabc4">WeBWorK::ContentGenerator::ProblemUtil::ProblemUtil::check_invalid</a>($self);
<a name="l00938"></a>00938     unless($valid eq <span class="stringliteral">&quot;valid&quot;</span>){
<a name="l00939"></a>00939         <span class="keywordflow">return</span> $valid;
<a name="l00940"></a>00940     }
<a name="l00941"></a>00941     
<a name="l00942"></a>00942     
<a name="l00943"></a>00943     
<a name="l00944"></a>00944 <span class="preprocessor">    ##### answer processing #####</span>
<a name="l00945"></a>00945 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;begin answer processing&quot;</span>);
<a name="l00946"></a>00946 <span class="preprocessor">    # if answers were submitted:</span>
<a name="l00947"></a>00947 <span class="preprocessor"></span><span class="preprocessor">    #my $scoreRecordedMessage = WeBWorK::ContentGenerator::ProblemUtil::ProblemUtil::process_and_log_answer($self);</span>
<a name="l00948"></a>00948 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;end answer processing&quot;</span>);
<a name="l00949"></a>00949 <span class="preprocessor">    # output for templates that only use body instead of calling the body parts individually</span>
<a name="l00950"></a>00950 <span class="preprocessor"></span>    $self -&gt;output_JS;
<a name="l00951"></a>00951     $self -&gt;output_custom_edit_message;
<a name="l00952"></a>00952     $self -&gt;output_summary;
<a name="l00953"></a>00953     $self -&gt;output_hidden_info;
<a name="l00954"></a>00954     $self -&gt;output_form_start();
<a name="l00955"></a>00955     $self -&gt;output_problem_body;
<a name="l00956"></a>00956     $self -&gt;output_message;
<a name="l00957"></a>00957     $self -&gt;output_editorLink;
<a name="l00958"></a>00958     $self -&gt;output_checkboxes;
<a name="l00959"></a>00959     $self -&gt;output_submit_buttons;
<a name="l00960"></a>00960     $self -&gt;output_score_summary;
<a name="l00961"></a>00961     $self -&gt;output_misc;
<a name="l00962"></a>00962     print <span class="stringliteral">&quot;&lt;/form&gt;&quot;</span>;
<a name="l00963"></a>00963 <span class="preprocessor">    # debugging stuff</span>
<a name="l00964"></a>00964 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (0) {
<a name="l00965"></a>00965         print
<a name="l00966"></a>00966             CGI::hr(),
<a name="l00967"></a>00967             CGI::h2(<span class="stringliteral">&quot;debugging information&quot;</span>),
<a name="l00968"></a>00968             CGI::h3(<span class="stringliteral">&quot;form fields&quot;</span>),
<a name="l00969"></a>00969             ref2string($self-&gt;{formFields}),
<a name="l00970"></a>00970             CGI::h3(<span class="stringliteral">&quot;user object&quot;</span>),
<a name="l00971"></a>00971             ref2string($self-&gt;{user}),
<a name="l00972"></a>00972             CGI::h3(<span class="stringliteral">&quot;set object&quot;</span>),
<a name="l00973"></a>00973             ref2string($set),
<a name="l00974"></a>00974             CGI::h3(<span class="stringliteral">&quot;problem object&quot;</span>),
<a name="l00975"></a>00975             ref2string($problem),
<a name="l00976"></a>00976             CGI::h3(<span class="stringliteral">&quot;PG object&quot;</span>),
<a name="l00977"></a>00977             ref2string($pg, {<span class="stringliteral">&#39;WeBWorK::PG::Translator&#39;</span> =&gt; 1});
<a name="l00978"></a>00978     }
<a name="l00979"></a>00979     debug(<span class="stringliteral">&quot;leaving body of Problem.pm&quot;</span>);
<a name="l00980"></a>00980     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00981"></a>00981 }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983 <span class="preprocessor"># output_form_start subroutine</span>
<a name="l00984"></a>00984 <span class="preprocessor"></span>
<a name="l00985"></a>00985 <span class="preprocessor"># prints out the beginning of the main form, and the necessary hidden authentication fields</span>
<a name="l00986"></a>00986 <span class="preprocessor"></span>
<a name="l00987"></a>00987 sub output_form_start{
<a name="l00988"></a>00988     my $self = shift;
<a name="l00989"></a>00989     my $r = $self-&gt;r;
<a name="l00990"></a>00990     print CGI::start_form(-method=&gt;<span class="stringliteral">&quot;POST&quot;</span>, -action=&gt; $r-&gt;uri,-name=&gt;<span class="stringliteral">&quot;problemMainForm&quot;</span>, onsubmit=&gt;<span class="stringliteral">&quot;submitAction()&quot;</span>);
<a name="l00991"></a>00991     print $self-&gt;hidden_authen_fields;
<a name="l00992"></a>00992     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00993"></a>00993 }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995 <span class="preprocessor"># output_problem_body subroutine</span>
<a name="l00996"></a>00996 <span class="preprocessor"></span>
<a name="l00997"></a>00997 <span class="preprocessor"># prints out the body of the current problem</span>
<a name="l00998"></a>00998 <span class="preprocessor"></span>
<a name="l00999"></a>00999 sub output_problem_body{
<a name="l01000"></a>01000     my $self = shift;
<a name="l01001"></a>01001     my $pg = $self-&gt;{pg};
<a name="l01002"></a>01002 
<a name="l01003"></a>01003     print <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01004"></a>01004     print CGI::p($pg-&gt;{body_text});
<a name="l01005"></a>01005     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01006"></a>01006 }
<a name="l01007"></a>01007 
<a name="l01008"></a>01008 <span class="preprocessor"># output_message subroutine</span>
<a name="l01009"></a>01009 <span class="preprocessor"></span>
<a name="l01010"></a>01010 <span class="preprocessor"># prints out a message about the problem</span>
<a name="l01011"></a>01011 <span class="preprocessor"></span>
<a name="l01012"></a>01012 sub output_message{
<a name="l01013"></a>01013     my $self = shift;
<a name="l01014"></a>01014     my $pg = $self-&gt;{pg};
<a name="l01015"></a>01015     my $r = $self-&gt;r;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017     print CGI::p(CGI::b($r-&gt;maketext(<span class="stringliteral">&quot;Note&quot;</span>).<span class="stringliteral">&quot;: &quot;</span>). CGI::i($pg-&gt;{result}-&gt;{msg})) if $pg-&gt;{result}-&gt;{msg};
<a name="l01018"></a>01018     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01019"></a>01019 }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 <span class="preprocessor"># output_editorLink subroutine</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span>
<a name="l01023"></a>01023 <span class="preprocessor"># processes and prints out the correct link to the editor of the current problem</span>
<a name="l01024"></a>01024 <span class="preprocessor"></span>
<a name="l01025"></a>01025 sub output_editorLink{
<a name="l01026"></a>01026     
<a name="l01027"></a>01027     my $self = shift;
<a name="l01028"></a>01028     
<a name="l01029"></a>01029     my $set = $self-&gt;{<span class="keyword">set</span>};
<a name="l01030"></a>01030     my $problem = $self-&gt;{problem};
<a name="l01031"></a>01031     my $pg = $self-&gt;{pg};
<a name="l01032"></a>01032     
<a name="l01033"></a>01033     my $r = $self-&gt;r;
<a name="l01034"></a>01034     
<a name="l01035"></a>01035     my $authz = $r-&gt;authz;
<a name="l01036"></a>01036     my $urlpath = $r-&gt;urlpath;
<a name="l01037"></a>01037     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l01038"></a>01038     
<a name="l01039"></a>01039     my $courseName = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l01040"></a>01040     
<a name="l01041"></a>01041 <span class="preprocessor">    # FIXME: move editor link to top, next to problem number.</span>
<a name="l01042"></a>01042 <span class="preprocessor"></span><span class="preprocessor">    # format as &quot;[edit]&quot; like we&#39;re doing with course info file, etc.</span>
<a name="l01043"></a>01043 <span class="preprocessor"></span><span class="preprocessor">    # add edit link for set as well.</span>
<a name="l01044"></a>01044 <span class="preprocessor"></span>    my $editorLink = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01045"></a>01045 <span class="preprocessor">    # if we are here without a real homework set, carry that through</span>
<a name="l01046"></a>01046 <span class="preprocessor"></span>    my $forced_field = [];
<a name="l01047"></a>01047     $forced_field = [<span class="stringliteral">&#39;sourceFilePath&#39;</span> =&gt;  $r-&gt;param(<span class="stringliteral">&quot;sourceFilePath&quot;</span>)] <span class="keywordflow">if</span>
<a name="l01048"></a>01048         ($set-&gt;set_id eq <span class="stringliteral">&#39;Undefined_Set&#39;</span>);
<a name="l01049"></a>01049     <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>)) {
<a name="l01050"></a>01050         my $editorPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::PGProblemEditor&quot;</span>, $r, 
<a name="l01051"></a>01051             courseID =&gt; $courseName, setID =&gt; $set-&gt;set_id, problemID =&gt; $problem-&gt;problem_id);
<a name="l01052"></a>01052         my $editorURL = $self-&gt;systemLink($editorPage, params=&gt;$forced_field);
<a name="l01053"></a>01053         $editorLink = CGI::p(CGI::a({href=&gt;$editorURL,target =&gt;<span class="stringliteral">&#39;WW_Editor&#39;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Edit this problem&quot;</span>)));
<a name="l01054"></a>01054     }
<a name="l01055"></a>01055     
<a name="l01056"></a>01056 <span class="preprocessor">    ##### translation errors? #####</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span>
<a name="l01058"></a>01058     <span class="keywordflow">if</span> ($pg-&gt;{flags}-&gt;{error_flag}) {
<a name="l01059"></a>01059         <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_problem_debugging_info&quot;</span>)) {
<a name="l01060"></a>01060             print <span class="stringliteral">&quot;Call errorOutput&lt;/br&gt;&quot;</span>;
<a name="l01061"></a>01061             print $self-&gt;errorOutput($pg-&gt;{errors}, $pg-&gt;{body_text});
<a name="l01062"></a>01062             print $editorLink;
<a name="l01063"></a>01063         } <span class="keywordflow">else</span> {
<a name="l01064"></a>01064             print $self-&gt;errorOutput($pg-&gt;{errors}, $r-&gt;maketext(<span class="stringliteral">&quot;You do not have permission to view the details of this error.&quot;</span>));
<a name="l01065"></a>01065         }
<a name="l01066"></a>01066         
<a name="l01067"></a>01067         print <span class="stringliteral">&quot;&quot;</span>;
<a name="l01068"></a>01068     }
<a name="l01069"></a>01069     <span class="keywordflow">else</span>{
<a name="l01070"></a>01070         print $editorLink;
<a name="l01071"></a>01071     }
<a name="l01072"></a>01072     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01073"></a>01073 }
<a name="l01074"></a>01074 
<a name="l01075"></a>01075 <span class="preprocessor"># output_checkboxes subroutine</span>
<a name="l01076"></a>01076 <span class="preprocessor"></span>
<a name="l01077"></a>01077 <span class="preprocessor"># prints out the checkbox input elements that are available for the current problem</span>
<a name="l01078"></a>01078 <span class="preprocessor"></span>
<a name="l01079"></a>01079 sub output_checkboxes{
<a name="l01080"></a>01080     my $self = shift;
<a name="l01081"></a>01081     my $r = $self-&gt;r;
<a name="l01082"></a>01082     my %can = %{ $self-&gt;{can} };
<a name="l01083"></a>01083     my %will = %{ $self-&gt;{will} };
<a name="l01084"></a>01084 
<a name="l01085"></a>01085     <span class="keywordflow">if</span> ($can{showCorrectAnswers}) {
<a name="l01086"></a>01086         print <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(
<a name="l01087"></a>01087             -type    =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>,
<a name="l01088"></a>01088             -<span class="keywordtype">id</span>      =&gt; <span class="stringliteral">&quot;showCorrectAnswers_id&quot;</span>,
<a name="l01089"></a>01089             -label_text =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Show correct answers&quot;</span>),
<a name="l01090"></a>01090             -input_attr =&gt; $will{showCorrectAnswers} ?
<a name="l01091"></a>01091             {
<a name="l01092"></a>01092                 -name    =&gt; <span class="stringliteral">&quot;showCorrectAnswers&quot;</span>,
<a name="l01093"></a>01093                 -checked =&gt; <span class="stringliteral">&quot;checked&quot;</span>,
<a name="l01094"></a>01094                 -value   =&gt; 1,
<a name="l01095"></a>01095             }
<a name="l01096"></a>01096             :
<a name="l01097"></a>01097             {
<a name="l01098"></a>01098                 -name    =&gt; <span class="stringliteral">&quot;showCorrectAnswers&quot;</span>,
<a name="l01099"></a>01099                 -value   =&gt; 1,
<a name="l01100"></a>01100             }
<a name="l01101"></a>01101         );
<a name="l01102"></a>01102     }
<a name="l01103"></a>01103     <span class="keywordflow">if</span> ($can{showHints}) {
<a name="l01104"></a>01104         print CGI::div({style=&gt;<span class="stringliteral">&quot;color:red&quot;</span>},
<a name="l01105"></a>01105             <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(
<a name="l01106"></a>01106                 -type    =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>,
<a name="l01107"></a>01107                 -<span class="keywordtype">id</span>      =&gt; <span class="stringliteral">&quot;showHints_id&quot;</span>,
<a name="l01108"></a>01108                 -label_text =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Show Hints&quot;</span>),
<a name="l01109"></a>01109                 -input_attr =&gt; $will{showHints} ?
<a name="l01110"></a>01110                 {
<a name="l01111"></a>01111                     -name    =&gt; <span class="stringliteral">&quot;showHints&quot;</span>,
<a name="l01112"></a>01112                     -checked =&gt; <span class="stringliteral">&quot;checked&quot;</span>,
<a name="l01113"></a>01113                     -value   =&gt; 1,
<a name="l01114"></a>01114                 }
<a name="l01115"></a>01115                 :
<a name="l01116"></a>01116                 {
<a name="l01117"></a>01117                     -name    =&gt; <span class="stringliteral">&quot;showCorrectAnswers&quot;</span>,
<a name="l01118"></a>01118                     -value   =&gt; 1,
<a name="l01119"></a>01119                 }
<a name="l01120"></a>01120             )
<a name="l01121"></a>01121         );
<a name="l01122"></a>01122     }
<a name="l01123"></a>01123     <span class="keywordflow">if</span> ($can{showSolutions}) {
<a name="l01124"></a>01124         print <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(
<a name="l01125"></a>01125             -type    =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>,
<a name="l01126"></a>01126             -<span class="keywordtype">id</span>      =&gt; <span class="stringliteral">&quot;showSolutions_id&quot;</span>,
<a name="l01127"></a>01127             -label_text =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Show Solutions&quot;</span>),
<a name="l01128"></a>01128             -input_attr =&gt; $will{showSolutions} ?
<a name="l01129"></a>01129             {
<a name="l01130"></a>01130                 -name    =&gt; <span class="stringliteral">&quot;showSolutions&quot;</span>,
<a name="l01131"></a>01131                 -checked =&gt; <span class="stringliteral">&quot;checked&quot;</span>,
<a name="l01132"></a>01132                 -value   =&gt; 1,
<a name="l01133"></a>01133             }
<a name="l01134"></a>01134             :
<a name="l01135"></a>01135             {
<a name="l01136"></a>01136                 -name    =&gt; <span class="stringliteral">&quot;showCorrectAnswers&quot;</span>,
<a name="l01137"></a>01137                 -value   =&gt; 1,
<a name="l01138"></a>01138             }
<a name="l01139"></a>01139         );
<a name="l01140"></a>01140     }
<a name="l01141"></a>01141     
<a name="l01142"></a>01142     <span class="keywordflow">if</span> ($can{showCorrectAnswers} or $can{showHints} or $can{showSolutions}) {
<a name="l01143"></a>01143         print CGI::br();
<a name="l01144"></a>01144     }
<a name="l01145"></a>01145     
<a name="l01146"></a>01146     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01147"></a>01147 }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149 <span class="preprocessor"># output_submit_buttons</span>
<a name="l01150"></a>01150 <span class="preprocessor"></span>
<a name="l01151"></a>01151 <span class="preprocessor"># prints out the submit button input elements that are available for the current problem</span>
<a name="l01152"></a>01152 <span class="preprocessor"></span>
<a name="l01153"></a>01153 sub output_submit_buttons{
<a name="l01154"></a>01154     my $self = shift;
<a name="l01155"></a>01155     my $r = $self-&gt;r;
<a name="l01156"></a>01156     my %can = %{ $self-&gt;{can} };
<a name="l01157"></a>01157     
<a name="l01158"></a>01158     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l01159"></a>01159     my $effectiveUser = $r-&gt;param(<span class="stringliteral">&#39;effectiveUser&#39;</span>);
<a name="l01160"></a>01160 
<a name="l01161"></a>01161     print <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;previewAnswers_id&quot;</span>, -input_attr=&gt;{-name=&gt;<span class="stringliteral">&quot;previewAnswers&quot;</span>, -value=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Preview Answers&quot;</span>)});
<a name="l01162"></a>01162     <span class="keywordflow">if</span> ($can{checkAnswers}) {
<a name="l01163"></a>01163         print <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;checkAnswers_id&quot;</span>, -input_attr=&gt;{-name=&gt;<span class="stringliteral">&quot;checkAnswers&quot;</span>, -value=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Check Answers&quot;</span>)});
<a name="l01164"></a>01164     }
<a name="l01165"></a>01165     <span class="keywordflow">if</span> ($can{getSubmitButton}) {
<a name="l01166"></a>01166         <span class="keywordflow">if</span> ($user ne $effectiveUser) {
<a name="l01167"></a>01167 <span class="preprocessor">            # if acting as a student, make it clear that answer submissions will</span>
<a name="l01168"></a>01168 <span class="preprocessor"></span><span class="preprocessor">            # apply to the student&#39;s records, not the professor&#39;s.</span>
<a name="l01169"></a>01169 <span class="preprocessor"></span>            print <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;submitAnswers_id&quot;</span>, -input_attr=&gt;{-name=&gt;<span class="stringliteral">&quot;submitAnswers&quot;</span>, -value=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Submit Answers for [_1]&quot;</span>, $effectiveUser)});
<a name="l01170"></a>01170         } <span class="keywordflow">else</span> {
<a name="l01171"></a>01171 <span class="preprocessor">            #print CGI::submit(-name=&gt;&quot;submitAnswers&quot;, -label=&gt;&quot;Submit Answers&quot;, -onclick=&gt;&quot;alert(&#39;submit button clicked&#39;)&quot;);</span>
<a name="l01172"></a>01172 <span class="preprocessor"></span>            print <a class="code" href="classWeBWorK.html#a0e533467c35899fd4d882a3a36fc04b5">WeBWorK::CGI_labeled_input</a>(-type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;submitAnswers_id&quot;</span>, -input_attr=&gt;{-name=&gt;<span class="stringliteral">&quot;submitAnswers&quot;</span>, -value=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Submit Answers&quot;</span>), -onclick=&gt;<span class="stringliteral">&quot;&quot;</span>});
<a name="l01173"></a>01173 <span class="preprocessor">            # FIXME  for unknown reasons the -onclick label seems to have to be there in order to allow the forms onsubmit to trigger</span>
<a name="l01174"></a>01174 <span class="preprocessor"></span><span class="preprocessor">            # WTF???</span>
<a name="l01175"></a>01175 <span class="preprocessor"></span>        }
<a name="l01176"></a>01176     }
<a name="l01177"></a>01177     
<a name="l01178"></a>01178     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01179"></a>01179 }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181 <span class="preprocessor"># output_score_summary subroutine</span>
<a name="l01182"></a>01182 <span class="preprocessor"></span>
<a name="l01183"></a>01183 <span class="preprocessor"># prints out a summary of the student&#39;s current progress and status on the current problem</span>
<a name="l01184"></a>01184 <span class="preprocessor"></span>
<a name="l01185"></a>01185 sub output_score_summary{
<a name="l01186"></a>01186     my $self = shift;
<a name="l01187"></a>01187     my $r = $self-&gt;r;
<a name="l01188"></a>01188     my $problem = $self-&gt;{problem};
<a name="l01189"></a>01189     my $set = $self-&gt;{<span class="keyword">set</span>};
<a name="l01190"></a>01190     my $pg = $self-&gt;{pg};
<a name="l01191"></a>01191     my $scoreRecordedMessage = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01192"></a>01192     <span class="keywordflow">if</span>  (defined $self-&gt;{scoreRecordedMessage}) {
<a name="l01193"></a>01193         $scoreRecordedMessage = $self-&gt;{scoreRecordedMessage};
<a name="l01194"></a>01194     } <span class="keywordflow">else</span> {
<a name="l01195"></a>01195         $scoreRecordedMessage = <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1ProblemUtil_1_1ProblemUtil.html#a6e7e9b2d6c1a078f04c67bc68645de90">WeBWorK::ContentGenerator::ProblemUtil::ProblemUtil::process_and_log_answer</a>($self) || <span class="stringliteral">&quot;&quot;</span>;
<a name="l01196"></a>01196     }
<a name="l01197"></a>01197     my $submitAnswers = $self-&gt;{submitAnswers};
<a name="l01198"></a>01198     
<a name="l01199"></a>01199 <span class="preprocessor">    # score summary</span>
<a name="l01200"></a>01200 <span class="preprocessor"></span>    my $attempts = $problem-&gt;num_correct + $problem-&gt;num_incorrect;
<a name="l01201"></a>01201 <span class="preprocessor">    #my $attemptsNoun = $attempts != 1 ? $r-&gt;maketext(&quot;times&quot;) : $r-&gt;maketext(&quot;time&quot;);</span>
<a name="l01202"></a>01202 <span class="preprocessor"></span>    my $problem_status    = $problem-&gt;status || 0;
<a name="l01203"></a>01203     my $lastScore = sprintf(<span class="stringliteral">&quot;%.0f%%&quot;</span>, $problem_status * 100); # Round to whole number
<a name="l01204"></a>01204 <span class="preprocessor">    #my ($attemptsLeft, $attemptsLeftNoun);</span>
<a name="l01205"></a>01205 <span class="preprocessor"></span>    my $attemptsLeft = $problem-&gt;max_attempts - $attempts;
<a name="l01206"></a>01206 <span class="preprocessor">#   if ($problem-&gt;max_attempts == -1) {</span>
<a name="l01207"></a>01207 <span class="preprocessor"></span><span class="preprocessor">#       # unlimited attempts</span>
<a name="l01208"></a>01208 <span class="preprocessor"></span><span class="preprocessor">#       $attemptsLeft = $r-&gt;maketext(&quot;unlimited&quot;);</span>
<a name="l01209"></a>01209 <span class="preprocessor"></span><span class="preprocessor">#       $attemptsLeftNoun = $r-&gt;maketext(&quot;attempts&quot;);</span>
<a name="l01210"></a>01210 <span class="preprocessor"></span><span class="preprocessor">#   } else {</span>
<a name="l01211"></a>01211 <span class="preprocessor"></span><span class="preprocessor">#       $attemptsLeft = $problem-&gt;max_attempts - $attempts;</span>
<a name="l01212"></a>01212 <span class="preprocessor"></span><span class="preprocessor">#       $attemptsLeftNoun = $attemptsLeft == 1 ? $r-&gt;maketext(&quot;attempt&quot;) : $r-&gt;maketext(&quot;attempts&quot;);</span>
<a name="l01213"></a>01213 <span class="preprocessor"></span><span class="preprocessor">#   }</span>
<a name="l01214"></a>01214 <span class="preprocessor"></span>    
<a name="l01215"></a>01215     my $setClosed = 0;
<a name="l01216"></a>01216     my $setClosedMessage;
<a name="l01217"></a>01217     <span class="keywordflow">if</span> (before($set-&gt;open_date) or after($set-&gt;due_date)) {
<a name="l01218"></a>01218         $setClosed = 1;
<a name="l01219"></a>01219         <span class="keywordflow">if</span> (before($set-&gt;open_date)) {
<a name="l01220"></a>01220             $setClosedMessage = $r-&gt;maketext(<span class="stringliteral">&quot;This homework set is not yet open.&quot;</span>);
<a name="l01221"></a>01221         } elsif (after($set-&gt;due_date)) {
<a name="l01222"></a>01222             $setClosedMessage = $r-&gt;maketext(<span class="stringliteral">&quot;This homework set is closed.&quot;</span>);
<a name="l01223"></a>01223         }
<a name="l01224"></a>01224     }
<a name="l01225"></a>01225 <span class="preprocessor">    #if (before($set-&gt;open_date) or after($set-&gt;due_date)) {</span>
<a name="l01226"></a>01226 <span class="preprocessor"></span><span class="preprocessor">    #   $setClosed = 1;</span>
<a name="l01227"></a>01227 <span class="preprocessor"></span><span class="preprocessor">    #   $setClosedMessage = &quot;This homework set is closed.&quot;;</span>
<a name="l01228"></a>01228 <span class="preprocessor"></span><span class="preprocessor">    #   if ($authz-&gt;hasPermissions($user, &quot;view_answers&quot;)) {</span>
<a name="l01229"></a>01229 <span class="preprocessor"></span><span class="preprocessor">    #       $setClosedMessage .= &quot; However, since you are a privileged user, additional attempts will be recorded.&quot;;</span>
<a name="l01230"></a>01230 <span class="preprocessor"></span><span class="preprocessor">    #   } else {</span>
<a name="l01231"></a>01231 <span class="preprocessor"></span><span class="preprocessor">    #       $setClosedMessage .= &quot; Additional attempts will not be recorded.&quot;;</span>
<a name="l01232"></a>01232 <span class="preprocessor"></span><span class="preprocessor">    #   }</span>
<a name="l01233"></a>01233 <span class="preprocessor"></span><span class="preprocessor">    #}</span>
<a name="l01234"></a>01234 <span class="preprocessor"></span>    unless (defined( $pg-&gt;{state}-&gt;{state_summary_msg}) and $pg-&gt;{state}-&gt;{state_summary_msg}=~/\S/) {
<a name="l01235"></a>01235         my $notCountedMessage = ($problem-&gt;value) ? <span class="stringliteral">&quot;&quot;</span> : $r-&gt;maketext(<span class="stringliteral">&quot;(This problem will not count towards your grade.)&quot;</span>);
<a name="l01236"></a>01236         print CGI::p(join(<span class="stringliteral">&quot;&quot;</span>,
<a name="l01237"></a>01237             $submitAnswers ? $scoreRecordedMessage . CGI::br() : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01238"></a>01238             $r-&gt;maketext(<span class="stringliteral">&quot;You have attempted this problem [quant,_1,time,times].&quot;</span>,$attempts), CGI::br(),
<a name="l01239"></a>01239             $submitAnswers ? $r-&gt;maketext(<span class="stringliteral">&quot;You received a score of [_1] for this attempt.&quot;</span>,sprintf(<span class="stringliteral">&quot;%.0f%%&quot;</span>, $pg-&gt;{result}-&gt;{score} * 100)) . CGI::br():<span class="stringliteral">&#39;&#39;</span>,
<a name="l01240"></a>01240             $problem-&gt;attempted
<a name="l01241"></a>01241                 ? $r-&gt;maketext(<span class="stringliteral">&quot;Your overall recorded score is [_1].  [_2]&quot;</span>,$lastScore,$notCountedMessage) . CGI::br()
<a name="l01242"></a>01242                 : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01243"></a>01243 #           $setClosed ? $setClosedMessage : $r-&gt;maketext(<span class="stringliteral">&quot;You have [_1] [_2] remaining.&quot;</span>,$attemptsLeft,$attemptsLeftNoun) 
<a name="l01244"></a>01244             $setClosed ? $setClosedMessage : $r-&gt;maketext(<span class="stringliteral">&quot;You have [negquant,_1,unlimited attempts,attempt,attempts] remaining.&quot;</span>,$attemptsLeft) 
<a name="l01245"></a>01245         ));
<a name="l01246"></a>01246     }<span class="keywordflow">else</span> {
<a name="l01247"></a>01247         print CGI::p($pg-&gt;{state}-&gt;{state_summary_msg});
<a name="l01248"></a>01248     }
<a name="l01249"></a>01249     
<a name="l01250"></a>01250     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01251"></a>01251 }
<a name="l01252"></a>01252 
<a name="l01253"></a>01253 <span class="preprocessor"># output_misc subroutine</span>
<a name="l01254"></a>01254 <span class="preprocessor"></span>
<a name="l01255"></a>01255 <span class="preprocessor"># prints out other necessary elements</span>
<a name="l01256"></a>01256 <span class="preprocessor"></span>
<a name="l01257"></a>01257 sub output_misc{
<a name="l01258"></a>01258 
<a name="l01259"></a>01259     my $self = shift;
<a name="l01260"></a>01260     my $r = $self-&gt;r;
<a name="l01261"></a>01261     my $ce = $r-&gt;ce;
<a name="l01262"></a>01262     my $db = $r-&gt;db;
<a name="l01263"></a>01263     my $pg = $self-&gt;{pg};
<a name="l01264"></a>01264     my %will = %{ $self-&gt;{will} };
<a name="l01265"></a>01265     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l01266"></a>01266 
<a name="l01267"></a>01267     
<a name="l01268"></a>01268 <span class="preprocessor">    # save state for viewOptions</span>
<a name="l01269"></a>01269 <span class="preprocessor"></span>    print  CGI::hidden(
<a name="l01270"></a>01270                -name  =&gt; <span class="stringliteral">&quot;showOldAnswers&quot;</span>,
<a name="l01271"></a>01271                -value =&gt; $will{showOldAnswers}
<a name="l01272"></a>01272            ),
<a name="l01273"></a>01273 
<a name="l01274"></a>01274            CGI::hidden(
<a name="l01275"></a>01275                -name  =&gt; <span class="stringliteral">&quot;displayMode&quot;</span>,
<a name="l01276"></a>01276                -value =&gt; $self-&gt;{displayMode}
<a name="l01277"></a>01277            );
<a name="l01278"></a>01278     print( CGI::hidden(
<a name="l01279"></a>01279                -name    =&gt; <span class="stringliteral">&#39;editMode&#39;</span>,
<a name="l01280"></a>01280                -value   =&gt; $self-&gt;{editMode},
<a name="l01281"></a>01281            )
<a name="l01282"></a>01282     ) if defined($self-&gt;{editMode}) and $self-&gt;{editMode} eq <span class="stringliteral">&#39;temporaryFile&#39;</span>;
<a name="l01283"></a>01283     
<a name="l01284"></a>01284 <span class="preprocessor">    # this is a security risk -- students can use this to find the source code for the problem</span>
<a name="l01285"></a>01285 <span class="preprocessor"></span>
<a name="l01286"></a>01286     my $permissionLevel = $db-&gt;getPermissionLevel($user)-&gt;permission;
<a name="l01287"></a>01287     my $professorPermissionLevel = $ce-&gt;{userRoles}-&gt;{professor};
<a name="l01288"></a>01288     print( CGI::hidden(
<a name="l01289"></a>01289                 -name   =&gt; <span class="stringliteral">&#39;sourceFilePath&#39;</span>,
<a name="l01290"></a>01290                 -value  =&gt;  $self-&gt;{problem}-&gt;{source_file}
<a name="l01291"></a>01291     ))  if defined($self-&gt;{problem}-&gt;{source_file}) and $permissionLevel&gt;= $professorPermissionLevel; # only allow <span class="keyword">this</span> <span class="keywordflow">for</span> professors
<a name="l01292"></a>01292 
<a name="l01293"></a>01293     print( CGI::hidden(
<a name="l01294"></a>01294                 -name   =&gt; <span class="stringliteral">&#39;problemSeed&#39;</span>,
<a name="l01295"></a>01295                 -value  =&gt;  $r-&gt;param(<span class="stringliteral">&quot;problemSeed&quot;</span>)
<a name="l01296"></a>01296     ))  if defined($r-&gt;param(&quot;problemSeed&quot;)) and $permissionLevel&gt;= $professorPermissionLevel; <span class="preprocessor"># only allow this for professors</span>
<a name="l01297"></a>01297 <span class="preprocessor"></span>    
<a name="l01298"></a>01298     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01299"></a>01299 }
<a name="l01300"></a>01300 
<a name="l01301"></a>01301 <span class="preprocessor"># output_summary subroutine</span>
<a name="l01302"></a>01302 <span class="preprocessor"></span>
<a name="l01303"></a>01303 <span class="preprocessor"># prints out the feedback on the questions that the student has answered for    </span>
<a name="l01304"></a>01304 <span class="preprocessor"></span><span class="preprocessor"># the current problem, along with available information about correctness</span>
<a name="l01305"></a>01305 <span class="preprocessor"></span>
<a name="l01306"></a>01306 sub output_summary{
<a name="l01307"></a>01307     
<a name="l01308"></a>01308     my $self = shift;
<a name="l01309"></a>01309     
<a name="l01310"></a>01310     my $editMode = $self-&gt;{editMode};
<a name="l01311"></a>01311     my $problem = $self-&gt;{problem};
<a name="l01312"></a>01312     my $pg = $self-&gt;{pg};
<a name="l01313"></a>01313     my $submitAnswers = $self-&gt;{submitAnswers};
<a name="l01314"></a>01314     my %will = %{ $self-&gt;{will} };
<a name="l01315"></a>01315     my $checkAnswers = $self-&gt;{checkAnswers};
<a name="l01316"></a>01316     my $previewAnswers = $self-&gt;{previewAnswers};
<a name="l01317"></a>01317     
<a name="l01318"></a>01318     my $r = $self-&gt;r;
<a name="l01319"></a>01319     
<a name="l01320"></a>01320     my $authz = $r-&gt;authz;
<a name="l01321"></a>01321     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l01322"></a>01322     
<a name="l01323"></a>01323 <span class="preprocessor">    # attempt summary</span>
<a name="l01324"></a>01324 <span class="preprocessor"></span><span class="preprocessor">    #FIXME -- the following is a kludge:  if showPartialCorrectAnswers is negative don&#39;t show anything.</span>
<a name="l01325"></a>01325 <span class="preprocessor"></span><span class="preprocessor">    # until after the due date</span>
<a name="l01326"></a>01326 <span class="preprocessor"></span><span class="preprocessor">    # do I need to check $will{showCorrectAnswers} to make preflight work??</span>
<a name="l01327"></a>01327 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (defined($pg-&gt;{flags}-&gt;{showPartialCorrectAnswers}) and ($pg-&gt;{flags}-&gt;{showPartialCorrectAnswers} &gt;= 0 and $submitAnswers) ) {
<a name="l01328"></a>01328 <span class="preprocessor">        # print this if user submitted answers OR requested correct answers</span>
<a name="l01329"></a>01329 <span class="preprocessor"></span>        
<a name="l01330"></a>01330         print $self-&gt;attemptResults($pg, 1,
<a name="l01331"></a>01331             $will{showCorrectAnswers},
<a name="l01332"></a>01332             $pg-&gt;{flags}-&gt;{showPartialCorrectAnswers}, 1, 1);
<a name="l01333"></a>01333     } elsif ($checkAnswers) {
<a name="l01334"></a>01334 <span class="preprocessor">        # print this if user previewed answers</span>
<a name="l01335"></a>01335 <span class="preprocessor"></span>        print CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},$r-&gt;maketext(<span class="stringliteral">&quot;ANSWERS ONLY CHECKED -- ANSWERS NOT RECORDED&quot;</span>)), CGI::br();
<a name="l01336"></a>01336         print $self-&gt;attemptResults($pg, 1, $will{showCorrectAnswers}, 1, 1, 1);
<a name="l01337"></a>01337 <span class="preprocessor">            # show attempt answers</span>
<a name="l01338"></a>01338 <span class="preprocessor"></span><span class="preprocessor">            # show correct answers if asked</span>
<a name="l01339"></a>01339 <span class="preprocessor"></span><span class="preprocessor">            # show attempt results (correctness)</span>
<a name="l01340"></a>01340 <span class="preprocessor"></span><span class="preprocessor">            # show attempt previews</span>
<a name="l01341"></a>01341 <span class="preprocessor"></span>    } elsif ($previewAnswers) {
<a name="l01342"></a>01342 <span class="preprocessor">        # print this if user previewed answers</span>
<a name="l01343"></a>01343 <span class="preprocessor"></span>        print CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},$r-&gt;maketext(<span class="stringliteral">&quot;PREVIEW ONLY -- ANSWERS NOT RECORDED&quot;</span>)),CGI::br(),$self-&gt;attemptResults($pg, 1, 0, 0, 0, 1);
<a name="l01344"></a>01344 <span class="preprocessor">            # show attempt answers</span>
<a name="l01345"></a>01345 <span class="preprocessor"></span><span class="preprocessor">            # don&#39;t show correct answers</span>
<a name="l01346"></a>01346 <span class="preprocessor"></span><span class="preprocessor">            # don&#39;t show attempt results (correctness)</span>
<a name="l01347"></a>01347 <span class="preprocessor"></span><span class="preprocessor">            # show attempt previews</span>
<a name="l01348"></a>01348 <span class="preprocessor"></span>    }
<a name="l01349"></a>01349     
<a name="l01350"></a>01350     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01351"></a>01351 }
<a name="l01352"></a>01352 
<a name="l01353"></a>01353 <span class="preprocessor"># output_custom_edit_message</span>
<a name="l01354"></a>01354 <span class="preprocessor"></span>
<a name="l01355"></a>01355 <span class="preprocessor"># prints out a custom edit message</span>
<a name="l01356"></a>01356 <span class="preprocessor"></span>
<a name="l01357"></a>01357 sub output_custom_edit_message{
<a name="l01358"></a>01358     my $self = shift;
<a name="l01359"></a>01359     my $r = $self-&gt;r;
<a name="l01360"></a>01360     my $authz = $r-&gt;authz;
<a name="l01361"></a>01361     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l01362"></a>01362     my $editMode = $self-&gt;{editMode};
<a name="l01363"></a>01363     my $problem = $self-&gt;{problem};
<a name="l01364"></a>01364     
<a name="l01365"></a>01365 <span class="preprocessor">    # custom message for editor</span>
<a name="l01366"></a>01366 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>) and defined $editMode) {
<a name="l01367"></a>01367         <span class="keywordflow">if</span> ($editMode eq <span class="stringliteral">&quot;temporaryFile&quot;</span>) {
<a name="l01368"></a>01368             print CGI::p(CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;temporaryFile&#39;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Viewing temporary file&quot;</span>), $problem-&gt;source_file));
<a name="l01369"></a>01369         } elsif ($editMode eq <span class="stringliteral">&quot;savedFile&quot;</span>) {
<a name="l01370"></a>01370 <span class="preprocessor">            # taken care of in the initialization phase</span>
<a name="l01371"></a>01371 <span class="preprocessor"></span>        }
<a name="l01372"></a>01372     }
<a name="l01373"></a>01373     
<a name="l01374"></a>01374     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01375"></a>01375 }
<a name="l01376"></a>01376 
<a name="l01377"></a>01377 <span class="preprocessor"># output_past_answer_button</span>
<a name="l01378"></a>01378 <span class="preprocessor"></span>
<a name="l01379"></a>01379 <span class="preprocessor"># prints out the &quot;Show Past Answers&quot; button</span>
<a name="l01380"></a>01380 <span class="preprocessor"></span>
<a name="l01381"></a>01381 sub output_past_answer_button{
<a name="l01382"></a>01382     my $self = shift;
<a name="l01383"></a>01383     my $r = $self-&gt;r;
<a name="l01384"></a>01384     my $problem = $self-&gt;{problem};
<a name="l01385"></a>01385     
<a name="l01386"></a>01386     my $authz = $r-&gt;authz;
<a name="l01387"></a>01387     my $urlpath = $r-&gt;urlpath;
<a name="l01388"></a>01388     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l01389"></a>01389     
<a name="l01390"></a>01390     my $courseName = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l01391"></a>01391 
<a name="l01392"></a>01392     my $pastAnswersPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::ShowAnswers&quot;</span>, $r, 
<a name="l01393"></a>01393         courseID =&gt; $courseName);
<a name="l01394"></a>01394     my $showPastAnswersURL = $self-&gt;systemLink($pastAnswersPage, authen =&gt; 0); # no authen info <span class="keywordflow">for</span> form action
<a name="l01395"></a>01395         
<a name="l01396"></a>01396 <span class="preprocessor">    # print answer inspection button</span>
<a name="l01397"></a>01397 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_answers&quot;</span>)) {
<a name="l01398"></a>01398         print <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01399"></a>01399             CGI::start_form(-method=&gt;<span class="stringliteral">&quot;POST&quot;</span>,-action=&gt;$showPastAnswersURL,-target=&gt;<span class="stringliteral">&quot;WW_Info&quot;</span>),<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01400"></a>01400             $self-&gt;hidden_authen_fields,<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01401"></a>01401             CGI::hidden(-name =&gt; <span class="stringliteral">&#39;courseID&#39;</span>,  -value=&gt;$courseName), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01402"></a>01402             CGI::hidden(-name =&gt; <span class="stringliteral">&#39;problemID&#39;</span>, -value=&gt;$problem-&gt;problem_id), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01403"></a>01403             CGI::hidden(-name =&gt; <span class="stringliteral">&#39;setID&#39;</span>,  -value=&gt;$problem-&gt;set_id), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01404"></a>01404             CGI::hidden(-name =&gt; <span class="stringliteral">&#39;studentUser&#39;</span>,    -value=&gt;$problem-&gt;user_id), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01405"></a>01405             CGI::p( {-align=&gt;<span class="stringliteral">&quot;left&quot;</span>},
<a name="l01406"></a>01406                 CGI::submit(-name =&gt; <span class="stringliteral">&#39;action&#39;</span>,  -value=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Show Past Answers&quot;</span>))
<a name="l01407"></a>01407             ), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l01408"></a>01408             CGI::endform();
<a name="l01409"></a>01409     }
<a name="l01410"></a>01410     
<a name="l01411"></a>01411     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01412"></a>01412 }
<a name="l01413"></a>01413 
<a name="l01414"></a>01414 <span class="preprocessor"># output_email_instructor subroutine</span>
<a name="l01415"></a>01415 <span class="preprocessor"></span>
<a name="l01416"></a>01416 <span class="preprocessor"># prints out the &quot;Email Instructor&quot; button</span>
<a name="l01417"></a>01417 <span class="preprocessor"></span>
<a name="l01418"></a>01418 sub output_email_instructor{
<a name="l01419"></a>01419     my $self = shift;
<a name="l01420"></a>01420     my $problem = $self-&gt;{problem};
<a name="l01421"></a>01421     my %will = %{ $self-&gt;{will} };
<a name="l01422"></a>01422     my $pg = $self-&gt;{pg};
<a name="l01423"></a>01423 
<a name="l01424"></a>01424     print $self-&gt;feedbackMacro(
<a name="l01425"></a>01425         module             =&gt; __PACKAGE__,
<a name="l01426"></a>01426         <span class="keyword">set</span>                =&gt; $self-&gt;{<span class="keyword">set</span>}-&gt;set_id,
<a name="l01427"></a>01427         problem            =&gt; $problem-&gt;problem_id,
<a name="l01428"></a>01428         displayMode        =&gt; $self-&gt;{displayMode},
<a name="l01429"></a>01429         showOldAnswers     =&gt; $will{showOldAnswers},
<a name="l01430"></a>01430         showCorrectAnswers =&gt; $will{showCorrectAnswers},
<a name="l01431"></a>01431         showHints          =&gt; $will{showHints},
<a name="l01432"></a>01432         showSolutions      =&gt; $will{showSolutions},
<a name="l01433"></a>01433         pg_object          =&gt; $pg,
<a name="l01434"></a>01434     );
<a name="l01435"></a>01435     
<a name="l01436"></a>01436     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01437"></a>01437 }
<a name="l01438"></a>01438 
<a name="l01439"></a>01439 <span class="preprocessor"># output_hidden_info subroutine</span>
<a name="l01440"></a>01440 <span class="preprocessor"></span>
<a name="l01441"></a>01441 <span class="preprocessor"># outputs the hidden fields required for the form</span>
<a name="l01442"></a>01442 <span class="preprocessor"></span>
<a name="l01443"></a>01443 sub output_hidden_info{
<a name="l01444"></a>01444     my $self = shift;
<a name="l01445"></a>01445     my $previewAnswers = $self-&gt;{previewAnswers};
<a name="l01446"></a>01446     
<a name="l01447"></a>01447     <span class="keywordflow">if</span>($previewAnswers){
<a name="l01448"></a>01448         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01449"></a>01449     }
<a name="l01450"></a>01450     <span class="keywordflow">else</span>{
<a name="l01451"></a>01451         <span class="keywordflow">if</span>(defined $self-&gt;{correct_ids}){
<a name="l01452"></a>01452             my $correctRef = $self-&gt;{correct_ids};
<a name="l01453"></a>01453             my @correct = @$correctRef;
<a name="l01454"></a>01454             <span class="keywordflow">foreach</span>(@correct){
<a name="l01455"></a>01455                 print CGI::hidden(-name=&gt;<span class="stringliteral">&quot;correct_ids&quot;</span>, -value=&gt;$_.<span class="stringliteral">&quot;_val&quot;</span>);
<a name="l01456"></a>01456             }
<a name="l01457"></a>01457         }
<a name="l01458"></a>01458         <span class="keywordflow">if</span>(defined $self-&gt;{incorrect_ids}){
<a name="l01459"></a>01459             my $incorrectRef = $self-&gt;{incorrect_ids};
<a name="l01460"></a>01460             my @incorrect = @$incorrectRef;
<a name="l01461"></a>01461             <span class="keywordflow">foreach</span>(@incorrect){
<a name="l01462"></a>01462                 print CGI::hidden(-name=&gt;<span class="stringliteral">&quot;incorrect_ids&quot;</span>, -value=&gt;$_.<span class="stringliteral">&quot;_val&quot;</span>);
<a name="l01463"></a>01463             }
<a name="l01464"></a>01464         }
<a name="l01465"></a>01465         <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01466"></a>01466     }
<a name="l01467"></a>01467 }
<a name="l01468"></a>01468 
<a name="l01469"></a>01469 <span class="preprocessor"># output_JS subroutine</span>
<a name="l01470"></a>01470 <span class="preprocessor"></span>
<a name="l01471"></a>01471 <span class="preprocessor"># outputs all of the Javascript needed for this page. The main javascript needed here is color.js, which colors input fields based on whether or not they are correct when answers are submitted.  When a problem attempts results, it prints out hidden fields containing identification information for the fields that were correct and the fields that were incorrect.  color.js collects of the correct and incorrect fields into two arrays using the information gathered from the hidden fields, and then loops through and changes the styles so that the colors will show up correctly.</span>
<a name="l01472"></a>01472 <span class="preprocessor"></span>
<a name="l01473"></a>01473 sub output_JS{
<a name="l01474"></a>01474     my $self = shift;
<a name="l01475"></a>01475     my $r = $self-&gt;r;
<a name="l01476"></a>01476     my $ce = $r-&gt;ce;
<a name="l01477"></a>01477 
<a name="l01478"></a>01478     my $site_url = $ce-&gt;{webworkURLs}-&gt;{htdocs};
<a name="l01479"></a>01479     
<a name="l01480"></a>01480 <span class="preprocessor">    # This file declares a function called addOnLoadEvent which allows multiple different scripts to add to a single onLoadEvent handler on a page.</span>
<a name="l01481"></a>01481 <span class="preprocessor"></span>    print CGI::start_script({type=&gt;<span class="stringliteral">&quot;text/javascript&quot;</span>, src=&gt;<span class="stringliteral">&quot;$site_url/js/addOnLoadEvent.js&quot;</span>}), CGI::end_script();
<a name="l01482"></a>01482     
<a name="l01483"></a>01483     print CGI::start_script({type=&gt;<span class="stringliteral">&quot;text/javascript&quot;</span>, src=&gt;<span class="stringliteral">&quot;$site_url/js/removeDuplicates.js&quot;</span>}), CGI::end_script();
<a name="l01484"></a>01484     
<a name="l01485"></a>01485 <span class="preprocessor">    # The color.js file, which uses javascript to color the input fields based on whether they are correct or incorrect.</span>
<a name="l01486"></a>01486 <span class="preprocessor"></span>    print CGI::start_script({type=&gt;<span class="stringliteral">&quot;text/javascript&quot;</span>, src=&gt;<span class="stringliteral">&quot;$site_url/js/color.js&quot;</span>}), CGI::end_script();
<a name="l01487"></a>01487     
<a name="l01488"></a>01488     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01489"></a>01489 }
<a name="l01490"></a>01490 
<a name="l01491"></a>01491 <span class="preprocessor"># Simply here to indicate to the template that this page has body part methods which can be called</span>
<a name="l01492"></a>01492 <span class="preprocessor"></span>
<a name="l01493"></a>01493 sub can_body_parts{
<a name="l01494"></a>01494     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01495"></a>01495 }
<a name="l01496"></a>01496 
<a name="l01497"></a>01497 <span class="preprocessor"># output_wztooltip_JS subroutine</span>
<a name="l01498"></a>01498 <span class="preprocessor"></span>
<a name="l01499"></a>01499 <span class="preprocessor"># prints out the wz_tooltip.js script for the current site.</span>
<a name="l01500"></a>01500 <span class="preprocessor"></span>
<a name="l01501"></a>01501 sub output_wztooltip_JS{
<a name="l01502"></a>01502     
<a name="l01503"></a>01503     my $self = shift;
<a name="l01504"></a>01504     my $r = $self-&gt;r;
<a name="l01505"></a>01505     my $ce = $r-&gt;ce;
<a name="l01506"></a>01506 
<a name="l01507"></a>01507     my $site_url = $ce-&gt;{webworkURLs}-&gt;{htdocs};
<a name="l01508"></a>01508     
<a name="l01509"></a>01509     print CGI::start_script({type=&gt;<span class="stringliteral">&quot;text/javascript&quot;</span>, src=&gt;<span class="stringliteral">&quot;$site_url/js/wz_tooltip.js&quot;</span>}), CGI::end_script();
<a name="l01510"></a>01510     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01511"></a>01511 }
<a name="l01512"></a>01512 
<a name="l01513"></a>01513 <span class="preprocessor"># output_removDupli_JS</span>
<a name="l01514"></a>01514 <span class="preprocessor"></span>
<a name="l01515"></a>01515 <span class="preprocessor"># outputs the removeDuplicates JS function</span>
<a name="l01516"></a>01516 <span class="preprocessor"></span>
<a name="l01517"></a>01517 sub output_removDupli_JS{
<a name="l01518"></a>01518     my $self = shift;
<a name="l01519"></a>01519     my $r = $self-&gt;r;
<a name="l01520"></a>01520     my $ce = $r-&gt;ce;
<a name="l01521"></a>01521 
<a name="l01522"></a>01522     my $site_url = $ce-&gt;{webworkURLs}-&gt;{htdocs};
<a name="l01523"></a>01523     
<a name="l01524"></a>01524     print CGI::start_script({type=&gt;<span class="stringliteral">&quot;text/javascript&quot;</span>, src=&gt;<span class="stringliteral">&quot;$site_url/js/removeDuplicates.js&quot;</span>}), CGI::end_script();
<a name="l01525"></a>01525     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01526"></a>01526 }
<a name="l01527"></a>01527 
<a name="l01528"></a>01528 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:34 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
