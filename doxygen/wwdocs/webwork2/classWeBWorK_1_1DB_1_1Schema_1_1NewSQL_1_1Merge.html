<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::DB::Schema::NewSQL::Merge Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1DB.html">DB</a>::<a class="el" href="classWeBWorK_1_1DB_1_1Schema.html">Schema</a>::<a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL.html">NewSQL</a>::<a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html">Merge</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::DB::Schema::NewSQL::Merge Class Reference</h1><!-- doxytag: class="WeBWorK::DB::Schema::NewSQL::Merge" --><!-- doxytag: inherits="WeBWorK::DB::Schema::NewSQL" --><div class="dynheader">
Inheritance diagram for WeBWorK::DB::Schema::NewSQL::Merge:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge__inherit__graph.png" border="0" usemap="#WeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge_inherit__map" id="WeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge_inherit__map">
<area shape="rect" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL.html" title="WeBWorK::DB::Schema::NewSQL" alt="" coords="27,229,251,256"/><area shape="rect" href="classWeBWorK_1_1DB_1_1Schema.html" title="WeBWorK::DB::Schema" alt="" coords="56,155,221,181"/><area shape="rect" href="classWeBWorK_1_1DB.html" title="WeBWorK::DB" alt="" coords="84,80,193,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="97,5,180,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::DB::Schema::NewSQL::Merge:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge__coll__graph.png" border="0" usemap="#WeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge_coll__map" id="WeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge_coll__map">
<area shape="rect" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL.html" title="WeBWorK::DB::Schema::NewSQL" alt="" coords="27,229,251,256"/><area shape="rect" href="classWeBWorK_1_1DB_1_1Schema.html" title="WeBWorK::DB::Schema" alt="" coords="56,155,221,181"/><area shape="rect" href="classWeBWorK_1_1DB.html" title="WeBWorK::DB" alt="" coords="84,80,193,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="97,5,180,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">private method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#a49e109cef6c1dd7aaf5d08d66ce7102a">_get_fields_where_prepex</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#a70356343dc6a942a1fe097de4f065ec7">keyparts_to_where</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#ae33906c51cd897a1db46bcb5501fab95">merge_init</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#a21288cda143db96ae8b99a338998794b">sql_init</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#a00a333808b034ce024b0c50949186be5">conv_where</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#a6ca2c9bddcadc92cba90697e414c9461">new</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html">WeBWorK::DB::Schema::NewSQL::Merge</a> - get merged records from multiple tables in an SQL database.</p>
<h2><a class="anchor" id="SUPPORTED_PARAMS">
SUPPORTED PARAMS</a></h2>
<p>This schema pays attention to the following items in the </p>
<div class="fragment"><pre class="fragment">params
</pre></div><p> entry. </p>
<ul>
<li>
<p class="startli"><a class="anchor" id="item_merge"></a><b>merge</b> </p>
<p class="endli">A reference to an array listing the tables to merge, from highest priority to lowest priority.  </p>
</li>
</ul>

<p>Definition at line <a class="el" href="Merge_8pm_source.html#l00034">34</a> of file <a class="el" href="Merge_8pm_source.html">Merge.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a49e109cef6c1dd7aaf5d08d66ce7102a"></a><!-- doxytag: member="WeBWorK::DB::Schema::NewSQL::Merge::_get_fields_where_prepex" ref="a49e109cef6c1dd7aaf5d08d66ce7102a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">private method WeBWorK::DB::Schema::NewSQL::Merge::_get_fields_where_prepex </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-_get_fields_where_prepex' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-_get_fields_where_prepex-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-_get_fields_where_prepex-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-_get_fields_where_prepex-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in _get_fields_where_prepex: 28</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#a49e109cef6c1dd7aaf5d08d66ce7102a">_get_fields_where_prepex</a> {
    my ($self, $fields, $where, $order) = @_;
    $where = $self-&gt;conv_where($where);
    
<span class="preprocessor">    # pull the requested fields out of $self-&gt;{sql_fieldexprs}</span>
<span class="preprocessor"></span>    my $sql_fields = join(<span class="stringliteral">&quot;, &quot;</span>, @{$self-&gt;{sql_fieldexprs}}{@$fields});
    
    my @where = $self-&gt;{sql_whereprefix};
    my @bind_vals;
    
    my ($base_where_clause, @base_bind_vals) = $self-&gt;sql-&gt;_recurse_where($where) <span class="keywordflow">if</span> $where;
    <span class="keywordflow">if</span> (defined $base_where_clause and $base_where_clause =~ /\S/) {
        push @where, $base_where_clause;
        push @bind_vals, @base_bind_vals;
    }
    
    my $where_clause = @where ? <span class="stringliteral">&quot;WHERE &quot;</span> . join(<span class="stringliteral">&quot; AND &quot;</span>, @where) : <span class="stringliteral">&quot;&quot;</span>;
    my $order_by_clause = $order ? $self-&gt;sql-&gt;_order_by($order) : <span class="stringliteral">&quot;&quot;</span>;
    
<span class="preprocessor">    # scalar ref so _quote_table will leave table expression alone</span>
<span class="preprocessor"></span>    my $stmt = $self-&gt;sql-&gt;select(\($self-&gt;{sql_tableexpr}), $sql_fields)
        . <span class="stringliteral">&quot; $where_clause $order_by_clause&quot;</span>;
    
    my $sth = $self-&gt;dbh-&gt;prepare_cached($stmt, undef, 3); # 3: see DBI docs
    $self-&gt;debug_stmt($sth, @bind_vals);
    $sth-&gt;execute(@bind_vals);  
    <span class="keywordflow">return</span> $sth;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a00a333808b034ce024b0c50949186be5"></a><!-- doxytag: member="WeBWorK::DB::Schema::NewSQL::Merge::conv_where" ref="a00a333808b034ce024b0c50949186be5" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::DB::Schema::NewSQL::Merge::conv_where </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-conv_where' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-conv_where-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-conv_where-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-conv_where-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in conv_where: 4</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#a00a333808b034ce024b0c50949186be5">conv_where</a> {
    my $self = shift;
    <span class="keywordflow">return</span> $self-&gt;{db}{$self-&gt;{pri}}-&gt;conv_where(@_);
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL.html#ae37678650d1bb717414b51e93320225a">WeBWorK::DB::Schema::NewSQL</a>.</p>

</div>
</div>
<a class="anchor" id="a70356343dc6a942a1fe097de4f065ec7"></a><!-- doxytag: member="WeBWorK::DB::Schema::NewSQL::Merge::keyparts_to_where" ref="a70356343dc6a942a1fe097de4f065ec7" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::DB::Schema::NewSQL::Merge::keyparts_to_where </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-keyparts_to_where' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-keyparts_to_where-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-keyparts_to_where-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-keyparts_to_where-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in keyparts_to_where: 4</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#a70356343dc6a942a1fe097de4f065ec7">keyparts_to_where</a> {
    my $self = shift;
    <span class="keywordflow">return</span> $self-&gt;{db}{$self-&gt;{pri}}-&gt;keyparts_to_where(@_);
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL.html#a793cfe7e23c7903eae45b2b7f56114c6">WeBWorK::DB::Schema::NewSQL</a>.</p>

</div>
</div>
<a class="anchor" id="ae33906c51cd897a1db46bcb5501fab95"></a><!-- doxytag: member="WeBWorK::DB::Schema::NewSQL::Merge::merge_init" ref="ae33906c51cd897a1db46bcb5501fab95" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::DB::Schema::NewSQL::Merge::merge_init </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-merge_init' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-merge_init-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-merge_init-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-merge_init-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in merge_init: 51</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#ae33906c51cd897a1db46bcb5501fab95">merge_init</a> {
    my $self = shift;
    my $db = $self-&gt;{db};
    
    my @merge_tables = @{$self-&gt;{params}{merge}};
    
    my %sql_table_aliases;
    @sql_table_aliases{@merge_tables} = map { <span class="stringliteral">&quot;merge$_&quot;</span> } 1 .. @merge_tables;
    
    my @sql_tableexprs;
    my %sql_field_names;
    <span class="keywordflow">foreach</span> my $table (@merge_tables) {
        push @sql_tableexprs, <span class="stringliteral">&quot;`&quot;</span> . $db-&gt;{$table}-&gt;sql_table_name . <span class="stringliteral">&quot;` AS `$sql_table_aliases{$table}`&quot;</span>;
        my @fields = $db-&gt;{$table}-&gt;fields;
        @{$sql_field_names{$table}}{@fields} = map { $db-&gt;{$table}-&gt;sql_field_name($_) } @fields;
    }
    
    my $pri = $merge_tables[0];
    
    my %sql_fieldexprs;
    my @sql_whereprefix;
    
    <span class="keywordflow">foreach</span> my $field ($db-&gt;{$pri}-&gt;fields) {
        my $sql_field_name = $sql_field_names{$pri}{$field};
        
        <span class="keywordflow">if</span> ($db-&gt;{$pri}-&gt;field_data-&gt;{$field}{key}) {
<span class="preprocessor">            # if it&#39;s a keyfield, use the version from the primary table</span>
<span class="preprocessor"></span><span class="preprocessor">            # (they&#39;re all going to be the same anyway)</span>
<span class="preprocessor"></span>            $sql_fieldexprs{$field} = $db-&gt;{$pri}-&gt;sql_field_expression($field, $sql_table_aliases{$pri});
            
<span class="preprocessor">            # add this field to the where clause, by matching the value in the</span>
<span class="preprocessor"></span><span class="preprocessor">            # primary table to the values in all other tables that have that field</span>
<span class="preprocessor"></span>            <span class="keywordflow">foreach</span> my $table (@merge_tables[1..$#merge_tables]) {
                next unless exists $db-&gt;{$table}-&gt;field_data-&gt;{$field};
                push @sql_whereprefix,
                    $db-&gt;{$pri}-&gt;sql_field_expression($field, $sql_table_aliases{$pri})
                    . <span class="stringliteral">&quot;=&quot;</span> . $db-&gt;{$table}-&gt;sql_field_expression($field, $sql_table_aliases{$table});
            }
        } <span class="keywordflow">else</span> {
<span class="preprocessor">            # if it&#39;s not a keyfield, we use the COALESCE function to select a</span>
<span class="preprocessor"></span><span class="preprocessor">            # value from the table that has the first non-NULL value</span>
<span class="preprocessor"></span>            my @coalesce;
            <span class="keywordflow">foreach</span> my $table (@merge_tables) {
                next unless exists $db-&gt;{$table}-&gt;field_data-&gt;{$field};
                push @coalesce, $db-&gt;{$table}-&gt;sql_field_expression($field, $sql_table_aliases{$table});
            }
<span class="preprocessor">            # VERSIONING: we may need something other than COALESCE() here as well, because </span>
<span class="preprocessor"></span><span class="preprocessor">            # it works with NULL/not-NULL, and SUBSTRING() returns empty strings if no match.</span>
<span class="preprocessor"></span>            $sql_fieldexprs{$field} = <span class="stringliteral">&quot;COALESCE(&quot;</span> . join(<span class="stringliteral">&quot;,&quot;</span>, @coalesce) . <span class="stringliteral">&quot;)&quot;</span>;
        }
    }
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a6ca2c9bddcadc92cba90697e414c9461"></a><!-- doxytag: member="WeBWorK::DB::Schema::NewSQL::Merge::new" ref="a6ca2c9bddcadc92cba90697e414c9461" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::DB::Schema::NewSQL::Merge::new </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-new' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-new-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-new-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-new-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in new: 8</span>
<span class="preprocessor"></span>sub <span class="keyword">new</span> {
    my $self = shift-&gt;SUPER::new(@_);
    
    $self-&gt;merge_init;
    $self-&gt;sql_init;
    
    <span class="keywordflow">return</span> $self;
}
</pre></div>  
</div>
 
<p>Reimplemented from <a class="el" href="classWeBWorK_1_1DB_1_1Schema.html#a1afa58255ff1632218f920a913f0fb5f">WeBWorK::DB::Schema</a>.</p>

</div>
</div>
<a class="anchor" id="a21288cda143db96ae8b99a338998794b"></a><!-- doxytag: member="WeBWorK::DB::Schema::NewSQL::Merge::sql_init" ref="a21288cda143db96ae8b99a338998794b" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::DB::Schema::NewSQL::Merge::sql_init </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-sql_init' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-sql_init-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-sql_init-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-sql_init-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in sql_init: 41</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1DB_1_1Schema_1_1NewSQL_1_1Merge.html#a21288cda143db96ae8b99a338998794b">sql_init</a> {
    my $self = shift;
    
<span class="preprocessor">    # transformation functions for table and field names: these allow us to pass</span>
<span class="preprocessor"></span><span class="preprocessor">    # the WeBWorK table/field names to SQL::Abstract, and have it translate them</span>
<span class="preprocessor"></span><span class="preprocessor">    # to the SQL table/field names from tableOverride and fieldOverride.</span>
<span class="preprocessor"></span><span class="preprocessor">    # (Without this, it would be hard to translate field names in WHERE</span>
<span class="preprocessor"></span><span class="preprocessor">    # structures, since they&#39;re so convoluted.)</span>
<span class="preprocessor"></span>    my $transform_table = sub {
        my $label = shift;
        <span class="keywordflow">if</span> (exists $self-&gt;{sql_table_aliases}{$label}) {
            <span class="keywordflow">return</span> $self-&gt;{sql_table_aliases}{$label};
        } <span class="keywordflow">else</span> {
            warn <span class="stringliteral">&quot;can&#39;t transform unrecognized table name &#39;$label&#39;&quot;</span>;
            <span class="keywordflow">return</span> $label;
        }
    };
    
<span class="preprocessor">    # This transformation is called both on bare field names and on qualified</span>
<span class="preprocessor"></span><span class="preprocessor">    # field names (i.e. &quot;table.field&quot;), but not on bare table names.</span>
<span class="preprocessor"></span>    my $transform_all = sub {
        my $label = shift;
        my ($table, $field) = $label =~ /(?:(.+)\.)?(.+)/;
        $table = $self-&gt;{pri} unless defined $table;
        <span class="keywordflow">if</span> (exists $self-&gt;{sql_field_names}{$table}{$field}) {
            $field = $self-&gt;{sql_field_names}{$table}{$field};
        } <span class="keywordflow">else</span> {
            warn <span class="stringliteral">&quot;can&#39;t transform unrecognized field name &#39;$field&#39; for table name &#39;$table&#39;&quot;</span>;
        }
        $table = $transform_table-&gt;($table);
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;`$table`.`$field`&quot;</span>;
    };
    
<span class="preprocessor">    # add SQL statement generation object</span>
<span class="preprocessor"></span>    $self-&gt;{sql} = <span class="keyword">new</span> <a class="code" href="classWeBWorK_1_1DB_1_1Utils_1_1SQLAbstractIdentTrans.html">WeBWorK::DB::Utils::SQLAbstractIdentTrans</a>(
        quote_char =&gt; <span class="stringliteral">&quot;`&quot;</span>,
        name_sep =&gt; <span class="stringliteral">&quot;.&quot;</span>,
        transform_table =&gt; $transform_table,
        transform_all =&gt; $transform_all,
    );
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="Merge_8pm_source.html">Merge.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:59:27 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
