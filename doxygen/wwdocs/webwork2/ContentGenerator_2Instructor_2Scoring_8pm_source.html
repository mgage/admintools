<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: Scoring.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>Scoring.pm</h1><a href="ContentGenerator_2Instructor_2Scoring_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/Instructor/Scoring.pm,v 1.62 2007/03/07 17:34:42 glarose Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::Instructor::Scoring;
<a name="l00018"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1Scoring.html">00018</a> use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">WeBWorK::ContentGenerator::Instructor</a>);
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 =head1 NAME
<a name="l00021"></a>00021  
<a name="l00022"></a>00022 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1Scoring.html">WeBWorK::ContentGenerator::Instructor::Scoring</a> - Generate scoring data files
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 =cut
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 use strict;
<a name="l00027"></a>00027 use warnings;
<a name="l00028"></a>00028 <span class="preprocessor">#use CGI qw(-nosticky );</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00030"></a>00030 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00031"></a>00031 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(readFile);
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 our @userInfoColumnHeadings = (<span class="stringliteral">&quot;STUDENT ID&quot;</span>, <span class="stringliteral">&quot;login ID&quot;</span>, <span class="stringliteral">&quot;LAST NAME&quot;</span>, <span class="stringliteral">&quot;FIRST NAME&quot;</span>, <span class="stringliteral">&quot;SECTION&quot;</span>, <span class="stringliteral">&quot;RECITATION&quot;</span>);
<a name="l00034"></a>00034 our @userInfoFields = (<span class="stringliteral">&quot;student_id&quot;</span>, <span class="stringliteral">&quot;user_id&quot;</span>,<span class="stringliteral">&quot;last_name&quot;</span>, <span class="stringliteral">&quot;first_name&quot;</span>, <span class="stringliteral">&quot;section&quot;</span>, <span class="stringliteral">&quot;recitation&quot;</span>);
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 sub initialize {
<a name="l00037"></a>00037     my ($self)     = @_;
<a name="l00038"></a>00038     my $r          = $self-&gt;r;
<a name="l00039"></a>00039     my $urlpath    = $r-&gt;urlpath;
<a name="l00040"></a>00040     my $ce         = $r-&gt;ce;
<a name="l00041"></a>00041     my $db         = $r-&gt;db;
<a name="l00042"></a>00042     my $authz      = $r-&gt;authz;
<a name="l00043"></a>00043     my $scoringDir = $ce-&gt;{courseDirs}-&gt;{scoring};
<a name="l00044"></a>00044     my $courseName = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00045"></a>00045     my $user       = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00046"></a>00046     
<a name="l00047"></a>00047 <span class="preprocessor">    # Check permission</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span>    <span class="keywordflow">return</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
<a name="l00049"></a>00049     <span class="keywordflow">return</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;score_sets&quot;</span>);
<a name="l00050"></a>00050     
<a name="l00051"></a>00051     my @selected = $r-&gt;param(<span class="stringliteral">&#39;selectedSet&#39;</span>);
<a name="l00052"></a>00052     my $scoreSelected = $r-&gt;param(<span class="stringliteral">&#39;scoreSelected&#39;</span>);
<a name="l00053"></a>00053     my $scoringFileName = $r-&gt;param(<span class="stringliteral">&#39;scoringFileName&#39;</span>) || <span class="stringliteral">&quot;${courseName}_totals&quot;</span>;
<a name="l00054"></a>00054     $scoringFileName =~ s/\.csv\s*$<span class="comment">//; $scoringFileName .=&#39;.csv&#39;;  # must end in .csv</span>
<a name="l00055"></a>00055     $self-&gt;{scoringFileName}=$scoringFileName;
<a name="l00056"></a>00056     
<a name="l00057"></a>00057     $self-&gt;{padFields}  = defined($r-&gt;param(<span class="stringliteral">&#39;padFields&#39;</span>) ) ? 1 : 0; 
<a name="l00058"></a>00058     
<a name="l00059"></a>00059     <span class="keywordflow">if</span> (defined $scoreSelected &amp;&amp; @selected) {
<a name="l00060"></a>00060 
<a name="l00061"></a>00061         my @totals                 = ();
<a name="l00062"></a>00062         my $recordSingleSetScores  = $r-&gt;param(<span class="stringliteral">&#39;recordSingleSetScores&#39;</span>);
<a name="l00063"></a>00063         
<a name="l00064"></a>00064 <span class="preprocessor">        # pre-fetch users</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span>        debug(<span class="stringliteral">&quot;pre-fetching users&quot;</span>);
<a name="l00066"></a>00066 <span class="preprocessor">        # DBFIXME shouldn&#39;t need ID list</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span>        my @Users = $db-&gt;getUsers($db-&gt;listUsers);
<a name="l00068"></a>00068         my %Users;
<a name="l00069"></a>00069         <span class="keywordflow">foreach</span> my $User (@Users) {
<a name="l00070"></a>00070             next unless $User;
<a name="l00071"></a>00071             next unless $ce-&gt;status_abbrev_has_behavior($User-&gt;status, <span class="stringliteral">&quot;include_in_scoring&quot;</span>);
<a name="l00072"></a>00072             $Users{$User-&gt;user_id} = $User;
<a name="l00073"></a>00073         }
<a name="l00074"></a>00074 <span class="preprocessor">        # DBFIXME use an ORDER BY clause in the database</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span>        my @sortedUserIDs = sort { 
<a name="l00076"></a>00076             lc($Users{$a}-&gt;last_name) cmp lc($Users{$b}-&gt;last_name) 
<a name="l00077"></a>00077                 ||
<a name="l00078"></a>00078             lc($Users{$a}-&gt;first_name) cmp lc($Users{$b}-&gt;first_name)
<a name="l00079"></a>00079                 ||
<a name="l00080"></a>00080             lc($Users{$a}-&gt;user_id) cmp lc($Users{$b}-&gt;user_id)
<a name="l00081"></a>00081             }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083             keys %Users;
<a name="l00084"></a>00084 <span class="preprocessor">        #my @userInfo = (\%Users, \@sortedUserIDs);</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>        debug(<span class="stringliteral">&quot;done pre-fetching users&quot;</span>);
<a name="l00086"></a>00086         
<a name="l00087"></a>00087         my $scoringType            = ($recordSingleSetScores) ?<span class="stringliteral">&#39;everything&#39;</span>:<span class="stringliteral">&#39;totals&#39;</span>;
<a name="l00088"></a>00088         my (@everything, @normal,@full,@info,@totalsColumn);
<a name="l00089"></a>00089         @info             = $self-&gt;scoreSet($selected[0], <span class="stringliteral">&quot;info&quot;</span>, undef, \%Users, \@sortedUserIDs) <span class="keywordflow">if</span> defined($selected[0]);
<a name="l00090"></a>00090         @totals           = @info;
<a name="l00091"></a>00091         my $showIndex     = defined($r-&gt;param(<span class="stringliteral">&#39;includeIndex&#39;</span>)) ? defined($r-&gt;param(<span class="stringliteral">&#39;includeIndex&#39;</span>)) : 0; 
<a name="l00092"></a>00092         
<a name="l00093"></a>00093      
<a name="l00094"></a>00094         <span class="keywordflow">foreach</span> my $setID (@selected) {
<a name="l00095"></a>00095             next unless defined $setID;
<a name="l00096"></a>00096             <span class="keywordflow">if</span> ($scoringType eq <span class="stringliteral">&#39;everything&#39;</span>) {
<a name="l00097"></a>00097                 @everything = $self-&gt;scoreSet($setID, <span class="stringliteral">&quot;everything&quot;</span>, $showIndex, \%Users, \@sortedUserIDs);
<a name="l00098"></a>00098                 @normal = $self-&gt;everything2normal(@everything);
<a name="l00099"></a>00099                 @full = $self-&gt;everything2full(@everything);
<a name="l00100"></a>00100                 @info = $self-&gt;everything2info(@everything);
<a name="l00101"></a>00101                 @totalsColumn = $self-&gt;everything2totals(@everything);
<a name="l00102"></a>00102                 $self-&gt;appendColumns(\@totals, \@totalsColumn);
<a name="l00103"></a>00103                 $self-&gt;writeCSV(<span class="stringliteral">&quot;$scoringDir/s${setID}scr.csv&quot;</span>, @normal);
<a name="l00104"></a>00104                 $self-&gt;writeCSV(<span class="stringliteral">&quot;$scoringDir/s${setID}ful.csv&quot;</span>, @full);             
<a name="l00105"></a>00105             } <span class="keywordflow">else</span> {
<a name="l00106"></a>00106                 @totalsColumn  = $self-&gt;scoreSet($setID, <span class="stringliteral">&quot;totals&quot;</span>, $showIndex, \%Users, \@sortedUserIDs);
<a name="l00107"></a>00107                 $self-&gt;appendColumns(\@totals, \@totalsColumn);
<a name="l00108"></a>00108             }   
<a name="l00109"></a>00109         }
<a name="l00110"></a>00110         my @sum_scores  = $self-&gt;sumScores(\@totals, $showIndex, \%Users, \@sortedUserIDs);
<a name="l00111"></a>00111         $self-&gt;appendColumns( \@totals,\@sum_scores);
<a name="l00112"></a>00112         $self-&gt;writeCSV(<span class="stringliteral">&quot;$scoringDir/$scoringFileName&quot;</span>, @totals);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114     } elsif (defined $scoreSelected) {
<a name="l00115"></a>00115         $self-&gt;addbadmessage(<span class="stringliteral">&quot;You must select one or more sets for scoring&quot;</span>);
<a name="l00116"></a>00116     } 
<a name="l00117"></a>00117     
<a name="l00118"></a>00118 <span class="preprocessor">    # Obtaining list of sets:</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>    my @setNames =  $db-&gt;listGlobalSets();
<a name="l00120"></a>00120     my @set_records = ();
<a name="l00121"></a>00121 <span class="preprocessor">    # DBFIXME shouldn&#39;t need ID list</span>
<a name="l00122"></a>00122 <span class="preprocessor"></span>    @set_records = $db-&gt;getGlobalSets( @setNames); 
<a name="l00123"></a>00123     
<a name="l00124"></a>00124     
<a name="l00125"></a>00125 <span class="preprocessor">    # store data</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span>    $self-&gt;{ra_sets}              =   \@setNames; # ra_sets IS NEVER USED AGAIN!!!!!
<a name="l00127"></a>00127     $self-&gt;{ra_set_records}       =   \@set_records;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 
<a name="l00131"></a>00131 sub body {
<a name="l00132"></a>00132     my ($self)      = @_;
<a name="l00133"></a>00133     my $r           = $self-&gt;r;
<a name="l00134"></a>00134     my $urlpath     = $r-&gt;urlpath;
<a name="l00135"></a>00135     my $ce          = $r-&gt;ce;
<a name="l00136"></a>00136     my $authz       = $r-&gt;authz;
<a name="l00137"></a>00137     my $scoringDir  = $ce-&gt;{courseDirs}-&gt;{scoring};
<a name="l00138"></a>00138     my $courseName  = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00139"></a>00139     my $user        = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00140"></a>00140     
<a name="l00141"></a>00141     my $scoringPage       = $urlpath-&gt;newFromModule($urlpath-&gt;module, $r, courseID =&gt; $courseName);
<a name="l00142"></a>00142     my $scoringURL        = $self-&gt;systemLink($scoringPage, authen=&gt;0);
<a name="l00143"></a>00143     
<a name="l00144"></a>00144     my $scoringDownloadPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::ScoringDownload&quot;</span>, $r,  
<a name="l00145"></a>00145                                           courseID =&gt; $courseName
<a name="l00146"></a>00146     );
<a name="l00147"></a>00147     
<a name="l00148"></a>00148     my $scoringFileName = $self-&gt;{scoringFileName};
<a name="l00149"></a>00149     
<a name="l00150"></a>00150 <span class="preprocessor">    # Check permissions</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, <span class="stringliteral">&quot;You are not authorized to access the Instructor tools.&quot;</span>)
<a name="l00152"></a>00152         unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
<a name="l00153"></a>00153     
<a name="l00154"></a>00154     <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, <span class="stringliteral">&quot;You are not authorized to score sets.&quot;</span>)
<a name="l00155"></a>00155         unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;score_sets&quot;</span>);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157     print join(<span class="stringliteral">&quot;&quot;</span>,
<a name="l00158"></a>00158             CGI::start_form(-method=&gt;<span class="stringliteral">&quot;POST&quot;</span>, -action=&gt;$scoringURL),<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00159"></a>00159             $self-&gt;hidden_authen_fields,<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00160"></a>00160             CGI::hidden({-name=&gt;<span class="stringliteral">&#39;scoreSelected&#39;</span>, -value=&gt;1}),
<a name="l00161"></a>00161             CGI::start_table({border=&gt;1,}),
<a name="l00162"></a>00162                 CGI::Tr({},
<a name="l00163"></a>00163                     CGI::td($self-&gt;popup_set_form),
<a name="l00164"></a>00164                     CGI::td({},
<a name="l00165"></a>00165                         CGI::checkbox({ -name=&gt;<span class="stringliteral">&#39;includeIndex&#39;</span>,
<a name="l00166"></a>00166                                         -value=&gt;1,
<a name="l00167"></a>00167                                         -label=&gt;<span class="stringliteral">&#39;Include Index&#39;</span>,
<a name="l00168"></a>00168                                         -checked=&gt;0,
<a name="l00169"></a>00169                                        },
<a name="l00170"></a>00170                         ),
<a name="l00171"></a>00171                         CGI::br(),
<a name="l00172"></a>00172 <span class="preprocessor">                        # These are not yet implemented</span>
<a name="l00173"></a>00173 <span class="preprocessor"></span><span class="preprocessor">                        #CGI::checkbox({ -name=&gt;&#39;includeTotals&#39;,</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span><span class="preprocessor">                        #               -value=&gt;1,</span>
<a name="l00175"></a>00175 <span class="preprocessor"></span><span class="preprocessor">                        #               -label=&gt;&#39;Include Total score column&#39;,</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span><span class="preprocessor">                        #               -checked=&gt;1,</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="preprocessor">                        #              },</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span><span class="preprocessor">                        #),</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span><span class="preprocessor">                        #CGI::br(),</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="preprocessor">                        #CGI::checkbox({ -name=&gt;&#39;includePercent&#39;,</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span><span class="preprocessor">                        #               -value=&gt;1,</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span><span class="preprocessor">                        #               -label=&gt;&#39;Include Percent correct column&#39;,</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span><span class="preprocessor">                        #               -checked=&gt;1,</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span><span class="preprocessor">                        #              },</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span><span class="preprocessor">                        #),</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span><span class="preprocessor">                        #CGI::br(),</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>                        CGI::checkbox({ -name=&gt;<span class="stringliteral">&#39;recordSingleSetScores&#39;</span>,
<a name="l00188"></a>00188                                         -value=&gt;1,
<a name="l00189"></a>00189                                         -label=&gt;<span class="stringliteral">&#39;Record Scores for Single Sets&#39;</span>,
<a name="l00190"></a>00190                                         -checked=&gt;0,
<a name="l00191"></a>00191                                       },
<a name="l00192"></a>00192                                      <span class="stringliteral">&#39;Record Scores for Single Sets&#39;</span>
<a name="l00193"></a>00193                         ),
<a name="l00194"></a>00194                         CGI::br(),
<a name="l00195"></a>00195                         CGI::checkbox({ -name=&gt;<span class="stringliteral">&#39;padFields&#39;</span>,
<a name="l00196"></a>00196                                         -value=&gt;1,
<a name="l00197"></a>00197                                         -label=&gt;<span class="stringliteral">&#39;Pad Fields&#39;</span>,
<a name="l00198"></a>00198                                         -checked=&gt;1,
<a name="l00199"></a>00199                                       },
<a name="l00200"></a>00200                                      <span class="stringliteral">&#39;Pad Fields&#39;</span>
<a name="l00201"></a>00201                         ),
<a name="l00202"></a>00202                     ),
<a name="l00203"></a>00203                 ),
<a name="l00204"></a>00204                 CGI::Tr(CGI::td({colspan =&gt;2,align=&gt;<span class="stringliteral">&#39;center&#39;</span>},
<a name="l00205"></a>00205                     CGI::input({type=&gt;<span class="stringliteral">&#39;submit&#39;</span>,value=&gt;<span class="stringliteral">&#39;Score selected set(s) and save to: &#39;</span>,name=&gt;<span class="stringliteral">&#39;score-sets&#39;</span>}),
<a name="l00206"></a>00206                     CGI::input({type=&gt;<span class="stringliteral">&#39;text&#39;</span>, name=&gt;<span class="stringliteral">&#39;scoringFileName&#39;</span>, size=&gt;<span class="stringliteral">&#39;40&#39;</span>,value=&gt;<span class="stringliteral">&quot;$scoringFileName&quot;</span>})
<a name="l00207"></a>00207                 )),
<a name="l00208"></a>00208             
<a name="l00209"></a>00209            CGI::end_table(),
<a name="l00210"></a>00210            CGI::end_form(),
<a name="l00211"></a>00211     );
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     
<a name="l00214"></a>00214     <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;score_sets&quot;</span>)) {
<a name="l00215"></a>00215         my @selected = $r-&gt;param(<span class="stringliteral">&#39;selectedSet&#39;</span>);
<a name="l00216"></a>00216         <span class="keywordflow">if</span> (@selected) {
<a name="l00217"></a>00217             print CGI::p(<span class="stringliteral">&quot;All of these files will also be made available for mail merge&quot;</span>);
<a name="l00218"></a>00218         } 
<a name="l00219"></a>00219         <span class="keywordflow">foreach</span> my $setID (@selected) {
<a name="l00220"></a>00220     
<a name="l00221"></a>00221             my @validFiles;
<a name="l00222"></a>00222             <span class="keywordflow">foreach</span> my $type (<span class="stringliteral">&quot;scr&quot;</span>, <span class="stringliteral">&quot;ful&quot;</span>) {
<a name="l00223"></a>00223                 my $filename = <span class="stringliteral">&quot;s$setID$type.csv&quot;</span>;
<a name="l00224"></a>00224                 my $path = <span class="stringliteral">&quot;$scoringDir/$filename&quot;</span>;
<a name="l00225"></a>00225                 push @validFiles, $filename <span class="keywordflow">if</span> -f $path;
<a name="l00226"></a>00226             }
<a name="l00227"></a>00227             <span class="keywordflow">if</span> (@validFiles) {
<a name="l00228"></a>00228                 print CGI::h2(<span class="stringliteral">&quot;$setID&quot;</span>);
<a name="l00229"></a>00229                 <span class="keywordflow">foreach</span> my $filename (@validFiles) {
<a name="l00230"></a>00230 <span class="preprocessor">                    #print CGI::a({href=&gt;&quot;../scoringDownload/?getFile=${filename}&amp;&quot;.$self-&gt;url_authen_args}, $filename);</span>
<a name="l00231"></a>00231 <span class="preprocessor"></span>                    print CGI::a({href=&gt;$self-&gt;systemLink($scoringDownloadPage,
<a name="l00232"></a>00232                                    params=&gt;{getFile =&gt; $filename } )}, $filename);
<a name="l00233"></a>00233                     print CGI::br();
<a name="l00234"></a>00234                 }
<a name="l00235"></a>00235                 print CGI::hr();
<a name="l00236"></a>00236             }
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238         <span class="keywordflow">if</span> (-f <span class="stringliteral">&quot;$scoringDir/$scoringFileName&quot;</span>) {
<a name="l00239"></a>00239             print CGI::h2(<span class="stringliteral">&quot;Totals&quot;</span>);
<a name="l00240"></a>00240 <span class="preprocessor">            #print CGI::a({href=&gt;&quot;../scoringDownload/?getFile=${courseName}_totals.csv&amp;&quot;.$self-&gt;url_authen_args}, &quot;${courseName}_totals.csv&quot;);</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span>            print CGI::a({href=&gt;$self-&gt;systemLink($scoringDownloadPage,
<a name="l00242"></a>00242                                    params=&gt;{getFile =&gt; <span class="stringliteral">&quot;$scoringFileName&quot;</span> } )}, <span class="stringliteral">&quot;$scoringFileName&quot;</span>);
<a name="l00243"></a>00243             print CGI::hr();
<a name="l00244"></a>00244             print CGI::pre({style=&gt;<span class="stringliteral">&#39;font-size:smaller&#39;</span>},<a class="code" href="classWeBWorK_1_1Utils.html#a7aa337cd97110ff3e5c7536bfb1a84e8">WeBWorK::Utils::readFile</a>(<span class="stringliteral">&quot;$scoringDir/$scoringFileName&quot;</span>));
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247     
<a name="l00248"></a>00248     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 <span class="preprocessor"># If, some day, it becomes possible to assign a different number of problems to each student, this code</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span><span class="preprocessor"># will have to be rewritten some.</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span><span class="preprocessor"># $format can be any of &quot;normal&quot;, &quot;full&quot;, &quot;everything&quot;, &quot;info&quot;, or &quot;totals&quot;.  An undefined value defaults to &quot;normal&quot;</span>
<a name="l00254"></a>00254 <span class="preprocessor"></span><span class="preprocessor">#   normal: student info, the status of each problem in the set, and a &quot;totals&quot; column</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span><span class="preprocessor">#   full: student info, the status of each problem, and the number of correct and incorrect attempts</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span><span class="preprocessor">#   everything: &quot;full&quot; plus a totals column</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">#   info: student info columns only</span>
<a name="l00258"></a>00258 <span class="preprocessor"></span><span class="preprocessor">#   totals: total column only</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span>sub scoreSet {
<a name="l00260"></a>00260     my ($self, $setID, $format, $showIndex, $UsersRef, $sortedUserIDsRef) = @_;
<a name="l00261"></a>00261     my $r  = $self-&gt;r;
<a name="l00262"></a>00262     my $db = $r-&gt;db;
<a name="l00263"></a>00263     my @scoringData;
<a name="l00264"></a>00264     my $scoringItems   = {    info             =&gt; 0,
<a name="l00265"></a>00265                               successIndex     =&gt; 0,
<a name="l00266"></a>00266                               setTotals        =&gt; 0,
<a name="l00267"></a>00267                               problemScores    =&gt; 0,
<a name="l00268"></a>00268                               problemAttempts  =&gt; 0, 
<a name="l00269"></a>00269                               header           =&gt; 0,
<a name="l00270"></a>00270     };
<a name="l00271"></a>00271     $format = <span class="stringliteral">&quot;normal&quot;</span> unless defined $format;
<a name="l00272"></a>00272     $format = <span class="stringliteral">&quot;normal&quot;</span> unless $format eq <span class="stringliteral">&quot;full&quot;</span> or $format eq <span class="stringliteral">&quot;everything&quot;</span> or $format eq <span class="stringliteral">&quot;totals&quot;</span> or $format eq <span class="stringliteral">&quot;info&quot;</span>;
<a name="l00273"></a>00273     my $columnsPerProblem = ($format eq <span class="stringliteral">&quot;full&quot;</span> or $format eq <span class="stringliteral">&quot;everything&quot;</span>) ? 3 : 1;
<a name="l00274"></a>00274     
<a name="l00275"></a>00275 <span class="preprocessor">    # DBFIXME these have already been fetched in ra_set_records</span>
<a name="l00276"></a>00276 <span class="preprocessor"></span>    my $setRecord = $db-&gt;getGlobalSet($setID); #checked
<a name="l00277"></a>00277     die <span class="stringliteral">&quot;global set $setID not found. &quot;</span> unless $setRecord;
<a name="l00278"></a>00278 <span class="preprocessor">    #my %users;</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span><span class="preprocessor">    #my %userStudentID=();</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span><span class="preprocessor">    #foreach my $userID ($db-&gt;listUsers()) {</span>
<a name="l00281"></a>00281 <span class="preprocessor"></span><span class="preprocessor">    #   my $userRecord = $db-&gt;getUser($userID); # checked</span>
<a name="l00282"></a>00282 <span class="preprocessor"></span><span class="preprocessor">    #   die &quot;user record for $userID not found&quot; unless $userID;</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span><span class="preprocessor">    #   # FIXME: if two users have the same student ID, the second one will</span>
<a name="l00284"></a>00284 <span class="preprocessor"></span><span class="preprocessor">    #   # clobber the first one. this is bad!</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span><span class="preprocessor">    #   # The key is what we&#39;d like to sort by.</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span><span class="preprocessor">    #   $users{$userRecord-&gt;student_id} = $userRecord;</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span><span class="preprocessor">    #   $userStudentID{$userID} = $userRecord-&gt;student_id;</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span><span class="preprocessor">    #}</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span>    
<a name="l00290"></a>00290     my %Users = %$UsersRef; # user objects hashed on user ID
<a name="l00291"></a>00291     my @sortedUserIDs = @$sortedUserIDsRef; # user IDs sorted by student ID
<a name="l00292"></a>00292     
<a name="l00293"></a>00293     my @problemIDs = $db-&gt;listGlobalProblems($setID);
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="preprocessor">    # determine what information will be returned</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($format eq <span class="stringliteral">&#39;normal&#39;</span>) {
<a name="l00297"></a>00297         $scoringItems  = {    info             =&gt; 1,
<a name="l00298"></a>00298                               successIndex     =&gt; $showIndex,
<a name="l00299"></a>00299                               setTotals        =&gt; 1,
<a name="l00300"></a>00300                               problemScores    =&gt; 1,
<a name="l00301"></a>00301                               problemAttempts  =&gt; 0, 
<a name="l00302"></a>00302                               header           =&gt; 1,
<a name="l00303"></a>00303         };
<a name="l00304"></a>00304     } elsif ($format eq <span class="stringliteral">&#39;full&#39;</span>) {
<a name="l00305"></a>00305         $scoringItems  = {    info             =&gt; 1,
<a name="l00306"></a>00306                               successIndex     =&gt; $showIndex,
<a name="l00307"></a>00307                               setTotals        =&gt; 0,
<a name="l00308"></a>00308                               problemScores    =&gt; 1,
<a name="l00309"></a>00309                               problemAttempts  =&gt; 1, 
<a name="l00310"></a>00310                               header           =&gt; 1,
<a name="l00311"></a>00311         };
<a name="l00312"></a>00312     } elsif ($format eq <span class="stringliteral">&#39;everything&#39;</span>) {
<a name="l00313"></a>00313         $scoringItems  = {    info             =&gt; 1,
<a name="l00314"></a>00314                               successIndex     =&gt; $showIndex,
<a name="l00315"></a>00315                               setTotals        =&gt; 1,
<a name="l00316"></a>00316                               problemScores    =&gt; 1,
<a name="l00317"></a>00317                               problemAttempts  =&gt; 1, 
<a name="l00318"></a>00318                               header           =&gt; 1,
<a name="l00319"></a>00319         };
<a name="l00320"></a>00320     } elsif ($format eq <span class="stringliteral">&#39;totals&#39;</span>) {
<a name="l00321"></a>00321         $scoringItems  = {    info             =&gt; 0,
<a name="l00322"></a>00322                               successIndex     =&gt; $showIndex,
<a name="l00323"></a>00323                               setTotals        =&gt; 1,
<a name="l00324"></a>00324                               problemScores    =&gt; 0,
<a name="l00325"></a>00325                               problemAttempts  =&gt; 0, 
<a name="l00326"></a>00326                               header           =&gt; 0,
<a name="l00327"></a>00327         };
<a name="l00328"></a>00328     } elsif ($format eq <span class="stringliteral">&#39;info&#39;</span>) {
<a name="l00329"></a>00329         $scoringItems  = {    info             =&gt; 0,
<a name="l00330"></a>00330                               successIndex     =&gt; 0,
<a name="l00331"></a>00331                               setTotals        =&gt; 0,
<a name="l00332"></a>00332                               problemScores    =&gt; 0,
<a name="l00333"></a>00333                               problemAttempts  =&gt; 0, 
<a name="l00334"></a>00334                               header           =&gt; 1,
<a name="l00335"></a>00335         };
<a name="l00336"></a>00336     } <span class="keywordflow">else</span> {
<a name="l00337"></a>00337         warn <span class="stringliteral">&quot;unrecognized format&quot;</span>;
<a name="l00338"></a>00338     }
<a name="l00339"></a>00339     
<a name="l00340"></a>00340 <span class="preprocessor">    # Initialize a two-dimensional array of the proper size</span>
<a name="l00341"></a>00341 <span class="preprocessor"></span>    <span class="keywordflow">for</span> (my $i = 0; $i &lt; @sortedUserIDs + 7; $i++) { # 7 is how many descriptive fields there are in each column
<a name="l00342"></a>00342         push @scoringData, [];
<a name="l00343"></a>00343     }
<a name="l00344"></a>00344     
<a name="l00345"></a>00345 <span class="preprocessor">    #my @userKeys = sort keys %users; # list of &quot;student IDs&quot; NOT user IDs</span>
<a name="l00346"></a>00346 <span class="preprocessor"></span>    
<a name="l00347"></a>00347     <span class="keywordflow">if</span> ($scoringItems-&gt;{header}) {
<a name="l00348"></a>00348         $scoringData[0][0] = <span class="stringliteral">&quot;NO OF FIELDS&quot;</span>;
<a name="l00349"></a>00349         $scoringData[1][0] = <span class="stringliteral">&quot;SET NAME&quot;</span>;
<a name="l00350"></a>00350         $scoringData[2][0] = <span class="stringliteral">&quot;PROB NUMBER&quot;</span>;
<a name="l00351"></a>00351         $scoringData[3][0] = <span class="stringliteral">&quot;DUE DATE&quot;</span>;
<a name="l00352"></a>00352         $scoringData[4][0] = <span class="stringliteral">&quot;DUE TIME&quot;</span>;
<a name="l00353"></a>00353         $scoringData[5][0] = <span class="stringliteral">&quot;PROB VALUE&quot;</span>;
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     
<a name="l00356"></a>00356     
<a name="l00357"></a>00357 <span class="preprocessor">    # Write identifying information about the users</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span>
<a name="l00359"></a>00359         <span class="keywordflow">for</span> (my $field=0; $field &lt; @userInfoFields; $field++) {
<a name="l00360"></a>00360             <span class="keywordflow">if</span> ($field &gt; 0) {
<a name="l00361"></a>00361                 <span class="keywordflow">for</span> (my $i = 0; $i &lt; 6; $i++) {
<a name="l00362"></a>00362                     $scoringData[$i][$field] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00363"></a>00363                 }
<a name="l00364"></a>00364             }
<a name="l00365"></a>00365             $scoringData[6][$field] = $userInfoColumnHeadings[$field];
<a name="l00366"></a>00366             <span class="keywordflow">for</span> (my $user = 0; $user &lt; @sortedUserIDs; $user++) {
<a name="l00367"></a>00367                 my $fieldName = $userInfoFields[$field];
<a name="l00368"></a>00368                 $scoringData[$user + 7][$field] = $Users{$sortedUserIDs[$user]}-&gt;$fieldName;
<a name="l00369"></a>00369             }
<a name="l00370"></a>00370         }
<a name="l00371"></a>00371     }
<a name="l00372"></a>00372     <span class="keywordflow">return</span> @scoringData <span class="keywordflow">if</span> $format eq <span class="stringliteral">&quot;info&quot;</span>;
<a name="l00373"></a>00373     
<a name="l00374"></a>00374 <span class="preprocessor">    # pre-fetch global problems</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;pre-fetching global problems for set $setID&quot;</span>);
<a name="l00376"></a>00376     my %GlobalProblems = map { $_-&gt;problem_id =&gt; $_ }
<a name="l00377"></a>00377         $db-&gt;getAllGlobalProblems($setID);
<a name="l00378"></a>00378     debug(<span class="stringliteral">&quot;done pre-fetching global problems for set $setID&quot;</span>);
<a name="l00379"></a>00379     
<a name="l00380"></a>00380 <span class="preprocessor">    # pre-fetch user problems</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;pre-fetching user problems for set $setID&quot;</span>);
<a name="l00382"></a>00382     my %UserProblems; # $UserProblems{$userID}{$problemID}
<a name="l00383"></a>00383 
<a name="l00384"></a>00384 <span class="preprocessor">  # Gateway change here: for non-gateway (non-versioned) sets, we just </span>
<a name="l00385"></a>00385 <span class="preprocessor"></span><span class="preprocessor">  # get each user&#39;s problems.  For gateway (versioned) sets, we get the </span>
<a name="l00386"></a>00386 <span class="preprocessor"></span><span class="preprocessor">  # user&#39;s best version and return that</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! defined( $setRecord-&gt;assignment_type() ) ||
<a name="l00388"></a>00388          $setRecord-&gt;assignment_type() !~ /gateway/ ) {
<a name="l00389"></a>00389         <span class="keywordflow">foreach</span> my $userID (@sortedUserIDs) {
<a name="l00390"></a>00390             my %CurrUserProblems = map { $_-&gt;problem_id =&gt; $_ }
<a name="l00391"></a>00391                 $db-&gt;getAllMergedUserProblems($userID, $setID);
<a name="l00392"></a>00392             $UserProblems{$userID} = \%CurrUserProblems;
<a name="l00393"></a>00393         }
<a name="l00394"></a>00394     } <span class="keywordflow">else</span> {  # versioned sets; <span class="keyword">get</span> the problems <span class="keywordflow">for</span> the best version 
<a name="l00395"></a>00395 
<a name="l00396"></a>00396         <span class="keywordflow">foreach</span> my $userID (@sortedUserIDs) {
<a name="l00397"></a>00397             my $CurrUserProblems = {};
<a name="l00398"></a>00398             my @versionNums = $db-&gt;listSetVersions($userID,$setID);
<a name="l00399"></a>00399 
<a name="l00400"></a>00400             my $bestScore = -1;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402             <span class="keywordflow">if</span> ( @versionNums ) {
<a name="l00403"></a>00403                 <span class="keywordflow">for</span> my $i ( @versionNums ) {
<a name="l00404"></a>00404                 my %versionUserProblems = map { $_-&gt;problem_id =&gt; $_ }
<a name="l00405"></a>00405                     $db-&gt;getAllMergedProblemVersions( $userID, $setID, $i );
<a name="l00406"></a>00406                 my $score = 0;
<a name="l00407"></a>00407                 <span class="keywordflow">foreach</span> ( values ( %versionUserProblems ) ) {
<a name="l00408"></a>00408                     my $status = $_-&gt;status || 0;
<a name="l00409"></a>00409                     my $value = $_-&gt;value || 1;
<a name="l00410"></a>00410 <span class="preprocessor">                # some of these are coming in null; I&#39;m not</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span><span class="preprocessor">                # why, or if this should be necessary</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span>                    $_-&gt;status($status);
<a name="l00413"></a>00413                     $_-&gt;value($value);
<a name="l00414"></a>00414                     $score += $status*$value;
<a name="l00415"></a>00415                 }
<a name="l00416"></a>00416                 <span class="keywordflow">if</span> ( $score &gt; $bestScore ) {
<a name="l00417"></a>00417                     $CurrUserProblems = \%versionUserProblems;
<a name="l00418"></a>00418                     $bestScore = $score;
<a name="l00419"></a>00419                 }
<a name="l00420"></a>00420                 }
<a name="l00421"></a>00421             } <span class="keywordflow">else</span> {
<a name="l00422"></a>00422                 my %cp = map { $_-&gt;problem_id =&gt; $_ }
<a name="l00423"></a>00423                 $db-&gt;getAllMergedUserProblems($userID, $setID);
<a name="l00424"></a>00424                 $CurrUserProblems = \%cp;
<a name="l00425"></a>00425             }
<a name="l00426"></a>00426             $UserProblems{$userID} = { %{$CurrUserProblems} };
<a name="l00427"></a>00427         }
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429     debug(<span class="stringliteral">&quot;done pre-fetching user problems for set $setID&quot;</span>);
<a name="l00430"></a>00430     
<a name="l00431"></a>00431 <span class="preprocessor">    # Write the problem data</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span>    my $dueDateString = $self-&gt;formatDateTime($setRecord-&gt;due_date);
<a name="l00433"></a>00433     my ($dueDate, $dueTime) = $dueDateString =~ m/^([^\s]*)\s*([^\s]*)$/;
<a name="l00434"></a>00434     my $valueTotal = 0;
<a name="l00435"></a>00435     my %userStatusTotals = ();
<a name="l00436"></a>00436     my %userSuccessIndex = ();
<a name="l00437"></a>00437     my %numberOfAttempts = ();
<a name="l00438"></a>00438     my $num_of_problems  = @problemIDs;
<a name="l00439"></a>00439     <span class="keywordflow">for</span> (my $problem = 0; $problem &lt; @problemIDs; $problem++) {
<a name="l00440"></a>00440         
<a name="l00441"></a>00441 <span class="preprocessor">        #my $globalProblem = $db-&gt;getGlobalProblem($setID, $problemIDs[$problem]); #checked</span>
<a name="l00442"></a>00442 <span class="preprocessor"></span>        my $globalProblem = $GlobalProblems{$problemIDs[$problem]};
<a name="l00443"></a>00443         die <span class="stringliteral">&quot;global problem $problemIDs[$problem] not found for set $setID&quot;</span> unless $globalProblem;
<a name="l00444"></a>00444         
<a name="l00445"></a>00445         my $column = 5 + $problem * $columnsPerProblem;
<a name="l00446"></a>00446         <span class="keywordflow">if</span> ($scoringItems-&gt;{header}) {
<a name="l00447"></a>00447             $scoringData[0][$column] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00448"></a>00448             $scoringData[1][$column] = $setRecord-&gt;set_id;
<a name="l00449"></a>00449             $scoringData[2][$column] = $globalProblem-&gt;problem_id;
<a name="l00450"></a>00450             $scoringData[3][$column] = $dueDate;
<a name="l00451"></a>00451             $scoringData[4][$column] = $dueTime;
<a name="l00452"></a>00452             $scoringData[5][$column] = $globalProblem-&gt;value;
<a name="l00453"></a>00453             $scoringData[6][$column] = <span class="stringliteral">&quot;STATUS&quot;</span>;
<a name="l00454"></a>00454             <span class="keywordflow">if</span> ($scoringItems-&gt;{header} and $scoringItems-&gt;{problemAttempts}) { # Fill in with blanks, or maybe the problem number
<a name="l00455"></a>00455                 <span class="keywordflow">for</span> (my $row = 0; $row &lt; 6; $row++) {
<a name="l00456"></a>00456                     <span class="keywordflow">for</span> (my $col = $column+1; $col &lt;= $column + 2; $col++) {
<a name="l00457"></a>00457                         <span class="keywordflow">if</span> ($row == 2) {
<a name="l00458"></a>00458                             $scoringData[$row][$col] = $globalProblem-&gt;problem_id;
<a name="l00459"></a>00459                         } <span class="keywordflow">else</span> {
<a name="l00460"></a>00460                             $scoringData[$row][$col] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00461"></a>00461                         }
<a name="l00462"></a>00462                     }
<a name="l00463"></a>00463                 }
<a name="l00464"></a>00464                 $scoringData[6][$column + 1] = <span class="stringliteral">&quot;#corr&quot;</span>;
<a name="l00465"></a>00465                 $scoringData[6][$column + 2] = <span class="stringliteral">&quot;#incorr&quot;</span>;
<a name="l00466"></a>00466             }
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468         $valueTotal += $globalProblem-&gt;value;
<a name="l00469"></a>00469         
<a name="l00470"></a>00470         
<a name="l00471"></a>00471         <span class="keywordflow">for</span> (my $user = 0; $user &lt; @sortedUserIDs; $user++) {
<a name="l00472"></a>00472 <span class="preprocessor">            #my $userProblem = $userProblems{    $users{$userKeys[$user]}-&gt;user_id   };</span>
<a name="l00473"></a>00473 <span class="preprocessor"></span><span class="preprocessor">            #my $userProblem = $UserProblems{$sers{$userKeys[$user]}-&gt;user_id}{$problemIDs[$problem]};</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span>            my $userProblem = $UserProblems{$sortedUserIDs[$user]}{$problemIDs[$problem]};
<a name="l00475"></a>00475             unless (defined $userProblem) { # assume an empty problem record <span class="keywordflow">if</span> the problem isn<span class="stringliteral">&#39;t assigned to this user</span>
<a name="l00476"></a>00476 <span class="stringliteral">                $userProblem = $db-&gt;newUserProblem;</span>
<a name="l00477"></a>00477 <span class="stringliteral">                $userProblem-&gt;status(0);</span>
<a name="l00478"></a>00478 <span class="stringliteral">                $userProblem-&gt;value(0);</span>
<a name="l00479"></a>00479 <span class="stringliteral">                $userProblem-&gt;num_correct(0);</span>
<a name="l00480"></a>00480 <span class="stringliteral">                $userProblem-&gt;num_incorrect(0);</span>
<a name="l00481"></a>00481 <span class="stringliteral">            }</span>
<a name="l00482"></a>00482 <span class="stringliteral">            $userStatusTotals{$user} = 0 unless exists $userStatusTotals{$user};</span>
<a name="l00483"></a>00483 <span class="stringliteral">            my $user_problem_status          = ($userProblem-&gt;status =~/^[\d\.]+$/) ? $userProblem-&gt;status : 0; # ensure it&#39;</span>s numeric
<a name="l00484"></a>00484             $userStatusTotals{$user}        += $user_problem_status * $userProblem-&gt;value;  
<a name="l00485"></a>00485             <span class="keywordflow">if</span> ($scoringItems-&gt;{successIndex})   {
<a name="l00486"></a>00486                 $numberOfAttempts{$user}  = 0 unless defined($numberOfAttempts{$user});
<a name="l00487"></a>00487                 my $num_correct     = $userProblem-&gt;num_correct;
<a name="l00488"></a>00488                 my $num_incorrect   = $userProblem-&gt;num_incorrect;
<a name="l00489"></a>00489                 $num_correct        = ( defined($num_correct) and $num_correct) ? $num_correct : 0;
<a name="l00490"></a>00490                 $num_incorrect      = ( defined($num_incorrect) and $num_incorrect) ? $num_incorrect : 0;
<a name="l00491"></a>00491                 $numberOfAttempts{$user} += $num_correct + $num_incorrect;   
<a name="l00492"></a>00492             }
<a name="l00493"></a>00493             <span class="keywordflow">if</span> ($scoringItems-&gt;{problemScores}) {
<a name="l00494"></a>00494                 $scoringData[7 + $user][$column] = $userProblem-&gt;status;
<a name="l00495"></a>00495                 <span class="keywordflow">if</span> ($scoringItems-&gt;{problemAttempts}) {
<a name="l00496"></a>00496                     $scoringData[7 + $user][$column + 1] = $userProblem-&gt;num_correct;
<a name="l00497"></a>00497                     $scoringData[7 + $user][$column + 2] = $userProblem-&gt;num_incorrect;
<a name="l00498"></a>00498                 }
<a name="l00499"></a>00499             }
<a name="l00500"></a>00500         }
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502     <span class="keywordflow">if</span> ($scoringItems-&gt;{successIndex}) {
<a name="l00503"></a>00503         <span class="keywordflow">for</span> (my $user = 0; $user &lt; @sortedUserIDs; $user++) {
<a name="l00504"></a>00504             my $avg_num_attempts = ($num_of_problems) ? $numberOfAttempts{$user}/$num_of_problems : 0;
<a name="l00505"></a>00505             $userSuccessIndex{$user} = ($avg_num_attempts &amp;&amp; $valueTotal) ? ($userStatusTotals{$user}/$valueTotal)**2/$avg_num_attempts : 0;                        
<a name="l00506"></a>00506         }
<a name="l00507"></a>00507     }
<a name="l00508"></a>00508 <span class="preprocessor">    # write the status totals</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($scoringItems-&gt;{setTotals}) { # Ironic, isn<span class="stringliteral">&#39;t it?</span>
<a name="l00510"></a>00510 <span class="stringliteral">        my $totalsColumn = $format eq &quot;totals&quot; ? 0 : 5 + @problemIDs * $columnsPerProblem;</span>
<a name="l00511"></a>00511 <span class="stringliteral">        $scoringData[0][$totalsColumn]    = &quot;&quot;;</span>
<a name="l00512"></a>00512 <span class="stringliteral">        $scoringData[1][$totalsColumn]    = $setRecord-&gt;set_id;</span>
<a name="l00513"></a>00513 <span class="stringliteral">        $scoringData[2][$totalsColumn]    = &quot;&quot;;</span>
<a name="l00514"></a>00514 <span class="stringliteral">        $scoringData[3][$totalsColumn]    = &quot;&quot;;</span>
<a name="l00515"></a>00515 <span class="stringliteral">        $scoringData[4][$totalsColumn]    = &quot;&quot;;</span>
<a name="l00516"></a>00516 <span class="stringliteral">        $scoringData[5][$totalsColumn]    = $valueTotal;</span>
<a name="l00517"></a>00517 <span class="stringliteral">        $scoringData[6][$totalsColumn]    = &quot;total&quot;;</span>
<a name="l00518"></a>00518 <span class="stringliteral">        if ($scoringItems-&gt;{successIndex}) {</span>
<a name="l00519"></a>00519 <span class="stringliteral">            $scoringData[0][$totalsColumn+1]    = &quot;&quot;;</span>
<a name="l00520"></a>00520 <span class="stringliteral">            $scoringData[1][$totalsColumn+1]    = $setRecord-&gt;set_id;</span>
<a name="l00521"></a>00521 <span class="stringliteral">            $scoringData[2][$totalsColumn+1]    = &quot;&quot;;</span>
<a name="l00522"></a>00522 <span class="stringliteral">            $scoringData[3][$totalsColumn+1]    = &quot;&quot;;</span>
<a name="l00523"></a>00523 <span class="stringliteral">            $scoringData[4][$totalsColumn+1]    = &quot;&quot;;</span>
<a name="l00524"></a>00524 <span class="stringliteral">            $scoringData[5][$totalsColumn+1]    = &#39;</span>100<span class="stringliteral">&#39;;</span>
<a name="l00525"></a>00525 <span class="stringliteral">            $scoringData[6][$totalsColumn+1]  = &quot;index&quot; ;</span>
<a name="l00526"></a>00526 <span class="stringliteral">        }</span>
<a name="l00527"></a>00527 <span class="stringliteral">        for (my $user = 0; $user &lt; @sortedUserIDs; $user++) {</span>
<a name="l00528"></a>00528 <span class="stringliteral">            $userStatusTotals{$user} =$userStatusTotals{$user} ||0;</span>
<a name="l00529"></a>00529 <span class="stringliteral">            $scoringData[7+$user][$totalsColumn] = sprintf(&quot;%.1f&quot;,$userStatusTotals{$user}) if $scoringItems-&gt;{setTotals};</span>
<a name="l00530"></a>00530 <span class="stringliteral">            $scoringData[7+$user][$totalsColumn+1] = sprintf(&quot;%.0f&quot;,100*$userSuccessIndex{$user}) if $scoringItems-&gt;{successIndex};</span>
<a name="l00531"></a>00531 <span class="stringliteral"></span>
<a name="l00532"></a>00532 <span class="stringliteral">        }</span>
<a name="l00533"></a>00533 <span class="stringliteral">    }</span>
<a name="l00534"></a>00534 <span class="stringliteral">    debug(&quot;End  set $setID&quot;);</span>
<a name="l00535"></a>00535 <span class="stringliteral">    return @scoringData;</span>
<a name="l00536"></a>00536 <span class="stringliteral">}</span>
<a name="l00537"></a>00537 <span class="stringliteral"></span>
<a name="l00538"></a>00538 <span class="stringliteral">sub sumScores {    # Create a totals column for each student</span>
<a name="l00539"></a>00539 <span class="stringliteral">    my $self        = shift;</span>
<a name="l00540"></a>00540 <span class="stringliteral">    my $r_totals    = shift;</span>
<a name="l00541"></a>00541 <span class="stringliteral">    my $showIndex   = shift;</span>
<a name="l00542"></a>00542 <span class="stringliteral">    my $r_users     = shift;</span>
<a name="l00543"></a>00543 <span class="stringliteral">    my $r_sorted_user_ids =shift;</span>
<a name="l00544"></a>00544 <span class="stringliteral">    my $r           = $self-&gt;r;</span>
<a name="l00545"></a>00545 <span class="stringliteral">    my $db          = $r-&gt;db;</span>
<a name="l00546"></a>00546 <span class="stringliteral">    my @scoringData = ();</span>
<a name="l00547"></a>00547 <span class="stringliteral">    my $index_increment  = ($showIndex) ? 2 : 1;</span>
<a name="l00548"></a>00548 <span class="stringliteral">    # This whole thing is a hack, but here goes.  We&#39;</span>re going to sum the appropriate columns of the totals file:
<a name="l00549"></a>00549 <span class="preprocessor">    # I believe we have $r_totals-&gt;[rows]-&gt;[cols]  -- the way it&#39;s printed out.</span>
<a name="l00550"></a>00550 <span class="preprocessor"></span>    my $start_column  = 6;  #The problem column 
<a name="l00551"></a>00551     my $last_column   = $#{$r_totals-&gt;[1]};  # <span class="keywordflow">try</span> to figure out the number of the last column in the array.
<a name="l00552"></a>00552     my $row_count     = $#{$r_totals};
<a name="l00553"></a>00553     
<a name="l00554"></a>00554 <span class="preprocessor">    # Calculate total number of problems for the course.</span>
<a name="l00555"></a>00555 <span class="preprocessor"></span>    my $totalPoints      = 0;
<a name="l00556"></a>00556     my $problemValueRow  = 5;
<a name="l00557"></a>00557     <span class="keywordflow">for</span>( my $j = $start_column;$j&lt;=$last_column;$j+= $index_increment) {
<a name="l00558"></a>00558         my $score = $r_totals-&gt;[$problemValueRow]-&gt;[$j];
<a name="l00559"></a>00559         $totalPoints += ($score =~/^\s*[\d\.]+\s*$/)? $score : 0;
<a name="l00560"></a>00560     }
<a name="l00561"></a>00561     <span class="keywordflow">foreach</span> my $i (0..$row_count) {
<a name="l00562"></a>00562         my $studentTotal = 0;
<a name="l00563"></a>00563         <span class="keywordflow">for</span>( my $j = $start_column;$j&lt;=$last_column;$j+= $index_increment) {
<a name="l00564"></a>00564             my $score = $r_totals-&gt;[$i]-&gt;[$j];
<a name="l00565"></a>00565             $studentTotal += ($score =~/^\s*[\d\.]+\s*$/)? $score : 0;
<a name="l00566"></a>00566             
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568         $scoringData[$i][0] =sprintf(<span class="stringliteral">&quot;%.1f&quot;</span>,$studentTotal);
<a name="l00569"></a>00569         $scoringData[$i][1] =($totalPoints) ?sprintf(<span class="stringliteral">&quot;%.1f&quot;</span>,100*$studentTotal/$totalPoints) : 0;
<a name="l00570"></a>00570     }
<a name="l00571"></a>00571     $scoringData[0]      = [<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>];
<a name="l00572"></a>00572     $scoringData[1]      = [<span class="stringliteral">&#39;summary&#39;</span>, <span class="stringliteral">&#39;%score&#39;</span>];
<a name="l00573"></a>00573     $scoringData[2]      = [<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>];
<a name="l00574"></a>00574     $scoringData[3]      = [<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>];
<a name="l00575"></a>00575     $scoringData[4]      = [<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>];
<a name="l00576"></a>00576     $scoringData[6]      = [<span class="stringliteral">&#39;&#39;</span>,<span class="stringliteral">&#39;&#39;</span>];
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 
<a name="l00579"></a>00579     <span class="keywordflow">return</span> @scoringData;
<a name="l00580"></a>00580 }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 
<a name="l00583"></a>00583 <span class="preprocessor"># Often it&#39;s more efficient to just get everything out of the database</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span><span class="preprocessor"># and then pick out what you want later.  Hence, these &quot;everything2*&quot; functions</span>
<a name="l00585"></a>00585 <span class="preprocessor"></span>sub everything2info {
<a name="l00586"></a>00586     my ($self, @everything) = @_;
<a name="l00587"></a>00587     my @result = ();
<a name="l00588"></a>00588     <span class="keywordflow">foreach</span> my $row (@everything) {
<a name="l00589"></a>00589         push @result, [@{$row}[0..4]];
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591     <span class="keywordflow">return</span> @result;
<a name="l00592"></a>00592 }
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 sub everything2normal {
<a name="l00595"></a>00595     my ($self, @everything) = @_;
<a name="l00596"></a>00596     my @result = ();
<a name="l00597"></a>00597     <span class="keywordflow">foreach</span> my $row (@everything) {
<a name="l00598"></a>00598         my @row = @$row;
<a name="l00599"></a>00599         my @newRow = ();
<a name="l00600"></a>00600         push @newRow, @row[0..4];
<a name="l00601"></a>00601         <span class="keywordflow">for</span> (my $i = 5; $i &lt; @row; $i+=3) {
<a name="l00602"></a>00602             push @newRow, $row[$i];
<a name="l00603"></a>00603         }
<a name="l00604"></a>00604 <span class="preprocessor">        #push @newRow, $row[$#row];</span>
<a name="l00605"></a>00605 <span class="preprocessor"></span>        push @result, [@newRow];
<a name="l00606"></a>00606     }
<a name="l00607"></a>00607     <span class="keywordflow">return</span> @result;
<a name="l00608"></a>00608 }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610 sub everything2full {
<a name="l00611"></a>00611     my ($self, @everything) = @_;
<a name="l00612"></a>00612     my @result = ();
<a name="l00613"></a>00613     <span class="keywordflow">foreach</span> my $row (@everything) {
<a name="l00614"></a>00614         push @result, [@{$row}[0..($#{$row}-1)]];
<a name="l00615"></a>00615     }
<a name="l00616"></a>00616     <span class="keywordflow">return</span> @result;
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619 sub everything2totals {
<a name="l00620"></a>00620     my ($self, @everything) = @_;
<a name="l00621"></a>00621     my @result = ();
<a name="l00622"></a>00622     <span class="keywordflow">foreach</span> my $row (@everything) {
<a name="l00623"></a>00623         push @result, [${$row}[$#{$row}]];
<a name="l00624"></a>00624     }
<a name="l00625"></a>00625     <span class="keywordflow">return</span> @result;
<a name="l00626"></a>00626 }
<a name="l00627"></a>00627 
<a name="l00628"></a>00628 sub appendColumns {
<a name="l00629"></a>00629     my ($self, $a1, $a2) = @_;
<a name="l00630"></a>00630     my @a1 = @$a1;
<a name="l00631"></a>00631     my @a2 = @$a2;
<a name="l00632"></a>00632     <span class="keywordflow">for</span> (my $i = 0; $i &lt; @a1; $i++) {
<a name="l00633"></a>00633         push @{$a1[$i]}, @{$a2[$i]};
<a name="l00634"></a>00634     }
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637 <span class="preprocessor"># Reads a CSV file and returns an array of arrayrefs, each containing a</span>
<a name="l00638"></a>00638 <span class="preprocessor"></span><span class="preprocessor"># row of data:</span>
<a name="l00639"></a>00639 <span class="preprocessor"></span><span class="preprocessor"># ([&quot;c1r1&quot;, &quot;c1r2&quot;, &quot;c1r3&quot;], [&quot;c2r1&quot;, &quot;c2r2&quot;, &quot;c2r3&quot;])</span>
<a name="l00640"></a>00640 <span class="preprocessor"></span>sub readCSV {
<a name="l00641"></a>00641     my ($self, $fileName) = @_;
<a name="l00642"></a>00642     my @result = ();
<a name="l00643"></a>00643     my @rows = split m/\n/, readFile($fileName);
<a name="l00644"></a>00644     <span class="keywordflow">foreach</span> my $row (@rows) {
<a name="l00645"></a>00645         push @result, [split m/\s*,\s*/, $row];
<a name="l00646"></a>00646     }
<a name="l00647"></a>00647     <span class="keywordflow">return</span> @result;
<a name="l00648"></a>00648 }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 <span class="preprocessor"># Write a CSV file from an array in the same format that readCSV produces</span>
<a name="l00651"></a>00651 <span class="preprocessor"></span>sub writeCSV {
<a name="l00652"></a>00652     my ($self, $filename, @csv) = @_;
<a name="l00653"></a>00653     
<a name="l00654"></a>00654     my @lengths = ();
<a name="l00655"></a>00655     <span class="keywordflow">for</span> (my $row = 0; $row &lt; @csv; $row++) {
<a name="l00656"></a>00656         <span class="keywordflow">for</span> (my $column = 0; $column &lt; @{$csv[$row]}; $column++) {
<a name="l00657"></a>00657             $lengths[$column] = 0 unless defined $lengths[$column];
<a name="l00658"></a>00658             $lengths[$column] = length $csv[$row][$column] <span class="keywordflow">if</span> defined($csv[$row][$column]) and length $csv[$row][$column] &gt; $lengths[$column];
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661     
<a name="l00662"></a>00662 <span class="preprocessor">    # Before writing a new totals file, we back up an existing totals file keeping any previous backups.</span>
<a name="l00663"></a>00663 <span class="preprocessor"></span><span class="preprocessor">    # We do not backup any other type of scoring files (e.g. ful or scr).</span>
<a name="l00664"></a>00664 <span class="preprocessor"></span>    
<a name="l00665"></a>00665     <span class="keywordflow">if</span> (($filename =~ m|(.*)/(.*_totals)\.csv$|) and (-e $filename)) {
<a name="l00666"></a>00666         my $scoringDir = $1;
<a name="l00667"></a>00667         my $short_filename = $2;
<a name="l00668"></a>00668         my $i=1;
<a name="l00669"></a>00669         <span class="keywordflow">while</span>(-e <span class="stringliteral">&quot;${scoringDir}/${short_filename}_bak$i.csv&quot;</span>) {$i++;}      #don<span class="stringliteral">&#39;t overwrite existing backups</span>
<a name="l00670"></a>00670 <span class="stringliteral">        my $bakFileName =&quot;${scoringDir}/${short_filename}_bak$i.csv&quot;;</span>
<a name="l00671"></a>00671 <span class="stringliteral">        rename $filename, $bakFileName or warn &quot;Unable to rename $filename to $bakFileName&quot;;</span>
<a name="l00672"></a>00672 <span class="stringliteral">    }</span>
<a name="l00673"></a>00673 <span class="stringliteral"></span>
<a name="l00674"></a>00674 <span class="stringliteral">    open my $fh, &quot;&gt;&quot;, $filename or warn &quot;Unable to open $filename for writing&quot;;</span>
<a name="l00675"></a>00675 <span class="stringliteral">    foreach my $row (@csv) {</span>
<a name="l00676"></a>00676 <span class="stringliteral">        my @rowPadded = ();</span>
<a name="l00677"></a>00677 <span class="stringliteral">        foreach (my $column = 0; $column &lt; @$row; $column++) {</span>
<a name="l00678"></a>00678 <span class="stringliteral">            push @rowPadded, $self-&gt;pad($row-&gt;[$column], $lengths[$column] + 1);</span>
<a name="l00679"></a>00679 <span class="stringliteral">        }</span>
<a name="l00680"></a>00680 <span class="stringliteral">        print $fh join(&quot;,&quot;, @rowPadded);</span>
<a name="l00681"></a>00681 <span class="stringliteral">        print $fh &quot;\n&quot;;</span>
<a name="l00682"></a>00682 <span class="stringliteral">    }</span>
<a name="l00683"></a>00683 <span class="stringliteral">    close $fh;</span>
<a name="l00684"></a>00684 <span class="stringliteral">}</span>
<a name="l00685"></a>00685 <span class="stringliteral"></span>
<a name="l00686"></a>00686 <span class="stringliteral"># As soon as backwards compatability is no longer a concern and we don&#39;</span>t expect to have
<a name="l00687"></a>00687 <span class="preprocessor"># to use old ww1.x code to read the output anymore, I recommend switching to using</span>
<a name="l00688"></a>00688 <span class="preprocessor"></span><span class="preprocessor"># these routines, which are more versatile and compatable with other programs which</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span><span class="preprocessor"># deal with CSV files.</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span>sub readStandardCSV {
<a name="l00691"></a>00691     my ($self, $fileName) = @_;
<a name="l00692"></a>00692     my @result = ();
<a name="l00693"></a>00693     my @rows = split m/\n/, readFile($fileName);
<a name="l00694"></a>00694     <span class="keywordflow">foreach</span> my $row (@rows) {
<a name="l00695"></a>00695         push @result, [$self-&gt;splitQuoted($row)];
<a name="l00696"></a>00696     }
<a name="l00697"></a>00697     <span class="keywordflow">return</span> @result;
<a name="l00698"></a>00698 }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700 sub writeStandardCSV {
<a name="l00701"></a>00701     my ($self, $filename, @csv) = @_;
<a name="l00702"></a>00702     open my $fh, <span class="stringliteral">&quot;&gt;&quot;</span>, $filename;
<a name="l00703"></a>00703     <span class="keywordflow">foreach</span> my $row (@csv) {
<a name="l00704"></a>00704         print $fh (join <span class="stringliteral">&quot;,&quot;</span>, map {$self-&gt;quote($_)} @$row);
<a name="l00705"></a>00705         print $fh <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00706"></a>00706     }
<a name="l00707"></a>00707     close $fh;
<a name="l00708"></a>00708 }
<a name="l00709"></a>00709 
<a name="l00710"></a>00710 <span class="preprocessor">###</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span>
<a name="l00712"></a>00712 <span class="preprocessor"># This particular unquote method unquotes (optionally) quoted strings in the</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span><span class="preprocessor"># traditional CSV style (double-quote for literal quote, etc.)</span>
<a name="l00714"></a>00714 <span class="preprocessor"></span>sub unquote {
<a name="l00715"></a>00715     my ($self, $string) = @_;
<a name="l00716"></a>00716     <span class="keywordflow">if</span> ($string =~ m/^<span class="stringliteral">&quot;(.*)&quot;</span>$/) {
<a name="l00717"></a>00717         $string = $1;
<a name="l00718"></a>00718         $string =~ s/<span class="stringliteral">&quot;&quot;</span>/<span class="stringliteral">&quot;/;</span>
<a name="l00719"></a>00719 <span class="stringliteral">    }</span>
<a name="l00720"></a>00720 <span class="stringliteral">    return $string;</span>
<a name="l00721"></a>00721 <span class="stringliteral">}</span>
<a name="l00722"></a>00722 <span class="stringliteral"></span>
<a name="l00723"></a>00723 <span class="stringliteral"># Should you wish to treat whitespace differently, this routine has been designed</span>
<a name="l00724"></a>00724 <span class="stringliteral"># to make it easy to do so.</span>
<a name="l00725"></a>00725 <span class="stringliteral">sub splitQuoted {</span>
<a name="l00726"></a>00726 <span class="stringliteral">    my ($self, $string) = @_;</span>
<a name="l00727"></a>00727 <span class="stringliteral">    my ($leadingSpace, $preText, $quoted, $postText, $trailingSpace, $result);</span>
<a name="l00728"></a>00728 <span class="stringliteral">    my @result = ();</span>
<a name="l00729"></a>00729 <span class="stringliteral">    my $continue = 1;</span>
<a name="l00730"></a>00730 <span class="stringliteral">    while ($continue) {</span>
<a name="l00731"></a>00731 <span class="stringliteral">        $string =~ m/\G(\s*)/gc;</span>
<a name="l00732"></a>00732 <span class="stringliteral">        $leadingSpace = $1;</span>
<a name="l00733"></a>00733 <span class="stringliteral">        $string =~ m/\G([^&quot;</span>,]*)/gc;
<a name="l00734"></a>00734         $preText = $1;
<a name="l00735"></a>00735         <span class="keywordflow">if</span> ($string =~ m/\G<span class="stringliteral">&quot;((?:[^&quot;</span>]|<span class="stringliteral">&quot;&quot;</span>)*)<span class="stringliteral">&quot;/gc) {</span>
<a name="l00736"></a>00736 <span class="stringliteral">            $quoted = $1;</span>
<a name="l00737"></a>00737 <span class="stringliteral">        }</span>
<a name="l00738"></a>00738 <span class="stringliteral">        $string =~ m/\G([^,]*?)(\s*)(,?)/gc;</span>
<a name="l00739"></a>00739 <span class="stringliteral">        ($postText, $trailingSpace, $continue) = ($1, $2, $3);</span>
<a name="l00740"></a>00740 <span class="stringliteral"></span>
<a name="l00741"></a>00741 <span class="stringliteral">        $preText = &quot;</span><span class="stringliteral">&quot; unless defined $preText;</span>
<a name="l00742"></a>00742 <span class="stringliteral">        $postText = &quot;</span><span class="stringliteral">&quot; unless defined $postText;</span>
<a name="l00743"></a>00743 <span class="stringliteral">        $quoted = &quot;</span><span class="stringliteral">&quot; unless defined $quoted;</span>
<a name="l00744"></a>00744 <span class="stringliteral"></span>
<a name="l00745"></a>00745 <span class="stringliteral">        if ($quoted and (not $preText and not $postText)) {</span>
<a name="l00746"></a>00746 <span class="stringliteral">                $quoted =~ s/&quot;</span><span class="stringliteral">&quot;/&quot;</span>/;
<a name="l00747"></a>00747                 $result = $quoted;
<a name="l00748"></a>00748         } <span class="keywordflow">else</span> {
<a name="l00749"></a>00749             $result = <span class="stringliteral">&quot;$preText$quoted$postText&quot;</span>;
<a name="l00750"></a>00750         }
<a name="l00751"></a>00751         push @result, $result;
<a name="l00752"></a>00752     }
<a name="l00753"></a>00753     <span class="keywordflow">return</span> @result;
<a name="l00754"></a>00754 }
<a name="l00755"></a>00755 
<a name="l00756"></a>00756 <span class="preprocessor"># This particular quoting method does CSV-style (double a quote to escape it) quoting when necessary.</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span>sub quote {
<a name="l00758"></a>00758     my ($self, $string) = @_;
<a name="l00759"></a>00759     <span class="keywordflow">if</span> ($string =~ m/[<span class="stringliteral">&quot;, ]/) {</span>
<a name="l00760"></a>00760 <span class="stringliteral">        $string =~ s/&quot;</span>/<span class="stringliteral">&quot;&quot;</span>/;
<a name="l00761"></a>00761         $string = <span class="stringliteral">&quot;\&quot;$string\&quot;&quot;</span>;
<a name="l00762"></a>00762     }
<a name="l00763"></a>00763     <span class="keywordflow">return</span> $string;
<a name="l00764"></a>00764 }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 sub pad {
<a name="l00767"></a>00767     my ($self, $string, $padTo) = @_;
<a name="l00768"></a>00768     $string = <span class="stringliteral">&#39;&#39;</span> unless defined $string;
<a name="l00769"></a>00769     <span class="keywordflow">return</span> $string unless $self-&gt;{padFields}==1;
<a name="l00770"></a>00770     my $spaces = $padTo - length $string;
<a name="l00771"></a>00771 
<a name="l00772"></a>00772 <span class="preprocessor">#   return &quot; &quot;x$spaces.$string;</span>
<a name="l00773"></a>00773 <span class="preprocessor"></span>    <span class="keywordflow">return</span> $string.<span class="stringliteral">&quot; &quot;</span>x$spaces;
<a name="l00774"></a>00774 }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776 sub maxLength {
<a name="l00777"></a>00777     my ($self, $arrayRef) = @_;
<a name="l00778"></a>00778     my $max = 0;
<a name="l00779"></a>00779     <span class="keywordflow">foreach</span> my $cell (@$arrayRef) {
<a name="l00780"></a>00780         $max = length $cell unless length $cell &lt; $max;
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782     <span class="keywordflow">return</span> $max;
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785 sub popup_set_form {
<a name="l00786"></a>00786     my $self  = shift;
<a name="l00787"></a>00787     my $r     = $self-&gt;r;   
<a name="l00788"></a>00788     my $db    = $r-&gt;db;
<a name="l00789"></a>00789     my $ce    = $r-&gt;ce;
<a name="l00790"></a>00790     my $authz = $r-&gt;authz;
<a name="l00791"></a>00791     my $user  = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00792"></a>00792 
<a name="l00793"></a>00793     my $root = $ce-&gt;{webworkURLs}-&gt;{root};
<a name="l00794"></a>00794     my $courseName = $ce-&gt;{courseName};
<a name="l00795"></a>00795 
<a name="l00796"></a>00796 <span class="preprocessor"> #     return CGI::em(&quot;You are not authorized to access the Instructor tools.&quot;) unless $authz-&gt;hasPermissions($user, &quot;access_instructor_tools&quot;);</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span>
<a name="l00798"></a>00798 <span class="preprocessor">    # This code will require changing if the permission and user tables ever have different keys.</span>
<a name="l00799"></a>00799 <span class="preprocessor"></span>    my @setNames              = ();
<a name="l00800"></a>00800     my $ra_set_records        = $self-&gt;{ra_set_records};
<a name="l00801"></a>00801     my %setLabels             = ();#  %$hr_classlistLabels;
<a name="l00802"></a>00802     my @set_records           =  sort {$a-&gt;set_id cmp $b-&gt;set_id } @{$ra_set_records};
<a name="l00803"></a>00803     <span class="keywordflow">foreach</span> my $sr (@set_records) {
<a name="l00804"></a>00804         $setLabels{$sr-&gt;set_id} = $sr-&gt;set_id;
<a name="l00805"></a>00805         push(@setNames, $sr-&gt;set_id);  # reorder sets
<a name="l00806"></a>00806     }
<a name="l00807"></a>00807     <span class="keywordflow">return</span>          CGI::popup_menu(-name=&gt;<span class="stringliteral">&#39;selectedSet&#39;</span>,
<a name="l00808"></a>00808                                -values=&gt;\@setNames,
<a name="l00809"></a>00809                                -labels=&gt;\%setLabels,
<a name="l00810"></a>00810                                -size  =&gt; 10,
<a name="l00811"></a>00811                                -multiple =&gt; 1,
<a name="l00812"></a>00812                                #-<span class="keywordflow">default</span>=&gt;$user
<a name="l00813"></a>00813                     ),
<a name="l00814"></a>00814 
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 1;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819 __END__
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 Here<span class="stringliteral">&#39;s pretty much everything I can think of that we can get out of the database</span>
<a name="l00822"></a>00822 <span class="stringliteral">or calculate:</span>
<a name="l00823"></a>00823 <span class="stringliteral"></span>
<a name="l00824"></a>00824 <span class="stringliteral">for each set, we have a few rows of non-user-specific data above the student rows</span>
<a name="l00825"></a>00825 <span class="stringliteral">(we could just have additional columns for these values, but they&#39;</span>d have the same value in every row)
<a name="l00826"></a>00826     set_id
<a name="l00827"></a>00827     optional other <span class="keyword">set</span> data (dates, etc)
<a name="l00828"></a>00828     per-problem data (usually not shown, but available <span class="keywordflow">if</span> needed)
<a name="l00829"></a>00829         problem_id
<a name="l00830"></a>00830         problem value
<a name="l00831"></a>00831     <span class="keywordflow">for</span> all problems in the <span class="keyword">set</span>
<a name="l00832"></a>00832         total value
<a name="l00833"></a>00833 <span class="keywordflow">for each</span> student (one row) we need columns <span class="keywordflow">for</span>:
<a name="l00834"></a>00834     user_id and/or student_id
<a name="l00835"></a>00835     optional other user data (first_name/last_name, section, recitation, etc)
<a name="l00836"></a>00836     per-set data
<a name="l00837"></a>00837         per-problem data (usually not shown, but available if needed)
<a name="l00838"></a>00838             status
<a name="l00839"></a>00839             score = value*status
<a name="l00840"></a>00840             number of attempts
<a name="l00841"></a>00841             number of correct attempts
<a name="l00842"></a>00842             number of incorrect attempts
<a name="l00843"></a>00843         for all problems in the set
<a name="l00844"></a>00844             total status
<a name="l00845"></a>00845             total score
<a name="l00846"></a>00846             total number of attempts
<a name="l00847"></a>00847             average number of attempts
<a name="l00848"></a>00848             total number of correct attempts
<a name="l00849"></a>00849             average number of correct attempts
<a name="l00850"></a>00850             total number of incorrect attempts
<a name="l00851"></a>00851             average number of incorrect attempts
<a name="l00852"></a>00852             index = ( total_status / total_value )**2 / average_number_of_attempts
<a name="l00853"></a>00853 
<a name="l00854"></a>00854 &quot;value&quot; is the weight of the problem, in the range [0,inf), usually 1.
<a name="l00855"></a>00855 &quot;status&quot; is the correctness of a problem, in the range [0,1].
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:35 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
