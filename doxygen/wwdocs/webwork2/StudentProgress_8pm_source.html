<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: StudentProgress.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>StudentProgress.pm</h1><a href="StudentProgress_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/Instructor/StudentProgress.pm,v 1.36 2008/06/19 19:34:31 glarose Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::Instructor::StudentProgress;
<a name="l00018"></a>00018 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">WeBWorK::ContentGenerator::Instructor</a>);
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 =head1 NAME
<a name="l00021"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1StudentProgress.html">00021</a> 
<a name="l00022"></a>00022 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1StudentProgress.html">WeBWorK::ContentGenerator::Instructor::StudentProgress</a> - Display Student Progress.
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 =cut
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 use strict;
<a name="l00027"></a>00027 use warnings;
<a name="l00028"></a>00028 <span class="preprocessor">#use CGI qw(-nosticky );</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00030"></a>00030 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00031"></a>00031 use <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Grades.html">WeBWorK::ContentGenerator::Grades</a>;
<a name="l00032"></a>00032 <span class="preprocessor">#use WeBWorK::Utils qw(readDirectory list2hash max sortByName);</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1Utils_1_1SortRecords.html">WeBWorK::Utils::SortRecords</a> qw/sortRecords/;
<a name="l00034"></a>00034 use <a class="code" href="classWeBWorK_1_1Utils_1_1Grades.html">WeBWorK::Utils::Grades</a> qw/list_set_versions/;
<a name="l00035"></a>00035 use <a class="code" href="classWeBWorK_1_1DB_1_1Record_1_1UserSet.html">WeBWorK::DB::Record::UserSet</a>;  #FIXME -- <span class="keyword">this</span> is only used in one spot.
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 # The table format has been borrowed from the <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Grades.html">Grades</a>.pm module
<a name="l00038"></a>00038 sub initialize {
<a name="l00039"></a>00039     my $self     = shift; 
<a name="l00040"></a>00040 <span class="preprocessor">    # FIXME  are there args here?</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>    my @components = @_;
<a name="l00042"></a>00042     my $r          = $self-&gt;{r};
<a name="l00043"></a>00043     my $urlpath    = $r-&gt;urlpath;
<a name="l00044"></a>00044     my $type       = $urlpath-&gt;arg(<span class="stringliteral">&quot;statType&quot;</span>) || <span class="stringliteral">&#39;&#39;</span>;
<a name="l00045"></a>00045     my $db         = $self-&gt;{db};
<a name="l00046"></a>00046     my $ce         = $self-&gt;{ce};
<a name="l00047"></a>00047     my $authz      = $self-&gt;{authz};
<a name="l00048"></a>00048     my $courseName = $urlpath-&gt;arg(<span class="stringliteral">&#39;courseID&#39;</span>);
<a name="l00049"></a>00049     my $user       = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00050"></a>00050     
<a name="l00051"></a>00051 <span class="preprocessor">    # Check permissions</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>    <span class="keywordflow">return</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
<a name="l00053"></a>00053     
<a name="l00054"></a>00054     $self-&gt;{type}  = $type;
<a name="l00055"></a>00055     <span class="keywordflow">if</span> ($type eq <span class="stringliteral">&#39;student&#39;</span>) {
<a name="l00056"></a>00056         my $studentName = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;userID&quot;</span>) || $user;
<a name="l00057"></a>00057         $self-&gt;{studentName } = $studentName;
<a name="l00058"></a>00058         
<a name="l00059"></a>00059     } elsif ($type eq <span class="stringliteral">&#39;set&#39;</span>) {
<a name="l00060"></a>00060         my $setName = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>) || 0;
<a name="l00061"></a>00061         $self-&gt;{setName}     = $setName;
<a name="l00062"></a>00062         my $setRecord  = $db-&gt;getGlobalSet($setName); # checked
<a name="l00063"></a>00063         die <span class="stringliteral">&quot;global set $setName  not found.&quot;</span> unless $setRecord;
<a name="l00064"></a>00064         $self-&gt;{set_due_date} = $setRecord-&gt;due_date;
<a name="l00065"></a>00065         $self-&gt;{setRecord}   = $setRecord;
<a name="l00066"></a>00066     }
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 
<a name="l00070"></a>00070 sub title { 
<a name="l00071"></a>00071     my ($self) = @_;
<a name="l00072"></a>00072     my $r = $self-&gt;r;
<a name="l00073"></a>00073     my $authz = $r-&gt;authz;
<a name="l00074"></a>00074     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00075"></a>00075     
<a name="l00076"></a>00076 <span class="preprocessor">    # Check permissions</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
<a name="l00078"></a>00078     
<a name="l00079"></a>00079     my $type                = $self-&gt;{type};
<a name="l00080"></a>00080     my $string              = <span class="stringliteral">&quot;Student Progress for &quot;</span>.$self-&gt;{ce}-&gt;{courseName}.<span class="stringliteral">&quot; &quot;</span>;
<a name="l00081"></a>00081     <span class="keywordflow">if</span> ($type eq <span class="stringliteral">&#39;student&#39;</span>) {
<a name="l00082"></a>00082         $string             .= <span class="stringliteral">&quot;student &quot;</span>.$self-&gt;{studentName};
<a name="l00083"></a>00083     } elsif ($type eq <span class="stringliteral">&#39;set&#39;</span> ) {
<a name="l00084"></a>00084         $string             .= <span class="stringliteral">&quot;set   &quot;</span>.$self-&gt;{setName};
<a name="l00085"></a>00085         $string             .= <span class="stringliteral">&quot;.&amp;nbsp;&amp;nbsp;&amp;nbsp; Due &quot;</span>. $self-&gt;formatDateTime($self-&gt;{set_due_date});
<a name="l00086"></a>00086     }
<a name="l00087"></a>00087     <span class="keywordflow">return</span> $string;
<a name="l00088"></a>00088 }
<a name="l00089"></a>00089 sub siblings {
<a name="l00090"></a>00090     my ($self) = @_;
<a name="l00091"></a>00091     my $r = $self-&gt;r;
<a name="l00092"></a>00092     my $db = $r-&gt;db;
<a name="l00093"></a>00093     my $authz = $r-&gt;authz;
<a name="l00094"></a>00094     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00095"></a>00095     my $urlpath = $r-&gt;urlpath;
<a name="l00096"></a>00096     
<a name="l00097"></a>00097 <span class="preprocessor">    # Check permissions</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
<a name="l00099"></a>00099     
<a name="l00100"></a>00100     my $courseID = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00101"></a>00101     my $eUserID  = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>);
<a name="l00102"></a>00102     my @setIDs   = sort  $db-&gt;listGlobalSets;
<a name="l00103"></a>00103     
<a name="l00104"></a>00104     my $progress     = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::StudentProgress&quot;</span>,  $r, 
<a name="l00105"></a>00105                                             courseID =&gt; $courseID);
<a name="l00106"></a>00106     
<a name="l00107"></a>00107     print CGI::start_div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;info-box&quot;</span>, <span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;fisheye&quot;</span>});
<a name="l00108"></a>00108     print CGI::h2(<span class="stringliteral">&quot;Student Progress&quot;</span>);
<a name="l00109"></a>00109 <span class="preprocessor">    #print CGI::start_ul({class=&gt;&quot;LinksMenu&quot;});</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span><span class="preprocessor">    #print CGI::start_li();</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span><span class="preprocessor">    #print CGI::span({style=&gt;&quot;font-size:larger&quot;}, CGI::a({href=&gt;$self-&gt;systemLink($stats)}, &#39;Statistics&#39;));</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>    print CGI::start_ul();
<a name="l00113"></a>00113     <span class="keywordflow">foreach</span> my $setID (@setIDs) {
<a name="l00114"></a>00114         my $problemPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::StudentProgress&quot;</span>, $r, 
<a name="l00115"></a>00115             courseID =&gt; $courseID, setID =&gt; $setID,statType =&gt; <span class="stringliteral">&#39;set&#39;</span>,);
<a name="l00116"></a>00116         my $prettySetID = $setID;
<a name="l00117"></a>00117         $prettySetID =~ s/_/ /g;
<a name="l00118"></a>00118         print CGI::li({},CGI::a({href=&gt;$self-&gt;systemLink($problemPage)}, $prettySetID));
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120     
<a name="l00121"></a>00121     print CGI::end_ul();
<a name="l00122"></a>00122 <span class="preprocessor">    #print CGI::end_li();</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span><span class="preprocessor">    #print CGI::end_ul();</span>
<a name="l00124"></a>00124 <span class="preprocessor"></span>    print CGI::end_div();
<a name="l00125"></a>00125     
<a name="l00126"></a>00126     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 sub body {
<a name="l00129"></a>00129     my $self       = shift;
<a name="l00130"></a>00130     my $r          = $self-&gt;r;
<a name="l00131"></a>00131     my $urlpath    = $r-&gt;urlpath;
<a name="l00132"></a>00132     my $db         = $r-&gt;db;
<a name="l00133"></a>00133     my $ce         = $r-&gt;ce;
<a name="l00134"></a>00134     my $authz      = $r-&gt;authz;
<a name="l00135"></a>00135     my $user       = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00136"></a>00136     my $courseName = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00137"></a>00137     my $type       = $self-&gt;{type};
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 <span class="preprocessor">    # Check permissions </span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}. CGI::p(<span class="stringliteral">&quot;You are not authorized to access instructor tools&quot;</span>))
<a name="l00141"></a>00141         unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
<a name="l00142"></a>00142         
<a name="l00143"></a>00143     <span class="keywordflow">if</span> ($type eq <span class="stringliteral">&#39;student&#39;</span>) {
<a name="l00144"></a>00144         my $studentName = $self-&gt;{studentName};
<a name="l00145"></a>00145         my $studentRecord = $db-&gt;getUser($studentName) # checked
<a name="l00146"></a>00146             or die <span class="stringliteral">&quot;record for user $studentName not found&quot;</span>;
<a name="l00147"></a>00147         my $fullName = $studentRecord-&gt;full_name;
<a name="l00148"></a>00148         my $courseHomePage = $urlpath-&gt;new(type  =&gt; <span class="stringliteral">&#39;set_list&#39;</span>,
<a name="l00149"></a>00149             args =&gt; {courseID=&gt;$courseName});
<a name="l00150"></a>00150         my $email = $studentRecord-&gt;email_address;
<a name="l00151"></a>00151         
<a name="l00152"></a>00152         print CGI::a({-href=&gt;<span class="stringliteral">&quot;mailto:$email&quot;</span>}, $email), CGI::br(),
<a name="l00153"></a>00153             <span class="stringliteral">&quot;Section: &quot;</span>, $studentRecord-&gt;section, CGI::br(),
<a name="l00154"></a>00154             <span class="stringliteral">&quot;Recitation: &quot;</span>, $studentRecord-&gt;recitation, CGI::br();
<a name="l00155"></a>00155         
<a name="l00156"></a>00156         <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;become_student&quot;</span>)) {
<a name="l00157"></a>00157             my $act_as_student_url = $self-&gt;systemLink($courseHomePage,
<a name="l00158"></a>00158                 params =&gt; {effectiveUser=&gt;$studentName});
<a name="l00159"></a>00159             
<a name="l00160"></a>00160             print <span class="stringliteral">&#39;Act as: &#39;</span>, CGI::a({-href=&gt;$act_as_student_url},$studentRecord-&gt;user_id);
<a name="l00161"></a>00161         }
<a name="l00162"></a>00162         
<a name="l00163"></a>00163         print <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Grades.html#ae4abb37ae251c756b26b293643982811">WeBWorK::ContentGenerator::Grades::displayStudentStats</a>($self,$studentName);
<a name="l00164"></a>00164     } elsif( $type eq <span class="stringliteral">&#39;set&#39;</span>) {
<a name="l00165"></a>00165         $self-&gt;displaySets($self-&gt;{setName});
<a name="l00166"></a>00166     } elsif ($type eq <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00167"></a>00167         
<a name="l00168"></a>00168         $self-&gt;index;
<a name="l00169"></a>00169     } <span class="keywordflow">else</span> {
<a name="l00170"></a>00170         warn <span class="stringliteral">&quot;Don&#39;t recognize statistics display type: |$type|&quot;</span>;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="keywordflow">return</span> <span class="stringliteral">&#39;&#39;</span>;
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 sub index {
<a name="l00179"></a>00179     my $self          = shift;
<a name="l00180"></a>00180     my $r             = $self-&gt;r;
<a name="l00181"></a>00181     my $urlpath       = $r-&gt;urlpath;
<a name="l00182"></a>00182     my $ce            = $r-&gt;ce;
<a name="l00183"></a>00183     my $db            = $r-&gt;db;
<a name="l00184"></a>00184     my $courseName    = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00185"></a>00185     my @studentList   = sort $db-&gt;listUsers;
<a name="l00186"></a>00186     my @setList       = sort  $db-&gt;listGlobalSets;
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="preprocessor">## Edit to filter out students you aren&#39;t allowed to see</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="preprocessor">    # DBFIXME do filtering in database</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span>    my @myUsers;
<a name="l00192"></a>00192 <span class="preprocessor">#   my @studentRecords = $db-&gt;getUsers;  #this is never used</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span>    my $user = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00194"></a>00194     
<a name="l00195"></a>00195     my (@viewable_sections, @viewable_recitations);
<a name="l00196"></a>00196     <span class="keywordflow">if</span> (defined @{$ce-&gt;{viewable_sections}-&gt;{$user}})
<a name="l00197"></a>00197         {@viewable_sections = @{$ce-&gt;{viewable_sections}-&gt;{$user}};}
<a name="l00198"></a>00198     <span class="keywordflow">if</span> (defined @{$ce-&gt;{viewable_recitations}-&gt;{$user}})
<a name="l00199"></a>00199         {@viewable_recitations = @{$ce-&gt;{viewable_recitations}-&gt;{$user}};}
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (@viewable_sections or @viewable_recitations){
<a name="l00201"></a>00201         <span class="keywordflow">foreach</span> my $studentL (@studentList){
<a name="l00202"></a>00202             my $keep = 0;
<a name="l00203"></a>00203             my $student = $db-&gt;getUser($studentL);
<a name="l00204"></a>00204             <span class="keywordflow">foreach</span> my $sec (@viewable_sections){
<a name="l00205"></a>00205                 <span class="keywordflow">if</span> ($student-&gt;section() eq $sec){$keep = 1; last;}
<a name="l00206"></a>00206             }
<a name="l00207"></a>00207             <span class="keywordflow">foreach</span> my $rec (@viewable_recitations){
<a name="l00208"></a>00208                 <span class="keywordflow">if</span> ($student-&gt;recitation() eq $rec){$keep = 1; last;}
<a name="l00209"></a>00209             }
<a name="l00210"></a>00210             <span class="keywordflow">if</span> ($keep) {push @myUsers, $studentL;}      
<a name="l00211"></a>00211         }
<a name="l00212"></a>00212 <span class="preprocessor">#   @studentList = @myUsers;</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span>    }
<a name="l00214"></a>00214     <span class="keywordflow">else</span> {@myUsers = @studentList;}
<a name="l00215"></a>00215     
<a name="l00216"></a>00216 <span class="preprocessor">    # DBFIXME sort in database</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span>    my @studentRecords = $db-&gt;getUsers(@myUsers);
<a name="l00218"></a>00218     my @sortedStudentRecords = sortRecords({fields=&gt;[qw/last_name first_name user_id/]}, @studentRecords);
<a name="l00219"></a>00219         
<a name="l00220"></a>00220     my @setLinks      = ();
<a name="l00221"></a>00221     my @studentLinks  = (); 
<a name="l00222"></a>00222     <span class="keywordflow">foreach</span> my $set (@setList) {
<a name="l00223"></a>00223         my $setStatisticsPage   = $urlpath-&gt;newFromModule($urlpath-&gt;module, $r, 
<a name="l00224"></a>00224                                                           courseID =&gt; $courseName,
<a name="l00225"></a>00225                                                           statType =&gt; <span class="stringliteral">&#39;set&#39;</span>,
<a name="l00226"></a>00226                                                           setID    =&gt; $set
<a name="l00227"></a>00227         );
<a name="l00228"></a>00228         my $prettySetID = $set;
<a name="l00229"></a>00229         $prettySetID =~ s/_/ /g;
<a name="l00230"></a>00230         push @setLinks, CGI::a({-href=&gt;$self-&gt;systemLink($setStatisticsPage) }, $prettySetID);
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232     
<a name="l00233"></a>00233     <span class="keywordflow">foreach</span> my $studentRecord (@sortedStudentRecords) {
<a name="l00234"></a>00234         my $first_name = $studentRecord-&gt;first_name;
<a name="l00235"></a>00235         my $last_name = $studentRecord-&gt;last_name;
<a name="l00236"></a>00236         my $user_id = $studentRecord-&gt;user_id;
<a name="l00237"></a>00237         my $userStatisticsPage  = $urlpath-&gt;newFromModule($urlpath-&gt;module, $r, 
<a name="l00238"></a>00238                                                           courseID =&gt; $courseName,
<a name="l00239"></a>00239                                                           statType =&gt; <span class="stringliteral">&#39;student&#39;</span>,
<a name="l00240"></a>00240                                                           userID   =&gt; $user_id
<a name="l00241"></a>00241         );
<a name="l00242"></a>00242 
<a name="l00243"></a>00243         push @studentLinks, CGI::a({-href=&gt;$self-&gt;systemLink($userStatisticsPage,
<a name="l00244"></a>00244                                                              prams=&gt;{effectiveUser =&gt; $studentRecord-&gt;user_id}
<a name="l00245"></a>00245                                                              )},<span class="stringliteral">&quot;  $last_name, $first_name  ($user_id)&quot;</span> ),; 
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247     print join(<span class="stringliteral">&quot;&quot;</span>,
<a name="l00248"></a>00248         CGI::start_table({-border=&gt;2, -cellpadding=&gt;20}),
<a name="l00249"></a>00249         CGI::Tr({},
<a name="l00250"></a>00250             CGI::td({-valign=&gt;<span class="stringliteral">&#39;top&#39;</span>}, 
<a name="l00251"></a>00251                 CGI::h3({-align=&gt;<span class="stringliteral">&#39;center&#39;</span>},<span class="stringliteral">&#39;View student progress by set&#39;</span>),
<a name="l00252"></a>00252                 CGI::ul(  CGI::li( [@setLinks] ) ), 
<a name="l00253"></a>00253             ),
<a name="l00254"></a>00254             CGI::td({-valign=&gt;<span class="stringliteral">&#39;top&#39;</span>}, 
<a name="l00255"></a>00255                 CGI::h3({-align=&gt;<span class="stringliteral">&#39;center&#39;</span>},<span class="stringliteral">&#39;View student progress by student&#39;</span>),
<a name="l00256"></a>00256                 CGI::ul(CGI::li( [ @studentLinks ] ) ),
<a name="l00257"></a>00257             ),
<a name="l00258"></a>00258         ),
<a name="l00259"></a>00259         CGI::end_table(),
<a name="l00260"></a>00260     );
<a name="l00261"></a>00261     
<a name="l00262"></a>00262 }
<a name="l00263"></a>00263 <span class="preprocessor">###################################################</span>
<a name="l00264"></a>00264 <span class="preprocessor"></span>sub displaySets {
<a name="l00265"></a>00265     my $self             = shift;   
<a name="l00266"></a>00266     my $r                = $self-&gt;r;
<a name="l00267"></a>00267     my $urlpath          = $r-&gt;urlpath;
<a name="l00268"></a>00268     my $db               = $r-&gt;db;
<a name="l00269"></a>00269     my $ce               = $r-&gt;ce;
<a name="l00270"></a>00270     my $authz            = $r-&gt;authz;
<a name="l00271"></a>00271     my $courseName       = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00272"></a>00272     my $setName          = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l00273"></a>00273     my $user             = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00274"></a>00274     my $GlobalSet        = $self-&gt;{setRecord};
<a name="l00275"></a>00275     my $root             = $ce-&gt;{webworkURLs}-&gt;{root};
<a name="l00276"></a>00276     
<a name="l00277"></a>00277     my $setStatsPage     = $urlpath-&gt;newFromModule($urlpath-&gt;module, $r, courseID=&gt;$courseName,statType=&gt;<span class="stringliteral">&#39;sets&#39;</span>,setID=&gt;$setName);
<a name="l00278"></a>00278     my $primary_sort_method_name = $r-&gt;param(<span class="stringliteral">&#39;primary_sort&#39;</span>);
<a name="l00279"></a>00279     my $secondary_sort_method_name = $r-&gt;param(<span class="stringliteral">&#39;secondary_sort&#39;</span>); 
<a name="l00280"></a>00280     my $ternary_sort_method_name = $r-&gt;param(<span class="stringliteral">&#39;ternary_sort&#39;</span>);  
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 <span class="preprocessor">    # DBFIXME duplicate call!</span>
<a name="l00283"></a>00283 <span class="preprocessor"></span>    my @studentList      = $db-&gt;listUsers;
<a name="l00284"></a>00284     
<a name="l00285"></a>00285 <span class="preprocessor"># another versioning/gateway change.  in many cases we don&#39;t want or need</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span><span class="preprocessor"># all of the columns that are put in here by default, so we add a set of</span>
<a name="l00287"></a>00287 <span class="preprocessor"></span><span class="preprocessor"># flags for which columns to show.  for versioned sets we may also want to</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span><span class="preprocessor"># only see the best score, so we include that as an option also.</span>
<a name="l00289"></a>00289 <span class="preprocessor"></span><span class="preprocessor"># these are ignored for non-versioned sets</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span>    my %showColumns = ( <span class="stringliteral">&#39;name&#39;</span> =&gt; 1, <span class="stringliteral">&#39;score&#39;</span> =&gt; 1, <span class="stringliteral">&#39;outof&#39;</span> =&gt; 1, 
<a name="l00291"></a>00291                 <span class="stringliteral">&#39;date&#39;</span> =&gt; 0, <span class="stringliteral">&#39;testtime&#39;</span> =&gt; 0, <span class="stringliteral">&#39;index&#39;</span> =&gt; 1, 
<a name="l00292"></a>00292                 <span class="stringliteral">&#39;problems&#39;</span> =&gt; 1, <span class="stringliteral">&#39;section&#39;</span> =&gt; 1, <span class="stringliteral">&#39;recit&#39;</span> =&gt; 1, 
<a name="l00293"></a>00293                 <span class="stringliteral">&#39;login&#39;</span> =&gt; 1 );
<a name="l00294"></a>00294     my $showBestOnly = 0;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     my @index_list                           = ();  # list of all student index 
<a name="l00297"></a>00297     my @score_list                           = ();  # list of all student total percentage scores 
<a name="l00298"></a>00298     my %attempts_list_for_problem            = ();  # a list of the number of attempts <span class="keywordflow">for each</span> problem
<a name="l00299"></a>00299     my %number_of_attempts_for_problem       = ();  # the total number of attempst <span class="keywordflow">for</span> <span class="keyword">this</span> problem (sum of above list)
<a name="l00300"></a>00300     my %number_of_students_attempting_problem = ();  # the number of students attempting <span class="keyword">this</span> problem.
<a name="l00301"></a>00301     my %correct_answers_for_problem          = ();  # the number of students correctly answering <span class="keyword">this</span> problem (partial correctness allowed)
<a name="l00302"></a>00302     my $sort_method = sub {
<a name="l00303"></a>00303         my ($a,$b,$sort_method_name) = @_;
<a name="l00304"></a>00304         <span class="keywordflow">return</span> 0 unless defined($sort_method_name);
<a name="l00305"></a>00305         <span class="keywordflow">return</span> lc($a-&gt;{last_name}) cmp lc($b-&gt;{last_name}) <span class="keywordflow">if</span> $sort_method_name eq <span class="stringliteral">&#39;last_name&#39;</span>;
<a name="l00306"></a>00306         <span class="keywordflow">return</span> lc($a-&gt;{first_name}) cmp lc($b-&gt;{first_name}) <span class="keywordflow">if</span> $sort_method_name eq <span class="stringliteral">&#39;first_name&#39;</span>;
<a name="l00307"></a>00307         <span class="keywordflow">return</span>  lc($a-&gt;{email_address}) cmp lc($b-&gt;{email_address}) <span class="keywordflow">if</span> $sort_method_name eq <span class="stringliteral">&#39;email_address&#39;</span>;
<a name="l00308"></a>00308         <span class="keywordflow">return</span> $b-&gt;{score} &lt;=&gt; $a-&gt;{score} <span class="keywordflow">if</span> $sort_method_name eq <span class="stringliteral">&#39;score&#39;</span>;
<a name="l00309"></a>00309         <span class="keywordflow">return</span> $b-&gt;{index} &lt;=&gt; $a-&gt;{index} <span class="keywordflow">if</span> $sort_method_name eq <span class="stringliteral">&#39;index&#39;</span>;
<a name="l00310"></a>00310         <span class="keywordflow">return</span> lc($a-&gt;{section}) cmp lc($b-&gt;{section}) <span class="keywordflow">if</span> $sort_method_name eq <span class="stringliteral">&#39;section&#39;</span>;
<a name="l00311"></a>00311         <span class="keywordflow">return</span> lc($a-&gt;{recitation}) cmp lc($b-&gt;{recitation}) <span class="keywordflow">if</span> $sort_method_name eq <span class="stringliteral">&#39;recitation&#39;</span>;
<a name="l00312"></a>00312         <span class="keywordflow">return</span> lc($a-&gt;{user_id}) cmp lc($b-&gt;{user_id}) <span class="keywordflow">if</span> $sort_method_name eq <span class="stringliteral">&#39;user_id&#39;</span>;
<a name="l00313"></a>00313         <span class="keywordflow">if</span> ($sort_method_name =~/p(\d+)/) {
<a name="l00314"></a>00314             my $left  =  $b-&gt;{problemData}-&gt;{$1} ||0;
<a name="l00315"></a>00315             my $right =  $a-&gt;{problemData}-&gt;{$1} ||0;
<a name="l00316"></a>00316             <span class="keywordflow">return</span> $left &lt;=&gt; $right;  # sort by number of attempts.
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318 
<a name="l00319"></a>00319     };
<a name="l00320"></a>00320     my %display_sort_method_name = (
<a name="l00321"></a>00321         last_name =&gt; <span class="stringliteral">&#39;last name&#39;</span>,
<a name="l00322"></a>00322         first_name =&gt; <span class="stringliteral">&#39;first name&#39;</span>,
<a name="l00323"></a>00323         email_address =&gt; <span class="stringliteral">&#39;email address&#39;</span>,
<a name="l00324"></a>00324         score =&gt; <span class="stringliteral">&#39;score&#39;</span>,
<a name="l00325"></a>00325         index =&gt; <span class="stringliteral">&#39;success indicator&#39;</span>,
<a name="l00326"></a>00326         section =&gt; <span class="stringliteral">&#39;section&#39;</span>,
<a name="l00327"></a>00327         recitation =&gt; <span class="stringliteral">&#39;recitation&#39;</span>,
<a name="l00328"></a>00328         user_id =&gt; <span class="stringliteral">&#39;login name&#39;</span>,
<a name="l00329"></a>00329     );              
<a name="l00330"></a>00330 
<a name="l00331"></a>00331 <span class="preprocessor"># get versioning information</span>
<a name="l00332"></a>00332 <span class="preprocessor"></span>    my $setIsVersioned = 
<a name="l00333"></a>00333         ( defined($GlobalSet-&gt;assignment_type()) &amp;&amp; 
<a name="l00334"></a>00334           $GlobalSet-&gt;assignment_type() =~ /gateway/ ) ? 1 : 0;
<a name="l00335"></a>00335 
<a name="l00336"></a>00336 <span class="preprocessor"># reset column view options based on whether the set is versioned and, if so,</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span><span class="preprocessor"># the input parameters</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $setIsVersioned ) {
<a name="l00339"></a>00339 <span class="preprocessor">  # the returning parameter lets us set defaults for versioned sets</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>        my $ret = defined($r-&gt;param(<span class="stringliteral">&#39;returning&#39;</span>)) ? 
<a name="l00341"></a>00341             $r-&gt;param(<span class="stringliteral">&#39;returning&#39;</span>) : 0;
<a name="l00342"></a>00342         $showColumns{<span class="stringliteral">&#39;date&#39;</span>} = ($ret &amp;&amp; defined($r-&gt;param(<span class="stringliteral">&#39;show_date&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;show_date&#39;</span>) : 1;
<a name="l00343"></a>00343         $showColumns{<span class="stringliteral">&#39;testtime&#39;</span>} = ($ret &amp;&amp; defined($r-&gt;param(<span class="stringliteral">&#39;show_testtime&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;show_testtime&#39;</span>):1;
<a name="l00344"></a>00344         $showColumns{<span class="stringliteral">&#39;index&#39;</span>} = ($ret &amp;&amp; defined($r-&gt;param(<span class="stringliteral">&#39;show_index&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;show_index&#39;</span>) : 0;
<a name="l00345"></a>00345         $showColumns{<span class="stringliteral">&#39;problems&#39;</span>} = ($ret &amp;&amp; defined($r-&gt;param(<span class="stringliteral">&#39;show_problems&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;show_problems&#39;</span>):0;
<a name="l00346"></a>00346         $showColumns{<span class="stringliteral">&#39;section&#39;</span>} = ($ret &amp;&amp; defined($r-&gt;param(<span class="stringliteral">&#39;show_section&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;show_section&#39;</span>) : 0;
<a name="l00347"></a>00347         $showColumns{<span class="stringliteral">&#39;recit&#39;</span>} = ($ret &amp;&amp; defined($r-&gt;param(<span class="stringliteral">&#39;show_recitation&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;show_recitation&#39;</span>) : 0;
<a name="l00348"></a>00348         $showColumns{<span class="stringliteral">&#39;login&#39;</span>} = ($ret &amp;&amp; defined($r-&gt;param(<span class="stringliteral">&#39;show_login&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;show_login&#39;</span>) : 0;
<a name="l00349"></a>00349         $showBestOnly = ($ret &amp;&amp; defined($r-&gt;param(<span class="stringliteral">&#39;show_best_only&#39;</span>))) ? $r-&gt;param(<span class="stringliteral">&#39;show_best_only&#39;</span>) : 0;
<a name="l00350"></a>00350     }
<a name="l00351"></a>00351 
<a name="l00352"></a>00352 <span class="preprocessor">###############################################################</span>
<a name="l00353"></a>00353 <span class="preprocessor"></span><span class="preprocessor">#  Print tables</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span><span class="preprocessor">###############################################################</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span>    
<a name="l00356"></a>00356     my $max_num_problems  = 0;
<a name="l00357"></a>00357 <span class="preprocessor">    # get user records</span>
<a name="l00358"></a>00358 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;Begin obtaining user records for set $setName&quot;</span>);
<a name="l00359"></a>00359     my @userRecords  = $db-&gt;getUsers(@studentList);
<a name="l00360"></a>00360     debug(<span class="stringliteral">&quot;End obtaining user records for set $setName&quot;</span>);
<a name="l00361"></a>00361     debug(<span class="stringliteral">&quot;begin main loop&quot;</span>);
<a name="l00362"></a>00362     my @augmentedUserRecords    = ();
<a name="l00363"></a>00363     my $number_of_active_students;
<a name="l00364"></a>00364 
<a name="l00365"></a>00365 <span class="preprocessor">## Edit to filter out students</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00367"></a>00367 <span class="preprocessor"></span>    my @myUsers;
<a name="l00368"></a>00368     my $ActiveUser = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
<a name="l00369"></a>00369     my (@viewable_sections, @viewable_recitations);
<a name="l00370"></a>00370     <span class="keywordflow">if</span> (defined @{$ce-&gt;{viewable_sections}-&gt;{$user}})
<a name="l00371"></a>00371         {@viewable_sections = @{$ce-&gt;{viewable_sections}-&gt;{$user}};}
<a name="l00372"></a>00372     <span class="keywordflow">if</span> (defined @{$ce-&gt;{viewable_recitations}-&gt;{$user}})
<a name="l00373"></a>00373         {@viewable_recitations = @{$ce-&gt;{viewable_recitations}-&gt;{$user}};}
<a name="l00374"></a>00374     <span class="keywordflow">if</span> (@viewable_sections or @viewable_recitations){
<a name="l00375"></a>00375         <span class="keywordflow">foreach</span> my $student (@userRecords){
<a name="l00376"></a>00376             my $keep = 0;
<a name="l00377"></a>00377             <span class="keywordflow">foreach</span> my $sec (@viewable_sections){
<a name="l00378"></a>00378                 <span class="keywordflow">if</span> ($student-&gt;section() eq $sec){$keep = 1; last;}
<a name="l00379"></a>00379             }
<a name="l00380"></a>00380             <span class="keywordflow">foreach</span> my $rec (@viewable_recitations){
<a name="l00381"></a>00381                 <span class="keywordflow">if</span> ($student-&gt;recitation() eq $rec){$keep = 1; last;}
<a name="l00382"></a>00382             }
<a name="l00383"></a>00383             <span class="keywordflow">if</span> ($keep) {push @myUsers, $student;}       
<a name="l00384"></a>00384         }
<a name="l00385"></a>00385     }
<a name="l00386"></a>00386     <span class="keywordflow">else</span> {@myUsers = @userRecords;}
<a name="l00387"></a>00387     <span class="keywordflow">foreach</span> my $studentRecord (@myUsers)   {
<a name="l00388"></a>00388         next unless ref($studentRecord);
<a name="l00389"></a>00389         my $studentName = $studentRecord-&gt;user_id;
<a name="l00390"></a>00390         next <span class="keywordflow">if</span> $studentRecord-&gt;last_name =~/^practice/i;  # don<span class="stringliteral">&#39;t show practice users</span>
<a name="l00391"></a>00391 <span class="stringliteral">        next unless $ce-&gt;status_abbrev_has_behavior($studentRecord-&gt;status, &quot;include_in_stats&quot;);</span>
<a name="l00392"></a>00392 <span class="stringliteral">        $number_of_active_students++;</span>
<a name="l00393"></a>00393 <span class="stringliteral"></span>
<a name="l00394"></a>00394 <span class="stringliteral"># build list of versioned sets for this student user</span>
<a name="l00395"></a>00395 <span class="stringliteral">#       my @allSetNames = ();</span>
<a name="l00396"></a>00396 <span class="stringliteral">#       my $notAssignedSet = 0;</span>
<a name="l00397"></a>00397 <span class="stringliteral">#       if ( $setIsVersioned ) {</span>
<a name="l00398"></a>00398 <span class="stringliteral">#           my @setVersions = $db-&gt;listSetVersions($studentName, $setName);</span>
<a name="l00399"></a>00399 <span class="stringliteral">#           @allSetNames = map { &quot;$setName,v$_&quot; } @setVersions;</span>
<a name="l00400"></a>00400 <span class="stringliteral">#           # if there aren&#39;</span>t any <span class="keyword">set</span> versions, is it because
<a name="l00401"></a>00401 <span class="preprocessor">#           #    the user isn&#39;t assigned the set (e.g., is a </span>
<a name="l00402"></a>00402 <span class="preprocessor"></span><span class="preprocessor">#           #    proctor), or because the user hasn&#39;t completed</span>
<a name="l00403"></a>00403 <span class="preprocessor"></span><span class="preprocessor">#           #    any versions?</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span><span class="preprocessor">#           if ( ! @setVersions ) {</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span><span class="preprocessor">#               $notAssignedSet = 1 if (! $db-&gt;existsUserSet($studentName,$setName));</span>
<a name="l00406"></a>00406 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l00407"></a>00407 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00408"></a>00408 <span class="preprocessor"></span><span class="preprocessor">#       } else {</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span><span class="preprocessor">#           @allSetNames = ( &quot;$setName&quot; );</span>
<a name="l00410"></a>00410 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span>        my( $ra_allSetVersionNames, $notAssignedSet) = list_set_versions($db, $studentName, $setName, $setIsVersioned);
<a name="l00412"></a>00412         my @allSetVersionNames = @{$ra_allSetVersionNames};
<a name="l00413"></a>00413         
<a name="l00414"></a>00414 <span class="preprocessor">        # for versioned sets, we might be keeping only the high score</span>
<a name="l00415"></a>00415 <span class="preprocessor"></span>        my $maxScore = -1;
<a name="l00416"></a>00416         my $max_hash = {};
<a name="l00417"></a>00417 
<a name="l00418"></a>00418         <span class="keywordflow">foreach</span> my $setName ( @allSetVersionNames ) {
<a name="l00419"></a>00419 
<a name="l00420"></a>00420             my $status          = 0;
<a name="l00421"></a>00421             my $longStatus      = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00422"></a>00422             my $string          = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00423"></a>00423             my $twoString       = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00424"></a>00424             my $totalRight      = 0;
<a name="l00425"></a>00425             my $total           = 0;
<a name="l00426"></a>00426             my $total_num_of_attempts_for_set = 0;
<a name="l00427"></a>00427             my %h_problemData   = ();
<a name="l00428"></a>00428             my $num_of_attempts;
<a name="l00429"></a>00429             my $num_of_problems;
<a name="l00430"></a>00430             
<a name="l00431"></a>00431             my $set;
<a name="l00432"></a>00432             my $userSet;
<a name="l00433"></a>00433             <span class="keywordflow">if</span> ( $setIsVersioned ) {
<a name="l00434"></a>00434                 my ($setN,$vNum) = ($setName =~ /(.+),v(\d+)$/);
<a name="l00435"></a>00435 <span class="preprocessor">                # we&#39;ll also need information from the set</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span><span class="preprocessor">                #    as we set up the display below, so get</span>
<a name="l00437"></a>00437 <span class="preprocessor"></span><span class="preprocessor">                #    the merged userset as well</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>                $set = $db-&gt;getMergedSetVersion($studentRecord-&gt;user_id, $setN, $vNum);
<a name="l00439"></a>00439                 $userSet = $set;
<a name="l00440"></a>00440                 $setName = $setN;
<a name="l00441"></a>00441             } <span class="keywordflow">else</span> {
<a name="l00442"></a>00442                 $set = $db-&gt;getMergedSet( $studentName, $setName );
<a name="l00443"></a>00443             
<a name="l00444"></a>00444             }
<a name="l00445"></a>00445 <span class="preprocessor">             #FIXME -- this seems like over kill -- perhaps we only need to pass in the set_id.</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span><span class="preprocessor">             # that is the only aspect of $set that is used in grade set.</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span><span class="preprocessor">             # the problem_random order sequence is used in the corresponding routine in Grades.pm</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span>             
<a name="l00449"></a>00449             unless ( ref($set) ) {
<a name="l00450"></a>00450                 $set = <span class="keyword">new</span> <a class="code" href="classWeBWorK_1_1DB_1_1Record_1_1UserSet.html">WeBWorK::DB::Record::UserSet</a>;
<a name="l00451"></a>00451                 $set-&gt;set_id($setName);
<a name="l00452"></a>00452             }
<a name="l00453"></a>00453             
<a name="l00454"></a>00454            ( $status, 
<a name="l00455"></a>00455              $longStatus, 
<a name="l00456"></a>00456              $string,
<a name="l00457"></a>00457              $twoString, 
<a name="l00458"></a>00458              $totalRight,
<a name="l00459"></a>00459              $total, 
<a name="l00460"></a>00460              $num_of_attempts, 
<a name="l00461"></a>00461              $num_of_problems) = grade_set( $db, $set, $setName, $studentName, $setIsVersioned,
<a name="l00462"></a>00462                                         \%number_of_students_attempting_problem,
<a name="l00463"></a>00463                                         \%attempts_list_for_problem,
<a name="l00464"></a>00464                                         \%number_of_attempts_for_problem,
<a name="l00465"></a>00465                                         \%h_problemData,
<a name="l00466"></a>00466                                         \$total_num_of_attempts_for_set,
<a name="l00467"></a>00467                                         \%correct_answers_for_problem,
<a name="l00468"></a>00468                                );
<a name="l00469"></a>00469             my $probNum         = 0;
<a name="l00470"></a>00470             my $act_as_student_url = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472 
<a name="l00473"></a>00473 <span class="preprocessor">#       </span>
<a name="l00474"></a>00474 <span class="preprocessor"></span><span class="preprocessor">#           # add on the scores for this problem</span>
<a name="l00475"></a>00475 <span class="preprocessor"></span><span class="preprocessor">#           if (defined($attempted) and $attempted) {</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span><span class="preprocessor">#               $number_of_students_attempting_problem{$probID}++;</span>
<a name="l00477"></a>00477 <span class="preprocessor"></span><span class="preprocessor">#               push( @{ $attempts_list_for_problem{$probID} } ,     $num_of_attempts);</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span><span class="preprocessor">#               $number_of_attempts_for_problem{$probID}             += $num_of_attempts;</span>
<a name="l00479"></a>00479 <span class="preprocessor"></span><span class="preprocessor">#               $h_problemData{$probID}                               = $num_incorrect;</span>
<a name="l00480"></a>00480 <span class="preprocessor"></span><span class="preprocessor">#               $total_num_of_attempts_for_set                       += $num_of_attempts;</span>
<a name="l00481"></a>00481 <span class="preprocessor"></span><span class="preprocessor">#               $correct_answers_for_problem{$probID}                += $status;</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span>
<a name="l00484"></a>00484 <span class="preprocessor"># </span>
<a name="l00485"></a>00485 <span class="preprocessor"></span><span class="preprocessor">#           # DBFIXME: to collect the problem records, we have </span>
<a name="l00486"></a>00486 <span class="preprocessor"></span><span class="preprocessor">#           #    to know which merge routines to call.  Should </span>
<a name="l00487"></a>00487 <span class="preprocessor"></span><span class="preprocessor">#           #    this really be an issue here?  That is, </span>
<a name="l00488"></a>00488 <span class="preprocessor"></span><span class="preprocessor">#           #    shouldn&#39;t the database deal with it invisibly </span>
<a name="l00489"></a>00489 <span class="preprocessor"></span><span class="preprocessor">#           #    by detecting what the problem types are?</span>
<a name="l00490"></a>00490 <span class="preprocessor"></span><span class="preprocessor">#           # DBFIXME sort in database</span>
<a name="l00491"></a>00491 <span class="preprocessor"></span><span class="preprocessor">#           my $userSet;</span>
<a name="l00492"></a>00492 <span class="preprocessor"></span><span class="preprocessor">#           my @problemRecords = ();</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span><span class="preprocessor">#           if ( $setIsVersioned ) {</span>
<a name="l00494"></a>00494 <span class="preprocessor"></span><span class="preprocessor">#               my ($setN,$vNum) = ($sN =~ /(.+),v(\d+)$/);</span>
<a name="l00495"></a>00495 <span class="preprocessor"></span><span class="preprocessor">#               @problemRecords = sort {$a-&gt;problem_id &lt;=&gt; $b-&gt;problem_id } $db-&gt;getAllMergedProblemVersions( $student, $setN, $vNum );</span>
<a name="l00496"></a>00496 <span class="preprocessor"></span><span class="preprocessor">#               # we&#39;ll also need information from the set</span>
<a name="l00497"></a>00497 <span class="preprocessor"></span><span class="preprocessor">#               #    as we set up the display below, so get</span>
<a name="l00498"></a>00498 <span class="preprocessor"></span><span class="preprocessor">#               #    the merged userset as well</span>
<a name="l00499"></a>00499 <span class="preprocessor"></span><span class="preprocessor">#               $userSet = $db-&gt;getMergedSetVersion($studentRecord-&gt;user_id, $setN, $vNum);</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00501"></a>00501 <span class="preprocessor"></span><span class="preprocessor">#           } else {</span>
<a name="l00502"></a>00502 <span class="preprocessor"></span><span class="preprocessor">#               @problemRecords = sort {$a-&gt;problem_id &lt;=&gt; $b-&gt;problem_id} $db-&gt;getAllMergedUserProblems( $student, $sN );</span>
<a name="l00503"></a>00503 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span><span class="preprocessor">#           debug(&quot;End obtaining problem records for user $student set $sN&quot;);</span>
<a name="l00505"></a>00505 <span class="preprocessor"></span><span class="preprocessor">#           my $num_of_problems = @problemRecords;</span>
<a name="l00506"></a>00506 <span class="preprocessor"></span><span class="preprocessor">#           $max_num_problems = ($max_num_problems&gt;= $num_of_problems) ? $max_num_problems : $num_of_problems;</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span><span class="preprocessor">#           ########################################</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span><span class="preprocessor">#           # Notes for factoring the calculation in this loop.</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span><span class="preprocessor">#           #</span>
<a name="l00510"></a>00510 <span class="preprocessor"></span><span class="preprocessor">#           # Inputs include:</span>
<a name="l00511"></a>00511 <span class="preprocessor"></span><span class="preprocessor">#           #   @problemRecords  </span>
<a name="l00512"></a>00512 <span class="preprocessor"></span><span class="preprocessor">#           # returns</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span><span class="preprocessor">#           #   $num_of_attempts</span>
<a name="l00514"></a>00514 <span class="preprocessor"></span><span class="preprocessor">#           #   $status</span>
<a name="l00515"></a>00515 <span class="preprocessor"></span><span class="preprocessor">#           # updates</span>
<a name="l00516"></a>00516 <span class="preprocessor"></span><span class="preprocessor">#           #   $number_of_students_attempting_problem{$probID}++;</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span><span class="preprocessor">#           #   @{ $attempts_list_for_problem{$probID} }   </span>
<a name="l00518"></a>00518 <span class="preprocessor"></span><span class="preprocessor">#           #   $number_of_attempts_for_problem{$probID}</span>
<a name="l00519"></a>00519 <span class="preprocessor"></span><span class="preprocessor">#           #   $total_num_of_attempts_for_set</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span><span class="preprocessor">#           #   $correct_answers_for_problem{$probID}   </span>
<a name="l00521"></a>00521 <span class="preprocessor"></span><span class="preprocessor">#           #    </span>
<a name="l00522"></a>00522 <span class="preprocessor"></span><span class="preprocessor">#           #   $string (formatting output)</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span><span class="preprocessor">#           #   $twoString (more formatted output)</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span><span class="preprocessor">#           #   $longtwo (a combination of $string and $twostring)</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span><span class="preprocessor">#           #   $total</span>
<a name="l00526"></a>00526 <span class="preprocessor"></span><span class="preprocessor">#           #   $totalRight</span>
<a name="l00527"></a>00527 <span class="preprocessor"></span><span class="preprocessor">#           ###################################</span>
<a name="l00528"></a>00528 <span class="preprocessor"></span><span class="preprocessor">#    </span>
<a name="l00529"></a>00529 <span class="preprocessor"></span><span class="preprocessor">#           foreach my $problemRecord (@problemRecords) {</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span><span class="preprocessor">#               next unless ref($problemRecord);</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span><span class="preprocessor">#               # warn &quot;Can&#39;t find record for problem $prob in set $setName for $student&quot;;</span>
<a name="l00532"></a>00532 <span class="preprocessor"></span><span class="preprocessor">#               # FIXME check the legitimate reasons why a student record might not be defined</span>
<a name="l00533"></a>00533 <span class="preprocessor"></span><span class="preprocessor">#               ###########################################</span>
<a name="l00534"></a>00534 <span class="preprocessor"></span><span class="preprocessor">#               # Grab data from the database</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span><span class="preprocessor">#               ###########################################</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span><span class="preprocessor">#               # It&#39;s possible that </span>
<a name="l00537"></a>00537 <span class="preprocessor"></span><span class="preprocessor">#               # $problemRecord-&gt;num_correct or </span>
<a name="l00538"></a>00538 <span class="preprocessor"></span><span class="preprocessor">#               # $problemRecord-&gt;num_correct</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span><span class="preprocessor">#               # or $problemRecord-&gt;status is an empty </span>
<a name="l00540"></a>00540 <span class="preprocessor"></span><span class="preprocessor">#               # or blank string instead of 0.  </span>
<a name="l00541"></a>00541 <span class="preprocessor"></span><span class="preprocessor">#               # The || clause fixes this and prevents </span>
<a name="l00542"></a>00542 <span class="preprocessor"></span><span class="preprocessor">#               # warning messages in the comparisons below.</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span><span class="preprocessor">#           </span>
<a name="l00544"></a>00544 <span class="preprocessor"></span><span class="preprocessor">#               my $probID          = $problemRecord-&gt;problem_id;</span>
<a name="l00545"></a>00545 <span class="preprocessor"></span><span class="preprocessor">#               my $attempted       = $problemRecord-&gt;attempted;</span>
<a name="l00546"></a>00546 <span class="preprocessor"></span><span class="preprocessor">#               my $num_correct     = $problemRecord-&gt;num_correct     || 0;</span>
<a name="l00547"></a>00547 <span class="preprocessor"></span><span class="preprocessor">#               my $num_incorrect   = $problemRecord-&gt;num_incorrect   || 0;</span>
<a name="l00548"></a>00548 <span class="preprocessor"></span><span class="preprocessor">#               my $num_of_attempts = $num_correct + $num_incorrect;</span>
<a name="l00549"></a>00549 <span class="preprocessor"></span><span class="preprocessor">#               # initialize the number of correct answers </span>
<a name="l00550"></a>00550 <span class="preprocessor"></span><span class="preprocessor">#               # for this problem if the value has not been </span>
<a name="l00551"></a>00551 <span class="preprocessor"></span><span class="preprocessor">#               # defined.</span>
<a name="l00552"></a>00552 <span class="preprocessor"></span><span class="preprocessor">#               $correct_answers_for_problem{$probID} = 0 </span>
<a name="l00553"></a>00553 <span class="preprocessor"></span><span class="preprocessor">#                   unless defined($correct_answers_for_problem{$probID});</span>
<a name="l00554"></a>00554 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00555"></a>00555 <span class="preprocessor"></span><span class="preprocessor">#               ## This doesn&#39;t work - Fix it</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span><span class="preprocessor">#               my $probValue = $problemRecord-&gt;value;</span>
<a name="l00557"></a>00557 <span class="preprocessor"></span><span class="preprocessor">#               # set default problem value here</span>
<a name="l00558"></a>00558 <span class="preprocessor"></span><span class="preprocessor">#               # FIXME?? set defaults here?</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span><span class="preprocessor">#               $probValue = 1 unless defined($probValue) and </span>
<a name="l00560"></a>00560 <span class="preprocessor"></span><span class="preprocessor">#                   $probValue ne &quot;&quot;;  </span>
<a name="l00561"></a>00561 <span class="preprocessor"></span><span class="preprocessor">#           </span>
<a name="l00562"></a>00562 <span class="preprocessor"></span><span class="preprocessor">#               my $status  = $problemRecord-&gt;status || 0;</span>
<a name="l00563"></a>00563 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00564"></a>00564 <span class="preprocessor"></span><span class="preprocessor">#               # sanity check that the status (score) is </span>
<a name="l00565"></a>00565 <span class="preprocessor"></span><span class="preprocessor">#               # between 0 and 1</span>
<a name="l00566"></a>00566 <span class="preprocessor"></span><span class="preprocessor">#               my $valid_status = ($status&gt;=0 &amp;&amp; $status&lt;=1)?1:0;</span>
<a name="l00567"></a>00567 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00568"></a>00568 <span class="preprocessor"></span><span class="preprocessor">#               ###########################################</span>
<a name="l00569"></a>00569 <span class="preprocessor"></span><span class="preprocessor">#               # Determine the string $longStatus which </span>
<a name="l00570"></a>00570 <span class="preprocessor"></span><span class="preprocessor">#               # will display the student&#39;s current score</span>
<a name="l00571"></a>00571 <span class="preprocessor"></span><span class="preprocessor">#               ###########################################</span>
<a name="l00572"></a>00572 <span class="preprocessor"></span><span class="preprocessor">#               my $longStatus = &#39;&#39;;</span>
<a name="l00573"></a>00573 <span class="preprocessor"></span><span class="preprocessor">#               if (!$attempted){</span>
<a name="l00574"></a>00574 <span class="preprocessor"></span><span class="preprocessor">#                   $longStatus     = &#39;.&#39;;</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span><span class="preprocessor">#               } elsif   ($valid_status) {</span>
<a name="l00576"></a>00576 <span class="preprocessor"></span><span class="preprocessor">#                   $longStatus     = int(100*$status+.5);</span>
<a name="l00577"></a>00577 <span class="preprocessor"></span><span class="preprocessor">#                   $longStatus=&#39;C&#39; if ($longStatus==100);</span>
<a name="l00578"></a>00578 <span class="preprocessor"></span><span class="preprocessor">#               } else  {</span>
<a name="l00579"></a>00579 <span class="preprocessor"></span><span class="preprocessor">#                   $longStatus     = &#39;X&#39;;</span>
<a name="l00580"></a>00580 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l00581"></a>00581 <span class="preprocessor"></span><span class="preprocessor">#           </span>
<a name="l00582"></a>00582 <span class="preprocessor"></span><span class="preprocessor">#               $string     .= threeSpaceFill($longStatus);</span>
<a name="l00583"></a>00583 <span class="preprocessor"></span><span class="preprocessor">#               $twoString  .= threeSpaceFill($num_incorrect);</span>
<a name="l00584"></a>00584 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00585"></a>00585 <span class="preprocessor"></span><span class="preprocessor">#               $total      += $probValue;</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span><span class="preprocessor">#               $totalRight += round_score($status*$probValue) </span>
<a name="l00587"></a>00587 <span class="preprocessor"></span><span class="preprocessor">#                   if $valid_status;</span>
<a name="l00588"></a>00588 <span class="preprocessor"></span><span class="preprocessor">#           </span>
<a name="l00589"></a>00589 <span class="preprocessor"></span><span class="preprocessor">#               # add on the scores for this problem</span>
<a name="l00590"></a>00590 <span class="preprocessor"></span><span class="preprocessor">#               if (defined($attempted) and $attempted) {</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span><span class="preprocessor">#                   $number_of_students_attempting_problem{$probID}++;</span>
<a name="l00592"></a>00592 <span class="preprocessor"></span><span class="preprocessor">#                   push( @{ $attempts_list_for_problem{$probID} } ,     $num_of_attempts);</span>
<a name="l00593"></a>00593 <span class="preprocessor"></span><span class="preprocessor">#                   $number_of_attempts_for_problem{$probID}             += $num_of_attempts;</span>
<a name="l00594"></a>00594 <span class="preprocessor"></span><span class="preprocessor">#                   $h_problemData{$probID}                               = $num_incorrect;</span>
<a name="l00595"></a>00595 <span class="preprocessor"></span><span class="preprocessor">#                   $total_num_of_attempts_for_set                       += $num_of_attempts;</span>
<a name="l00596"></a>00596 <span class="preprocessor"></span><span class="preprocessor">#                   $correct_answers_for_problem{$probID}                += $status;</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span><span class="preprocessor">#               }</span>
<a name="l00598"></a>00598 <span class="preprocessor"></span><span class="preprocessor">#           </span>
<a name="l00599"></a>00599 <span class="preprocessor"></span><span class="preprocessor">#           }  # end of problem record loop</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span>            
<a name="l00601"></a>00601             
<a name="l00602"></a>00602 <span class="preprocessor">            # for versioned tests we might be displaying the </span>
<a name="l00603"></a>00603 <span class="preprocessor"></span><span class="preprocessor">            # test date and test time</span>
<a name="l00604"></a>00604 <span class="preprocessor"></span>            my $dateOfTest = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00605"></a>00605             my $testTime = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00606"></a>00606             <span class="keywordflow">if</span> ( $setIsVersioned ) {
<a name="l00607"></a>00607 <span class="preprocessor">                # if this isn&#39;t defined, something&#39;s wrong</span>
<a name="l00608"></a>00608 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( defined($userSet) ) {  
<a name="l00609"></a>00609                     $dateOfTest = localtime($userSet-&gt;version_creation_time());
<a name="l00610"></a>00610                     <span class="keywordflow">if</span> ( defined($userSet-&gt;version_last_attempt_time()) &amp;&amp; $userSet-&gt;version_last_attempt_time() ) {
<a name="l00611"></a>00611                         $testTime = ($userSet-&gt;version_last_attempt_time() - $userSet-&gt;open_date() ) / 60; 
<a name="l00612"></a>00612                         my $timeLimit = $userSet-&gt;version_time_limit()/60;
<a name="l00613"></a>00613                         $testTime = $timeLimit <span class="keywordflow">if</span> ( $testTime &gt; $timeLimit );
<a name="l00614"></a>00614                         $testTime = sprintf(<span class="stringliteral">&quot;%3.1f min&quot;</span>, $testTime);
<a name="l00615"></a>00615                     } elsif ( time() - $userSet-&gt;open_date() &lt; $userSet-&gt;version_time_limit() ) {
<a name="l00616"></a>00616                         $testTime = <span class="stringliteral">&#39;still open&#39;</span>;
<a name="l00617"></a>00617                     } <span class="keywordflow">else</span> {
<a name="l00618"></a>00618                         $testTime = <span class="stringliteral">&#39;time limit &#39;</span> .
<a name="l00619"></a>00619                             <span class="stringliteral">&#39;exceeded&#39;</span>;
<a name="l00620"></a>00620                     }
<a name="l00621"></a>00621                 } <span class="keywordflow">else</span> {
<a name="l00622"></a>00622                     $dateOfTest = <span class="stringliteral">&#39;???&#39;</span>;
<a name="l00623"></a>00623                     $testTime = <span class="stringliteral">&#39;???&#39;</span>;
<a name="l00624"></a>00624                 }
<a name="l00625"></a>00625             }
<a name="l00626"></a>00626         
<a name="l00627"></a>00627         
<a name="l00628"></a>00628             $act_as_student_url = $self-&gt;systemLink($urlpath-&gt;new(type=&gt;<span class="stringliteral">&#39;set_list&#39;</span>,args=&gt;{courseID=&gt;$courseName}), params=&gt;{effectiveUser =&gt; $studentRecord-&gt;user_id});
<a name="l00629"></a>00629             my $email              = $studentRecord-&gt;email_address;
<a name="l00630"></a>00630 <span class="preprocessor">            # FIXME  this needs formatting</span>
<a name="l00631"></a>00631 <span class="preprocessor"></span>
<a name="l00632"></a>00632 <span class="preprocessor">            # change to give better output for gateways with; </span>
<a name="l00633"></a>00633 <span class="preprocessor"></span><span class="preprocessor">            # only one attempt per version: just reports the </span>
<a name="l00634"></a>00634 <span class="preprocessor"></span><span class="preprocessor">            # result for each problem, not the number of attempts.</span>
<a name="l00635"></a>00635 <span class="preprocessor"></span>            my $longtwo = ($setIsVersioned &amp;&amp; 
<a name="l00636"></a>00636                        $userSet-&gt;attempts_per_version == 1) ? 
<a name="l00637"></a>00637                        $string : <span class="stringliteral">&quot;$string\n$twoString&quot;</span>;
<a name="l00638"></a>00638         
<a name="l00639"></a>00639             my $avg_num_attempts = ($num_of_problems) ? $total_num_of_attempts_for_set/$num_of_problems : 0;
<a name="l00640"></a>00640             my $successIndicator = ($avg_num_attempts &amp;&amp; $total) ? ($totalRight/$total)**2/$avg_num_attempts : 0 ;
<a name="l00641"></a>00641         
<a name="l00642"></a>00642             my $temp_hash         = { user_id        =&gt; $studentRecord-&gt;user_id,
<a name="l00643"></a>00643                                           last_name      =&gt; $studentRecord-&gt;last_name,
<a name="l00644"></a>00644                                           first_name     =&gt; $studentRecord-&gt;first_name,
<a name="l00645"></a>00645                                           score          =&gt; $totalRight,
<a name="l00646"></a>00646                                           total          =&gt; $total,
<a name="l00647"></a>00647                                           index          =&gt; $successIndicator,
<a name="l00648"></a>00648                                           section        =&gt; $studentRecord-&gt;section,
<a name="l00649"></a>00649                                           recitation     =&gt; $studentRecord-&gt;recitation,
<a name="l00650"></a>00650                                           problemString  =&gt; <span class="stringliteral">&quot;&lt;pre&gt;$longtwo&lt;/pre&gt;&quot;</span>,
<a name="l00651"></a>00651                                           act_as_student =&gt; $act_as_student_url,
<a name="l00652"></a>00652                                           email_address  =&gt; $studentRecord-&gt;email_address,
<a name="l00653"></a>00653                                           problemData    =&gt; {%h_problemData},
<a name="l00654"></a>00654                           date           =&gt; $dateOfTest,
<a name="l00655"></a>00655                           testtime       =&gt; $testTime,
<a name="l00656"></a>00656                           }; 
<a name="l00657"></a>00657             
<a name="l00658"></a>00658 <span class="preprocessor">            # keep track of best score</span>
<a name="l00659"></a>00659 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $totalRight &gt; $maxScore ) {
<a name="l00660"></a>00660                 $maxScore = $totalRight;
<a name="l00661"></a>00661                 $max_hash = { %$temp_hash };
<a name="l00662"></a>00662             }
<a name="l00663"></a>00663 
<a name="l00664"></a>00664 <span class="preprocessor">            # if we&#39;re showing all records, add it in to the list</span>
<a name="l00665"></a>00665 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( ! $showBestOnly ) {
<a name="l00666"></a>00666 <span class="preprocessor">                # add this data to the list of total scores (out of 100)</span>
<a name="l00667"></a>00667 <span class="preprocessor"></span><span class="preprocessor">                # add this data to the list of success indices.</span>
<a name="l00668"></a>00668 <span class="preprocessor"></span>                push( @index_list, $temp_hash-&gt;{index});
<a name="l00669"></a>00669                 push( @score_list, ($temp_hash-&gt;{total}) ?$temp_hash-&gt;{score}/$temp_hash-&gt;{total} : 0 ) ;
<a name="l00670"></a>00670                 push( @augmentedUserRecords, $temp_hash );
<a name="l00671"></a>00671             }
<a name="l00672"></a>00672 
<a name="l00673"></a>00673         } # <span class="keyword">this</span> closes the loop through all <span class="keyword">set</span> versions
<a name="l00674"></a>00674 
<a name="l00675"></a>00675 <span class="preprocessor">        # if we&#39;re showing only the best score, add the best score now</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $showBestOnly ) {
<a name="l00677"></a>00677 <span class="preprocessor">            # if there&#39;s no %$max_hash, then we had no results</span>
<a name="l00678"></a>00678 <span class="preprocessor"></span><span class="preprocessor">            #    this occurs for proctors, for example</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $notAssignedSet ) {
<a name="l00680"></a>00680                 next;
<a name="l00681"></a>00681             } elsif ( ! %$max_hash ) {
<a name="l00682"></a>00682                 $max_hash = { 
<a name="l00683"></a>00683                     user_id =&gt; $studentRecord-&gt;user_id(),
<a name="l00684"></a>00684                     last_name=&gt;$studentRecord-&gt;last_name(),
<a name="l00685"></a>00685                     first_name=&gt;$studentRecord-&gt;first_name(),
<a name="l00686"></a>00686                     score =&gt; 0,
<a name="l00687"></a>00687                     total =&gt; <span class="stringliteral">&#39;n/a&#39;</span>,
<a name="l00688"></a>00688                     index =&gt; 0,
<a name="l00689"></a>00689                     section =&gt; $studentRecord-&gt;section(),
<a name="l00690"></a>00690                     recitation=&gt;$studentRecord-&gt;recitation(),
<a name="l00691"></a>00691                     problemString =&gt; <span class="stringliteral">&#39;no attempt recorded&#39;</span>,
<a name="l00692"></a>00692                     act_as_student =&gt; $self-&gt;systemLink($urlpath-&gt;new(type=&gt;<span class="stringliteral">&#39;set_list&#39;</span>,args=&gt;{courseID=&gt;$courseName}), params=&gt;{effectiveUser =&gt; $studentRecord-&gt;user_id}),
<a name="l00693"></a>00693                     email_address =&gt; $studentRecord-&gt;email_address(),
<a name="l00694"></a>00694                     problemData =&gt; {},
<a name="l00695"></a>00695                     date =&gt; <span class="stringliteral">&#39;none&#39;</span>,
<a name="l00696"></a>00696                     testtime =&gt; <span class="stringliteral">&#39;none&#39;</span>,
<a name="l00697"></a>00697                 };
<a name="l00698"></a>00698             }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700             push( @index_list, $max_hash-&gt;{index} );
<a name="l00701"></a>00701             push( @score_list, 
<a name="l00702"></a>00702                   ($max_hash-&gt;{total} &amp;&amp; $max_hash-&gt;{total} ne <span class="stringliteral">&#39;n/a&#39;</span>) ? 
<a name="l00703"></a>00703                   $max_hash-&gt;{score}/$max_hash-&gt;{total} : 0 );
<a name="l00704"></a>00704             push( @augmentedUserRecords, $max_hash );
<a name="l00705"></a>00705 <span class="preprocessor">        # if there were no set versions and the set was assigned</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span><span class="preprocessor">        #    to the user, also keep the data</span>
<a name="l00707"></a>00707 <span class="preprocessor"></span>        } elsif ( ! @allSetVersionNames &amp;&amp; ! $notAssignedSet ) {
<a name="l00708"></a>00708             my $dataH = { user_id =&gt; $studentRecord-&gt;user_id(),
<a name="l00709"></a>00709                       last_name=&gt;$studentRecord-&gt;last_name(),
<a name="l00710"></a>00710                       first_name=&gt;$studentRecord-&gt;first_name(),
<a name="l00711"></a>00711                       score =&gt; 0,
<a name="l00712"></a>00712                       total =&gt; <span class="stringliteral">&#39;n/a&#39;</span>,
<a name="l00713"></a>00713                       index =&gt; 0,
<a name="l00714"></a>00714                       section =&gt; $studentRecord-&gt;section(),
<a name="l00715"></a>00715                       recitation=&gt;$studentRecord-&gt;recitation(),
<a name="l00716"></a>00716                       problemString =&gt; <span class="stringliteral">&#39;no attempt recorded&#39;</span>,
<a name="l00717"></a>00717                       act_as_student =&gt; $self-&gt;systemLink($urlpath-&gt;new(type=&gt;<span class="stringliteral">&#39;set_list&#39;</span>,args=&gt;{courseID=&gt;$courseName}), params=&gt;{effectiveUser =&gt; $studentRecord-&gt;user_id}),
<a name="l00718"></a>00718                       email_address =&gt; $studentRecord-&gt;email_address(),
<a name="l00719"></a>00719                       problemData =&gt; {},
<a name="l00720"></a>00720                       date =&gt; <span class="stringliteral">&#39;none&#39;</span>,
<a name="l00721"></a>00721                       testtime =&gt; <span class="stringliteral">&#39;none&#39;</span>,
<a name="l00722"></a>00722                   };
<a name="l00723"></a>00723             push( @index_list, 0 );
<a name="l00724"></a>00724             push( @score_list, 0 );
<a name="l00725"></a>00725             push( @augmentedUserRecords, $dataH );
<a name="l00726"></a>00726 
<a name="l00727"></a>00727         }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729         } # <span class="keyword">this</span> closes the loop through all student records
<a name="l00730"></a>00730     
<a name="l00731"></a>00731     debug(<span class="stringliteral">&quot;end mainloop&quot;</span>);
<a name="l00732"></a>00732     
<a name="l00733"></a>00733     @augmentedUserRecords = sort {
<a name="l00734"></a>00734         &amp;$sort_method($a,$b,$primary_sort_method_name)
<a name="l00735"></a>00735             ||
<a name="l00736"></a>00736         &amp;$sort_method($a,$b,$secondary_sort_method_name)
<a name="l00737"></a>00737             ||
<a name="l00738"></a>00738         &amp;$sort_method($a,$b,$ternary_sort_method_name)
<a name="l00739"></a>00739             ||          
<a name="l00740"></a>00740         lc($a-&gt;{last_name}) cmp lc($b-&gt;{last_name})
<a name="l00741"></a>00741             ||
<a name="l00742"></a>00742         lc($a-&gt;{first_name}) cmp lc($b-&gt;{first_name})
<a name="l00743"></a>00743             ||
<a name="l00744"></a>00744         lc($a-&gt;{user_id}) cmp lc($b-&gt;{user_id}) 
<a name="l00745"></a>00745         } 
<a name="l00746"></a>00746         @augmentedUserRecords;
<a name="l00747"></a>00747     
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 <span class="preprocessor">    # construct header</span>
<a name="l00750"></a>00750 <span class="preprocessor"></span>    my $problem_header = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00751"></a>00751 <span class="preprocessor">    # DBFIXME sort in database</span>
<a name="l00752"></a>00752 <span class="preprocessor"></span>    my @list_problems = sort {$a&lt;=&gt; $b } $db-&gt;listGlobalProblems($setName );
<a name="l00753"></a>00753     $problem_header = <span class="stringliteral">&#39;&lt;pre&gt;&#39;</span>.join(<span class="stringliteral">&quot;&quot;</span>, map {&amp;threeSpaceFill($_)}  @list_problems  ).<span class="stringliteral">&#39;&lt;/pre&gt;&#39;</span>;
<a name="l00754"></a>00754 
<a name="l00755"></a>00755 <span class="preprocessor"># changes for gateways/versioned sets here.  in this case we allow instructors</span>
<a name="l00756"></a>00756 <span class="preprocessor"></span><span class="preprocessor"># to modify the appearance of output, which we do with a form.  so paste in the</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span><span class="preprocessor"># form header here, and make appropriate modifications</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span>        my $verSelectors = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00759"></a>00759     <span class="keywordflow">if</span> ( $setIsVersioned ) {
<a name="l00760"></a>00760         print CGI::start_form({<span class="stringliteral">&#39;method&#39;</span> =&gt; <span class="stringliteral">&#39;post&#39;</span>, 
<a name="l00761"></a>00761                        <span class="stringliteral">&#39;action&#39;</span> =&gt; $self-&gt;systemLink($urlpath,authen=&gt;0),<span class="stringliteral">&#39;name&#39;</span> =&gt; <span class="stringliteral">&#39;StudentProgress&#39;</span>});
<a name="l00762"></a>00762         print $self-&gt;hidden_authen_fields();
<a name="l00763"></a>00763 
<a name="l00764"></a>00764 <span class="preprocessor">#       $verSelectors = CGI::p({&#39;style&#39;=&gt;&#39;background-color:#eeeeee;color:black;&#39;},</span>
<a name="l00765"></a>00765 <span class="preprocessor"></span>        print CGI::p({<span class="stringliteral">&#39;style&#39;</span>=&gt;<span class="stringliteral">&#39;background-color:#eeeeee;color:black;&#39;</span>},
<a name="l00766"></a>00766                  <span class="stringliteral">&quot;Display options: Show &quot;</span>,
<a name="l00767"></a>00767                  CGI::hidden(-name=&gt;<span class="stringliteral">&#39;returning&#39;</span>, -value=&gt;<span class="charliteral">&#39;1&#39;</span>),
<a name="l00768"></a>00768                  CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;show_best_only&#39;</span>, -value=&gt;<span class="charliteral">&#39;1&#39;</span>, 
<a name="l00769"></a>00769                        -checked=&gt;$showBestOnly, 
<a name="l00770"></a>00770                        -label=&gt;<span class="stringliteral">&#39; only best scores; &#39;</span>),
<a name="l00771"></a>00771 <span class="preprocessor">#                CGI::checkbox(-name=&gt;&#39;show_index&#39;, -value=&gt;&#39;1&#39;, </span>
<a name="l00772"></a>00772 <span class="preprocessor"></span><span class="preprocessor">#                      -checked=&gt;$showColumns{&#39;index&#39;},</span>
<a name="l00773"></a>00773 <span class="preprocessor"></span><span class="preprocessor">#                      -label=&gt;&#39; success indicator; &#39;),</span>
<a name="l00774"></a>00774 <span class="preprocessor"></span>                 CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;show_date&#39;</span>, -value=&gt;<span class="charliteral">&#39;1&#39;</span>, 
<a name="l00775"></a>00775                        -checked=&gt;$showColumns{<span class="stringliteral">&#39;date&#39;</span>},
<a name="l00776"></a>00776                        -label=&gt;<span class="stringliteral">&#39; test date; &#39;</span>),
<a name="l00777"></a>00777                  CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;show_testtime&#39;</span>, -value=&gt;<span class="charliteral">&#39;1&#39;</span>, 
<a name="l00778"></a>00778                        -checked=&gt;$showColumns{<span class="stringliteral">&#39;testtime&#39;</span>},
<a name="l00779"></a>00779                        -label=&gt;<span class="stringliteral">&#39; test time; &#39;</span>),
<a name="l00780"></a>00780                  CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;show_problems&#39;</span>, -value=&gt;<span class="charliteral">&#39;1&#39;</span>, 
<a name="l00781"></a>00781                        -checked=&gt;$showColumns{<span class="stringliteral">&#39;problems&#39;</span>},
<a name="l00782"></a>00782                        -label=&gt;<span class="stringliteral">&#39;problems;&#39;</span>), <span class="stringliteral">&quot;\n&quot;</span>, CGI::br(), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00783"></a>00783                  CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;show_section&#39;</span>, -value=&gt;<span class="charliteral">&#39;1&#39;</span>, 
<a name="l00784"></a>00784                        -checked=&gt;$showColumns{<span class="stringliteral">&#39;section&#39;</span>}, 
<a name="l00785"></a>00785                        -label=&gt;<span class="stringliteral">&#39; section #; &#39;</span>),
<a name="l00786"></a>00786                  CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;show_recitation&#39;</span>, -value=&gt;<span class="charliteral">&#39;1&#39;</span>, 
<a name="l00787"></a>00787                        -checked=&gt;$showColumns{<span class="stringliteral">&#39;recit&#39;</span>},
<a name="l00788"></a>00788                        -label=&gt;<span class="stringliteral">&#39; recitation #; &#39;</span>),
<a name="l00789"></a>00789                  CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;show_login&#39;</span>, -value=&gt;<span class="charliteral">&#39;1&#39;</span>, 
<a name="l00790"></a>00790                        -checked=&gt;$showColumns{<span class="stringliteral">&#39;login&#39;</span>}, 
<a name="l00791"></a>00791                        -label=&gt;<span class="stringliteral">&#39;login&#39;</span>), <span class="stringliteral">&quot;\n&quot;</span>, CGI::br(), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l00792"></a>00792                  CGI::submit(-value=&gt;<span class="stringliteral">&#39;Update Display&#39;</span>),
<a name="l00793"></a>00793                  );
<a name="l00794"></a>00794         print CGI::end_form();
<a name="l00795"></a>00795     }
<a name="l00796"></a>00796 
<a name="l00797"></a>00797 <span class="preprocessor">#####################################################################################</span>
<a name="l00798"></a>00798 <span class="preprocessor"></span>    print
<a name="l00799"></a>00799 <span class="preprocessor">#       CGI::br(),</span>
<a name="l00800"></a>00800 <span class="preprocessor"></span>        CGI::br(),
<a name="l00801"></a>00801         CGI::p({},<span class="stringliteral">&#39;A period (.) indicates a problem has not been attempted, a &amp;quot;C&amp;quot; indicates </span>
<a name="l00802"></a>00802 <span class="stringliteral">        a problem has been answered 100% correctly, and a number from 0 to 99 </span>
<a name="l00803"></a>00803 <span class="stringliteral">        indicates the percentage of partial credit earned. The number on the </span>
<a name="l00804"></a>00804 <span class="stringliteral">        second line gives the number of incorrect attempts.  &#39;</span>,
<a name="l00805"></a>00805 <span class="preprocessor">#       &#39;The success indicator,&#39; ,CGI::i(&#39;Ind&#39;),&#39;, for each student is calculated as&#39;,</span>
<a name="l00806"></a>00806 <span class="preprocessor"></span><span class="preprocessor">#       CGI::br(),</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span><span class="preprocessor">#       &#39;100*(totalNumberOfCorrectProblems / totalNumberOfProblems)^2 / (AvgNumberOfAttemptsPerProblem)&#39;,CGI::br(),</span>
<a name="l00808"></a>00808 <span class="preprocessor"></span><span class="preprocessor">#       &#39;or 0 if there are no attempts.&#39;</span>
<a name="l00809"></a>00809 <span class="preprocessor"></span>        ),
<a name="l00810"></a>00810         CGI::br(),
<a name="l00811"></a>00811         <span class="stringliteral">&quot;Click on student&#39;s name to see the student&#39;s version of the homework set. &amp;nbsp; &amp;nbsp;&amp;nbsp;</span>
<a name="l00812"></a>00812 <span class="stringliteral">        Click heading to sort table. &quot;</span>,
<a name="l00813"></a>00813         CGI::br(),
<a name="l00814"></a>00814         CGI::br(),
<a name="l00815"></a>00815         defined($primary_sort_method_name) ?<span class="stringliteral">&quot; Entries are sorted by $display_sort_method_name{$primary_sort_method_name}&quot;</span>:<span class="stringliteral">&#39;&#39;</span>,
<a name="l00816"></a>00816         defined($secondary_sort_method_name) ?<span class="stringliteral">&quot;, then by $display_sort_method_name{$secondary_sort_method_name}&quot;</span>:<span class="stringliteral">&#39;&#39;</span>,
<a name="l00817"></a>00817         defined($ternary_sort_method_name) ?<span class="stringliteral">&quot;, then by $display_sort_method_name{$ternary_sort_method_name}&quot;</span>:<span class="stringliteral">&#39;&#39;</span>,
<a name="l00818"></a>00818         defined($primary_sort_method_name) ?<span class="charliteral">&#39;.&#39;</span>:<span class="stringliteral">&#39;&#39;</span>,
<a name="l00819"></a>00819     ;
<a name="l00820"></a>00820 <span class="preprocessor">    # calculate secondary and ternary sort methods parameters if appropriate</span>
<a name="l00821"></a>00821 <span class="preprocessor"></span>    my %past_sort_methods = ();     
<a name="l00822"></a>00822     %past_sort_methods = (secondary_sort =&gt; <span class="stringliteral">&quot;$primary_sort_method_name&quot;</span>,) <span class="keywordflow">if</span> defined($primary_sort_method_name);
<a name="l00823"></a>00823     %past_sort_methods = (%past_sort_methods, ternary_sort =&gt; <span class="stringliteral">&quot;$secondary_sort_method_name&quot;</span>,) <span class="keywordflow">if</span> defined($secondary_sort_method_name);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825 <span class="preprocessor">    # continue with table output</span>
<a name="l00826"></a>00826 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! $setIsVersioned ) {
<a name="l00827"></a>00827         print
<a name="l00828"></a>00828         CGI::start_table({-border=&gt;5,style=&gt;<span class="stringliteral">&#39;font-size:smaller&#39;</span>}),
<a name="l00829"></a>00829         CGI::Tr(CGI::td(  {-align=&gt;<span class="stringliteral">&#39;left&#39;</span>},
<a name="l00830"></a>00830             [<span class="stringliteral">&#39;Name&#39;</span>.CGI::br().CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;first_name&#39;</span>, %past_sort_methods})},<span class="stringliteral">&#39;First&#39;</span>).
<a name="l00831"></a>00831                <span class="stringliteral">&#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</span>.CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;last_name&#39;</span>, %past_sort_methods })},<span class="stringliteral">&#39;Last&#39;</span>).CGI::br().
<a name="l00832"></a>00832                CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;email_address&#39;</span>, %past_sort_methods })},<span class="stringliteral">&#39;Email&#39;</span>),
<a name="l00833"></a>00833             CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;score&#39;</span>, %past_sort_methods})},<span class="stringliteral">&#39;Score&#39;</span>),
<a name="l00834"></a>00834             <span class="stringliteral">&#39;Out&#39;</span>.CGI::br().<span class="stringliteral">&#39;Of&#39;</span>,
<a name="l00835"></a>00835 <span class="preprocessor">#           CGI::a({&quot;href&quot;=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;&#39;index&#39;, %past_sort_methods})},&#39;Ind&#39;),</span>
<a name="l00836"></a>00836 <span class="preprocessor"></span>            <span class="stringliteral">&#39;Problems&#39;</span>.CGI::br().$problem_header,
<a name="l00837"></a>00837             CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;section&#39;</span>, %past_sort_methods})},<span class="stringliteral">&#39;Section&#39;</span>),
<a name="l00838"></a>00838             CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;recitation&#39;</span>, %past_sort_methods})},<span class="stringliteral">&#39;Recitation&#39;</span>),
<a name="l00839"></a>00839             CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;user_id&#39;</span>, %past_sort_methods})},<span class="stringliteral">&#39;Login Name&#39;</span>),
<a name="l00840"></a>00840             ])
<a name="l00841"></a>00841 
<a name="l00842"></a>00842         ),
<a name="l00843"></a>00843         ;
<a name="l00844"></a>00844     } <span class="keywordflow">else</span> {
<a name="l00845"></a>00845 <span class="preprocessor">        # we need to preserve display options when the sort headers are clicked</span>
<a name="l00846"></a>00846 <span class="preprocessor"></span>        my %display_options = (
<a name="l00847"></a>00847             returning       =&gt; 1,
<a name="l00848"></a>00848             show_best_only  =&gt; $showBestOnly,
<a name="l00849"></a>00849 <span class="preprocessor">#           show_index      =&gt; $showColumns{index},</span>
<a name="l00850"></a>00850 <span class="preprocessor"></span>            show_date       =&gt; $showColumns{date},
<a name="l00851"></a>00851             show_testtime   =&gt; $showColumns{testtime},
<a name="l00852"></a>00852             show_problems   =&gt; $showColumns{problems},
<a name="l00853"></a>00853             show_section    =&gt; $showColumns{section},
<a name="l00854"></a>00854             show_recitation =&gt; $showColumns{recit},
<a name="l00855"></a>00855             show_login      =&gt; $showColumns{login},
<a name="l00856"></a>00856         );
<a name="l00857"></a>00857         my %params = (%past_sort_methods, %display_options);
<a name="l00858"></a>00858         my @columnHdrs = ();
<a name="l00859"></a>00859         push( @columnHdrs, <span class="stringliteral">&#39;Name&#39;</span>.CGI::br().CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;first_name&#39;</span>, %params})},<span class="stringliteral">&#39;First&#39;</span>).
<a name="l00860"></a>00860           <span class="stringliteral">&#39;&amp;nbsp;&amp;nbsp;&amp;nbsp;&#39;</span>.CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;last_name&#39;</span>, %params })},<span class="stringliteral">&#39;Last&#39;</span>) );
<a name="l00861"></a>00861         push( @columnHdrs, CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;score&#39;</span>, %params})},<span class="stringliteral">&#39;Score&#39;</span>) );
<a name="l00862"></a>00862         push( @columnHdrs, <span class="stringliteral">&#39;Out&#39;</span>.CGI::br().<span class="stringliteral">&#39;Of&#39;</span> );
<a name="l00863"></a>00863         push( @columnHdrs, <span class="stringliteral">&#39;Date&#39;</span> ) if ( $showColumns{ <span class="stringliteral">&#39;date&#39;</span> } );
<a name="l00864"></a>00864         push( @columnHdrs, <span class="stringliteral">&#39;TestTime&#39;</span> ) if ( $showColumns{ <span class="stringliteral">&#39;testtime&#39;</span> } );
<a name="l00865"></a>00865 <span class="preprocessor">#       push( @columnHdrs, CGI::a({&quot;href&quot;=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;&#39;index&#39;, %params})},&#39;Ind&#39;) )</span>
<a name="l00866"></a>00866 <span class="preprocessor"></span><span class="preprocessor">#       if ( $showColumns{ &#39;index&#39; } );</span>
<a name="l00867"></a>00867 <span class="preprocessor"></span>        push( @columnHdrs, <span class="stringliteral">&#39;Problems&#39;</span>.CGI::br().$problem_header )
<a name="l00868"></a>00868         if ( $showColumns{ <span class="stringliteral">&#39;problems&#39;</span> } );
<a name="l00869"></a>00869         push( @columnHdrs, CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;section&#39;</span>, %params})},<span class="stringliteral">&#39;Section&#39;</span>) )
<a name="l00870"></a>00870         <span class="keywordflow">if</span> ( $showColumns{ <span class="stringliteral">&#39;section&#39;</span> } );
<a name="l00871"></a>00871         push( @columnHdrs, CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;recitation&#39;</span>, %params})},<span class="stringliteral">&#39;Recitation&#39;</span>) )
<a name="l00872"></a>00872         <span class="keywordflow">if</span> ( $showColumns{ <span class="stringliteral">&#39;recit&#39;</span> } );
<a name="l00873"></a>00873         push( @columnHdrs, CGI::a({<span class="stringliteral">&quot;href&quot;</span>=&gt;$self-&gt;systemLink($setStatsPage,params=&gt;{primary_sort=&gt;<span class="stringliteral">&#39;user_id&#39;</span>, %params})},<span class="stringliteral">&#39;Login Name&#39;</span>) )
<a name="l00874"></a>00874         <span class="keywordflow">if</span> ( $showColumns{ <span class="stringliteral">&#39;login&#39;</span> } );
<a name="l00875"></a>00875 
<a name="l00876"></a>00876         print CGI::start_table({-border=&gt;5,style=&gt;<span class="stringliteral">&#39;font-size:smaller&#39;</span>}),
<a name="l00877"></a>00877             CGI::Tr(CGI::td(  {-align=&gt;<span class="stringliteral">&#39;left&#39;</span>},
<a name="l00878"></a>00878             [ @columnHdrs ] ) ),
<a name="l00879"></a>00879         ;
<a name="l00880"></a>00880     }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="preprocessor">    # variables to keep track of versioned sets</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span>    my $prevFullName = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00884"></a>00884     my $vNum = 1;
<a name="l00885"></a>00885 <span class="preprocessor">    # and to make formatting nice for students who haven&#39;t taken any tests</span>
<a name="l00886"></a>00886 <span class="preprocessor"></span><span class="preprocessor">    #    (the total number of columns is two more than this; we want the </span>
<a name="l00887"></a>00887 <span class="preprocessor"></span><span class="preprocessor">    #    number that missing record information should span)</span>
<a name="l00888"></a>00888 <span class="preprocessor"></span>    my $numCol = 1 + $showColumns{<span class="stringliteral">&#39;date&#39;</span>} + $showColumns{<span class="stringliteral">&#39;testtime&#39;</span>} + 
<a name="l00889"></a>00889 <span class="preprocessor">#       $showColumns{&#39;index&#39;} +</span>
<a name="l00890"></a>00890 <span class="preprocessor"></span>        $showColumns{<span class="stringliteral">&#39;problems&#39;</span>};
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     <span class="keywordflow">foreach</span> my $rec (@augmentedUserRecords) {
<a name="l00893"></a>00893         my $fullName = join(<span class="stringliteral">&quot;&quot;</span>, $rec-&gt;{first_name},<span class="stringliteral">&quot; &quot;</span>, $rec-&gt;{last_name});
<a name="l00894"></a>00894         my $email    = $rec-&gt;{email_address}; 
<a name="l00895"></a>00895         my $twoString  = $rec-&gt;{twoString};
<a name="l00896"></a>00896         <span class="keywordflow">if</span> ( ! $setIsVersioned ) {
<a name="l00897"></a>00897             print CGI::Tr({},
<a name="l00898"></a>00898             CGI::td({},CGI::a({-href=&gt;$rec-&gt;{act_as_student}},$fullName), CGI::br(), CGI::a({-href=&gt;<span class="stringliteral">&quot;mailto:$email&quot;</span>},$email)),
<a name="l00899"></a>00899             CGI::td( sprintf(<span class="stringliteral">&quot;%0.2f&quot;</span>,$rec-&gt;{score}) ), # score
<a name="l00900"></a>00900             CGI::td($rec-&gt;{total}), # out of 
<a name="l00901"></a>00901 #           CGI::td(sprintf(<span class="stringliteral">&quot;%0.0f&quot;</span>,100*($rec-&gt;{index}) )),   # indicator
<a name="l00902"></a>00902             CGI::td($rec-&gt;{problemString}), # problems
<a name="l00903"></a>00903             CGI::td($self-&gt;nbsp($rec-&gt;{section})),
<a name="l00904"></a>00904             CGI::td($self-&gt;nbsp($rec-&gt;{recitation})),
<a name="l00905"></a>00905             CGI::td($rec-&gt;{user_id}),           
<a name="l00906"></a>00906             );
<a name="l00907"></a>00907         } <span class="keywordflow">else</span> {
<a name="l00908"></a>00908 <span class="preprocessor">            # we separate versioned sets so that we can restrict what columns</span>
<a name="l00909"></a>00909 <span class="preprocessor"></span><span class="preprocessor">            # we show</span>
<a name="l00910"></a>00910 <span class="preprocessor"></span><span class="preprocessor">            # if total is &#39;n/a&#39;, then it&#39;s a user who hasn&#39;t taken</span>
<a name="l00911"></a>00911 <span class="preprocessor"></span><span class="preprocessor">            #    any tests, which we treat separately</span>
<a name="l00912"></a>00912 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $rec-&gt;{total} ne <span class="stringliteral">&#39;n/a&#39;</span> ) {
<a name="l00913"></a>00913                 my @cols = ();
<a name="l00914"></a>00914 <span class="preprocessor">                # make make versioned sets&#39; name format nicer</span>
<a name="l00915"></a>00915 <span class="preprocessor"></span>                my $nameEntry = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00916"></a>00916                 <span class="keywordflow">if</span> ( $fullName eq $prevFullName ) {
<a name="l00917"></a>00917                     $vNum++;
<a name="l00918"></a>00918                     $nameEntry = <span class="stringliteral">&quot;(v$vNum)&quot;</span>;
<a name="l00919"></a>00919                 } <span class="keywordflow">else</span> {
<a name="l00920"></a>00920                     $nameEntry = CGI::a({-href=&gt;$rec-&gt;{act_as_student}},$fullName) . 
<a name="l00921"></a>00921                         ($setIsVersioned &amp;&amp; ! $showBestOnly ? <span class="stringliteral">&#39; (v1)&#39;</span>:<span class="charliteral">&#39; &#39;</span>) .
<a name="l00922"></a>00922                         CGI::br() . CGI::a({-href=&gt;<span class="stringliteral">&quot;mailto:$email&quot;</span>},$email);
<a name="l00923"></a>00923                     $vNum = 1;
<a name="l00924"></a>00924                     $prevFullName = $fullName;
<a name="l00925"></a>00925                 }
<a name="l00926"></a>00926             
<a name="l00927"></a>00927 <span class="preprocessor">                # build columns to show</span>
<a name="l00928"></a>00928 <span class="preprocessor"></span>                push(@cols, $nameEntry, 
<a name="l00929"></a>00929                      sprintf(<span class="stringliteral">&quot;%0.2f&quot;</span>,$rec-&gt;{score}),
<a name="l00930"></a>00930                      $rec-&gt;{total});
<a name="l00931"></a>00931                 push(@cols, $self-&gt;nbsp($rec-&gt;{date})) 
<a name="l00932"></a>00932                     if ($showColumns{<span class="stringliteral">&#39;date&#39;</span>});
<a name="l00933"></a>00933                 push(@cols, $self-&gt;nbsp($rec-&gt;{testtime})) 
<a name="l00934"></a>00934                     if ($showColumns{<span class="stringliteral">&#39;testtime&#39;</span>});
<a name="l00935"></a>00935 <span class="preprocessor">#               push(@cols, sprintf(&quot;%0.0f&quot;,$rec-&gt;{index})) </span>
<a name="l00936"></a>00936 <span class="preprocessor"></span><span class="preprocessor">#                   if ($showColumns{&#39;index&#39;});</span>
<a name="l00937"></a>00937 <span class="preprocessor"></span>                push(@cols, $self-&gt;nbsp($rec-&gt;{problemString}))
<a name="l00938"></a>00938                     if ($showColumns{<span class="stringliteral">&#39;problems&#39;</span>});
<a name="l00939"></a>00939                 push(@cols, $self-&gt;nbsp($rec-&gt;{section})) 
<a name="l00940"></a>00940                     if ($showColumns{<span class="stringliteral">&#39;section&#39;</span>});
<a name="l00941"></a>00941                 push(@cols, $self-&gt;nbsp($rec-&gt;{recitation})) 
<a name="l00942"></a>00942                     if ($showColumns{<span class="stringliteral">&#39;recit&#39;</span>});
<a name="l00943"></a>00943                 push(@cols, $rec-&gt;{user_id}) <span class="keywordflow">if</span> ($showColumns{<span class="stringliteral">&#39;login&#39;</span>});
<a name="l00944"></a>00944                 print CGI::Tr( CGI::td( [ @cols ] ) );
<a name="l00945"></a>00945             } <span class="keywordflow">else</span> {
<a name="l00946"></a>00946                 my @cols = ( CGI::td( $fullName ),
<a name="l00947"></a>00947                          CGI::td( $rec-&gt;{score} ),
<a name="l00948"></a>00948                          CGI::td({colspan=&gt;$numCol},
<a name="l00949"></a>00949                              CGI::em($self-&gt;nbsp(<span class="stringliteral">&quot;No tests taken.&quot;</span>))) );
<a name="l00950"></a>00950                 push(@cols, 
<a name="l00951"></a>00951                      CGI::td($self-&gt;nbsp($rec-&gt;{section})))
<a name="l00952"></a>00952                     <span class="keywordflow">if</span> ( $showColumns{<span class="stringliteral">&#39;section&#39;</span>} );
<a name="l00953"></a>00953                 push(@cols, 
<a name="l00954"></a>00954                      CGI::td($self-&gt;nbsp($rec-&gt;{recitation})))
<a name="l00955"></a>00955                     <span class="keywordflow">if</span> ( $showColumns{<span class="stringliteral">&#39;recit&#39;</span>} );
<a name="l00956"></a>00956                 push(@cols, 
<a name="l00957"></a>00957                      CGI::td($self-&gt;nbsp($rec-&gt;{user_id})))
<a name="l00958"></a>00958                     <span class="keywordflow">if</span> ( $showColumns{<span class="stringliteral">&#39;login&#39;</span>} );
<a name="l00959"></a>00959                 print CGI::Tr(@cols);
<a name="l00960"></a>00960             }
<a name="l00961"></a>00961         }
<a name="l00962"></a>00962     }
<a name="l00963"></a>00963 
<a name="l00964"></a>00964     print CGI::end_table();
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00967"></a>00967 }
<a name="l00968"></a>00968 
<a name="l00969"></a>00969 <span class="preprocessor">#############################################################</span>
<a name="l00970"></a>00970 <span class="preprocessor"></span><span class="preprocessor"># Grading utilities</span>
<a name="l00971"></a>00971 <span class="preprocessor"></span><span class="preprocessor">#############################################################</span>
<a name="l00972"></a>00972 <span class="preprocessor"></span>
<a name="l00973"></a>00973 
<a name="l00974"></a>00974 <span class="preprocessor">#           ########################################</span>
<a name="l00975"></a>00975 <span class="preprocessor"></span><span class="preprocessor">#           # Notes for factoring the calculation in this loop.</span>
<a name="l00976"></a>00976 <span class="preprocessor"></span><span class="preprocessor">#           #</span>
<a name="l00977"></a>00977 <span class="preprocessor"></span><span class="preprocessor">#           # Inputs include:</span>
<a name="l00978"></a>00978 <span class="preprocessor"></span><span class="preprocessor">#           #   @problemRecords  </span>
<a name="l00979"></a>00979 <span class="preprocessor"></span><span class="preprocessor">#           # returns</span>
<a name="l00980"></a>00980 <span class="preprocessor"></span><span class="preprocessor">#           #   $num_of_attempts</span>
<a name="l00981"></a>00981 <span class="preprocessor"></span><span class="preprocessor">#           #   $status</span>
<a name="l00982"></a>00982 <span class="preprocessor"></span><span class="preprocessor">#           # updates</span>
<a name="l00983"></a>00983 <span class="preprocessor"></span><span class="preprocessor">#           #   $number__studofents_attempting_problem{$probID}++;</span>
<a name="l00984"></a>00984 <span class="preprocessor"></span><span class="preprocessor">#           #   @{ $attempts_list_for_problem{$probID} }   </span>
<a name="l00985"></a>00985 <span class="preprocessor"></span><span class="preprocessor">#           #   $number_of_attempts_for_problem{$probID}</span>
<a name="l00986"></a>00986 <span class="preprocessor"></span><span class="preprocessor">#           #   $total_num_of_attempts_for_set</span>
<a name="l00987"></a>00987 <span class="preprocessor"></span><span class="preprocessor">#           #   $correct_answers_for_problem{$probID}   </span>
<a name="l00988"></a>00988 <span class="preprocessor"></span><span class="preprocessor">#           #    </span>
<a name="l00989"></a>00989 <span class="preprocessor"></span><span class="preprocessor">#           #   $string (formatting output)</span>
<a name="l00990"></a>00990 <span class="preprocessor"></span><span class="preprocessor">#           #   $twoString (more formatted output)</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span><span class="preprocessor">#           #   $longtwo (a combination of $string and $twostring)</span>
<a name="l00992"></a>00992 <span class="preprocessor"></span><span class="preprocessor">#           #   $total</span>
<a name="l00993"></a>00993 <span class="preprocessor"></span><span class="preprocessor">#           #   $totalRight</span>
<a name="l00994"></a>00994 <span class="preprocessor"></span><span class="preprocessor">#           ###################################</span>
<a name="l00995"></a>00995 <span class="preprocessor"></span>
<a name="l00996"></a>00996 <span class="preprocessor">###############################################################</span>
<a name="l00997"></a>00997 <span class="preprocessor"></span><span class="preprocessor"># requires = grade_set( $db, $set, $setName, $studentName, $setIsVersioned);</span>
<a name="l00998"></a>00998 <span class="preprocessor"></span><span class="preprocessor"># returns   my ($status, </span>
<a name="l00999"></a>00999 <span class="preprocessor"></span><span class="preprocessor">#            $longStatus, </span>
<a name="l01000"></a>01000 <span class="preprocessor"></span><span class="preprocessor">#            $string,</span>
<a name="l01001"></a>01001 <span class="preprocessor"></span><span class="preprocessor">#            $twoString, </span>
<a name="l01002"></a>01002 <span class="preprocessor"></span><span class="preprocessor">#            $totalRight,</span>
<a name="l01003"></a>01003 <span class="preprocessor"></span><span class="preprocessor">#            $total, </span>
<a name="l01004"></a>01004 <span class="preprocessor"></span><span class="preprocessor">#            $num_of_attempts, </span>
<a name="l01005"></a>01005 <span class="preprocessor"></span><span class="preprocessor">#            $num_of_problems) = grade_set(...);</span>
<a name="l01006"></a>01006 <span class="preprocessor"></span><span class="preprocessor">#########################</span>
<a name="l01007"></a>01007 <span class="preprocessor"></span>
<a name="l01008"></a>01008 sub grade_set {
<a name="l01009"></a>01009 
<a name="l01010"></a>01010         my ($db, $set, $setName, $studentName, $setIsVersioned,
<a name="l01011"></a>01011         $rh_number_of_students_attempting_problem,
<a name="l01012"></a>01012         $rh_attempts_list_for_problem,
<a name="l01013"></a>01013         $rh_number_of_attempts_for_problem,
<a name="l01014"></a>01014         $rh_problemData,
<a name="l01015"></a>01015         $rh_total_num_of_attempts_for_set,
<a name="l01016"></a>01016         $rh_correct_answers_for_problem
<a name="l01017"></a>01017         ) = @_;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         my $setID = $set-&gt;set_id();  #FIXME   setName and setID should be the same
<a name="l01020"></a>01020 
<a name="l01021"></a>01021         my $status = 0;
<a name="l01022"></a>01022         my $longStatus = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01023"></a>01023         my $string     = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01024"></a>01024         my $twoString  = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01025"></a>01025         my $totalRight = 0;
<a name="l01026"></a>01026         my $total      = 0;
<a name="l01027"></a>01027         my $num_of_attempts = 0;
<a name="l01028"></a>01028     
<a name="l01029"></a>01029         debug(<span class="stringliteral">&quot;Begin collecting problems for set $setName&quot;</span>);
<a name="l01030"></a>01030 <span class="preprocessor">        # DBFIXME: to collect the problem records, we have to know </span>
<a name="l01031"></a>01031 <span class="preprocessor"></span><span class="preprocessor">        #    which merge routines to call.  Should this really be an </span>
<a name="l01032"></a>01032 <span class="preprocessor"></span><span class="preprocessor">        #    issue here?  That is, shouldn&#39;t the database deal with </span>
<a name="l01033"></a>01033 <span class="preprocessor"></span><span class="preprocessor">        #    it invisibly by detecting what the problem types are?  </span>
<a name="l01034"></a>01034 <span class="preprocessor"></span><span class="preprocessor">        #    oh well.</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span>        
<a name="l01036"></a>01036         my @problemRecords = $db-&gt;getAllMergedUserProblems( $studentName, $setID );
<a name="l01037"></a>01037         my $num_of_problems  = @problemRecords || 0;
<a name="l01038"></a>01038         <span class="keywordflow">if</span> ( $setIsVersioned ) {
<a name="l01039"></a>01039             @problemRecords =  $db-&gt;getAllMergedProblemVersions( $studentName, $setID, $set-&gt;version_id );
<a name="l01040"></a>01040         }
<a name="l01041"></a>01041         
<a name="l01042"></a>01042         
<a name="l01043"></a>01043         
<a name="l01044"></a>01044         
<a name="l01045"></a>01045         
<a name="l01046"></a>01046         
<a name="l01047"></a>01047         debug(<span class="stringliteral">&quot;End collecting problems for set $setName&quot;</span>);
<a name="l01048"></a>01048 
<a name="l01049"></a>01049 <span class="preprocessor">    ####################</span>
<a name="l01050"></a>01050 <span class="preprocessor"></span><span class="preprocessor">    # Resort records</span>
<a name="l01051"></a>01051 <span class="preprocessor"></span><span class="preprocessor">    #####################</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span>        @problemRecords = sort {$a-&gt;problem_id &lt;=&gt; $b-&gt;problem_id } @problemRecords;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054 <span class="preprocessor">#           </span>
<a name="l01055"></a>01055 <span class="preprocessor"></span><span class="preprocessor">#       # for gateway/quiz assignments we have to be careful about </span>
<a name="l01056"></a>01056 <span class="preprocessor"></span><span class="preprocessor">#       #    the order in which the problems are displayed, because</span>
<a name="l01057"></a>01057 <span class="preprocessor"></span><span class="preprocessor">#       #    they may be in a random order</span>
<a name="l01058"></a>01058 <span class="preprocessor"></span><span class="preprocessor">#       if ( $set-&gt;problem_randorder ) {</span>
<a name="l01059"></a>01059 <span class="preprocessor"></span><span class="preprocessor">#           my @newOrder = ();</span>
<a name="l01060"></a>01060 <span class="preprocessor"></span><span class="preprocessor">#           my @probOrder = (0..$#problemRecords);</span>
<a name="l01061"></a>01061 <span class="preprocessor"></span><span class="preprocessor">#           # we reorder using a pgrand based on the set psvn</span>
<a name="l01062"></a>01062 <span class="preprocessor"></span><span class="preprocessor">#           my $pgrand = PGrandom-&gt;new();</span>
<a name="l01063"></a>01063 <span class="preprocessor"></span><span class="preprocessor">#           $pgrand-&gt;srand( $set-&gt;psvn );</span>
<a name="l01064"></a>01064 <span class="preprocessor"></span><span class="preprocessor">#           while ( @probOrder ) { </span>
<a name="l01065"></a>01065 <span class="preprocessor"></span><span class="preprocessor">#               my $i = int($pgrand-&gt;rand(scalar(@probOrder)));</span>
<a name="l01066"></a>01066 <span class="preprocessor"></span><span class="preprocessor">#               push( @newOrder, $probOrder[$i] );</span>
<a name="l01067"></a>01067 <span class="preprocessor"></span><span class="preprocessor">#               splice(@probOrder, $i, 1);</span>
<a name="l01068"></a>01068 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l01069"></a>01069 <span class="preprocessor"></span><span class="preprocessor">#           # now $newOrder[i] = pNum-1, where pNum is the problem</span>
<a name="l01070"></a>01070 <span class="preprocessor"></span><span class="preprocessor">#           #    number to display in the ith position on the test</span>
<a name="l01071"></a>01071 <span class="preprocessor"></span><span class="preprocessor">#           #    for sorting, invert this mapping:</span>
<a name="l01072"></a>01072 <span class="preprocessor"></span><span class="preprocessor">#           my %pSort = map {($newOrder[$_]+1)=&gt;$_} (0..$#newOrder);</span>
<a name="l01073"></a>01073 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01074"></a>01074 <span class="preprocessor"></span><span class="preprocessor">#           @problemRecords = sort {$pSort{$a-&gt;problem_id} &lt;=&gt; $pSort{$b-&gt;problem_id}} @problemRecords;</span>
<a name="l01075"></a>01075 <span class="preprocessor"></span><span class="preprocessor">#       }</span>
<a name="l01076"></a>01076 <span class="preprocessor"></span>    
<a name="l01077"></a>01077 <span class="preprocessor">    #######################################################</span>
<a name="l01078"></a>01078 <span class="preprocessor"></span><span class="preprocessor">    # construct header</span>
<a name="l01079"></a>01079 <span class="preprocessor"></span>    
<a name="l01080"></a>01080         <span class="keywordflow">foreach</span> my $problemRecord (@problemRecords) {
<a name="l01081"></a>01081             my $prob = $problemRecord-&gt;problem_id;
<a name="l01082"></a>01082             
<a name="l01083"></a>01083             unless (defined($problemRecord) ){
<a name="l01084"></a>01084 <span class="preprocessor">                # warn &quot;Can&#39;t find record for problem $prob in set $setName for $student&quot;;</span>
<a name="l01085"></a>01085 <span class="preprocessor"></span><span class="preprocessor">            # FIXME check the legitimate reasons why a student record might not be defined</span>
<a name="l01086"></a>01086 <span class="preprocessor"></span>                next;
<a name="l01087"></a>01087             }
<a name="l01088"></a>01088             
<a name="l01089"></a>01089             $status           = $problemRecord-&gt;status || 0;
<a name="l01090"></a>01090             my $attempted     = $problemRecord-&gt;attempted;
<a name="l01091"></a>01091             my $num_correct   = $problemRecord-&gt;num_correct || 0;
<a name="l01092"></a>01092             my $num_incorrect = $problemRecord-&gt;num_incorrect   || 0;
<a name="l01093"></a>01093             $num_of_attempts  = $num_correct + $num_incorrect;
<a name="l01094"></a>01094             
<a name="l01095"></a>01095 <span class="preprocessor">#######################################################</span>
<a name="l01096"></a>01096 <span class="preprocessor"></span><span class="preprocessor">            # This is a fail safe mechanism that makes sure that</span>
<a name="l01097"></a>01097 <span class="preprocessor"></span><span class="preprocessor">            # the problem is marked as attempted if the status has</span>
<a name="l01098"></a>01098 <span class="preprocessor"></span><span class="preprocessor">            # been set or if the problem has been attempted</span>
<a name="l01099"></a>01099 <span class="preprocessor"></span><span class="preprocessor">            # DBFIXME this should happen in the database layer, not here!</span>
<a name="l01100"></a>01100 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!$attempted &amp;&amp; ($status || $num_of_attempts)) {
<a name="l01101"></a>01101                 $attempted = 1;
<a name="l01102"></a>01102                 $problemRecord-&gt;attempted(<span class="charliteral">&#39;1&#39;</span>);
<a name="l01103"></a>01103 <span class="preprocessor">                # DBFIXME: this is another case where it </span>
<a name="l01104"></a>01104 <span class="preprocessor"></span><span class="preprocessor">                #    seems we shouldn&#39;t have to check for </span>
<a name="l01105"></a>01105 <span class="preprocessor"></span><span class="preprocessor">                #    which routine to use here...</span>
<a name="l01106"></a>01106 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $setIsVersioned ) {
<a name="l01107"></a>01107                     $db-&gt;putProblemVersion($problemRecord);
<a name="l01108"></a>01108                 } <span class="keywordflow">else</span> {
<a name="l01109"></a>01109                     $db-&gt;putUserProblem($problemRecord );
<a name="l01110"></a>01110                 }
<a name="l01111"></a>01111             }
<a name="l01112"></a>01112 <span class="preprocessor">######################################################          </span>
<a name="l01113"></a>01113 <span class="preprocessor"></span>
<a name="l01114"></a>01114 <span class="preprocessor">            # sanity check that the status (score) is </span>
<a name="l01115"></a>01115 <span class="preprocessor"></span><span class="preprocessor">            # between 0 and 1</span>
<a name="l01116"></a>01116 <span class="preprocessor"></span>            my $valid_status = ($status&gt;=0 &amp;&amp; $status&lt;=1)?1:0;
<a name="l01117"></a>01117 
<a name="l01118"></a>01118 <span class="preprocessor">            ###########################################</span>
<a name="l01119"></a>01119 <span class="preprocessor"></span><span class="preprocessor">            # Determine the string $longStatus which </span>
<a name="l01120"></a>01120 <span class="preprocessor"></span><span class="preprocessor">            # will display the student&#39;s current score</span>
<a name="l01121"></a>01121 <span class="preprocessor"></span><span class="preprocessor">            ###########################################</span>
<a name="l01122"></a>01122 <span class="preprocessor"></span>
<a name="l01123"></a>01123             <span class="keywordflow">if</span> (!$attempted){
<a name="l01124"></a>01124                 $longStatus     = <span class="charliteral">&#39;.&#39;</span>;
<a name="l01125"></a>01125             } elsif   ($valid_status) {
<a name="l01126"></a>01126                 $longStatus     =  int(100*$status+.5) ;
<a name="l01127"></a>01127                 $longStatus=<span class="charliteral">&#39;C&#39;</span> <span class="keywordflow">if</span> ($longStatus==100);
<a name="l01128"></a>01128             } <span class="keywordflow">else</span>  {
<a name="l01129"></a>01129                 $longStatus     = <span class="charliteral">&#39;X&#39;</span>;
<a name="l01130"></a>01130             }
<a name="l01131"></a>01131         
<a name="l01132"></a>01132             $string         .= threeSpaceFill($longStatus);
<a name="l01133"></a>01133             $twoString      .= threeSpaceFill($num_incorrect);
<a name="l01134"></a>01134             my $probValue   =  $problemRecord-&gt;value;
<a name="l01135"></a>01135             $probValue      =  1 unless defined($probValue) and $probValue ne &quot;&quot;;  <span class="preprocessor"># FIXME?? set defaults here?</span>
<a name="l01136"></a>01136 <span class="preprocessor"></span>            $total          += $probValue;
<a name="l01137"></a>01137             $totalRight     += round_score($status*$probValue) <span class="keywordflow">if</span> $valid_status;
<a name="l01138"></a>01138                 
<a name="l01139"></a>01139 <span class="preprocessor">#               </span>
<a name="l01140"></a>01140 <span class="preprocessor"></span><span class="preprocessor">#           # initialize the number of correct answers </span>
<a name="l01141"></a>01141 <span class="preprocessor"></span><span class="preprocessor">#           # for this problem if the value has not been </span>
<a name="l01142"></a>01142 <span class="preprocessor"></span><span class="preprocessor">#           # defined.</span>
<a name="l01143"></a>01143 <span class="preprocessor"></span><span class="preprocessor">#           $correct_answers_for_problem{$probID} = 0 </span>
<a name="l01144"></a>01144 <span class="preprocessor"></span><span class="preprocessor">#               unless defined($correct_answers_for_problem{$probID});</span>
<a name="l01145"></a>01145 <span class="preprocessor"></span>            
<a name="l01146"></a>01146                 
<a name="l01147"></a>01147 <span class="preprocessor">        # add on the scores for this problem</span>
<a name="l01148"></a>01148 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (defined($rh_correct_answers_for_problem ) ) {  #skip <span class="keyword">this</span> <span class="keywordflow">if</span> we are not updating records
<a name="l01149"></a>01149                 my $probID          = $problemRecord-&gt;problem_id;
<a name="l01150"></a>01150                 $rh_correct_answers_for_problem-&gt;{$probID} = 0      unless defined($rh_correct_answers_for_problem-&gt;{$probID});
<a name="l01151"></a>01151                 <span class="keywordflow">if</span> (defined($attempted) and $attempted) {
<a name="l01152"></a>01152                     $rh_number_of_students_attempting_problem-&gt;{$probID}++;
<a name="l01153"></a>01153                     push( @{ $rh_attempts_list_for_problem-&gt;{$probID} } ,     $num_of_attempts);
<a name="l01154"></a>01154                     $rh_number_of_attempts_for_problem-&gt;{$probID}          += $num_of_attempts;
<a name="l01155"></a>01155                     $rh_problemData-&gt;{$probID}                              = $num_incorrect;
<a name="l01156"></a>01156                     $$rh_total_num_of_attempts_for_set                     += $num_of_attempts;
<a name="l01157"></a>01157                     $rh_correct_answers_for_problem-&gt;{$probID}             += $status;
<a name="l01158"></a>01158                 }
<a name="l01159"></a>01159             }
<a name="l01160"></a>01160         
<a name="l01161"></a>01161         }  # end of problem record loop
<a name="l01162"></a>01162 
<a name="l01163"></a>01163 
<a name="l01164"></a>01164 
<a name="l01165"></a>01165         <span class="keywordflow">return</span>($status,  
<a name="l01166"></a>01166                $longStatus, 
<a name="l01167"></a>01167                $string,
<a name="l01168"></a>01168                $twoString, 
<a name="l01169"></a>01169                $totalRight,
<a name="l01170"></a>01170                $total, 
<a name="l01171"></a>01171                $num_of_attempts, 
<a name="l01172"></a>01172                $num_of_problems         
<a name="l01173"></a>01173         );
<a name="l01174"></a>01174 }
<a name="l01175"></a>01175 <span class="preprocessor">#################################</span>
<a name="l01176"></a>01176 <span class="preprocessor"></span><span class="preprocessor"># Utility function NOT a method</span>
<a name="l01177"></a>01177 <span class="preprocessor"></span><span class="preprocessor">#################################</span>
<a name="l01178"></a>01178 <span class="preprocessor"></span>sub threeSpaceFill {
<a name="l01179"></a>01179     my $num = shift @_ || 0;
<a name="l01180"></a>01180 
<a name="l01181"></a>01181     <span class="keywordflow">if</span> (length($num)&lt;=1) {<span class="keywordflow">return</span> <span class="stringliteral">&quot;$num&quot;</span>.<span class="stringliteral">&#39;&amp;nbsp;&amp;nbsp;&#39;</span>;}
<a name="l01182"></a>01182     elsif (length($num)==2) {<span class="keywordflow">return</span> <span class="stringliteral">&quot;$num&quot;</span>.<span class="stringliteral">&#39;&amp;nbsp;&#39;</span>;}
<a name="l01183"></a>01183     <span class="keywordflow">else</span> {<span class="keywordflow">return</span> <span class="stringliteral">&quot;## &quot;</span>;}
<a name="l01184"></a>01184 }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186 sub round_score{
<a name="l01187"></a>01187     <span class="keywordflow">return</span> shift;
<a name="l01188"></a>01188 }
<a name="l01189"></a>01189 
<a name="l01190"></a>01190 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:35 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
