<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WebworkWebservice::RenderProblem Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWebworkWebservice.html">WebworkWebservice</a>::<a class="el" href="classWebworkWebservice_1_1RenderProblem.html">RenderProblem</a>
  </div>
</div>
<div class="contents">
<h1>WebworkWebservice::RenderProblem Class Reference</h1><!-- doxytag: class="WebworkWebservice::RenderProblem" --><!-- doxytag: inherits="WebworkWebservice" --><div class="dynheader">
Inheritance diagram for WebworkWebservice::RenderProblem:</div>
<div class="dynsection">
<div class="center"><img src="classWebworkWebservice_1_1RenderProblem__inherit__graph.png" border="0" usemap="#WebworkWebservice_1_1RenderProblem_inherit__map" alt="Inheritance graph"/></div>
<map name="WebworkWebservice_1_1RenderProblem_inherit__map" id="WebworkWebservice_1_1RenderProblem_inherit__map">
<area shape="rect" href="classWebworkWebservice.html" title="WebworkWebservice" alt="" coords="55,5,196,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WebworkWebservice::RenderProblem:</div>
<div class="dynsection">
<div class="center"><img src="classWebworkWebservice_1_1RenderProblem__coll__graph.png" border="0" usemap="#WebworkWebservice_1_1RenderProblem_coll__map" alt="Collaboration graph"/></div>
<map name="WebworkWebservice_1_1RenderProblem_coll__map" id="WebworkWebservice_1_1RenderProblem_coll__map">
<area shape="rect" href="classWebworkWebservice.html" title="WebworkWebservice" alt="" coords="55,5,196,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWebworkWebservice_1_1RenderProblem-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWebworkWebservice_1_1RenderProblem.html#a44c4d08930d14883ebe0d5eef20fb9c2">xml_filter</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWebworkWebservice_1_1RenderProblem.html#a68d6e76c36fbdbe8b756e96906440d6a">logTimingInfo</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWebworkWebservice_1_1RenderProblem.html#a6fc2bdba0d3b3ff574e7dd3884d80bf3">renderProblem</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWebworkWebservice_1_1RenderProblem.html#a46422a9e107780b4517b06a94a34194f">new</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>

<p>Definition at line <a class="el" href="RenderProblem_8pm_source.html#l00029">29</a> of file <a class="el" href="RenderProblem_8pm_source.html">RenderProblem.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a68d6e76c36fbdbe8b756e96906440d6a"></a><!-- doxytag: member="WebworkWebservice::RenderProblem::logTimingInfo" ref="a68d6e76c36fbdbe8b756e96906440d6a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WebworkWebservice::RenderProblem::logTimingInfo </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-logTimingInfo' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-logTimingInfo-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-logTimingInfo-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-logTimingInfo-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in logTimingInfo: 6</span>
<span class="preprocessor"></span>sub <a class="code" href="classWebworkWebservice_1_1RenderProblem.html#a68d6e76c36fbdbe8b756e96906440d6a">logTimingInfo</a>{
    my ($beginTime,$endTime,) = @_;
    my $out = <span class="stringliteral">&quot;&quot;</span>;
    $out .= Benchmark::timestr( Benchmark::timediff($endTime , $beginTime) );
    $out;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a46422a9e107780b4517b06a94a34194f"></a><!-- doxytag: member="WebworkWebservice::RenderProblem::new" ref="a46422a9e107780b4517b06a94a34194f" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WebworkWebservice::RenderProblem::new </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-new' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-new-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-new-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-new-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in new: 13</span>
<span class="preprocessor"></span>sub <span class="keyword">new</span> {
    shift; # <span class="keywordflow">throw</span> away invocant -- we don<span class="stringliteral">&#39;t need it</span>
<span class="stringliteral">    my ($ce, $user, $key, $set, $problem, $psvn, $formFields,</span>
<span class="stringliteral">        $translationOptions) = @_;</span>
<span class="stringliteral">    </span>
<span class="stringliteral">    #my $renderer = &#39;</span><a class="code" href="classWeBWorK_1_1PG_1_1Local.html">WeBWorK::PG::Local</a><span class="stringliteral">&#39;;</span>
<span class="stringliteral">    my $renderer = $ce-&gt;{pg}-&gt;{renderer};</span>
<span class="stringliteral">    </span>
<span class="stringliteral">    runtime_use $renderer;</span>
<span class="stringliteral">    # the idea is to have Local call back to the defineProblemEnvir below.</span>
<span class="stringliteral">    #return WeBWorK::PG::Local::new($renderer,@_);</span>
<span class="stringliteral">    return $renderer-&gt;new(@_);</span>
<span class="stringliteral">}</span>
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a6fc2bdba0d3b3ff574e7dd3884d80bf3"></a><!-- doxytag: member="WebworkWebservice::RenderProblem::renderProblem" ref="a6fc2bdba0d3b3ff574e7dd3884d80bf3" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WebworkWebservice::RenderProblem::renderProblem </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-renderProblem' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-renderProblem-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-renderProblem-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-renderProblem-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in renderProblem: 342</span>
<span class="preprocessor"></span>sub <a class="code" href="classWebworkWebservice_1_1RenderProblem.html#a6fc2bdba0d3b3ff574e7dd3884d80bf3">renderProblem</a> {
    my $self = shift;
    my $rh = shift;

<span class="preprocessor">###########################################</span>
<span class="preprocessor"></span><span class="preprocessor"># Grab the course name, if this request is going to depend on </span>
<span class="preprocessor"></span><span class="preprocessor"># some course other than the default course</span>
<span class="preprocessor"></span><span class="preprocessor">###########################################</span>
<span class="preprocessor"></span>    my $courseName;
    my $ce;
    my $db;
    my $user;
    my $beginTime = <span class="keyword">new</span> Benchmark;
<span class="preprocessor">#   if (defined($self-&gt;{courseName}) and $self-&gt;{courseName} ) {</span>
<span class="preprocessor"></span><span class="preprocessor">#       $courseName = $self-&gt;{courseName};</span>
<span class="preprocessor"></span><span class="preprocessor">#   } elsif (defined($rh-&gt;{course}) and $rh-&gt;{course}=~/\S/ ) {</span>
<span class="preprocessor"></span><span class="preprocessor">#       $courseName = $rh-&gt;{course};</span>
<span class="preprocessor"></span><span class="preprocessor">#   } else {</span>
<span class="preprocessor"></span><span class="preprocessor">#       $courseName = $COURSENAME;</span>
<span class="preprocessor"></span><span class="preprocessor">#       # use the default $ce</span>
<span class="preprocessor"></span><span class="preprocessor">#   }</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (defined($self-&gt;{courseName}) and $self-&gt;{courseName} ) {
        $courseName = $self-&gt;{courseName};
    } 
    
<span class="preprocessor">    # It&#39;s better not to get the course in too many places. :-)</span>
<span class="preprocessor"></span><span class="preprocessor">    # High level information about the course should come from $self</span>
<span class="preprocessor"></span><span class="preprocessor">    # Lower level information should come from $rh (i.e. passed by $in at WebworkWebservice)</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    #FIXME  put in check to make sure the course exists.</span>
<span class="preprocessor"></span>    eval {
        $ce           = <a class="code" href="classWeBWorK_1_1CourseEnvironment.html">WeBWorK::CourseEnvironment</a>-&gt;new({webwork_dir=&gt;$WW_DIRECTORY, courseName=&gt; $courseName});
        $ce-&gt;{apache_root_url}= $HOSTURL;
<span class="preprocessor">    # Create database object for this course</span>
<span class="preprocessor"></span>        $db = <a class="code" href="classWeBWorK_1_1DB.html">WeBWorK::DB</a>-&gt;new($ce-&gt;{dbLayout});
    };
<span class="preprocessor">    # $ce-&gt;{pg}-&gt;{options}-&gt;{catchWarnings}=1;  #FIXME warnings aren&#39;t automatically caught </span>
<span class="preprocessor"></span><span class="preprocessor">    # when using xmlrpc -- turn this on in the daemon2_course.</span>
<span class="preprocessor"></span><span class="preprocessor">    #^FIXME  need better way of determining whether the course actually exists.</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    # The UNIT_TEST_ON snippets are the closest thing we have to a real unit test.</span>
<span class="preprocessor"></span><span class="preprocessor">    #</span>
<span class="preprocessor"></span>    warn <span class="stringliteral">&quot;Unable to create course $courseName. Error: $@&quot;</span> <span class="keywordflow">if</span> $@;
<span class="preprocessor">    # my $user = $rh-&gt;{user};</span>
<span class="preprocessor"></span><span class="preprocessor">    #   $user    = &#39;practice1&#39; unless defined $user and $user =~/\S/;</span>
<span class="preprocessor"></span>
    my $user = $self-&gt;{user_id};
    
<span class="preprocessor">###########################################</span>
<span class="preprocessor"></span><span class="preprocessor"># Authenticate this request -- done by initiate  in WebworkWebservice </span>
<span class="preprocessor"></span><span class="preprocessor">###########################################</span>
<span class="preprocessor"></span>


<span class="preprocessor">###########################################</span>
<span class="preprocessor"></span><span class="preprocessor"># Determine the authorization level (permissions)  -- done by initiate  in WebworkWebservice </span>
<span class="preprocessor"></span><span class="preprocessor">###########################################</span>
<span class="preprocessor"></span>
<span class="preprocessor">###############################################################################</span>
<span class="preprocessor"></span><span class="preprocessor"># set up warning handler</span>
<span class="preprocessor"></span><span class="preprocessor">###############################################################################</span>
<span class="preprocessor"></span>    my $warning_messages=<span class="stringliteral">&quot;&quot;</span>;

    my  $warning_handler = sub {
            my ($warning) = @_;
            CORE::warn $warning;
            chomp $warning;
            $warning_messages .=<span class="stringliteral">&quot;$warning\n&quot;</span>;           
        };

    local $SIG{__WARN__} = $warning_handler;



<span class="preprocessor">###########################################</span>
<span class="preprocessor"></span><span class="preprocessor"># Determine the method for accessing data   ???? what was this</span>
<span class="preprocessor"></span><span class="preprocessor">###########################################</span>
<span class="preprocessor"></span>    my $problem_source_access    =   $rh-&gt;{problem_source_access};
<span class="preprocessor">    # One of</span>
<span class="preprocessor"></span><span class="preprocessor">    #   source_from_course_set_problem</span>
<span class="preprocessor"></span><span class="preprocessor">    #   source_from_source_file_path</span>
<span class="preprocessor"></span><span class="preprocessor">    #   source_from_request</span>
<span class="preprocessor"></span>    
    my $data_access              =   $rh-&gt;{data_access};
<span class="preprocessor">    # One of </span>
<span class="preprocessor"></span><span class="preprocessor">    #   data_from_course</span>
<span class="preprocessor"></span><span class="preprocessor">    #   data_from_request</span>
<span class="preprocessor"></span>
<span class="preprocessor">###########################################</span>
<span class="preprocessor"></span><span class="preprocessor"># Determine an effective user for this interaction</span>
<span class="preprocessor"></span><span class="preprocessor"># or create one if it is not given</span>
<span class="preprocessor"></span><span class="preprocessor"># In order:  use effectiveUserName, studentLogin, or user  or &#39;foobar&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">###########################################</span>
<span class="preprocessor"></span>    my $effectiveUserName;
    <span class="keywordflow">if</span> (defined($rh-&gt;{effectiveUser}) and $rh-&gt;{effectiveUser}=~/\S/ ) {
        $effectiveUserName = $rh-&gt;{effectiveUser};
    } elsif (defined($rh-&gt;{envir}-&gt;{studentLogin}) and $rh-&gt;{envir}-&gt;{studentLogin}=~/\S/ ) {
        $effectiveUserName = $rh-&gt;{envir}-&gt;{studentLogin};
    } elsif (defined($user) and $user =~ /\S/ ) {
        $effectiveUserName = $user;
    } <span class="keywordflow">else</span> {
        $effectiveUserName = <span class="stringliteral">&#39;foobar&#39;</span>;
    }
<span class="preprocessor">    ##################################################</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ($UNIT_TESTS_ON) {
        print STDERR <span class="stringliteral">&quot;RenderProblem.pm:  user = $user\n&quot;</span>;
        print STDERR <span class="stringliteral">&quot;RenderProblem.pm:  courseName = $courseName\n&quot;</span>;
        print STDERR <span class="stringliteral">&quot;RenderProblem.pm:  effectiveUserName = $effectiveUserName\n&quot;</span>;
    }
    
<span class="preprocessor">    #################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # The effectiveUser is the student the this problem version was written for</span>
<span class="preprocessor"></span><span class="preprocessor">    # The user might also be the effective user but it could be </span>
<span class="preprocessor"></span><span class="preprocessor">    # an instructor checking out how well the problem is working.</span>
<span class="preprocessor"></span><span class="preprocessor">    #################################################################</span>
<span class="preprocessor"></span>    
    my $effectiveUser = $db-&gt;getUser($effectiveUserName); # checked
    my $effectiveUserPermissionLevel;
    my $effectiveUserPassword;
    unless (defined $effectiveUser ) {
        $effectiveUser                = $db-&gt;newUser;
        $effectiveUserPermissionLevel = $db-&gt;newPermissionLevel;
        $effectiveUserPassword        = $db-&gt;newPassword;
        $effectiveUser-&gt;user_id($effectiveUserName);
        $effectiveUserPermissionLevel-&gt;user_id($effectiveUserName);
        $effectiveUserPassword-&gt;user_id($effectiveUserName);
        $effectiveUserPassword-&gt;password(<span class="stringliteral">&#39;&#39;</span>);
        $effectiveUser-&gt;last_name($rh-&gt;{envir}-&gt;{studentName}|| <span class="stringliteral">&#39;foobar&#39;</span>);
        $effectiveUser-&gt;first_name(<span class="stringliteral">&#39;&#39;</span>);
        $effectiveUser-&gt;student_id($rh-&gt;{envir}-&gt;{studentID}|| <span class="stringliteral">&#39;foobar&#39;</span>);
        $effectiveUser-&gt;email_address($rh-&gt;{envir}-&gt;{email}|| <span class="stringliteral">&#39;&#39;</span>);
        $effectiveUser-&gt;section($rh-&gt;{envir}-&gt;{section} ||<span class="stringliteral">&#39;&#39;</span>);
        $effectiveUser-&gt;recitation($rh-&gt;{envir}-&gt;{recitation} ||<span class="stringliteral">&#39;&#39;</span>);
        $effectiveUser-&gt;comment(<span class="stringliteral">&#39;&#39;</span>);
        $effectiveUser-&gt;status(<span class="charliteral">&#39;C&#39;</span>);
<span class="preprocessor">        #$effectiveUser-&gt;password($rh-&gt;{envir}-&gt;{studentID}|| &#39;foobar&#39;); dunno what&#39;s going on here</span>
<span class="preprocessor"></span>        $effectiveUserPermissionLevel-&gt;permission(0);
    }       
<span class="preprocessor">   #FIXME  these will fail if the keys are not defined within the environment.</span>
<span class="preprocessor"></span>
<span class="preprocessor">###########################################</span>
<span class="preprocessor"></span><span class="preprocessor"># Insure that set and problem are defined</span>
<span class="preprocessor"></span><span class="preprocessor"># Define the set and problem information from</span>
<span class="preprocessor"></span><span class="preprocessor"># data in the environment if necessary</span>
<span class="preprocessor"></span><span class="preprocessor">###########################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # determine the set name and the set problem number</span>
<span class="preprocessor"></span>    my $setName       =  (defined($rh-&gt;{envir}-&gt;{setNumber}) )    ? $rh-&gt;{envir}-&gt;{setNumber}    : <span class="stringliteral">&#39;&#39;</span>;
    my $problemNumber =  (defined($rh-&gt;{envir}-&gt;{probNum})   )    ? $rh-&gt;{envir}-&gt;{probNum}      : 1 ;
    my $problemSeed   =  (defined($rh-&gt;{envir}-&gt;{problemSeed}))   ? $rh-&gt;{envir}-&gt;{problemSeed}  : 1 ;
    my $psvn          =  (defined($rh-&gt;{envir}-&gt;{psvn})      )    ? $rh-&gt;{envir}-&gt;{psvn}         : 1234 ;
    my $problemStatus =  $rh-&gt;{problem_state}-&gt;{recorded_score}|| 0 ;
    my $problemValue  =  (defined($rh-&gt;{envir}-&gt;{problemValue}))   ? $rh-&gt;{envir}-&gt;{problemValue}  : 1 ;
    my $num_correct   =  $rh-&gt;{problem_state}-&gt;{num_correct}   || 0 ;
    my $num_incorrect =  $rh-&gt;{problem_state}-&gt;{num_incorrect} || 0 ;
    my $problemAttempted = ($num_correct || $num_incorrect);
    my $lastAnswer    = <span class="stringliteral">&#39;&#39;</span>;
    
    my $setRecord = $db-&gt;getMergedSet($effectiveUserName, $setName);
    unless (defined($setRecord) and ref($setRecord) ) {
<span class="preprocessor">        # if a User Set does not exist for this user and this set</span>
<span class="preprocessor"></span><span class="preprocessor">        # then we check the Global Set</span>
<span class="preprocessor"></span><span class="preprocessor">        # if that does not exist we create a fake set</span>
<span class="preprocessor"></span><span class="preprocessor">        # if it does, we add fake user data</span>
<span class="preprocessor"></span>        my $userSetClass = $db-&gt;{set_user}-&gt;{record};
        my $globalSet = $db-&gt;getGlobalSet($setName); # checked

        <span class="keywordflow">if</span> (not defined $globalSet) {
            $setRecord = fake_set($db);
        } <span class="keywordflow">else</span> {
            $setRecord = global2user($userSetClass, $globalSet);
        }
<span class="preprocessor">        # initializations</span>
<span class="preprocessor"></span>        $setRecord-&gt;set_id($setName);
        $setRecord-&gt;set_header(<span class="stringliteral">&quot;&quot;</span>);
        $setRecord-&gt;hardcopy_header(<span class="stringliteral">&quot;defaultHeader&quot;</span>);
        $setRecord-&gt;open_date(time()-60*60*24*7); #  one week ago
        $setRecord-&gt;due_date(time()+60*60*24*7*2); # in two weeks
        $setRecord-&gt;answer_date(time()+60*60*24*7*3); # in three weeks
        $setRecord-&gt;psvn($rh-&gt;{envir}-&gt;{psvn}||0);
    }
<span class="preprocessor">    #warn &quot;set Record is $setRecord&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">    # obtain the merged problem for $effectiveUser</span>
<span class="preprocessor"></span>    my $problemRecord = $db-&gt;getMergedProblem($effectiveUserName, $setName, $problemNumber); 
    
<span class="preprocessor">    # if that is not yet defined obtain the global problem,</span>
<span class="preprocessor"></span><span class="preprocessor">    # convert it to a user problem, and add fake user data</span>
<span class="preprocessor"></span>    unless (defined $problemRecord) {
        my $userProblemClass = $db-&gt;{problem_user}-&gt;{record};
        my $globalProblem = $db-&gt;getGlobalProblem($setName, $problemNumber); # checked
<span class="preprocessor">        # if the global problem doesn&#39;t exist either, bail!</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span>(not defined $globalProblem) {
            $problemRecord = fake_problem($db);
        } <span class="keywordflow">else</span> {
            $problemRecord = global2user($userProblemClass, $globalProblem);
        }
<span class="preprocessor">        # initializations</span>
<span class="preprocessor"></span>        $problemRecord-&gt;user_id($effectiveUserName);
        $problemRecord-&gt;problem_id($problemNumber);
        $problemRecord-&gt;set_id($setName);
        $problemRecord-&gt;problem_seed($problemSeed);
        $problemRecord-&gt;status($problemStatus);
        $problemRecord-&gt;value($problemValue);
        $problemRecord-&gt;attempted($problemAttempted);
        $problemRecord-&gt;last_answer($lastAnswer);
        $problemRecord-&gt;num_correct($num_correct);
        $problemRecord-&gt;num_incorrect($num_incorrect);
    }
<span class="preprocessor">    # initialize problem source</span>
<span class="preprocessor"></span>    my $problem_source;
    my $r_problem_source =undef;
    <span class="keywordflow">if</span> (defined($rh-&gt;{source})) {
        $problem_source = decode_base64($rh-&gt;{source});
        $problem_source =~ tr /\r/\n/;
        $r_problem_source =\$problem_source;
        $problemRecord-&gt;source_file($rh-&gt;{envir}-&gt;{fileName}) <span class="keywordflow">if</span> defined $rh-&gt;{envir}-&gt;{fileName};
    } elsif (defined($rh-&gt;{sourceFilePath}) and $rh-&gt;{sourceFilePath} =/\S/)  {
        $problemRecord-&gt;source_file($rh-&gt;{sourceFilePath});
    }
    $problemRecord-&gt;source_file(<span class="stringliteral">&#39;foobar&#39;</span>) unless defined($problemRecord-&gt;source_file);
    <span class="keywordflow">if</span> ($UNIT_TESTS_ON){
            print STDERR <span class="stringliteral">&quot;RenderProblem.pm: source file is &quot;</span>, $problemRecord-&gt;source_file,<span class="stringliteral">&quot;\n&quot;</span>;
            print STDERR <span class="stringliteral">&quot;RenderProblem.pm: problem source is included in the request \n&quot;</span> <span class="keywordflow">if</span> defined($rh-&gt;{source});
    }
<span class="preprocessor">    #warn &quot;problem Record is $problemRecord&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">    # now we&#39;re sure we have valid UserSet and UserProblem objects</span>
<span class="preprocessor"></span><span class="preprocessor">    # yay!</span>
<span class="preprocessor"></span>
<span class="preprocessor">##################################################</span>
<span class="preprocessor"></span><span class="preprocessor"># Other initializations</span>
<span class="preprocessor"></span><span class="preprocessor">##################################################</span>
<span class="preprocessor"></span>    my $translationOptions = {
        displayMode     =&gt; $rh-&gt;{envir}-&gt;{displayMode},
        showHints       =&gt; $rh-&gt;{envir}-&gt;{showHints},
        showSolutions   =&gt; $rh-&gt;{envir}-&gt;{showSolutions},
        refreshMath2img =&gt; $rh-&gt;{envir}-&gt;{showHints} || $rh-&gt;{envir}-&gt;{showSolutions},
        processAnswers  =&gt; 1,
        catchWarnings   =&gt; 1,
<span class="preprocessor">        # methods for supplying the source, </span>
<span class="preprocessor"></span>        r_source        =&gt; $r_problem_source, # reference to a source file <span class="keywordtype">string</span>.
        # <span class="keywordflow">if</span> reference is not defined then the path is obtained 
<span class="preprocessor">        # from the problem object.</span>
<span class="preprocessor"></span>        permissionLevel =&gt; $rh-&gt;{envir}-&gt;{permissionLevel} || 0,
    };
    
    my $formFields = $rh-&gt;{envir}-&gt;{inputs_ref};
    my $key        = $rh-&gt;{envir}-&gt;{key} || <span class="stringliteral">&#39;&#39;</span>;
    
    
<span class="preprocessor">    #check definitions</span>
<span class="preprocessor"></span><span class="preprocessor">    #warn &quot;setRecord is &quot;, WebworkWebservice::pretty_print_rh($setRecord);</span>
<span class="preprocessor"></span><span class="preprocessor">    #warn &quot;problemRecord is&quot;,WebworkWebservice::pretty_print_rh($problemRecord);</span>
<span class="preprocessor"></span><span class="preprocessor">#   warn &quot;envir is\n &quot;,WebworkWebservice::pretty_print_rh(__PACKAGE__-&gt;defineProblemEnvir(</span>
<span class="preprocessor"></span><span class="preprocessor">#       $ce,</span>
<span class="preprocessor"></span><span class="preprocessor">#       $effectiveUser,</span>
<span class="preprocessor"></span><span class="preprocessor">#       $key,</span>
<span class="preprocessor"></span><span class="preprocessor">#       $setRecord,</span>
<span class="preprocessor"></span><span class="preprocessor">#       $problemRecord,</span>
<span class="preprocessor"></span><span class="preprocessor">#       $psvn,  #FIXME -- not used</span>
<span class="preprocessor"></span><span class="preprocessor">#       $formFields,</span>
<span class="preprocessor"></span><span class="preprocessor">#       $translationOptions,</span>
<span class="preprocessor"></span><span class="preprocessor">#   ));</span>
<span class="preprocessor"></span><span class="preprocessor">#################################################</span>
<span class="preprocessor"></span>
<span class="preprocessor"># Other options can be over ridden by modifying </span>
<span class="preprocessor"></span><span class="preprocessor"># $ce-&gt;{pg}</span>
<span class="preprocessor"></span>


<span class="preprocessor"># We&#39;ll try to use this code instead so that Local does all of the work.</span>
<span class="preprocessor"></span><span class="preprocessor"># Most of the configuration will take place in the fake course associated</span>
<span class="preprocessor"></span><span class="preprocessor"># with XMLRPC responses</span>
<span class="preprocessor"></span><span class="preprocessor">#   problem needs to be loaded with the following:</span>
<span class="preprocessor"></span><span class="preprocessor">#       source_file</span>
<span class="preprocessor"></span><span class="preprocessor">#       status</span>
<span class="preprocessor"></span><span class="preprocessor">#       num_correct</span>
<span class="preprocessor"></span><span class="preprocessor">#       num_incorrect</span>
<span class="preprocessor"></span><span class="preprocessor">#   it doesn&#39;t seem that $effectiveUser, $set or $key is used in the subroutine</span>
<span class="preprocessor"></span><span class="preprocessor">#   except that it is passed on to defineProblemEnvironment</span>
<span class="preprocessor"></span>
    my $pg;
    $pg = <a class="code" href="classWebworkWebservice_1_1RenderProblem.html">WebworkWebservice::RenderProblem</a>-&gt;new(
        $ce,
        $effectiveUser,
        $key,
        $setRecord,
        $problemRecord,
        $setRecord-&gt;psvn, # FIXME: <span class="keyword">this</span> field should be removed
        $formFields,
        # translation options
        $translationOptions,
#       { # extras
#               overrides       =&gt; $rh-&gt;{overrides}},
<span class="preprocessor">#         }</span>
<span class="preprocessor"></span>        
    );
  
    my $internal_debug_messages;
    <span class="keywordflow">if</span> (ref ($pg-&gt;{pgcore}) ) {
        $internal_debug_messages = $pg-&gt;{pgcore}-&gt;get_internal_debug_messages;
    } <span class="keywordflow">else</span> {
        $internal_debug_messages = [<span class="stringliteral">&#39;Error in obtaining debug messages from PGcore&#39;</span>];
    }
<span class="preprocessor">    # new version of output:</span>
<span class="preprocessor"></span>    my $out2   = {
        text                        =&gt; encode_base64( $pg-&gt;{body_text}  ),
        header_text                 =&gt; encode_base64( $pg-&gt;{head_text} ),
        answers                     =&gt; $pg-&gt;{answers},
        errors                      =&gt; $pg-&gt;{errors},
        WARNINGS                    =&gt; encode_base64( 
                                         <span class="stringliteral">&quot;WARNINGS\n&quot;</span>.$warning_messages.<span class="stringliteral">&quot;\nMore\n&quot;</span>.$pg-&gt;{warnings} 
                                       ),
        problem_result              =&gt; $pg-&gt;{result},
        problem_state               =&gt; $pg-&gt;{state},
        flags                       =&gt; $pg-&gt;{flags},
        internal_debug_messages     =&gt; $internal_debug_messages,
    };
    
<span class="preprocessor">    # Filter out bad reference types</span>
<span class="preprocessor"></span><span class="preprocessor">    ###################</span>
<span class="preprocessor"></span><span class="preprocessor">    # DEBUGGING CODE</span>
<span class="preprocessor"></span><span class="preprocessor">    ###################</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ($debugXmlCode) {
        my $logDirectory =$ce-&gt;{courseDirs}-&gt;{logs};
        my $xmlDebugLog  = <span class="stringliteral">&quot;$logDirectory/xml_debug.txt&quot;</span>;
<span class="preprocessor">        #warn &quot;RenderProblem.pm: Opening debug log $xmlDebugLog\n&quot; ;</span>
<span class="preprocessor"></span>        open (DEBUGCODE, <span class="stringliteral">&quot;&gt;&gt;$xmlDebugLog&quot;</span>) || die <span class="stringliteral">&quot;Can&#39;t open debug log $xmlDebugLog&quot;</span>;
        print DEBUGCODE <span class="stringliteral">&quot;\n\nStart xml encoding\n&quot;</span>;
    }
    
    $out2-&gt;{answers} = <a class="code" href="classWebworkWebservice_1_1RenderProblem.html#a44c4d08930d14883ebe0d5eef20fb9c2">xml_filter</a>($out2-&gt;{answers}); # check <span class="keyword">this</span> -- it might not be working correctly
<span class="preprocessor">    ##################</span>
<span class="preprocessor"></span>    close(DEBUGCODE) if $debugXmlCode;
    <span class="preprocessor">###################</span>
<span class="preprocessor"></span>    
    $out2-&gt;{flags}-&gt;{PROBLEM_GRADER_TO_USE} = undef;
    my $endTime = <span class="keyword">new</span> Benchmark;
    $out2-&gt;{compute_time} = <a class="code" href="classWebworkWebservice_1_1RenderProblem.html#a68d6e76c36fbdbe8b756e96906440d6a">logTimingInfo</a>($beginTime, $endTime);
<span class="preprocessor">    # warn &quot;flags are&quot; , WebworkWebservice::pretty_print_rh($pg-&gt;{flags});</span>
<span class="preprocessor"></span>    
    $out2;
             
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a44c4d08930d14883ebe0d5eef20fb9c2"></a><!-- doxytag: member="WebworkWebservice::RenderProblem::xml_filter" ref="a44c4d08930d14883ebe0d5eef20fb9c2" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WebworkWebservice::RenderProblem::xml_filter </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-xml_filter' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-xml_filter-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-xml_filter-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-xml_filter-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in xml_filter: 38</span>
<span class="preprocessor"></span>sub <a class="code" href="classWebworkWebservice_1_1RenderProblem.html#a44c4d08930d14883ebe0d5eef20fb9c2">xml_filter</a> {
    my $input = shift;
    my $level = shift || 0;
    my $space=<span class="stringliteral">&quot;  &quot;</span>;
<span class="preprocessor">    # Hack to filter out CODE references</span>
<span class="preprocessor"></span>    my $type = ref($input);
    <span class="keywordflow">if</span> (!defined($type) or !$type ) {
        print DEBUGCODE $space x $level.<span class="stringliteral">&quot; : scalar -- not converted\n&quot;</span> <span class="keywordflow">if</span> $debugXmlCode;
    } elsif( $type =~/HASH/i or <span class="stringliteral">&quot;$input&quot;</span>=~/HASH/i) {
        print DEBUGCODE <span class="stringliteral">&quot;HASH reference with &quot;</span>.%{$input}.<span class="stringliteral">&quot; elements will be investigated\n&quot;</span> <span class="keywordflow">if</span> $debugXmlCode;
        $level++;
        <span class="keywordflow">foreach</span> my $item (keys %{$input}) {
            print DEBUGCODE <span class="stringliteral">&quot;  &quot;</span>x$level.<span class="stringliteral">&quot;$item is &quot;</span> <span class="keywordflow">if</span> $debugXmlCode;
            $input-&gt;{$item} = <a class="code" href="classWebworkWebservice_1_1RenderProblem.html#a44c4d08930d14883ebe0d5eef20fb9c2">xml_filter</a>($input-&gt;{$item},$level);   
        }
        $level--;
        print DEBUGCODE <span class="stringliteral">&quot;  &quot;</span>x$level.<span class="stringliteral">&quot;HASH reference completed \n&quot;</span> <span class="keywordflow">if</span> $debugXmlCode;
    } elsif( $type=~/ARRAY/i or <span class="stringliteral">&quot;$input&quot;</span>=~/ARRAY/i) {
        print DEBUGCODE <span class="stringliteral">&quot;  &quot;</span>x$level.<span class="stringliteral">&quot;ARRAY reference with &quot;</span>.@{$input}.<span class="stringliteral">&quot; elements will be investigated\n&quot;</span> <span class="keywordflow">if</span> $debugXmlCode;
        $level++;
        my $tmp = [];
        <span class="keywordflow">foreach</span> my $item (@{$input}) {
            $item = <a class="code" href="classWebworkWebservice_1_1RenderProblem.html#a44c4d08930d14883ebe0d5eef20fb9c2">xml_filter</a>($item,$level);
            push @$tmp, $item;
        }
        $input = $tmp;
        $level--;
        print DEBUGCODE <span class="stringliteral">&quot;  &quot;</span>x$level.<span class="stringliteral">&quot;ARRAY reference completed&quot;</span>,join(<span class="stringliteral">&quot; &quot;</span>,@$input),<span class="stringliteral">&quot;\n&quot;</span> <span class="keywordflow">if</span> $debugXmlCode;
    } elsif($type =~ /CODE/i or <span class="stringliteral">&quot;$input&quot;</span> =~/CODE/i) {
        $input = <span class="stringliteral">&quot;CODE reference&quot;</span>;
        print DEBUGCODE <span class="stringliteral">&quot;  &quot;</span>x$level.<span class="stringliteral">&quot;CODE reference, converted $input\n&quot;</span> <span class="keywordflow">if</span> $debugXmlCode;
    } <span class="keywordflow">else</span> {
        print DEBUGCODE  <span class="stringliteral">&quot;  &quot;</span>x$level.<span class="stringliteral">&quot; $type and was  converted to string\n&quot;</span> <span class="keywordflow">if</span> $debugXmlCode;
        $input = <span class="stringliteral">&quot;$type reference&quot;</span>;
    }
    $input;
    
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="RenderProblem_8pm_source.html">RenderProblem.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 23:00:50 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
