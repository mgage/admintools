<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::ContentGenerator::Instructor::ProblemSetDetail Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator.html">ContentGenerator</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">Instructor</a>::<a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html">ProblemSetDetail</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::ContentGenerator::Instructor::ProblemSetDetail Class Reference</h1><!-- doxytag: class="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail" --><!-- doxytag: inherits="WeBWorK::ContentGenerator::Instructor" --><div class="dynheader">
Inheritance diagram for WeBWorK::ContentGenerator::Instructor::ProblemSetDetail:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail__inherit__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail_inherit__map" id="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail_inherit__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html" title="WeBWorK::ContentGenerator::Instructor" alt="" coords="59,155,315,181"/><area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="91,80,283,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="145,5,228,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::ContentGenerator::Instructor::ProblemSetDetail:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail__coll__graph.png" border="0" usemap="#WeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail_coll__map" id="WeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail_coll__map">
<area shape="rect" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html" title="WeBWorK::ContentGenerator::Instructor" alt="" coords="59,155,315,181"/><area shape="rect" href="classWeBWorK_1_1ContentGenerator.html" title="WeBWorK::ContentGenerator" alt="" coords="91,80,283,107"/><area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="145,5,228,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a79607043dba76c6b5f55ee30e488622a">problem_number_popup</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a9c3fba313741ab7ad57ecd9fcd8903a1">options</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a7ee5d4290cba1647d8d43f7839afb3b4">definedness</a> ($)()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#aadca428452b90de028e2fbef3e663488">checkFile</a> ($)()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a53c08e2b586ca7946c573642728cd836">initialize</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a535d98ecb64ab8a73f0503d73af161fe">FieldHTML</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab1d82f7e4749c6674e48c83232fb0d37">canChange</a> ($$)()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab7aaabdff126c3494bccb97c1afc4540">FieldTable</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a787093cdd71b85e6ab9b7d3e10355684">body</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ae5d24a5582c5e9f6e36dcf3090d8d94d">extraSetFields</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a3b44dc54c21dddcb3a7823da5e6942cd">changed</a> ($$)()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#af3602e0071a8eb6ba6a34499a6c08423">handle_problem_numbers</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a7f2fa5c4662e56b67ef177d3ac5edc36">proctoredFieldHTML</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html">WeBWorK::ContentGenerator::Instructor::ProblemSetDetail</a> - Edit general set and specific user/set information as well as problem information</p>
<h2><a class="anchor" id="AUTHOR">
AUTHOR</a></h2>
<p>Written by Robert Van Dam, toenail (at) cif.rochester.edu </p>

<p>Definition at line <a class="el" href="ProblemSetDetail_8pm_source.html#l00035">35</a> of file <a class="el" href="ProblemSetDetail_8pm_source.html">ProblemSetDetail.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="a787093cdd71b85e6ab9b7d3e10355684"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::body" ref="a787093cdd71b85e6ab9b7d3e10355684" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::body </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-body' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-body-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-body-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-body-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in body: 551</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a787093cdd71b85e6ab9b7d3e10355684">body</a> {

    my ($self)      = @_;
    my $r           = $self-&gt;r;
    my $db          = $r-&gt;db;
    my $ce          = $r-&gt;ce;
    my $authz       = $r-&gt;authz;
    my $userID      = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
    my $urlpath     = $r-&gt;urlpath;
    my $courseID    = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
    my $setID       = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);

<span class="preprocessor">    ## we&#39;re now allowing setID to come in as setID,v# to edit a set</span>
<span class="preprocessor"></span><span class="preprocessor">    ##    version; catch this first</span>
<span class="preprocessor"></span>    my $editingSetVersion = 0;
    my $fullSetID = $setID;
    <span class="keywordflow">if</span> ( $setID =~ /,v(\d+)$/ ) {
        $editingSetVersion = $1;
        $setID =~ s/,v(\d+)$<span class="comment">//;</span>
    }

    my $setRecord   = $db-&gt;getGlobalSet($setID) or die $r-&gt;maketext(<span class="stringliteral">&quot;No record for global set [_1].&quot;</span>, $setID);

    my $userRecord = $db-&gt;getUser($userID) or die $r-&gt;maketext(<span class="stringliteral">&quot;No record for user [_1].&quot;</span>, $userID);
<span class="preprocessor">    # Check permissions</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;You are not authorized to access the Instructor tools.&quot;</span>))
        unless $authz-&gt;hasPermissions($userRecord-&gt;user_id, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
    
    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;You are not authorized to modify problems.&quot;</span>))
        unless $authz-&gt;hasPermissions($userRecord-&gt;user_id, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>);

    my @editForUser = $r-&gt;param(<span class="stringliteral">&#39;editForUser&#39;</span>);

    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Versions of a set can only be edited for one user at a time.&quot;</span>)) <span class="keywordflow">if</span> ( $editingSetVersion &amp;&amp; @editForUser != 1 );

<span class="preprocessor">    # Check that every user that we&#39;re editing for has a valid UserSet</span>
<span class="preprocessor"></span>    my @assignedUsers;
    my @unassignedUsers;
    <span class="keywordflow">if</span> (scalar @editForUser) {
        <span class="keywordflow">foreach</span> my $ID (@editForUser) {
<span class="preprocessor">            # DBFIXME iterator</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ($db-&gt;getUserSet($ID, $setID)) {
                unshift @assignedUsers, $ID;
            } <span class="keywordflow">else</span> {
                unshift @unassignedUsers, $ID;
            }
        }
        @editForUser = sort @assignedUsers;
        $r-&gt;param(<span class="stringliteral">&quot;editForUser&quot;</span>, \@editForUser);
        
        <span class="keywordflow">if</span> (scalar @editForUser &amp;&amp; scalar @unassignedUsers) {
            print CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;The following users are NOT assigned to this set and will be ignored: [_1]&quot;</span>, CGI::b(join(<span class="stringliteral">&quot;, &quot;</span>, @unassignedUsers))) );
        } elsif (scalar @editForUser == 0) {
            print CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;None of the selected users are assigned to this set: [_1]&quot;</span>, CGI::b(join(<span class="stringliteral">&quot;, &quot;</span>, @unassignedUsers))));
            print CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Global set data will be shown instead of user specific data&quot;</span>));
        }       
    }

<span class="preprocessor">    # some useful booleans</span>
<span class="preprocessor"></span>    my $forUsers    = scalar(@editForUser);
    my $forOneUser  = $forUsers == 1;

<span class="preprocessor">    # and check that if we&#39;re editing a set version for a user, that</span>
<span class="preprocessor"></span><span class="preprocessor">    #    it exists as well</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $editingSetVersion &amp;&amp; ! $db-&gt;existsSetVersion( $editForUser[0], $setID, $editingSetVersion ) ) {
        <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;The set-version ([_1], version [_2]) is not assigned to user [_3].&quot;</span>, $setID, $editingSetVersion, $editForUser[0]));
    }

<span class="preprocessor">    # If you&#39;re editing for users, initially their records will be different but</span>
<span class="preprocessor"></span><span class="preprocessor">    # if you make any changes to them they will be the same.</span>
<span class="preprocessor"></span><span class="preprocessor">    # if you&#39;re editing for one user, the problems shown should be his/hers</span>
<span class="preprocessor"></span>    my $userToShow        = $forUsers ? $editForUser[0] : $userID;

<span class="preprocessor">    # a useful gateway variable</span>
<span class="preprocessor"></span>    my $isGatewaySet = ( $setRecord-&gt;assignment_type =~ /gateway/ ) ? 1 : 0;
    
<span class="preprocessor">    # DBFIXME no need to get ID lists -- counts would be fine</span>
<span class="preprocessor"></span>    my $userCount        = $db-&gt;listUsers();
    my $setCount         = $db-&gt;listGlobalSets(); # <span class="keywordflow">if</span> $forOneUser;
    my $setUserCount     = $db-&gt;countSetUsers($setID);
<span class="preprocessor"># if $forOneUser;</span>
<span class="preprocessor"></span>    my $userSetCount     = ($forOneUser &amp;&amp; @editForUser) ? $db-&gt;countUserSets($editForUser[0]) : 0;

    
    my $editUsersAssignedToSetURL = $self-&gt;systemLink(
          $urlpath-&gt;newFromModule(
                <span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::UsersAssignedToSet&quot;</span>, $r,
                  courseID =&gt; $courseID, setID =&gt; $setID));
    my $editSetsAssignedToUserURL = $self-&gt;systemLink(
          $urlpath-&gt;newFromModule(
                <span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::UserDetail&quot;</span>,$r,
                  courseID =&gt; $courseID, userID =&gt; $editForUser[0])) <span class="keywordflow">if</span> $forOneUser;


    my $setDetailPage  = $urlpath -&gt; newFromModule($urlpath-&gt;module, $r, courseID =&gt; $courseID, setID =&gt; $setID);
    my $fullsetDetailPage  = $urlpath -&gt; newFromModule($urlpath-&gt;module, $r, courseID =&gt; $courseID, setID =&gt; $fullSetID);
    my $setDetailURL   = $self-&gt;systemLink($fullsetDetailPage, authen=&gt;0);

    my $userCountMessage = CGI::a({href=&gt;$editUsersAssignedToSetURL}, $self-&gt;userCountMessage($setUserCount, $userCount));
    my $setCountMessage = CGI::a({href=&gt;$editSetsAssignedToUserURL}, $self-&gt;setCountMessage($userSetCount, $setCount)) <span class="keywordflow">if</span> $forOneUser;

    $userCountMessage = $r-&gt;maketext(<span class="stringliteral">&quot;The set [_1] is assigned to [_2].&quot;</span>, $setID, $userCountMessage);
    $setCountMessage  = $r-&gt;maketext(<span class="stringliteral">&quot;The user [_1] has been assigned [_2].&quot;</span>, $editForUser[0], $setCountMessage) <span class="keywordflow">if</span> $forOneUser;

    <span class="keywordflow">if</span> ($forUsers) {
<span class="preprocessor">        ##############################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # calculate links for the users being edited:</span>
<span class="preprocessor"></span><span class="preprocessor">        ##############################################</span>
<span class="preprocessor"></span>        my @userLinks = ();
        <span class="keywordflow">foreach</span> my $userID (@editForUser) {
            my $u = $db-&gt;getUser($userID);
            my $email_address = $u-&gt;email_address;
            my $line = $u-&gt;last_name.<span class="stringliteral">&quot;, &quot;</span> . $u-&gt;first_name . <span class="stringliteral">&quot;&amp;nbsp;&amp;nbsp;(&quot;</span> .
                CGI::a({-href=&gt;<span class="stringliteral">&quot;mailto:$email_address&quot;</span>},<span class="stringliteral">&quot;email &quot;</span>). $u-&gt;user_id .
                <span class="stringliteral">&quot;). &quot;</span>;
            if ( ! $editingSetVersion ) {
                $line .= $r-&gt;maketext(<span class="stringliteral">&quot;Assigned to &quot;</span>);
                my $editSetsAssignedToUserURL = $self-&gt;systemLink(
                    $urlpath-&gt;newFromModule(
                        <span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::UserDetail&quot;</span>, $r,
                                courseID =&gt; $courseID, userID =&gt; $u-&gt;user_id));
                        $line .= CGI::a({href=&gt;$editSetsAssignedToUserURL}, 
                                $self-&gt;setCountMessage($db-&gt;countUserSets($u-&gt;user_id), 
                        $setCount));
            } <span class="keywordflow">else</span> {
                my $editSetLink = $self-&gt;systemLink( $setDetailPage,
                    params=&gt;{effectiveUser=&gt;$u-&gt;user_id,
                         editForUser  =&gt;$u-&gt;user_id} );
                $line .= $r-&gt;maketext(<span class="stringliteral">&quot;Edit set [_1] for this user.&quot;</span>, CGI::a({href=&gt;$editSetLink},$setID));
            }
            unshift @userLinks,$line;
        }
        @userLinks = sort @userLinks;
    
<span class="preprocessor">        # handy messages when editing gateway sets</span>
<span class="preprocessor"></span>        my $gwmsg = ( $isGatewaySet &amp;&amp; ! $editingSetVersion ) ?
            CGI::br() . CGI::em($r-&gt;maketext(<span class="stringliteral">&quot;To edit a specific student version of this set, edit (all of) her/his assigned sets.&quot;</span>)) : <span class="stringliteral">&quot;&quot;</span>;
        my $vermsg = ( $editingSetVersion ) ? <span class="stringliteral">&quot;, $editingSetVersion&quot;</span> : <span class="stringliteral">&quot;&quot;</span>;

        print CGI::table({border=&gt;2,cellpadding=&gt;10}, 
            CGI::Tr({},
                CGI::td([
                     $r-&gt;maketext(<span class="stringliteral">&quot;Editing problem set [_1] data for these individual students: [_2]&quot;</span>, CGI::strong($setID . $vermsg), CGI::br().CGI::strong(join CGI::br(), @userLinks)),
                    CGI::a({href=&gt;$self-&gt;systemLink($setDetailPage) },$r-&gt;maketext(<span class="stringliteral">&quot;Edit set [_1] data for ALL students assigned to this set.&quot;</span>, CGI::strong($setID))) . $gwmsg,
                
                ])
            )
        );
    } <span class="keywordflow">else</span> {
        print CGI::table({border=&gt;2,cellpadding=&gt;10}, 
            CGI::Tr({},
                CGI::td([
                    $r-&gt;maketext(<span class="stringliteral">&quot;This set [_1] is assigned to [_2].&quot;</span>, CGI::strong($setID), $self-&gt;userCountMessage($setUserCount, $userCount)) ,
                    $r-&gt;maketext(<span class="stringliteral">&quot;Edit [_1] of set [_2].&quot;</span>, CGI::a({href=&gt;$editUsersAssignedToSetURL},$r-&gt;maketext(<span class="stringliteral">&#39;individual versions&#39;</span>)), $setID),
                
                ])
            )
        );
    }
    
<span class="preprocessor">    # handle renumbering of problems if necessary</span>
<span class="preprocessor"></span>    print CGI::a({name=&gt;<span class="stringliteral">&quot;problems&quot;</span>});

    my %newProblemNumbers = ();
    my $maxProblemNumber = -1;
    <span class="keywordflow">for</span> my $jj (sort { $a &lt;=&gt; $b } $db-&gt;listGlobalProblems($setID)) {
        $newProblemNumbers{$jj} = $r-&gt;param(<span class="stringliteral">&#39;problem_num_&#39;</span> . $jj);
        $maxProblemNumber = $jj <span class="keywordflow">if</span> $jj &gt; $maxProblemNumber;
    }

    my $forceRenumber = $r-&gt;param(<span class="stringliteral">&#39;force_renumber&#39;</span>) || 0;
    <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#af3602e0071a8eb6ba6a34499a6c08423">handle_problem_numbers</a>($self,\%newProblemNumbers, $maxProblemNumber, $db, $setID, $forceRenumber) unless defined $r-&gt;param(&#39;undo_changes&#39;);

    my %properties = %{ FIELD_PROPERTIES() };

    my %display_modes = %{WeBWorK::PG::DISPLAY_MODES()};
    my @active_modes = grep { exists $display_modes{$_} } @{$r-&gt;ce-&gt;{pg}-&gt;{displayModes}};
    push @active_modes, $r-&gt;maketext(<span class="stringliteral">&#39;None&#39;</span>);
    my $default_header_mode = $r-&gt;param(<span class="stringliteral">&#39;header.displaymode&#39;</span>) || $r-&gt;maketext(<span class="stringliteral">&#39;None&#39;</span>);
    my $default_problem_mode = $r-&gt;param(<span class="stringliteral">&#39;problem.displaymode&#39;</span>) || $r-&gt;maketext(<span class="stringliteral">&#39;None&#39;</span>);

<span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Browse available header/problem files</span>
<span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span>    
    my $templates = $r-&gt;ce-&gt;{courseDirs}-&gt;{templates};
    my $skip = join(<span class="stringliteral">&quot;|&quot;</span>, keys %{ $r-&gt;ce-&gt;{courseFiles}-&gt;{problibs} });

    my @headerFileList = listFilesRecursive(
        $templates,
        qr/<a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad1905f1621af61ea10def7aae24b7b8b">header</a>.*\.pg$/i,         # match these files
        qr/^(?:$skip|svn)$/,    # prune these directories
        0,              # match against file name only
        1,              # prune against path relative to $templates
    );
  @headerFileList = sortByName(undef,@headerFileList);
 
<span class="preprocessor">    # Display a useful warning message</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ($forUsers) {
        print CGI::p(CGI::b($r-&gt;maketext(<span class="stringliteral">&quot;Any changes made below will be reflected in the set for ONLY the student(s) listed above.&quot;</span>)));
    } <span class="keywordflow">else</span> {
        print CGI::p(CGI::b($r-&gt;maketext(<span class="stringliteral">&quot;Any changes made below will be reflected in the set for ALL students.&quot;</span>)));
    }

    print CGI::start_form({method=&gt;<span class="stringliteral">&quot;POST&quot;</span>, action=&gt;$setDetailURL});
    print $self-&gt;hiddenEditForUserFields(@editForUser);
    print $self-&gt;hidden_authen_fields;
    print CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, name=&gt;<span class="stringliteral">&quot;submit_changes&quot;</span>, value=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Save Changes&quot;</span>)});
    print CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, name=&gt;<span class="stringliteral">&quot;undo_changes&quot;</span>, value =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Reset Form&quot;</span>)});

<span class="preprocessor">    # spacing</span>
<span class="preprocessor"></span>    print CGI::p();
    
<span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Display general set information</span>
<span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span>
    print CGI::start_table({border=&gt;1, cellpadding=&gt;4});
    print CGI::Tr({}, CGI::th({}, [
        $r-&gt;maketext(<span class="stringliteral">&quot;General Information&quot;</span>),
    ]));
    
<span class="preprocessor">    # this is kind of a hack -- we need to get a user record here, so we can</span>
<span class="preprocessor"></span><span class="preprocessor">    # pass it to FieldTable, so FieldTable can pass it to FieldHTML, so</span>
<span class="preprocessor"></span><span class="preprocessor">    # FieldHTML doesn&#39;t have to fetch it itself.</span>
<span class="preprocessor"></span>    my $userSetRecord = $db-&gt;getUserSet($userToShow, $setID);

    my $templateUserSetRecord;
<span class="preprocessor">    # send in the set version if we&#39;re editing for versions</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $editingSetVersion ) {
        $templateUserSetRecord = $userSetRecord;
        $userSetRecord = $db-&gt;getSetVersion( $userToShow, $setID, $editingSetVersion );
    }
    
    print CGI::Tr({}, CGI::td({}, [
        $self-&gt;FieldTable($userToShow, $setID, undef, $setRecord, $userSetRecord),
    ]));
    print CGI::end_table(); 

<span class="preprocessor">    # spacing</span>
<span class="preprocessor"></span>    print CGI::p();

    
<span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Display header information</span>
<span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span>    my @headers = @{ HEADER_ORDER() };
    my %headerModules = (set_header =&gt; <span class="stringliteral">&#39;problem_list&#39;</span>, hardcopy_header =&gt; <span class="stringliteral">&#39;hardcopy_preselect_set&#39;</span>);
    my %headerDefaults = (set_header =&gt; $ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{setHeader}, hardcopy_header =&gt; $ce-&gt;{webworkFiles}-&gt;{hardcopySnippets}-&gt;{setHeader});
    my @headerFiles = map { $setRecord-&gt;{$_} } @headers;
    <span class="keywordflow">if</span> (scalar @headers and not $forUsers) {

        print CGI::start_table({border=&gt;1, cellpadding=&gt;4});
        print CGI::Tr({}, CGI::th({}, [
            $r-&gt;maketext(<span class="stringliteral">&quot;Headers&quot;</span>),
<span class="preprocessor">#           &quot;Data&quot;,</span>
<span class="preprocessor"></span>            <span class="stringliteral">&quot;Display&amp;nbsp;Mode:&amp;nbsp;&quot;</span> . 
            CGI::popup_menu(-name =&gt; <span class="stringliteral">&quot;header.displaymode&quot;</span>, -values =&gt; \@active_modes, -<span class="keywordflow">default</span> =&gt; $default_header_mode) . <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>. 
            CGI::input({type =&gt; <span class="stringliteral">&quot;submit&quot;</span>, name =&gt; <span class="stringliteral">&quot;refresh&quot;</span>, value =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Refresh Display&quot;</span>)}),
        ]));

        my %header_html;
        
        my %error;
        my $this_set = $db-&gt;getMergedSet($userToShow, $setID);
        my $guaranteed_set = $this_set;
        <span class="keywordflow">if</span> ( ! $guaranteed_set ) { 
<span class="preprocessor">            # in the header loop we need to have a set that </span>
<span class="preprocessor"></span><span class="preprocessor">            #    we know exists, so if the getMergedSet failed</span>
<span class="preprocessor"></span><span class="preprocessor">            #    (that is, the set isn&#39;t assigned to the </span>
<span class="preprocessor"></span><span class="preprocessor">            #    the current user), we get the global set instead</span>
<span class="preprocessor"></span><span class="preprocessor">            # $guaranteed_set = $db-&gt;getGlobalSet( $setID );</span>
<span class="preprocessor"></span>            $guaranteed_set = $setRecord;
        }

        <span class="keywordflow">foreach</span> my $headerType (@headers) {

            my $headerFile = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$headerType&quot;</span>) || $setRecord-&gt;{$headerType};

            $headerFile = <span class="stringliteral">&#39;defaultHeader&#39;</span> unless $headerFile =~/\S/; # (some non-white space character required)

            $error{$headerType} = $self-&gt;checkFile($headerFile,$headerType);

            unless ($error{$headerType}) {      
                my @temp = renderProblems(
                    <a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a>=&gt; $r, 
                    user =&gt; $db-&gt;getUser($userToShow),
                    displayMode=&gt; $default_header_mode,
                    problem_number=&gt; 0,
                    this_set =&gt; $this_set,
                    problem_list =&gt; [$headerFile],
                );
                $header_html{$headerType} = $temp[0];   
            }
        }
        
        <span class="keywordflow">foreach</span> my $headerType (@headers) {
    
            my $editHeaderPage = $urlpath-&gt;new(type =&gt; <span class="stringliteral">&#39;instructor_problem_editor_withset_withproblem&#39;</span>, args =&gt; { courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt; 0 });
            my $editHeaderLink = $self-&gt;systemLink($editHeaderPage, params =&gt; { file_type =&gt; $headerType, make_local_copy =&gt; 1 });

            my $viewHeaderPage = $urlpath-&gt;new(type =&gt; $headerModules{$headerType}, args =&gt; { courseID =&gt; $courseID, setID =&gt; $setID });    
            my $viewHeaderLink = $self-&gt;systemLink($viewHeaderPage);
            
<span class="preprocessor">            # this is a bit of a hack; the set header isn&#39;t shown</span>
<span class="preprocessor"></span><span class="preprocessor">            #    for gateway tests, and we run into trouble trying to </span>
<span class="preprocessor"></span><span class="preprocessor">            #    edit/view it in this context, so we don&#39;t show this </span>
<span class="preprocessor"></span><span class="preprocessor">            #    field for gateway tests</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $headerType eq <span class="stringliteral">&#39;set_header&#39;</span> &amp;&amp; 
                     $guaranteed_set-&gt;assignment_type =~ /gateway/ ) {
                print CGI::Tr({}, CGI::td({}, 
                          [ $r-&gt;maketext(<span class="stringliteral">&quot;Set Header&quot;</span>), 
                            $r-&gt;maketext(<span class="stringliteral">&quot;Set headers are not used in display of gateway tests.&quot;</span>)]));
                next;
            }

            print CGI::Tr({}, CGI::td({}, [
                CGI::start_table({border =&gt; 0, cellpadding =&gt; 0}) . 
                    CGI::Tr({}, CGI::td({}, $properties{$headerType}-&gt;{name})) . 
                    CGI::Tr({}, CGI::td({}, CGI::a({href =&gt; $editHeaderLink, target=&gt;<span class="stringliteral">&quot;WW_Editor&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Edit it&quot;</span>)))) .
                    CGI::Tr({}, CGI::td({}, CGI::a({href =&gt; $viewHeaderLink, target=&gt;<span class="stringliteral">&quot;WW_View&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;View it&quot;</span>)))) .
                CGI::end_table(),

                comboBox({
                    name =&gt; <span class="stringliteral">&quot;set.$setID.$headerType&quot;</span>,
                    request =&gt; $r,
                    <span class="keywordflow">default</span> =&gt; $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$headerType&quot;</span>) || $setRecord-&gt;{$headerType}  || <span class="stringliteral">&quot;defaultHeader&quot;</span>,
                    multiple =&gt; 0,
                    values =&gt; [<span class="stringliteral">&quot;defaultHeader&quot;</span>, @headerFileList],
                    labels =&gt; { <span class="stringliteral">&quot;defaultHeader&quot;</span> =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Use Default Header File&quot;</span>) },
                }) .
                ($error{$headerType} ? 
                    CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>, style=&gt;<span class="stringliteral">&quot;font-weight: bold&quot;</span>}, $error{$headerType}) 
                    : CGI::div({<span class="keyword">class</span>=&gt; <span class="stringliteral">&quot;RenderSolo&quot;</span>}, $header_html{$headerType}-&gt;{body_text})
                ),
            ]));
        }
        
        print CGI::end_table();
    } <span class="keywordflow">else</span> {
        print CGI::p(CGI::b($r-&gt;maketext(<span class="stringliteral">&quot;Screen and Hardcopy set header information can not be overridden for individual students.&quot;</span>)));
    }

<span class="preprocessor">    # spacing</span>
<span class="preprocessor"></span>    print CGI::p();


<span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Display problem information</span>
<span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span>
    my @problemIDList = sort { $a &lt;=&gt; $b } $db-&gt;listGlobalProblems($setID);
    
<span class="preprocessor">    # DBFIXME use iterators instead of getting all at once</span>
<span class="preprocessor"></span>    
<span class="preprocessor">    # get global problem records for all problems in one go</span>
<span class="preprocessor"></span>    my %GlobalProblems;
    my @globalKeypartsRef = map { [$setID, $_] } @problemIDList;
<span class="preprocessor">    # DBFIXME shouldn&#39;t need to get key list here</span>
<span class="preprocessor"></span>    @GlobalProblems{@problemIDList} = $db-&gt;getGlobalProblems(@globalKeypartsRef);
    
<span class="preprocessor">    # if needed, get user problem records for all problems in one go</span>
<span class="preprocessor"></span>    my (%UserProblems, %MergedProblems);
    <span class="keywordflow">if</span> ($forOneUser) {
        my @userKeypartsRef = map { [$editForUser[0], $setID, $_] } @problemIDList;
<span class="preprocessor">        # DBFIXME shouldn&#39;t need to get key list here</span>
<span class="preprocessor"></span>        @UserProblems{@problemIDList} = $db-&gt;getUserProblems(@userKeypartsRef);
        <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
            @MergedProblems{@problemIDList} = $db-&gt;getMergedProblems(@userKeypartsRef);
        } <span class="keywordflow">else</span> {
            my @userversionKeypartsRef = map { [$editForUser[0], $setID, $editingSetVersion, $_] } @problemIDList;
            @MergedProblems{@problemIDList} = $db-&gt;getMergedProblemVersions(@userversionKeypartsRef);
        }
    }
    
    <span class="keywordflow">if</span> (scalar @problemIDList) {

        print CGI::start_table({border=&gt;1, cellpadding=&gt;4});
        print CGI::Tr({}, CGI::th({}, [
            $r-&gt;maketext(<span class="stringliteral">&quot;Problems&quot;</span>),
            $r-&gt;maketext(<span class="stringliteral">&quot;Data&quot;</span>),
            <span class="stringliteral">&quot;Display&amp;nbsp;Mode:&amp;nbsp;&quot;</span> . 
            CGI::popup_menu(-name =&gt; <span class="stringliteral">&quot;problem.displaymode&quot;</span>, -values =&gt; \@active_modes, -<span class="keywordflow">default</span> =&gt; $default_problem_mode) . <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>. 
            CGI::input({type =&gt; <span class="stringliteral">&quot;submit&quot;</span>, name =&gt; <span class="stringliteral">&quot;refresh&quot;</span>, value =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Refresh Display&quot;</span>)}),
        ]));
        
        my %shownYet;
        my $repeatFile;

        <span class="keywordflow">foreach</span> my $problemID (@problemIDList) {
        
            my $problemRecord;
            <span class="keywordflow">if</span> ($forOneUser) {
<span class="preprocessor">                #$problemRecord = $db-&gt;getMergedProblem($editForUser[0], $setID, $problemID);</span>
<span class="preprocessor"></span>                $problemRecord = $MergedProblems{$problemID}; # already fetched above --sam
            } <span class="keywordflow">else</span> {
<span class="preprocessor">                #$problemRecord = $db-&gt;getGlobalProblem($setID, $problemID);</span>
<span class="preprocessor"></span>                $problemRecord = $GlobalProblems{$problemID}; # already fetched above --sam
            }

<span class="preprocessor">            #$self-&gt;addgoodmessage(&quot;&quot;);</span>
<span class="preprocessor"></span><span class="preprocessor">            #$self-&gt;addbadmessage($problemRecord-&gt;toString());</span>
<span class="preprocessor"></span>
<span class="preprocessor">            # when we&#39;re editing a set version, we want to be sure to</span>
<span class="preprocessor"></span><span class="preprocessor">            #    use the merged problem in the edit, because we could</span>
<span class="preprocessor"></span><span class="preprocessor">            #    be using problem groups (for which the problem is generated</span>
<span class="preprocessor"></span><span class="preprocessor">            #    and then stored in the problem version)</span>
<span class="preprocessor"></span>            my $problemToShow = ( $editingSetVersion ) ?
                $MergedProblems{$problemID} : $UserProblems{$problemID};

            my ( $editProblemPage, $editProblemLink, $viewProblemPage,
                 $viewProblemLink );
            <span class="keywordflow">if</span> ( $isGatewaySet ) {
                $editProblemPage = $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;instructor_problem_editor_withset_withproblem&#39;</span>, args =&gt; { courseID =&gt; $courseID, setID =&gt; $fullSetID, problemID =&gt; $problemID });
                $editProblemLink = $self-&gt;systemLink($editProblemPage, params =&gt; { make_local_copy =&gt; 0 });
                $viewProblemPage =
                    $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;gateway_quiz&#39;</span>,
                              args =&gt; { courseID =&gt; $courseID,
                                setID =&gt; <span class="stringliteral">&quot;Undefined_Set&quot;</span>,
                                problemID =&gt; <span class="stringliteral">&quot;1&quot;</span> } );

                my $seed = $problemToShow ? $problemToShow-&gt;problem_seed : <span class="stringliteral">&quot;&quot;</span>;
                my $file = $problemToShow ? $problemToShow-&gt;source_file : 
                    $GlobalProblems{$problemID}-&gt;source_file;

                $viewProblemLink =
                    $self-&gt;systemLink( $viewProblemPage,
                        params =&gt; { effectiveUser =&gt;
                                ($forOneUser ? $editForUser[0] : $userID),
                                problemSeed =&gt; $seed,
                                sourceFilePath =&gt; $file });
            } <span class="keywordflow">else</span> {
                $editProblemPage = $urlpath-&gt;new(type =&gt; <span class="stringliteral">&#39;instructor_problem_editor_withset_withproblem&#39;</span>, args =&gt; { courseID =&gt; $courseID, setID =&gt; $fullSetID, problemID =&gt; $problemID });
                $editProblemLink = $self-&gt;systemLink($editProblemPage, params =&gt; { make_local_copy =&gt; 0 });
<span class="preprocessor">            # FIXME: should we have an &quot;act as&quot; type link here when editing for multiple users?     </span>
<span class="preprocessor"></span>                $viewProblemPage = $urlpath-&gt;new(type =&gt; <span class="stringliteral">&#39;problem_detail&#39;</span>, args =&gt; { courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt; $problemID });
                $viewProblemLink = $self-&gt;systemLink($viewProblemPage, params =&gt; { effectiveUser =&gt; ($forOneUser ? $editForUser[0] : $userID)});
            }

    
            my $problemFile = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.source_file&quot;</span>) || $problemRecord-&gt;source_file;
            $problemFile =~ s|^/||;
            $problemFile =~ s|\.\.||g;
<span class="preprocessor">            # warn of repeat problems</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> (defined $shownYet{$problemFile}) {
                $repeatFile = $r-&gt;maketext(<span class="stringliteral">&quot;This problem uses the same source file as number [_1].&quot;</span>, $shownYet{$problemFile});
            } <span class="keywordflow">else</span> {
                $shownYet{$problemFile} = $problemID;
                $repeatFile = <span class="stringliteral">&quot;&quot;</span>;
            }
            
            my $error = $self-&gt;checkFile($problemFile, undef);
            my $this_set = $db-&gt;getMergedSet($userToShow, $setID);
            my @problem_html;
            unless ($error) {
                @problem_html = renderProblems(
                    <a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a>=&gt; $r, 
                    user =&gt; $db-&gt;getUser($userToShow),
                    displayMode=&gt; $default_problem_mode,
                    problem_number=&gt; $problemID,
                    this_set =&gt; $this_set,
                    problem_seed =&gt; $forOneUser ? $problemRecord-&gt;problem_seed : 0,
                    problem_list =&gt; [$problemFile],     #  [$problemRecord-&gt;source_file],
                );
            }

<span class="preprocessor">            # we want to show the &quot;Try It&quot; and &quot;Edit It&quot; links if there&#39;s a </span>
<span class="preprocessor"></span><span class="preprocessor">            #    well defined problem to view; this is when we&#39;re editing a </span>
<span class="preprocessor"></span><span class="preprocessor">            #    homework set, or if we&#39;re editing a gateway set version, or </span>
<span class="preprocessor"></span><span class="preprocessor">            #    if we&#39;re editing a gateway set and the problem is not a </span>
<span class="preprocessor"></span><span class="preprocessor">            #    group problem</span>
<span class="preprocessor"></span>            my $showLinks = ( ! $isGatewaySet || 
                      ( $editingSetVersion || $problemFile !~ /^group/ ));


            print CGI::Tr({}, CGI::td({}, [
                CGI::start_table({border =&gt; 0, cellpadding =&gt; 1}) .
                    CGI::Tr({}, CGI::td({}, <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a79607043dba76c6b5f55ee30e488622a">problem_number_popup</a>($problemID, $maxProblemNumber))) .
                    CGI::Tr({}, CGI::td({}, 
                                $showLinks ? CGI::a({href =&gt; $editProblemLink, target=&gt;<span class="stringliteral">&quot;WW_Editor&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Edit it&quot;</span>)) : <span class="stringliteral">&quot;&quot;</span> )) .
                    CGI::Tr({}, CGI::td({}, 
                                $showLinks ? CGI::a({href =&gt; $viewProblemLink, target=&gt;<span class="stringliteral">&quot;WW_View&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Try it&quot;</span>) . ($forOneUser ? <span class="stringliteral">&quot; (as $editForUser[0])&quot;</span> : <span class="stringliteral">&quot;&quot;</span>)) : <span class="stringliteral">&quot;&quot;</span> )) .
                    ($forUsers ? <span class="stringliteral">&quot;&quot;</span> : CGI::Tr({}, CGI::td({}, CGI::checkbox({name =&gt; <span class="stringliteral">&quot;deleteProblem&quot;</span>, value =&gt; $problemID, label =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Delete it?&quot;</span>)})))) .
#                   CGI::Tr({}, CGI::td({}, <span class="stringliteral">&quot;Delete&amp;nbsp;it?&quot;</span> . CGI::input({type =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>, name =&gt; <span class="stringliteral">&quot;deleteProblem&quot;</span>, value =&gt; $problemID}))) .
                    ($forOneUser ? <span class="stringliteral">&quot;&quot;</span> : CGI::Tr({}, CGI::td({}, CGI::checkbox({name =&gt; <span class="stringliteral">&quot;markCorrect&quot;</span>, value =&gt; $problemID, label =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Mark Correct?&quot;</span>)})))) .
                CGI::end_table(),
                $self-&gt;FieldTable($userToShow, $setID, $problemID, $GlobalProblems{$problemID}, $problemToShow, $isGatewaySet),
# A comprehensive list of problems is just TOO big to be handled well
#               comboBox({
<span class="preprocessor">#                   name =&gt; &quot;set.$setID.$problemID&quot;,</span>
<span class="preprocessor"></span><span class="preprocessor">#                   request =&gt; $r,</span>
<span class="preprocessor"></span><span class="preprocessor">#                   default =&gt; $problemRecord-&gt;{problem_id},</span>
<span class="preprocessor"></span><span class="preprocessor">#                   multiple =&gt; 0,</span>
<span class="preprocessor"></span><span class="preprocessor">#                   values =&gt; \@problemFileList,</span>
<span class="preprocessor"></span><span class="preprocessor">#               }) .</span>
<span class="preprocessor"></span>                
                join (<span class="stringliteral">&quot;\n&quot;</span>, $self-&gt;FieldHTML(
                    $userToShow,
                    $setID,
                    $problemID,
                    $GlobalProblems{$problemID}, # pass previously fetched global record to FieldHTML --sam
                    $problemToShow, # pass previously fetched user record to FieldHTML --sam
                    <span class="stringliteral">&quot;source_file&quot;</span>
                )) .
                        CGI::br() . 
                    ($error ? 
                        CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>, style=&gt;<span class="stringliteral">&quot;font-weight: bold&quot;</span>}, $error) 
                        : CGI::div({<span class="keyword">class</span>=&gt; <span class="stringliteral">&quot;RenderSolo&quot;</span>}, $problem_html[0]-&gt;{body_text})
                    ) .
                    ($repeatFile ? CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>, style=&gt;<span class="stringliteral">&quot;font-weight: bold&quot;</span>}, $repeatFile) : <span class="stringliteral">&#39;&#39;</span>),
            ]));
        }

          
<span class="preprocessor"># print final lines</span>
<span class="preprocessor"></span>        print CGI::end_table();
        print CGI::checkbox({
                  label=&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Force problems to be numbered consecutively from one (always done when reordering problems)&quot;</span>),
                  name=&gt;<span class="stringliteral">&quot;force_renumber&quot;</span>, value=&gt;<span class="stringliteral">&quot;1&quot;</span>});
        print CGI::p($r-&gt;maketext(<span class="stringliteral">&quot;Any time problem numbers are intentionally changed, the problems will always be renumbered consecutively, starting from one.  When deleting problems, gaps will be left in the numbering unless the box above is checked.&quot;</span>));
        print CGI::p($r-&gt;maketext(<span class="stringliteral">&quot;It is before the open date.  You probably want to renumber the problems if you are deleting some from the middle.&quot;</span>)) <span class="keywordflow">if</span> ($setRecord-&gt;open_date&gt;time());
        print CGI::p($r-&gt;maketext(<span class="stringliteral">&quot;When changing problem numbers, we will move the problem to be [_1] the chosen number.&quot;</span>,CGI::em($r-&gt;maketext(<span class="stringliteral">&quot;before&quot;</span>))));

    } <span class="keywordflow">else</span> {
        print CGI::p(CGI::b($r-&gt;maketext(<span class="stringliteral">&quot;This set doesn&#39;t contain any problems yet.&quot;</span>)));
    }
<span class="preprocessor">    # always allow one to add a new problem, unless we&#39;re editing a set version</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
        print   CGI::checkbox({ label=&gt; <span class="stringliteral">&quot;Add&quot;</span>,
                    name=&gt;<span class="stringliteral">&quot;add_blank_problem&quot;</span>, value=&gt;<span class="stringliteral">&quot;1&quot;</span>}
            ),CGI::input({
                    name=&gt;<span class="stringliteral">&quot;add_n_problems&quot;</span>,
                    size=&gt;2,
                    value=&gt;1 },
                    $r-&gt;maketext(<span class="stringliteral">&quot;blank problem template(s) to end of homework set&quot;</span>)
            );
    }
    print CGI::br(),CGI::br(),
        CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, name=&gt;<span class="stringliteral">&quot;submit_changes&quot;</span>, value=&gt;<span class="stringliteral">&quot;Save Changes&quot;</span>}),
        CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, name=&gt;<span class="stringliteral">&quot;handle_numbers&quot;</span>, value=&gt;<span class="stringliteral">&quot;Reorder problems only&quot;</span>}),
            $r-&gt;maketext(<span class="stringliteral">&quot;(Any unsaved changes will be lost.)&quot;</span>);

<span class="preprocessor">    #my $editNewProblemPage = $urlpath-&gt;new(type =&gt; &#39;instructor_problem_editor_withset_withproblem&#39;, args =&gt; { courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt;&#39;new_problem&#39;    });</span>
<span class="preprocessor"></span><span class="preprocessor">    #my $editNewProblemLink = $self-&gt;systemLink($editNewProblemPage, params =&gt; { make_local_copy =&gt; 1, file_type =&gt; &#39;blank_problem&#39;  });</span>
<span class="preprocessor"></span><span class="preprocessor">    # This next feature isn&#39;t fully supported and is causing problems.  Remove for now.  #FIXME</span>
<span class="preprocessor"></span><span class="preprocessor">    #print CGI::p( CGI::a({href=&gt;$editNewProblemLink},&#39;Edit&#39;). &#39; a new blank problem&#39;);</span>
<span class="preprocessor"></span>
    print CGI::end_form();
    
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ab1d82f7e4749c6674e48c83232fb0d37"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::canChange" ref="ab1d82f7e4749c6674e48c83232fb0d37" args="($$)()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::canChange </td>
          <td>(</td>
          <td class="paramtype">$$&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-canChange($$)' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-canChange($$)-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-canChange($$)-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-canChange($$)-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in canChange($$): 13</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab1d82f7e4749c6674e48c83232fb0d37">canChange</a> ($$) {
    my ($forUsers, $field) = @_;
    
    my %properties = %{ FIELD_PROPERTIES() };
    my $forOneUser = $forUsers == 1;
    
    my $howManyCan = $properties{$field}-&gt;{<span class="keyword">override</span>};
    <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> $howManyCan eq <span class="stringliteral">&quot;none&quot;</span>;
    <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> $howManyCan eq <span class="stringliteral">&quot;any&quot;</span>;   
    <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> $howManyCan eq <span class="stringliteral">&quot;one&quot;</span> &amp;&amp; $forOneUser;
    <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> $howManyCan eq <span class="stringliteral">&quot;all&quot;</span> &amp;&amp; !$forUsers;
    <span class="keywordflow">return</span> 0;   # FIXME: maybe it should <span class="keywordflow">default</span> to 1?
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a3b44dc54c21dddcb3a7823da5e6942cd"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::changed" ref="a3b44dc54c21dddcb3a7823da5e6942cd" args="($$)()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::changed </td>
          <td>(</td>
          <td class="paramtype">$$&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-changed($$)' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-changed($$)-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-changed($$)-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-changed($$)-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in changed($$): 9</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a3b44dc54c21dddcb3a7823da5e6942cd">changed</a> ($$) {
    my ($first, $second) = @_;

    <span class="keywordflow">return</span> <span class="stringliteral">&quot;def/undef&quot;</span> <span class="keywordflow">if</span> defined $first and not defined $second;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;undef/def&quot;</span> <span class="keywordflow">if</span> not defined $first and defined $second;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> not defined $first and not defined $second;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;ne&quot;</span> <span class="keywordflow">if</span> $first ne $second;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;  # <span class="keywordflow">if</span> they<span class="stringliteral">&#39;re equal, there&#39;</span>s no change
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aadca428452b90de028e2fbef3e663488"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::checkFile" ref="aadca428452b90de028e2fbef3e663488" args="($)()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::checkFile </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-checkFile($)' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-checkFile($)-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-checkFile($)-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-checkFile($)-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in checkFile($): 29</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#aadca428452b90de028e2fbef3e663488">checkFile</a> ($) {
    my ($self, $filePath, $headerType) = @_;

    my $r = $self-&gt;r;
    my $ce = $r-&gt;ce;

    <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;No source filePath specified&quot;</span>) unless $filePath;
    <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;Problem source is drawn from a grouping set&quot;</span>) <span class="keywordflow">if</span> $filePath =~ /^group/;
    
    <span class="keywordflow">if</span> ( $filePath eq <span class="stringliteral">&quot;defaultHeader&quot;</span> ) {
        <span class="keywordflow">if</span> ($headerType eq <span class="stringliteral">&#39;set_header&#39;</span>) {
          $filePath = $ce-&gt;{webworkFiles}{screenSnippets}{setHeader};
        } elsif  ($headerType eq <span class="stringliteral">&#39;hardcopy_header&#39;</span>) {
            $filePath = $ce-&gt;{webworkFiles}{hardcopySnippets}{setHeader};
        }   <span class="keywordflow">else</span>    {
            <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;Invalid headerType [_1]&quot;</span>, $headerType);    
        }   
    } <span class="keywordflow">else</span> {
<span class="preprocessor">    #   $filePath = $ce-&gt;{courseDirs}-&gt;{templates} . &#39;/&#39; . $filePath unless $filePath =~ m|^/|; # bug: 1725 allows access to all files e.g. /etc/passwd</span>
<span class="preprocessor"></span>        $filePath = $ce-&gt;{courseDirs}-&gt;{templates} . <span class="charliteral">&#39;/&#39;</span> . $filePath ; # only filePaths in <span class="keyword">template</span> directory can be accessed 
    }
    
    my $fileError;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> -e $filePath &amp;&amp; -f $filePath &amp;&amp; -<a class="code" href="classWeBWorK_1_1ContentGenerator.html#afc1106db125a42082cafaf10746a947b">r</a> $filePath;
    <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;This source file is not readable!&quot;</span>) <span class="keywordflow">if</span> -e $filePath &amp;&amp; -f $filePath;
    <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;This source file is a directory!&quot;</span>) <span class="keywordflow">if</span> -d $filePath;
    <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;This source file does not exist!&quot;</span>) unless -e $filePath;
    <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;This source file is not a plain file!&quot;</span>);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a7ee5d4290cba1647d8d43f7839afb3b4"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::definedness" ref="a7ee5d4290cba1647d8d43f7839afb3b4" args="($)()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::definedness </td>
          <td>(</td>
          <td class="paramtype">$&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-definedness($)' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-definedness($)-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-definedness($)-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-definedness($)-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in definedness($): 7</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a7ee5d4290cba1647d8d43f7839afb3b4">definedness</a> ($) {
    my ($variable) = @_;

    <span class="keywordflow">return</span> <span class="stringliteral">&quot;undefined&quot;</span> unless defined $variable;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;empty&quot;</span> unless $variable ne <span class="stringliteral">&quot;&quot;</span>;
    <span class="keywordflow">return</span> $variable;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ae5d24a5582c5e9f6e36dcf3090d8d94d"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::extraSetFields" ref="ae5d24a5582c5e9f6e36dcf3090d8d94d" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::extraSetFields </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-extraSetFields' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-extraSetFields-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-extraSetFields-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-extraSetFields-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in extraSetFields: 106</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ae5d24a5582c5e9f6e36dcf3090d8d94d">extraSetFields</a> {
    my ($self,$userID,$setID,$globalRecord,$userRecord,$forUsers) = @_;
    my $db = $self-&gt;r-&gt;{db};
    my $r = $self-&gt;r;

    my ($gwFields, $ipFields, $ipDefaults, $numLocations, $ipOverride,
        $procFields) = ( <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span> );

<span class="preprocessor">    # if we&#39;re dealing with a gateway, set up a table of gateway fields</span>
<span class="preprocessor"></span>    my $nF = 0;  # <span class="keyword">this</span> is the number of columns in the <span class="keyword">set</span> field table
    <span class="keywordflow">if</span> ( $globalRecord-&gt;assignment_type() =~ /gateway/ ) {
        my $gwhdr = <span class="stringliteral">&quot;\n&lt;!-- begin gwoutput table --&gt;\n&quot;</span>;

        <span class="keywordflow">foreach</span> my $gwfield ( @{ GATEWAY_SET_FIELD_ORDER() } ) {

<span class="preprocessor">            # don&#39;t show template gateway fields when editing</span>
<span class="preprocessor"></span><span class="preprocessor">            #    set versions</span>
<span class="preprocessor"></span>            next <span class="keywordflow">if</span> ( ( $gwfield eq <span class="stringliteral">&quot;time_interval&quot;</span> ||
                    $gwfield eq <span class="stringliteral">&quot;versions_per_interval&quot;</span> ) &amp;&amp;
                  ( $forUsers &amp;&amp;
                    $userRecord-&gt;can(<span class="stringliteral">&#39;version_id&#39;</span>) ) );

            my @fieldData = 
                ($self-&gt;FieldHTML($userID, $setID, undef, 
                          $globalRecord, $userRecord, 
                          $gwfield));
            <span class="keywordflow">if</span> ( @fieldData &amp;&amp; defined($fieldData[1]) and 
                 $fieldData[1] ne <span class="stringliteral">&#39;&#39;</span> ) {
                $nF = @fieldData <span class="keywordflow">if</span> ( @fieldData &gt; $nF );
                $gwFields .= CGI::Tr({}, 
                    CGI::td({}, [@fieldData]));
                }
        }
        $gwhdr .= CGI::Tr({},CGI::td({colspan=&gt;$nF}, 
                         CGI::em($r-&gt;maketext(<span class="stringliteral">&quot;Gateway parameters&quot;</span>))))
            <span class="keywordflow">if</span> ( $nF );
        $gwFields = <span class="stringliteral">&quot;$gwhdr$gwFields\n&quot;</span> .
            <span class="stringliteral">&quot;&lt;!-- end gwoutput table --&gt;\n&quot;</span>;
    }

<span class="preprocessor">    # if we have a proctored test, then also generate a proctored </span>
<span class="preprocessor"></span><span class="preprocessor">    #    set password input </span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $globalRecord-&gt;assignment_type eq <span class="stringliteral">&#39;proctored_gateway&#39;</span> &amp;&amp; ! $forUsers ) {
        my $nfm1 = $nF - 1;
        $procFields = CGI::Tr({},CGI::td({},<span class="stringliteral">&#39;&#39;</span>),
            CGI::td({colspan=&gt;$nfm1},
                CGI::em($r-&gt;maketext(<span class="stringliteral">&quot;Proctored tests require proctor authorization to start and to grade.  Provide a password to have a single password for all students to start a proctored test.&quot;</span>))));
<span class="preprocessor">        # we use a routine other than FieldHTML because of getting</span>
<span class="preprocessor"></span><span class="preprocessor">        #    the default value here</span>
<span class="preprocessor"></span>        my @fieldData = 
            $self-&gt;proctoredFieldHTML($userID, $setID, 
                          $globalRecord);
        $procFields .= CGI::Tr({}, 
            CGI::td({}, [@fieldData]));
    }

<span class="preprocessor">    # finally, figure out what ip selector fields we want to include</span>
<span class="preprocessor"></span>    my @locations = sort {$a cmp $b} ($db-&gt;listLocations());
    $numLocations = @locations;

<span class="preprocessor">    # we don&#39;t show ip selector fields if we&#39;re editing a set version</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! defined( $userRecord ) ||
         ( defined( $userRecord ) &amp;&amp; ! $userRecord-&gt;can(<span class="stringliteral">&quot;version_id&quot;</span>) ) ) {
        <span class="keywordflow">if</span> ( ( ! $forUsers &amp;&amp; $globalRecord-&gt;restrict_ip &amp;&amp;
               $globalRecord-&gt;restrict_ip ne <span class="stringliteral">&#39;No&#39;</span> ) ||
             ( $forUsers &amp;&amp; $userRecord-&gt;restrict_ip ne <span class="stringliteral">&#39;No&#39;</span> ) ) {

            my @globalLocations = $db-&gt;listGlobalSetLocations($setID);
<span class="preprocessor">            # what ip locations should be selected?</span>
<span class="preprocessor"></span>            my @defaultLocations = ();
            <span class="keywordflow">if</span> ( $forUsers &amp;&amp; 
                 ! $db-&gt;countUserSetLocations($userID, $setID) ) { 
                @defaultLocations = @globalLocations;
                $ipOverride = 0;
            } elsif ( $forUsers ) {
                @defaultLocations = $db-&gt;listUserSetLocations($userID, $setID);
                $ipOverride = 1;
            } <span class="keywordflow">else</span> {
                @defaultLocations = @globalLocations;
            }
            my $ipDefaults = join(<span class="stringliteral">&#39;, &#39;</span>, @globalLocations);

            my $ipSelector = CGI::scrolling_list({
                -name =&gt; <span class="stringliteral">&quot;set.$setID.selected_ip_locations&quot;</span>,
                -values =&gt; [ @locations ], 
                -<span class="keywordflow">default</span> =&gt; [ @defaultLocations ], 
                -size =&gt; 5,
                -multiple =&gt; <span class="stringliteral">&#39;true&#39;</span>});

            my $override = ($forUsers) ? 
                CGI::checkbox({ type =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>,
                    name =&gt; <span class="stringliteral">&quot;set.$setID.selected_ip_locations.override&quot;</span>,
                    label =&gt; <span class="stringliteral">&quot;&quot;</span>,
                    checked =&gt; $ipOverride }) : <span class="stringliteral">&#39;&#39;</span>;
            $ipFields .= CGI::Tr({-valign=&gt;<span class="stringliteral">&#39;top&#39;</span>},
                         CGI::td({}, [ $override, 
                           $r-&gt;maketext(<span class="stringliteral">&#39;Restrict Locations&#39;</span>), 
                           $ipSelector, 
                           $forUsers ? 
                           <span class="stringliteral">&quot; $ipDefaults&quot;</span> : <span class="stringliteral">&#39;&#39;</span>, ]
                    ),
            );
        }
    }
    <span class="keywordflow">return</span>($gwFields, $ipFields, $numLocations, $procFields);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a535d98ecb64ab8a73f0503d73af161fe"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::FieldHTML" ref="a535d98ecb64ab8a73f0503d73af161fe" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::FieldHTML </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-FieldHTML' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-FieldHTML-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-FieldHTML-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-FieldHTML-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in FieldHTML: 148</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a535d98ecb64ab8a73f0503d73af161fe">FieldHTML</a> {
    my ($self, $userID, $setID, $problemID, $globalRecord, $userRecord, $field) = @_;
    
    my $r = $self-&gt;r;
    my $db = $r-&gt;db;
    my @editForUser = $r-&gt;param(<span class="stringliteral">&#39;editForUser&#39;</span>);
    my $forUsers    = scalar(@editForUser);
    my $forOneUser  = $forUsers == 1;

<span class="preprocessor">    #my ($globalRecord, $userRecord, $mergedRecord);</span>
<span class="preprocessor"></span><span class="preprocessor">    #if (defined $problemID) {  </span>
<span class="preprocessor"></span><span class="preprocessor">    #   $globalRecord = $db-&gt;getGlobalProblem($setID, $problemID);</span>
<span class="preprocessor"></span><span class="preprocessor">    #   $userRecord = $db-&gt;getUserProblem($userID, $setID, $problemID);</span>
<span class="preprocessor"></span><span class="preprocessor">    #   #$mergedRecord = $db-&gt;getMergedProblem($userID, $setID, $problemID); # never used --sam</span>
<span class="preprocessor"></span><span class="preprocessor">    #} else {</span>
<span class="preprocessor"></span><span class="preprocessor">    #   $globalRecord = $db-&gt;getGlobalSet($setID);</span>
<span class="preprocessor"></span><span class="preprocessor">    #   $userRecord = $db-&gt;getUserSet($userID, $setID);</span>
<span class="preprocessor"></span><span class="preprocessor">    #   #$mergedRecord = $db-&gt;getMergedSet($userID, $setID); # never user --sam</span>
<span class="preprocessor"></span><span class="preprocessor">    #}</span>
<span class="preprocessor"></span>    
    <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;No data exists for set [_1] and problem [_2]&quot;</span>, $setID, $problemID) unless $globalRecord;
    <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;No user specific data exists for user [_1]&quot;</span>, $userID) <span class="keywordflow">if</span> $forOneUser and $globalRecord and not $userRecord;
    
    my %properties = %{ FIELD_PROPERTIES()-&gt;{$field} };
    my %labels = %{ $properties{labels} };
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $properties{type} eq <span class="stringliteral">&quot;hidden&quot;</span>;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $properties{<span class="keyword">override</span>} eq <span class="stringliteral">&quot;one&quot;</span> &amp;&amp; not $forOneUser;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $properties{<span class="keyword">override</span>} eq <span class="stringliteral">&quot;none&quot;</span> &amp;&amp; not $forOneUser;
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $properties{<span class="keyword">override</span>} eq <span class="stringliteral">&quot;all&quot;</span> &amp;&amp; $forUsers;
            
    my $edit = ($properties{type} eq <span class="stringliteral">&quot;edit&quot;</span>) &amp;&amp; ($properties{<span class="keyword">override</span>} ne <span class="stringliteral">&quot;none&quot;</span>);
    my $choose = ($properties{type} eq <span class="stringliteral">&quot;choose&quot;</span>) &amp;&amp; ($properties{<span class="keyword">override</span>} ne <span class="stringliteral">&quot;none&quot;</span>);
    
<span class="preprocessor"># FIXME: allow one selector to set multiple fields</span>
<span class="preprocessor"></span><span class="preprocessor">#   my $globalValue = $globalRecord-&gt;{$field};</span>
<span class="preprocessor"></span><span class="preprocessor">#   my $userValue = $userRecord-&gt;{$field};</span>
<span class="preprocessor"></span>    my ($globalValue, $userValue) = (<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
    my $blankfield = <span class="stringliteral">&#39;&#39;</span>;
    <span class="keywordflow">if</span> ( $field =~ /:/ ) {
        my @gVals = ();
        my @uVals = ();
        my @bVals = ();
        <span class="keywordflow">foreach</span> my $f ( split(/:/, $field) ) {
<span class="preprocessor">            # hmm.  this directly references the data in the </span>
<span class="preprocessor"></span><span class="preprocessor">            #    record rather than calling the access method, </span>
<span class="preprocessor"></span><span class="preprocessor">            #    thereby avoiding errors if the userRecord is </span>
<span class="preprocessor"></span><span class="preprocessor">            #    undefined.  that seems a bit suspect, but it&#39;s</span>
<span class="preprocessor"></span><span class="preprocessor">            #    used below so we&#39;ll leave it here.</span>
<span class="preprocessor"></span>
            push(@gVals, $globalRecord-&gt;{$f} );
            push(@uVals, $userRecord-&gt;{$f} );    # (defined($userRecord-&gt;{$f})?$userRecord-&gt;{$f}:<span class="stringliteral">&#39;&#39;</span>) );
            push(@bVals, <span class="stringliteral">&#39;&#39;</span>);
        }
<span class="preprocessor">        # I don&#39;t like this, but combining multiple values is a bit messy</span>
<span class="preprocessor"></span>        $globalValue = (grep {defined($_)} @gVals) ? join(<span class="charliteral">&#39;:&#39;</span>, (map { defined($_) ? $_ : <span class="stringliteral">&#39;&#39;</span> } @gVals )) : undef;
        $userValue = (grep {defined($_)} @uVals) ? join(<span class="charliteral">&#39;:&#39;</span>, (map { defined($_) ? $_ : <span class="stringliteral">&#39;&#39;</span> } @uVals )) : undef;
        $blankfield = join(<span class="charliteral">&#39;:&#39;</span>, @bVals);
    } <span class="keywordflow">else</span> {
        $globalValue = $globalRecord-&gt;{$field};
        $userValue = $userRecord-&gt;{$field};
    }

<span class="preprocessor">    # use defined instead of value in order to allow 0 to printed, e.g. for the &#39;value&#39; field</span>
<span class="preprocessor"></span>    $globalValue = (defined($globalValue)) ? ($labels{$globalValue || <span class="stringliteral">&quot;&quot;</span>} || $globalValue) : <span class="stringliteral">&quot;&quot;</span>;
    $userValue = (defined($userValue)) ? ($labels{$userValue || <span class="stringliteral">&quot;&quot;</span>} || $userValue) : $blankfield;

    <span class="keywordflow">if</span> ($field =~ /_date/) {
        $globalValue = $self-&gt;formatDateTime($globalValue) <span class="keywordflow">if</span> defined $globalValue &amp;&amp; $globalValue ne $labels{<span class="stringliteral">&quot;&quot;</span>};
<span class="preprocessor">        # this is still fragile, but the check for blank (as opposed to 0) $userValue seems to prevent errors when no user has been assigned.</span>
<span class="preprocessor"></span>        $userValue = $self-&gt;formatDateTime($userValue) <span class="keywordflow">if</span> defined $userValue &amp;&amp; $userValue =~/\S/ &amp;&amp; $userValue ne $labels{<span class="stringliteral">&quot;&quot;</span>};
    }

    <span class="keywordflow">if</span> ( defined($properties{convertby}) &amp;&amp; $properties{convertby} ) {
        $globalValue = $globalValue/$properties{convertby} <span class="keywordflow">if</span> $globalValue;
        $userValue = $userValue/$properties{convertby} <span class="keywordflow">if</span> $userValue;
    }

<span class="preprocessor">    # check to make sure that a given value can be overridden</span>
<span class="preprocessor"></span>    my %canOverride = map { $_ =&gt; 1 } (@{ PROBLEM_FIELDS() }, @{ SET_FIELDS() });
    my $check = $canOverride{$field};

<span class="preprocessor">    # $recordType is a shorthand in the return statement for problem or set</span>
<span class="preprocessor"></span><span class="preprocessor">    # $recordID is a shorthand in the return statement for $problemID or $setID</span>
<span class="preprocessor"></span>    my $recordType = <span class="stringliteral">&quot;&quot;</span>;
    my $recordID = <span class="stringliteral">&quot;&quot;</span>;
    <span class="keywordflow">if</span> (defined $problemID) {
        $recordType = <span class="stringliteral">&quot;problem&quot;</span>;
        $recordID = $problemID;
    } <span class="keywordflow">else</span> {
        $recordType = <span class="stringliteral">&quot;set&quot;</span>;
        $recordID = $setID;
    }
    
<span class="preprocessor">    # $inputType contains either an input box or a popup_menu for changing a given db field</span>
<span class="preprocessor"></span>    my $inputType = <span class="stringliteral">&quot;&quot;</span>;
    <span class="keywordflow">if</span> ($edit) {
        $inputType = CGI::input({
                name =&gt; <span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>,
                value =&gt; $r-&gt;param(<span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>) || ($forUsers ? $userValue : $globalValue),
                size =&gt; $properties{size} || 5,
        });
    } elsif ($choose) {
<span class="preprocessor">        # Note that in popup menus, you&#39;re almost guaranteed to have the choices hashed to labels in %properties</span>
<span class="preprocessor"></span><span class="preprocessor">        # but $userValue and and $globalValue are the values in the hash not the keys</span>
<span class="preprocessor"></span><span class="preprocessor">        # so we have to use the actual db record field values to select our default here.</span>
<span class="preprocessor"></span>
<span class="preprocessor">        # FIXME: this allows us to set one selector from two (or more) fields</span>
<span class="preprocessor"></span><span class="preprocessor">        # if $field matches /:/, we have to get two fields to get the data we need here</span>
<span class="preprocessor"></span>        my $value = $r-&gt;param(<span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>);
        <span class="keywordflow">if</span> ( ! $value &amp;&amp; $field =~ /:/ ) { 
            my @fields = split(/:/, $field);
            $value = <span class="stringliteral">&#39;&#39;</span>;
            <span class="keywordflow">foreach</span> my $f ( @fields ) {
                $value .= ($forUsers &amp;&amp; $userRecord-&gt;$f ne <span class="stringliteral">&#39;&#39;</span> ? $userRecord-&gt;$f : $globalRecord-&gt;$f) . <span class="stringliteral">&quot;:&quot;</span>;
            }
            $value =~ s/:$<span class="comment">//;</span>
        } elsif ( ! $value ) {
            $value = ($forUsers &amp;&amp; $userRecord-&gt;$field ne <span class="stringliteral">&#39;&#39;</span> ? $userRecord-&gt;$field : $globalRecord-&gt;$field);
        }
        
        <span class="keywordflow">foreach</span> my $l (keys %labels){
            $labels{$l} = $r-&gt;maketext($labels{$l});
        }
            
        $inputType = CGI::popup_menu({
                name =&gt; <span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>,
                values =&gt; $properties{choices},
                labels =&gt; \%labels,
                <span class="keywordflow">default</span> =&gt; $value,
        });
    }
    
    my $gDisplVal = defined($properties{labels}) &amp;&amp; defined($properties{labels}-&gt;{$globalValue}) ? $properties{labels}-&gt;{$globalValue} : $globalValue;

<span class="preprocessor">    # FIXME: adding &quot;:&quot; in the checked =&gt; allows for multiple fields to be set by one selector</span>
<span class="preprocessor"></span><span class="preprocessor">#   return (($forUsers &amp;&amp; $edit &amp;&amp; $check) ? CGI::checkbox({</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> (($forUsers &amp;&amp; $check) ? CGI::checkbox({
                type =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>,
                name =&gt; <span class="stringliteral">&quot;$recordType.$recordID.$field.override&quot;</span>,
                label =&gt; <span class="stringliteral">&quot;&quot;</span>,
                value =&gt; $field,
                checked =&gt; $r-&gt;param(<span class="stringliteral">&quot;$recordType.$recordID.$field.override&quot;</span>) || ($userValue ne ($labels{<span class="stringliteral">&quot;&quot;</span>} || $blankfield) ? 1 : 0),
        }) : <span class="stringliteral">&quot;&quot;</span>,
        $r-&gt;maketext($properties{name}),
        $inputType,
        $forUsers ? <span class="stringliteral">&quot; $gDisplVal&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
    );
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="ab7aaabdff126c3494bccb97c1afc4540"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::FieldTable" ref="ab7aaabdff126c3494bccb97c1afc4540" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::FieldTable </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-FieldTable' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-FieldTable-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-FieldTable-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-FieldTable-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in FieldTable: 93</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab7aaabdff126c3494bccb97c1afc4540">FieldTable</a> {
    my ($self, $userID, $setID, $problemID, $globalRecord, $userRecord, $isGWset) = @_;

    my $r = $self-&gt;r;   
    my @editForUser = $r-&gt;param(<span class="stringliteral">&#39;editForUser&#39;</span>);
    my $forUsers    = scalar(@editForUser);
    my $forOneUser  = $forUsers == 1;

    my @fieldOrder;

<span class="preprocessor">    # needed for gateway output</span>
<span class="preprocessor"></span>    my $gwFields = <span class="stringliteral">&#39;&#39;</span>;
<span class="preprocessor">    # $isGWset will come in undef if we don&#39;t need to worry about it</span>
<span class="preprocessor"></span>    $isGWset = 0 <span class="keywordflow">if</span> ( ! defined( $isGWset ) );
<span class="preprocessor">    # are we editing a set version?</span>
<span class="preprocessor"></span>    my $setVersion = (defined($userRecord) &amp;&amp; $userRecord-&gt;can(<span class="stringliteral">&quot;version_id&quot;</span>)) ? 1 : 0;

<span class="preprocessor">    # needed for ip restrictions</span>
<span class="preprocessor"></span>    my $ipFields = <span class="stringliteral">&#39;&#39;</span>;
    my $ipDefaults;
    my $numLocations = 0;
    my $ipOverride;

<span class="preprocessor">    # needed for set-level proctor</span>
<span class="preprocessor"></span>    my $procFields = <span class="stringliteral">&#39;&#39;</span>;

    <span class="keywordflow">if</span> (defined $problemID) {
        @fieldOrder = ($isGWset) ? @{ GATEWAY_PROBLEM_FIELD_ORDER() } :
            @{ PROBLEM_FIELD_ORDER() };
    } <span class="keywordflow">else</span> {
        @fieldOrder = @{ SET_FIELD_ORDER() };

        ($gwFields, $ipFields, $numLocations, $procFields) = $self-&gt;extraSetFields($userID, $setID, $globalRecord, $userRecord, $forUsers);
    }

    my $output = CGI::start_table({border =&gt; 0, cellpadding =&gt; 1});
    <span class="keywordflow">if</span> ($forUsers) {
        $output .= CGI::Tr({},
            CGI::th({colspan=&gt;<span class="stringliteral">&quot;2&quot;</span>}, <span class="stringliteral">&quot;&amp;nbsp;&quot;</span>),
            CGI::th({colspan=&gt;<span class="stringliteral">&quot;1&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;User Values&quot;</span>)),
            CGI::th({}, $r-&gt;maketext(<span class="stringliteral">&quot;Class values&quot;</span>)),
        );
    }
    <span class="keywordflow">foreach</span> my $field (@fieldOrder) {
        my %properties; 
        
        
        <span class="keywordflow">if</span>($isGWset &amp;&amp; defined( FIELD_PROPERTIES_GWQUIZ-&gt;{$field} )){
            %properties = %{ FIELD_PROPERTIES_GWQUIZ-&gt;{$field} };
        }
        <span class="keywordflow">else</span>{
            %properties = %{ FIELD_PROPERTIES()-&gt;{$field} };
        }
        
<span class="preprocessor">        # we don&#39;t show the ip restriction option if there are </span>
<span class="preprocessor"></span><span class="preprocessor">        #    no defined locations, nor the relax_restrict_ip option</span>
<span class="preprocessor"></span><span class="preprocessor">        #    if we&#39;re not restricting ip access</span>
<span class="preprocessor"></span>        next <span class="keywordflow">if</span> ( $field eq <span class="stringliteral">&#39;restrict_ip&#39;</span> &amp;&amp; ( ! $numLocations || $setVersion ) );
        next <span class="keywordflow">if</span> ($field eq <span class="stringliteral">&#39;relax_restrict_ip&#39;</span> &amp;&amp;
             (! $numLocations || $setVersion ||
              ($forUsers &amp;&amp; $userRecord-&gt;restrict_ip eq <span class="stringliteral">&#39;No&#39;</span>) ||
              (! $forUsers &amp;&amp; 
               ( $globalRecord-&gt;restrict_ip eq <span class="stringliteral">&#39;&#39;</span> ||
                 $globalRecord-&gt;restrict_ip eq <span class="stringliteral">&#39;No&#39;</span> ) ) ) );
<span class="preprocessor">        # skip the problem seed if we&#39;re editing a gateway set for users,</span>
<span class="preprocessor"></span><span class="preprocessor">        #    but aren&#39;t editing a set version</span>
<span class="preprocessor"></span>        next <span class="keywordflow">if</span> ( $field eq <span class="stringliteral">&#39;problem_seed&#39;</span>  &amp;&amp;
              ( $isGWset &amp;&amp; $forUsers &amp;&amp; ! $setVersion ) );

        unless ($properties{type} eq <span class="stringliteral">&quot;hidden&quot;</span>) {
            $output .= CGI::Tr({}, CGI::td({}, [$self-&gt;FieldHTML($userID, $setID, $problemID, $globalRecord, $userRecord, $field)])) . <span class="stringliteral">&quot;\n&quot;</span>;
    }

<span class="preprocessor">        # finally, put in extra fields that are exceptions to the </span>
<span class="preprocessor"></span><span class="preprocessor">        #    usual display mechanism</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $field eq <span class="stringliteral">&#39;restrict_ip&#39;</span> &amp;&amp; $ipFields ) {
            $output .= $ipFields;
        }
                          
        <span class="keywordflow">if</span> ( $field eq <span class="stringliteral">&#39;assignment_type&#39;</span> ) {
            $output .= <span class="stringliteral">&quot;$procFields\n$gwFields\n&quot;</span>;
        }
    } 

    <span class="keywordflow">if</span> (defined $problemID) {
<span class="preprocessor">        #my $problemRecord = $r-&gt;{db}-&gt;getUserProblem($userID, $setID, $problemID);</span>
<span class="preprocessor"></span>        my $problemRecord = $userRecord; # we <span class="keyword">get</span> <span class="keyword">this</span> from the caller, hopefully
        $output .= CGI::Tr({}, CGI::td({}, [<span class="stringliteral">&quot;&quot;</span>,$r-&gt;maketext(<span class="stringliteral">&quot;Attempts&quot;</span>), ($problemRecord-&gt;num_correct || 0) + ($problemRecord-&gt;num_incorrect || 0)])) if $forOneUser;
    }       
    $output .= CGI::end_table();
    
    return $output;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="af3602e0071a8eb6ba6a34499a6c08423"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::handle_problem_numbers" ref="af3602e0071a8eb6ba6a34499a6c08423" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::handle_problem_numbers </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-handle_problem_numbers' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-handle_problem_numbers-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-handle_problem_numbers-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-handle_problem_numbers-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in handle_problem_numbers: 118</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#af3602e0071a8eb6ba6a34499a6c08423">handle_problem_numbers</a> {
    my $self = shift;
    my $r = $self-&gt;r;
    my $newProblemNumbersref = shift;
    my %newProblemNumbers = %$newProblemNumbersref;
    my $maxNum = shift;
    my $db = shift;
    my $setID = shift;
    my $force = shift || 0;
    my @sortme=();
    my ($j, $val);

<span class="preprocessor">    # keys are current problem numbers, values are target problem numbers</span>
<span class="preprocessor"></span>    <span class="keywordflow">foreach</span> $j (keys %newProblemNumbers) {
<span class="preprocessor">        # we don&#39;t want to act unless all problems have been assigned a new problem number, so if any have not, return</span>
<span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> (not defined $newProblemNumbers{<span class="stringliteral">&quot;$j&quot;</span>});
<span class="preprocessor">        # if the problem has been given a new number, we reduce the &quot;score&quot; of the problem by the original number of the problem</span>
<span class="preprocessor"></span><span class="preprocessor">        # when multiple problems are assigned the same number, this results in the last one ending up first -- FIXME?</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> ($newProblemNumbers{<span class="stringliteral">&quot;$j&quot;</span>} != $j) {
<span class="preprocessor">            # force always gets set if reordering is done, so don&#39;t expect to be able to delete a problem,</span>
<span class="preprocessor"></span><span class="preprocessor">            # reorder some other problems, and end up with a hole -- FIXME</span>
<span class="preprocessor"></span>            $force = 1;
            $val = 1000 * $newProblemNumbers{$j} - $j;
        } <span class="keywordflow">else</span> {
            $val = 1000 * $newProblemNumbers{$j};
        }
<span class="preprocessor">        # store a mapping between current problem number and score (based on currnet and new problem number)</span>
<span class="preprocessor"></span>        push @sortme, [$j, $val];
<span class="preprocessor">        # replace new problem numbers in hash with the (global) problems themselves</span>
<span class="preprocessor"></span>        $newProblemNumbers{$j} = $db-&gt;getGlobalProblem($setID, $j);
        die $r-&gt;maketext(<span class="stringliteral">&quot;global [_1] for set [_2] not found.&quot;</span>, $j, $setID) unless $newProblemNumbers{$j};
    }

<span class="preprocessor">    # we don&#39;t have to do anything if we&#39;re not getting rid of holes</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless $force;

<span class="preprocessor">    # sort the curr. prob. num./score pairs by score</span>
<span class="preprocessor"></span>    @sortme = sort {$a-&gt;[1] &lt;=&gt; $b-&gt;[1]} @sortme;
<span class="preprocessor">    # now, for global and each user with this set, loop through problem list</span>
<span class="preprocessor"></span><span class="preprocessor">    #   get all of the problem records</span>
<span class="preprocessor"></span><span class="preprocessor">    # assign new problem numbers</span>
<span class="preprocessor"></span><span class="preprocessor">    # loop - if number is new, put the problem record</span>
<span class="preprocessor"></span><span class="preprocessor">    # print &quot;Sorted to get &quot;. join(&#39;, &#39;, map {$_-&gt;[0] } @sortme) .&quot;&lt;p&gt;\n&quot;;</span>
<span class="preprocessor"></span>

<span class="preprocessor">    # Now, three stages.  First global values</span>
<span class="preprocessor"></span>
    <span class="keywordflow">for</span> ($j = 0; $j &lt; scalar @sortme; $j++) {
        <span class="keywordflow">if</span>($sortme[$j][0] == $j + 1) {
<span class="preprocessor">            # if the jth problem (according to the new ordering) is in the right place (problem IDs are numbered from 1, hence $j+1)</span>
<span class="preprocessor"></span><span class="preprocessor">            # do nothing</span>
<span class="preprocessor"></span>        } elsif (not defined $newProblemNumbers{$j + 1}) {
<span class="preprocessor">            # otherwise, if there&#39;s a hole for it, add it there</span>
<span class="preprocessor"></span>            $newProblemNumbers{$sortme[$j][0]}-&gt;problem_id($j + 1);
            $db-&gt;addGlobalProblem($newProblemNumbers{$sortme[$j][0]});
        } <span class="keywordflow">else</span> {
<span class="preprocessor">            # otherwise, overwrite the data for the problem that&#39;s already there with the jth problem&#39;s data (with a changed problemID)</span>
<span class="preprocessor"></span>            $newProblemNumbers{$sortme[$j][0]}-&gt;problem_id($j + 1);
            $db-&gt;putGlobalProblem($newProblemNumbers{$sortme[$j][0]});
        }
    }

    my @setUsers = $db-&gt;listSetUsers($setID);
    my (@problist, $user);

    <span class="keywordflow">foreach</span> $user (@setUsers) {
<span class="preprocessor">        # grab a copy of each UserProblem for this user. @problist can be sparse (if problems were deleted)</span>
<span class="preprocessor"></span>        <span class="keywordflow">for</span> $j (keys %newProblemNumbers) {
            $problist[$j] = $db-&gt;getUserProblem($user, $setID, $j);
        }
        <span class="keywordflow">for</span>($j = 0; $j &lt; scalar @sortme; $j++) { 
            <span class="keywordflow">if</span> ($sortme[$j][0] == $j + 1) {
<span class="preprocessor">                # same as above -- the jth problem is in the right place, so don&#39;t worry about it</span>
<span class="preprocessor"></span><span class="preprocessor">                # do nothing</span>
<span class="preprocessor"></span>            } elsif ($problist[$sortme[$j][0]]) {
<span class="preprocessor">                # we&#39;ve made sure the user&#39;s problem actually exists HERE, since we want to be able to fail gracefullly if it doesn&#39;t</span>
<span class="preprocessor"></span><span class="preprocessor">                # the problem with the original conditional below is that %newProblemNumbers maps oldids =&gt; global problem record</span>
<span class="preprocessor"></span><span class="preprocessor">                # we need to check if the target USER PROBLEM exists, which is what @problist knows</span>
<span class="preprocessor"></span><span class="preprocessor">                #if (not defined $newProblemNumbers{$j + 1}) {</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span> (not defined $problist[$j+1]) {
<span class="preprocessor">                    # same as above -- there&#39;s a hole for that problem to go into, so add it in its new place</span>
<span class="preprocessor"></span>                    $problist[$sortme[$j][0]]-&gt;problem_id($j + 1); 
                    $db-&gt;addUserProblem($problist[$sortme[$j][0]]); 
                } <span class="keywordflow">else</span> { 
<span class="preprocessor">                    # same as above -- there&#39;s a problem already there, so overwrite its data with the data from the jth problem</span>
<span class="preprocessor"></span>                    $problist[$sortme[$j][0]]-&gt;problem_id($j + 1); 
                    $db-&gt;putUserProblem($problist[$sortme[$j][0]]); 
                } 
            } <span class="keywordflow">else</span> {
                warn $r-&gt;maketext(<span class="stringliteral">&quot;UserProblem missing for user=[_1] set=[_2] problem=[_3]. This may indicate database corruption.&quot;</span>, $user, $setID, $sortme[$j][0]).<span class="stringliteral">&quot;\n&quot;</span>;
<span class="preprocessor">                # when a problem doesn&#39;t exist in the target slot, a new problem gets added there, but the original problem</span>
<span class="preprocessor"></span><span class="preprocessor">                # never gets overwritten (because there wan&#39;t a problem it would have to get exchanged with)</span>
<span class="preprocessor"></span><span class="preprocessor">                # i think this can get pretty complex. consider 1=&gt;2, 2=&gt;3, 3=&gt;4, 4=&gt;1 where problem 1 doesn&#39;t exist for some user:</span>
<span class="preprocessor"></span><span class="preprocessor">                # @sortme[$j][0] will contain: 4, 1, 2, 3</span>
<span class="preprocessor"></span><span class="preprocessor">                # - problem 1 will get **added** with the data from problem 4 (because problem 1 doesn&#39;t exist for this user)</span>
<span class="preprocessor"></span><span class="preprocessor">                # - problem 2 will get overwritten with the data from problem 1</span>
<span class="preprocessor"></span><span class="preprocessor">                # - problem 3 will get overwritten with the data from problem 2</span>
<span class="preprocessor"></span><span class="preprocessor">                # - nothing will happend to problem 4, since problem 1 doesn&#39;t exit</span>
<span class="preprocessor"></span><span class="preprocessor">                # so the solution is to delete problem 4 altogether!</span>
<span class="preprocessor"></span><span class="preprocessor">                # here&#39;s the fix:</span>
<span class="preprocessor"></span>                
<span class="preprocessor">                # the data from problem $j+1 was/will be moved to another problem slot,</span>
<span class="preprocessor"></span><span class="preprocessor">                # but there&#39;s no problem $sortme[$j][0] to replace it. thus, we delete it now.</span>
<span class="preprocessor"></span>                $db-&gt;deleteUserProblem($user, $setID, $j+1);
            }
        } 
    }

<span class="preprocessor">    # any problems with IDs above $maxNum get deleted -- presumably their data has been copied into problems with lower IDs</span>
<span class="preprocessor"></span>    <span class="keywordflow">foreach</span> ($j = scalar @sortme; $j &lt; $maxNum; $j++) {
        <span class="keywordflow">if</span> (defined $newProblemNumbers{$j + 1}) {
            $db-&gt;deleteGlobalProblem($setID, $j+1);
        }
    }

<span class="preprocessor">    # return a string form of the old problem IDs in the new order (not used by caller, incidentally)</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> join(<span class="stringliteral">&#39;, &#39;</span>, map {$_-&gt;[0]} @sortme);
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a53c08e2b586ca7946c573642728cd836"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::initialize" ref="a53c08e2b586ca7946c573642728cd836" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::initialize </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-initialize' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-initialize-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-initialize-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-initialize-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in initialize: 658</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a53c08e2b586ca7946c573642728cd836">initialize</a> {
    my ($self)    = @_;
    my $r         = $self-&gt;r;
    my $db        = $r-&gt;db;
    my $ce        = $r-&gt;ce;
    my $authz     = $r-&gt;authz;
    my $user      = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
    my $setID   = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);

<span class="preprocessor">    ## we&#39;re now allowing setID to come in as setID,v# to edit a set</span>
<span class="preprocessor"></span><span class="preprocessor">    ##    version; catch this first</span>
<span class="preprocessor"></span>    my $editingSetVersion = 0;
    <span class="keywordflow">if</span> ( $setID =~ /,v(\d+)$/ ) {
        $editingSetVersion = $1;
        $setID =~ s/,v(\d+)$<span class="comment">//;</span>
    }

    my $setRecord = $db-&gt;getGlobalSet($setID); # checked
    die $r-&gt;maketext(<span class="stringliteral">&quot;global set [_1] not found.&quot;</span>, $setID) unless $setRecord;

    $self-&gt;{<span class="keyword">set</span>}  = $setRecord;
    my @editForUser = $r-&gt;param(<span class="stringliteral">&#39;editForUser&#39;</span>);
<span class="preprocessor">    # some useful booleans</span>
<span class="preprocessor"></span>    my $forUsers   = scalar(@editForUser);
    my $forOneUser = $forUsers == 1;

<span class="preprocessor">    # Check permissions</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> unless ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>));
    <span class="keywordflow">return</span> unless ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>));

<span class="preprocessor">    ## if we&#39;re editing a versioned set, it only makes sense to be</span>
<span class="preprocessor"></span><span class="preprocessor">    ##    editing it for one user</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> ( $editingSetVersion &amp;&amp; ! $forOneUser );

    my %properties = %{ FIELD_PROPERTIES() };

<span class="preprocessor">    # takes a hash of hashes and inverts it</span>
<span class="preprocessor"></span>    my %undoLabels;
    <span class="keywordflow">foreach</span> my $key (keys %properties) {
        %{ $undoLabels{$key} } = map { $properties{$key}-&gt;{labels}-&gt;{$_} =&gt; $_ } keys %{ $properties{$key}-&gt;{labels} };
    }

<span class="preprocessor">    # Unfortunately not everyone uses Javascript enabled browsers so</span>
<span class="preprocessor"></span><span class="preprocessor">    # we must fudge the information coming from the ComboBoxes</span>
<span class="preprocessor"></span><span class="preprocessor">    # Since the textfield and menu both have the same name, we get an array of two elements</span>
<span class="preprocessor"></span><span class="preprocessor">    # We then reset the param to the first if its not-empty or the second (empty or not).</span>
<span class="preprocessor"></span>    <span class="keywordflow">foreach</span> ( @{ HEADER_ORDER() } ) {
        my @values = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$_&quot;</span>);
        my $value = $values[0] || $values[1] || <span class="stringliteral">&quot;&quot;</span>; 
        $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$_&quot;</span>, $value);
    }

<span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">    # Check date information</span>
<span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<span class="preprocessor"></span>
    my ($open_date, $due_date, $answer_date);
    my $error = 0;
    <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>)) {
        my @names = (<span class="stringliteral">&quot;open_date&quot;</span>, <span class="stringliteral">&quot;due_date&quot;</span>, <span class="stringliteral">&quot;answer_date&quot;</span>);
        
        my %dates = map { $_ =&gt; $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$_&quot;</span>) } @names;
        %dates = map { 
            my $unlabel = $undoLabels{$_}-&gt;{$dates{$_}}; 
            $_ =&gt; defined $unlabel ? $setRecord-&gt;$_ : $self-&gt;parseDateTime($dates{$_}) 
        } @names;

        ($open_date, $due_date, $answer_date) = map { $dates{$_}||0 } @names;
        
<span class="preprocessor">        # make sure dates are numeric by using ||0</span>
<span class="preprocessor"></span>        
        <span class="keywordflow">if</span> ($answer_date &lt; $due_date || $answer_date &lt; $open_date) {        
            $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Answers cannot be made available until on or after the due date!&quot;</span>));
            $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
        }
        
        <span class="keywordflow">if</span> ($due_date &lt; $open_date) {
            $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Answers cannot be due until on or after the open date!&quot;</span>));
            $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
        }
        
<span class="preprocessor">        # make sure the dates are not more than 10 years in the future</span>
<span class="preprocessor"></span>        my $curr_time = time;
        my $seconds_per_year = 31_556_926;
        my $cutoff = $curr_time + $seconds_per_year*10;
        <span class="keywordflow">if</span> ($open_date &gt; $cutoff) {
            $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error: open date cannot be more than 10 years from now in set [_1]&quot;</span>, $setID));
            $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
        }
        <span class="keywordflow">if</span> ($due_date &gt; $cutoff) {
            $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error: due date cannot be more than 10 years from now in set [_1]&quot;</span>, $setID));
            $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
        }
        <span class="keywordflow">if</span> ($answer_date &gt; $cutoff) {
            $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error: answer date cannot be more than 10 years from now in set [_1]&quot;</span>, $setID));
            $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
        }

    }
    <span class="keywordflow">if</span> ($error) {
        $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;No changes were saved!&quot;</span>));
    }
    
    <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>) &amp;&amp; !$error) {

<span class="preprocessor">        #my $setRecord = $db-&gt;getGlobalSet($setID); # already fetched above --sam</span>
<span class="preprocessor"></span>
<span class="preprocessor">        #####################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Save general set information (including headers)</span>
<span class="preprocessor"></span><span class="preprocessor">        #####################################################################</span>
<span class="preprocessor"></span>
        <span class="keywordflow">if</span> ($forUsers) {
<span class="preprocessor">            # note that we don&#39;t deal with the proctor user</span>
<span class="preprocessor"></span><span class="preprocessor">            #    fields here, with the assumption that it can&#39;t</span>
<span class="preprocessor"></span><span class="preprocessor">            #    be possible to change them for users.  this is</span>
<span class="preprocessor"></span><span class="preprocessor">            #    not the most robust treatment of the problem</span>
<span class="preprocessor"></span><span class="preprocessor">            #    (FIXME)</span>
<span class="preprocessor"></span>
<span class="preprocessor">            # DBFIXME use a WHERE clause, iterator</span>
<span class="preprocessor"></span>            my @userRecords = $db-&gt;getUserSets(map { [$_, $setID] } @editForUser);
<span class="preprocessor">            # if we&#39;re editing a set version, we want to edit</span>
<span class="preprocessor"></span><span class="preprocessor">            #    edit that instead of the userset, so get it</span>
<span class="preprocessor"></span><span class="preprocessor">            #    too.</span>
<span class="preprocessor"></span>            my $userSet = $userRecords[0];
            my $setVersion = 0;
            <span class="keywordflow">if</span> ( $editingSetVersion ) {
                $setVersion =
                    $db-&gt;getSetVersion($editForUser[0],
                               $setID,
                               $editingSetVersion);
                @userRecords = ( $setVersion );
            }

            <span class="keywordflow">foreach</span> my $record (@userRecords) {
                <span class="keywordflow">foreach</span> my $field ( @{ SET_FIELDS() } ) {
                    next unless <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab1d82f7e4749c6674e48c83232fb0d37">canChange</a>($forUsers, $field);
                    my $override = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field.override&quot;</span>);

                    <span class="keywordflow">if</span> (defined $override &amp;&amp; $override eq $field) {

                        my $param = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field&quot;</span>);
                        $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
                        my $unlabel = $undoLabels{$field}-&gt;{$param};
                        $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
<span class="preprocessor">#                       $param = $undoLabels{$field}-&gt;{$param} || $param;</span>
<span class="preprocessor"></span>                        <span class="keywordflow">if</span> ($field =~ /_date/) {
                            $param = $self-&gt;parseDateTime($param) unless defined $unlabel;
                        }
                        <span class="keywordflow">if</span> (defined($properties{$field}-&gt;{convertby}) &amp;&amp; $properties{$field}-&gt;{convertby}) {
                            $param = $param*$properties{$field}-&gt;{convertby};
                        }
<span class="preprocessor">                        # special case; does field fill in multiple values?</span>
<span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( $field =~ /:/ ) {
                            my @values = split(/:/, $param);
                            my @fields = split(/:/, $field);
                            <span class="keywordflow">for</span> ( my $i=0; $i&lt;@values; $i++ ) { 
                                my $f=$fields[$i]; 
                                $record-&gt;$f($values[$i]); 
                            }
                        } <span class="keywordflow">else</span> {
                            $record-&gt;$field($param);
                        }
                    } <span class="keywordflow">else</span> {
<span class="preprocessor">                        ####################</span>
<span class="preprocessor"></span><span class="preprocessor">                        # FIXME: allow one selector to set multiple fields</span>
<span class="preprocessor"></span><span class="preprocessor">                        # </span>
<span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( $field =~ /:/ ) {
                            <span class="keywordflow">foreach</span> my $f ( split(/:/, $field) ) {
                                $record-&gt;$f(undef);
                            }
                        } <span class="keywordflow">else</span> {
                            $record-&gt;$field(undef);
                        }
                    }
                
                }
<span class="preprocessor">                ####################</span>
<span class="preprocessor"></span><span class="preprocessor">                # FIXME: this is replaced by our allowing multiple fields to be set by one selector</span>
<span class="preprocessor"></span><span class="preprocessor">                # a check for hiding scores: if we have </span>
<span class="preprocessor"></span><span class="preprocessor">                #    $set-&gt;hide_score eq &#39;N&#39;, we also want </span>
<span class="preprocessor"></span><span class="preprocessor">                #    $set-&gt;hide_score_by_problem eq &#39;N&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">                # if ( $record-&gt;hide_score eq &#39;N&#39; ) {</span>
<span class="preprocessor"></span><span class="preprocessor">                #   $record-&gt;hide_score_by_problem(&#39;N&#39;);</span>
<span class="preprocessor"></span><span class="preprocessor">                # }</span>
<span class="preprocessor"></span><span class="preprocessor">                ####################</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $editingSetVersion ) {
                    $db-&gt;putSetVersion( $record );
                } <span class="keywordflow">else</span> {
                    $db-&gt;putUserSet($record);
                }
            }

<span class="preprocessor">        #######################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Save IP restriction Location information</span>
<span class="preprocessor"></span><span class="preprocessor">        #######################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # FIXME: it would be nice to have this in the field values</span>
<span class="preprocessor"></span><span class="preprocessor">        #    hash, so that we don&#39;t have to assume that we can </span>
<span class="preprocessor"></span><span class="preprocessor">        #    override this information for users</span>
<span class="preprocessor"></span>
<span class="preprocessor">            ## should we allow resetting set locations for set versions?  this</span>
<span class="preprocessor"></span><span class="preprocessor">            ##    requires either putting in a new set of database routines</span>
<span class="preprocessor"></span><span class="preprocessor">            ##    to deal with the versioned setID, or fudging it at this end</span>
<span class="preprocessor"></span><span class="preprocessor">            ##    by manually putting in the versioned ID setID,v#.  neither</span>
<span class="preprocessor"></span><span class="preprocessor">            ##    of these seems desirable, so for now it&#39;s not allowed</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
                <span class="keywordflow">if</span> ( $r-&gt;param(<span class="stringliteral">&quot;set.$setID.selected_ip_locations.override&quot;</span>) ) {
                    <span class="keywordflow">foreach</span> my $record ( @userRecords ) {
                        my $userID = $record-&gt;user_id;
                        my @selectedLocations = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.selected_ip_locations&quot;</span>);
                        my @userSetLocations = $db-&gt;listUserSetLocations($userID,$setID);
                        my @addSetLocations = ();
                        my @delSetLocations = ();
                        <span class="keywordflow">foreach</span> my $loc ( @selectedLocations ) {
                            push( @addSetLocations, $loc ) if ( ! grep( /^$loc$/, @userSetLocations ) );
                        }
                        foreach my $loc ( @userSetLocations ) {
                            push( @delSetLocations, $loc ) if ( ! grep( /^$loc$/, @selectedLocations ) );
                        }
                        <span class="preprocessor"># then update the user set_locations</span>
<span class="preprocessor"></span>                        <span class="keywordflow">foreach</span> ( @addSetLocations ) {
                            my $Loc = $db-&gt;newUserSetLocation;
                            $Loc-&gt;set_id( $setID );
                            $Loc-&gt;user_id( $userID );
                            $Loc-&gt;location_id($_);
                            $db-&gt;addUserSetLocation($Loc);
                        }
                        <span class="keywordflow">foreach</span> ( @delSetLocations ) {
                            $db-&gt;deleteUserSetLocation($userID,$setID,$_);
                        }
                    }
                } <span class="keywordflow">else</span> {
<span class="preprocessor">                    # if override isn&#39;t selected, then we want</span>
<span class="preprocessor"></span><span class="preprocessor">                    #    to be sure that there are no</span>
<span class="preprocessor"></span><span class="preprocessor">                    #    set_locations_user entries setting around</span>
<span class="preprocessor"></span>                    <span class="keywordflow">foreach</span> my $record ( @userRecords ) {
                        my $userID = $record-&gt;user_id;
                        my @userLocations = $db-&gt;listUserSetLocations($userID,$setID);
                        <span class="keywordflow">foreach</span> ( @userLocations ) {
                            $db-&gt;deleteUserSetLocation($userID,$setID,$_);
                        }
                    }
                }
            }
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">foreach</span> my $field ( @{ SET_FIELDS() } ) {
                next unless <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab1d82f7e4749c6674e48c83232fb0d37">canChange</a>($forUsers, $field);

                my $param = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field&quot;</span>);
                $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;

                my $unlabel = $undoLabels{$field}-&gt;{$param};
                $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
                <span class="keywordflow">if</span> ($field =~ /_date/) {
                    $param = $self-&gt;parseDateTime($param) unless defined $unlabel;
                }
                <span class="keywordflow">if</span> (defined($properties{$field}-&gt;{convertby}) &amp;&amp; $properties{$field}-&gt;{convertby} &amp;&amp; $param) {
                    $param = $param*$properties{$field}-&gt;{convertby};
                }
<span class="preprocessor">                # special case; does field fill in multiple values?</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $field =~ /:/ ) {
                    my @values = split(/:/, $param);
                    my @fields = split(/:/, $field);
                    <span class="keywordflow">for</span> ( my $i=0; $i&lt;@fields; $i++ ) { 
                        my $f = $fields[$i];
                        $setRecord-&gt;$f($values[$i]); 
                    }
                } <span class="keywordflow">else</span> {
                    $setRecord-&gt;$field($param);
                }
            }
<span class="preprocessor">####################</span>
<span class="preprocessor"></span><span class="preprocessor"># FIXME: this is replaced by our setting both hide_score and hide_score_by_problem</span>
<span class="preprocessor"></span><span class="preprocessor">#    with a single drop down</span>
<span class="preprocessor"></span><span class="preprocessor"># </span>
<span class="preprocessor"></span><span class="preprocessor">#           # a check for hiding scores: if we have </span>
<span class="preprocessor"></span><span class="preprocessor">#           #    $set-&gt;hide_score eq &#39;N&#39;, we also want </span>
<span class="preprocessor"></span><span class="preprocessor">#           #    $set-&gt;hide_score_by_problem eq &#39;N&#39;, and if it&#39;s</span>
<span class="preprocessor"></span><span class="preprocessor">#           #    changed to &#39;Y&#39; and hide_score_by_problem is Null,</span>
<span class="preprocessor"></span><span class="preprocessor">#           #    give it a value &#39;N&#39;</span>
<span class="preprocessor"></span><span class="preprocessor">#           if ( $setRecord-&gt;hide_score eq &#39;N&#39; ||</span>
<span class="preprocessor"></span><span class="preprocessor">#                ( ! defined($setRecord-&gt;hide_score_by_problem) ||</span>
<span class="preprocessor"></span><span class="preprocessor">#                  $setRecord-&gt;hide_score_by_problem eq &#39;&#39; ) ) {</span>
<span class="preprocessor"></span><span class="preprocessor">#               $setRecord-&gt;hide_score_by_problem(&#39;N&#39;);</span>
<span class="preprocessor"></span><span class="preprocessor">#           }</span>
<span class="preprocessor"></span><span class="preprocessor">####################</span>
<span class="preprocessor"></span>            $db-&gt;putGlobalSet($setRecord);

<span class="preprocessor">        #######################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Save IP restriction Location information</span>
<span class="preprocessor"></span><span class="preprocessor">        #######################################################</span>
<span class="preprocessor"></span>
            <span class="keywordflow">if</span> ( defined($r-&gt;param(<span class="stringliteral">&quot;set.$setID.restrict_ip&quot;</span>)) and $r-&gt;param(<span class="stringliteral">&quot;set.$setID.restrict_ip&quot;</span>) ne <span class="stringliteral">&#39;No&#39;</span> ) {
                my @selectedLocations = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.selected_ip_locations&quot;</span>);
                my @globalSetLocations = $db-&gt;listGlobalSetLocations($setID);
                my @addSetLocations = ();
                my @delSetLocations = ();
                <span class="keywordflow">foreach</span> my $loc ( @selectedLocations ) {
                    push( @addSetLocations, $loc ) if ( ! grep( /^$loc$/, @globalSetLocations ) );
                }
                foreach my $loc ( @globalSetLocations ) {
                    push( @delSetLocations, $loc ) if ( ! grep( /^$loc$/, @selectedLocations ) );
                }
                <span class="preprocessor"># then update the global set_locations</span>
<span class="preprocessor"></span>                <span class="keywordflow">foreach</span> ( @addSetLocations ) {
                    my $Loc = $db-&gt;newGlobalSetLocation;
                    $Loc-&gt;set_id( $setID );
                    $Loc-&gt;location_id($_);
                    $db-&gt;addGlobalSetLocation($Loc);
                }
                <span class="keywordflow">foreach</span> ( @delSetLocations ) {
                    $db-&gt;deleteGlobalSetLocation($setID,$_);
                }
            } <span class="keywordflow">else</span> {
                my @globalSetLocations = $db-&gt;listGlobalSetLocations($setID);
                <span class="keywordflow">foreach</span> ( @globalSetLocations ) {
                    $db-&gt;deleteGlobalSetLocation($setID,$_);
                }
            }

<span class="preprocessor">        #######################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Save proctored problem proctor user information</span>
<span class="preprocessor"></span><span class="preprocessor">        #######################################################</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ($r-&gt;param(<span class="stringliteral">&quot;set.$setID.restricted_login_proctor_password&quot;</span>) &amp;&amp;
                $setRecord-&gt;assignment_type eq <span class="stringliteral">&#39;proctored_gateway&#39;</span>) {
<span class="preprocessor">                # in this case we&#39;re adding a set-level proctor</span>
<span class="preprocessor"></span><span class="preprocessor">                #    or updating the password</span>
<span class="preprocessor"></span>
                my $procID = <span class="stringliteral">&quot;set_id:$setID&quot;</span>;
                my $pass = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.restricted_login_proctor_password&quot;</span>);
<span class="preprocessor">                # should we carefully check in this case that</span>
<span class="preprocessor"></span><span class="preprocessor">                #    the user and password exist?  the code </span>
<span class="preprocessor"></span><span class="preprocessor">                #    in the add stanza is pretty careful to </span>
<span class="preprocessor"></span><span class="preprocessor">                #    be sure that there&#39;s a one-to-one </span>
<span class="preprocessor"></span><span class="preprocessor">                #    correspondence between the existence of </span>
<span class="preprocessor"></span><span class="preprocessor">                #    the user and the setting of the set</span>
<span class="preprocessor"></span><span class="preprocessor">                #    restricted_login_proctor field, so we </span>
<span class="preprocessor"></span><span class="preprocessor">                #    assume that just checking the latter </span>
<span class="preprocessor"></span><span class="preprocessor">                #    here is sufficient.</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $setRecord-&gt;restricted_login_proctor eq <span class="stringliteral">&#39;Yes&#39;</span> ) {
<span class="preprocessor">                    # in this case we already have a set</span>
<span class="preprocessor"></span><span class="preprocessor">                    #    level proctor, and so should be </span>
<span class="preprocessor"></span><span class="preprocessor">                    #    resetting the password</span>
<span class="preprocessor"></span>                    <span class="keywordflow">if</span> ( $pass ne <span class="stringliteral">&#39;********&#39;</span> ) {
<span class="preprocessor">                        # then we submitted a new </span>
<span class="preprocessor"></span><span class="preprocessor">                        #    password, so save it</span>
<span class="preprocessor"></span>                        my $dbPass;
                        eval { $dbPass = $db-&gt;getPassword($procID) };
                        <span class="keywordflow">if</span> ( $@ ) {
                            $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error getting old set-proctor password from the database: [_1].  No update to the password was done.&quot;</span>, $@));
                        } <span class="keywordflow">else</span> {
                            $dbPass-&gt;password(cryptPassword($pass));
                            $db-&gt;putPassword($dbPass);
                        }
                    }

                } <span class="keywordflow">else</span> {
                    $setRecord-&gt;restricted_login_proctor(<span class="stringliteral">&#39;Yes&#39;</span>);
                    my $procUser = $db-&gt;newUser();
                    $procUser-&gt;user_id($procID);
                    $procUser-&gt;last_name(<span class="stringliteral">&quot;Proctor&quot;</span>);
                    $procUser-&gt;first_name(<span class="stringliteral">&quot;Login&quot;</span>);
                    $procUser-&gt;student_id(<span class="stringliteral">&quot;loginproctor&quot;</span>);
                    $procUser-&gt;status($ce-&gt;status_name_to_abbrevs(<span class="stringliteral">&#39;Proctor&#39;</span>));
                    my $procPerm = $db-&gt;newPermissionLevel;
                    $procPerm-&gt;user_id($procID);
                    $procPerm-&gt;permission($ce-&gt;{userRoles}-&gt;{login_proctor});
                    my $procPass = $db-&gt;newPassword;
                    $procPass-&gt;user_id($procID);
                    $procPass-&gt;password(cryptPassword($pass));
<span class="preprocessor">                    # put these into the database</span>
<span class="preprocessor"></span>                    eval { $db-&gt;addUser($procUser) };
                    <span class="keywordflow">if</span> ( $@ ) { 
                        $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error adding set-level proctor: [_1]&quot;</span>, $@));
                    } <span class="keywordflow">else</span> {
                        $db-&gt;addPermissionLevel($procPerm);
                        $db-&gt;addPassword($procPass);
                    }

<span class="preprocessor">                    # and set the restricted_login_proctor</span>
<span class="preprocessor"></span><span class="preprocessor">                    #    set field</span>
<span class="preprocessor"></span>                    $db-&gt;putGlobalSet( $setRecord );
                }

            } <span class="keywordflow">else</span> {
<span class="preprocessor">                # if the parameter isn&#39;t set, or if the assignment</span>
<span class="preprocessor"></span><span class="preprocessor">                #    type is not &#39;proctored_gateway&#39;, then we need to be </span>
<span class="preprocessor"></span><span class="preprocessor">                #    sure that there&#39;s no set-level proctor defined</span>
<span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $setRecord-&gt;restricted_login_proctor eq <span class="stringliteral">&#39;Yes&#39;</span> ) {

                    $setRecord-&gt;restricted_login_proctor(<span class="stringliteral">&#39;No&#39;</span>);
                    $db-&gt;deleteUser( <span class="stringliteral">&quot;set_id:$setID&quot;</span> );
                    $db-&gt;putGlobalSet( $setRecord );

                }
            }
        }
        
<span class="preprocessor">        #####################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Save problem information</span>
<span class="preprocessor"></span><span class="preprocessor">        #####################################################################</span>
<span class="preprocessor"></span>
<span class="preprocessor">        # DBFIXME use a WHERE clause, iterator?</span>
<span class="preprocessor"></span>        my @problemIDs = sort { $a &lt;=&gt; $b } $db-&gt;listGlobalProblems($setID);;
        my @problemRecords = $db-&gt;getGlobalProblems(map { [$setID, $_] } @problemIDs);
        <span class="keywordflow">foreach</span> my $problemRecord (@problemRecords) {
            my $problemID = $problemRecord-&gt;problem_id;
            die $r-&gt;maketext(<span class="stringliteral">&quot;Global problem [_1] for set [_2] not found.&quot;</span>, $problemID, $setID) unless $problemRecord;
            
            <span class="keywordflow">if</span> ($forUsers) {
<span class="preprocessor">                # Since we&#39;re editing for specific users, we don&#39;t allow the GlobalProblem record to be altered on that same page</span>
<span class="preprocessor"></span><span class="preprocessor">                # So we only need to make changes to the UserProblem record and only then if we are overriding a value</span>
<span class="preprocessor"></span><span class="preprocessor">                # in the GlobalProblem record or for fields unique to the UserProblem record.</span>
<span class="preprocessor"></span>                                
                my @userIDs = @editForUser;

                my @userProblemRecords;
                <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
                    my @userProblemIDs = map { [$_, $setID, $problemID] } @userIDs;
<span class="preprocessor">                    # DBFIXME where clause? iterator?</span>
<span class="preprocessor"></span>                    @userProblemRecords = $db-&gt;getUserProblems(@userProblemIDs);
                } <span class="keywordflow">else</span> {
<span class="preprocessor">                    ## (we know that we&#39;re only editing for one user)</span>
<span class="preprocessor"></span>                    @userProblemRecords =
                        ( $db-&gt;getMergedProblemVersion( $userIDs[0], $setID, $editingSetVersion, $problemID ) );
                }

                <span class="keywordflow">foreach</span> my $record (@userProblemRecords) {

                    my $changed = 0; # keep track of any changes, <span class="keywordflow">if</span> none are made, avoid unnecessary db accesses
                    <span class="keywordflow">foreach</span> my $field ( @{ PROBLEM_FIELDS() } ) {
                        next unless <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab1d82f7e4749c6674e48c83232fb0d37">canChange</a>($forUsers, $field);

                        my $override = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field.override&quot;</span>);
                        <span class="keywordflow">if</span> (defined $override &amp;&amp; $override eq $field) {

                            my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
                            $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
                            my $unlabel = $undoLabels{$field}-&gt;{$param};
                            $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
<span class="preprocessor">                                                #protect exploits with source_file</span>
<span class="preprocessor"></span>                            <span class="keywordflow">if</span> ($field eq <span class="stringliteral">&#39;source_file&#39;</span>) {
<span class="preprocessor">                                # add message</span>
<span class="preprocessor"></span>                                <span class="keywordflow">if</span> ( $param =~ /\.\./ || $param =~ /^\<span class="comment">// ) {</span>
                                    $self-&gt;addbadmessage( $r-&gt;maketext(<span class="stringliteral">&quot;Source file paths cannot include .. or start with /: your source file path was modified.&quot;</span>) );
                                }
                                $param =~ s|\.\.||g;    # prevent access to files above <span class="keyword">template</span>
                                $param =~ s|^/||;       # prevent access to files above <span class="keyword">template</span>
                            }

                            $changed ||= <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a3b44dc54c21dddcb3a7823da5e6942cd">changed</a>($record-&gt;$field, $param);
                            $record-&gt;$field($param);
                        } <span class="keywordflow">else</span> {
                            $changed ||= <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a3b44dc54c21dddcb3a7823da5e6942cd">changed</a>($record-&gt;$field, undef);
                            $record-&gt;$field(undef);
                        }
                        
                    }
                    
                    <span class="keywordflow">foreach</span> my $field ( @{ USER_PROBLEM_FIELDS() } ) {
                        next unless <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab1d82f7e4749c6674e48c83232fb0d37">canChange</a>($forUsers, $field);

                        my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
                        $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
                        my $unlabel = $undoLabels{$field}-&gt;{$param};
                        $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
<span class="preprocessor">                                            #protect exploits with source_file</span>
<span class="preprocessor"></span>                        <span class="keywordflow">if</span> ($field eq <span class="stringliteral">&#39;source_file&#39;</span>) {
<span class="preprocessor">                            # add message</span>
<span class="preprocessor"></span>                            <span class="keywordflow">if</span> ( $param =~ /\.\./ || $param =~ /^\<span class="comment">// ) {</span>
                                $self-&gt;addbadmessage( $r-&gt;maketext(<span class="stringliteral">&quot;Source file paths cannot include .. or start with /: your source file path was modified.&quot;</span>));
                            }
                            $param =~ s|\.\.||g;    # prevent access to files above <span class="keyword">template</span>
                            $param =~ s|^/||;       # prevent access to files above <span class="keyword">template</span>
                        }

                        $changed ||= <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a3b44dc54c21dddcb3a7823da5e6942cd">changed</a>($record-&gt;$field, $param);
                        $record-&gt;$field($param);
                    }
                    <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
                        $db-&gt;putUserProblem($record) <span class="keywordflow">if</span> $changed;
                    } <span class="keywordflow">else</span> {
                        $db-&gt;putProblemVersion($record) <span class="keywordflow">if</span> $changed;
                    }
                }
            } <span class="keywordflow">else</span> { 
<span class="preprocessor">                # Since we&#39;re editing for ALL set users, we will make changes to the GlobalProblem record.</span>
<span class="preprocessor"></span><span class="preprocessor">                # We may also have instances where a field is unique to the UserProblem record but we want</span>
<span class="preprocessor"></span><span class="preprocessor">                # all users to (at least initially) have the same value</span>
<span class="preprocessor"></span>
<span class="preprocessor">                # this only edits a globalProblem record</span>
<span class="preprocessor"></span>                my $changed = 0; # keep track of any changes, <span class="keywordflow">if</span> none are made, avoid unnecessary db accesses
                <span class="keywordflow">foreach</span> my $field ( @{ PROBLEM_FIELDS() } ) {
                    next unless <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab1d82f7e4749c6674e48c83232fb0d37">canChange</a>($forUsers, $field);

                    my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
                    $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
                    my $unlabel = $undoLabels{$field}-&gt;{$param};
                    $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
                    
<span class="preprocessor">                    #protect exploits with source_file</span>
<span class="preprocessor"></span>                    <span class="keywordflow">if</span> ($field eq <span class="stringliteral">&#39;source_file&#39;</span>) {
<span class="preprocessor">                        # add message</span>
<span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( $param =~ /\.\./ || $param =~ /^\<span class="comment">// ) {</span>
                            $self-&gt;addbadmessage( $r-&gt;maketext(<span class="stringliteral">&quot;Source file paths cannot include .. or start with /: your source file path was modified.&quot;</span>) );
                        }
                        $param =~ s|\.\.||g;    # prevent access to files above <span class="keyword">template</span>
                        $param =~ s|^/||;       # prevent access to files above <span class="keyword">template</span>
                    }
                    $changed ||= <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a3b44dc54c21dddcb3a7823da5e6942cd">changed</a>($problemRecord-&gt;$field, $param);
                    $problemRecord-&gt;$field($param);
                }
                $db-&gt;putGlobalProblem($problemRecord) <span class="keywordflow">if</span> $changed;


<span class="preprocessor">                # sometimes (like for status) we might want to change an attribute in</span>
<span class="preprocessor"></span><span class="preprocessor">                # the userProblem record for every assigned user</span>
<span class="preprocessor"></span><span class="preprocessor">                # However, since this data is stored in the UserProblem records,</span>
<span class="preprocessor"></span><span class="preprocessor">                # it won&#39;t be displayed once its been changed and if you hit &quot;Save Changes&quot; again</span>
<span class="preprocessor"></span><span class="preprocessor">                # it gets erased</span>
<span class="preprocessor"></span>                
<span class="preprocessor">                # So we&#39;ll enforce that there be something worth putting in all the UserProblem records</span>
<span class="preprocessor"></span><span class="preprocessor">                # This also will make hitting &quot;Save Changes&quot; on the global page MUCH faster</span>
<span class="preprocessor"></span>                my %useful;
                <span class="keywordflow">foreach</span> my $field ( @{ USER_PROBLEM_FIELDS() } ) {
                    my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
                    $useful{$field} = 1 <span class="keywordflow">if</span> defined $param and $param ne <span class="stringliteral">&quot;&quot;</span>;
                }

                <span class="keywordflow">if</span> (keys %useful) {
<span class="preprocessor">                    # DBFIXME where clause, iterator</span>
<span class="preprocessor"></span>                    my @userIDs = $db-&gt;listProblemUsers($setID, $problemID);
                    my @userProblemIDs = map { [$_, $setID, $problemID] } @userIDs;
                    my @userProblemRecords = $db-&gt;getUserProblems(@userProblemIDs);
                    <span class="keywordflow">foreach</span> my $record (@userProblemRecords) {
                        my $changed = 0; # keep track of any changes, <span class="keywordflow">if</span> none are made, avoid unnecessary db accesses
                        <span class="keywordflow">foreach</span> my $field ( keys %useful ) {
                            next unless <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#ab1d82f7e4749c6674e48c83232fb0d37">canChange</a>($forUsers, $field);

                            my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
                            $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
                            my $unlabel = $undoLabels{$field}-&gt;{$param};
                            $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
                            $changed ||= <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a3b44dc54c21dddcb3a7823da5e6942cd">changed</a>($record-&gt;$field, $param);
                            $record-&gt;$field($param);
                        }
                        $db-&gt;putUserProblem($record) <span class="keywordflow">if</span> $changed;
                    }
                }
            }
        }
        
<span class="preprocessor">        # Mark the specified problems as correct for all users (not applicable when editing a set</span>
<span class="preprocessor"></span><span class="preprocessor">        #    version, because this only shows up when editing for users or editing the</span>
<span class="preprocessor"></span><span class="preprocessor">        #    global set/problem, not for one user)</span>
<span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $problemID ($r-&gt;param(<span class="stringliteral">&#39;markCorrect&#39;</span>)) {
<span class="preprocessor">            # DBFIXME where clause, iterator</span>
<span class="preprocessor"></span>            my @userProblemIDs = map { [$_, $setID, $problemID] } ($forUsers ? @editForUser : $db-&gt;listProblemUsers($setID, $problemID));
<span class="preprocessor">            # if the set is not a gateway set, this requires going through the</span>
<span class="preprocessor"></span><span class="preprocessor">            #    user_problems and resetting their status; if it&#39;s a gateway set,</span>
<span class="preprocessor"></span><span class="preprocessor">            #    then we have to go through every *version* of every user_problem.</span>
<span class="preprocessor"></span><span class="preprocessor">            #    it may be that there is an argument for being able to get() all</span>
<span class="preprocessor"></span><span class="preprocessor">            #    problem versions for all users in one database call.  The current</span>
<span class="preprocessor"></span><span class="preprocessor">            #    code may be slow for large classes.</span>
<span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $setRecord-&gt;assignment_type !~ /gateway/ ) {
                my @userProblemRecords = $db-&gt;getUserProblems(@userProblemIDs);
                <span class="keywordflow">foreach</span> my $record (@userProblemRecords) {
                    <span class="keywordflow">if</span> (defined $record &amp;&amp; ($record-&gt;status eq <span class="stringliteral">&quot;&quot;</span> || $record-&gt;status &lt; 1)) {
                        $record-&gt;status(1);
                        $record-&gt;attempted(1);
                        $db-&gt;putUserProblem($record);
                    }
                }
            } <span class="keywordflow">else</span> {
                my @userIDs = ( $forUsers ) ? @editForUser : $db-&gt;listProblemUsers($setID, $problemID);
                <span class="keywordflow">foreach</span> my $uid ( @userIDs ) {
                    my @versions = $db-&gt;listSetVersions( $uid, $setID );
                    my @userProblemVersionIDs = 
                        map{ [ $uid, $setID, $_, $problemID ]} @versions;
                    my @userProblemVersionRecords = $db-&gt;getProblemVersions(@userProblemVersionIDs);
                    <span class="keywordflow">foreach</span> my $record (@userProblemVersionRecords) { 
                        <span class="keywordflow">if</span> (defined $record &amp;&amp; ($record-&gt;status eq <span class="stringliteral">&quot;&quot;</span> || $record-&gt;status &lt; 1)) {
                            $record-&gt;status(1);
                            $record-&gt;attempted(1);
                            $db-&gt;putProblemVersion($record);
                        }
                    }
                }
            }
        }
        
<span class="preprocessor">        # Delete all problems marked for deletion (not applicable when editing</span>
<span class="preprocessor"></span><span class="preprocessor">        #    for users)</span>
<span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $problemID ($r-&gt;param(<span class="stringliteral">&#39;deleteProblem&#39;</span>)) {
            $db-&gt;deleteGlobalProblem($setID, $problemID);
        }
        
<span class="preprocessor">        #####################################################################</span>
<span class="preprocessor"></span><span class="preprocessor">        # Add blank problem if needed</span>
<span class="preprocessor"></span><span class="preprocessor">        #####################################################################</span>
<span class="preprocessor"></span>        <span class="keywordflow">if</span> (defined($r-&gt;param(<span class="stringliteral">&quot;add_blank_problem&quot;</span>) ) and $r-&gt;param(<span class="stringliteral">&quot;add_blank_problem&quot;</span>) == 1) {
<span class="preprocessor">           # get number of problems to add and clean the entry</span>
<span class="preprocessor"></span>            my $newBlankProblems = (defined($r-&gt;param(<span class="stringliteral">&quot;add_n_problems&quot;</span>)) ) ? $r-&gt;param(<span class="stringliteral">&quot;add_n_problems&quot;</span>) :1;
            $newBlankProblems = int($newBlankProblems);
            my $MAX_NEW_PROBLEMS = 20;
            <span class="keywordflow">if</span> ($newBlankProblems &gt;=1 and $newBlankProblems &lt;= $MAX_NEW_PROBLEMS ) {
                <span class="keywordflow">foreach</span> my $newProb (1..$newBlankProblems) {
                        my $targetProblemNumber   =  1+ <a class="code" href="classWeBWorK_1_1Utils.html#a3d364a4d0cb81eef75c34845afb179e3">WeBWorK::Utils::max</a>( $self-&gt;r-&gt;db-&gt;listGlobalProblems($setID));
<span class="preprocessor">                        ##################################################</span>
<span class="preprocessor"></span><span class="preprocessor">                        # make local copy of the blankProblem</span>
<span class="preprocessor"></span><span class="preprocessor">                        ##################################################</span>
<span class="preprocessor"></span>                        my $blank_file_path       =  $ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{blankProblem};
                        my $problemContents       =  <a class="code" href="classWeBWorK_1_1Utils.html#a7aa337cd97110ff3e5c7536bfb1a84e8">WeBWorK::Utils::readFile</a>($blank_file_path);
                        my $new_file_path         =  <span class="stringliteral">&quot;set$setID/&quot;</span>.BLANKPROBLEM();
                        my $fullPath              =  <a class="code" href="classWeBWorK_1_1Utils.html#aec74ceba9815c67c2d10f46fbe909063">WeBWorK::Utils::surePathToFile</a>($ce-&gt;{courseDirs}-&gt;{templates},<span class="charliteral">&#39;/&#39;</span>.$new_file_path);
                        local(*TEMPFILE);
                        open(TEMPFILE, <span class="stringliteral">&quot;&gt;$fullPath&quot;</span>) or warn $r-&gt;maketext(&quot;Can&#39;t write to file [_1]&quot;, $fullPath);
                        print TEMPFILE $problemContents;
                        close(TEMPFILE);
                        
                        <span class="preprocessor">#################################################</span>
<span class="preprocessor"></span><span class="preprocessor">                        # Update problem record</span>
<span class="preprocessor"></span><span class="preprocessor">                        #################################################</span>
<span class="preprocessor"></span>                        my $problemRecord  = $self-&gt;addProblemToSet(
                                   setName        =&gt; $setID,
                                   sourceFile     =&gt; $new_file_path, 
                                   problemID      =&gt; $targetProblemNumber, #added to end of <span class="keyword">set</span>
                        );
                        $self-&gt;assignProblemToAllSetUsers($problemRecord);
                        $self-&gt;addgoodmessage($r-&gt;maketext(<span class="stringliteral">&quot;Added [_1] to [_2] as problem [_3]&quot;</span>, $new_file_path, $setID, $targetProblemNumber)) ;
                }
            } <span class="keywordflow">else</span> {
                $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Could not add [_1] problems to this set.  The number must be between 1 and [_2]&quot;</span>, $newBlankProblems, $MAX_NEW_PROBLEMS));
            }
        }
        
<span class="preprocessor">        # Sets the specified header to &quot;defaultHeader&quot; so that the default file will get used.</span>
<span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $header ($r-&gt;param(<span class="stringliteral">&#39;defaultHeader&#39;</span>)) {
            $setRecord-&gt;$header(<span class="stringliteral">&quot;defaultHeader&quot;</span>);
        }
    }   
    



<span class="preprocessor">    # This erases any sticky fields if the user saves changes, resets the form, or reorders problems</span>
<span class="preprocessor"></span><span class="preprocessor">    # It may not be obvious why this is necessary when saving changes or reordering problems</span>
<span class="preprocessor"></span><span class="preprocessor">    #   but when the problems are reorder the param problem.1.source_file needs to be the source</span>
<span class="preprocessor"></span><span class="preprocessor">    #   file of the problem that is NOW #1 and not the problem that WAS #1.</span>
<span class="preprocessor"></span>    unless (defined $r-&gt;param(<span class="stringliteral">&#39;refresh&#39;</span>)) {
        
<span class="preprocessor">        # reset all the parameters dealing with set/problem/header information</span>
<span class="preprocessor"></span><span class="preprocessor">        # if the current naming scheme is changed/broken, this could reek havoc</span>
<span class="preprocessor"></span><span class="preprocessor">        # on all kinds of things</span>
<span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $param ($r-&gt;param) {
            $r-&gt;param($param, <span class="stringliteral">&quot;&quot;</span>) <span class="keywordflow">if</span> $param =~ /^(<span class="keyword">set</span>|problem|<a class="code" href="classWeBWorK_1_1ContentGenerator.html#ad1905f1621af61ea10def7aae24b7b8b">header</a>)\./  &amp;&amp; $param !~ /displaymode/;
        }
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a9c3fba313741ab7ad57ecd9fcd8903a1"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::options" ref="a9c3fba313741ab7ad57ecd9fcd8903a1" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::options </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-options' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-options-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-options-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-options-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in options: 3</span>
<span class="preprocessor"></span>sub options {
    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a79607043dba76c6b5f55ee30e488622a"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::problem_number_popup" ref="a79607043dba76c6b5f55ee30e488622a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::problem_number_popup </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-problem_number_popup' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-problem_number_popup-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-problem_number_popup-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-problem_number_popup-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in problem_number_popup: 7</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a79607043dba76c6b5f55ee30e488622a">problem_number_popup</a> {
    my $num = shift;
    my $total = shift;
    <span class="keywordflow">return</span> (CGI::popup_menu(-name =&gt; <span class="stringliteral">&quot;problem_num_$num&quot;</span>,
                -values =&gt; [1..$total],
                -<span class="keywordflow">default</span> =&gt; $num));
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a7f2fa5c4662e56b67ef177d3ac5edc36"></a><!-- doxytag: member="WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::proctoredFieldHTML" ref="a7f2fa5c4662e56b67ef177d3ac5edc36" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::ContentGenerator::Instructor::ProblemSetDetail::proctoredFieldHTML </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-proctoredFieldHTML' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-proctoredFieldHTML-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-proctoredFieldHTML-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-proctoredFieldHTML-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in proctoredFieldHTML: 26</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html#a7f2fa5c4662e56b67ef177d3ac5edc36">proctoredFieldHTML</a> {
    my ( $self, $userID, $setID, $globalRecord ) = @_;

    my $r = $self-&gt;r;
    my $db = $r-&gt;db;

<span class="preprocessor">    # note that this routine assumes that the login proctor password</span>
<span class="preprocessor"></span><span class="preprocessor">    #    is something that can only be changed for the global set</span>
<span class="preprocessor"></span>
<span class="preprocessor">    # if the set doesn&#39;t require a login proctor, then we can assume</span>
<span class="preprocessor"></span><span class="preprocessor">    #    that one doesn&#39;t exist; otherwise, we need to check the </span>
<span class="preprocessor"></span><span class="preprocessor">    #    database to find if there&#39;s an already defined password</span>
<span class="preprocessor"></span>    my $value = <span class="stringliteral">&#39;&#39;</span>;
    <span class="keywordflow">if</span> ( $globalRecord-&gt;restricted_login_proctor eq <span class="stringliteral">&#39;Yes&#39;</span> &amp;&amp;
         $db-&gt;existsPassword(<span class="stringliteral">&quot;set_id:$setID&quot;</span>) ) {
        $value = <span class="stringliteral">&#39;********&#39;</span>;
    }

    <span class="keywordflow">return</span>( ( <span class="stringliteral">&#39;&#39;</span>,
          $r-&gt;maketext(<span class="stringliteral">&#39;Password (Leave blank for regular proctoring)&#39;</span>),
          CGI::input({ name=&gt;<span class="stringliteral">&quot;set.$setID.restricted_login_proctor_password&quot;</span>,
                   value=&gt;$value,
                   size=&gt;10,
               }),
          <span class="stringliteral">&#39;&#39;</span> ) );
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="ProblemSetDetail_8pm_source.html">ProblemSetDetail.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:57:48 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
