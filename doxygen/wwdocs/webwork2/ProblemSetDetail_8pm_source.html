<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: ProblemSetDetail.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>ProblemSetDetail.pm</h1><a href="ProblemSetDetail_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::Instructor::ProblemSetDetail;
<a name="l00018"></a>00018 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">WeBWorK::ContentGenerator::Instructor</a>);
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 =head1 NAME
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html">WeBWorK::ContentGenerator::Instructor::ProblemSetDetail</a> - Edit general <span class="keyword">set</span> and specific user/<span class="keyword">set</span> information as well as problem information
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 =cut
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 use strict;
<a name="l00027"></a>00027 use warnings;
<a name="l00028"></a>00028 <span class="preprocessor">#use CGI qw(-nosticky );</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00030"></a>00030 use WeBWorK::HTML::ComboBox qw/comboBox/;
<a name="l00031"></a>00031 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(readDirectory list2hash sortByName listFilesRecursive max cryptPassword);
<a name="l00032"></a>00032 use <a class="code" href="classWeBWorK_1_1Utils_1_1Tasks.html">WeBWorK::Utils::Tasks</a> qw(renderProblems);
<a name="l00033"></a>00033 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00034"></a>00034 <span class="preprocessor"># IP RESTRICT</span>
<a name="l00035"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1ProblemSetDetail.html">00035</a> <span class="preprocessor"></span>use WeBWorK::HTML::ScrollingRecordList qw/scrollingRecordList/;
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor"># Important Note: the following two sets of constants may seem similar </span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#   but they are functionally and semantically different</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span>
<a name="l00040"></a>00040 <span class="preprocessor"># these constants determine which fields belong to what type of record</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>use constant SET_FIELDS =&gt; [qw(set_header hardcopy_header open_date due_date answer_date visible enable_reduced_scoring restrict_ip relax_restrict_ip assignment_type attempts_per_version version_time_limit time_limit_cap versions_per_interval time_interval problem_randorder problems_per_page hide_score:hide_score_by_problem hide_work)];
<a name="l00042"></a>00042 use constant PROBLEM_FIELDS =&gt;[qw(source_file value max_attempts)];
<a name="l00043"></a>00043 use constant USER_PROBLEM_FIELDS =&gt; [qw(problem_seed status num_correct num_incorrect)];
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor"># these constants determine what order those fields should be displayed in</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>use constant HEADER_ORDER =&gt; [qw(set_header hardcopy_header)];
<a name="l00047"></a>00047 use constant PROBLEM_FIELD_ORDER =&gt; [qw(problem_seed status value max_attempts attempted last_answer num_correct num_incorrect)];
<a name="l00048"></a>00048 <span class="preprocessor"># for gateway sets, we don&#39;t want to allow users to change max_attempts on a per</span>
<a name="l00049"></a>00049 <span class="preprocessor"></span><span class="preprocessor">#    problem basis, as that&#39;s nothing but confusing.</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>use constant GATEWAY_PROBLEM_FIELD_ORDER =&gt; [qw(problem_seed status value attempted last_answer num_correct num_incorrect)];
<a name="l00051"></a>00051 
<a name="l00052"></a>00052 <span class="preprocessor"># we exclude the gateway set fields from the set field order, because they</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">#     are only displayed for sets that are gateways.  this results in a bit of</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span><span class="preprocessor">#     convoluted logic below, but it saves burdening people who are only using</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">#     homework assignments with all of the gateway parameters</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor"># FIXME: in the long run, we may want to let hide_score and hide_work be</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor"># FIXME: set for non-gateway assignments.  right now (11/30/06) they are</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor"># FIXME: only used for gateways</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>use constant SET_FIELD_ORDER =&gt; [qw(open_date due_date answer_date visible enable_reduced_scoring restrict_ip relax_restrict_ip assignment_type)];
<a name="l00060"></a>00060 <span class="preprocessor"># use constant GATEWAY_SET_FIELD_ORDER =&gt; [qw(attempts_per_version version_time_limit time_interval versions_per_interval problem_randorder problems_per_page hide_score hide_work)];</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span>use constant GATEWAY_SET_FIELD_ORDER =&gt; [qw(version_time_limit time_limit_cap attempts_per_version time_interval versions_per_interval problem_randorder problems_per_page hide_score:hide_score_by_problem hide_work)];
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor"># this constant is massive hash of information corresponding to each db field.</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span><span class="preprocessor"># override indicates for how many students at a time a field can be overridden</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor"># this hash should make it possible to NEVER have explicitly: if (somefield) { blah() }</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">#   All but name are optional</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#   some_field =&gt; {</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#       name      =&gt; &quot;Some Field&quot;,</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#       type      =&gt; &quot;edit&quot;,        # edit, choose, hidden, view - defines how the data is displayed</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span><span class="preprocessor">#       size      =&gt; &quot;50&quot;,      # size of the edit box (if any)</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#       override  =&gt; &quot;none&quot;,        # none, one, any, all - defines for whom this data can/must be overidden</span>
<a name="l00073"></a>00073 <span class="preprocessor"></span><span class="preprocessor">#       module    =&gt; &quot;problem_list&quot;,    # WeBWorK module </span>
<a name="l00074"></a>00074 <span class="preprocessor"></span><span class="preprocessor">#       default   =&gt; 0          # if a field cannot default to undefined/empty what should it default to</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor">#       labels    =&gt; {          # special values can be hashed to display labels</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span><span class="preprocessor">#               1 =&gt; &quot;Yes&quot;,</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#               0 =&gt; &quot;No&quot;,</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#       },</span>
<a name="l00079"></a>00079 <span class="preprocessor"></span><span class="preprocessor">#               convertby =&gt; 60,                # divide incoming database field values by this, and multiply when saving</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span>
<a name="l00081"></a>00081 use constant BLANKPROBLEM =&gt; <span class="stringliteral">&#39;blankProblem.pg&#39;</span>;
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 use constant FIELD_PROPERTIES =&gt; {
<a name="l00084"></a>00084 <span class="preprocessor">    # Set information</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span>    set_header =&gt; {
<a name="l00086"></a>00086         name      =&gt; <span class="stringliteral">&quot;Set Header&quot;</span>,
<a name="l00087"></a>00087         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00088"></a>00088         size      =&gt; <span class="stringliteral">&quot;50&quot;</span>,
<a name="l00089"></a>00089         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;all&quot;</span>,
<a name="l00090"></a>00090         module    =&gt; <span class="stringliteral">&quot;problem_list&quot;</span>,
<a name="l00091"></a>00091         <span class="keywordflow">default</span>   =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00092"></a>00092     },
<a name="l00093"></a>00093     hardcopy_header =&gt; {
<a name="l00094"></a>00094         name      =&gt; <span class="stringliteral">&quot;Hardcopy Header&quot;</span>,
<a name="l00095"></a>00095         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00096"></a>00096         size      =&gt; <span class="stringliteral">&quot;50&quot;</span>,
<a name="l00097"></a>00097         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;all&quot;</span>,
<a name="l00098"></a>00098         module    =&gt; <span class="stringliteral">&quot;hardcopy_preselect_set&quot;</span>,
<a name="l00099"></a>00099         <span class="keywordflow">default</span>   =&gt; <span class="stringliteral">&quot;&quot;</span>,        
<a name="l00100"></a>00100     },
<a name="l00101"></a>00101     open_date =&gt; {
<a name="l00102"></a>00102         name      =&gt; <span class="stringliteral">&quot;Opens&quot;</span>,
<a name="l00103"></a>00103         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00104"></a>00104         size      =&gt; <span class="stringliteral">&quot;26&quot;</span>,
<a name="l00105"></a>00105         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00106"></a>00106         labels    =&gt; {
<a name="l00107"></a>00107 <span class="preprocessor">                #0 =&gt; &quot;None Specified&quot;,</span>
<a name="l00108"></a>00108 <span class="preprocessor"></span>                <span class="stringliteral">&quot;&quot;</span> =&gt; <span class="stringliteral">&quot;None Specified&quot;</span>,
<a name="l00109"></a>00109         },
<a name="l00110"></a>00110     },
<a name="l00111"></a>00111     due_date =&gt; {
<a name="l00112"></a>00112         name      =&gt; <span class="stringliteral">&quot;Answers Due&quot;</span>,
<a name="l00113"></a>00113         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00114"></a>00114         size      =&gt; <span class="stringliteral">&quot;26&quot;</span>,
<a name="l00115"></a>00115         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00116"></a>00116         labels    =&gt; {
<a name="l00117"></a>00117 <span class="preprocessor">                #0 =&gt; &quot;None Specified&quot;,</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span>                <span class="stringliteral">&quot;&quot;</span> =&gt; <span class="stringliteral">&quot;None Specified&quot;</span>,
<a name="l00119"></a>00119         },
<a name="l00120"></a>00120     },
<a name="l00121"></a>00121     answer_date =&gt; {
<a name="l00122"></a>00122         name      =&gt; <span class="stringliteral">&quot;Answers Available&quot;</span>,
<a name="l00123"></a>00123         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00124"></a>00124         size      =&gt; <span class="stringliteral">&quot;26&quot;</span>,
<a name="l00125"></a>00125         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00126"></a>00126         labels    =&gt; {
<a name="l00127"></a>00127 <span class="preprocessor">                #0 =&gt; &quot;None Specified&quot;,</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>                <span class="stringliteral">&quot;&quot;</span> =&gt; <span class="stringliteral">&quot;None Specified&quot;</span>,
<a name="l00129"></a>00129         },
<a name="l00130"></a>00130     },
<a name="l00131"></a>00131     visible =&gt; {
<a name="l00132"></a>00132         name      =&gt; <span class="stringliteral">&quot;Visible to Students&quot;</span>,
<a name="l00133"></a>00133         type      =&gt; <span class="stringliteral">&quot;choose&quot;</span>,
<a name="l00134"></a>00134         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;all&quot;</span>,
<a name="l00135"></a>00135         choices   =&gt; [qw( 0 1 )],
<a name="l00136"></a>00136         labels    =&gt; {
<a name="l00137"></a>00137                 1 =&gt; <span class="stringliteral">&quot;Yes&quot;</span>,
<a name="l00138"></a>00138                 0 =&gt; <span class="stringliteral">&quot;No&quot;</span>,
<a name="l00139"></a>00139         },
<a name="l00140"></a>00140     },
<a name="l00141"></a>00141     enable_reduced_scoring =&gt; {
<a name="l00142"></a>00142         name      =&gt; <span class="stringliteral">&quot;Reduced Credit Enabled&quot;</span>,
<a name="l00143"></a>00143         type      =&gt; <span class="stringliteral">&quot;choose&quot;</span>,
<a name="l00144"></a>00144         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;all&quot;</span>,
<a name="l00145"></a>00145         choices   =&gt; [qw( 0 1 )],
<a name="l00146"></a>00146         labels    =&gt; {
<a name="l00147"></a>00147                 1 =&gt; <span class="stringliteral">&quot;Yes&quot;</span>,
<a name="l00148"></a>00148                 0 =&gt; <span class="stringliteral">&quot;No&quot;</span>,
<a name="l00149"></a>00149         },
<a name="l00150"></a>00150     },
<a name="l00151"></a>00151     restrict_ip =&gt; {
<a name="l00152"></a>00152         name      =&gt; <span class="stringliteral">&quot;Restrict Access by IP&quot;</span>,
<a name="l00153"></a>00153         type      =&gt; <span class="stringliteral">&quot;choose&quot;</span>,
<a name="l00154"></a>00154         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00155"></a>00155         choices   =&gt; [qw( No RestrictTo DenyFrom )],
<a name="l00156"></a>00156         labels    =&gt; {
<a name="l00157"></a>00157                 No =&gt; <span class="stringliteral">&quot;No&quot;</span>,
<a name="l00158"></a>00158                 RestrictTo =&gt; <span class="stringliteral">&quot;Restrict To&quot;</span>,
<a name="l00159"></a>00159                 DenyFrom =&gt; <span class="stringliteral">&quot;Deny From&quot;</span>,
<a name="l00160"></a>00160         },
<a name="l00161"></a>00161         <span class="keywordflow">default</span>   =&gt; <span class="stringliteral">&#39;No&#39;</span>,
<a name="l00162"></a>00162     },
<a name="l00163"></a>00163     relax_restrict_ip =&gt; { 
<a name="l00164"></a>00164         name      =&gt; <span class="stringliteral">&quot;Relax IP restrictions when?&quot;</span>,
<a name="l00165"></a>00165         type      =&gt; <span class="stringliteral">&quot;choose&quot;</span>,
<a name="l00166"></a>00166         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00167"></a>00167         choices   =&gt; [qw( No AfterAnswerDate AfterVersionAnswerDate )],
<a name="l00168"></a>00168         labels    =&gt; {
<a name="l00169"></a>00169                 No =&gt; <span class="stringliteral">&quot;Never&quot;</span>,
<a name="l00170"></a>00170                 AfterAnswerDate =&gt; <span class="stringliteral">&quot;After set answer date&quot;</span>,
<a name="l00171"></a>00171                 AfterVersionAnswerDate =&gt; <span class="stringliteral">&quot;(gw/quiz) After version answer date&quot;</span>,
<a name="l00172"></a>00172         },
<a name="l00173"></a>00173         <span class="keywordflow">default</span>   =&gt; <span class="stringliteral">&#39;No&#39;</span>,
<a name="l00174"></a>00174     },
<a name="l00175"></a>00175     assignment_type =&gt; {
<a name="l00176"></a>00176         name      =&gt; <span class="stringliteral">&quot;Assignment type&quot;</span>,
<a name="l00177"></a>00177         type      =&gt; <span class="stringliteral">&quot;choose&quot;</span>,
<a name="l00178"></a>00178         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;all&quot;</span>,
<a name="l00179"></a>00179         choices   =&gt; [qw( <span class="keywordflow">default</span> gateway proctored_gateway )],
<a name="l00180"></a>00180         labels    =&gt; {  <span class="keywordflow">default</span> =&gt; <span class="stringliteral">&quot;homework&quot;</span>,
<a name="l00181"></a>00181                 gateway =&gt; <span class="stringliteral">&quot;gateway/quiz&quot;</span>,
<a name="l00182"></a>00182                 proctored_gateway =&gt; <span class="stringliteral">&quot;proctored gateway/quiz&quot;</span>,
<a name="l00183"></a>00183         },
<a name="l00184"></a>00184     },
<a name="l00185"></a>00185     version_time_limit =&gt; {
<a name="l00186"></a>00186         name      =&gt; <span class="stringliteral">&quot;Test Time Limit (min)&quot;</span>,
<a name="l00187"></a>00187         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00188"></a>00188         size      =&gt; <span class="stringliteral">&quot;4&quot;</span>,
<a name="l00189"></a>00189         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00190"></a>00190 <span class="preprocessor">#       labels    =&gt; {  &quot;&quot; =&gt; 0 },  # I&#39;m not sure this is quite right</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span>        convertby =&gt; 60,
<a name="l00192"></a>00192     },
<a name="l00193"></a>00193     time_limit_cap =&gt; {
<a name="l00194"></a>00194         name      =&gt; <span class="stringliteral">&quot;Cap Test Time at Set Due Date?&quot;</span>,
<a name="l00195"></a>00195         type      =&gt; <span class="stringliteral">&quot;choose&quot;</span>,
<a name="l00196"></a>00196         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;all&quot;</span>,
<a name="l00197"></a>00197         choices   =&gt; [qw(0 1)],
<a name="l00198"></a>00198         labels    =&gt; { <span class="charliteral">&#39;0&#39;</span> =&gt; <span class="stringliteral">&#39;No&#39;</span>, <span class="charliteral">&#39;1&#39;</span> =&gt; <span class="stringliteral">&#39;Yes&#39;</span> },
<a name="l00199"></a>00199     },
<a name="l00200"></a>00200     attempts_per_version =&gt; {
<a name="l00201"></a>00201         name      =&gt; <span class="stringliteral">&quot;Number of Graded Submissions per Test&quot;</span>,
<a name="l00202"></a>00202         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00203"></a>00203         size      =&gt; <span class="stringliteral">&quot;3&quot;</span>,
<a name="l00204"></a>00204         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00205"></a>00205 <span class="preprocessor">#       labels    =&gt; {  &quot;&quot; =&gt; 1 },</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span>    },
<a name="l00207"></a>00207     time_interval =&gt; {
<a name="l00208"></a>00208         name      =&gt; <span class="stringliteral">&quot;Time Interval for New Test Versions (min; 0=infty)&quot;</span>,
<a name="l00209"></a>00209         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00210"></a>00210                 size      =&gt; <span class="stringliteral">&quot;5&quot;</span>,
<a name="l00211"></a>00211         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00212"></a>00212 <span class="preprocessor">#       labels    =&gt; {  &quot;&quot; =&gt; 0 },</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span>        convertby =&gt; 60,
<a name="l00214"></a>00214     },
<a name="l00215"></a>00215     versions_per_interval =&gt; {
<a name="l00216"></a>00216         name      =&gt; <span class="stringliteral">&quot;Number of Tests per Time Interval (0=infty)&quot;</span>,
<a name="l00217"></a>00217         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00218"></a>00218                 size      =&gt; <span class="stringliteral">&quot;3&quot;</span>,
<a name="l00219"></a>00219         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00220"></a>00220         <span class="keywordflow">default</span>   =&gt; <span class="stringliteral">&quot;0&quot;</span>,
<a name="l00221"></a>00221         format    =&gt; <span class="stringliteral">&#39;[0-9]+&#39;</span>,      # an integer, possibly zero
<a name="l00222"></a>00222 <span class="preprocessor">#       labels    =&gt; {  &quot;&quot; =&gt; 0 },</span>
<a name="l00223"></a>00223 <span class="preprocessor"></span><span class="preprocessor">#       labels    =&gt; {  &quot;&quot; =&gt; 1 },</span>
<a name="l00224"></a>00224 <span class="preprocessor"></span>    },
<a name="l00225"></a>00225     problem_randorder =&gt; {
<a name="l00226"></a>00226         name      =&gt; <span class="stringliteral">&quot;Order Problems Randomly&quot;</span>,
<a name="l00227"></a>00227         type      =&gt; <span class="stringliteral">&quot;choose&quot;</span>,
<a name="l00228"></a>00228         choices   =&gt; [qw( 0 1 )],
<a name="l00229"></a>00229         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00230"></a>00230         labels    =&gt; {  0 =&gt; <span class="stringliteral">&quot;No&quot;</span>, 1 =&gt; <span class="stringliteral">&quot;Yes&quot;</span> },
<a name="l00231"></a>00231     },
<a name="l00232"></a>00232     problems_per_page =&gt; {
<a name="l00233"></a>00233             name      =&gt; <span class="stringliteral">&quot;Number of Problems per Page (0=all)&quot;</span>,
<a name="l00234"></a>00234         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00235"></a>00235         size      =&gt; <span class="stringliteral">&quot;3&quot;</span>,
<a name="l00236"></a>00236         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00237"></a>00237         <span class="keywordflow">default</span>   =&gt; <span class="stringliteral">&quot;0&quot;</span>,
<a name="l00238"></a>00238 <span class="preprocessor">#       labels    =&gt; { &quot;&quot; =&gt; 0 },</span>
<a name="l00239"></a>00239 <span class="preprocessor"></span>    },
<a name="l00240"></a>00240     <span class="stringliteral">&#39;hide_score:hide_score_by_problem&#39;</span> =&gt; {
<a name="l00241"></a>00241         name      =&gt; <span class="stringliteral">&quot;Show Scores on Finished Assignments?&quot;</span>,
<a name="l00242"></a>00242         type      =&gt; <span class="stringliteral">&quot;choose&quot;</span>,
<a name="l00243"></a>00243         choices   =&gt; [ qw( N: Y:N BeforeAnswerDate:N Y:Y BeforeAnswerDate:Y ) ],
<a name="l00244"></a>00244         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00245"></a>00245         labels    =&gt; { <span class="stringliteral">&#39;N:&#39;</span> =&gt; <span class="stringliteral">&#39;Yes&#39;</span>, <span class="stringliteral">&#39;Y:N&#39;</span> =&gt; <span class="stringliteral">&#39;No&#39;</span>, <span class="stringliteral">&#39;BeforeAnswerDate:N&#39;</span> =&gt; <span class="stringliteral">&#39;Only after set answer date&#39;</span>, <span class="stringliteral">&#39;Y:Y&#39;</span> =&gt; <span class="stringliteral">&#39;Totals only (not problem scores)&#39;</span>, <span class="stringliteral">&#39;BeforeAnswerDate:Y&#39;</span> =&gt; <span class="stringliteral">&#39;Totals only, only after answer date&#39;</span> },
<a name="l00246"></a>00246     },
<a name="l00247"></a>00247     hide_work         =&gt; {
<a name="l00248"></a>00248         name      =&gt; <span class="stringliteral">&quot;Show Student Work on Finished Tests&quot;</span>,
<a name="l00249"></a>00249         type      =&gt; <span class="stringliteral">&quot;choose&quot;</span>,
<a name="l00250"></a>00250         choices   =&gt; [ qw(N Y BeforeAnswerDate) ],
<a name="l00251"></a>00251         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00252"></a>00252         labels    =&gt; { <span class="charliteral">&#39;N&#39;</span> =&gt; <span class="stringliteral">&quot;Yes&quot;</span>, <span class="charliteral">&#39;Y&#39;</span> =&gt; <span class="stringliteral">&quot;No&quot;</span>, <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> =&gt; <span class="stringliteral">&#39;Only after set answer date&#39;</span> },
<a name="l00253"></a>00253     },
<a name="l00254"></a>00254 <span class="preprocessor">    # in addition to the set fields above, there are a number of things</span>
<a name="l00255"></a>00255 <span class="preprocessor"></span><span class="preprocessor">    #    that are set but aren&#39;t in this table:</span>
<a name="l00256"></a>00256 <span class="preprocessor"></span><span class="preprocessor">    #    any set proctor information (which is in the user tables), and</span>
<a name="l00257"></a>00257 <span class="preprocessor"></span><span class="preprocessor">    #    any set location restriction information (which is in the </span>
<a name="l00258"></a>00258 <span class="preprocessor"></span><span class="preprocessor">    #    location tables)</span>
<a name="l00259"></a>00259 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span><span class="preprocessor">    # Problem information</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span>    source_file =&gt; {
<a name="l00262"></a>00262         name      =&gt; <span class="stringliteral">&quot;Source File&quot;</span>,
<a name="l00263"></a>00263         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00264"></a>00264         size      =&gt; 50,
<a name="l00265"></a>00265         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00266"></a>00266         <span class="keywordflow">default</span>   =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00267"></a>00267     },
<a name="l00268"></a>00268     value =&gt; {
<a name="l00269"></a>00269         name      =&gt; <span class="stringliteral">&quot;Weight&quot;</span>,
<a name="l00270"></a>00270         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00271"></a>00271         size      =&gt; 6,
<a name="l00272"></a>00272         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00273"></a>00273     },
<a name="l00274"></a>00274     max_attempts =&gt; {
<a name="l00275"></a>00275         name      =&gt; <span class="stringliteral">&quot;Max&amp;nbsp;attempts&quot;</span>,
<a name="l00276"></a>00276         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00277"></a>00277         size      =&gt; 6,
<a name="l00278"></a>00278         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00279"></a>00279         labels    =&gt; {
<a name="l00280"></a>00280                 <span class="stringliteral">&quot;-1&quot;</span> =&gt; <span class="stringliteral">&quot;unlimited&quot;</span>,
<a name="l00281"></a>00281         },
<a name="l00282"></a>00282     },
<a name="l00283"></a>00283     problem_seed =&gt; {
<a name="l00284"></a>00284         name      =&gt; <span class="stringliteral">&quot;Seed&quot;</span>,
<a name="l00285"></a>00285         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00286"></a>00286         size      =&gt; 6,
<a name="l00287"></a>00287         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;one&quot;</span>,
<a name="l00288"></a>00288         
<a name="l00289"></a>00289     },
<a name="l00290"></a>00290     status =&gt; {
<a name="l00291"></a>00291         name      =&gt; <span class="stringliteral">&quot;Status&quot;</span>,
<a name="l00292"></a>00292         type      =&gt; <span class="stringliteral">&quot;edit&quot;</span>,
<a name="l00293"></a>00293         size      =&gt; 6,
<a name="l00294"></a>00294         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;one&quot;</span>,
<a name="l00295"></a>00295         <span class="keywordflow">default</span>   =&gt; 0,
<a name="l00296"></a>00296     },
<a name="l00297"></a>00297     attempted =&gt; {
<a name="l00298"></a>00298         name      =&gt; <span class="stringliteral">&quot;Attempted&quot;</span>,
<a name="l00299"></a>00299         type      =&gt; <span class="stringliteral">&quot;hidden&quot;</span>,
<a name="l00300"></a>00300         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;none&quot;</span>,
<a name="l00301"></a>00301         choices   =&gt; [qw( 0 1 )],
<a name="l00302"></a>00302         labels    =&gt; {
<a name="l00303"></a>00303                 1 =&gt; <span class="stringliteral">&quot;Yes&quot;</span>,
<a name="l00304"></a>00304                 0 =&gt; <span class="stringliteral">&quot;No&quot;</span>,
<a name="l00305"></a>00305         },
<a name="l00306"></a>00306         <span class="keywordflow">default</span>   =&gt; 0,
<a name="l00307"></a>00307     },
<a name="l00308"></a>00308     last_answer =&gt; {
<a name="l00309"></a>00309         name      =&gt; <span class="stringliteral">&quot;Last Answer&quot;</span>,
<a name="l00310"></a>00310         type      =&gt; <span class="stringliteral">&quot;hidden&quot;</span>,
<a name="l00311"></a>00311         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;none&quot;</span>,
<a name="l00312"></a>00312     },
<a name="l00313"></a>00313     num_correct =&gt; {
<a name="l00314"></a>00314         name      =&gt; <span class="stringliteral">&quot;Correct&quot;</span>,
<a name="l00315"></a>00315         type      =&gt; <span class="stringliteral">&quot;hidden&quot;</span>,
<a name="l00316"></a>00316         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;none&quot;</span>,
<a name="l00317"></a>00317         <span class="keywordflow">default</span>   =&gt; 0,
<a name="l00318"></a>00318     },
<a name="l00319"></a>00319     num_incorrect =&gt; {
<a name="l00320"></a>00320         name      =&gt; <span class="stringliteral">&quot;Incorrect&quot;</span>,
<a name="l00321"></a>00321         type      =&gt; <span class="stringliteral">&quot;hidden&quot;</span>,
<a name="l00322"></a>00322         <span class="keyword">override</span>  =&gt; <span class="stringliteral">&quot;none&quot;</span>,
<a name="l00323"></a>00323         <span class="keywordflow">default</span>   =&gt; 0,
<a name="l00324"></a>00324     },  
<a name="l00325"></a>00325 };
<a name="l00326"></a>00326 
<a name="l00327"></a>00327 use constant FIELD_PROPERTIES_GWQUIZ =&gt; {
<a name="l00328"></a>00328     max_attempts =&gt; {
<a name="l00329"></a>00329         type    =&gt; <span class="stringliteral">&quot;hidden&quot;</span>,
<a name="l00330"></a>00330         <span class="keyword">override</span>=&gt; <span class="stringliteral">&quot;any&quot;</span>,
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332 };
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="preprocessor"># Create a table of fields for the given parameters, one row for each db field</span>
<a name="l00335"></a>00335 <span class="preprocessor"></span><span class="preprocessor"># if only the setID is included, it creates a table of set information</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span><span class="preprocessor"># if the problemID is included, it creates a table of problem information</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span>sub FieldTable {
<a name="l00338"></a>00338     my ($self, $userID, $setID, $problemID, $globalRecord, $userRecord, $isGWset) = @_;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     my $r = $self-&gt;r;   
<a name="l00341"></a>00341     my @editForUser = $r-&gt;param(<span class="stringliteral">&#39;editForUser&#39;</span>);
<a name="l00342"></a>00342     my $forUsers    = scalar(@editForUser);
<a name="l00343"></a>00343     my $forOneUser  = $forUsers == 1;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345     my @fieldOrder;
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 <span class="preprocessor">    # needed for gateway output</span>
<a name="l00348"></a>00348 <span class="preprocessor"></span>    my $gwFields = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00349"></a>00349 <span class="preprocessor">    # $isGWset will come in undef if we don&#39;t need to worry about it</span>
<a name="l00350"></a>00350 <span class="preprocessor"></span>    $isGWset = 0 <span class="keywordflow">if</span> ( ! defined( $isGWset ) );
<a name="l00351"></a>00351 <span class="preprocessor">    # are we editing a set version?</span>
<a name="l00352"></a>00352 <span class="preprocessor"></span>    my $setVersion = (defined($userRecord) &amp;&amp; $userRecord-&gt;can(<span class="stringliteral">&quot;version_id&quot;</span>)) ? 1 : 0;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354 <span class="preprocessor">    # needed for ip restrictions</span>
<a name="l00355"></a>00355 <span class="preprocessor"></span>    my $ipFields = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00356"></a>00356     my $ipDefaults;
<a name="l00357"></a>00357     my $numLocations = 0;
<a name="l00358"></a>00358     my $ipOverride;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="preprocessor">    # needed for set-level proctor</span>
<a name="l00361"></a>00361 <span class="preprocessor"></span>    my $procFields = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00362"></a>00362 
<a name="l00363"></a>00363     <span class="keywordflow">if</span> (defined $problemID) {
<a name="l00364"></a>00364         @fieldOrder = ($isGWset) ? @{ GATEWAY_PROBLEM_FIELD_ORDER() } :
<a name="l00365"></a>00365             @{ PROBLEM_FIELD_ORDER() };
<a name="l00366"></a>00366     } <span class="keywordflow">else</span> {
<a name="l00367"></a>00367         @fieldOrder = @{ SET_FIELD_ORDER() };
<a name="l00368"></a>00368 
<a name="l00369"></a>00369         ($gwFields, $ipFields, $numLocations, $procFields) = $self-&gt;extraSetFields($userID, $setID, $globalRecord, $userRecord, $forUsers);
<a name="l00370"></a>00370     }
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     my $output = CGI::start_table({border =&gt; 0, cellpadding =&gt; 1});
<a name="l00373"></a>00373     <span class="keywordflow">if</span> ($forUsers) {
<a name="l00374"></a>00374         $output .= CGI::Tr({},
<a name="l00375"></a>00375             CGI::th({colspan=&gt;<span class="stringliteral">&quot;2&quot;</span>}, <span class="stringliteral">&quot;&amp;nbsp;&quot;</span>),
<a name="l00376"></a>00376             CGI::th({colspan=&gt;<span class="stringliteral">&quot;1&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;User Values&quot;</span>)),
<a name="l00377"></a>00377             CGI::th({}, $r-&gt;maketext(<span class="stringliteral">&quot;Class values&quot;</span>)),
<a name="l00378"></a>00378         );
<a name="l00379"></a>00379     }
<a name="l00380"></a>00380     <span class="keywordflow">foreach</span> my $field (@fieldOrder) {
<a name="l00381"></a>00381         my %properties; 
<a name="l00382"></a>00382         
<a name="l00383"></a>00383         
<a name="l00384"></a>00384         <span class="keywordflow">if</span>($isGWset &amp;&amp; defined( FIELD_PROPERTIES_GWQUIZ-&gt;{$field} )){
<a name="l00385"></a>00385             %properties = %{ FIELD_PROPERTIES_GWQUIZ-&gt;{$field} };
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387         <span class="keywordflow">else</span>{
<a name="l00388"></a>00388             %properties = %{ FIELD_PROPERTIES()-&gt;{$field} };
<a name="l00389"></a>00389         }
<a name="l00390"></a>00390         
<a name="l00391"></a>00391 <span class="preprocessor">        # we don&#39;t show the ip restriction option if there are </span>
<a name="l00392"></a>00392 <span class="preprocessor"></span><span class="preprocessor">        #    no defined locations, nor the relax_restrict_ip option</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span><span class="preprocessor">        #    if we&#39;re not restricting ip access</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span>        next <span class="keywordflow">if</span> ( $field eq <span class="stringliteral">&#39;restrict_ip&#39;</span> &amp;&amp; ( ! $numLocations || $setVersion ) );
<a name="l00395"></a>00395         next <span class="keywordflow">if</span> ($field eq <span class="stringliteral">&#39;relax_restrict_ip&#39;</span> &amp;&amp;
<a name="l00396"></a>00396              (! $numLocations || $setVersion ||
<a name="l00397"></a>00397               ($forUsers &amp;&amp; $userRecord-&gt;restrict_ip eq <span class="stringliteral">&#39;No&#39;</span>) ||
<a name="l00398"></a>00398               (! $forUsers &amp;&amp; 
<a name="l00399"></a>00399                ( $globalRecord-&gt;restrict_ip eq <span class="stringliteral">&#39;&#39;</span> ||
<a name="l00400"></a>00400                  $globalRecord-&gt;restrict_ip eq <span class="stringliteral">&#39;No&#39;</span> ) ) ) );
<a name="l00401"></a>00401 <span class="preprocessor">        # skip the problem seed if we&#39;re editing a gateway set for users,</span>
<a name="l00402"></a>00402 <span class="preprocessor"></span><span class="preprocessor">        #    but aren&#39;t editing a set version</span>
<a name="l00403"></a>00403 <span class="preprocessor"></span>        next <span class="keywordflow">if</span> ( $field eq <span class="stringliteral">&#39;problem_seed&#39;</span>  &amp;&amp;
<a name="l00404"></a>00404               ( $isGWset &amp;&amp; $forUsers &amp;&amp; ! $setVersion ) );
<a name="l00405"></a>00405 
<a name="l00406"></a>00406         unless ($properties{type} eq <span class="stringliteral">&quot;hidden&quot;</span>) {
<a name="l00407"></a>00407             $output .= CGI::Tr({}, CGI::td({}, [$self-&gt;FieldHTML($userID, $setID, $problemID, $globalRecord, $userRecord, $field)])) . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 <span class="preprocessor">        # finally, put in extra fields that are exceptions to the </span>
<a name="l00411"></a>00411 <span class="preprocessor"></span><span class="preprocessor">        #    usual display mechanism</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $field eq <span class="stringliteral">&#39;restrict_ip&#39;</span> &amp;&amp; $ipFields ) {
<a name="l00413"></a>00413             $output .= $ipFields;
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415                           
<a name="l00416"></a>00416         <span class="keywordflow">if</span> ( $field eq <span class="stringliteral">&#39;assignment_type&#39;</span> ) {
<a name="l00417"></a>00417             $output .= <span class="stringliteral">&quot;$procFields\n$gwFields\n&quot;</span>;
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419     } 
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     <span class="keywordflow">if</span> (defined $problemID) {
<a name="l00422"></a>00422 <span class="preprocessor">        #my $problemRecord = $r-&gt;{db}-&gt;getUserProblem($userID, $setID, $problemID);</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>        my $problemRecord = $userRecord; # we <span class="keyword">get</span> <span class="keyword">this</span> from the caller, hopefully
<a name="l00424"></a>00424         $output .= CGI::Tr({}, CGI::td({}, [<span class="stringliteral">&quot;&quot;</span>,$r-&gt;maketext(<span class="stringliteral">&quot;Attempts&quot;</span>), ($problemRecord-&gt;num_correct || 0) + ($problemRecord-&gt;num_incorrect || 0)])) if $forOneUser;
<a name="l00425"></a>00425     }       
<a name="l00426"></a>00426     $output .= CGI::end_table();
<a name="l00427"></a>00427     
<a name="l00428"></a>00428     return $output;
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a>00431 <span class="preprocessor"># Returns a list of information and HTML widgets</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span><span class="preprocessor"># for viewing and editing the specified db fields</span>
<a name="l00433"></a>00433 <span class="preprocessor"></span><span class="preprocessor"># if only the setID is included, it creates a list of set information</span>
<a name="l00434"></a>00434 <span class="preprocessor"></span><span class="preprocessor"># if the problemID is included, it creates a list of problem information</span>
<a name="l00435"></a>00435 <span class="preprocessor"></span>sub FieldHTML {
<a name="l00436"></a>00436     my ($self, $userID, $setID, $problemID, $globalRecord, $userRecord, $field) = @_;
<a name="l00437"></a>00437     
<a name="l00438"></a>00438     my $r = $self-&gt;r;
<a name="l00439"></a>00439     my $db = $r-&gt;db;
<a name="l00440"></a>00440     my @editForUser = $r-&gt;param(<span class="stringliteral">&#39;editForUser&#39;</span>);
<a name="l00441"></a>00441     my $forUsers    = scalar(@editForUser);
<a name="l00442"></a>00442     my $forOneUser  = $forUsers == 1;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 <span class="preprocessor">    #my ($globalRecord, $userRecord, $mergedRecord);</span>
<a name="l00445"></a>00445 <span class="preprocessor"></span><span class="preprocessor">    #if (defined $problemID) {  </span>
<a name="l00446"></a>00446 <span class="preprocessor"></span><span class="preprocessor">    #   $globalRecord = $db-&gt;getGlobalProblem($setID, $problemID);</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span><span class="preprocessor">    #   $userRecord = $db-&gt;getUserProblem($userID, $setID, $problemID);</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span><span class="preprocessor">    #   #$mergedRecord = $db-&gt;getMergedProblem($userID, $setID, $problemID); # never used --sam</span>
<a name="l00449"></a>00449 <span class="preprocessor"></span><span class="preprocessor">    #} else {</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span><span class="preprocessor">    #   $globalRecord = $db-&gt;getGlobalSet($setID);</span>
<a name="l00451"></a>00451 <span class="preprocessor"></span><span class="preprocessor">    #   $userRecord = $db-&gt;getUserSet($userID, $setID);</span>
<a name="l00452"></a>00452 <span class="preprocessor"></span><span class="preprocessor">    #   #$mergedRecord = $db-&gt;getMergedSet($userID, $setID); # never user --sam</span>
<a name="l00453"></a>00453 <span class="preprocessor"></span><span class="preprocessor">    #}</span>
<a name="l00454"></a>00454 <span class="preprocessor"></span>    
<a name="l00455"></a>00455     <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;No data exists for set [_1] and problem [_2]&quot;</span>, $setID, $problemID) unless $globalRecord;
<a name="l00456"></a>00456     <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;No user specific data exists for user [_1]&quot;</span>, $userID) <span class="keywordflow">if</span> $forOneUser and $globalRecord and not $userRecord;
<a name="l00457"></a>00457     
<a name="l00458"></a>00458     my %properties = %{ FIELD_PROPERTIES()-&gt;{$field} };
<a name="l00459"></a>00459     my %labels = %{ $properties{labels} };
<a name="l00460"></a>00460     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $properties{type} eq <span class="stringliteral">&quot;hidden&quot;</span>;
<a name="l00461"></a>00461     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $properties{<span class="keyword">override</span>} eq <span class="stringliteral">&quot;one&quot;</span> &amp;&amp; not $forOneUser;
<a name="l00462"></a>00462     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $properties{<span class="keyword">override</span>} eq <span class="stringliteral">&quot;none&quot;</span> &amp;&amp; not $forOneUser;
<a name="l00463"></a>00463     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> $properties{<span class="keyword">override</span>} eq <span class="stringliteral">&quot;all&quot;</span> &amp;&amp; $forUsers;
<a name="l00464"></a>00464             
<a name="l00465"></a>00465     my $edit = ($properties{type} eq <span class="stringliteral">&quot;edit&quot;</span>) &amp;&amp; ($properties{<span class="keyword">override</span>} ne <span class="stringliteral">&quot;none&quot;</span>);
<a name="l00466"></a>00466     my $choose = ($properties{type} eq <span class="stringliteral">&quot;choose&quot;</span>) &amp;&amp; ($properties{<span class="keyword">override</span>} ne <span class="stringliteral">&quot;none&quot;</span>);
<a name="l00467"></a>00467     
<a name="l00468"></a>00468 <span class="preprocessor"># FIXME: allow one selector to set multiple fields</span>
<a name="l00469"></a>00469 <span class="preprocessor"></span><span class="preprocessor">#   my $globalValue = $globalRecord-&gt;{$field};</span>
<a name="l00470"></a>00470 <span class="preprocessor"></span><span class="preprocessor">#   my $userValue = $userRecord-&gt;{$field};</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>    my ($globalValue, $userValue) = (<span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00472"></a>00472     my $blankfield = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00473"></a>00473     <span class="keywordflow">if</span> ( $field =~ /:/ ) {
<a name="l00474"></a>00474         my @gVals = ();
<a name="l00475"></a>00475         my @uVals = ();
<a name="l00476"></a>00476         my @bVals = ();
<a name="l00477"></a>00477         <span class="keywordflow">foreach</span> my $f ( split(/:/, $field) ) {
<a name="l00478"></a>00478 <span class="preprocessor">            # hmm.  this directly references the data in the </span>
<a name="l00479"></a>00479 <span class="preprocessor"></span><span class="preprocessor">            #    record rather than calling the access method, </span>
<a name="l00480"></a>00480 <span class="preprocessor"></span><span class="preprocessor">            #    thereby avoiding errors if the userRecord is </span>
<a name="l00481"></a>00481 <span class="preprocessor"></span><span class="preprocessor">            #    undefined.  that seems a bit suspect, but it&#39;s</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span><span class="preprocessor">            #    used below so we&#39;ll leave it here.</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span>
<a name="l00484"></a>00484             push(@gVals, $globalRecord-&gt;{$f} );
<a name="l00485"></a>00485             push(@uVals, $userRecord-&gt;{$f} );    # (defined($userRecord-&gt;{$f})?$userRecord-&gt;{$f}:<span class="stringliteral">&#39;&#39;</span>) );
<a name="l00486"></a>00486             push(@bVals, <span class="stringliteral">&#39;&#39;</span>);
<a name="l00487"></a>00487         }
<a name="l00488"></a>00488 <span class="preprocessor">        # I don&#39;t like this, but combining multiple values is a bit messy</span>
<a name="l00489"></a>00489 <span class="preprocessor"></span>        $globalValue = (grep {defined($_)} @gVals) ? join(<span class="charliteral">&#39;:&#39;</span>, (map { defined($_) ? $_ : <span class="stringliteral">&#39;&#39;</span> } @gVals )) : undef;
<a name="l00490"></a>00490         $userValue = (grep {defined($_)} @uVals) ? join(<span class="charliteral">&#39;:&#39;</span>, (map { defined($_) ? $_ : <span class="stringliteral">&#39;&#39;</span> } @uVals )) : undef;
<a name="l00491"></a>00491         $blankfield = join(<span class="charliteral">&#39;:&#39;</span>, @bVals);
<a name="l00492"></a>00492     } <span class="keywordflow">else</span> {
<a name="l00493"></a>00493         $globalValue = $globalRecord-&gt;{$field};
<a name="l00494"></a>00494         $userValue = $userRecord-&gt;{$field};
<a name="l00495"></a>00495     }
<a name="l00496"></a>00496 
<a name="l00497"></a>00497 <span class="preprocessor">    # use defined instead of value in order to allow 0 to printed, e.g. for the &#39;value&#39; field</span>
<a name="l00498"></a>00498 <span class="preprocessor"></span>    $globalValue = (defined($globalValue)) ? ($labels{$globalValue || <span class="stringliteral">&quot;&quot;</span>} || $globalValue) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00499"></a>00499     $userValue = (defined($userValue)) ? ($labels{$userValue || <span class="stringliteral">&quot;&quot;</span>} || $userValue) : $blankfield;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="keywordflow">if</span> ($field =~ /_date/) {
<a name="l00502"></a>00502         $globalValue = $self-&gt;formatDateTime($globalValue) <span class="keywordflow">if</span> defined $globalValue &amp;&amp; $globalValue ne $labels{<span class="stringliteral">&quot;&quot;</span>};
<a name="l00503"></a>00503 <span class="preprocessor">        # this is still fragile, but the check for blank (as opposed to 0) $userValue seems to prevent errors when no user has been assigned.</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>        $userValue = $self-&gt;formatDateTime($userValue) <span class="keywordflow">if</span> defined $userValue &amp;&amp; $userValue =~/\S/ &amp;&amp; $userValue ne $labels{<span class="stringliteral">&quot;&quot;</span>};
<a name="l00505"></a>00505     }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507     <span class="keywordflow">if</span> ( defined($properties{convertby}) &amp;&amp; $properties{convertby} ) {
<a name="l00508"></a>00508         $globalValue = $globalValue/$properties{convertby} <span class="keywordflow">if</span> $globalValue;
<a name="l00509"></a>00509         $userValue = $userValue/$properties{convertby} <span class="keywordflow">if</span> $userValue;
<a name="l00510"></a>00510     }
<a name="l00511"></a>00511 
<a name="l00512"></a>00512 <span class="preprocessor">    # check to make sure that a given value can be overridden</span>
<a name="l00513"></a>00513 <span class="preprocessor"></span>    my %canOverride = map { $_ =&gt; 1 } (@{ PROBLEM_FIELDS() }, @{ SET_FIELDS() });
<a name="l00514"></a>00514     my $check = $canOverride{$field};
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 <span class="preprocessor">    # $recordType is a shorthand in the return statement for problem or set</span>
<a name="l00517"></a>00517 <span class="preprocessor"></span><span class="preprocessor">    # $recordID is a shorthand in the return statement for $problemID or $setID</span>
<a name="l00518"></a>00518 <span class="preprocessor"></span>    my $recordType = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00519"></a>00519     my $recordID = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00520"></a>00520     <span class="keywordflow">if</span> (defined $problemID) {
<a name="l00521"></a>00521         $recordType = <span class="stringliteral">&quot;problem&quot;</span>;
<a name="l00522"></a>00522         $recordID = $problemID;
<a name="l00523"></a>00523     } <span class="keywordflow">else</span> {
<a name="l00524"></a>00524         $recordType = <span class="stringliteral">&quot;set&quot;</span>;
<a name="l00525"></a>00525         $recordID = $setID;
<a name="l00526"></a>00526     }
<a name="l00527"></a>00527     
<a name="l00528"></a>00528 <span class="preprocessor">    # $inputType contains either an input box or a popup_menu for changing a given db field</span>
<a name="l00529"></a>00529 <span class="preprocessor"></span>    my $inputType = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00530"></a>00530     <span class="keywordflow">if</span> ($edit) {
<a name="l00531"></a>00531         $inputType = CGI::input({
<a name="l00532"></a>00532                 name =&gt; <span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>,
<a name="l00533"></a>00533                 value =&gt; $r-&gt;param(<span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>) || ($forUsers ? $userValue : $globalValue),
<a name="l00534"></a>00534                 size =&gt; $properties{size} || 5,
<a name="l00535"></a>00535         });
<a name="l00536"></a>00536     } elsif ($choose) {
<a name="l00537"></a>00537 <span class="preprocessor">        # Note that in popup menus, you&#39;re almost guaranteed to have the choices hashed to labels in %properties</span>
<a name="l00538"></a>00538 <span class="preprocessor"></span><span class="preprocessor">        # but $userValue and and $globalValue are the values in the hash not the keys</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span><span class="preprocessor">        # so we have to use the actual db record field values to select our default here.</span>
<a name="l00540"></a>00540 <span class="preprocessor"></span>
<a name="l00541"></a>00541 <span class="preprocessor">        # FIXME: this allows us to set one selector from two (or more) fields</span>
<a name="l00542"></a>00542 <span class="preprocessor"></span><span class="preprocessor">        # if $field matches /:/, we have to get two fields to get the data we need here</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span>        my $value = $r-&gt;param(<span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>);
<a name="l00544"></a>00544         <span class="keywordflow">if</span> ( ! $value &amp;&amp; $field =~ /:/ ) { 
<a name="l00545"></a>00545             my @fields = split(/:/, $field);
<a name="l00546"></a>00546             $value = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00547"></a>00547             <span class="keywordflow">foreach</span> my $f ( @fields ) {
<a name="l00548"></a>00548                 $value .= ($forUsers &amp;&amp; $userRecord-&gt;$f ne <span class="stringliteral">&#39;&#39;</span> ? $userRecord-&gt;$f : $globalRecord-&gt;$f) . <span class="stringliteral">&quot;:&quot;</span>;
<a name="l00549"></a>00549             }
<a name="l00550"></a>00550             $value =~ s/:$<span class="comment">//;</span>
<a name="l00551"></a>00551         } elsif ( ! $value ) {
<a name="l00552"></a>00552             $value = ($forUsers &amp;&amp; $userRecord-&gt;$field ne <span class="stringliteral">&#39;&#39;</span> ? $userRecord-&gt;$field : $globalRecord-&gt;$field);
<a name="l00553"></a>00553         }
<a name="l00554"></a>00554         
<a name="l00555"></a>00555         <span class="keywordflow">foreach</span> my $l (keys %labels){
<a name="l00556"></a>00556             $labels{$l} = $r-&gt;maketext($labels{$l});
<a name="l00557"></a>00557         }
<a name="l00558"></a>00558             
<a name="l00559"></a>00559         $inputType = CGI::popup_menu({
<a name="l00560"></a>00560                 name =&gt; <span class="stringliteral">&quot;$recordType.$recordID.$field&quot;</span>,
<a name="l00561"></a>00561                 values =&gt; $properties{choices},
<a name="l00562"></a>00562                 labels =&gt; \%labels,
<a name="l00563"></a>00563                 <span class="keywordflow">default</span> =&gt; $value,
<a name="l00564"></a>00564         });
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566     
<a name="l00567"></a>00567     my $gDisplVal = defined($properties{labels}) &amp;&amp; defined($properties{labels}-&gt;{$globalValue}) ? $properties{labels}-&gt;{$globalValue} : $globalValue;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569 <span class="preprocessor">    # FIXME: adding &quot;:&quot; in the checked =&gt; allows for multiple fields to be set by one selector</span>
<a name="l00570"></a>00570 <span class="preprocessor"></span><span class="preprocessor">#   return (($forUsers &amp;&amp; $edit &amp;&amp; $check) ? CGI::checkbox({</span>
<a name="l00571"></a>00571 <span class="preprocessor"></span>    <span class="keywordflow">return</span> (($forUsers &amp;&amp; $check) ? CGI::checkbox({
<a name="l00572"></a>00572                 type =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>,
<a name="l00573"></a>00573                 name =&gt; <span class="stringliteral">&quot;$recordType.$recordID.$field.override&quot;</span>,
<a name="l00574"></a>00574                 label =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00575"></a>00575                 value =&gt; $field,
<a name="l00576"></a>00576                 checked =&gt; $r-&gt;param(<span class="stringliteral">&quot;$recordType.$recordID.$field.override&quot;</span>) || ($userValue ne ($labels{<span class="stringliteral">&quot;&quot;</span>} || $blankfield) ? 1 : 0),
<a name="l00577"></a>00577         }) : <span class="stringliteral">&quot;&quot;</span>,
<a name="l00578"></a>00578         $r-&gt;maketext($properties{name}),
<a name="l00579"></a>00579         $inputType,
<a name="l00580"></a>00580         $forUsers ? <span class="stringliteral">&quot; $gDisplVal&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l00581"></a>00581     );
<a name="l00582"></a>00582 }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584 <span class="preprocessor"># return weird fields that are non-native or which are displayed</span>
<a name="l00585"></a>00585 <span class="preprocessor"></span><span class="preprocessor">#    for only some sets</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span>sub extraSetFields {
<a name="l00587"></a>00587     my ($self,$userID,$setID,$globalRecord,$userRecord,$forUsers) = @_;
<a name="l00588"></a>00588     my $db = $self-&gt;r-&gt;{db};
<a name="l00589"></a>00589     my $r = $self-&gt;r;
<a name="l00590"></a>00590 
<a name="l00591"></a>00591     my ($gwFields, $ipFields, $ipDefaults, $numLocations, $ipOverride,
<a name="l00592"></a>00592         $procFields) = ( <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span>, 0, <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span> );
<a name="l00593"></a>00593 
<a name="l00594"></a>00594 <span class="preprocessor">    # if we&#39;re dealing with a gateway, set up a table of gateway fields</span>
<a name="l00595"></a>00595 <span class="preprocessor"></span>    my $nF = 0;  # <span class="keyword">this</span> is the number of columns in the <span class="keyword">set</span> field table
<a name="l00596"></a>00596     <span class="keywordflow">if</span> ( $globalRecord-&gt;assignment_type() =~ /gateway/ ) {
<a name="l00597"></a>00597         my $gwhdr = <span class="stringliteral">&quot;\n&lt;!-- begin gwoutput table --&gt;\n&quot;</span>;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599         <span class="keywordflow">foreach</span> my $gwfield ( @{ GATEWAY_SET_FIELD_ORDER() } ) {
<a name="l00600"></a>00600 
<a name="l00601"></a>00601 <span class="preprocessor">            # don&#39;t show template gateway fields when editing</span>
<a name="l00602"></a>00602 <span class="preprocessor"></span><span class="preprocessor">            #    set versions</span>
<a name="l00603"></a>00603 <span class="preprocessor"></span>            next <span class="keywordflow">if</span> ( ( $gwfield eq <span class="stringliteral">&quot;time_interval&quot;</span> ||
<a name="l00604"></a>00604                     $gwfield eq <span class="stringliteral">&quot;versions_per_interval&quot;</span> ) &amp;&amp;
<a name="l00605"></a>00605                   ( $forUsers &amp;&amp;
<a name="l00606"></a>00606                     $userRecord-&gt;can(<span class="stringliteral">&#39;version_id&#39;</span>) ) );
<a name="l00607"></a>00607 
<a name="l00608"></a>00608             my @fieldData = 
<a name="l00609"></a>00609                 ($self-&gt;FieldHTML($userID, $setID, undef, 
<a name="l00610"></a>00610                           $globalRecord, $userRecord, 
<a name="l00611"></a>00611                           $gwfield));
<a name="l00612"></a>00612             <span class="keywordflow">if</span> ( @fieldData &amp;&amp; defined($fieldData[1]) and 
<a name="l00613"></a>00613                  $fieldData[1] ne <span class="stringliteral">&#39;&#39;</span> ) {
<a name="l00614"></a>00614                 $nF = @fieldData <span class="keywordflow">if</span> ( @fieldData &gt; $nF );
<a name="l00615"></a>00615                 $gwFields .= CGI::Tr({}, 
<a name="l00616"></a>00616                     CGI::td({}, [@fieldData]));
<a name="l00617"></a>00617                 }
<a name="l00618"></a>00618         }
<a name="l00619"></a>00619         $gwhdr .= CGI::Tr({},CGI::td({colspan=&gt;$nF}, 
<a name="l00620"></a>00620                          CGI::em($r-&gt;maketext(<span class="stringliteral">&quot;Gateway parameters&quot;</span>))))
<a name="l00621"></a>00621             <span class="keywordflow">if</span> ( $nF );
<a name="l00622"></a>00622         $gwFields = <span class="stringliteral">&quot;$gwhdr$gwFields\n&quot;</span> .
<a name="l00623"></a>00623             <span class="stringliteral">&quot;&lt;!-- end gwoutput table --&gt;\n&quot;</span>;
<a name="l00624"></a>00624     }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626 <span class="preprocessor">    # if we have a proctored test, then also generate a proctored </span>
<a name="l00627"></a>00627 <span class="preprocessor"></span><span class="preprocessor">    #    set password input </span>
<a name="l00628"></a>00628 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $globalRecord-&gt;assignment_type eq <span class="stringliteral">&#39;proctored_gateway&#39;</span> &amp;&amp; ! $forUsers ) {
<a name="l00629"></a>00629         my $nfm1 = $nF - 1;
<a name="l00630"></a>00630         $procFields = CGI::Tr({},CGI::td({},<span class="stringliteral">&#39;&#39;</span>),
<a name="l00631"></a>00631             CGI::td({colspan=&gt;$nfm1},
<a name="l00632"></a>00632                 CGI::em($r-&gt;maketext(<span class="stringliteral">&quot;Proctored tests require proctor authorization to start and to grade.  Provide a password to have a single password for all students to start a proctored test.&quot;</span>))));
<a name="l00633"></a>00633 <span class="preprocessor">        # we use a routine other than FieldHTML because of getting</span>
<a name="l00634"></a>00634 <span class="preprocessor"></span><span class="preprocessor">        #    the default value here</span>
<a name="l00635"></a>00635 <span class="preprocessor"></span>        my @fieldData = 
<a name="l00636"></a>00636             $self-&gt;proctoredFieldHTML($userID, $setID, 
<a name="l00637"></a>00637                           $globalRecord);
<a name="l00638"></a>00638         $procFields .= CGI::Tr({}, 
<a name="l00639"></a>00639             CGI::td({}, [@fieldData]));
<a name="l00640"></a>00640     }
<a name="l00641"></a>00641 
<a name="l00642"></a>00642 <span class="preprocessor">    # finally, figure out what ip selector fields we want to include</span>
<a name="l00643"></a>00643 <span class="preprocessor"></span>    my @locations = sort {$a cmp $b} ($db-&gt;listLocations());
<a name="l00644"></a>00644     $numLocations = @locations;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646 <span class="preprocessor">    # we don&#39;t show ip selector fields if we&#39;re editing a set version</span>
<a name="l00647"></a>00647 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! defined( $userRecord ) ||
<a name="l00648"></a>00648          ( defined( $userRecord ) &amp;&amp; ! $userRecord-&gt;can(<span class="stringliteral">&quot;version_id&quot;</span>) ) ) {
<a name="l00649"></a>00649         <span class="keywordflow">if</span> ( ( ! $forUsers &amp;&amp; $globalRecord-&gt;restrict_ip &amp;&amp;
<a name="l00650"></a>00650                $globalRecord-&gt;restrict_ip ne <span class="stringliteral">&#39;No&#39;</span> ) ||
<a name="l00651"></a>00651              ( $forUsers &amp;&amp; $userRecord-&gt;restrict_ip ne <span class="stringliteral">&#39;No&#39;</span> ) ) {
<a name="l00652"></a>00652 
<a name="l00653"></a>00653             my @globalLocations = $db-&gt;listGlobalSetLocations($setID);
<a name="l00654"></a>00654 <span class="preprocessor">            # what ip locations should be selected?</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span>            my @defaultLocations = ();
<a name="l00656"></a>00656             <span class="keywordflow">if</span> ( $forUsers &amp;&amp; 
<a name="l00657"></a>00657                  ! $db-&gt;countUserSetLocations($userID, $setID) ) { 
<a name="l00658"></a>00658                 @defaultLocations = @globalLocations;
<a name="l00659"></a>00659                 $ipOverride = 0;
<a name="l00660"></a>00660             } elsif ( $forUsers ) {
<a name="l00661"></a>00661                 @defaultLocations = $db-&gt;listUserSetLocations($userID, $setID);
<a name="l00662"></a>00662                 $ipOverride = 1;
<a name="l00663"></a>00663             } <span class="keywordflow">else</span> {
<a name="l00664"></a>00664                 @defaultLocations = @globalLocations;
<a name="l00665"></a>00665             }
<a name="l00666"></a>00666             my $ipDefaults = join(<span class="stringliteral">&#39;, &#39;</span>, @globalLocations);
<a name="l00667"></a>00667 
<a name="l00668"></a>00668             my $ipSelector = CGI::scrolling_list({
<a name="l00669"></a>00669                 -name =&gt; <span class="stringliteral">&quot;set.$setID.selected_ip_locations&quot;</span>,
<a name="l00670"></a>00670                 -values =&gt; [ @locations ], 
<a name="l00671"></a>00671                 -<span class="keywordflow">default</span> =&gt; [ @defaultLocations ], 
<a name="l00672"></a>00672                 -size =&gt; 5,
<a name="l00673"></a>00673                 -multiple =&gt; <span class="stringliteral">&#39;true&#39;</span>});
<a name="l00674"></a>00674 
<a name="l00675"></a>00675             my $override = ($forUsers) ? 
<a name="l00676"></a>00676                 CGI::checkbox({ type =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>,
<a name="l00677"></a>00677                     name =&gt; <span class="stringliteral">&quot;set.$setID.selected_ip_locations.override&quot;</span>,
<a name="l00678"></a>00678                     label =&gt; <span class="stringliteral">&quot;&quot;</span>,
<a name="l00679"></a>00679                     checked =&gt; $ipOverride }) : <span class="stringliteral">&#39;&#39;</span>;
<a name="l00680"></a>00680             $ipFields .= CGI::Tr({-valign=&gt;<span class="stringliteral">&#39;top&#39;</span>},
<a name="l00681"></a>00681                          CGI::td({}, [ $override, 
<a name="l00682"></a>00682                            $r-&gt;maketext(<span class="stringliteral">&#39;Restrict Locations&#39;</span>), 
<a name="l00683"></a>00683                            $ipSelector, 
<a name="l00684"></a>00684                            $forUsers ? 
<a name="l00685"></a>00685                            <span class="stringliteral">&quot; $ipDefaults&quot;</span> : <span class="stringliteral">&#39;&#39;</span>, ]
<a name="l00686"></a>00686                     ),
<a name="l00687"></a>00687             );
<a name="l00688"></a>00688         }
<a name="l00689"></a>00689     }
<a name="l00690"></a>00690     <span class="keywordflow">return</span>($gwFields, $ipFields, $numLocations, $procFields);
<a name="l00691"></a>00691 }
<a name="l00692"></a>00692 
<a name="l00693"></a>00693 sub proctoredFieldHTML {
<a name="l00694"></a>00694     my ( $self, $userID, $setID, $globalRecord ) = @_;
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     my $r = $self-&gt;r;
<a name="l00697"></a>00697     my $db = $r-&gt;db;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699 <span class="preprocessor">    # note that this routine assumes that the login proctor password</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span><span class="preprocessor">    #    is something that can only be changed for the global set</span>
<a name="l00701"></a>00701 <span class="preprocessor"></span>
<a name="l00702"></a>00702 <span class="preprocessor">    # if the set doesn&#39;t require a login proctor, then we can assume</span>
<a name="l00703"></a>00703 <span class="preprocessor"></span><span class="preprocessor">    #    that one doesn&#39;t exist; otherwise, we need to check the </span>
<a name="l00704"></a>00704 <span class="preprocessor"></span><span class="preprocessor">    #    database to find if there&#39;s an already defined password</span>
<a name="l00705"></a>00705 <span class="preprocessor"></span>    my $value = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00706"></a>00706     <span class="keywordflow">if</span> ( $globalRecord-&gt;restricted_login_proctor eq <span class="stringliteral">&#39;Yes&#39;</span> &amp;&amp;
<a name="l00707"></a>00707          $db-&gt;existsPassword(<span class="stringliteral">&quot;set_id:$setID&quot;</span>) ) {
<a name="l00708"></a>00708         $value = <span class="stringliteral">&#39;********&#39;</span>;
<a name="l00709"></a>00709     }
<a name="l00710"></a>00710 
<a name="l00711"></a>00711     <span class="keywordflow">return</span>( ( <span class="stringliteral">&#39;&#39;</span>,
<a name="l00712"></a>00712           $r-&gt;maketext(<span class="stringliteral">&#39;Password (Leave blank for regular proctoring)&#39;</span>),
<a name="l00713"></a>00713           CGI::input({ name=&gt;<span class="stringliteral">&quot;set.$setID.restricted_login_proctor_password&quot;</span>,
<a name="l00714"></a>00714                    value=&gt;$value,
<a name="l00715"></a>00715                    size=&gt;10,
<a name="l00716"></a>00716                }),
<a name="l00717"></a>00717           <span class="stringliteral">&#39;&#39;</span> ) );
<a name="l00718"></a>00718 }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720 <span class="preprocessor"># creates a popup menu of all possible problem numbers (for possible rearranging)</span>
<a name="l00721"></a>00721 <span class="preprocessor"></span>sub problem_number_popup {
<a name="l00722"></a>00722     my $num = shift;
<a name="l00723"></a>00723     my $total = shift;
<a name="l00724"></a>00724     <span class="keywordflow">return</span> (CGI::popup_menu(-name =&gt; <span class="stringliteral">&quot;problem_num_$num&quot;</span>,
<a name="l00725"></a>00725                 -values =&gt; [1..$total],
<a name="l00726"></a>00726                 -<span class="keywordflow">default</span> =&gt; $num));
<a name="l00727"></a>00727 }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729 <span class="preprocessor"># handles rearrangement necessary after changes to problem ordering</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span>sub handle_problem_numbers {
<a name="l00731"></a>00731     my $self = shift;
<a name="l00732"></a>00732     my $r = $self-&gt;r;
<a name="l00733"></a>00733     my $newProblemNumbersref = shift;
<a name="l00734"></a>00734     my %newProblemNumbers = %$newProblemNumbersref;
<a name="l00735"></a>00735     my $maxNum = shift;
<a name="l00736"></a>00736     my $db = shift;
<a name="l00737"></a>00737     my $setID = shift;
<a name="l00738"></a>00738     my $force = shift || 0;
<a name="l00739"></a>00739     my @sortme=();
<a name="l00740"></a>00740     my ($j, $val);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742 <span class="preprocessor">    # keys are current problem numbers, values are target problem numbers</span>
<a name="l00743"></a>00743 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> $j (keys %newProblemNumbers) {
<a name="l00744"></a>00744 <span class="preprocessor">        # we don&#39;t want to act unless all problems have been assigned a new problem number, so if any have not, return</span>
<a name="l00745"></a>00745 <span class="preprocessor"></span>        <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> (not defined $newProblemNumbers{<span class="stringliteral">&quot;$j&quot;</span>});
<a name="l00746"></a>00746 <span class="preprocessor">        # if the problem has been given a new number, we reduce the &quot;score&quot; of the problem by the original number of the problem</span>
<a name="l00747"></a>00747 <span class="preprocessor"></span><span class="preprocessor">        # when multiple problems are assigned the same number, this results in the last one ending up first -- FIXME?</span>
<a name="l00748"></a>00748 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ($newProblemNumbers{<span class="stringliteral">&quot;$j&quot;</span>} != $j) {
<a name="l00749"></a>00749 <span class="preprocessor">            # force always gets set if reordering is done, so don&#39;t expect to be able to delete a problem,</span>
<a name="l00750"></a>00750 <span class="preprocessor"></span><span class="preprocessor">            # reorder some other problems, and end up with a hole -- FIXME</span>
<a name="l00751"></a>00751 <span class="preprocessor"></span>            $force = 1;
<a name="l00752"></a>00752             $val = 1000 * $newProblemNumbers{$j} - $j;
<a name="l00753"></a>00753         } <span class="keywordflow">else</span> {
<a name="l00754"></a>00754             $val = 1000 * $newProblemNumbers{$j};
<a name="l00755"></a>00755         }
<a name="l00756"></a>00756 <span class="preprocessor">        # store a mapping between current problem number and score (based on currnet and new problem number)</span>
<a name="l00757"></a>00757 <span class="preprocessor"></span>        push @sortme, [$j, $val];
<a name="l00758"></a>00758 <span class="preprocessor">        # replace new problem numbers in hash with the (global) problems themselves</span>
<a name="l00759"></a>00759 <span class="preprocessor"></span>        $newProblemNumbers{$j} = $db-&gt;getGlobalProblem($setID, $j);
<a name="l00760"></a>00760         die $r-&gt;maketext(<span class="stringliteral">&quot;global [_1] for set [_2] not found.&quot;</span>, $j, $setID) unless $newProblemNumbers{$j};
<a name="l00761"></a>00761     }
<a name="l00762"></a>00762 
<a name="l00763"></a>00763 <span class="preprocessor">    # we don&#39;t have to do anything if we&#39;re not getting rid of holes</span>
<a name="l00764"></a>00764 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless $force;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766 <span class="preprocessor">    # sort the curr. prob. num./score pairs by score</span>
<a name="l00767"></a>00767 <span class="preprocessor"></span>    @sortme = sort {$a-&gt;[1] &lt;=&gt; $b-&gt;[1]} @sortme;
<a name="l00768"></a>00768 <span class="preprocessor">    # now, for global and each user with this set, loop through problem list</span>
<a name="l00769"></a>00769 <span class="preprocessor"></span><span class="preprocessor">    #   get all of the problem records</span>
<a name="l00770"></a>00770 <span class="preprocessor"></span><span class="preprocessor">    # assign new problem numbers</span>
<a name="l00771"></a>00771 <span class="preprocessor"></span><span class="preprocessor">    # loop - if number is new, put the problem record</span>
<a name="l00772"></a>00772 <span class="preprocessor"></span><span class="preprocessor">    # print &quot;Sorted to get &quot;. join(&#39;, &#39;, map {$_-&gt;[0] } @sortme) .&quot;&lt;p&gt;\n&quot;;</span>
<a name="l00773"></a>00773 <span class="preprocessor"></span>
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="preprocessor">    # Now, three stages.  First global values</span>
<a name="l00776"></a>00776 <span class="preprocessor"></span>
<a name="l00777"></a>00777     <span class="keywordflow">for</span> ($j = 0; $j &lt; scalar @sortme; $j++) {
<a name="l00778"></a>00778         <span class="keywordflow">if</span>($sortme[$j][0] == $j + 1) {
<a name="l00779"></a>00779 <span class="preprocessor">            # if the jth problem (according to the new ordering) is in the right place (problem IDs are numbered from 1, hence $j+1)</span>
<a name="l00780"></a>00780 <span class="preprocessor"></span><span class="preprocessor">            # do nothing</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>        } elsif (not defined $newProblemNumbers{$j + 1}) {
<a name="l00782"></a>00782 <span class="preprocessor">            # otherwise, if there&#39;s a hole for it, add it there</span>
<a name="l00783"></a>00783 <span class="preprocessor"></span>            $newProblemNumbers{$sortme[$j][0]}-&gt;problem_id($j + 1);
<a name="l00784"></a>00784             $db-&gt;addGlobalProblem($newProblemNumbers{$sortme[$j][0]});
<a name="l00785"></a>00785         } <span class="keywordflow">else</span> {
<a name="l00786"></a>00786 <span class="preprocessor">            # otherwise, overwrite the data for the problem that&#39;s already there with the jth problem&#39;s data (with a changed problemID)</span>
<a name="l00787"></a>00787 <span class="preprocessor"></span>            $newProblemNumbers{$sortme[$j][0]}-&gt;problem_id($j + 1);
<a name="l00788"></a>00788             $db-&gt;putGlobalProblem($newProblemNumbers{$sortme[$j][0]});
<a name="l00789"></a>00789         }
<a name="l00790"></a>00790     }
<a name="l00791"></a>00791 
<a name="l00792"></a>00792     my @setUsers = $db-&gt;listSetUsers($setID);
<a name="l00793"></a>00793     my (@problist, $user);
<a name="l00794"></a>00794 
<a name="l00795"></a>00795     <span class="keywordflow">foreach</span> $user (@setUsers) {
<a name="l00796"></a>00796 <span class="preprocessor">        # grab a copy of each UserProblem for this user. @problist can be sparse (if problems were deleted)</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span>        <span class="keywordflow">for</span> $j (keys %newProblemNumbers) {
<a name="l00798"></a>00798             $problist[$j] = $db-&gt;getUserProblem($user, $setID, $j);
<a name="l00799"></a>00799         }
<a name="l00800"></a>00800         <span class="keywordflow">for</span>($j = 0; $j &lt; scalar @sortme; $j++) { 
<a name="l00801"></a>00801             <span class="keywordflow">if</span> ($sortme[$j][0] == $j + 1) {
<a name="l00802"></a>00802 <span class="preprocessor">                # same as above -- the jth problem is in the right place, so don&#39;t worry about it</span>
<a name="l00803"></a>00803 <span class="preprocessor"></span><span class="preprocessor">                # do nothing</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span>            } elsif ($problist[$sortme[$j][0]]) {
<a name="l00805"></a>00805 <span class="preprocessor">                # we&#39;ve made sure the user&#39;s problem actually exists HERE, since we want to be able to fail gracefullly if it doesn&#39;t</span>
<a name="l00806"></a>00806 <span class="preprocessor"></span><span class="preprocessor">                # the problem with the original conditional below is that %newProblemNumbers maps oldids =&gt; global problem record</span>
<a name="l00807"></a>00807 <span class="preprocessor"></span><span class="preprocessor">                # we need to check if the target USER PROBLEM exists, which is what @problist knows</span>
<a name="l00808"></a>00808 <span class="preprocessor"></span><span class="preprocessor">                #if (not defined $newProblemNumbers{$j + 1}) {</span>
<a name="l00809"></a>00809 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (not defined $problist[$j+1]) {
<a name="l00810"></a>00810 <span class="preprocessor">                    # same as above -- there&#39;s a hole for that problem to go into, so add it in its new place</span>
<a name="l00811"></a>00811 <span class="preprocessor"></span>                    $problist[$sortme[$j][0]]-&gt;problem_id($j + 1); 
<a name="l00812"></a>00812                     $db-&gt;addUserProblem($problist[$sortme[$j][0]]); 
<a name="l00813"></a>00813                 } <span class="keywordflow">else</span> { 
<a name="l00814"></a>00814 <span class="preprocessor">                    # same as above -- there&#39;s a problem already there, so overwrite its data with the data from the jth problem</span>
<a name="l00815"></a>00815 <span class="preprocessor"></span>                    $problist[$sortme[$j][0]]-&gt;problem_id($j + 1); 
<a name="l00816"></a>00816                     $db-&gt;putUserProblem($problist[$sortme[$j][0]]); 
<a name="l00817"></a>00817                 } 
<a name="l00818"></a>00818             } <span class="keywordflow">else</span> {
<a name="l00819"></a>00819                 warn $r-&gt;maketext(<span class="stringliteral">&quot;UserProblem missing for user=[_1] set=[_2] problem=[_3]. This may indicate database corruption.&quot;</span>, $user, $setID, $sortme[$j][0]).<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00820"></a>00820 <span class="preprocessor">                # when a problem doesn&#39;t exist in the target slot, a new problem gets added there, but the original problem</span>
<a name="l00821"></a>00821 <span class="preprocessor"></span><span class="preprocessor">                # never gets overwritten (because there wan&#39;t a problem it would have to get exchanged with)</span>
<a name="l00822"></a>00822 <span class="preprocessor"></span><span class="preprocessor">                # i think this can get pretty complex. consider 1=&gt;2, 2=&gt;3, 3=&gt;4, 4=&gt;1 where problem 1 doesn&#39;t exist for some user:</span>
<a name="l00823"></a>00823 <span class="preprocessor"></span><span class="preprocessor">                # @sortme[$j][0] will contain: 4, 1, 2, 3</span>
<a name="l00824"></a>00824 <span class="preprocessor"></span><span class="preprocessor">                # - problem 1 will get **added** with the data from problem 4 (because problem 1 doesn&#39;t exist for this user)</span>
<a name="l00825"></a>00825 <span class="preprocessor"></span><span class="preprocessor">                # - problem 2 will get overwritten with the data from problem 1</span>
<a name="l00826"></a>00826 <span class="preprocessor"></span><span class="preprocessor">                # - problem 3 will get overwritten with the data from problem 2</span>
<a name="l00827"></a>00827 <span class="preprocessor"></span><span class="preprocessor">                # - nothing will happend to problem 4, since problem 1 doesn&#39;t exit</span>
<a name="l00828"></a>00828 <span class="preprocessor"></span><span class="preprocessor">                # so the solution is to delete problem 4 altogether!</span>
<a name="l00829"></a>00829 <span class="preprocessor"></span><span class="preprocessor">                # here&#39;s the fix:</span>
<a name="l00830"></a>00830 <span class="preprocessor"></span>                
<a name="l00831"></a>00831 <span class="preprocessor">                # the data from problem $j+1 was/will be moved to another problem slot,</span>
<a name="l00832"></a>00832 <span class="preprocessor"></span><span class="preprocessor">                # but there&#39;s no problem $sortme[$j][0] to replace it. thus, we delete it now.</span>
<a name="l00833"></a>00833 <span class="preprocessor"></span>                $db-&gt;deleteUserProblem($user, $setID, $j+1);
<a name="l00834"></a>00834             }
<a name="l00835"></a>00835         } 
<a name="l00836"></a>00836     }
<a name="l00837"></a>00837 
<a name="l00838"></a>00838 <span class="preprocessor">    # any problems with IDs above $maxNum get deleted -- presumably their data has been copied into problems with lower IDs</span>
<a name="l00839"></a>00839 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> ($j = scalar @sortme; $j &lt; $maxNum; $j++) {
<a name="l00840"></a>00840         <span class="keywordflow">if</span> (defined $newProblemNumbers{$j + 1}) {
<a name="l00841"></a>00841             $db-&gt;deleteGlobalProblem($setID, $j+1);
<a name="l00842"></a>00842         }
<a name="l00843"></a>00843     }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 <span class="preprocessor">    # return a string form of the old problem IDs in the new order (not used by caller, incidentally)</span>
<a name="l00846"></a>00846 <span class="preprocessor"></span>    <span class="keywordflow">return</span> join(<span class="stringliteral">&#39;, &#39;</span>, map {$_-&gt;[0]} @sortme);
<a name="l00847"></a>00847 }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849 
<a name="l00850"></a>00850 <span class="preprocessor"># primarily saves any changes into the correct set or problem records (global vs user)</span>
<a name="l00851"></a>00851 <span class="preprocessor"></span><span class="preprocessor"># also deals with deleting or rearranging problems</span>
<a name="l00852"></a>00852 <span class="preprocessor"></span>sub initialize {
<a name="l00853"></a>00853     my ($self)    = @_;
<a name="l00854"></a>00854     my $r         = $self-&gt;r;
<a name="l00855"></a>00855     my $db        = $r-&gt;db;
<a name="l00856"></a>00856     my $ce        = $r-&gt;ce;
<a name="l00857"></a>00857     my $authz     = $r-&gt;authz;
<a name="l00858"></a>00858     my $user      = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00859"></a>00859     my $setID   = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l00860"></a>00860 
<a name="l00861"></a>00861 <span class="preprocessor">    ## we&#39;re now allowing setID to come in as setID,v# to edit a set</span>
<a name="l00862"></a>00862 <span class="preprocessor"></span><span class="preprocessor">    ##    version; catch this first</span>
<a name="l00863"></a>00863 <span class="preprocessor"></span>    my $editingSetVersion = 0;
<a name="l00864"></a>00864     <span class="keywordflow">if</span> ( $setID =~ /,v(\d+)$/ ) {
<a name="l00865"></a>00865         $editingSetVersion = $1;
<a name="l00866"></a>00866         $setID =~ s/,v(\d+)$<span class="comment">//;</span>
<a name="l00867"></a>00867     }
<a name="l00868"></a>00868 
<a name="l00869"></a>00869     my $setRecord = $db-&gt;getGlobalSet($setID); # checked
<a name="l00870"></a>00870     die $r-&gt;maketext(<span class="stringliteral">&quot;global set [_1] not found.&quot;</span>, $setID) unless $setRecord;
<a name="l00871"></a>00871 
<a name="l00872"></a>00872     $self-&gt;{<span class="keyword">set</span>}  = $setRecord;
<a name="l00873"></a>00873     my @editForUser = $r-&gt;param(<span class="stringliteral">&#39;editForUser&#39;</span>);
<a name="l00874"></a>00874 <span class="preprocessor">    # some useful booleans</span>
<a name="l00875"></a>00875 <span class="preprocessor"></span>    my $forUsers   = scalar(@editForUser);
<a name="l00876"></a>00876     my $forOneUser = $forUsers == 1;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878 <span class="preprocessor">    # Check permissions</span>
<a name="l00879"></a>00879 <span class="preprocessor"></span>    <span class="keywordflow">return</span> unless ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>));
<a name="l00880"></a>00880     <span class="keywordflow">return</span> unless ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>));
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="preprocessor">    ## if we&#39;re editing a versioned set, it only makes sense to be</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span><span class="preprocessor">    ##    editing it for one user</span>
<a name="l00884"></a>00884 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> ( $editingSetVersion &amp;&amp; ! $forOneUser );
<a name="l00885"></a>00885 
<a name="l00886"></a>00886     my %properties = %{ FIELD_PROPERTIES() };
<a name="l00887"></a>00887 
<a name="l00888"></a>00888 <span class="preprocessor">    # takes a hash of hashes and inverts it</span>
<a name="l00889"></a>00889 <span class="preprocessor"></span>    my %undoLabels;
<a name="l00890"></a>00890     <span class="keywordflow">foreach</span> my $key (keys %properties) {
<a name="l00891"></a>00891         %{ $undoLabels{$key} } = map { $properties{$key}-&gt;{labels}-&gt;{$_} =&gt; $_ } keys %{ $properties{$key}-&gt;{labels} };
<a name="l00892"></a>00892     }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894 <span class="preprocessor">    # Unfortunately not everyone uses Javascript enabled browsers so</span>
<a name="l00895"></a>00895 <span class="preprocessor"></span><span class="preprocessor">    # we must fudge the information coming from the ComboBoxes</span>
<a name="l00896"></a>00896 <span class="preprocessor"></span><span class="preprocessor">    # Since the textfield and menu both have the same name, we get an array of two elements</span>
<a name="l00897"></a>00897 <span class="preprocessor"></span><span class="preprocessor">    # We then reset the param to the first if its not-empty or the second (empty or not).</span>
<a name="l00898"></a>00898 <span class="preprocessor"></span>    <span class="keywordflow">foreach</span> ( @{ HEADER_ORDER() } ) {
<a name="l00899"></a>00899         my @values = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$_&quot;</span>);
<a name="l00900"></a>00900         my $value = $values[0] || $values[1] || <span class="stringliteral">&quot;&quot;</span>; 
<a name="l00901"></a>00901         $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$_&quot;</span>, $value);
<a name="l00902"></a>00902     }
<a name="l00903"></a>00903 
<a name="l00904"></a>00904 <span class="preprocessor">    #####################################################################</span>
<a name="l00905"></a>00905 <span class="preprocessor"></span><span class="preprocessor">    # Check date information</span>
<a name="l00906"></a>00906 <span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<a name="l00907"></a>00907 <span class="preprocessor"></span>
<a name="l00908"></a>00908     my ($open_date, $due_date, $answer_date);
<a name="l00909"></a>00909     my $error = 0;
<a name="l00910"></a>00910     <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>)) {
<a name="l00911"></a>00911         my @names = (<span class="stringliteral">&quot;open_date&quot;</span>, <span class="stringliteral">&quot;due_date&quot;</span>, <span class="stringliteral">&quot;answer_date&quot;</span>);
<a name="l00912"></a>00912         
<a name="l00913"></a>00913         my %dates = map { $_ =&gt; $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$_&quot;</span>) } @names;
<a name="l00914"></a>00914         %dates = map { 
<a name="l00915"></a>00915             my $unlabel = $undoLabels{$_}-&gt;{$dates{$_}}; 
<a name="l00916"></a>00916             $_ =&gt; defined $unlabel ? $setRecord-&gt;$_ : $self-&gt;parseDateTime($dates{$_}) 
<a name="l00917"></a>00917         } @names;
<a name="l00918"></a>00918 
<a name="l00919"></a>00919         ($open_date, $due_date, $answer_date) = map { $dates{$_}||0 } @names;
<a name="l00920"></a>00920         
<a name="l00921"></a>00921 <span class="preprocessor">        # make sure dates are numeric by using ||0</span>
<a name="l00922"></a>00922 <span class="preprocessor"></span>        
<a name="l00923"></a>00923         <span class="keywordflow">if</span> ($answer_date &lt; $due_date || $answer_date &lt; $open_date) {        
<a name="l00924"></a>00924             $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Answers cannot be made available until on or after the due date!&quot;</span>));
<a name="l00925"></a>00925             $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
<a name="l00926"></a>00926         }
<a name="l00927"></a>00927         
<a name="l00928"></a>00928         <span class="keywordflow">if</span> ($due_date &lt; $open_date) {
<a name="l00929"></a>00929             $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Answers cannot be due until on or after the open date!&quot;</span>));
<a name="l00930"></a>00930             $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
<a name="l00931"></a>00931         }
<a name="l00932"></a>00932         
<a name="l00933"></a>00933 <span class="preprocessor">        # make sure the dates are not more than 10 years in the future</span>
<a name="l00934"></a>00934 <span class="preprocessor"></span>        my $curr_time = time;
<a name="l00935"></a>00935         my $seconds_per_year = 31_556_926;
<a name="l00936"></a>00936         my $cutoff = $curr_time + $seconds_per_year*10;
<a name="l00937"></a>00937         <span class="keywordflow">if</span> ($open_date &gt; $cutoff) {
<a name="l00938"></a>00938             $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error: open date cannot be more than 10 years from now in set [_1]&quot;</span>, $setID));
<a name="l00939"></a>00939             $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
<a name="l00940"></a>00940         }
<a name="l00941"></a>00941         <span class="keywordflow">if</span> ($due_date &gt; $cutoff) {
<a name="l00942"></a>00942             $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error: due date cannot be more than 10 years from now in set [_1]&quot;</span>, $setID));
<a name="l00943"></a>00943             $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945         <span class="keywordflow">if</span> ($answer_date &gt; $cutoff) {
<a name="l00946"></a>00946             $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error: answer date cannot be more than 10 years from now in set [_1]&quot;</span>, $setID));
<a name="l00947"></a>00947             $error = $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>);
<a name="l00948"></a>00948         }
<a name="l00949"></a>00949 
<a name="l00950"></a>00950     }
<a name="l00951"></a>00951     <span class="keywordflow">if</span> ($error) {
<a name="l00952"></a>00952         $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;No changes were saved!&quot;</span>));
<a name="l00953"></a>00953     }
<a name="l00954"></a>00954     
<a name="l00955"></a>00955     <span class="keywordflow">if</span> (defined $r-&gt;param(<span class="stringliteral">&#39;submit_changes&#39;</span>) &amp;&amp; !$error) {
<a name="l00956"></a>00956 
<a name="l00957"></a>00957 <span class="preprocessor">        #my $setRecord = $db-&gt;getGlobalSet($setID); # already fetched above --sam</span>
<a name="l00958"></a>00958 <span class="preprocessor"></span>
<a name="l00959"></a>00959 <span class="preprocessor">        #####################################################################</span>
<a name="l00960"></a>00960 <span class="preprocessor"></span><span class="preprocessor">        # Save general set information (including headers)</span>
<a name="l00961"></a>00961 <span class="preprocessor"></span><span class="preprocessor">        #####################################################################</span>
<a name="l00962"></a>00962 <span class="preprocessor"></span>
<a name="l00963"></a>00963         <span class="keywordflow">if</span> ($forUsers) {
<a name="l00964"></a>00964 <span class="preprocessor">            # note that we don&#39;t deal with the proctor user</span>
<a name="l00965"></a>00965 <span class="preprocessor"></span><span class="preprocessor">            #    fields here, with the assumption that it can&#39;t</span>
<a name="l00966"></a>00966 <span class="preprocessor"></span><span class="preprocessor">            #    be possible to change them for users.  this is</span>
<a name="l00967"></a>00967 <span class="preprocessor"></span><span class="preprocessor">            #    not the most robust treatment of the problem</span>
<a name="l00968"></a>00968 <span class="preprocessor"></span><span class="preprocessor">            #    (FIXME)</span>
<a name="l00969"></a>00969 <span class="preprocessor"></span>
<a name="l00970"></a>00970 <span class="preprocessor">            # DBFIXME use a WHERE clause, iterator</span>
<a name="l00971"></a>00971 <span class="preprocessor"></span>            my @userRecords = $db-&gt;getUserSets(map { [$_, $setID] } @editForUser);
<a name="l00972"></a>00972 <span class="preprocessor">            # if we&#39;re editing a set version, we want to edit</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span><span class="preprocessor">            #    edit that instead of the userset, so get it</span>
<a name="l00974"></a>00974 <span class="preprocessor"></span><span class="preprocessor">            #    too.</span>
<a name="l00975"></a>00975 <span class="preprocessor"></span>            my $userSet = $userRecords[0];
<a name="l00976"></a>00976             my $setVersion = 0;
<a name="l00977"></a>00977             <span class="keywordflow">if</span> ( $editingSetVersion ) {
<a name="l00978"></a>00978                 $setVersion =
<a name="l00979"></a>00979                     $db-&gt;getSetVersion($editForUser[0],
<a name="l00980"></a>00980                                $setID,
<a name="l00981"></a>00981                                $editingSetVersion);
<a name="l00982"></a>00982                 @userRecords = ( $setVersion );
<a name="l00983"></a>00983             }
<a name="l00984"></a>00984 
<a name="l00985"></a>00985             <span class="keywordflow">foreach</span> my $record (@userRecords) {
<a name="l00986"></a>00986                 <span class="keywordflow">foreach</span> my $field ( @{ SET_FIELDS() } ) {
<a name="l00987"></a>00987                     next unless canChange($forUsers, $field);
<a name="l00988"></a>00988                     my $override = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field.override&quot;</span>);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990                     <span class="keywordflow">if</span> (defined $override &amp;&amp; $override eq $field) {
<a name="l00991"></a>00991 
<a name="l00992"></a>00992                         my $param = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field&quot;</span>);
<a name="l00993"></a>00993                         $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l00994"></a>00994                         my $unlabel = $undoLabels{$field}-&gt;{$param};
<a name="l00995"></a>00995                         $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
<a name="l00996"></a>00996 <span class="preprocessor">#                       $param = $undoLabels{$field}-&gt;{$param} || $param;</span>
<a name="l00997"></a>00997 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ($field =~ /_date/) {
<a name="l00998"></a>00998                             $param = $self-&gt;parseDateTime($param) unless defined $unlabel;
<a name="l00999"></a>00999                         }
<a name="l01000"></a>01000                         <span class="keywordflow">if</span> (defined($properties{$field}-&gt;{convertby}) &amp;&amp; $properties{$field}-&gt;{convertby}) {
<a name="l01001"></a>01001                             $param = $param*$properties{$field}-&gt;{convertby};
<a name="l01002"></a>01002                         }
<a name="l01003"></a>01003 <span class="preprocessor">                        # special case; does field fill in multiple values?</span>
<a name="l01004"></a>01004 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( $field =~ /:/ ) {
<a name="l01005"></a>01005                             my @values = split(/:/, $param);
<a name="l01006"></a>01006                             my @fields = split(/:/, $field);
<a name="l01007"></a>01007                             <span class="keywordflow">for</span> ( my $i=0; $i&lt;@values; $i++ ) { 
<a name="l01008"></a>01008                                 my $f=$fields[$i]; 
<a name="l01009"></a>01009                                 $record-&gt;$f($values[$i]); 
<a name="l01010"></a>01010                             }
<a name="l01011"></a>01011                         } <span class="keywordflow">else</span> {
<a name="l01012"></a>01012                             $record-&gt;$field($param);
<a name="l01013"></a>01013                         }
<a name="l01014"></a>01014                     } <span class="keywordflow">else</span> {
<a name="l01015"></a>01015 <span class="preprocessor">                        ####################</span>
<a name="l01016"></a>01016 <span class="preprocessor"></span><span class="preprocessor">                        # FIXME: allow one selector to set multiple fields</span>
<a name="l01017"></a>01017 <span class="preprocessor"></span><span class="preprocessor">                        # </span>
<a name="l01018"></a>01018 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( $field =~ /:/ ) {
<a name="l01019"></a>01019                             <span class="keywordflow">foreach</span> my $f ( split(/:/, $field) ) {
<a name="l01020"></a>01020                                 $record-&gt;$f(undef);
<a name="l01021"></a>01021                             }
<a name="l01022"></a>01022                         } <span class="keywordflow">else</span> {
<a name="l01023"></a>01023                             $record-&gt;$field(undef);
<a name="l01024"></a>01024                         }
<a name="l01025"></a>01025                     }
<a name="l01026"></a>01026                 
<a name="l01027"></a>01027                 }
<a name="l01028"></a>01028 <span class="preprocessor">                ####################</span>
<a name="l01029"></a>01029 <span class="preprocessor"></span><span class="preprocessor">                # FIXME: this is replaced by our allowing multiple fields to be set by one selector</span>
<a name="l01030"></a>01030 <span class="preprocessor"></span><span class="preprocessor">                # a check for hiding scores: if we have </span>
<a name="l01031"></a>01031 <span class="preprocessor"></span><span class="preprocessor">                #    $set-&gt;hide_score eq &#39;N&#39;, we also want </span>
<a name="l01032"></a>01032 <span class="preprocessor"></span><span class="preprocessor">                #    $set-&gt;hide_score_by_problem eq &#39;N&#39;</span>
<a name="l01033"></a>01033 <span class="preprocessor"></span><span class="preprocessor">                # if ( $record-&gt;hide_score eq &#39;N&#39; ) {</span>
<a name="l01034"></a>01034 <span class="preprocessor"></span><span class="preprocessor">                #   $record-&gt;hide_score_by_problem(&#39;N&#39;);</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span><span class="preprocessor">                # }</span>
<a name="l01036"></a>01036 <span class="preprocessor"></span><span class="preprocessor">                ####################</span>
<a name="l01037"></a>01037 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $editingSetVersion ) {
<a name="l01038"></a>01038                     $db-&gt;putSetVersion( $record );
<a name="l01039"></a>01039                 } <span class="keywordflow">else</span> {
<a name="l01040"></a>01040                     $db-&gt;putUserSet($record);
<a name="l01041"></a>01041                 }
<a name="l01042"></a>01042             }
<a name="l01043"></a>01043 
<a name="l01044"></a>01044 <span class="preprocessor">        #######################################################</span>
<a name="l01045"></a>01045 <span class="preprocessor"></span><span class="preprocessor">        # Save IP restriction Location information</span>
<a name="l01046"></a>01046 <span class="preprocessor"></span><span class="preprocessor">        #######################################################</span>
<a name="l01047"></a>01047 <span class="preprocessor"></span><span class="preprocessor">        # FIXME: it would be nice to have this in the field values</span>
<a name="l01048"></a>01048 <span class="preprocessor"></span><span class="preprocessor">        #    hash, so that we don&#39;t have to assume that we can </span>
<a name="l01049"></a>01049 <span class="preprocessor"></span><span class="preprocessor">        #    override this information for users</span>
<a name="l01050"></a>01050 <span class="preprocessor"></span>
<a name="l01051"></a>01051 <span class="preprocessor">            ## should we allow resetting set locations for set versions?  this</span>
<a name="l01052"></a>01052 <span class="preprocessor"></span><span class="preprocessor">            ##    requires either putting in a new set of database routines</span>
<a name="l01053"></a>01053 <span class="preprocessor"></span><span class="preprocessor">            ##    to deal with the versioned setID, or fudging it at this end</span>
<a name="l01054"></a>01054 <span class="preprocessor"></span><span class="preprocessor">            ##    by manually putting in the versioned ID setID,v#.  neither</span>
<a name="l01055"></a>01055 <span class="preprocessor"></span><span class="preprocessor">            ##    of these seems desirable, so for now it&#39;s not allowed</span>
<a name="l01056"></a>01056 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
<a name="l01057"></a>01057                 <span class="keywordflow">if</span> ( $r-&gt;param(<span class="stringliteral">&quot;set.$setID.selected_ip_locations.override&quot;</span>) ) {
<a name="l01058"></a>01058                     <span class="keywordflow">foreach</span> my $record ( @userRecords ) {
<a name="l01059"></a>01059                         my $userID = $record-&gt;user_id;
<a name="l01060"></a>01060                         my @selectedLocations = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.selected_ip_locations&quot;</span>);
<a name="l01061"></a>01061                         my @userSetLocations = $db-&gt;listUserSetLocations($userID,$setID);
<a name="l01062"></a>01062                         my @addSetLocations = ();
<a name="l01063"></a>01063                         my @delSetLocations = ();
<a name="l01064"></a>01064                         <span class="keywordflow">foreach</span> my $loc ( @selectedLocations ) {
<a name="l01065"></a>01065                             push( @addSetLocations, $loc ) if ( ! grep( /^$loc$/, @userSetLocations ) );
<a name="l01066"></a>01066                         }
<a name="l01067"></a>01067                         foreach my $loc ( @userSetLocations ) {
<a name="l01068"></a>01068                             push( @delSetLocations, $loc ) if ( ! grep( /^$loc$/, @selectedLocations ) );
<a name="l01069"></a>01069                         }
<a name="l01070"></a>01070                         <span class="preprocessor"># then update the user set_locations</span>
<a name="l01071"></a>01071 <span class="preprocessor"></span>                        <span class="keywordflow">foreach</span> ( @addSetLocations ) {
<a name="l01072"></a>01072                             my $Loc = $db-&gt;newUserSetLocation;
<a name="l01073"></a>01073                             $Loc-&gt;set_id( $setID );
<a name="l01074"></a>01074                             $Loc-&gt;user_id( $userID );
<a name="l01075"></a>01075                             $Loc-&gt;location_id($_);
<a name="l01076"></a>01076                             $db-&gt;addUserSetLocation($Loc);
<a name="l01077"></a>01077                         }
<a name="l01078"></a>01078                         <span class="keywordflow">foreach</span> ( @delSetLocations ) {
<a name="l01079"></a>01079                             $db-&gt;deleteUserSetLocation($userID,$setID,$_);
<a name="l01080"></a>01080                         }
<a name="l01081"></a>01081                     }
<a name="l01082"></a>01082                 } <span class="keywordflow">else</span> {
<a name="l01083"></a>01083 <span class="preprocessor">                    # if override isn&#39;t selected, then we want</span>
<a name="l01084"></a>01084 <span class="preprocessor"></span><span class="preprocessor">                    #    to be sure that there are no</span>
<a name="l01085"></a>01085 <span class="preprocessor"></span><span class="preprocessor">                    #    set_locations_user entries setting around</span>
<a name="l01086"></a>01086 <span class="preprocessor"></span>                    <span class="keywordflow">foreach</span> my $record ( @userRecords ) {
<a name="l01087"></a>01087                         my $userID = $record-&gt;user_id;
<a name="l01088"></a>01088                         my @userLocations = $db-&gt;listUserSetLocations($userID,$setID);
<a name="l01089"></a>01089                         <span class="keywordflow">foreach</span> ( @userLocations ) {
<a name="l01090"></a>01090                             $db-&gt;deleteUserSetLocation($userID,$setID,$_);
<a name="l01091"></a>01091                         }
<a name="l01092"></a>01092                     }
<a name="l01093"></a>01093                 }
<a name="l01094"></a>01094             }
<a name="l01095"></a>01095         } <span class="keywordflow">else</span> {
<a name="l01096"></a>01096             <span class="keywordflow">foreach</span> my $field ( @{ SET_FIELDS() } ) {
<a name="l01097"></a>01097                 next unless canChange($forUsers, $field);
<a name="l01098"></a>01098 
<a name="l01099"></a>01099                 my $param = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$field&quot;</span>);
<a name="l01100"></a>01100                 $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l01101"></a>01101 
<a name="l01102"></a>01102                 my $unlabel = $undoLabels{$field}-&gt;{$param};
<a name="l01103"></a>01103                 $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
<a name="l01104"></a>01104                 <span class="keywordflow">if</span> ($field =~ /_date/) {
<a name="l01105"></a>01105                     $param = $self-&gt;parseDateTime($param) unless defined $unlabel;
<a name="l01106"></a>01106                 }
<a name="l01107"></a>01107                 <span class="keywordflow">if</span> (defined($properties{$field}-&gt;{convertby}) &amp;&amp; $properties{$field}-&gt;{convertby} &amp;&amp; $param) {
<a name="l01108"></a>01108                     $param = $param*$properties{$field}-&gt;{convertby};
<a name="l01109"></a>01109                 }
<a name="l01110"></a>01110 <span class="preprocessor">                # special case; does field fill in multiple values?</span>
<a name="l01111"></a>01111 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $field =~ /:/ ) {
<a name="l01112"></a>01112                     my @values = split(/:/, $param);
<a name="l01113"></a>01113                     my @fields = split(/:/, $field);
<a name="l01114"></a>01114                     <span class="keywordflow">for</span> ( my $i=0; $i&lt;@fields; $i++ ) { 
<a name="l01115"></a>01115                         my $f = $fields[$i];
<a name="l01116"></a>01116                         $setRecord-&gt;$f($values[$i]); 
<a name="l01117"></a>01117                     }
<a name="l01118"></a>01118                 } <span class="keywordflow">else</span> {
<a name="l01119"></a>01119                     $setRecord-&gt;$field($param);
<a name="l01120"></a>01120                 }
<a name="l01121"></a>01121             }
<a name="l01122"></a>01122 <span class="preprocessor">####################</span>
<a name="l01123"></a>01123 <span class="preprocessor"></span><span class="preprocessor"># FIXME: this is replaced by our setting both hide_score and hide_score_by_problem</span>
<a name="l01124"></a>01124 <span class="preprocessor"></span><span class="preprocessor">#    with a single drop down</span>
<a name="l01125"></a>01125 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l01126"></a>01126 <span class="preprocessor"></span><span class="preprocessor">#           # a check for hiding scores: if we have </span>
<a name="l01127"></a>01127 <span class="preprocessor"></span><span class="preprocessor">#           #    $set-&gt;hide_score eq &#39;N&#39;, we also want </span>
<a name="l01128"></a>01128 <span class="preprocessor"></span><span class="preprocessor">#           #    $set-&gt;hide_score_by_problem eq &#39;N&#39;, and if it&#39;s</span>
<a name="l01129"></a>01129 <span class="preprocessor"></span><span class="preprocessor">#           #    changed to &#39;Y&#39; and hide_score_by_problem is Null,</span>
<a name="l01130"></a>01130 <span class="preprocessor"></span><span class="preprocessor">#           #    give it a value &#39;N&#39;</span>
<a name="l01131"></a>01131 <span class="preprocessor"></span><span class="preprocessor">#           if ( $setRecord-&gt;hide_score eq &#39;N&#39; ||</span>
<a name="l01132"></a>01132 <span class="preprocessor"></span><span class="preprocessor">#                ( ! defined($setRecord-&gt;hide_score_by_problem) ||</span>
<a name="l01133"></a>01133 <span class="preprocessor"></span><span class="preprocessor">#                  $setRecord-&gt;hide_score_by_problem eq &#39;&#39; ) ) {</span>
<a name="l01134"></a>01134 <span class="preprocessor"></span><span class="preprocessor">#               $setRecord-&gt;hide_score_by_problem(&#39;N&#39;);</span>
<a name="l01135"></a>01135 <span class="preprocessor"></span><span class="preprocessor">#           }</span>
<a name="l01136"></a>01136 <span class="preprocessor"></span><span class="preprocessor">####################</span>
<a name="l01137"></a>01137 <span class="preprocessor"></span>            $db-&gt;putGlobalSet($setRecord);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139 <span class="preprocessor">        #######################################################</span>
<a name="l01140"></a>01140 <span class="preprocessor"></span><span class="preprocessor">        # Save IP restriction Location information</span>
<a name="l01141"></a>01141 <span class="preprocessor"></span><span class="preprocessor">        #######################################################</span>
<a name="l01142"></a>01142 <span class="preprocessor"></span>
<a name="l01143"></a>01143             <span class="keywordflow">if</span> ( defined($r-&gt;param(<span class="stringliteral">&quot;set.$setID.restrict_ip&quot;</span>)) and $r-&gt;param(<span class="stringliteral">&quot;set.$setID.restrict_ip&quot;</span>) ne <span class="stringliteral">&#39;No&#39;</span> ) {
<a name="l01144"></a>01144                 my @selectedLocations = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.selected_ip_locations&quot;</span>);
<a name="l01145"></a>01145                 my @globalSetLocations = $db-&gt;listGlobalSetLocations($setID);
<a name="l01146"></a>01146                 my @addSetLocations = ();
<a name="l01147"></a>01147                 my @delSetLocations = ();
<a name="l01148"></a>01148                 <span class="keywordflow">foreach</span> my $loc ( @selectedLocations ) {
<a name="l01149"></a>01149                     push( @addSetLocations, $loc ) if ( ! grep( /^$loc$/, @globalSetLocations ) );
<a name="l01150"></a>01150                 }
<a name="l01151"></a>01151                 foreach my $loc ( @globalSetLocations ) {
<a name="l01152"></a>01152                     push( @delSetLocations, $loc ) if ( ! grep( /^$loc$/, @selectedLocations ) );
<a name="l01153"></a>01153                 }
<a name="l01154"></a>01154                 <span class="preprocessor"># then update the global set_locations</span>
<a name="l01155"></a>01155 <span class="preprocessor"></span>                <span class="keywordflow">foreach</span> ( @addSetLocations ) {
<a name="l01156"></a>01156                     my $Loc = $db-&gt;newGlobalSetLocation;
<a name="l01157"></a>01157                     $Loc-&gt;set_id( $setID );
<a name="l01158"></a>01158                     $Loc-&gt;location_id($_);
<a name="l01159"></a>01159                     $db-&gt;addGlobalSetLocation($Loc);
<a name="l01160"></a>01160                 }
<a name="l01161"></a>01161                 <span class="keywordflow">foreach</span> ( @delSetLocations ) {
<a name="l01162"></a>01162                     $db-&gt;deleteGlobalSetLocation($setID,$_);
<a name="l01163"></a>01163                 }
<a name="l01164"></a>01164             } <span class="keywordflow">else</span> {
<a name="l01165"></a>01165                 my @globalSetLocations = $db-&gt;listGlobalSetLocations($setID);
<a name="l01166"></a>01166                 <span class="keywordflow">foreach</span> ( @globalSetLocations ) {
<a name="l01167"></a>01167                     $db-&gt;deleteGlobalSetLocation($setID,$_);
<a name="l01168"></a>01168                 }
<a name="l01169"></a>01169             }
<a name="l01170"></a>01170 
<a name="l01171"></a>01171 <span class="preprocessor">        #######################################################</span>
<a name="l01172"></a>01172 <span class="preprocessor"></span><span class="preprocessor">        # Save proctored problem proctor user information</span>
<a name="l01173"></a>01173 <span class="preprocessor"></span><span class="preprocessor">        #######################################################</span>
<a name="l01174"></a>01174 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ($r-&gt;param(<span class="stringliteral">&quot;set.$setID.restricted_login_proctor_password&quot;</span>) &amp;&amp;
<a name="l01175"></a>01175                 $setRecord-&gt;assignment_type eq <span class="stringliteral">&#39;proctored_gateway&#39;</span>) {
<a name="l01176"></a>01176 <span class="preprocessor">                # in this case we&#39;re adding a set-level proctor</span>
<a name="l01177"></a>01177 <span class="preprocessor"></span><span class="preprocessor">                #    or updating the password</span>
<a name="l01178"></a>01178 <span class="preprocessor"></span>
<a name="l01179"></a>01179                 my $procID = <span class="stringliteral">&quot;set_id:$setID&quot;</span>;
<a name="l01180"></a>01180                 my $pass = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.restricted_login_proctor_password&quot;</span>);
<a name="l01181"></a>01181 <span class="preprocessor">                # should we carefully check in this case that</span>
<a name="l01182"></a>01182 <span class="preprocessor"></span><span class="preprocessor">                #    the user and password exist?  the code </span>
<a name="l01183"></a>01183 <span class="preprocessor"></span><span class="preprocessor">                #    in the add stanza is pretty careful to </span>
<a name="l01184"></a>01184 <span class="preprocessor"></span><span class="preprocessor">                #    be sure that there&#39;s a one-to-one </span>
<a name="l01185"></a>01185 <span class="preprocessor"></span><span class="preprocessor">                #    correspondence between the existence of </span>
<a name="l01186"></a>01186 <span class="preprocessor"></span><span class="preprocessor">                #    the user and the setting of the set</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span><span class="preprocessor">                #    restricted_login_proctor field, so we </span>
<a name="l01188"></a>01188 <span class="preprocessor"></span><span class="preprocessor">                #    assume that just checking the latter </span>
<a name="l01189"></a>01189 <span class="preprocessor"></span><span class="preprocessor">                #    here is sufficient.</span>
<a name="l01190"></a>01190 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $setRecord-&gt;restricted_login_proctor eq <span class="stringliteral">&#39;Yes&#39;</span> ) {
<a name="l01191"></a>01191 <span class="preprocessor">                    # in this case we already have a set</span>
<a name="l01192"></a>01192 <span class="preprocessor"></span><span class="preprocessor">                    #    level proctor, and so should be </span>
<a name="l01193"></a>01193 <span class="preprocessor"></span><span class="preprocessor">                    #    resetting the password</span>
<a name="l01194"></a>01194 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> ( $pass ne <span class="stringliteral">&#39;********&#39;</span> ) {
<a name="l01195"></a>01195 <span class="preprocessor">                        # then we submitted a new </span>
<a name="l01196"></a>01196 <span class="preprocessor"></span><span class="preprocessor">                        #    password, so save it</span>
<a name="l01197"></a>01197 <span class="preprocessor"></span>                        my $dbPass;
<a name="l01198"></a>01198                         eval { $dbPass = $db-&gt;getPassword($procID) };
<a name="l01199"></a>01199                         <span class="keywordflow">if</span> ( $@ ) {
<a name="l01200"></a>01200                             $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error getting old set-proctor password from the database: [_1].  No update to the password was done.&quot;</span>, $@));
<a name="l01201"></a>01201                         } <span class="keywordflow">else</span> {
<a name="l01202"></a>01202                             $dbPass-&gt;password(cryptPassword($pass));
<a name="l01203"></a>01203                             $db-&gt;putPassword($dbPass);
<a name="l01204"></a>01204                         }
<a name="l01205"></a>01205                     }
<a name="l01206"></a>01206 
<a name="l01207"></a>01207                 } <span class="keywordflow">else</span> {
<a name="l01208"></a>01208                     $setRecord-&gt;restricted_login_proctor(<span class="stringliteral">&#39;Yes&#39;</span>);
<a name="l01209"></a>01209                     my $procUser = $db-&gt;newUser();
<a name="l01210"></a>01210                     $procUser-&gt;user_id($procID);
<a name="l01211"></a>01211                     $procUser-&gt;last_name(<span class="stringliteral">&quot;Proctor&quot;</span>);
<a name="l01212"></a>01212                     $procUser-&gt;first_name(<span class="stringliteral">&quot;Login&quot;</span>);
<a name="l01213"></a>01213                     $procUser-&gt;student_id(<span class="stringliteral">&quot;loginproctor&quot;</span>);
<a name="l01214"></a>01214                     $procUser-&gt;status($ce-&gt;status_name_to_abbrevs(<span class="stringliteral">&#39;Proctor&#39;</span>));
<a name="l01215"></a>01215                     my $procPerm = $db-&gt;newPermissionLevel;
<a name="l01216"></a>01216                     $procPerm-&gt;user_id($procID);
<a name="l01217"></a>01217                     $procPerm-&gt;permission($ce-&gt;{userRoles}-&gt;{login_proctor});
<a name="l01218"></a>01218                     my $procPass = $db-&gt;newPassword;
<a name="l01219"></a>01219                     $procPass-&gt;user_id($procID);
<a name="l01220"></a>01220                     $procPass-&gt;password(cryptPassword($pass));
<a name="l01221"></a>01221 <span class="preprocessor">                    # put these into the database</span>
<a name="l01222"></a>01222 <span class="preprocessor"></span>                    eval { $db-&gt;addUser($procUser) };
<a name="l01223"></a>01223                     <span class="keywordflow">if</span> ( $@ ) { 
<a name="l01224"></a>01224                         $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Error adding set-level proctor: [_1]&quot;</span>, $@));
<a name="l01225"></a>01225                     } <span class="keywordflow">else</span> {
<a name="l01226"></a>01226                         $db-&gt;addPermissionLevel($procPerm);
<a name="l01227"></a>01227                         $db-&gt;addPassword($procPass);
<a name="l01228"></a>01228                     }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230 <span class="preprocessor">                    # and set the restricted_login_proctor</span>
<a name="l01231"></a>01231 <span class="preprocessor"></span><span class="preprocessor">                    #    set field</span>
<a name="l01232"></a>01232 <span class="preprocessor"></span>                    $db-&gt;putGlobalSet( $setRecord );
<a name="l01233"></a>01233                 }
<a name="l01234"></a>01234 
<a name="l01235"></a>01235             } <span class="keywordflow">else</span> {
<a name="l01236"></a>01236 <span class="preprocessor">                # if the parameter isn&#39;t set, or if the assignment</span>
<a name="l01237"></a>01237 <span class="preprocessor"></span><span class="preprocessor">                #    type is not &#39;proctored_gateway&#39;, then we need to be </span>
<a name="l01238"></a>01238 <span class="preprocessor"></span><span class="preprocessor">                #    sure that there&#39;s no set-level proctor defined</span>
<a name="l01239"></a>01239 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $setRecord-&gt;restricted_login_proctor eq <span class="stringliteral">&#39;Yes&#39;</span> ) {
<a name="l01240"></a>01240 
<a name="l01241"></a>01241                     $setRecord-&gt;restricted_login_proctor(<span class="stringliteral">&#39;No&#39;</span>);
<a name="l01242"></a>01242                     $db-&gt;deleteUser( <span class="stringliteral">&quot;set_id:$setID&quot;</span> );
<a name="l01243"></a>01243                     $db-&gt;putGlobalSet( $setRecord );
<a name="l01244"></a>01244 
<a name="l01245"></a>01245                 }
<a name="l01246"></a>01246             }
<a name="l01247"></a>01247         }
<a name="l01248"></a>01248         
<a name="l01249"></a>01249 <span class="preprocessor">        #####################################################################</span>
<a name="l01250"></a>01250 <span class="preprocessor"></span><span class="preprocessor">        # Save problem information</span>
<a name="l01251"></a>01251 <span class="preprocessor"></span><span class="preprocessor">        #####################################################################</span>
<a name="l01252"></a>01252 <span class="preprocessor"></span>
<a name="l01253"></a>01253 <span class="preprocessor">        # DBFIXME use a WHERE clause, iterator?</span>
<a name="l01254"></a>01254 <span class="preprocessor"></span>        my @problemIDs = sort { $a &lt;=&gt; $b } $db-&gt;listGlobalProblems($setID);;
<a name="l01255"></a>01255         my @problemRecords = $db-&gt;getGlobalProblems(map { [$setID, $_] } @problemIDs);
<a name="l01256"></a>01256         <span class="keywordflow">foreach</span> my $problemRecord (@problemRecords) {
<a name="l01257"></a>01257             my $problemID = $problemRecord-&gt;problem_id;
<a name="l01258"></a>01258             die $r-&gt;maketext(<span class="stringliteral">&quot;Global problem [_1] for set [_2] not found.&quot;</span>, $problemID, $setID) unless $problemRecord;
<a name="l01259"></a>01259             
<a name="l01260"></a>01260             <span class="keywordflow">if</span> ($forUsers) {
<a name="l01261"></a>01261 <span class="preprocessor">                # Since we&#39;re editing for specific users, we don&#39;t allow the GlobalProblem record to be altered on that same page</span>
<a name="l01262"></a>01262 <span class="preprocessor"></span><span class="preprocessor">                # So we only need to make changes to the UserProblem record and only then if we are overriding a value</span>
<a name="l01263"></a>01263 <span class="preprocessor"></span><span class="preprocessor">                # in the GlobalProblem record or for fields unique to the UserProblem record.</span>
<a name="l01264"></a>01264 <span class="preprocessor"></span>                                
<a name="l01265"></a>01265                 my @userIDs = @editForUser;
<a name="l01266"></a>01266 
<a name="l01267"></a>01267                 my @userProblemRecords;
<a name="l01268"></a>01268                 <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
<a name="l01269"></a>01269                     my @userProblemIDs = map { [$_, $setID, $problemID] } @userIDs;
<a name="l01270"></a>01270 <span class="preprocessor">                    # DBFIXME where clause? iterator?</span>
<a name="l01271"></a>01271 <span class="preprocessor"></span>                    @userProblemRecords = $db-&gt;getUserProblems(@userProblemIDs);
<a name="l01272"></a>01272                 } <span class="keywordflow">else</span> {
<a name="l01273"></a>01273 <span class="preprocessor">                    ## (we know that we&#39;re only editing for one user)</span>
<a name="l01274"></a>01274 <span class="preprocessor"></span>                    @userProblemRecords =
<a name="l01275"></a>01275                         ( $db-&gt;getMergedProblemVersion( $userIDs[0], $setID, $editingSetVersion, $problemID ) );
<a name="l01276"></a>01276                 }
<a name="l01277"></a>01277 
<a name="l01278"></a>01278                 <span class="keywordflow">foreach</span> my $record (@userProblemRecords) {
<a name="l01279"></a>01279 
<a name="l01280"></a>01280                     my $changed = 0; # keep track of any changes, <span class="keywordflow">if</span> none are made, avoid unnecessary db accesses
<a name="l01281"></a>01281                     <span class="keywordflow">foreach</span> my $field ( @{ PROBLEM_FIELDS() } ) {
<a name="l01282"></a>01282                         next unless canChange($forUsers, $field);
<a name="l01283"></a>01283 
<a name="l01284"></a>01284                         my $override = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field.override&quot;</span>);
<a name="l01285"></a>01285                         <span class="keywordflow">if</span> (defined $override &amp;&amp; $override eq $field) {
<a name="l01286"></a>01286 
<a name="l01287"></a>01287                             my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
<a name="l01288"></a>01288                             $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l01289"></a>01289                             my $unlabel = $undoLabels{$field}-&gt;{$param};
<a name="l01290"></a>01290                             $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
<a name="l01291"></a>01291 <span class="preprocessor">                                                #protect exploits with source_file</span>
<a name="l01292"></a>01292 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> ($field eq <span class="stringliteral">&#39;source_file&#39;</span>) {
<a name="l01293"></a>01293 <span class="preprocessor">                                # add message</span>
<a name="l01294"></a>01294 <span class="preprocessor"></span>                                <span class="keywordflow">if</span> ( $param =~ /\.\./ || $param =~ /^\<span class="comment">// ) {</span>
<a name="l01295"></a>01295                                     $self-&gt;addbadmessage( $r-&gt;maketext(<span class="stringliteral">&quot;Source file paths cannot include .. or start with /: your source file path was modified.&quot;</span>) );
<a name="l01296"></a>01296                                 }
<a name="l01297"></a>01297                                 $param =~ s|\.\.||g;    # prevent access to files above <span class="keyword">template</span>
<a name="l01298"></a>01298                                 $param =~ s|^/||;       # prevent access to files above <span class="keyword">template</span>
<a name="l01299"></a>01299                             }
<a name="l01300"></a>01300 
<a name="l01301"></a>01301                             $changed ||= changed($record-&gt;$field, $param);
<a name="l01302"></a>01302                             $record-&gt;$field($param);
<a name="l01303"></a>01303                         } <span class="keywordflow">else</span> {
<a name="l01304"></a>01304                             $changed ||= changed($record-&gt;$field, undef);
<a name="l01305"></a>01305                             $record-&gt;$field(undef);
<a name="l01306"></a>01306                         }
<a name="l01307"></a>01307                         
<a name="l01308"></a>01308                     }
<a name="l01309"></a>01309                     
<a name="l01310"></a>01310                     <span class="keywordflow">foreach</span> my $field ( @{ USER_PROBLEM_FIELDS() } ) {
<a name="l01311"></a>01311                         next unless canChange($forUsers, $field);
<a name="l01312"></a>01312 
<a name="l01313"></a>01313                         my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
<a name="l01314"></a>01314                         $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l01315"></a>01315                         my $unlabel = $undoLabels{$field}-&gt;{$param};
<a name="l01316"></a>01316                         $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
<a name="l01317"></a>01317 <span class="preprocessor">                                            #protect exploits with source_file</span>
<a name="l01318"></a>01318 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ($field eq <span class="stringliteral">&#39;source_file&#39;</span>) {
<a name="l01319"></a>01319 <span class="preprocessor">                            # add message</span>
<a name="l01320"></a>01320 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> ( $param =~ /\.\./ || $param =~ /^\<span class="comment">// ) {</span>
<a name="l01321"></a>01321                                 $self-&gt;addbadmessage( $r-&gt;maketext(<span class="stringliteral">&quot;Source file paths cannot include .. or start with /: your source file path was modified.&quot;</span>));
<a name="l01322"></a>01322                             }
<a name="l01323"></a>01323                             $param =~ s|\.\.||g;    # prevent access to files above <span class="keyword">template</span>
<a name="l01324"></a>01324                             $param =~ s|^/||;       # prevent access to files above <span class="keyword">template</span>
<a name="l01325"></a>01325                         }
<a name="l01326"></a>01326 
<a name="l01327"></a>01327                         $changed ||= changed($record-&gt;$field, $param);
<a name="l01328"></a>01328                         $record-&gt;$field($param);
<a name="l01329"></a>01329                     }
<a name="l01330"></a>01330                     <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
<a name="l01331"></a>01331                         $db-&gt;putUserProblem($record) <span class="keywordflow">if</span> $changed;
<a name="l01332"></a>01332                     } <span class="keywordflow">else</span> {
<a name="l01333"></a>01333                         $db-&gt;putProblemVersion($record) <span class="keywordflow">if</span> $changed;
<a name="l01334"></a>01334                     }
<a name="l01335"></a>01335                 }
<a name="l01336"></a>01336             } <span class="keywordflow">else</span> { 
<a name="l01337"></a>01337 <span class="preprocessor">                # Since we&#39;re editing for ALL set users, we will make changes to the GlobalProblem record.</span>
<a name="l01338"></a>01338 <span class="preprocessor"></span><span class="preprocessor">                # We may also have instances where a field is unique to the UserProblem record but we want</span>
<a name="l01339"></a>01339 <span class="preprocessor"></span><span class="preprocessor">                # all users to (at least initially) have the same value</span>
<a name="l01340"></a>01340 <span class="preprocessor"></span>
<a name="l01341"></a>01341 <span class="preprocessor">                # this only edits a globalProblem record</span>
<a name="l01342"></a>01342 <span class="preprocessor"></span>                my $changed = 0; # keep track of any changes, <span class="keywordflow">if</span> none are made, avoid unnecessary db accesses
<a name="l01343"></a>01343                 <span class="keywordflow">foreach</span> my $field ( @{ PROBLEM_FIELDS() } ) {
<a name="l01344"></a>01344                     next unless canChange($forUsers, $field);
<a name="l01345"></a>01345 
<a name="l01346"></a>01346                     my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
<a name="l01347"></a>01347                     $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l01348"></a>01348                     my $unlabel = $undoLabels{$field}-&gt;{$param};
<a name="l01349"></a>01349                     $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
<a name="l01350"></a>01350                     
<a name="l01351"></a>01351 <span class="preprocessor">                    #protect exploits with source_file</span>
<a name="l01352"></a>01352 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> ($field eq <span class="stringliteral">&#39;source_file&#39;</span>) {
<a name="l01353"></a>01353 <span class="preprocessor">                        # add message</span>
<a name="l01354"></a>01354 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> ( $param =~ /\.\./ || $param =~ /^\<span class="comment">// ) {</span>
<a name="l01355"></a>01355                             $self-&gt;addbadmessage( $r-&gt;maketext(<span class="stringliteral">&quot;Source file paths cannot include .. or start with /: your source file path was modified.&quot;</span>) );
<a name="l01356"></a>01356                         }
<a name="l01357"></a>01357                         $param =~ s|\.\.||g;    # prevent access to files above <span class="keyword">template</span>
<a name="l01358"></a>01358                         $param =~ s|^/||;       # prevent access to files above <span class="keyword">template</span>
<a name="l01359"></a>01359                     }
<a name="l01360"></a>01360                     $changed ||= changed($problemRecord-&gt;$field, $param);
<a name="l01361"></a>01361                     $problemRecord-&gt;$field($param);
<a name="l01362"></a>01362                 }
<a name="l01363"></a>01363                 $db-&gt;putGlobalProblem($problemRecord) <span class="keywordflow">if</span> $changed;
<a name="l01364"></a>01364 
<a name="l01365"></a>01365 
<a name="l01366"></a>01366 <span class="preprocessor">                # sometimes (like for status) we might want to change an attribute in</span>
<a name="l01367"></a>01367 <span class="preprocessor"></span><span class="preprocessor">                # the userProblem record for every assigned user</span>
<a name="l01368"></a>01368 <span class="preprocessor"></span><span class="preprocessor">                # However, since this data is stored in the UserProblem records,</span>
<a name="l01369"></a>01369 <span class="preprocessor"></span><span class="preprocessor">                # it won&#39;t be displayed once its been changed and if you hit &quot;Save Changes&quot; again</span>
<a name="l01370"></a>01370 <span class="preprocessor"></span><span class="preprocessor">                # it gets erased</span>
<a name="l01371"></a>01371 <span class="preprocessor"></span>                
<a name="l01372"></a>01372 <span class="preprocessor">                # So we&#39;ll enforce that there be something worth putting in all the UserProblem records</span>
<a name="l01373"></a>01373 <span class="preprocessor"></span><span class="preprocessor">                # This also will make hitting &quot;Save Changes&quot; on the global page MUCH faster</span>
<a name="l01374"></a>01374 <span class="preprocessor"></span>                my %useful;
<a name="l01375"></a>01375                 <span class="keywordflow">foreach</span> my $field ( @{ USER_PROBLEM_FIELDS() } ) {
<a name="l01376"></a>01376                     my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
<a name="l01377"></a>01377                     $useful{$field} = 1 <span class="keywordflow">if</span> defined $param and $param ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l01378"></a>01378                 }
<a name="l01379"></a>01379 
<a name="l01380"></a>01380                 <span class="keywordflow">if</span> (keys %useful) {
<a name="l01381"></a>01381 <span class="preprocessor">                    # DBFIXME where clause, iterator</span>
<a name="l01382"></a>01382 <span class="preprocessor"></span>                    my @userIDs = $db-&gt;listProblemUsers($setID, $problemID);
<a name="l01383"></a>01383                     my @userProblemIDs = map { [$_, $setID, $problemID] } @userIDs;
<a name="l01384"></a>01384                     my @userProblemRecords = $db-&gt;getUserProblems(@userProblemIDs);
<a name="l01385"></a>01385                     <span class="keywordflow">foreach</span> my $record (@userProblemRecords) {
<a name="l01386"></a>01386                         my $changed = 0; # keep track of any changes, <span class="keywordflow">if</span> none are made, avoid unnecessary db accesses
<a name="l01387"></a>01387                         <span class="keywordflow">foreach</span> my $field ( keys %useful ) {
<a name="l01388"></a>01388                             next unless canChange($forUsers, $field);
<a name="l01389"></a>01389 
<a name="l01390"></a>01390                             my $param = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.$field&quot;</span>);
<a name="l01391"></a>01391                             $param = $properties{$field}-&gt;{<span class="keywordflow">default</span>} || <span class="stringliteral">&quot;&quot;</span> unless defined $param &amp;&amp; $param ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l01392"></a>01392                             my $unlabel = $undoLabels{$field}-&gt;{$param};
<a name="l01393"></a>01393                             $param = $unlabel <span class="keywordflow">if</span> defined $unlabel;
<a name="l01394"></a>01394                             $changed ||= changed($record-&gt;$field, $param);
<a name="l01395"></a>01395                             $record-&gt;$field($param);
<a name="l01396"></a>01396                         }
<a name="l01397"></a>01397                         $db-&gt;putUserProblem($record) <span class="keywordflow">if</span> $changed;
<a name="l01398"></a>01398                     }
<a name="l01399"></a>01399                 }
<a name="l01400"></a>01400             }
<a name="l01401"></a>01401         }
<a name="l01402"></a>01402         
<a name="l01403"></a>01403 <span class="preprocessor">        # Mark the specified problems as correct for all users (not applicable when editing a set</span>
<a name="l01404"></a>01404 <span class="preprocessor"></span><span class="preprocessor">        #    version, because this only shows up when editing for users or editing the</span>
<a name="l01405"></a>01405 <span class="preprocessor"></span><span class="preprocessor">        #    global set/problem, not for one user)</span>
<a name="l01406"></a>01406 <span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $problemID ($r-&gt;param(<span class="stringliteral">&#39;markCorrect&#39;</span>)) {
<a name="l01407"></a>01407 <span class="preprocessor">            # DBFIXME where clause, iterator</span>
<a name="l01408"></a>01408 <span class="preprocessor"></span>            my @userProblemIDs = map { [$_, $setID, $problemID] } ($forUsers ? @editForUser : $db-&gt;listProblemUsers($setID, $problemID));
<a name="l01409"></a>01409 <span class="preprocessor">            # if the set is not a gateway set, this requires going through the</span>
<a name="l01410"></a>01410 <span class="preprocessor"></span><span class="preprocessor">            #    user_problems and resetting their status; if it&#39;s a gateway set,</span>
<a name="l01411"></a>01411 <span class="preprocessor"></span><span class="preprocessor">            #    then we have to go through every *version* of every user_problem.</span>
<a name="l01412"></a>01412 <span class="preprocessor"></span><span class="preprocessor">            #    it may be that there is an argument for being able to get() all</span>
<a name="l01413"></a>01413 <span class="preprocessor"></span><span class="preprocessor">            #    problem versions for all users in one database call.  The current</span>
<a name="l01414"></a>01414 <span class="preprocessor"></span><span class="preprocessor">            #    code may be slow for large classes.</span>
<a name="l01415"></a>01415 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $setRecord-&gt;assignment_type !~ /gateway/ ) {
<a name="l01416"></a>01416                 my @userProblemRecords = $db-&gt;getUserProblems(@userProblemIDs);
<a name="l01417"></a>01417                 <span class="keywordflow">foreach</span> my $record (@userProblemRecords) {
<a name="l01418"></a>01418                     <span class="keywordflow">if</span> (defined $record &amp;&amp; ($record-&gt;status eq <span class="stringliteral">&quot;&quot;</span> || $record-&gt;status &lt; 1)) {
<a name="l01419"></a>01419                         $record-&gt;status(1);
<a name="l01420"></a>01420                         $record-&gt;attempted(1);
<a name="l01421"></a>01421                         $db-&gt;putUserProblem($record);
<a name="l01422"></a>01422                     }
<a name="l01423"></a>01423                 }
<a name="l01424"></a>01424             } <span class="keywordflow">else</span> {
<a name="l01425"></a>01425                 my @userIDs = ( $forUsers ) ? @editForUser : $db-&gt;listProblemUsers($setID, $problemID);
<a name="l01426"></a>01426                 <span class="keywordflow">foreach</span> my $uid ( @userIDs ) {
<a name="l01427"></a>01427                     my @versions = $db-&gt;listSetVersions( $uid, $setID );
<a name="l01428"></a>01428                     my @userProblemVersionIDs = 
<a name="l01429"></a>01429                         map{ [ $uid, $setID, $_, $problemID ]} @versions;
<a name="l01430"></a>01430                     my @userProblemVersionRecords = $db-&gt;getProblemVersions(@userProblemVersionIDs);
<a name="l01431"></a>01431                     <span class="keywordflow">foreach</span> my $record (@userProblemVersionRecords) { 
<a name="l01432"></a>01432                         <span class="keywordflow">if</span> (defined $record &amp;&amp; ($record-&gt;status eq <span class="stringliteral">&quot;&quot;</span> || $record-&gt;status &lt; 1)) {
<a name="l01433"></a>01433                             $record-&gt;status(1);
<a name="l01434"></a>01434                             $record-&gt;attempted(1);
<a name="l01435"></a>01435                             $db-&gt;putProblemVersion($record);
<a name="l01436"></a>01436                         }
<a name="l01437"></a>01437                     }
<a name="l01438"></a>01438                 }
<a name="l01439"></a>01439             }
<a name="l01440"></a>01440         }
<a name="l01441"></a>01441         
<a name="l01442"></a>01442 <span class="preprocessor">        # Delete all problems marked for deletion (not applicable when editing</span>
<a name="l01443"></a>01443 <span class="preprocessor"></span><span class="preprocessor">        #    for users)</span>
<a name="l01444"></a>01444 <span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $problemID ($r-&gt;param(<span class="stringliteral">&#39;deleteProblem&#39;</span>)) {
<a name="l01445"></a>01445             $db-&gt;deleteGlobalProblem($setID, $problemID);
<a name="l01446"></a>01446         }
<a name="l01447"></a>01447         
<a name="l01448"></a>01448 <span class="preprocessor">        #####################################################################</span>
<a name="l01449"></a>01449 <span class="preprocessor"></span><span class="preprocessor">        # Add blank problem if needed</span>
<a name="l01450"></a>01450 <span class="preprocessor"></span><span class="preprocessor">        #####################################################################</span>
<a name="l01451"></a>01451 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (defined($r-&gt;param(<span class="stringliteral">&quot;add_blank_problem&quot;</span>) ) and $r-&gt;param(<span class="stringliteral">&quot;add_blank_problem&quot;</span>) == 1) {
<a name="l01452"></a>01452 <span class="preprocessor">           # get number of problems to add and clean the entry</span>
<a name="l01453"></a>01453 <span class="preprocessor"></span>            my $newBlankProblems = (defined($r-&gt;param(<span class="stringliteral">&quot;add_n_problems&quot;</span>)) ) ? $r-&gt;param(<span class="stringliteral">&quot;add_n_problems&quot;</span>) :1;
<a name="l01454"></a>01454             $newBlankProblems = int($newBlankProblems);
<a name="l01455"></a>01455             my $MAX_NEW_PROBLEMS = 20;
<a name="l01456"></a>01456             <span class="keywordflow">if</span> ($newBlankProblems &gt;=1 and $newBlankProblems &lt;= $MAX_NEW_PROBLEMS ) {
<a name="l01457"></a>01457                 <span class="keywordflow">foreach</span> my $newProb (1..$newBlankProblems) {
<a name="l01458"></a>01458                         my $targetProblemNumber   =  1+ <a class="code" href="classWeBWorK_1_1Utils.html#a3d364a4d0cb81eef75c34845afb179e3">WeBWorK::Utils::max</a>( $self-&gt;r-&gt;db-&gt;listGlobalProblems($setID));
<a name="l01459"></a>01459 <span class="preprocessor">                        ##################################################</span>
<a name="l01460"></a>01460 <span class="preprocessor"></span><span class="preprocessor">                        # make local copy of the blankProblem</span>
<a name="l01461"></a>01461 <span class="preprocessor"></span><span class="preprocessor">                        ##################################################</span>
<a name="l01462"></a>01462 <span class="preprocessor"></span>                        my $blank_file_path       =  $ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{blankProblem};
<a name="l01463"></a>01463                         my $problemContents       =  <a class="code" href="classWeBWorK_1_1Utils.html#a7aa337cd97110ff3e5c7536bfb1a84e8">WeBWorK::Utils::readFile</a>($blank_file_path);
<a name="l01464"></a>01464                         my $new_file_path         =  <span class="stringliteral">&quot;set$setID/&quot;</span>.BLANKPROBLEM();
<a name="l01465"></a>01465                         my $fullPath              =  <a class="code" href="classWeBWorK_1_1Utils.html#aec74ceba9815c67c2d10f46fbe909063">WeBWorK::Utils::surePathToFile</a>($ce-&gt;{courseDirs}-&gt;{templates},<span class="charliteral">&#39;/&#39;</span>.$new_file_path);
<a name="l01466"></a>01466                         local(*TEMPFILE);
<a name="l01467"></a>01467                         open(TEMPFILE, <span class="stringliteral">&quot;&gt;$fullPath&quot;</span>) or warn $r-&gt;maketext(&quot;Can&#39;t write to file [_1]&quot;, $fullPath);
<a name="l01468"></a>01468                         print TEMPFILE $problemContents;
<a name="l01469"></a>01469                         close(TEMPFILE);
<a name="l01470"></a>01470                         
<a name="l01471"></a>01471                         <span class="preprocessor">#################################################</span>
<a name="l01472"></a>01472 <span class="preprocessor"></span><span class="preprocessor">                        # Update problem record</span>
<a name="l01473"></a>01473 <span class="preprocessor"></span><span class="preprocessor">                        #################################################</span>
<a name="l01474"></a>01474 <span class="preprocessor"></span>                        my $problemRecord  = $self-&gt;addProblemToSet(
<a name="l01475"></a>01475                                    setName        =&gt; $setID,
<a name="l01476"></a>01476                                    sourceFile     =&gt; $new_file_path, 
<a name="l01477"></a>01477                                    problemID      =&gt; $targetProblemNumber, #added to end of <span class="keyword">set</span>
<a name="l01478"></a>01478                         );
<a name="l01479"></a>01479                         $self-&gt;assignProblemToAllSetUsers($problemRecord);
<a name="l01480"></a>01480                         $self-&gt;addgoodmessage($r-&gt;maketext(<span class="stringliteral">&quot;Added [_1] to [_2] as problem [_3]&quot;</span>, $new_file_path, $setID, $targetProblemNumber)) ;
<a name="l01481"></a>01481                 }
<a name="l01482"></a>01482             } <span class="keywordflow">else</span> {
<a name="l01483"></a>01483                 $self-&gt;addbadmessage($r-&gt;maketext(<span class="stringliteral">&quot;Could not add [_1] problems to this set.  The number must be between 1 and [_2]&quot;</span>, $newBlankProblems, $MAX_NEW_PROBLEMS));
<a name="l01484"></a>01484             }
<a name="l01485"></a>01485         }
<a name="l01486"></a>01486         
<a name="l01487"></a>01487 <span class="preprocessor">        # Sets the specified header to &quot;defaultHeader&quot; so that the default file will get used.</span>
<a name="l01488"></a>01488 <span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $header ($r-&gt;param(<span class="stringliteral">&#39;defaultHeader&#39;</span>)) {
<a name="l01489"></a>01489             $setRecord-&gt;$header(<span class="stringliteral">&quot;defaultHeader&quot;</span>);
<a name="l01490"></a>01490         }
<a name="l01491"></a>01491     }   
<a name="l01492"></a>01492     
<a name="l01493"></a>01493 
<a name="l01494"></a>01494 
<a name="l01495"></a>01495 
<a name="l01496"></a>01496 <span class="preprocessor">    # This erases any sticky fields if the user saves changes, resets the form, or reorders problems</span>
<a name="l01497"></a>01497 <span class="preprocessor"></span><span class="preprocessor">    # It may not be obvious why this is necessary when saving changes or reordering problems</span>
<a name="l01498"></a>01498 <span class="preprocessor"></span><span class="preprocessor">    #   but when the problems are reorder the param problem.1.source_file needs to be the source</span>
<a name="l01499"></a>01499 <span class="preprocessor"></span><span class="preprocessor">    #   file of the problem that is NOW #1 and not the problem that WAS #1.</span>
<a name="l01500"></a>01500 <span class="preprocessor"></span>    unless (defined $r-&gt;param(<span class="stringliteral">&#39;refresh&#39;</span>)) {
<a name="l01501"></a>01501         
<a name="l01502"></a>01502 <span class="preprocessor">        # reset all the parameters dealing with set/problem/header information</span>
<a name="l01503"></a>01503 <span class="preprocessor"></span><span class="preprocessor">        # if the current naming scheme is changed/broken, this could reek havoc</span>
<a name="l01504"></a>01504 <span class="preprocessor"></span><span class="preprocessor">        # on all kinds of things</span>
<a name="l01505"></a>01505 <span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $param ($r-&gt;param) {
<a name="l01506"></a>01506             $r-&gt;param($param, <span class="stringliteral">&quot;&quot;</span>) <span class="keywordflow">if</span> $param =~ /^(<span class="keyword">set</span>|problem|header)\./  &amp;&amp; $param !~ /displaymode/;
<a name="l01507"></a>01507         }
<a name="l01508"></a>01508     }
<a name="l01509"></a>01509 }
<a name="l01510"></a>01510 
<a name="l01511"></a>01511 <span class="preprocessor"># helper method for debugging</span>
<a name="l01512"></a>01512 <span class="preprocessor"></span>sub definedness ($) {
<a name="l01513"></a>01513     my ($variable) = @_;
<a name="l01514"></a>01514 
<a name="l01515"></a>01515     <span class="keywordflow">return</span> <span class="stringliteral">&quot;undefined&quot;</span> unless defined $variable;
<a name="l01516"></a>01516     <span class="keywordflow">return</span> <span class="stringliteral">&quot;empty&quot;</span> unless $variable ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l01517"></a>01517     <span class="keywordflow">return</span> $variable;
<a name="l01518"></a>01518 }
<a name="l01519"></a>01519 
<a name="l01520"></a>01520 <span class="preprocessor"># helper method for checking if two things are different</span>
<a name="l01521"></a>01521 <span class="preprocessor"></span><span class="preprocessor"># the return values will usually be thrown away, but they could be useful for debugging</span>
<a name="l01522"></a>01522 <span class="preprocessor"></span>sub changed ($$) {
<a name="l01523"></a>01523     my ($first, $second) = @_;
<a name="l01524"></a>01524 
<a name="l01525"></a>01525     <span class="keywordflow">return</span> <span class="stringliteral">&quot;def/undef&quot;</span> <span class="keywordflow">if</span> defined $first and not defined $second;
<a name="l01526"></a>01526     <span class="keywordflow">return</span> <span class="stringliteral">&quot;undef/def&quot;</span> <span class="keywordflow">if</span> not defined $first and defined $second;
<a name="l01527"></a>01527     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> not defined $first and not defined $second;
<a name="l01528"></a>01528     <span class="keywordflow">return</span> <span class="stringliteral">&quot;ne&quot;</span> <span class="keywordflow">if</span> $first ne $second;
<a name="l01529"></a>01529     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;  # <span class="keywordflow">if</span> they<span class="stringliteral">&#39;re equal, there&#39;</span>s no change
<a name="l01530"></a>01530 }
<a name="l01531"></a>01531 
<a name="l01532"></a>01532 <span class="preprocessor"># helper method that determines for how many users at a time a field can be changed</span>
<a name="l01533"></a>01533 <span class="preprocessor"></span><span class="preprocessor">#   none means it can&#39;t be changed for anyone</span>
<a name="l01534"></a>01534 <span class="preprocessor"></span><span class="preprocessor">#   any means it can be changed for anyone</span>
<a name="l01535"></a>01535 <span class="preprocessor"></span><span class="preprocessor">#   one means it can ONLY be changed for one at a time. (eg problem_seed)</span>
<a name="l01536"></a>01536 <span class="preprocessor"></span><span class="preprocessor">#   all means it can ONLY be changed for all at a time. (eg set_header)</span>
<a name="l01537"></a>01537 <span class="preprocessor"></span>sub canChange ($$) {
<a name="l01538"></a>01538     my ($forUsers, $field) = @_;
<a name="l01539"></a>01539     
<a name="l01540"></a>01540     my %properties = %{ FIELD_PROPERTIES() };
<a name="l01541"></a>01541     my $forOneUser = $forUsers == 1;
<a name="l01542"></a>01542     
<a name="l01543"></a>01543     my $howManyCan = $properties{$field}-&gt;{<span class="keyword">override</span>};
<a name="l01544"></a>01544     <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> $howManyCan eq <span class="stringliteral">&quot;none&quot;</span>;
<a name="l01545"></a>01545     <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> $howManyCan eq <span class="stringliteral">&quot;any&quot;</span>;   
<a name="l01546"></a>01546     <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> $howManyCan eq <span class="stringliteral">&quot;one&quot;</span> &amp;&amp; $forOneUser;
<a name="l01547"></a>01547     <span class="keywordflow">return</span> 1 <span class="keywordflow">if</span> $howManyCan eq <span class="stringliteral">&quot;all&quot;</span> &amp;&amp; !$forUsers;
<a name="l01548"></a>01548     <span class="keywordflow">return</span> 0;   # FIXME: maybe it should <span class="keywordflow">default</span> to 1?
<a name="l01549"></a>01549 }
<a name="l01550"></a>01550 
<a name="l01551"></a>01551 <span class="preprocessor"># helper method that determines if a file is valid and returns a pretty error message</span>
<a name="l01552"></a>01552 <span class="preprocessor"></span>sub checkFile ($) {
<a name="l01553"></a>01553     my ($self, $filePath, $headerType) = @_;
<a name="l01554"></a>01554 
<a name="l01555"></a>01555     my $r = $self-&gt;r;
<a name="l01556"></a>01556     my $ce = $r-&gt;ce;
<a name="l01557"></a>01557 
<a name="l01558"></a>01558     <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;No source filePath specified&quot;</span>) unless $filePath;
<a name="l01559"></a>01559     <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;Problem source is drawn from a grouping set&quot;</span>) <span class="keywordflow">if</span> $filePath =~ /^group/;
<a name="l01560"></a>01560     
<a name="l01561"></a>01561     <span class="keywordflow">if</span> ( $filePath eq <span class="stringliteral">&quot;defaultHeader&quot;</span> ) {
<a name="l01562"></a>01562         <span class="keywordflow">if</span> ($headerType eq <span class="stringliteral">&#39;set_header&#39;</span>) {
<a name="l01563"></a>01563           $filePath = $ce-&gt;{webworkFiles}{screenSnippets}{setHeader};
<a name="l01564"></a>01564         } elsif  ($headerType eq <span class="stringliteral">&#39;hardcopy_header&#39;</span>) {
<a name="l01565"></a>01565             $filePath = $ce-&gt;{webworkFiles}{hardcopySnippets}{setHeader};
<a name="l01566"></a>01566         }   <span class="keywordflow">else</span>    {
<a name="l01567"></a>01567             <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;Invalid headerType [_1]&quot;</span>, $headerType);    
<a name="l01568"></a>01568         }   
<a name="l01569"></a>01569     } <span class="keywordflow">else</span> {
<a name="l01570"></a>01570 <span class="preprocessor">    #   $filePath = $ce-&gt;{courseDirs}-&gt;{templates} . &#39;/&#39; . $filePath unless $filePath =~ m|^/|; # bug: 1725 allows access to all files e.g. /etc/passwd</span>
<a name="l01571"></a>01571 <span class="preprocessor"></span>        $filePath = $ce-&gt;{courseDirs}-&gt;{templates} . <span class="charliteral">&#39;/&#39;</span> . $filePath ; # only filePaths in <span class="keyword">template</span> directory can be accessed 
<a name="l01572"></a>01572     }
<a name="l01573"></a>01573     
<a name="l01574"></a>01574     my $fileError;
<a name="l01575"></a>01575     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span> -e $filePath &amp;&amp; -f $filePath &amp;&amp; -r $filePath;
<a name="l01576"></a>01576     <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;This source file is not readable!&quot;</span>) <span class="keywordflow">if</span> -e $filePath &amp;&amp; -f $filePath;
<a name="l01577"></a>01577     <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;This source file is a directory!&quot;</span>) <span class="keywordflow">if</span> -d $filePath;
<a name="l01578"></a>01578     <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;This source file does not exist!&quot;</span>) unless -e $filePath;
<a name="l01579"></a>01579     <span class="keywordflow">return</span> $r-&gt;maketext(<span class="stringliteral">&quot;This source file is not a plain file!&quot;</span>);
<a name="l01580"></a>01580 }
<a name="l01581"></a>01581 
<a name="l01582"></a>01582 <span class="preprocessor"># don&#39;t show view options -- we provide display mode controls for headers/problems separately</span>
<a name="l01583"></a>01583 <span class="preprocessor"></span>sub options {
<a name="l01584"></a>01584     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01585"></a>01585 }
<a name="l01586"></a>01586 
<a name="l01587"></a>01587 <span class="preprocessor"># Creates two separate tables, first of the headers, and the of the problems in a given set</span>
<a name="l01588"></a>01588 <span class="preprocessor"></span><span class="preprocessor"># If one or more users are specified in the &quot;editForUser&quot; param, only the data for those users</span>
<a name="l01589"></a>01589 <span class="preprocessor"></span><span class="preprocessor"># becomes editable, not all the data</span>
<a name="l01590"></a>01590 <span class="preprocessor"></span>sub body {
<a name="l01591"></a>01591 
<a name="l01592"></a>01592     my ($self)      = @_;
<a name="l01593"></a>01593     my $r           = $self-&gt;r;
<a name="l01594"></a>01594     my $db          = $r-&gt;db;
<a name="l01595"></a>01595     my $ce          = $r-&gt;ce;
<a name="l01596"></a>01596     my $authz       = $r-&gt;authz;
<a name="l01597"></a>01597     my $userID      = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l01598"></a>01598     my $urlpath     = $r-&gt;urlpath;
<a name="l01599"></a>01599     my $courseID    = $urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l01600"></a>01600     my $setID       = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l01601"></a>01601 
<a name="l01602"></a>01602 <span class="preprocessor">    ## we&#39;re now allowing setID to come in as setID,v# to edit a set</span>
<a name="l01603"></a>01603 <span class="preprocessor"></span><span class="preprocessor">    ##    version; catch this first</span>
<a name="l01604"></a>01604 <span class="preprocessor"></span>    my $editingSetVersion = 0;
<a name="l01605"></a>01605     my $fullSetID = $setID;
<a name="l01606"></a>01606     <span class="keywordflow">if</span> ( $setID =~ /,v(\d+)$/ ) {
<a name="l01607"></a>01607         $editingSetVersion = $1;
<a name="l01608"></a>01608         $setID =~ s/,v(\d+)$<span class="comment">//;</span>
<a name="l01609"></a>01609     }
<a name="l01610"></a>01610 
<a name="l01611"></a>01611     my $setRecord   = $db-&gt;getGlobalSet($setID) or die $r-&gt;maketext(<span class="stringliteral">&quot;No record for global set [_1].&quot;</span>, $setID);
<a name="l01612"></a>01612 
<a name="l01613"></a>01613     my $userRecord = $db-&gt;getUser($userID) or die $r-&gt;maketext(<span class="stringliteral">&quot;No record for user [_1].&quot;</span>, $userID);
<a name="l01614"></a>01614 <span class="preprocessor">    # Check permissions</span>
<a name="l01615"></a>01615 <span class="preprocessor"></span>    <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;You are not authorized to access the Instructor tools.&quot;</span>))
<a name="l01616"></a>01616         unless $authz-&gt;hasPermissions($userRecord-&gt;user_id, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>);
<a name="l01617"></a>01617     
<a name="l01618"></a>01618     <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;You are not authorized to modify problems.&quot;</span>))
<a name="l01619"></a>01619         unless $authz-&gt;hasPermissions($userRecord-&gt;user_id, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>);
<a name="l01620"></a>01620 
<a name="l01621"></a>01621     my @editForUser = $r-&gt;param(<span class="stringliteral">&#39;editForUser&#39;</span>);
<a name="l01622"></a>01622 
<a name="l01623"></a>01623     <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Versions of a set can only be edited for one user at a time.&quot;</span>)) <span class="keywordflow">if</span> ( $editingSetVersion &amp;&amp; @editForUser != 1 );
<a name="l01624"></a>01624 
<a name="l01625"></a>01625 <span class="preprocessor">    # Check that every user that we&#39;re editing for has a valid UserSet</span>
<a name="l01626"></a>01626 <span class="preprocessor"></span>    my @assignedUsers;
<a name="l01627"></a>01627     my @unassignedUsers;
<a name="l01628"></a>01628     <span class="keywordflow">if</span> (scalar @editForUser) {
<a name="l01629"></a>01629         <span class="keywordflow">foreach</span> my $ID (@editForUser) {
<a name="l01630"></a>01630 <span class="preprocessor">            # DBFIXME iterator</span>
<a name="l01631"></a>01631 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ($db-&gt;getUserSet($ID, $setID)) {
<a name="l01632"></a>01632                 unshift @assignedUsers, $ID;
<a name="l01633"></a>01633             } <span class="keywordflow">else</span> {
<a name="l01634"></a>01634                 unshift @unassignedUsers, $ID;
<a name="l01635"></a>01635             }
<a name="l01636"></a>01636         }
<a name="l01637"></a>01637         @editForUser = sort @assignedUsers;
<a name="l01638"></a>01638         $r-&gt;param(<span class="stringliteral">&quot;editForUser&quot;</span>, \@editForUser);
<a name="l01639"></a>01639         
<a name="l01640"></a>01640         <span class="keywordflow">if</span> (scalar @editForUser &amp;&amp; scalar @unassignedUsers) {
<a name="l01641"></a>01641             print CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;The following users are NOT assigned to this set and will be ignored: [_1]&quot;</span>, CGI::b(join(<span class="stringliteral">&quot;, &quot;</span>, @unassignedUsers))) );
<a name="l01642"></a>01642         } elsif (scalar @editForUser == 0) {
<a name="l01643"></a>01643             print CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;None of the selected users are assigned to this set: [_1]&quot;</span>, CGI::b(join(<span class="stringliteral">&quot;, &quot;</span>, @unassignedUsers))));
<a name="l01644"></a>01644             print CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Global set data will be shown instead of user specific data&quot;</span>));
<a name="l01645"></a>01645         }       
<a name="l01646"></a>01646     }
<a name="l01647"></a>01647 
<a name="l01648"></a>01648 <span class="preprocessor">    # some useful booleans</span>
<a name="l01649"></a>01649 <span class="preprocessor"></span>    my $forUsers    = scalar(@editForUser);
<a name="l01650"></a>01650     my $forOneUser  = $forUsers == 1;
<a name="l01651"></a>01651 
<a name="l01652"></a>01652 <span class="preprocessor">    # and check that if we&#39;re editing a set version for a user, that</span>
<a name="l01653"></a>01653 <span class="preprocessor"></span><span class="preprocessor">    #    it exists as well</span>
<a name="l01654"></a>01654 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $editingSetVersion &amp;&amp; ! $db-&gt;existsSetVersion( $editForUser[0], $setID, $editingSetVersion ) ) {
<a name="l01655"></a>01655         <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;The set-version ([_1], version [_2]) is not assigned to user [_3].&quot;</span>, $setID, $editingSetVersion, $editForUser[0]));
<a name="l01656"></a>01656     }
<a name="l01657"></a>01657 
<a name="l01658"></a>01658 <span class="preprocessor">    # If you&#39;re editing for users, initially their records will be different but</span>
<a name="l01659"></a>01659 <span class="preprocessor"></span><span class="preprocessor">    # if you make any changes to them they will be the same.</span>
<a name="l01660"></a>01660 <span class="preprocessor"></span><span class="preprocessor">    # if you&#39;re editing for one user, the problems shown should be his/hers</span>
<a name="l01661"></a>01661 <span class="preprocessor"></span>    my $userToShow        = $forUsers ? $editForUser[0] : $userID;
<a name="l01662"></a>01662 
<a name="l01663"></a>01663 <span class="preprocessor">    # a useful gateway variable</span>
<a name="l01664"></a>01664 <span class="preprocessor"></span>    my $isGatewaySet = ( $setRecord-&gt;assignment_type =~ /gateway/ ) ? 1 : 0;
<a name="l01665"></a>01665     
<a name="l01666"></a>01666 <span class="preprocessor">    # DBFIXME no need to get ID lists -- counts would be fine</span>
<a name="l01667"></a>01667 <span class="preprocessor"></span>    my $userCount        = $db-&gt;listUsers();
<a name="l01668"></a>01668     my $setCount         = $db-&gt;listGlobalSets(); # <span class="keywordflow">if</span> $forOneUser;
<a name="l01669"></a>01669     my $setUserCount     = $db-&gt;countSetUsers($setID);
<a name="l01670"></a>01670 <span class="preprocessor"># if $forOneUser;</span>
<a name="l01671"></a>01671 <span class="preprocessor"></span>    my $userSetCount     = ($forOneUser &amp;&amp; @editForUser) ? $db-&gt;countUserSets($editForUser[0]) : 0;
<a name="l01672"></a>01672 
<a name="l01673"></a>01673     
<a name="l01674"></a>01674     my $editUsersAssignedToSetURL = $self-&gt;systemLink(
<a name="l01675"></a>01675           $urlpath-&gt;newFromModule(
<a name="l01676"></a>01676                 <span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::UsersAssignedToSet&quot;</span>, $r,
<a name="l01677"></a>01677                   courseID =&gt; $courseID, setID =&gt; $setID));
<a name="l01678"></a>01678     my $editSetsAssignedToUserURL = $self-&gt;systemLink(
<a name="l01679"></a>01679           $urlpath-&gt;newFromModule(
<a name="l01680"></a>01680                 <span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::UserDetail&quot;</span>,$r,
<a name="l01681"></a>01681                   courseID =&gt; $courseID, userID =&gt; $editForUser[0])) <span class="keywordflow">if</span> $forOneUser;
<a name="l01682"></a>01682 
<a name="l01683"></a>01683 
<a name="l01684"></a>01684     my $setDetailPage  = $urlpath -&gt; newFromModule($urlpath-&gt;module, $r, courseID =&gt; $courseID, setID =&gt; $setID);
<a name="l01685"></a>01685     my $fullsetDetailPage  = $urlpath -&gt; newFromModule($urlpath-&gt;module, $r, courseID =&gt; $courseID, setID =&gt; $fullSetID);
<a name="l01686"></a>01686     my $setDetailURL   = $self-&gt;systemLink($fullsetDetailPage, authen=&gt;0);
<a name="l01687"></a>01687 
<a name="l01688"></a>01688     my $userCountMessage = CGI::a({href=&gt;$editUsersAssignedToSetURL}, $self-&gt;userCountMessage($setUserCount, $userCount));
<a name="l01689"></a>01689     my $setCountMessage = CGI::a({href=&gt;$editSetsAssignedToUserURL}, $self-&gt;setCountMessage($userSetCount, $setCount)) <span class="keywordflow">if</span> $forOneUser;
<a name="l01690"></a>01690 
<a name="l01691"></a>01691     $userCountMessage = $r-&gt;maketext(<span class="stringliteral">&quot;The set [_1] is assigned to [_2].&quot;</span>, $setID, $userCountMessage);
<a name="l01692"></a>01692     $setCountMessage  = $r-&gt;maketext(<span class="stringliteral">&quot;The user [_1] has been assigned [_2].&quot;</span>, $editForUser[0], $setCountMessage) <span class="keywordflow">if</span> $forOneUser;
<a name="l01693"></a>01693 
<a name="l01694"></a>01694     <span class="keywordflow">if</span> ($forUsers) {
<a name="l01695"></a>01695 <span class="preprocessor">        ##############################################</span>
<a name="l01696"></a>01696 <span class="preprocessor"></span><span class="preprocessor">        # calculate links for the users being edited:</span>
<a name="l01697"></a>01697 <span class="preprocessor"></span><span class="preprocessor">        ##############################################</span>
<a name="l01698"></a>01698 <span class="preprocessor"></span>        my @userLinks = ();
<a name="l01699"></a>01699         <span class="keywordflow">foreach</span> my $userID (@editForUser) {
<a name="l01700"></a>01700             my $u = $db-&gt;getUser($userID);
<a name="l01701"></a>01701             my $email_address = $u-&gt;email_address;
<a name="l01702"></a>01702             my $line = $u-&gt;last_name.<span class="stringliteral">&quot;, &quot;</span> . $u-&gt;first_name . <span class="stringliteral">&quot;&amp;nbsp;&amp;nbsp;(&quot;</span> .
<a name="l01703"></a>01703                 CGI::a({-href=&gt;<span class="stringliteral">&quot;mailto:$email_address&quot;</span>},<span class="stringliteral">&quot;email &quot;</span>). $u-&gt;user_id .
<a name="l01704"></a>01704                 <span class="stringliteral">&quot;). &quot;</span>;
<a name="l01705"></a>01705             if ( ! $editingSetVersion ) {
<a name="l01706"></a>01706                 $line .= $r-&gt;maketext(<span class="stringliteral">&quot;Assigned to &quot;</span>);
<a name="l01707"></a>01707                 my $editSetsAssignedToUserURL = $self-&gt;systemLink(
<a name="l01708"></a>01708                     $urlpath-&gt;newFromModule(
<a name="l01709"></a>01709                         <span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::UserDetail&quot;</span>, $r,
<a name="l01710"></a>01710                                 courseID =&gt; $courseID, userID =&gt; $u-&gt;user_id));
<a name="l01711"></a>01711                         $line .= CGI::a({href=&gt;$editSetsAssignedToUserURL}, 
<a name="l01712"></a>01712                                 $self-&gt;setCountMessage($db-&gt;countUserSets($u-&gt;user_id), 
<a name="l01713"></a>01713                         $setCount));
<a name="l01714"></a>01714             } <span class="keywordflow">else</span> {
<a name="l01715"></a>01715                 my $editSetLink = $self-&gt;systemLink( $setDetailPage,
<a name="l01716"></a>01716                     params=&gt;{effectiveUser=&gt;$u-&gt;user_id,
<a name="l01717"></a>01717                          editForUser  =&gt;$u-&gt;user_id} );
<a name="l01718"></a>01718                 $line .= $r-&gt;maketext(<span class="stringliteral">&quot;Edit set [_1] for this user.&quot;</span>, CGI::a({href=&gt;$editSetLink},$setID));
<a name="l01719"></a>01719             }
<a name="l01720"></a>01720             unshift @userLinks,$line;
<a name="l01721"></a>01721         }
<a name="l01722"></a>01722         @userLinks = sort @userLinks;
<a name="l01723"></a>01723     
<a name="l01724"></a>01724 <span class="preprocessor">        # handy messages when editing gateway sets</span>
<a name="l01725"></a>01725 <span class="preprocessor"></span>        my $gwmsg = ( $isGatewaySet &amp;&amp; ! $editingSetVersion ) ?
<a name="l01726"></a>01726             CGI::br() . CGI::em($r-&gt;maketext(<span class="stringliteral">&quot;To edit a specific student version of this set, edit (all of) her/his assigned sets.&quot;</span>)) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l01727"></a>01727         my $vermsg = ( $editingSetVersion ) ? <span class="stringliteral">&quot;, $editingSetVersion&quot;</span> : <span class="stringliteral">&quot;&quot;</span>;
<a name="l01728"></a>01728 
<a name="l01729"></a>01729         print CGI::table({border=&gt;2,cellpadding=&gt;10}, 
<a name="l01730"></a>01730             CGI::Tr({},
<a name="l01731"></a>01731                 CGI::td([
<a name="l01732"></a>01732                      $r-&gt;maketext(<span class="stringliteral">&quot;Editing problem set [_1] data for these individual students: [_2]&quot;</span>, CGI::strong($setID . $vermsg), CGI::br().CGI::strong(join CGI::br(), @userLinks)),
<a name="l01733"></a>01733                     CGI::a({href=&gt;$self-&gt;systemLink($setDetailPage) },$r-&gt;maketext(<span class="stringliteral">&quot;Edit set [_1] data for ALL students assigned to this set.&quot;</span>, CGI::strong($setID))) . $gwmsg,
<a name="l01734"></a>01734                 
<a name="l01735"></a>01735                 ])
<a name="l01736"></a>01736             )
<a name="l01737"></a>01737         );
<a name="l01738"></a>01738     } <span class="keywordflow">else</span> {
<a name="l01739"></a>01739         print CGI::table({border=&gt;2,cellpadding=&gt;10}, 
<a name="l01740"></a>01740             CGI::Tr({},
<a name="l01741"></a>01741                 CGI::td([
<a name="l01742"></a>01742                     $r-&gt;maketext(<span class="stringliteral">&quot;This set [_1] is assigned to [_2].&quot;</span>, CGI::strong($setID), $self-&gt;userCountMessage($setUserCount, $userCount)) ,
<a name="l01743"></a>01743                     $r-&gt;maketext(<span class="stringliteral">&quot;Edit [_1] of set [_2].&quot;</span>, CGI::a({href=&gt;$editUsersAssignedToSetURL},$r-&gt;maketext(<span class="stringliteral">&#39;individual versions&#39;</span>)), $setID),
<a name="l01744"></a>01744                 
<a name="l01745"></a>01745                 ])
<a name="l01746"></a>01746             )
<a name="l01747"></a>01747         );
<a name="l01748"></a>01748     }
<a name="l01749"></a>01749     
<a name="l01750"></a>01750 <span class="preprocessor">    # handle renumbering of problems if necessary</span>
<a name="l01751"></a>01751 <span class="preprocessor"></span>    print CGI::a({name=&gt;<span class="stringliteral">&quot;problems&quot;</span>});
<a name="l01752"></a>01752 
<a name="l01753"></a>01753     my %newProblemNumbers = ();
<a name="l01754"></a>01754     my $maxProblemNumber = -1;
<a name="l01755"></a>01755     <span class="keywordflow">for</span> my $jj (sort { $a &lt;=&gt; $b } $db-&gt;listGlobalProblems($setID)) {
<a name="l01756"></a>01756         $newProblemNumbers{$jj} = $r-&gt;param(<span class="stringliteral">&#39;problem_num_&#39;</span> . $jj);
<a name="l01757"></a>01757         $maxProblemNumber = $jj <span class="keywordflow">if</span> $jj &gt; $maxProblemNumber;
<a name="l01758"></a>01758     }
<a name="l01759"></a>01759 
<a name="l01760"></a>01760     my $forceRenumber = $r-&gt;param(<span class="stringliteral">&#39;force_renumber&#39;</span>) || 0;
<a name="l01761"></a>01761     handle_problem_numbers($self,\%newProblemNumbers, $maxProblemNumber, $db, $setID, $forceRenumber) unless defined $r-&gt;param(&#39;undo_changes&#39;);
<a name="l01762"></a>01762 
<a name="l01763"></a>01763     my %properties = %{ FIELD_PROPERTIES() };
<a name="l01764"></a>01764 
<a name="l01765"></a>01765     my %display_modes = %{WeBWorK::PG::DISPLAY_MODES()};
<a name="l01766"></a>01766     my @active_modes = grep { exists $display_modes{$_} } @{$r-&gt;ce-&gt;{pg}-&gt;{displayModes}};
<a name="l01767"></a>01767     push @active_modes, $r-&gt;maketext(<span class="stringliteral">&#39;None&#39;</span>);
<a name="l01768"></a>01768     my $default_header_mode = $r-&gt;param(<span class="stringliteral">&#39;header.displaymode&#39;</span>) || $r-&gt;maketext(<span class="stringliteral">&#39;None&#39;</span>);
<a name="l01769"></a>01769     my $default_problem_mode = $r-&gt;param(<span class="stringliteral">&#39;problem.displaymode&#39;</span>) || $r-&gt;maketext(<span class="stringliteral">&#39;None&#39;</span>);
<a name="l01770"></a>01770 
<a name="l01771"></a>01771 <span class="preprocessor">    #####################################################################</span>
<a name="l01772"></a>01772 <span class="preprocessor"></span><span class="preprocessor">    # Browse available header/problem files</span>
<a name="l01773"></a>01773 <span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<a name="l01774"></a>01774 <span class="preprocessor"></span>    
<a name="l01775"></a>01775     my $templates = $r-&gt;ce-&gt;{courseDirs}-&gt;{templates};
<a name="l01776"></a>01776     my $skip = join(<span class="stringliteral">&quot;|&quot;</span>, keys %{ $r-&gt;ce-&gt;{courseFiles}-&gt;{problibs} });
<a name="l01777"></a>01777 
<a name="l01778"></a>01778     my @headerFileList = listFilesRecursive(
<a name="l01779"></a>01779         $templates,
<a name="l01780"></a>01780         qr/header.*\.pg$/i,         # match these files
<a name="l01781"></a>01781         qr/^(?:$skip|svn)$/,    # prune these directories
<a name="l01782"></a>01782         0,              # match against file name only
<a name="l01783"></a>01783         1,              # prune against path relative to $templates
<a name="l01784"></a>01784     );
<a name="l01785"></a>01785   @headerFileList = sortByName(undef,@headerFileList);
<a name="l01786"></a>01786  
<a name="l01787"></a>01787 <span class="preprocessor">    # Display a useful warning message</span>
<a name="l01788"></a>01788 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($forUsers) {
<a name="l01789"></a>01789         print CGI::p(CGI::b($r-&gt;maketext(<span class="stringliteral">&quot;Any changes made below will be reflected in the set for ONLY the student(s) listed above.&quot;</span>)));
<a name="l01790"></a>01790     } <span class="keywordflow">else</span> {
<a name="l01791"></a>01791         print CGI::p(CGI::b($r-&gt;maketext(<span class="stringliteral">&quot;Any changes made below will be reflected in the set for ALL students.&quot;</span>)));
<a name="l01792"></a>01792     }
<a name="l01793"></a>01793 
<a name="l01794"></a>01794     print CGI::start_form({method=&gt;<span class="stringliteral">&quot;POST&quot;</span>, action=&gt;$setDetailURL});
<a name="l01795"></a>01795     print $self-&gt;hiddenEditForUserFields(@editForUser);
<a name="l01796"></a>01796     print $self-&gt;hidden_authen_fields;
<a name="l01797"></a>01797     print CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, name=&gt;<span class="stringliteral">&quot;submit_changes&quot;</span>, value=&gt;$r-&gt;maketext(<span class="stringliteral">&quot;Save Changes&quot;</span>)});
<a name="l01798"></a>01798     print CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, name=&gt;<span class="stringliteral">&quot;undo_changes&quot;</span>, value =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Reset Form&quot;</span>)});
<a name="l01799"></a>01799 
<a name="l01800"></a>01800 <span class="preprocessor">    # spacing</span>
<a name="l01801"></a>01801 <span class="preprocessor"></span>    print CGI::p();
<a name="l01802"></a>01802     
<a name="l01803"></a>01803 <span class="preprocessor">    #####################################################################</span>
<a name="l01804"></a>01804 <span class="preprocessor"></span><span class="preprocessor">    # Display general set information</span>
<a name="l01805"></a>01805 <span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<a name="l01806"></a>01806 <span class="preprocessor"></span>
<a name="l01807"></a>01807     print CGI::start_table({border=&gt;1, cellpadding=&gt;4});
<a name="l01808"></a>01808     print CGI::Tr({}, CGI::th({}, [
<a name="l01809"></a>01809         $r-&gt;maketext(<span class="stringliteral">&quot;General Information&quot;</span>),
<a name="l01810"></a>01810     ]));
<a name="l01811"></a>01811     
<a name="l01812"></a>01812 <span class="preprocessor">    # this is kind of a hack -- we need to get a user record here, so we can</span>
<a name="l01813"></a>01813 <span class="preprocessor"></span><span class="preprocessor">    # pass it to FieldTable, so FieldTable can pass it to FieldHTML, so</span>
<a name="l01814"></a>01814 <span class="preprocessor"></span><span class="preprocessor">    # FieldHTML doesn&#39;t have to fetch it itself.</span>
<a name="l01815"></a>01815 <span class="preprocessor"></span>    my $userSetRecord = $db-&gt;getUserSet($userToShow, $setID);
<a name="l01816"></a>01816 
<a name="l01817"></a>01817     my $templateUserSetRecord;
<a name="l01818"></a>01818 <span class="preprocessor">    # send in the set version if we&#39;re editing for versions</span>
<a name="l01819"></a>01819 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $editingSetVersion ) {
<a name="l01820"></a>01820         $templateUserSetRecord = $userSetRecord;
<a name="l01821"></a>01821         $userSetRecord = $db-&gt;getSetVersion( $userToShow, $setID, $editingSetVersion );
<a name="l01822"></a>01822     }
<a name="l01823"></a>01823     
<a name="l01824"></a>01824     print CGI::Tr({}, CGI::td({}, [
<a name="l01825"></a>01825         $self-&gt;FieldTable($userToShow, $setID, undef, $setRecord, $userSetRecord),
<a name="l01826"></a>01826     ]));
<a name="l01827"></a>01827     print CGI::end_table(); 
<a name="l01828"></a>01828 
<a name="l01829"></a>01829 <span class="preprocessor">    # spacing</span>
<a name="l01830"></a>01830 <span class="preprocessor"></span>    print CGI::p();
<a name="l01831"></a>01831 
<a name="l01832"></a>01832     
<a name="l01833"></a>01833 <span class="preprocessor">    #####################################################################</span>
<a name="l01834"></a>01834 <span class="preprocessor"></span><span class="preprocessor">    # Display header information</span>
<a name="l01835"></a>01835 <span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<a name="l01836"></a>01836 <span class="preprocessor"></span>    my @headers = @{ HEADER_ORDER() };
<a name="l01837"></a>01837     my %headerModules = (set_header =&gt; <span class="stringliteral">&#39;problem_list&#39;</span>, hardcopy_header =&gt; <span class="stringliteral">&#39;hardcopy_preselect_set&#39;</span>);
<a name="l01838"></a>01838     my %headerDefaults = (set_header =&gt; $ce-&gt;{webworkFiles}-&gt;{screenSnippets}-&gt;{setHeader}, hardcopy_header =&gt; $ce-&gt;{webworkFiles}-&gt;{hardcopySnippets}-&gt;{setHeader});
<a name="l01839"></a>01839     my @headerFiles = map { $setRecord-&gt;{$_} } @headers;
<a name="l01840"></a>01840     <span class="keywordflow">if</span> (scalar @headers and not $forUsers) {
<a name="l01841"></a>01841 
<a name="l01842"></a>01842         print CGI::start_table({border=&gt;1, cellpadding=&gt;4});
<a name="l01843"></a>01843         print CGI::Tr({}, CGI::th({}, [
<a name="l01844"></a>01844             $r-&gt;maketext(<span class="stringliteral">&quot;Headers&quot;</span>),
<a name="l01845"></a>01845 <span class="preprocessor">#           &quot;Data&quot;,</span>
<a name="l01846"></a>01846 <span class="preprocessor"></span>            <span class="stringliteral">&quot;Display&amp;nbsp;Mode:&amp;nbsp;&quot;</span> . 
<a name="l01847"></a>01847             CGI::popup_menu(-name =&gt; <span class="stringliteral">&quot;header.displaymode&quot;</span>, -values =&gt; \@active_modes, -<span class="keywordflow">default</span> =&gt; $default_header_mode) . <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>. 
<a name="l01848"></a>01848             CGI::input({type =&gt; <span class="stringliteral">&quot;submit&quot;</span>, name =&gt; <span class="stringliteral">&quot;refresh&quot;</span>, value =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Refresh Display&quot;</span>)}),
<a name="l01849"></a>01849         ]));
<a name="l01850"></a>01850 
<a name="l01851"></a>01851         my %header_html;
<a name="l01852"></a>01852         
<a name="l01853"></a>01853         my %error;
<a name="l01854"></a>01854         my $this_set = $db-&gt;getMergedSet($userToShow, $setID);
<a name="l01855"></a>01855         my $guaranteed_set = $this_set;
<a name="l01856"></a>01856         <span class="keywordflow">if</span> ( ! $guaranteed_set ) { 
<a name="l01857"></a>01857 <span class="preprocessor">            # in the header loop we need to have a set that </span>
<a name="l01858"></a>01858 <span class="preprocessor"></span><span class="preprocessor">            #    we know exists, so if the getMergedSet failed</span>
<a name="l01859"></a>01859 <span class="preprocessor"></span><span class="preprocessor">            #    (that is, the set isn&#39;t assigned to the </span>
<a name="l01860"></a>01860 <span class="preprocessor"></span><span class="preprocessor">            #    the current user), we get the global set instead</span>
<a name="l01861"></a>01861 <span class="preprocessor"></span><span class="preprocessor">            # $guaranteed_set = $db-&gt;getGlobalSet( $setID );</span>
<a name="l01862"></a>01862 <span class="preprocessor"></span>            $guaranteed_set = $setRecord;
<a name="l01863"></a>01863         }
<a name="l01864"></a>01864 
<a name="l01865"></a>01865         <span class="keywordflow">foreach</span> my $headerType (@headers) {
<a name="l01866"></a>01866 
<a name="l01867"></a>01867             my $headerFile = $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$headerType&quot;</span>) || $setRecord-&gt;{$headerType};
<a name="l01868"></a>01868 
<a name="l01869"></a>01869             $headerFile = <span class="stringliteral">&#39;defaultHeader&#39;</span> unless $headerFile =~/\S/; # (some non-white space character required)
<a name="l01870"></a>01870 
<a name="l01871"></a>01871             $error{$headerType} = $self-&gt;checkFile($headerFile,$headerType);
<a name="l01872"></a>01872 
<a name="l01873"></a>01873             unless ($error{$headerType}) {      
<a name="l01874"></a>01874                 my @temp = renderProblems(
<a name="l01875"></a>01875                     r=&gt; $r, 
<a name="l01876"></a>01876                     user =&gt; $db-&gt;getUser($userToShow),
<a name="l01877"></a>01877                     displayMode=&gt; $default_header_mode,
<a name="l01878"></a>01878                     problem_number=&gt; 0,
<a name="l01879"></a>01879                     this_set =&gt; $this_set,
<a name="l01880"></a>01880                     problem_list =&gt; [$headerFile],
<a name="l01881"></a>01881                 );
<a name="l01882"></a>01882                 $header_html{$headerType} = $temp[0];   
<a name="l01883"></a>01883             }
<a name="l01884"></a>01884         }
<a name="l01885"></a>01885         
<a name="l01886"></a>01886         <span class="keywordflow">foreach</span> my $headerType (@headers) {
<a name="l01887"></a>01887     
<a name="l01888"></a>01888             my $editHeaderPage = $urlpath-&gt;new(type =&gt; <span class="stringliteral">&#39;instructor_problem_editor_withset_withproblem&#39;</span>, args =&gt; { courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt; 0 });
<a name="l01889"></a>01889             my $editHeaderLink = $self-&gt;systemLink($editHeaderPage, params =&gt; { file_type =&gt; $headerType, make_local_copy =&gt; 1 });
<a name="l01890"></a>01890 
<a name="l01891"></a>01891             my $viewHeaderPage = $urlpath-&gt;new(type =&gt; $headerModules{$headerType}, args =&gt; { courseID =&gt; $courseID, setID =&gt; $setID });    
<a name="l01892"></a>01892             my $viewHeaderLink = $self-&gt;systemLink($viewHeaderPage);
<a name="l01893"></a>01893             
<a name="l01894"></a>01894 <span class="preprocessor">            # this is a bit of a hack; the set header isn&#39;t shown</span>
<a name="l01895"></a>01895 <span class="preprocessor"></span><span class="preprocessor">            #    for gateway tests, and we run into trouble trying to </span>
<a name="l01896"></a>01896 <span class="preprocessor"></span><span class="preprocessor">            #    edit/view it in this context, so we don&#39;t show this </span>
<a name="l01897"></a>01897 <span class="preprocessor"></span><span class="preprocessor">            #    field for gateway tests</span>
<a name="l01898"></a>01898 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $headerType eq <span class="stringliteral">&#39;set_header&#39;</span> &amp;&amp; 
<a name="l01899"></a>01899                      $guaranteed_set-&gt;assignment_type =~ /gateway/ ) {
<a name="l01900"></a>01900                 print CGI::Tr({}, CGI::td({}, 
<a name="l01901"></a>01901                           [ $r-&gt;maketext(<span class="stringliteral">&quot;Set Header&quot;</span>), 
<a name="l01902"></a>01902                             $r-&gt;maketext(<span class="stringliteral">&quot;Set headers are not used in display of gateway tests.&quot;</span>)]));
<a name="l01903"></a>01903                 next;
<a name="l01904"></a>01904             }
<a name="l01905"></a>01905 
<a name="l01906"></a>01906             print CGI::Tr({}, CGI::td({}, [
<a name="l01907"></a>01907                 CGI::start_table({border =&gt; 0, cellpadding =&gt; 0}) . 
<a name="l01908"></a>01908                     CGI::Tr({}, CGI::td({}, $properties{$headerType}-&gt;{name})) . 
<a name="l01909"></a>01909                     CGI::Tr({}, CGI::td({}, CGI::a({href =&gt; $editHeaderLink, target=&gt;<span class="stringliteral">&quot;WW_Editor&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Edit it&quot;</span>)))) .
<a name="l01910"></a>01910                     CGI::Tr({}, CGI::td({}, CGI::a({href =&gt; $viewHeaderLink, target=&gt;<span class="stringliteral">&quot;WW_View&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;View it&quot;</span>)))) .
<a name="l01911"></a>01911                 CGI::end_table(),
<a name="l01912"></a>01912 
<a name="l01913"></a>01913                 comboBox({
<a name="l01914"></a>01914                     name =&gt; <span class="stringliteral">&quot;set.$setID.$headerType&quot;</span>,
<a name="l01915"></a>01915                     request =&gt; $r,
<a name="l01916"></a>01916                     <span class="keywordflow">default</span> =&gt; $r-&gt;param(<span class="stringliteral">&quot;set.$setID.$headerType&quot;</span>) || $setRecord-&gt;{$headerType}  || <span class="stringliteral">&quot;defaultHeader&quot;</span>,
<a name="l01917"></a>01917                     multiple =&gt; 0,
<a name="l01918"></a>01918                     values =&gt; [<span class="stringliteral">&quot;defaultHeader&quot;</span>, @headerFileList],
<a name="l01919"></a>01919                     labels =&gt; { <span class="stringliteral">&quot;defaultHeader&quot;</span> =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Use Default Header File&quot;</span>) },
<a name="l01920"></a>01920                 }) .
<a name="l01921"></a>01921                 ($error{$headerType} ? 
<a name="l01922"></a>01922                     CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>, style=&gt;<span class="stringliteral">&quot;font-weight: bold&quot;</span>}, $error{$headerType}) 
<a name="l01923"></a>01923                     : CGI::div({<span class="keyword">class</span>=&gt; <span class="stringliteral">&quot;RenderSolo&quot;</span>}, $header_html{$headerType}-&gt;{body_text})
<a name="l01924"></a>01924                 ),
<a name="l01925"></a>01925             ]));
<a name="l01926"></a>01926         }
<a name="l01927"></a>01927         
<a name="l01928"></a>01928         print CGI::end_table();
<a name="l01929"></a>01929     } <span class="keywordflow">else</span> {
<a name="l01930"></a>01930         print CGI::p(CGI::b($r-&gt;maketext(<span class="stringliteral">&quot;Screen and Hardcopy set header information can not be overridden for individual students.&quot;</span>)));
<a name="l01931"></a>01931     }
<a name="l01932"></a>01932 
<a name="l01933"></a>01933 <span class="preprocessor">    # spacing</span>
<a name="l01934"></a>01934 <span class="preprocessor"></span>    print CGI::p();
<a name="l01935"></a>01935 
<a name="l01936"></a>01936 
<a name="l01937"></a>01937 <span class="preprocessor">    #####################################################################</span>
<a name="l01938"></a>01938 <span class="preprocessor"></span><span class="preprocessor">    # Display problem information</span>
<a name="l01939"></a>01939 <span class="preprocessor"></span><span class="preprocessor">    #####################################################################</span>
<a name="l01940"></a>01940 <span class="preprocessor"></span>
<a name="l01941"></a>01941     my @problemIDList = sort { $a &lt;=&gt; $b } $db-&gt;listGlobalProblems($setID);
<a name="l01942"></a>01942     
<a name="l01943"></a>01943 <span class="preprocessor">    # DBFIXME use iterators instead of getting all at once</span>
<a name="l01944"></a>01944 <span class="preprocessor"></span>    
<a name="l01945"></a>01945 <span class="preprocessor">    # get global problem records for all problems in one go</span>
<a name="l01946"></a>01946 <span class="preprocessor"></span>    my %GlobalProblems;
<a name="l01947"></a>01947     my @globalKeypartsRef = map { [$setID, $_] } @problemIDList;
<a name="l01948"></a>01948 <span class="preprocessor">    # DBFIXME shouldn&#39;t need to get key list here</span>
<a name="l01949"></a>01949 <span class="preprocessor"></span>    @GlobalProblems{@problemIDList} = $db-&gt;getGlobalProblems(@globalKeypartsRef);
<a name="l01950"></a>01950     
<a name="l01951"></a>01951 <span class="preprocessor">    # if needed, get user problem records for all problems in one go</span>
<a name="l01952"></a>01952 <span class="preprocessor"></span>    my (%UserProblems, %MergedProblems);
<a name="l01953"></a>01953     <span class="keywordflow">if</span> ($forOneUser) {
<a name="l01954"></a>01954         my @userKeypartsRef = map { [$editForUser[0], $setID, $_] } @problemIDList;
<a name="l01955"></a>01955 <span class="preprocessor">        # DBFIXME shouldn&#39;t need to get key list here</span>
<a name="l01956"></a>01956 <span class="preprocessor"></span>        @UserProblems{@problemIDList} = $db-&gt;getUserProblems(@userKeypartsRef);
<a name="l01957"></a>01957         <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
<a name="l01958"></a>01958             @MergedProblems{@problemIDList} = $db-&gt;getMergedProblems(@userKeypartsRef);
<a name="l01959"></a>01959         } <span class="keywordflow">else</span> {
<a name="l01960"></a>01960             my @userversionKeypartsRef = map { [$editForUser[0], $setID, $editingSetVersion, $_] } @problemIDList;
<a name="l01961"></a>01961             @MergedProblems{@problemIDList} = $db-&gt;getMergedProblemVersions(@userversionKeypartsRef);
<a name="l01962"></a>01962         }
<a name="l01963"></a>01963     }
<a name="l01964"></a>01964     
<a name="l01965"></a>01965     <span class="keywordflow">if</span> (scalar @problemIDList) {
<a name="l01966"></a>01966 
<a name="l01967"></a>01967         print CGI::start_table({border=&gt;1, cellpadding=&gt;4});
<a name="l01968"></a>01968         print CGI::Tr({}, CGI::th({}, [
<a name="l01969"></a>01969             $r-&gt;maketext(<span class="stringliteral">&quot;Problems&quot;</span>),
<a name="l01970"></a>01970             $r-&gt;maketext(<span class="stringliteral">&quot;Data&quot;</span>),
<a name="l01971"></a>01971             <span class="stringliteral">&quot;Display&amp;nbsp;Mode:&amp;nbsp;&quot;</span> . 
<a name="l01972"></a>01972             CGI::popup_menu(-name =&gt; <span class="stringliteral">&quot;problem.displaymode&quot;</span>, -values =&gt; \@active_modes, -<span class="keywordflow">default</span> =&gt; $default_problem_mode) . <span class="stringliteral">&#39;&amp;nbsp;&#39;</span>. 
<a name="l01973"></a>01973             CGI::input({type =&gt; <span class="stringliteral">&quot;submit&quot;</span>, name =&gt; <span class="stringliteral">&quot;refresh&quot;</span>, value =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Refresh Display&quot;</span>)}),
<a name="l01974"></a>01974         ]));
<a name="l01975"></a>01975         
<a name="l01976"></a>01976         my %shownYet;
<a name="l01977"></a>01977         my $repeatFile;
<a name="l01978"></a>01978 
<a name="l01979"></a>01979         <span class="keywordflow">foreach</span> my $problemID (@problemIDList) {
<a name="l01980"></a>01980         
<a name="l01981"></a>01981             my $problemRecord;
<a name="l01982"></a>01982             <span class="keywordflow">if</span> ($forOneUser) {
<a name="l01983"></a>01983 <span class="preprocessor">                #$problemRecord = $db-&gt;getMergedProblem($editForUser[0], $setID, $problemID);</span>
<a name="l01984"></a>01984 <span class="preprocessor"></span>                $problemRecord = $MergedProblems{$problemID}; # already fetched above --sam
<a name="l01985"></a>01985             } <span class="keywordflow">else</span> {
<a name="l01986"></a>01986 <span class="preprocessor">                #$problemRecord = $db-&gt;getGlobalProblem($setID, $problemID);</span>
<a name="l01987"></a>01987 <span class="preprocessor"></span>                $problemRecord = $GlobalProblems{$problemID}; # already fetched above --sam
<a name="l01988"></a>01988             }
<a name="l01989"></a>01989 
<a name="l01990"></a>01990 <span class="preprocessor">            #$self-&gt;addgoodmessage(&quot;&quot;);</span>
<a name="l01991"></a>01991 <span class="preprocessor"></span><span class="preprocessor">            #$self-&gt;addbadmessage($problemRecord-&gt;toString());</span>
<a name="l01992"></a>01992 <span class="preprocessor"></span>
<a name="l01993"></a>01993 <span class="preprocessor">            # when we&#39;re editing a set version, we want to be sure to</span>
<a name="l01994"></a>01994 <span class="preprocessor"></span><span class="preprocessor">            #    use the merged problem in the edit, because we could</span>
<a name="l01995"></a>01995 <span class="preprocessor"></span><span class="preprocessor">            #    be using problem groups (for which the problem is generated</span>
<a name="l01996"></a>01996 <span class="preprocessor"></span><span class="preprocessor">            #    and then stored in the problem version)</span>
<a name="l01997"></a>01997 <span class="preprocessor"></span>            my $problemToShow = ( $editingSetVersion ) ?
<a name="l01998"></a>01998                 $MergedProblems{$problemID} : $UserProblems{$problemID};
<a name="l01999"></a>01999 
<a name="l02000"></a>02000             my ( $editProblemPage, $editProblemLink, $viewProblemPage,
<a name="l02001"></a>02001                  $viewProblemLink );
<a name="l02002"></a>02002             <span class="keywordflow">if</span> ( $isGatewaySet ) {
<a name="l02003"></a>02003                 $editProblemPage = $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;instructor_problem_editor_withset_withproblem&#39;</span>, args =&gt; { courseID =&gt; $courseID, setID =&gt; $fullSetID, problemID =&gt; $problemID });
<a name="l02004"></a>02004                 $editProblemLink = $self-&gt;systemLink($editProblemPage, params =&gt; { make_local_copy =&gt; 0 });
<a name="l02005"></a>02005                 $viewProblemPage =
<a name="l02006"></a>02006                     $urlpath-&gt;new(type =&gt;<span class="stringliteral">&#39;gateway_quiz&#39;</span>,
<a name="l02007"></a>02007                               args =&gt; { courseID =&gt; $courseID,
<a name="l02008"></a>02008                                 setID =&gt; <span class="stringliteral">&quot;Undefined_Set&quot;</span>,
<a name="l02009"></a>02009                                 problemID =&gt; <span class="stringliteral">&quot;1&quot;</span> } );
<a name="l02010"></a>02010 
<a name="l02011"></a>02011                 my $seed = $problemToShow ? $problemToShow-&gt;problem_seed : <span class="stringliteral">&quot;&quot;</span>;
<a name="l02012"></a>02012                 my $file = $problemToShow ? $problemToShow-&gt;source_file : 
<a name="l02013"></a>02013                     $GlobalProblems{$problemID}-&gt;source_file;
<a name="l02014"></a>02014 
<a name="l02015"></a>02015                 $viewProblemLink =
<a name="l02016"></a>02016                     $self-&gt;systemLink( $viewProblemPage,
<a name="l02017"></a>02017                         params =&gt; { effectiveUser =&gt;
<a name="l02018"></a>02018                                 ($forOneUser ? $editForUser[0] : $userID),
<a name="l02019"></a>02019                                 problemSeed =&gt; $seed,
<a name="l02020"></a>02020                                 sourceFilePath =&gt; $file });
<a name="l02021"></a>02021             } <span class="keywordflow">else</span> {
<a name="l02022"></a>02022                 $editProblemPage = $urlpath-&gt;new(type =&gt; <span class="stringliteral">&#39;instructor_problem_editor_withset_withproblem&#39;</span>, args =&gt; { courseID =&gt; $courseID, setID =&gt; $fullSetID, problemID =&gt; $problemID });
<a name="l02023"></a>02023                 $editProblemLink = $self-&gt;systemLink($editProblemPage, params =&gt; { make_local_copy =&gt; 0 });
<a name="l02024"></a>02024 <span class="preprocessor">            # FIXME: should we have an &quot;act as&quot; type link here when editing for multiple users?     </span>
<a name="l02025"></a>02025 <span class="preprocessor"></span>                $viewProblemPage = $urlpath-&gt;new(type =&gt; <span class="stringliteral">&#39;problem_detail&#39;</span>, args =&gt; { courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt; $problemID });
<a name="l02026"></a>02026                 $viewProblemLink = $self-&gt;systemLink($viewProblemPage, params =&gt; { effectiveUser =&gt; ($forOneUser ? $editForUser[0] : $userID)});
<a name="l02027"></a>02027             }
<a name="l02028"></a>02028 
<a name="l02029"></a>02029     
<a name="l02030"></a>02030             my $problemFile = $r-&gt;param(<span class="stringliteral">&quot;problem.$problemID.source_file&quot;</span>) || $problemRecord-&gt;source_file;
<a name="l02031"></a>02031             $problemFile =~ s|^/||;
<a name="l02032"></a>02032             $problemFile =~ s|\.\.||g;
<a name="l02033"></a>02033 <span class="preprocessor">            # warn of repeat problems</span>
<a name="l02034"></a>02034 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (defined $shownYet{$problemFile}) {
<a name="l02035"></a>02035                 $repeatFile = $r-&gt;maketext(<span class="stringliteral">&quot;This problem uses the same source file as number [_1].&quot;</span>, $shownYet{$problemFile});
<a name="l02036"></a>02036             } <span class="keywordflow">else</span> {
<a name="l02037"></a>02037                 $shownYet{$problemFile} = $problemID;
<a name="l02038"></a>02038                 $repeatFile = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02039"></a>02039             }
<a name="l02040"></a>02040             
<a name="l02041"></a>02041             my $error = $self-&gt;checkFile($problemFile, undef);
<a name="l02042"></a>02042             my $this_set = $db-&gt;getMergedSet($userToShow, $setID);
<a name="l02043"></a>02043             my @problem_html;
<a name="l02044"></a>02044             unless ($error) {
<a name="l02045"></a>02045                 @problem_html = renderProblems(
<a name="l02046"></a>02046                     r=&gt; $r, 
<a name="l02047"></a>02047                     user =&gt; $db-&gt;getUser($userToShow),
<a name="l02048"></a>02048                     displayMode=&gt; $default_problem_mode,
<a name="l02049"></a>02049                     problem_number=&gt; $problemID,
<a name="l02050"></a>02050                     this_set =&gt; $this_set,
<a name="l02051"></a>02051                     problem_seed =&gt; $forOneUser ? $problemRecord-&gt;problem_seed : 0,
<a name="l02052"></a>02052                     problem_list =&gt; [$problemFile],     #  [$problemRecord-&gt;source_file],
<a name="l02053"></a>02053                 );
<a name="l02054"></a>02054             }
<a name="l02055"></a>02055 
<a name="l02056"></a>02056 <span class="preprocessor">            # we want to show the &quot;Try It&quot; and &quot;Edit It&quot; links if there&#39;s a </span>
<a name="l02057"></a>02057 <span class="preprocessor"></span><span class="preprocessor">            #    well defined problem to view; this is when we&#39;re editing a </span>
<a name="l02058"></a>02058 <span class="preprocessor"></span><span class="preprocessor">            #    homework set, or if we&#39;re editing a gateway set version, or </span>
<a name="l02059"></a>02059 <span class="preprocessor"></span><span class="preprocessor">            #    if we&#39;re editing a gateway set and the problem is not a </span>
<a name="l02060"></a>02060 <span class="preprocessor"></span><span class="preprocessor">            #    group problem</span>
<a name="l02061"></a>02061 <span class="preprocessor"></span>            my $showLinks = ( ! $isGatewaySet || 
<a name="l02062"></a>02062                       ( $editingSetVersion || $problemFile !~ /^group/ ));
<a name="l02063"></a>02063 
<a name="l02064"></a>02064 
<a name="l02065"></a>02065             print CGI::Tr({}, CGI::td({}, [
<a name="l02066"></a>02066                 CGI::start_table({border =&gt; 0, cellpadding =&gt; 1}) .
<a name="l02067"></a>02067                     CGI::Tr({}, CGI::td({}, problem_number_popup($problemID, $maxProblemNumber))) .
<a name="l02068"></a>02068                     CGI::Tr({}, CGI::td({}, 
<a name="l02069"></a>02069                                 $showLinks ? CGI::a({href =&gt; $editProblemLink, target=&gt;<span class="stringliteral">&quot;WW_Editor&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Edit it&quot;</span>)) : <span class="stringliteral">&quot;&quot;</span> )) .
<a name="l02070"></a>02070                     CGI::Tr({}, CGI::td({}, 
<a name="l02071"></a>02071                                 $showLinks ? CGI::a({href =&gt; $viewProblemLink, target=&gt;<span class="stringliteral">&quot;WW_View&quot;</span>}, $r-&gt;maketext(<span class="stringliteral">&quot;Try it&quot;</span>) . ($forOneUser ? <span class="stringliteral">&quot; (as $editForUser[0])&quot;</span> : <span class="stringliteral">&quot;&quot;</span>)) : <span class="stringliteral">&quot;&quot;</span> )) .
<a name="l02072"></a>02072                     ($forUsers ? <span class="stringliteral">&quot;&quot;</span> : CGI::Tr({}, CGI::td({}, CGI::checkbox({name =&gt; <span class="stringliteral">&quot;deleteProblem&quot;</span>, value =&gt; $problemID, label =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Delete it?&quot;</span>)})))) .
<a name="l02073"></a>02073 #                   CGI::Tr({}, CGI::td({}, <span class="stringliteral">&quot;Delete&amp;nbsp;it?&quot;</span> . CGI::input({type =&gt; <span class="stringliteral">&quot;checkbox&quot;</span>, name =&gt; <span class="stringliteral">&quot;deleteProblem&quot;</span>, value =&gt; $problemID}))) .
<a name="l02074"></a>02074                     ($forOneUser ? <span class="stringliteral">&quot;&quot;</span> : CGI::Tr({}, CGI::td({}, CGI::checkbox({name =&gt; <span class="stringliteral">&quot;markCorrect&quot;</span>, value =&gt; $problemID, label =&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Mark Correct?&quot;</span>)})))) .
<a name="l02075"></a>02075                 CGI::end_table(),
<a name="l02076"></a>02076                 $self-&gt;FieldTable($userToShow, $setID, $problemID, $GlobalProblems{$problemID}, $problemToShow, $isGatewaySet),
<a name="l02077"></a>02077 # A comprehensive list of problems is just TOO big to be handled well
<a name="l02078"></a>02078 #               comboBox({
<a name="l02079"></a>02079 <span class="preprocessor">#                   name =&gt; &quot;set.$setID.$problemID&quot;,</span>
<a name="l02080"></a>02080 <span class="preprocessor"></span><span class="preprocessor">#                   request =&gt; $r,</span>
<a name="l02081"></a>02081 <span class="preprocessor"></span><span class="preprocessor">#                   default =&gt; $problemRecord-&gt;{problem_id},</span>
<a name="l02082"></a>02082 <span class="preprocessor"></span><span class="preprocessor">#                   multiple =&gt; 0,</span>
<a name="l02083"></a>02083 <span class="preprocessor"></span><span class="preprocessor">#                   values =&gt; \@problemFileList,</span>
<a name="l02084"></a>02084 <span class="preprocessor"></span><span class="preprocessor">#               }) .</span>
<a name="l02085"></a>02085 <span class="preprocessor"></span>                
<a name="l02086"></a>02086                 join (<span class="stringliteral">&quot;\n&quot;</span>, $self-&gt;FieldHTML(
<a name="l02087"></a>02087                     $userToShow,
<a name="l02088"></a>02088                     $setID,
<a name="l02089"></a>02089                     $problemID,
<a name="l02090"></a>02090                     $GlobalProblems{$problemID}, # pass previously fetched global record to FieldHTML --sam
<a name="l02091"></a>02091                     $problemToShow, # pass previously fetched user record to FieldHTML --sam
<a name="l02092"></a>02092                     <span class="stringliteral">&quot;source_file&quot;</span>
<a name="l02093"></a>02093                 )) .
<a name="l02094"></a>02094                         CGI::br() . 
<a name="l02095"></a>02095                     ($error ? 
<a name="l02096"></a>02096                         CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>, style=&gt;<span class="stringliteral">&quot;font-weight: bold&quot;</span>}, $error) 
<a name="l02097"></a>02097                         : CGI::div({<span class="keyword">class</span>=&gt; <span class="stringliteral">&quot;RenderSolo&quot;</span>}, $problem_html[0]-&gt;{body_text})
<a name="l02098"></a>02098                     ) .
<a name="l02099"></a>02099                     ($repeatFile ? CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>, style=&gt;<span class="stringliteral">&quot;font-weight: bold&quot;</span>}, $repeatFile) : <span class="stringliteral">&#39;&#39;</span>),
<a name="l02100"></a>02100             ]));
<a name="l02101"></a>02101         }
<a name="l02102"></a>02102 
<a name="l02103"></a>02103           
<a name="l02104"></a>02104 <span class="preprocessor"># print final lines</span>
<a name="l02105"></a>02105 <span class="preprocessor"></span>        print CGI::end_table();
<a name="l02106"></a>02106         print CGI::checkbox({
<a name="l02107"></a>02107                   label=&gt; $r-&gt;maketext(<span class="stringliteral">&quot;Force problems to be numbered consecutively from one (always done when reordering problems)&quot;</span>),
<a name="l02108"></a>02108                   name=&gt;<span class="stringliteral">&quot;force_renumber&quot;</span>, value=&gt;<span class="stringliteral">&quot;1&quot;</span>});
<a name="l02109"></a>02109         print CGI::p($r-&gt;maketext(<span class="stringliteral">&quot;Any time problem numbers are intentionally changed, the problems will always be renumbered consecutively, starting from one.  When deleting problems, gaps will be left in the numbering unless the box above is checked.&quot;</span>));
<a name="l02110"></a>02110         print CGI::p($r-&gt;maketext(<span class="stringliteral">&quot;It is before the open date.  You probably want to renumber the problems if you are deleting some from the middle.&quot;</span>)) <span class="keywordflow">if</span> ($setRecord-&gt;open_date&gt;time());
<a name="l02111"></a>02111         print CGI::p($r-&gt;maketext(<span class="stringliteral">&quot;When changing problem numbers, we will move the problem to be [_1] the chosen number.&quot;</span>,CGI::em($r-&gt;maketext(<span class="stringliteral">&quot;before&quot;</span>))));
<a name="l02112"></a>02112 
<a name="l02113"></a>02113     } <span class="keywordflow">else</span> {
<a name="l02114"></a>02114         print CGI::p(CGI::b($r-&gt;maketext(<span class="stringliteral">&quot;This set doesn&#39;t contain any problems yet.&quot;</span>)));
<a name="l02115"></a>02115     }
<a name="l02116"></a>02116 <span class="preprocessor">    # always allow one to add a new problem, unless we&#39;re editing a set version</span>
<a name="l02117"></a>02117 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! $editingSetVersion ) {
<a name="l02118"></a>02118         print   CGI::checkbox({ label=&gt; <span class="stringliteral">&quot;Add&quot;</span>,
<a name="l02119"></a>02119                     name=&gt;<span class="stringliteral">&quot;add_blank_problem&quot;</span>, value=&gt;<span class="stringliteral">&quot;1&quot;</span>}
<a name="l02120"></a>02120             ),CGI::input({
<a name="l02121"></a>02121                     name=&gt;<span class="stringliteral">&quot;add_n_problems&quot;</span>,
<a name="l02122"></a>02122                     size=&gt;2,
<a name="l02123"></a>02123                     value=&gt;1 },
<a name="l02124"></a>02124                     $r-&gt;maketext(<span class="stringliteral">&quot;blank problem template(s) to end of homework set&quot;</span>)
<a name="l02125"></a>02125             );
<a name="l02126"></a>02126     }
<a name="l02127"></a>02127     print CGI::br(),CGI::br(),
<a name="l02128"></a>02128         CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, name=&gt;<span class="stringliteral">&quot;submit_changes&quot;</span>, value=&gt;<span class="stringliteral">&quot;Save Changes&quot;</span>}),
<a name="l02129"></a>02129         CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, name=&gt;<span class="stringliteral">&quot;handle_numbers&quot;</span>, value=&gt;<span class="stringliteral">&quot;Reorder problems only&quot;</span>}),
<a name="l02130"></a>02130             $r-&gt;maketext(<span class="stringliteral">&quot;(Any unsaved changes will be lost.)&quot;</span>);
<a name="l02131"></a>02131 
<a name="l02132"></a>02132 <span class="preprocessor">    #my $editNewProblemPage = $urlpath-&gt;new(type =&gt; &#39;instructor_problem_editor_withset_withproblem&#39;, args =&gt; { courseID =&gt; $courseID, setID =&gt; $setID, problemID =&gt;&#39;new_problem&#39;    });</span>
<a name="l02133"></a>02133 <span class="preprocessor"></span><span class="preprocessor">    #my $editNewProblemLink = $self-&gt;systemLink($editNewProblemPage, params =&gt; { make_local_copy =&gt; 1, file_type =&gt; &#39;blank_problem&#39;  });</span>
<a name="l02134"></a>02134 <span class="preprocessor"></span><span class="preprocessor">    # This next feature isn&#39;t fully supported and is causing problems.  Remove for now.  #FIXME</span>
<a name="l02135"></a>02135 <span class="preprocessor"></span><span class="preprocessor">    #print CGI::p( CGI::a({href=&gt;$editNewProblemLink},&#39;Edit&#39;). &#39; a new blank problem&#39;);</span>
<a name="l02136"></a>02136 <span class="preprocessor"></span>
<a name="l02137"></a>02137     print CGI::end_form();
<a name="l02138"></a>02138     
<a name="l02139"></a>02139     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l02140"></a>02140 }
<a name="l02141"></a>02141 
<a name="l02142"></a>02142 1;
<a name="l02143"></a>02143 
<a name="l02144"></a>02144 =head1 AUTHOR
<a name="l02145"></a>02145 
<a name="l02146"></a>02146 Written by Robert Van Dam, toenail (at) cif.rochester.edu
<a name="l02147"></a>02147 
<a name="l02148"></a>02148 =cut
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:35 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
