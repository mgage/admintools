<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: FileManager.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>FileManager.pm</h1><a href="FileManager_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/Instructor/FileManager.pm,v 1.30 2007/09/08 21:15:16 dpvc Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE. See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::Instructor::FileManager;
<a name="l00018"></a>00018 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">WeBWorK::ContentGenerator::Instructor</a>);
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(readDirectory readFile sortByName listFilesRecursive);
<a name="l00021"></a>00021 use <a class="code" href="classWeBWorK_1_1Upload.html">WeBWorK::Upload</a>;
<a name="l00022"></a>00022 use File::Path;
<a name="l00023"></a>00023 use File::Copy;
<a name="l00024"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1FileManager.html">00024</a> use File::Spec;
<a name="l00025"></a>00025 use String::ShellQuote;
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 =head1 NAME
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1FileManager.html">WeBWorK::ContentGenerator::Instructor::FileManager</a>.pm -- simple directory manager <span class="keywordflow">for</span> WW files
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 =cut
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 use strict;
<a name="l00034"></a>00034 use warnings;
<a name="l00035"></a>00035 <span class="preprocessor">#use CGI;</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 use <a class="code" href="classWeBWorK_1_1Utils_1_1CourseManagement.html">WeBWorK::Utils::CourseManagement</a> qw(archiveCourse);
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 use constant HOME =&gt; <span class="stringliteral">&#39;templates&#39;</span>;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#  The list of file extensions and the directories they usually go in.</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>my %uploadDir = (
<a name="l00046"></a>00046   csv  =&gt; <span class="stringliteral">&#39;scoring&#39;</span>,
<a name="l00047"></a>00047   lst  =&gt; <span class="stringliteral">&#39;templates&#39;</span>,
<a name="l00048"></a>00048   pg   =&gt; <span class="stringliteral">&#39;templates/.*&#39;</span>,
<a name="l00049"></a>00049   pl   =&gt; <span class="stringliteral">&#39;templates/macros&#39;</span>,
<a name="l00050"></a>00050   def  =&gt; <span class="stringliteral">&#39;templates&#39;</span>,
<a name="l00051"></a>00051   html =&gt; <span class="stringliteral">&#39;html/.*&#39;</span>,
<a name="l00052"></a>00052 );
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">##################################################</span>
<a name="l00055"></a>00055 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor"># Check that the user is authorized, and then</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor"># see if there is a download to perform.</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>sub pre_header_initialize {
<a name="l00060"></a>00060     my $self = shift;
<a name="l00061"></a>00061     my $r = $self-&gt;r;
<a name="l00062"></a>00062     my $authz = $r-&gt;authz;
<a name="l00063"></a>00063     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00064"></a>00064     
<a name="l00065"></a>00065 <span class="preprocessor">    # we don&#39;t need to return an error here, because body() will print an error for us :)</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>    <span class="keywordflow">return</span> unless $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;manage_course_files&quot;</span>);
<a name="l00067"></a>00067     
<a name="l00068"></a>00068     my $action = $r-&gt;param(<span class="stringliteral">&#39;action&#39;</span>);
<a name="l00069"></a>00069     $self-&gt;Download <span class="keywordflow">if</span> ($action &amp;&amp; $action eq <span class="stringliteral">&#39;Download&#39;</span>);
<a name="l00070"></a>00070     my $file = $r-&gt;param(<span class="stringliteral">&#39;download&#39;</span>);
<a name="l00071"></a>00071     $self-&gt;downloadFile($file) <span class="keywordflow">if</span> (defined $file);
<a name="l00072"></a>00072     my $ce = $r-&gt;ce;
<a name="l00073"></a>00073     my $urlpath = $r-&gt;urlpath;
<a name="l00074"></a>00074     my $courseID = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>);
<a name="l00075"></a>00075 <span class="preprocessor">    # removed archived_course_ prefix -- it is important that path matches the $courseID for consitency with the database dump</span>
<a name="l00076"></a>00076 <span class="preprocessor"></span>    my $archive_path = $ce-&gt;{webworkDirs}{courses} . <span class="stringliteral">&quot;/$courseID/templates/$courseID.tar.gz&quot;</span>;
<a name="l00077"></a>00077     my %options = (courseID =&gt; $courseID, archive_path =&gt; $archive_path, ce=&gt;$ce );
<a name="l00078"></a>00078     $self-&gt;{archive_options}= \%options;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 }
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="preprocessor">##################################################</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="preprocessor"># Download a given file</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>sub downloadFile {
<a name="l00087"></a>00087     my $self = shift;
<a name="l00088"></a>00088     my $file = checkName(shift);
<a name="l00089"></a>00089     my $pwd = $self-&gt;checkPWD(shift || $self-&gt;r-&gt;param(<span class="stringliteral">&#39;pwd&#39;</span>) || HOME);
<a name="l00090"></a>00090     <span class="keywordflow">return</span> unless $pwd;
<a name="l00091"></a>00091     $pwd = $self-&gt;{ce}{courseDirs}{root} . <span class="charliteral">&#39;/&#39;</span> . $pwd;
<a name="l00092"></a>00092     unless (-e <span class="stringliteral">&quot;$pwd/$file&quot;</span>) {
<a name="l00093"></a>00093         $self-&gt;addbadmessage(<span class="stringliteral">&quot;The file you are trying to download doesn&#39;t exist&quot;</span>);
<a name="l00094"></a>00094         <span class="keywordflow">return</span>;
<a name="l00095"></a>00095     }
<a name="l00096"></a>00096     unless (-f <span class="stringliteral">&quot;$pwd/$file&quot;</span>) {
<a name="l00097"></a>00097         $self-&gt;addbadmessage(<span class="stringliteral">&quot;You can only download regular files.&quot;</span>);
<a name="l00098"></a>00098         <span class="keywordflow">return</span>;
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100     my $type = <span class="stringliteral">&quot;application/octet-stream&quot;</span>;
<a name="l00101"></a>00101     $type = <span class="stringliteral">&quot;text/plain&quot;</span> <span class="keywordflow">if</span> $file =~ m/\.(pg|pl|pm|txt|def|csv|lst)/;
<a name="l00102"></a>00102     $type = <span class="stringliteral">&quot;image/gif&quot;</span>  <span class="keywordflow">if</span> $file =~ m/\.gif/;
<a name="l00103"></a>00103     $type = <span class="stringliteral">&quot;image/jpeg&quot;</span> <span class="keywordflow">if</span> $file =~ m/\.(jpg|jpeg)/;
<a name="l00104"></a>00104     $type = <span class="stringliteral">&quot;image/png&quot;</span>  <span class="keywordflow">if</span> $file =~ m/\.png/;
<a name="l00105"></a>00105     $self-&gt;reply_with_file($type, <span class="stringliteral">&quot;$pwd/$file&quot;</span>, $file, 0);
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00108"></a>00108 <span class="preprocessor">##################################################</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00110"></a>00110 <span class="preprocessor"></span><span class="preprocessor"># The main body of the page</span>
<a name="l00111"></a>00111 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00112"></a>00112 <span class="preprocessor"></span>sub body {
<a name="l00113"></a>00113     my $self       = shift;
<a name="l00114"></a>00114     my $r          = $self-&gt;r;
<a name="l00115"></a>00115     my $urlpath    = $r-&gt;urlpath;
<a name="l00116"></a>00116     my $db         = $r-&gt;db;
<a name="l00117"></a>00117     my $ce         = $r-&gt;ce;
<a name="l00118"></a>00118     my $authz      = $r-&gt;authz;
<a name="l00119"></a>00119     my $courseRoot = $ce-&gt;{courseDirs}{root};
<a name="l00120"></a>00120     my $courseName = $urlpath-&gt;arg(<span class="stringliteral">&#39;courseID&#39;</span>);
<a name="l00121"></a>00121     my $user       = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00122"></a>00122     my $key        = $r-&gt;param(<span class="stringliteral">&#39;key&#39;</span>);
<a name="l00123"></a>00123     
<a name="l00124"></a>00124     <span class="keywordflow">return</span> CGI::em(<span class="stringliteral">&quot;You are not authorized to manage course files&quot;</span>)
<a name="l00125"></a>00125         unless $authz-&gt;hasPermissions($user, &quot;manage_course_files&quot;);
<a name="l00126"></a>00126 
<a name="l00127"></a>00127     $self-&gt;{pwd} = $self-&gt;checkPWD($r-&gt;param(<span class="stringliteral">&#39;pwd&#39;</span>) || HOME);
<a name="l00128"></a>00128     <span class="keywordflow">return</span> CGI::em(<span class="stringliteral">&quot;You have specified an illegal working directory!&quot;</span>) unless defined $self-&gt;{pwd};
<a name="l00129"></a>00129 
<a name="l00130"></a>00130     my $fileManagerPage = $urlpath-&gt;newFromModule($urlpath-&gt;module, $r, courseID =&gt; $courseName);
<a name="l00131"></a>00131     my $fileManagerURL  = $self-&gt;systemLink($fileManagerPage, authen =&gt; 0);
<a name="l00132"></a>00132 
<a name="l00133"></a>00133     print CGI::start_form(
<a name="l00134"></a>00134         -method=&gt;<span class="stringliteral">&quot;POST&quot;</span>,
<a name="l00135"></a>00135         -action=&gt;$fileManagerURL,
<a name="l00136"></a>00136         -<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;FileManager&quot;</span>,
<a name="l00137"></a>00137         -enctype=&gt; <span class="stringliteral">&#39;multipart/form-data&#39;</span>,
<a name="l00138"></a>00138         -name=&gt;<span class="stringliteral">&quot;FileManager&quot;</span>,
<a name="l00139"></a>00139          -style=&gt;<span class="stringliteral">&quot;margin:0&quot;</span>,
<a name="l00140"></a>00140     );
<a name="l00141"></a>00141     print $self-&gt;hidden_authen_fields;
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     $self-&gt;{courseRoot} = $courseRoot;
<a name="l00144"></a>00144     $self-&gt;{courseName} = $courseName;
<a name="l00145"></a>00145 
<a name="l00146"></a>00146     my $action = $r-&gt;param(<span class="stringliteral">&#39;action&#39;</span>) || $r-&gt;param(<span class="stringliteral">&#39;formAction&#39;</span>) || $r-&gt;param(<span class="stringliteral">&quot;confirmed&quot;</span>) || <span class="stringliteral">&#39;Init&#39;</span>;
<a name="l00147"></a>00147 
<a name="l00148"></a>00148     <span class="keywordflow">for</span> ($action) {
<a name="l00149"></a>00149         /^Refresh/i    and <span class="keywordflow">do</span> {$self-&gt;Refresh; last};
<a name="l00150"></a>00150         /^Cancel/i     and <span class="keywordflow">do</span> {$self-&gt;Refresh; last};
<a name="l00151"></a>00151         /^\^/i         and <span class="keywordflow">do</span> {$self-&gt;ParentDir; last};
<a name="l00152"></a>00152         /^Directory/i  and <span class="keywordflow">do</span> {$self-&gt;Go; last};
<a name="l00153"></a>00153         /^Go/i         and <span class="keywordflow">do</span> {$self-&gt;Go; last};
<a name="l00154"></a>00154         /^View/i       and <span class="keywordflow">do</span> {$self-&gt;View; last};
<a name="l00155"></a>00155         /^Edit/i       and <span class="keywordflow">do</span> {$self-&gt;Edit; last};
<a name="l00156"></a>00156         /^Download/i   and <span class="keywordflow">do</span> {$self-&gt;Refresh; last};
<a name="l00157"></a>00157         /^Copy/i       and <span class="keywordflow">do</span> {$self-&gt;Copy; last};
<a name="l00158"></a>00158         /^Rename/i     and <span class="keywordflow">do</span> {$self-&gt;Rename; last};
<a name="l00159"></a>00159         /^Delete/i     and <span class="keywordflow">do</span> {$self-&gt;Delete; last};
<a name="l00160"></a>00160         /^Make/i       and <span class="keywordflow">do</span> {$self-&gt;MakeArchive; last};
<a name="l00161"></a>00161         /^Unpack/i     and <span class="keywordflow">do</span> {$self-&gt;UnpackArchive; last};
<a name="l00162"></a>00162         /^New Folder/i and <span class="keywordflow">do</span> {$self-&gt;NewFolder; last};
<a name="l00163"></a>00163         /^New <a class="code" href="classWeBWorK_1_1File.html">File</a>/i   and <span class="keywordflow">do</span> {$self-&gt;NewFile; last};
<a name="l00164"></a>00164         /^Upload/i     and <span class="keywordflow">do</span> {$self-&gt;Upload; last};
<a name="l00165"></a>00165         /^Revert/i     and <span class="keywordflow">do</span> {$self-&gt;Edit; last};
<a name="l00166"></a>00166         /^Save As/i    and <span class="keywordflow">do</span> {$self-&gt;SaveAs; last};
<a name="l00167"></a>00167         /^Save/i       and <span class="keywordflow">do</span> {$self-&gt;Save; last};
<a name="l00168"></a>00168         /^Init/i       and <span class="keywordflow">do</span> {$self-&gt;Init; last};
<a name="l00169"></a>00169         $self-&gt;addbadmessage(<span class="stringliteral">&quot;Unknown action.&quot;</span>);
<a name="l00170"></a>00170         $self-&gt;Refresh;
<a name="l00171"></a>00171     }
<a name="l00172"></a>00172     <span class="keywordflow">if</span> ($r-&gt;param(<span class="stringliteral">&#39;archiveCourse&#39;</span>) ) {
<a name="l00173"></a>00173          my %options = %{$self-&gt;{archive_options}};
<a name="l00174"></a>00174         my $courseID = $options{courseID};
<a name="l00175"></a>00175         $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Archiving course as $courseID.tar.gz. Reload FileManager to see it.&quot;</span>);
<a name="l00176"></a>00176         <a class="code" href="classWeBWorK_1_1Utils_1_1CourseManagement.html#a1dc2740fc57733be708c89a7def1ef9e">WeBWorK::Utils::CourseManagement::archiveCourse</a>(%options);
<a name="l00177"></a>00177         $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Course archived.&quot;</span>);
<a name="l00178"></a>00178         
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180     print CGI::hidden({name=&gt;<span class="stringliteral">&#39;pwd&#39;</span>,value=&gt;$self-&gt;{pwd}});
<a name="l00181"></a>00181     print CGI::hidden({name=&gt;<span class="stringliteral">&#39;formAction&#39;</span>,value=&gt;<span class="stringliteral">&quot;&quot;</span>});
<a name="l00182"></a>00182     print CGI::end_form();
<a name="l00183"></a>00183 
<a name="l00184"></a>00184     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00187"></a>00187 
<a name="l00188"></a>00188 <span class="preprocessor">##################################################</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="preprocessor">#  First time through</span>
<a name="l00191"></a>00191 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>sub Init {
<a name="l00193"></a>00193     my $self = shift;
<a name="l00194"></a>00194     $self-&gt;r-&gt;param(<span class="stringliteral">&#39;unpack&#39;</span>,1);
<a name="l00195"></a>00195     $self-&gt;r-&gt;param(<span class="stringliteral">&#39;autodelete&#39;</span>,1);
<a name="l00196"></a>00196     $self-&gt;r-&gt;param(<span class="stringliteral">&#39;format&#39;</span>,<span class="stringliteral">&#39;Automatic&#39;</span>);
<a name="l00197"></a>00197     $self-&gt;Refresh;
<a name="l00198"></a>00198 }
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 sub HiddenFlags {
<a name="l00201"></a>00201     my $self = shift;
<a name="l00202"></a>00202     print CGI::hidden({name=&gt;<span class="stringliteral">&quot;dates&quot;</span>,     value=&gt;$self-&gt;getFlag(<span class="stringliteral">&#39;dates&#39;</span>)});
<a name="l00203"></a>00203     print CGI::hidden({name=&gt;<span class="stringliteral">&quot;overwrite&quot;</span>, value=&gt;$self-&gt;getFlag(<span class="stringliteral">&#39;overwrite&#39;</span>)});
<a name="l00204"></a>00204     print CGI::hidden({name=&gt;<span class="stringliteral">&quot;unpack&quot;</span>,    value=&gt;$self-&gt;getFlag(<span class="stringliteral">&#39;unpack&#39;</span>)});
<a name="l00205"></a>00205     print CGI::hidden({name=&gt;<span class="stringliteral">&quot;autodelete&quot;</span>,value=&gt;$self-&gt;getFlag(<span class="stringliteral">&#39;autodelete&#39;</span>)});
<a name="l00206"></a>00206     print CGI::hidden({name=&gt;<span class="stringliteral">&quot;format&quot;</span>,    value=&gt;$self-&gt;getFlag(<span class="stringliteral">&#39;format&#39;</span>,<span class="stringliteral">&#39;Automatic&#39;</span>)});
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="preprocessor">##################################################</span>
<a name="l00210"></a>00210 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00211"></a>00211 <span class="preprocessor"></span><span class="preprocessor"># Display the directory listing and associated buttons</span>
<a name="l00212"></a>00212 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00213"></a>00213 <span class="preprocessor"></span>sub Refresh {
<a name="l00214"></a>00214     my $self = shift;
<a name="l00215"></a>00215     my $pwd = shift || $self-&gt;{pwd};
<a name="l00216"></a>00216     my $isTop = $pwd eq <span class="charliteral">&#39;.&#39;</span> || $pwd eq <span class="stringliteral">&#39;&#39;</span>;
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     my ($dirs,$dirlabels) = directoryMenu($self-&gt;{courseName},$pwd);
<a name="l00219"></a>00219     my ($files,$filelabels) = directoryListing($self-&gt;{courseRoot},$pwd,$self-&gt;getFlag(<span class="stringliteral">&#39;dates&#39;</span>));
<a name="l00220"></a>00220 
<a name="l00221"></a>00221     unless ($files) {
<a name="l00222"></a>00222         $self-&gt;addbadmessage(<span class="stringliteral">&quot;The directory you specified doesn&#39;t exist&quot;</span>);
<a name="l00223"></a>00223         $files = []; $filelabels = {};
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225 
<a name="l00226"></a>00226 <span class="preprocessor">    #</span>
<a name="l00227"></a>00227 <span class="preprocessor"></span><span class="preprocessor">    # Some JavaScript to make things easier for the user</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>    print CGI::script(&lt;&lt;EOF);
<a name="l00230"></a>00230         function doForm(action) {
<a name="l00231"></a>00231             var form = window.document.getElementById(<span class="stringliteral">&#39;FileManager&#39;</span>);
<a name="l00232"></a>00232             form.formAction.value = action;
<a name="l00233"></a>00233             form.submit();
<a name="l00234"></a>00234         }
<a name="l00235"></a>00235         function disableButton(<span class="keywordtype">id</span>,state) {
<a name="l00236"></a>00236             var element = window.document.getElementById(<span class="keywordtype">id</span>);
<a name="l00237"></a>00237             element.disabled = state;
<a name="l00238"></a>00238         }
<a name="l00239"></a>00239         function checkFiles() {
<a name="l00240"></a>00240             var files = window.document.getElementById(<span class="stringliteral">&#39;files&#39;</span>);
<a name="l00241"></a>00241             var state = files.selectedIndex &lt; 0;
<a name="l00242"></a>00242             disableButton(<span class="stringliteral">&#39;View&#39;</span>,state);
<a name="l00243"></a>00243             disableButton(<span class="stringliteral">&#39;Edit&#39;</span>,state);
<a name="l00244"></a>00244             disableButton(<span class="stringliteral">&#39;Download&#39;</span>,state);
<a name="l00245"></a>00245             disableButton(<span class="stringliteral">&#39;Rename&#39;</span>,state);
<a name="l00246"></a>00246             disableButton(<span class="stringliteral">&#39;Copy&#39;</span>,state);
<a name="l00247"></a>00247             disableButton(<span class="stringliteral">&#39;Delete&#39;</span>,state);
<a name="l00248"></a>00248             disableButton(<span class="stringliteral">&#39;MakeArchive&#39;</span>,state);
<a name="l00249"></a>00249             checkArchive(files,state);
<a name="l00250"></a>00250         }
<a name="l00251"></a>00251         function checkFile() {
<a name="l00252"></a>00252             var file = window.document.getElementById(<span class="stringliteral">&#39;file&#39;</span>);
<a name="l00253"></a>00253             <span class="keywordflow">if</span> (navigator.vendor &amp;&amp; navigator.vendorSub &amp;&amp; navigator.vendor == <span class="stringliteral">&quot;Netscape&quot;</span>) {
<a name="l00254"></a>00254               <span class="keywordflow">if</span> (navigator.vendorSub.match(/(\\d+)\.(\\d+)/)) {
<a name="l00255"></a>00255                 <span class="keywordflow">if</span> (RegExp.\$1 &lt; 7 || (RegExp.\$1 == 7 &amp;&amp; RegExp.\$2 &lt; 2)) <span class="keywordflow">return</span>;
<a name="l00256"></a>00256               }
<a name="l00257"></a>00257             }
<a name="l00258"></a>00258             var state = (file.value == <span class="stringliteral">&quot;&quot;</span>);
<a name="l00259"></a>00259             disableButton(<span class="stringliteral">&#39;Upload&#39;</span>,state);
<a name="l00260"></a>00260         }
<a name="l00261"></a>00261         function checkArchive(files,disabled) {
<a name="l00262"></a>00262             var button = document.getElementById(<span class="stringliteral">&#39;MakeArchive&#39;</span>);
<a name="l00263"></a>00263             button.value = <span class="stringliteral">&#39;Make Archive&#39;</span>;
<a name="l00264"></a>00264             <span class="keywordflow">if</span> (disabled) <span class="keywordflow">return</span>;
<a name="l00265"></a>00265             <span class="keywordflow">if</span> (!files.childNodes[files.selectedIndex].value.match(/\\.(tar|tar\\.gz|tgz)\$/)) <span class="keywordflow">return</span>;
<a name="l00266"></a>00266             <span class="keywordflow">for</span> (var i = files.selectedIndex+1; i &lt; files.length; i++)
<a name="l00267"></a>00267               {<span class="keywordflow">if</span> (files.childNodes[i].selected) <span class="keywordflow">return</span>}
<a name="l00268"></a>00268             button.value = <span class="stringliteral">&#39;Unpack Archive&#39;</span>;
<a name="l00269"></a>00269         }
<a name="l00270"></a>00270 EOF
<a name="l00271"></a>00271 
<a name="l00272"></a>00272 <span class="preprocessor">    #</span>
<a name="l00273"></a>00273 <span class="preprocessor"></span><span class="preprocessor">    # Start the table</span>
<a name="l00274"></a>00274 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span>    print CGI::start_table({border=&gt;0,cellpadding=&gt;0,cellspacing=&gt;3, style=&gt;<span class="stringliteral">&quot;margin:1em 0 0 3em&quot;</span>});
<a name="l00276"></a>00276 
<a name="l00277"></a>00277 <span class="preprocessor">    #</span>
<a name="l00278"></a>00278 <span class="preprocessor"></span><span class="preprocessor">    # Directory menu and date/size checkbox</span>
<a name="l00279"></a>00279 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span>    print CGI::Tr({},
<a name="l00281"></a>00281         CGI::td({colspan=&gt;2},
<a name="l00282"></a>00282             CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>, name=&gt;<span class="stringliteral">&quot;action&quot;</span>, value =&gt; <span class="stringliteral">&quot;^&quot;</span>, ($isTop? (disabled=&gt;1): ())}),
<a name="l00283"></a>00283             CGI::popup_menu(
<a name="l00284"></a>00284                 -name =&gt; <span class="stringliteral">&quot;directory&quot;</span>,
<a name="l00285"></a>00285                 -values =&gt; $dirs,
<a name="l00286"></a>00286                 -labels =&gt; $dirlabels,
<a name="l00287"></a>00287                 -style =&gt; <span class="stringliteral">&quot;width:25em&quot;</span>,
<a name="l00288"></a>00288                 -onChange =&gt; <span class="stringliteral">&quot;doForm(&#39;Go&#39;)&quot;</span>
<a name="l00289"></a>00289             ),
<a name="l00290"></a>00290             CGI::noscript(CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>,name=&gt;<span class="stringliteral">&quot;action&quot;</span>,value=&gt;<span class="stringliteral">&quot;Go&quot;</span>}))
<a name="l00291"></a>00291         ),
<a name="l00292"></a>00292         CGI::td(CGI::small(CGI::checkbox(
<a name="l00293"></a>00293             -name =&gt; <span class="stringliteral">&#39;dates&#39;</span>,
<a name="l00294"></a>00294             -checked =&gt; $self-&gt;getFlag(<span class="stringliteral">&#39;dates&#39;</span>),
<a name="l00295"></a>00295             -value =&gt; 1,
<a name="l00296"></a>00296             -label =&gt; <span class="stringliteral">&#39;Show Date &amp; Size&#39;</span>,
<a name="l00297"></a>00297             -onClick =&gt; <span class="stringliteral">&#39;doForm(&quot;Refresh&quot;)&#39;</span>,
<a name="l00298"></a>00298         ))),
<a name="l00299"></a>00299     );
<a name="l00300"></a>00300 
<a name="l00301"></a>00301 <span class="preprocessor">    #</span>
<a name="l00302"></a>00302 <span class="preprocessor"></span><span class="preprocessor">    # Directory Listing and column of buttons</span>
<a name="l00303"></a>00303 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00304"></a>00304 <span class="preprocessor"></span>    my %button = (type=&gt;<span class="stringliteral">&quot;submit&quot;</span>,name=&gt;<span class="stringliteral">&quot;action&quot;</span>,style=&gt;<span class="stringliteral">&quot;width:10em&quot;</span>);
<a name="l00305"></a>00305     my $width = ($self-&gt;getFlag(<span class="stringliteral">&#39;dates&#39;</span>) &amp;&amp; scalar(@{$files}) &gt; 0) ? <span class="stringliteral">&quot;&quot;</span>: <span class="stringliteral">&quot; width:30em&quot;</span>;
<a name="l00306"></a>00306     print CGI::Tr({valign=&gt;<span class="stringliteral">&quot;middle&quot;</span>},
<a name="l00307"></a>00307         fixSpaces(CGI::td(CGI::scrolling_list(
<a name="l00308"></a>00308             -name =&gt; <span class="stringliteral">&quot;files&quot;</span>, <span class="keywordtype">id</span> =&gt; <span class="stringliteral">&quot;files&quot;</span>,
<a name="l00309"></a>00309             -style =&gt; <span class="stringliteral">&quot;font-family:monospace; $width&quot;</span>,
<a name="l00310"></a>00310             -size =&gt; 17,
<a name="l00311"></a>00311             -multiple =&gt; 1,
<a name="l00312"></a>00312             -values =&gt; $files,
<a name="l00313"></a>00313             -labels =&gt; $filelabels,
<a name="l00314"></a>00314             -onDblClick =&gt; <span class="stringliteral">&quot;doForm(&#39;View&#39;)&quot;</span>,
<a name="l00315"></a>00315             -onChange =&gt; <span class="stringliteral">&quot;checkFiles()&quot;</span>
<a name="l00316"></a>00316         ))),
<a name="l00317"></a>00317         CGI::td({width=&gt;15}),
<a name="l00318"></a>00318         CGI::td({},
<a name="l00319"></a>00319             CGI::start_table({border=&gt;0,cellpadding=&gt;0,cellspacing=&gt;3}),
<a name="l00320"></a>00320             CGI::Tr([
<a name="l00321"></a>00321                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;View&quot;</span>,<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;View&quot;</span>})),
<a name="l00322"></a>00322                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;Edit&quot;</span>,<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;Edit&quot;</span>})),
<a name="l00323"></a>00323                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;Download&quot;</span>,<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;Download&quot;</span>})),
<a name="l00324"></a>00324                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;Rename&quot;</span>,<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;Rename&quot;</span>})),
<a name="l00325"></a>00325                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;Copy&quot;</span>,<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;Copy&quot;</span>})),
<a name="l00326"></a>00326                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;Delete&quot;</span>,<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;Delete&quot;</span>})),
<a name="l00327"></a>00327                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;Make Archive&quot;</span>,<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;MakeArchive&quot;</span>})),
<a name="l00328"></a>00328                 CGI::td({height=&gt;10}),
<a name="l00329"></a>00329                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;New File&quot;</span>})),
<a name="l00330"></a>00330                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;New Folder&quot;</span>})),
<a name="l00331"></a>00331                 CGI::td(CGI::input({%button,value=&gt;<span class="stringliteral">&quot;Refresh&quot;</span>})),
<a name="l00332"></a>00332             ]),
<a name="l00333"></a>00333             CGI::end_table(),
<a name="l00334"></a>00334         ),
<a name="l00335"></a>00335     );
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 <span class="preprocessor">    #</span>
<a name="l00338"></a>00338 <span class="preprocessor"></span><span class="preprocessor">    # Upload button and checkboxes</span>
<a name="l00339"></a>00339 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span>    print CGI::Tr([
<a name="l00341"></a>00341         CGI::td(),
<a name="l00342"></a>00342         CGI::td({colspan=&gt;3},
<a name="l00343"></a>00343           CGI::input({type=&gt;<span class="stringliteral">&quot;submit&quot;</span>,name=&gt;<span class="stringliteral">&quot;action&quot;</span>,style=&gt;<span class="stringliteral">&quot;width:7em&quot;</span>,value=&gt;<span class="stringliteral">&quot;Upload:&quot;</span>,<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;Upload&quot;</span>}),
<a name="l00344"></a>00344           CGI::input({type=&gt;<span class="stringliteral">&quot;file&quot;</span>,name=&gt;<span class="stringliteral">&quot;file&quot;</span>,<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;file&quot;</span>,size=&gt;40,onChange=&gt;<span class="stringliteral">&quot;checkFile()&quot;</span>}),
<a name="l00345"></a>00345           CGI::br(),
<a name="l00346"></a>00346           CGI::small(join(<span class="stringliteral">&#39; &amp;nbsp; &#39;</span>,<span class="stringliteral">&quot;Format:&quot;</span>,
<a name="l00347"></a>00347             CGI::radio_group(-name=&gt;<span class="stringliteral">&#39;format&#39;</span>, -value=&gt;[<span class="stringliteral">&#39;Text&#39;</span>,<span class="stringliteral">&#39;Binary&#39;</span>,<span class="stringliteral">&#39;Automatic&#39;</span>],
<a name="l00348"></a>00348                      -<span class="keywordflow">default</span>=&gt;$self-&gt;getFlag(<span class="stringliteral">&#39;format&#39;</span>,<span class="stringliteral">&#39;Automatic&#39;</span>)))),
<a name="l00349"></a>00349         ),
<a name="l00350"></a>00350     ]);
<a name="l00351"></a>00351     print CGI::Tr([
<a name="l00352"></a>00352         CGI::td(),
<a name="l00353"></a>00353         CGI::td({colspan=&gt;3},
<a name="l00354"></a>00354           CGI::small(CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;overwrite&#39;</span>,-checked=&gt;$self-&gt;getFlag(<span class="stringliteral">&#39;overwrite&#39;</span>),-value=&gt;1,
<a name="l00355"></a>00355                        -label=&gt;<span class="stringliteral">&#39;Overwrite existing files silently&#39;</span>)),
<a name="l00356"></a>00356           CGI::br(),
<a name="l00357"></a>00357           CGI::small(CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;unpack&#39;</span>,-checked=&gt;$self-&gt;getFlag(<span class="stringliteral">&#39;unpack&#39;</span>),-value=&gt;1,
<a name="l00358"></a>00358                        -label=&gt;<span class="stringliteral">&#39;Unpack archives automatically&#39;</span>)),
<a name="l00359"></a>00359           CGI::small(CGI::checkbox(-name=&gt;<span class="stringliteral">&#39;autodelete&#39;</span>,-checked=&gt;$self-&gt;getFlag(<span class="stringliteral">&#39;autodelete&#39;</span>),-value=&gt;1,
<a name="l00360"></a>00360                        -label=&gt;<span class="stringliteral">&#39;then delete them&#39;</span>)),
<a name="l00361"></a>00361         ),
<a name="l00362"></a>00362     ]);
<a name="l00363"></a>00363 
<a name="l00364"></a>00364 <span class="preprocessor">    #</span>
<a name="l00365"></a>00365 <span class="preprocessor"></span><span class="preprocessor">    # End the table</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span><span class="preprocessor">    # </span>
<a name="l00367"></a>00367 <span class="preprocessor"></span>    print CGI::end_table();
<a name="l00368"></a>00368     print CGI::script(<span class="stringliteral">&quot;checkFiles(); checkFile();&quot;</span>);
<a name="l00369"></a>00369 }
<a name="l00370"></a>00370 
<a name="l00371"></a>00371 <span class="preprocessor">##################################################</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span><span class="preprocessor"># Move to the parent directory</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00375"></a>00375 <span class="preprocessor"></span>sub ParentDir {
<a name="l00376"></a>00376     my $self = shift;
<a name="l00377"></a>00377     $self-&gt;{pwd} = <span class="charliteral">&#39;.&#39;</span> unless ($self-&gt;{pwd} =~ s!/[^/]*$!!);
<a name="l00378"></a>00378     $self-&gt;Refresh;
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 <span class="preprocessor">##################################################</span>
<a name="l00382"></a>00382 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span><span class="preprocessor"># Move to the parent directory</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span>sub Go {
<a name="l00386"></a>00386     my $self = shift;
<a name="l00387"></a>00387     $self-&gt;{pwd} = $self-&gt;r-&gt;param(<span class="stringliteral">&#39;directory&#39;</span>);
<a name="l00388"></a>00388     $self-&gt;Refresh;
<a name="l00389"></a>00389 }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391 <span class="preprocessor">##################################################</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00393"></a>00393 <span class="preprocessor"></span><span class="preprocessor"># Open a directory or view a file</span>
<a name="l00394"></a>00394 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span>sub View {
<a name="l00396"></a>00396     my $self = shift; my $pwd = $self-&gt;{pwd};
<a name="l00397"></a>00397     my $r = $self-&gt;r;
<a name="l00398"></a>00398     my $filename = $self-&gt;getFile(<span class="stringliteral">&quot;view&quot;</span>); <span class="keywordflow">return</span> unless $filename;
<a name="l00399"></a>00399     my $name = <span class="stringliteral">&quot;$pwd/$filename&quot;</span>; $name =~ s!^\./?!!;
<a name="l00400"></a>00400     my $file = <span class="stringliteral">&quot;$self-&gt;{courseRoot}/$pwd/$filename&quot;</span>;
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 <span class="preprocessor">    #</span>
<a name="l00403"></a>00403 <span class="preprocessor"></span><span class="preprocessor">    # Don&#39;t follow symbolic links</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00405"></a>00405 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($self-&gt;isSymLink($file)) {
<a name="l00406"></a>00406       $self-&gt;addbadmessage(<span class="stringliteral">&quot;That symbolic link takes you outside your course directory&quot;</span>);
<a name="l00407"></a>00407       $self-&gt;Refresh; <span class="keywordflow">return</span>;
<a name="l00408"></a>00408     }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 <span class="preprocessor">    #</span>
<a name="l00411"></a>00411 <span class="preprocessor"></span><span class="preprocessor">    # Handle directories by making them the working directory</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00413"></a>00413 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (-d $file) {
<a name="l00414"></a>00414         $self-&gt;{pwd} .= <span class="charliteral">&#39;/&#39;</span>.$filename;
<a name="l00415"></a>00415         $self-&gt;Refresh; <span class="keywordflow">return</span>;
<a name="l00416"></a>00416     }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418     unless (-f $file) {
<a name="l00419"></a>00419         $self-&gt;addbadmessage(<span class="stringliteral">&quot;You can&#39;t view files of that type&quot;</span>);
<a name="l00420"></a>00420         $self-&gt;Refresh; <span class="keywordflow">return</span>;
<a name="l00421"></a>00421     }
<a name="l00422"></a>00422 
<a name="l00423"></a>00423 <span class="preprocessor">    #</span>
<a name="l00424"></a>00424 <span class="preprocessor"></span><span class="preprocessor">    # Include a download link</span>
<a name="l00425"></a>00425 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00426"></a>00426 <span class="preprocessor"></span>    my $urlpath = $self-&gt;r-&gt;urlpath;
<a name="l00427"></a>00427     my $fileManagerPage = $urlpath-&gt;newFromModule($urlpath-&gt;module, $r, courseID =&gt; $self-&gt;{courseName});
<a name="l00428"></a>00428     my $fileManagerURL  = $self-&gt;systemLink($fileManagerPage, params =&gt; {download =&gt; $filename, pwd =&gt; $pwd});
<a name="l00429"></a>00429     print CGI::div({style=&gt;<span class="stringliteral">&quot;float:right&quot;</span>},
<a name="l00430"></a>00430          CGI::a({href=&gt;$fileManagerURL},<span class="stringliteral">&quot;Download&quot;</span>));
<a name="l00431"></a>00431     print CGI::p(),CGI::b($name),CGI::p();
<a name="l00432"></a>00432     print CGI::hr();
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 <span class="preprocessor">    #</span>
<a name="l00435"></a>00435 <span class="preprocessor"></span><span class="preprocessor">    # For files, display the file, if possible.</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span><span class="preprocessor">    # If the file is an image, display it as an image.</span>
<a name="l00437"></a>00437 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>    my $data = readFile($file);
<a name="l00439"></a>00439     <span class="keywordflow">if</span> (isText($data)) {
<a name="l00440"></a>00440         print CGI::pre(showHTML($data));
<a name="l00441"></a>00441     } elsif ($file =~ m/\.(gif|jpg|png)/i) {
<a name="l00442"></a>00442         print CGI::img({src=&gt;$fileManagerURL, border=&gt;0});
<a name="l00443"></a>00443     } <span class="keywordflow">else</span> {
<a name="l00444"></a>00444         print CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>},
<a name="l00445"></a>00445             <span class="stringliteral">&quot;The file does not appear to be a text file.&quot;</span>);
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447 }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449 <span class="preprocessor">##################################################</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00451"></a>00451 <span class="preprocessor"></span><span class="preprocessor"># Edit a file</span>
<a name="l00452"></a>00452 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00453"></a>00453 <span class="preprocessor"></span>sub Edit {
<a name="l00454"></a>00454     my $self = shift;
<a name="l00455"></a>00455     my $filename = $self-&gt;getFile(<span class="stringliteral">&#39;edit&#39;</span>); <span class="keywordflow">return</span> unless $filename;
<a name="l00456"></a>00456     my $file = <span class="stringliteral">&quot;$self-&gt;{courseRoot}/$self-&gt;{pwd}/$filename&quot;</span>;
<a name="l00457"></a>00457 
<a name="l00458"></a>00458     <span class="keywordflow">if</span> (-d $file) {
<a name="l00459"></a>00459         $self-&gt;addbadmessage(<span class="stringliteral">&quot;You can&#39;t edit a directory&quot;</span>);
<a name="l00460"></a>00460         $self-&gt;Refresh; <span class="keywordflow">return</span>;
<a name="l00461"></a>00461     }
<a name="l00462"></a>00462     unless (-f $file) {
<a name="l00463"></a>00463         $self-&gt;addbadmessage(<span class="stringliteral">&quot;You can only edit text files&quot;</span>);
<a name="l00464"></a>00464         $self-&gt;Refresh; <span class="keywordflow">return</span>;
<a name="l00465"></a>00465     }
<a name="l00466"></a>00466     my $data = readFile($file);
<a name="l00467"></a>00467     <span class="keywordflow">if</span> (!isText($data)) {
<a name="l00468"></a>00468         $self-&gt;addbadmessage(<span class="stringliteral">&quot;The file does not appear to be a text file&quot;</span>);
<a name="l00469"></a>00469         $self-&gt;Refresh; <span class="keywordflow">return</span>;
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     $self-&gt;RefreshEdit($data,$filename);
<a name="l00473"></a>00473 }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475 <span class="preprocessor">##################################################</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00477"></a>00477 <span class="preprocessor"></span><span class="preprocessor"># Save the edited file</span>
<a name="l00478"></a>00478 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00479"></a>00479 <span class="preprocessor"></span>sub Save {
<a name="l00480"></a>00480     my $self = shift; my $filename = shift;
<a name="l00481"></a>00481     my $pwd = $self-&gt;{pwd};
<a name="l00482"></a>00482     <span class="keywordflow">if</span> ($filename) {
<a name="l00483"></a>00483         $pwd = substr($filename,length($self-&gt;{courseRoot})+1);
<a name="l00484"></a>00484         $pwd =~ s!(/|^)([^/]*)$!!; $filename = $2;
<a name="l00485"></a>00485                 $pwd = <span class="charliteral">&#39;.&#39;</span> <span class="keywordflow">if</span> $pwd eq <span class="stringliteral">&#39;&#39;</span>;
<a name="l00486"></a>00486     } <span class="keywordflow">else</span> {
<a name="l00487"></a>00487         $filename = $self-&gt;getFile(<span class="stringliteral">&quot;save&quot;</span>); <span class="keywordflow">return</span> unless $filename;
<a name="l00488"></a>00488     }
<a name="l00489"></a>00489     my $file = <span class="stringliteral">&quot;$self-&gt;{courseRoot}/$pwd/$filename&quot;</span>;
<a name="l00490"></a>00490     my $data = $self-&gt;r-&gt;param(<span class="stringliteral">&quot;data&quot;</span>);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <span class="keywordflow">if</span> (defined($data)) {
<a name="l00493"></a>00493         $data =~ s/\r\n?/\n/g;  # convert DOS and Mac line ends to unix
<a name="l00494"></a>00494         local (*OUTFILE);
<a name="l00495"></a>00495         <span class="keywordflow">if</span> (open(OUTFILE,<span class="stringliteral">&quot;&gt;$file&quot;</span>)) {
<a name="l00496"></a>00496             eval {print OUTFILE $data; close(OUTFILE)};
<a name="l00497"></a>00497             <span class="keywordflow">if</span> ($@) {$self-&gt;addbadmessage(<span class="stringliteral">&quot;Failed to save: $@&quot;</span>)}
<a name="l00498"></a>00498                <span class="keywordflow">else</span> {$self-&gt;addgoodmessage(<span class="stringliteral">&quot;File saved&quot;</span>)}
<a name="l00499"></a>00499         } <span class="keywordflow">else</span> {$self-&gt;addbadmessage(<span class="stringliteral">&quot;Can&#39;t write to file: $!&quot;</span>)}
<a name="l00500"></a>00500     } <span class="keywordflow">else</span> {$data = <span class="stringliteral">&quot;&quot;</span>; $self-&gt;addbadmessage(<span class="stringliteral">&quot;Error: no file data was submitted!&quot;</span>)}
<a name="l00501"></a>00501 
<a name="l00502"></a>00502     $self-&gt;{pwd} = $pwd;
<a name="l00503"></a>00503     $self-&gt;RefreshEdit($data,$filename);
<a name="l00504"></a>00504 }
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 <span class="preprocessor">##################################################</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span><span class="preprocessor"># Save the edited file under a new name</span>
<a name="l00509"></a>00509 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00510"></a>00510 <span class="preprocessor"></span>sub SaveAs {
<a name="l00511"></a>00511     my $self = shift;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     my $newfile = $self-&gt;r-&gt;param(<span class="stringliteral">&#39;name&#39;</span>);
<a name="l00514"></a>00514     my $original = $self-&gt;r-&gt;param(<span class="stringliteral">&#39;files&#39;</span>);
<a name="l00515"></a>00515     $newfile = $self-&gt;verifyPath($newfile,$original);
<a name="l00516"></a>00516     <span class="keywordflow">if</span> ($newfile) {$self-&gt;Save($newfile); <span class="keywordflow">return</span>}
<a name="l00517"></a>00517     $self-&gt;RefreshEdit($self-&gt;r-&gt;param(<span class="stringliteral">&#39;data&#39;</span>),$original);
<a name="l00518"></a>00518 }
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="preprocessor">##################################################</span>
<a name="l00521"></a>00521 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00522"></a>00522 <span class="preprocessor"></span><span class="preprocessor"># Display the Edit page</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l00524"></a>00524 <span class="preprocessor"></span>sub RefreshEdit {
<a name="l00525"></a>00525     my $self = shift; my $data = shift; my $file = shift;
<a name="l00526"></a>00526     my $pwd = shift || $self-&gt;{pwd};
<a name="l00527"></a>00527     my $name = <span class="stringliteral">&quot;$pwd/$file&quot;</span>; $name =~ s!^\./?!!;
<a name="l00528"></a>00528 
<a name="l00529"></a>00529     my %button = (type=&gt;<span class="stringliteral">&quot;submit&quot;</span>,name=&gt;<span class="stringliteral">&quot;action&quot;</span>,style=&gt;<span class="stringliteral">&quot;width:6em&quot;</span>);
<a name="l00530"></a>00530     print CGI::p();
<a name="l00531"></a>00531     print CGI::start_table({border=&gt;0,cellspacing=&gt;0,cellpadding=&gt;2, width=&gt;<span class="stringliteral">&quot;95%&quot;</span>, align=&gt;<span class="stringliteral">&quot;center&quot;</span>});
<a name="l00532"></a>00532     print CGI::Tr([
<a name="l00533"></a>00533         CGI::td({align=&gt;<span class="stringliteral">&quot;center&quot;</span>,style=&gt;<span class="stringliteral">&quot;background-color:#CCCCCC&quot;</span>},CGI::b($name)),
<a name="l00534"></a>00534         CGI::td(CGI::textarea(-name=&gt;<span class="stringliteral">&quot;data&quot;</span>,-<span class="keywordflow">default</span>=&gt;$data,-<span class="keyword">override</span>=&gt;1,-rows=&gt;30,-columns=&gt;80,
<a name="l00535"></a>00535                 -style=&gt;<span class="stringliteral">&quot;width:100%&quot;</span>)), ## can<span class="stringliteral">&#39;t seem to get variable height to work</span>
<a name="l00536"></a>00536 <span class="stringliteral">        CGI::td({align=&gt;&quot;center&quot;, nowrap=&gt;1},</span>
<a name="l00537"></a>00537 <span class="stringliteral">            CGI::input({%button,value=&gt;&quot;Cancel&quot;}),&quot;&amp;nbsp;&quot;,</span>
<a name="l00538"></a>00538 <span class="stringliteral">            CGI::input({%button,value=&gt;&quot;Revert&quot;}),&quot;&amp;nbsp;&quot;,</span>
<a name="l00539"></a>00539 <span class="stringliteral">            CGI::input({%button,value=&gt;&quot;Save&quot;}),,&quot;&amp;nbsp;&quot;,</span>
<a name="l00540"></a>00540 <span class="stringliteral">            CGI::input({%button,value=&gt;&quot;Save As:&quot;}),</span>
<a name="l00541"></a>00541 <span class="stringliteral">            CGI::input({type=&gt;&quot;text&quot;,name=&gt;&quot;name&quot;,size=&gt;20,style=&gt;&quot;width:50%&quot;}),</span>
<a name="l00542"></a>00542 <span class="stringliteral">        ),</span>
<a name="l00543"></a>00543 <span class="stringliteral">    ]);</span>
<a name="l00544"></a>00544 <span class="stringliteral">    print CGI::end_table();</span>
<a name="l00545"></a>00545 <span class="stringliteral">    print CGI::hidden({name=&gt;&quot;files&quot;, value=&gt;$file});</span>
<a name="l00546"></a>00546 <span class="stringliteral">    $self-&gt;HiddenFlags;</span>
<a name="l00547"></a>00547 <span class="stringliteral">}</span>
<a name="l00548"></a>00548 <span class="stringliteral"></span>
<a name="l00549"></a>00549 <span class="stringliteral">##################################################</span>
<a name="l00550"></a>00550 <span class="stringliteral">#</span>
<a name="l00551"></a>00551 <span class="stringliteral"># Copy a file</span>
<a name="l00552"></a>00552 <span class="stringliteral">#</span>
<a name="l00553"></a>00553 <span class="stringliteral">sub Copy {</span>
<a name="l00554"></a>00554 <span class="stringliteral">    my $self = shift;</span>
<a name="l00555"></a>00555 <span class="stringliteral">        my $dir = &quot;$self-&gt;{courseRoot}/$self-&gt;{pwd}&quot;;</span>
<a name="l00556"></a>00556 <span class="stringliteral">    my $original = $self-&gt;getFile(&#39;</span>copy<span class="stringliteral">&#39;); return unless $original;</span>
<a name="l00557"></a>00557 <span class="stringliteral">    my $oldfile = &quot;$dir/$original&quot;;</span>
<a name="l00558"></a>00558 <span class="stringliteral"></span>
<a name="l00559"></a>00559 <span class="stringliteral">    if (-d $oldfile) {</span>
<a name="l00560"></a>00560 <span class="stringliteral">        # FIXME: need to do recursive directory copy</span>
<a name="l00561"></a>00561 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;Directory copies are not yet implemented&quot;);</span>
<a name="l00562"></a>00562 <span class="stringliteral">        $self-&gt;Refresh;</span>
<a name="l00563"></a>00563 <span class="stringliteral">        return;</span>
<a name="l00564"></a>00564 <span class="stringliteral">    }</span>
<a name="l00565"></a>00565 <span class="stringliteral"></span>
<a name="l00566"></a>00566 <span class="stringliteral">    if ($self-&gt;r-&gt;param(&#39;</span>confirmed<span class="stringliteral">&#39;)) {</span>
<a name="l00567"></a>00567 <span class="stringliteral">        my $newfile = $self-&gt;r-&gt;param(&#39;</span>name<span class="stringliteral">&#39;);</span>
<a name="l00568"></a>00568 <span class="stringliteral">        if ($newfile = $self-&gt;verifyPath($newfile,$original)) {</span>
<a name="l00569"></a>00569 <span class="stringliteral">            if (copy($oldfile, $newfile)) {</span>
<a name="l00570"></a>00570 <span class="stringliteral">                $self-&gt;addgoodmessage(&quot;File successfully copied&quot;);</span>
<a name="l00571"></a>00571 <span class="stringliteral">                $self-&gt;Refresh; return;</span>
<a name="l00572"></a>00572 <span class="stringliteral">            } else {$self-&gt;addbadmessage(&quot;Can&#39;</span>t copy file: $!<span class="stringliteral">&quot;)}</span>
<a name="l00573"></a>00573 <span class="stringliteral">        }</span>
<a name="l00574"></a>00574 <span class="stringliteral">    }</span>
<a name="l00575"></a>00575 <span class="stringliteral"></span>
<a name="l00576"></a>00576 <span class="stringliteral">    $self-&gt;Confirm(&quot;</span>Copy file as:<span class="stringliteral">&quot;,$original,&quot;</span>Copy<span class="stringliteral">&quot;);</span>
<a name="l00577"></a>00577 <span class="stringliteral">    print CGI::hidden({name=&gt;&quot;</span>files<span class="stringliteral">&quot;,value=&gt;$original});</span>
<a name="l00578"></a>00578 <span class="stringliteral">}</span>
<a name="l00579"></a>00579 <span class="stringliteral"></span>
<a name="l00580"></a>00580 <span class="stringliteral">##################################################</span>
<a name="l00581"></a>00581 <span class="stringliteral">#</span>
<a name="l00582"></a>00582 <span class="stringliteral"># Rename a file</span>
<a name="l00583"></a>00583 <span class="stringliteral">#</span>
<a name="l00584"></a>00584 <span class="stringliteral">sub Rename {</span>
<a name="l00585"></a>00585 <span class="stringliteral">    my $self = shift;</span>
<a name="l00586"></a>00586 <span class="stringliteral">        my $dir = &quot;</span>$self-&gt;{courseRoot}/$self-&gt;{pwd}<span class="stringliteral">&quot;;</span>
<a name="l00587"></a>00587 <span class="stringliteral">    my $original = $self-&gt;getFile(&#39;rename&#39;); return unless $original;</span>
<a name="l00588"></a>00588 <span class="stringliteral">    my $oldfile = &quot;</span>$dir/$original<span class="stringliteral">&quot;;</span>
<a name="l00589"></a>00589 <span class="stringliteral"></span>
<a name="l00590"></a>00590 <span class="stringliteral">    if ($self-&gt;r-&gt;param(&#39;confirmed&#39;)) {</span>
<a name="l00591"></a>00591 <span class="stringliteral">        my $newfile = $self-&gt;r-&gt;param(&#39;name&#39;);</span>
<a name="l00592"></a>00592 <span class="stringliteral">        if ($newfile = $self-&gt;verifyPath($newfile,$original)) {</span>
<a name="l00593"></a>00593 <span class="stringliteral">            if (rename $oldfile, $newfile) {</span>
<a name="l00594"></a>00594 <span class="stringliteral">                $self-&gt;addgoodmessage(&quot;</span><a class="code" href="classWeBWorK_1_1File.html">File</a> successfully renamed<span class="stringliteral">&quot;);</span>
<a name="l00595"></a>00595 <span class="stringliteral">                $self-&gt;Refresh; return;</span>
<a name="l00596"></a>00596 <span class="stringliteral">            } else {$self-&gt;addbadmessage(&quot;</span>Can<span class="stringliteral">&#39;t rename file: $!&quot;)}</span>
<a name="l00597"></a>00597 <span class="stringliteral">        }</span>
<a name="l00598"></a>00598 <span class="stringliteral">    }</span>
<a name="l00599"></a>00599 <span class="stringliteral"></span>
<a name="l00600"></a>00600 <span class="stringliteral">    $self-&gt;Confirm(&quot;Rename file as:&quot;,uniqueName($dir,$original),&quot;Rename&quot;);</span>
<a name="l00601"></a>00601 <span class="stringliteral">    print CGI::hidden({name=&gt;&quot;files&quot;,value=&gt;$original});</span>
<a name="l00602"></a>00602 <span class="stringliteral">}</span>
<a name="l00603"></a>00603 <span class="stringliteral"></span>
<a name="l00604"></a>00604 <span class="stringliteral">##################################################</span>
<a name="l00605"></a>00605 <span class="stringliteral">#</span>
<a name="l00606"></a>00606 <span class="stringliteral"># Delete a file</span>
<a name="l00607"></a>00607 <span class="stringliteral">#</span>
<a name="l00608"></a>00608 <span class="stringliteral">sub Delete {</span>
<a name="l00609"></a>00609 <span class="stringliteral">    my $self = shift;</span>
<a name="l00610"></a>00610 <span class="stringliteral">    my @files = $self-&gt;r-&gt;param(&#39;</span>files<span class="stringliteral">&#39;);</span>
<a name="l00611"></a>00611 <span class="stringliteral">    if (scalar(@files) == 0) {</span>
<a name="l00612"></a>00612 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;You must select at least one file to delete&quot;);</span>
<a name="l00613"></a>00613 <span class="stringliteral">        $self-&gt;Refresh; return;</span>
<a name="l00614"></a>00614 <span class="stringliteral">    }</span>
<a name="l00615"></a>00615 <span class="stringliteral"></span>
<a name="l00616"></a>00616 <span class="stringliteral">    my $pwd = $self-&gt;{pwd};</span>
<a name="l00617"></a>00617 <span class="stringliteral">    my $dir = $self-&gt;{courseRoot}.&#39;</span>/<span class="stringliteral">&#39;.$pwd;</span>
<a name="l00618"></a>00618 <span class="stringliteral">    if ($self-&gt;r-&gt;param(&#39;</span>confirmed<span class="stringliteral">&#39;)) {</span>
<a name="l00619"></a>00619 <span class="stringliteral"></span>
<a name="l00620"></a>00620 <span class="stringliteral">        #</span>
<a name="l00621"></a>00621 <span class="stringliteral">        # If confirmed, go ahead and delete the files</span>
<a name="l00622"></a>00622 <span class="stringliteral">        #</span>
<a name="l00623"></a>00623 <span class="stringliteral">        foreach my $file (@files) {</span>
<a name="l00624"></a>00624 <span class="stringliteral">            if (defined $self-&gt;checkPWD(&quot;$pwd/$file&quot;,1)) {</span>
<a name="l00625"></a>00625 <span class="stringliteral">                if (-d &quot;$dir/$file&quot; &amp;&amp; !-l &quot;$dir/$file&quot;) {</span>
<a name="l00626"></a>00626 <span class="stringliteral">                    my $removed = eval {rmtree(&quot;$dir/$file&quot;,0,1)};</span>
<a name="l00627"></a>00627 <span class="stringliteral">                    if ($removed) {$self-&gt;addgoodmessage(&quot;Directory &#39;</span>$file<span class="stringliteral">&#39; removed (items deleted: $removed)&quot;)}</span>
<a name="l00628"></a>00628 <span class="stringliteral">                    else {$self-&gt;addbadmessage(&quot;Directory &#39;</span>$file<span class="stringliteral">&#39; not removed: $!&quot;)}</span>
<a name="l00629"></a>00629 <span class="stringliteral">                } else {</span>
<a name="l00630"></a>00630 <span class="stringliteral">                    if (unlink(&quot;$dir/$file&quot;)) {$self-&gt;addgoodmessage(&quot;File &#39;</span>$file<span class="stringliteral">&#39; successfully removed&quot;)}</span>
<a name="l00631"></a>00631 <span class="stringliteral">                    else {$self-&gt;addbadmessage(&quot;File &#39;</span>$file<span class="stringliteral">&#39; not removed: $!&quot;)}</span>
<a name="l00632"></a>00632 <span class="stringliteral">                }</span>
<a name="l00633"></a>00633 <span class="stringliteral">            } else {$self-&gt;addbadmessage(&quot;Illegal file &#39;</span>$file<span class="stringliteral">&#39; specified&quot;); last}</span>
<a name="l00634"></a>00634 <span class="stringliteral">        }</span>
<a name="l00635"></a>00635 <span class="stringliteral">        $self-&gt;Refresh;</span>
<a name="l00636"></a>00636 <span class="stringliteral"></span>
<a name="l00637"></a>00637 <span class="stringliteral">    } else {</span>
<a name="l00638"></a>00638 <span class="stringliteral"></span>
<a name="l00639"></a>00639 <span class="stringliteral">        #</span>
<a name="l00640"></a>00640 <span class="stringliteral">        #  Look up the files to be deleted, and for directories, add / and the contents of the directory</span>
<a name="l00641"></a>00641 <span class="stringliteral">        #</span>
<a name="l00642"></a>00642 <span class="stringliteral">        my @filelist = ();</span>
<a name="l00643"></a>00643 <span class="stringliteral">        foreach my $file (@files) {</span>
<a name="l00644"></a>00644 <span class="stringliteral">            if (defined $self-&gt;checkPWD(&quot;$pwd/$file&quot;,1)) {</span>
<a name="l00645"></a>00645 <span class="stringliteral">                if (-l &quot;$dir/$file&quot;) {</span>
<a name="l00646"></a>00646 <span class="stringliteral">                    push(@filelist,&quot;$file@&quot;);</span>
<a name="l00647"></a>00647 <span class="stringliteral">                } elsif (-d &quot;$dir/$file&quot;) {</span>
<a name="l00648"></a>00648 <span class="stringliteral">                    my @contents = (); my $dcount = 0;</span>
<a name="l00649"></a>00649 <span class="stringliteral">                    foreach my $item (readDirectory(&quot;$dir/$file&quot;)) {</span>
<a name="l00650"></a>00650 <span class="stringliteral">                        next if $item eq &quot;.&quot; || $item eq &quot;..&quot;;</span>
<a name="l00651"></a>00651 <span class="stringliteral">                        if (-l &quot;$dir/$file/$item&quot;) {</span>
<a name="l00652"></a>00652 <span class="stringliteral">                            push(@contents, &quot;$item@&quot;);</span>
<a name="l00653"></a>00653 <span class="stringliteral">                        } elsif (-d &quot;$dir/$file/$item&quot;) {</span>
<a name="l00654"></a>00654 <span class="stringliteral">                            my $count = scalar(listFilesRecursive(&quot;$dir/$file/$item&quot;,&quot;.*&quot;));</span>
<a name="l00655"></a>00655 <span class="stringliteral">                            my $s = ($count == 1 ? &quot;&quot; : &quot;s&quot;); $dcount += $count;</span>
<a name="l00656"></a>00656 <span class="stringliteral">                            push (@contents, &quot;$item/&quot;.CGI::small({style=&gt;&quot;float:right;margin-right:3em&quot;},CGI::i(&quot;($count item$s)&quot;)));</span>
<a name="l00657"></a>00657 <span class="stringliteral">                        } else {</span>
<a name="l00658"></a>00658 <span class="stringliteral">                            push(@contents, $item);</span>
<a name="l00659"></a>00659 <span class="stringliteral">                        }</span>
<a name="l00660"></a>00660 <span class="stringliteral">                        $dcount += 1;</span>
<a name="l00661"></a>00661 <span class="stringliteral">                    }</span>
<a name="l00662"></a>00662 <span class="stringliteral">                    my $s = ($dcount == 1 ? &quot;&quot;: &quot;s&quot;);</span>
<a name="l00663"></a>00663 <span class="stringliteral">                    @contents = (@contents[0..10],&quot;&amp;nbsp; .&quot;,&quot;&amp;nbsp; .&quot;,&quot;&amp;nbsp; .&quot;) if scalar(@contents) &gt; 15;</span>
<a name="l00664"></a>00664 <span class="stringliteral">                    push (@filelist,$file.&quot;/&quot;.</span>
<a name="l00665"></a>00665 <span class="stringliteral">                                CGI::small({style=&gt;&quot;float:right;margin-right:4em&quot;},CGI::i(&quot;($dcount item$s total)&quot;)).</span>
<a name="l00666"></a>00666 <span class="stringliteral">                                CGI::div({style=&gt;&quot;margin-left:1ex&quot;},join(CGI::br(),@contents)));</span>
<a name="l00667"></a>00667 <span class="stringliteral">                } else {</span>
<a name="l00668"></a>00668 <span class="stringliteral">                    push(@filelist,$file);</span>
<a name="l00669"></a>00669 <span class="stringliteral">                }</span>
<a name="l00670"></a>00670 <span class="stringliteral">            }</span>
<a name="l00671"></a>00671 <span class="stringliteral">        }</span>
<a name="l00672"></a>00672 <span class="stringliteral"></span>
<a name="l00673"></a>00673 <span class="stringliteral">        #</span>
<a name="l00674"></a>00674 <span class="stringliteral">        # Put up the confirmation dialog box</span>
<a name="l00675"></a>00675 <span class="stringliteral">        #</span>
<a name="l00676"></a>00676 <span class="stringliteral">        print CGI::start_table({border=&gt;1,cellspacing=&gt;2,cellpadding=&gt;20, style=&gt;&quot;margin: 1em 0 0 5em&quot;});</span>
<a name="l00677"></a>00677 <span class="stringliteral">        print CGI::Tr(</span>
<a name="l00678"></a>00678 <span class="stringliteral">            CGI::td(</span>
<a name="l00679"></a>00679 <span class="stringliteral">              CGI::b(&quot;Warning:&quot;),&quot; You have requested that the following items be deleted\n&quot;,</span>
<a name="l00680"></a>00680 <span class="stringliteral">              CGI::ul(CGI::li(\@filelist)),</span>
<a name="l00681"></a>00681 <span class="stringliteral">                ((grep { -d &quot;$dir/$_&quot; } @files)?</span>
<a name="l00682"></a>00682 <span class="stringliteral">                     CGI::p({style=&gt;&quot;width:500&quot;},&quot;Some of these files are directories. &quot;,</span>
<a name="l00683"></a>00683 <span class="stringliteral">                                    &quot;Only delete directories if you really know what you are doing. &quot;,</span>
<a name="l00684"></a>00684 <span class="stringliteral">                                    &quot;You can seriously damage your course if you delete the wrong thing.&quot;): &quot;&quot;),</span>
<a name="l00685"></a>00685 <span class="stringliteral">              CGI::p({style=&gt;&quot;color:red&quot;},&quot;There is no undo for deleting files or directories!&quot;),</span>
<a name="l00686"></a>00686 <span class="stringliteral">              CGI::p(&quot;Really delete the items listed above?&quot;),</span>
<a name="l00687"></a>00687 <span class="stringliteral">              CGI::div({style=&gt;&quot;float:left; padding-left:3ex&quot;},</span>
<a name="l00688"></a>00688 <span class="stringliteral">                CGI::input({type=&gt;&quot;submit&quot;,name=&gt;&quot;action&quot;,value=&gt;&quot;Cancel&quot;})),</span>
<a name="l00689"></a>00689 <span class="stringliteral">              CGI::div({style=&gt;&quot;float:right; padding-right:3ex&quot;},</span>
<a name="l00690"></a>00690 <span class="stringliteral">                CGI::input({type=&gt;&quot;submit&quot;,name=&gt;&quot;action&quot;,value=&gt;&quot;Delete&quot;})),</span>
<a name="l00691"></a>00691 <span class="stringliteral">            ),</span>
<a name="l00692"></a>00692 <span class="stringliteral">        );</span>
<a name="l00693"></a>00693 <span class="stringliteral">        print CGI::end_table();</span>
<a name="l00694"></a>00694 <span class="stringliteral"></span>
<a name="l00695"></a>00695 <span class="stringliteral">        print CGI::hidden({name=&gt;&quot;confirmed&quot;,value=&gt;&quot;Delete&quot;});</span>
<a name="l00696"></a>00696 <span class="stringliteral">        foreach my $file (@files) {print CGI::hidden({name=&gt;&quot;files&quot;,value=&gt;$file})}</span>
<a name="l00697"></a>00697 <span class="stringliteral">        $self-&gt;HiddenFlags;</span>
<a name="l00698"></a>00698 <span class="stringliteral">    }</span>
<a name="l00699"></a>00699 <span class="stringliteral">}</span>
<a name="l00700"></a>00700 <span class="stringliteral"></span>
<a name="l00701"></a>00701 <span class="stringliteral">##################################################</span>
<a name="l00702"></a>00702 <span class="stringliteral">#</span>
<a name="l00703"></a>00703 <span class="stringliteral"># Make a gzipped tar archive</span>
<a name="l00704"></a>00704 <span class="stringliteral">#</span>
<a name="l00705"></a>00705 <span class="stringliteral">sub MakeArchive {</span>
<a name="l00706"></a>00706 <span class="stringliteral">    my $self = shift;</span>
<a name="l00707"></a>00707 <span class="stringliteral">    my @files = $self-&gt;r-&gt;param(&#39;</span>files<span class="stringliteral">&#39;);</span>
<a name="l00708"></a>00708 <span class="stringliteral">    if (scalar(@files) == 0) {</span>
<a name="l00709"></a>00709 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;You must select at least one file for the archive&quot;);</span>
<a name="l00710"></a>00710 <span class="stringliteral">        $self-&gt;Refresh; return;</span>
<a name="l00711"></a>00711 <span class="stringliteral">    }</span>
<a name="l00712"></a>00712 <span class="stringliteral"></span>
<a name="l00713"></a>00713 <span class="stringliteral">    my $dir = $self-&gt;{courseRoot}.&#39;</span>/<span class="stringliteral">&#39;.$self-&gt;{pwd};</span>
<a name="l00714"></a>00714 <span class="stringliteral">    my $archive = uniqueName($dir,(scalar(@files) == 1)?</span>
<a name="l00715"></a>00715 <span class="stringliteral">                 $files[0].&quot;.tgz&quot;: $self-&gt;{courseName}.&quot;.tgz&quot;);</span>
<a name="l00716"></a>00716 <span class="stringliteral">    my $tar = &quot;cd &quot;.shell_quote($dir).&quot; &amp;&amp; $self-&gt;{ce}{externalPrograms}{tar} -cvzf &quot;.shell_quote($archive,@files);</span>
<a name="l00717"></a>00717 <span class="stringliteral">    @files = readpipe $tar.&quot; 2&gt;&amp;1&quot;;</span>
<a name="l00718"></a>00718 <span class="stringliteral">    if ($? == 0) {</span>
<a name="l00719"></a>00719 <span class="stringliteral">        my $n = scalar(@files); my $s = ($n == 1? &quot;&quot;: &quot;s&quot;);</span>
<a name="l00720"></a>00720 <span class="stringliteral">        $self-&gt;addgoodmessage(&quot;Archive &#39;</span>$archive<span class="stringliteral">&#39; created successfully ($n file$s)&quot;);</span>
<a name="l00721"></a>00721 <span class="stringliteral">    } else {</span>
<a name="l00722"></a>00722 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;Can&#39;</span>t create archive <span class="stringliteral">&#39;$archive&#39;</span>: command returned <span class="stringliteral">&quot;.systemError($?));</span>
<a name="l00723"></a>00723 <span class="stringliteral">    }</span>
<a name="l00724"></a>00724 <span class="stringliteral">    $self-&gt;Refresh;</span>
<a name="l00725"></a>00725 <span class="stringliteral">}</span>
<a name="l00726"></a>00726 <span class="stringliteral"></span>
<a name="l00727"></a>00727 <span class="stringliteral">##################################################</span>
<a name="l00728"></a>00728 <span class="stringliteral">#</span>
<a name="l00729"></a>00729 <span class="stringliteral"># Unpack a gzipped tar archive</span>
<a name="l00730"></a>00730 <span class="stringliteral">#</span>
<a name="l00731"></a>00731 <span class="stringliteral">sub UnpackArchive {</span>
<a name="l00732"></a>00732 <span class="stringliteral">    my $self = shift;</span>
<a name="l00733"></a>00733 <span class="stringliteral">    my $archive = $self-&gt;getFile(&quot;</span>unpack<span class="stringliteral">&quot;); return unless $archive;</span>
<a name="l00734"></a>00734 <span class="stringliteral">    if ($archive !~ m/\.(tar|tar\.gz|tgz)$/) {</span>
<a name="l00735"></a>00735 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;</span>You can only unpack files ending in <span class="stringliteral">&#39;.tgz&#39;</span>, <span class="stringliteral">&#39;.tar&#39;</span> or <span class="stringliteral">&#39;.tar.gz&#39;</span><span class="stringliteral">&quot;);</span>
<a name="l00736"></a>00736 <span class="stringliteral">    } else {</span>
<a name="l00737"></a>00737 <span class="stringliteral">        $self-&gt;unpack($archive);</span>
<a name="l00738"></a>00738 <span class="stringliteral">    }</span>
<a name="l00739"></a>00739 <span class="stringliteral">    $self-&gt;Refresh;</span>
<a name="l00740"></a>00740 <span class="stringliteral">}</span>
<a name="l00741"></a>00741 <span class="stringliteral"></span>
<a name="l00742"></a>00742 <span class="stringliteral">sub unpack {</span>
<a name="l00743"></a>00743 <span class="stringliteral">    my $self = shift;</span>
<a name="l00744"></a>00744 <span class="stringliteral">    my $archive = shift; my $z = &#39;z&#39;; $z = &#39;&#39; if $archive =~ m/\.tar$/;</span>
<a name="l00745"></a>00745 <span class="stringliteral">    my $dir = $self-&gt;{courseRoot}.&#39;/&#39;.$self-&gt;{pwd};</span>
<a name="l00746"></a>00746 <span class="stringliteral">    my $tar = &quot;</span>cd <span class="stringliteral">&quot;.shell_quote($dir).&quot;</span> &amp;&amp; $self-&gt;{ce}{externalPrograms}{tar} -vx${z}f <span class="stringliteral">&quot;.shell_quote($archive);</span>
<a name="l00747"></a>00747 <span class="stringliteral">    my @files = readpipe $tar.&quot;</span> 2&gt;&amp;1<span class="stringliteral">&quot;;</span>
<a name="l00748"></a>00748 <span class="stringliteral">    if ($? == 0) {</span>
<a name="l00749"></a>00749 <span class="stringliteral">        my $n = scalar(@files); my $s = ($n == 1? &quot;</span><span class="stringliteral">&quot;: &quot;</span>s<span class="stringliteral">&quot;);</span>
<a name="l00750"></a>00750 <span class="stringliteral">        $self-&gt;addgoodmessage(&quot;</span>$n file$s unpacked successfully<span class="stringliteral">&quot;);</span>
<a name="l00751"></a>00751 <span class="stringliteral">        return 1;</span>
<a name="l00752"></a>00752 <span class="stringliteral">    } else {</span>
<a name="l00753"></a>00753 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;</span>Can<span class="stringliteral">&#39;t unpack &#39;</span>$archive<span class="stringliteral">&#39;: command returned &quot;.systemError($?));</span>
<a name="l00754"></a>00754 <span class="stringliteral">        return 0;</span>
<a name="l00755"></a>00755 <span class="stringliteral">    }</span>
<a name="l00756"></a>00756 <span class="stringliteral">}</span>
<a name="l00757"></a>00757 <span class="stringliteral"></span>
<a name="l00758"></a>00758 <span class="stringliteral">##################################################</span>
<a name="l00759"></a>00759 <span class="stringliteral">#</span>
<a name="l00760"></a>00760 <span class="stringliteral"># Make a new file and edit it</span>
<a name="l00761"></a>00761 <span class="stringliteral">#</span>
<a name="l00762"></a>00762 <span class="stringliteral">sub NewFile {</span>
<a name="l00763"></a>00763 <span class="stringliteral">    my $self = shift;</span>
<a name="l00764"></a>00764 <span class="stringliteral"></span>
<a name="l00765"></a>00765 <span class="stringliteral">    if ($self-&gt;r-&gt;param(&#39;</span>confirmed<span class="stringliteral">&#39;)) {</span>
<a name="l00766"></a>00766 <span class="stringliteral">        my $name = $self-&gt;r-&gt;param(&#39;</span>name<span class="stringliteral">&#39;);</span>
<a name="l00767"></a>00767 <span class="stringliteral">        if (my $file = $self-&gt;verifyName($name,&quot;file&quot;)) {</span>
<a name="l00768"></a>00768 <span class="stringliteral">            local (*NEWFILE);</span>
<a name="l00769"></a>00769 <span class="stringliteral">            if (open(NEWFILE,&quot;&gt;$file&quot;)) {</span>
<a name="l00770"></a>00770 <span class="stringliteral">                close(NEWFILE);</span>
<a name="l00771"></a>00771 <span class="stringliteral">                $self-&gt;RefreshEdit(&quot;&quot;,$name);</span>
<a name="l00772"></a>00772 <span class="stringliteral">                return;</span>
<a name="l00773"></a>00773 <span class="stringliteral">            } else {$self-&gt;addbadmessage(&quot;Can&#39;</span>t create file: $!<span class="stringliteral">&quot;)}</span>
<a name="l00774"></a>00774 <span class="stringliteral">        }</span>
<a name="l00775"></a>00775 <span class="stringliteral">    }</span>
<a name="l00776"></a>00776 <span class="stringliteral"></span>
<a name="l00777"></a>00777 <span class="stringliteral">    $self-&gt;Confirm(&quot;</span>New file name:<span class="stringliteral">&quot;,&quot;</span><span class="stringliteral">&quot;,&quot;</span>New <a class="code" href="classWeBWorK_1_1File.html">File</a><span class="stringliteral">&quot;);</span>
<a name="l00778"></a>00778 <span class="stringliteral">}</span>
<a name="l00779"></a>00779 <span class="stringliteral"></span>
<a name="l00780"></a>00780 <span class="stringliteral">##################################################</span>
<a name="l00781"></a>00781 <span class="stringliteral">#</span>
<a name="l00782"></a>00782 <span class="stringliteral"># Make a new directory</span>
<a name="l00783"></a>00783 <span class="stringliteral">#</span>
<a name="l00784"></a>00784 <span class="stringliteral">sub NewFolder {</span>
<a name="l00785"></a>00785 <span class="stringliteral">    my $self = shift;</span>
<a name="l00786"></a>00786 <span class="stringliteral"></span>
<a name="l00787"></a>00787 <span class="stringliteral">    if ($self-&gt;r-&gt;param(&#39;confirmed&#39;)) {</span>
<a name="l00788"></a>00788 <span class="stringliteral">        my $name = $self-&gt;r-&gt;param(&#39;name&#39;);</span>
<a name="l00789"></a>00789 <span class="stringliteral">        if (my $dir = $self-&gt;verifyName($name,&quot;</span>directory<span class="stringliteral">&quot;)) {</span>
<a name="l00790"></a>00790 <span class="stringliteral">            if (mkdir $dir, 0750) {</span>
<a name="l00791"></a>00791 <span class="stringliteral">                $self-&gt;{pwd} .= &#39;/&#39;.$name;</span>
<a name="l00792"></a>00792 <span class="stringliteral">                $self-&gt;Refresh; return;</span>
<a name="l00793"></a>00793 <span class="stringliteral">            } else {$self-&gt;addbadmessage(&quot;</span>Can<span class="stringliteral">&#39;t create directory: $!&quot;)}</span>
<a name="l00794"></a>00794 <span class="stringliteral">        }</span>
<a name="l00795"></a>00795 <span class="stringliteral">    }</span>
<a name="l00796"></a>00796 <span class="stringliteral"></span>
<a name="l00797"></a>00797 <span class="stringliteral">    $self-&gt;Confirm(&quot;New folder name:&quot;,&quot;&quot;,&quot;New Folder&quot;);</span>
<a name="l00798"></a>00798 <span class="stringliteral">}</span>
<a name="l00799"></a>00799 <span class="stringliteral"></span>
<a name="l00800"></a>00800 <span class="stringliteral">##################################################</span>
<a name="l00801"></a>00801 <span class="stringliteral">#</span>
<a name="l00802"></a>00802 <span class="stringliteral"># Download a file</span>
<a name="l00803"></a>00803 <span class="stringliteral">#</span>
<a name="l00804"></a>00804 <span class="stringliteral">sub Download {</span>
<a name="l00805"></a>00805 <span class="stringliteral">    my $self = shift;</span>
<a name="l00806"></a>00806 <span class="stringliteral">    my $pwd = $self-&gt;checkPWD($self-&gt;r-&gt;param(&#39;</span>pwd<span class="stringliteral">&#39;) || HOME);</span>
<a name="l00807"></a>00807 <span class="stringliteral">    return unless $pwd;</span>
<a name="l00808"></a>00808 <span class="stringliteral">    my $filename = $self-&gt;getFile(&quot;download&quot;); return unless $filename;</span>
<a name="l00809"></a>00809 <span class="stringliteral">    my $file = $self-&gt;{ce}{courseDirs}{root}.&#39;</span>/<span class="stringliteral">&#39;.$pwd.&#39;</span>/<span class="stringliteral">&#39;.$filename;</span>
<a name="l00810"></a>00810 <span class="stringliteral"></span>
<a name="l00811"></a>00811 <span class="stringliteral">    if (-d $file) {$self-&gt;addbadmessage(&quot;You can&#39;</span>t download directories<span class="stringliteral">&quot;); return}</span>
<a name="l00812"></a>00812 <span class="stringliteral">    unless (-f $file) {$self-&gt;addbadmessage(&quot;</span>You can<span class="stringliteral">&#39;t download files of that type&quot;); return}</span>
<a name="l00813"></a>00813 <span class="stringliteral"></span>
<a name="l00814"></a>00814 <span class="stringliteral">    $self-&gt;r-&gt;param(&#39;</span>download<span class="stringliteral">&#39;,$filename);</span>
<a name="l00815"></a>00815 <span class="stringliteral">}</span>
<a name="l00816"></a>00816 <span class="stringliteral"></span>
<a name="l00817"></a>00817 <span class="stringliteral">##################################################</span>
<a name="l00818"></a>00818 <span class="stringliteral">#</span>
<a name="l00819"></a>00819 <span class="stringliteral"># Upload a file to the server</span>
<a name="l00820"></a>00820 <span class="stringliteral">#</span>
<a name="l00821"></a>00821 <span class="stringliteral">sub Upload {</span>
<a name="l00822"></a>00822 <span class="stringliteral">    my $self = shift;</span>
<a name="l00823"></a>00823 <span class="stringliteral">    my $dir = &quot;$self-&gt;{courseRoot}/$self-&gt;{pwd}&quot;;</span>
<a name="l00824"></a>00824 <span class="stringliteral">    my $fileIDhash = $self-&gt;r-&gt;param(&#39;</span>file<span class="stringliteral">&#39;);</span>
<a name="l00825"></a>00825 <span class="stringliteral">    unless ($fileIDhash) {</span>
<a name="l00826"></a>00826 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;You have not chosen a file to upload.&quot;);</span>
<a name="l00827"></a>00827 <span class="stringliteral">        $self-&gt;Refresh;</span>
<a name="l00828"></a>00828 <span class="stringliteral">        return;</span>
<a name="l00829"></a>00829 <span class="stringliteral">    }</span>
<a name="l00830"></a>00830 <span class="stringliteral"></span>
<a name="l00831"></a>00831 <span class="stringliteral">    my ($id,$hash) = split(/\s+/,$fileIDhash);</span>
<a name="l00832"></a>00832 <span class="stringliteral">    my $upload = WeBWorK::Upload-&gt;retrieve($id,$hash,dir=&gt;$self-&gt;{ce}{webworkDirs}{uploadCache});</span>
<a name="l00833"></a>00833 <span class="stringliteral"></span>
<a name="l00834"></a>00834 <span class="stringliteral">    my $name = checkName($upload-&gt;filename);</span>
<a name="l00835"></a>00835 <span class="stringliteral">    my $action = $self-&gt;r-&gt;param(&quot;formAction&quot;) || &quot;Cancel&quot;;</span>
<a name="l00836"></a>00836 <span class="stringliteral">    if ($self-&gt;r-&gt;param(&quot;confirmed&quot;)) {</span>
<a name="l00837"></a>00837 <span class="stringliteral">        if ($action eq &quot;Cancel&quot;) {</span>
<a name="l00838"></a>00838 <span class="stringliteral">            $upload-&gt;dispose;</span>
<a name="l00839"></a>00839 <span class="stringliteral">            $self-&gt;Refresh;</span>
<a name="l00840"></a>00840 <span class="stringliteral">            return;</span>
<a name="l00841"></a>00841 <span class="stringliteral">        }</span>
<a name="l00842"></a>00842 <span class="stringliteral">        $name = checkName($self-&gt;r-&gt;param(&#39;</span>name<span class="stringliteral">&#39;)) if ($action eq &quot;Rename&quot;);</span>
<a name="l00843"></a>00843 <span class="stringliteral">    }</span>
<a name="l00844"></a>00844 <span class="stringliteral"></span>
<a name="l00845"></a>00845 <span class="stringliteral">    if (-e &quot;$dir/$name&quot;) {</span>
<a name="l00846"></a>00846 <span class="stringliteral">        unless ($self-&gt;r-&gt;param(&#39;</span>overwrite<span class="stringliteral">&#39;) || $action eq &quot;Overwrite&quot;) {</span>
<a name="l00847"></a>00847 <span class="stringliteral">            $self-&gt;Confirm(&quot;File &quot;.CGI::b($name).&quot; already exists. Overwrite it, or rename it as:&quot;.</span>
<a name="l00848"></a>00848 <span class="stringliteral">                       CGI::p(),uniqueName($dir,$name),&quot;Rename&quot;,&quot;Overwrite&quot;);</span>
<a name="l00849"></a>00849 <span class="stringliteral">            print CGI::hidden({name=&gt;&quot;action&quot;,value=&gt;&quot;Upload&quot;});</span>
<a name="l00850"></a>00850 <span class="stringliteral">            print CGI::hidden({name=&gt;&quot;file&quot;,value=&gt;$fileIDhash});</span>
<a name="l00851"></a>00851 <span class="stringliteral">            return;</span>
<a name="l00852"></a>00852 <span class="stringliteral">        }</span>
<a name="l00853"></a>00853 <span class="stringliteral">    }</span>
<a name="l00854"></a>00854 <span class="stringliteral">    $self-&gt;checkFileLocation($name,$self-&gt;{pwd});</span>
<a name="l00855"></a>00855 <span class="stringliteral"></span>
<a name="l00856"></a>00856 <span class="stringliteral">    my $file = &quot;$dir/$name&quot;;</span>
<a name="l00857"></a>00857 <span class="stringliteral">    my $type = $self-&gt;getFlag(&#39;</span>format<span class="charliteral">&#39;,&#39;</span>Automatic<span class="stringliteral">&#39;);</span>
<a name="l00858"></a>00858 <span class="stringliteral">    my $data;</span>
<a name="l00859"></a>00859 <span class="stringliteral">    </span>
<a name="l00860"></a>00860 <span class="stringliteral">    #</span>
<a name="l00861"></a>00861 <span class="stringliteral">    #  Check if we need to convert linebreaks</span>
<a name="l00862"></a>00862 <span class="stringliteral">    #</span>
<a name="l00863"></a>00863 <span class="stringliteral">    if ($type ne &#39;</span>Binary<span class="stringliteral">&#39;) {</span>
<a name="l00864"></a>00864 <span class="stringliteral">        my $fh = $upload-&gt;fileHandle;</span>
<a name="l00865"></a>00865 <span class="stringliteral">        my @lines = &lt;$fh&gt;; $data = join(&#39;</span><span class="stringliteral">&#39;,@lines);</span>
<a name="l00866"></a>00866 <span class="stringliteral">        if ($type eq &#39;</span>Automatic<span class="stringliteral">&#39;) {$type = isText($data) ? &#39;</span>Text<span class="stringliteral">&#39; : &#39;</span>Binary<span class="stringliteral">&#39;}</span>
<a name="l00867"></a>00867 <span class="stringliteral">    }</span>
<a name="l00868"></a>00868 <span class="stringliteral">    if ($type eq &#39;</span>Text<span class="stringliteral">&#39;) {</span>
<a name="l00869"></a>00869 <span class="stringliteral">        $upload-&gt;dispose;</span>
<a name="l00870"></a>00870 <span class="stringliteral">        $data =~ s/\r\n?/\n/g;</span>
<a name="l00871"></a>00871 <span class="stringliteral">        if (open(UPLOAD,&quot;&gt;$file&quot;)) {print UPLOAD $data; close(UPLOAD)}</span>
<a name="l00872"></a>00872 <span class="stringliteral">          else {$self-&gt;addbadmessage(&quot;Can&#39;</span>t create file <span class="stringliteral">&#39;$name&#39;</span>: $!<span class="stringliteral">&quot;)}</span>
<a name="l00873"></a>00873 <span class="stringliteral">    } else {</span>
<a name="l00874"></a>00874 <span class="stringliteral">        $upload-&gt;disposeTo($file);</span>
<a name="l00875"></a>00875 <span class="stringliteral">    }</span>
<a name="l00876"></a>00876 <span class="stringliteral"></span>
<a name="l00877"></a>00877 <span class="stringliteral">    if (-e $file) {</span>
<a name="l00878"></a>00878 <span class="stringliteral">      $self-&gt;addgoodmessage(&quot;</span>$type file <span class="stringliteral">&#39;$name&#39;</span> uploaded successfully<span class="stringliteral">&quot;);</span>
<a name="l00879"></a>00879 <span class="stringliteral">      if ($name =~ m/\.(tar|tar\.gz|tgz)$/ &amp;&amp; $self-&gt;getFlag(&#39;unpack&#39;)) {</span>
<a name="l00880"></a>00880 <span class="stringliteral">        if ($self-&gt;unpack($name) &amp;&amp; $self-&gt;getFlag(&#39;autodelete&#39;)) {</span>
<a name="l00881"></a>00881 <span class="stringliteral">          if (unlink($file)) {$self-&gt;addgoodmessage(&quot;</span>Archive <span class="stringliteral">&#39;$name&#39;</span> deleted<span class="stringliteral">&quot;)}</span>
<a name="l00882"></a>00882 <span class="stringliteral">            else {$self-&gt;addbadmessage(&quot;</span>Can<span class="stringliteral">&#39;t delete archive &#39;</span>$name<span class="stringliteral">&#39;: $!&quot;)}</span>
<a name="l00883"></a>00883 <span class="stringliteral">        }</span>
<a name="l00884"></a>00884 <span class="stringliteral">      }</span>
<a name="l00885"></a>00885 <span class="stringliteral">    }</span>
<a name="l00886"></a>00886 <span class="stringliteral"></span>
<a name="l00887"></a>00887 <span class="stringliteral">    $self-&gt;Refresh;</span>
<a name="l00888"></a>00888 <span class="stringliteral">}</span>
<a name="l00889"></a>00889 <span class="stringliteral"></span>
<a name="l00890"></a>00890 <span class="stringliteral">##################################################</span>
<a name="l00891"></a>00891 <span class="stringliteral">##################################################</span>
<a name="l00892"></a>00892 <span class="stringliteral">#</span>
<a name="l00893"></a>00893 <span class="stringliteral"># Print a confirmation dialog box</span>
<a name="l00894"></a>00894 <span class="stringliteral">#</span>
<a name="l00895"></a>00895 <span class="stringliteral">sub Confirm {</span>
<a name="l00896"></a>00896 <span class="stringliteral">    my $self = shift;</span>
<a name="l00897"></a>00897 <span class="stringliteral">    my $message = shift; my $value = shift;</span>
<a name="l00898"></a>00898 <span class="stringliteral">    my $button = shift; my $button2 = shift;</span>
<a name="l00899"></a>00899 <span class="stringliteral"></span>
<a name="l00900"></a>00900 <span class="stringliteral">    print CGI::p();</span>
<a name="l00901"></a>00901 <span class="stringliteral">    print CGI::start_table({border=&gt;1,cellspacing=&gt;2,cellpadding=&gt;20, style=&gt;&quot;margin: 1em 0 0 3em&quot;});</span>
<a name="l00902"></a>00902 <span class="stringliteral">    print CGI::Tr(</span>
<a name="l00903"></a>00903 <span class="stringliteral">        CGI::td({align=&gt;&quot;CENTER&quot;},</span>
<a name="l00904"></a>00904 <span class="stringliteral">          $message,</span>
<a name="l00905"></a>00905 <span class="stringliteral">          CGI::input({type=&gt;&quot;text&quot;,name=&gt;&quot;name&quot;,size=&gt;50,value=&gt;$value}),</span>
<a name="l00906"></a>00906 <span class="stringliteral">          CGI::p(), CGI::center(</span>
<a name="l00907"></a>00907 <span class="stringliteral">            CGI::div({style=&gt;&quot;float:right; padding-right:3ex&quot;},</span>
<a name="l00908"></a>00908 <span class="stringliteral">              CGI::input({type=&gt;&quot;submit&quot;,name=&gt;&quot;formAction&quot;,value=&gt;$button})), # this will be the default</span>
<a name="l00909"></a>00909 <span class="stringliteral">            CGI::div({style=&gt;&quot;float:left; padding-left:3ex&quot;},</span>
<a name="l00910"></a>00910 <span class="stringliteral">            CGI::input({type=&gt;&quot;submit&quot;,name=&gt;&quot;formAction&quot;,value=&gt;&quot;Cancel&quot;})),</span>
<a name="l00911"></a>00911 <span class="stringliteral">            ($button2 ? CGI::input({type=&gt;&quot;submit&quot;,name=&gt;&quot;formAction&quot;,value=&gt;$button2}): ()),</span>
<a name="l00912"></a>00912 <span class="stringliteral">          ),</span>
<a name="l00913"></a>00913 <span class="stringliteral">        ),</span>
<a name="l00914"></a>00914 <span class="stringliteral">          );</span>
<a name="l00915"></a>00915 <span class="stringliteral">    print CGI::end_table();</span>
<a name="l00916"></a>00916 <span class="stringliteral">    print CGI::hidden({name=&gt;&quot;confirmed&quot;, value=&gt;$button});</span>
<a name="l00917"></a>00917 <span class="stringliteral">    $self-&gt;HiddenFlags;</span>
<a name="l00918"></a>00918 <span class="stringliteral">    print CGI::script(&quot;window.document.FileManager.name.focus()&quot;);</span>
<a name="l00919"></a>00919 <span class="stringliteral">}</span>
<a name="l00920"></a>00920 <span class="stringliteral"></span>
<a name="l00921"></a>00921 <span class="stringliteral">##################################################</span>
<a name="l00922"></a>00922 <span class="stringliteral">##################################################</span>
<a name="l00923"></a>00923 <span class="stringliteral">#</span>
<a name="l00924"></a>00924 <span class="stringliteral"># Check that there is exactly one valid file</span>
<a name="l00925"></a>00925 <span class="stringliteral">#</span>
<a name="l00926"></a>00926 <span class="stringliteral">sub getFile {</span>
<a name="l00927"></a>00927 <span class="stringliteral">    my $self = shift; my $action = shift;</span>
<a name="l00928"></a>00928 <span class="stringliteral">    my @files = $self-&gt;r-&gt;param(&quot;files&quot;);</span>
<a name="l00929"></a>00929 <span class="stringliteral">    if (scalar(@files) &gt; 1) {</span>
<a name="l00930"></a>00930 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;You can only $action one file at a time.&quot;);</span>
<a name="l00931"></a>00931 <span class="stringliteral">        $self-&gt;Refresh unless $action eq &#39;</span>download<span class="stringliteral">&#39;;</span>
<a name="l00932"></a>00932 <span class="stringliteral">        return;</span>
<a name="l00933"></a>00933 <span class="stringliteral">    }</span>
<a name="l00934"></a>00934 <span class="stringliteral">    if (scalar(@files) == 0 || $files[0] eq &quot;&quot;) {</span>
<a name="l00935"></a>00935 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;You need to select a file to $action.&quot;);</span>
<a name="l00936"></a>00936 <span class="stringliteral">        $self-&gt;Refresh unless $action eq &#39;</span>download<span class="stringliteral">&#39;;</span>
<a name="l00937"></a>00937 <span class="stringliteral">        return;</span>
<a name="l00938"></a>00938 <span class="stringliteral">    }</span>
<a name="l00939"></a>00939 <span class="stringliteral">    my $pwd = $self-&gt;checkPWD($self-&gt;{pwd} || $self-&gt;r-&gt;param(&#39;</span>pwd<span class="stringliteral">&#39;) || HOME) || &#39;</span>.<span class="stringliteral">&#39;;</span>
<a name="l00940"></a>00940 <span class="stringliteral">    if ($self-&gt;isSymLink($pwd.&#39;</span>/<span class="stringliteral">&#39;.$files[0])) {</span>
<a name="l00941"></a>00941 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;That symbolic link takes you outside your course directory&quot;);</span>
<a name="l00942"></a>00942 <span class="stringliteral">        $self-&gt;Refresh unless $action eq &#39;</span>download<span class="stringliteral">&#39;;</span>
<a name="l00943"></a>00943 <span class="stringliteral">        return;</span>
<a name="l00944"></a>00944 <span class="stringliteral">    }</span>
<a name="l00945"></a>00945 <span class="stringliteral">    unless ($self-&gt;checkPWD($pwd.&#39;</span>/<span class="stringliteral">&#39;.$files[0],1)) {</span>
<a name="l00946"></a>00946 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;You have specified an illegal file&quot;);</span>
<a name="l00947"></a>00947 <span class="stringliteral">        $self-&gt;Refresh unless $action eq &#39;</span>download<span class="stringliteral">&#39;;</span>
<a name="l00948"></a>00948 <span class="stringliteral">        return;</span>
<a name="l00949"></a>00949 <span class="stringliteral">    }</span>
<a name="l00950"></a>00950 <span class="stringliteral">    return $files[0];</span>
<a name="l00951"></a>00951 <span class="stringliteral">}</span>
<a name="l00952"></a>00952 <span class="stringliteral"></span>
<a name="l00953"></a>00953 <span class="stringliteral">##################################################</span>
<a name="l00954"></a>00954 <span class="stringliteral">#</span>
<a name="l00955"></a>00955 <span class="stringliteral"># Get the entries for the directory menu</span>
<a name="l00956"></a>00956 <span class="stringliteral">#</span>
<a name="l00957"></a>00957 <span class="stringliteral">sub directoryMenu {</span>
<a name="l00958"></a>00958 <span class="stringliteral">    my $course = shift;</span>
<a name="l00959"></a>00959 <span class="stringliteral">    my $dir  = shift; $dir =~ s!^\.(/|$)!!;</span>
<a name="l00960"></a>00960 <span class="stringliteral">    my @dirs = split(&#39;</span>/<span class="stringliteral">&#39;,$dir);</span>
<a name="l00961"></a>00961 <span class="stringliteral">    my $menu = &quot;&quot;; my $pwd;</span>
<a name="l00962"></a>00962 <span class="stringliteral">    </span>
<a name="l00963"></a>00963 <span class="stringliteral">    my (@values,%labels);</span>
<a name="l00964"></a>00964 <span class="stringliteral">    while (scalar(@dirs)) {</span>
<a name="l00965"></a>00965 <span class="stringliteral">        $pwd = join(&#39;</span>/<span class="stringliteral">&#39;,(@dirs)[0..$#dirs]);</span>
<a name="l00966"></a>00966 <span class="stringliteral">        $dir = pop(@dirs);</span>
<a name="l00967"></a>00967 <span class="stringliteral">        push(@values,$pwd); $labels{$pwd} = $dir;</span>
<a name="l00968"></a>00968 <span class="stringliteral">    }</span>
<a name="l00969"></a>00969 <span class="stringliteral">    push(@values,&#39;</span>.<span class="stringliteral">&#39;); $labels{&#39;</span>.<span class="stringliteral">&#39;} = $course;</span>
<a name="l00970"></a>00970 <span class="stringliteral">    return (\@values,\%labels);</span>
<a name="l00971"></a>00971 <span class="stringliteral">}</span>
<a name="l00972"></a>00972 <span class="stringliteral"></span>
<a name="l00973"></a>00973 <span class="stringliteral">##################################################</span>
<a name="l00974"></a>00974 <span class="stringliteral">#</span>
<a name="l00975"></a>00975 <span class="stringliteral"># Get the directory listing</span>
<a name="l00976"></a>00976 <span class="stringliteral">#</span>
<a name="l00977"></a>00977 <span class="stringliteral">sub directoryListing {</span>
<a name="l00978"></a>00978 <span class="stringliteral">    my $root = shift; my $pwd = shift; my $showdates = shift;</span>
<a name="l00979"></a>00979 <span class="stringliteral">    my $dir = $root.&#39;</span>/<span class="stringliteral">&#39;.$pwd;</span>
<a name="l00980"></a>00980 <span class="stringliteral">    my (@values,%labels,$size,$data);</span>
<a name="l00981"></a>00981 <span class="stringliteral"></span>
<a name="l00982"></a>00982 <span class="stringliteral">    return unless -d $dir;</span>
<a name="l00983"></a>00983 <span class="stringliteral">        my $len = 24;</span>
<a name="l00984"></a>00984 <span class="stringliteral">    my @names = sortByName(undef,grep(/^[^.]/,readDirectory($dir)));</span>
<a name="l00985"></a>00985 <span class="stringliteral">    foreach my $name (@names) {</span>
<a name="l00986"></a>00986 <span class="stringliteral">        unless ($name eq &#39;</span>DATA<span class="stringliteral">&#39;) {   #FIXME don&#39;</span>t view the DATA directory
<a name="l00987"></a>00987             my $file = <span class="stringliteral">&quot;$dir/$name&quot;</span>;
<a name="l00988"></a>00988             push(@values,$name); $labels{$name} = $name;
<a name="l00989"></a>00989             $labels{$name} .= <span class="charliteral">&#39;@&#39;</span> <span class="keywordflow">if</span> (-l $file);
<a name="l00990"></a>00990             $labels{$name} .= <span class="charliteral">&#39;/&#39;</span> <span class="keywordflow">if</span> (-d $file &amp;&amp; !-l $file);
<a name="l00991"></a>00991             $len = length($labels{$name}) <span class="keywordflow">if</span> length($labels{$name}) &gt; $len;
<a name="l00992"></a>00992         }
<a name="l00993"></a>00993     }
<a name="l00994"></a>00994     <span class="keywordflow">if</span> ($showdates) {
<a name="l00995"></a>00995         $len += 3;
<a name="l00996"></a>00996         <span class="keywordflow">foreach</span> my $name (@values) {
<a name="l00997"></a>00997             my $file = <span class="stringliteral">&quot;$dir/$name&quot;</span>;
<a name="l00998"></a>00998             my ($size,$date) = (lstat($file))[7,9];
<a name="l00999"></a>00999             $labels{$name} = sprintf(<span class="stringliteral">&quot;%-${len}s%-16s%10s&quot;</span>,$labels{$name},
<a name="l01000"></a>01000                          ((-d $file)? (<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;&quot;</span>):
<a name="l01001"></a>01001                           (getDate($date),getSize($size))));
<a name="l01002"></a>01002         }
<a name="l01003"></a>01003     }
<a name="l01004"></a>01004     <span class="keywordflow">return</span> (\@values,\%labels);
<a name="l01005"></a>01005 }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007 sub getDate {
<a name="l01008"></a>01008   my ($sec,$min,$hour,$day,$month,$year) = localtime(shift);
<a name="l01009"></a>01009   sprintf(<span class="stringliteral">&quot;%02d-%02d-%04d %02d:%02d&quot;</span>,$month+1,$day,$year+1900,$hour,$min);
<a name="l01010"></a>01010 }
<a name="l01011"></a>01011 
<a name="l01012"></a>01012 sub getSize {
<a name="l01013"></a>01013   my $size = shift;
<a name="l01014"></a>01014   <span class="keywordflow">return</span> $size.<span class="stringliteral">&quot; B &quot;</span>                        <span class="keywordflow">if</span> $size &lt; 1024;
<a name="l01015"></a>01015   <span class="keywordflow">return</span> sprintf(<span class="stringliteral">&quot;%.1f KB&quot;</span>,$size/1024)      if $size &lt; 1024*100;
<a name="l01016"></a>01016   return sprintf(&quot;%d KB&quot;,<span class="keywordtype">int</span>($size/1024))   if $size &lt; 1024*1024;
<a name="l01017"></a>01017   return sprintf(&quot;%.1f MB&quot;,$size/1024/1024) if $size &lt; 1024*1024*100;
<a name="l01018"></a>01018   return sprintf(&quot;%d MB&quot;,$size/1024/1024);
<a name="l01019"></a>01019 }
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 <span class="preprocessor">##################################################</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01023"></a>01023 <span class="preprocessor"></span><span class="preprocessor">#  Check if a file is a symbolic link that we</span>
<a name="l01024"></a>01024 <span class="preprocessor"></span><span class="preprocessor">#  are not allowed to follow.</span>
<a name="l01025"></a>01025 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01026"></a>01026 <span class="preprocessor"></span>sub isSymLink {
<a name="l01027"></a>01027     my $self = shift; my $file = shift;
<a name="l01028"></a>01028     <span class="keywordflow">return</span> 0 unless -l $file;
<a name="l01029"></a>01029 
<a name="l01030"></a>01030     my $courseRoot = $self-&gt;{ce}{courseDirs}{root};
<a name="l01031"></a>01031     $courseRoot = readlink($courseRoot) if -l $courseRoot;
<a name="l01032"></a>01032     my $pwd = $self-&gt;{pwd} || $self-&gt;r-&gt;param(<span class="stringliteral">&#39;pwd&#39;</span>) || HOME;
<a name="l01033"></a>01033     my $link = File::Spec-&gt;rel2abs(readlink($file),<span class="stringliteral">&quot;$courseRoot/$pwd&quot;</span>);
<a name="l01034"></a>01034 <span class="preprocessor">    #</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span><span class="preprocessor">    # Remove /./ and dir/../ constructs</span>
<a name="l01036"></a>01036 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01037"></a>01037 <span class="preprocessor"></span>    $link =~ s!(^|/)(\.(/|$))+!$1!g;
<a name="l01038"></a>01038     <span class="keywordflow">while</span> ($link =~ s!((\.[^./]+|\.\.[^/]+|[^./][^/]*)/\.\.(/|$))!!) {};
<a name="l01039"></a>01039 
<a name="l01040"></a>01040 <span class="preprocessor">    #</span>
<a name="l01041"></a>01041 <span class="preprocessor"></span><span class="preprocessor">    # Link is OK if it is in the course directory</span>
<a name="l01042"></a>01042 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01043"></a>01043 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> substr($link,0,length($courseRoot)) eq $courseRoot;
<a name="l01044"></a>01044 
<a name="l01045"></a>01045     <span class="preprocessor">#</span>
<a name="l01046"></a>01046 <span class="preprocessor"></span><span class="preprocessor">    # Look through the list of valid paths to see if this link is OK</span>
<a name="l01047"></a>01047 <span class="preprocessor"></span><span class="preprocessor">    #</span>
<a name="l01048"></a>01048 <span class="preprocessor"></span>    my $valid = $self-&gt;{ce}{webworkDirs}{valid_symlinks};
<a name="l01049"></a>01049     <span class="keywordflow">if</span> (defined $valid &amp;&amp; $valid) {
<a name="l01050"></a>01050         <span class="keywordflow">foreach</span> my $path (@{$valid}) {
<a name="l01051"></a>01051             <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> substr($link,0,length($path)) eq $path;
<a name="l01052"></a>01052         }
<a name="l01053"></a>01053     }
<a name="l01054"></a>01054 
<a name="l01055"></a>01055     return 1;
<a name="l01056"></a>01056 }
<a name="l01057"></a>01057 
<a name="l01058"></a>01058 <span class="preprocessor">##################################################</span>
<a name="l01059"></a>01059 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01060"></a>01060 <span class="preprocessor"></span><span class="preprocessor"># Normalize the working directory and check if it is OK.</span>
<a name="l01061"></a>01061 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01062"></a>01062 <span class="preprocessor"></span>sub checkPWD {
<a name="l01063"></a>01063     my $self = shift;
<a name="l01064"></a>01064     my $pwd = shift;
<a name="l01065"></a>01065     my $renameError = shift;
<a name="l01066"></a>01066 
<a name="l01067"></a>01067     $pwd =~ s!<span class="comment">//+!/!g;               # remove duplicate slashes</span>
<a name="l01068"></a>01068     $pwd =~ s!(^|/)~!$1_!g;          # <span class="keyword">remove</span> ~user references
<a name="l01069"></a>01069     $pwd =~ s!(^|/)(\.(/|$))+!$1!g;  # <span class="keyword">remove</span> dot directories
<a name="l01070"></a>01070     
<a name="l01071"></a>01071 <span class="preprocessor">    # remove dir/.. constructions</span>
<a name="l01072"></a>01072 <span class="preprocessor"></span>    <span class="keywordflow">while</span> ($pwd =~ s!((\.[^./]+|\.\.[^/]+|[^./][^/]*)/\.\.(/|$))!!) {};
<a name="l01073"></a>01073     
<a name="l01074"></a>01074     $pwd =~ s!/$!!;                        # <span class="keyword">remove</span> trailing /
<a name="l01075"></a>01075     <span class="keywordflow">return</span> <span class="keywordflow">if</span> ($pwd =~ m!(^|/)\.\.(/|$)!); # Error <span class="keywordflow">if</span> outside the root
<a name="l01076"></a>01076 
<a name="l01077"></a>01077 <span class="preprocessor">    # check for bad symbolic links</span>
<a name="l01078"></a>01078 <span class="preprocessor"></span>    my @dirs = split(<span class="charliteral">&#39;/&#39;</span>,$pwd);
<a name="l01079"></a>01079     pop(@dirs) if $renameError;      <span class="preprocessor"># don&#39;t check file iteself in this case</span>
<a name="l01080"></a>01080 <span class="preprocessor"></span>    my @path = ($self-&gt;{ce}{courseDirs}{root});
<a name="l01081"></a>01081     <span class="keywordflow">foreach</span> my $dir (@dirs) {
<a name="l01082"></a>01082         push @path,$dir;
<a name="l01083"></a>01083         <span class="keywordflow">return</span> <span class="keywordflow">if</span> ($self-&gt;isSymLink(join(<span class="charliteral">&#39;/&#39;</span>,@path)));
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086     my $original = $pwd;
<a name="l01087"></a>01087     $pwd =~ s!(^|/)\.!$1_!g;         # don<span class="stringliteral">&#39;t enter hidden directories</span>
<a name="l01088"></a>01088 <span class="stringliteral">    $pwd =~ s!^/!!;                  # remove leading /</span>
<a name="l01089"></a>01089 <span class="stringliteral">    $pwd =~ s![^-_./A-Z0-9~, ]!_!gi; # no illegal characters</span>
<a name="l01090"></a>01090 <span class="stringliteral">    return if $renameError &amp;&amp; $original ne $pwd;</span>
<a name="l01091"></a>01091 <span class="stringliteral"></span>
<a name="l01092"></a>01092 <span class="stringliteral">    $pwd = &#39;</span>.<span class="stringliteral">&#39; if $pwd eq &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l01093"></a>01093 <span class="stringliteral">    return $pwd;</span>
<a name="l01094"></a>01094 <span class="stringliteral">}</span>
<a name="l01095"></a>01095 <span class="stringliteral"></span>
<a name="l01096"></a>01096 <span class="stringliteral">##################################################</span>
<a name="l01097"></a>01097 <span class="stringliteral">#</span>
<a name="l01098"></a>01098 <span class="stringliteral"># Check that a file is uploaded to the correct directory</span>
<a name="l01099"></a>01099 <span class="stringliteral">#</span>
<a name="l01100"></a>01100 <span class="stringliteral">sub checkFileLocation {</span>
<a name="l01101"></a>01101 <span class="stringliteral">    my $self = shift;</span>
<a name="l01102"></a>01102 <span class="stringliteral">    my $extension = shift; $extension =~ s/.*\.//;</span>
<a name="l01103"></a>01103 <span class="stringliteral">    my $dir = shift; my $location = $uploadDir{$extension};</span>
<a name="l01104"></a>01104 <span class="stringliteral">    return unless defined($location);</span>
<a name="l01105"></a>01105 <span class="stringliteral">    return if $dir =~ m/^$location$/;</span>
<a name="l01106"></a>01106 <span class="stringliteral">    $location =~ s!/\.\*!!;</span>
<a name="l01107"></a>01107 <span class="stringliteral">    return if $dir =~ m/^$location$/;</span>
<a name="l01108"></a>01108 <span class="stringliteral">    $self-&gt;addbadmessage(&quot;Files with extension &#39;</span>.$extension<span class="stringliteral">&#39; usually belong in &#39;</span>$location<span class="stringliteral">&#39;&quot;);</span>
<a name="l01109"></a>01109 <span class="stringliteral">}</span>
<a name="l01110"></a>01110 <span class="stringliteral"></span>
<a name="l01111"></a>01111 <span class="stringliteral">##################################################</span>
<a name="l01112"></a>01112 <span class="stringliteral">#</span>
<a name="l01113"></a>01113 <span class="stringliteral"># Check a name for bad characters, etc.</span>
<a name="l01114"></a>01114 <span class="stringliteral">#</span>
<a name="l01115"></a>01115 <span class="stringliteral">sub checkName {</span>
<a name="l01116"></a>01116 <span class="stringliteral">    my $file = shift;</span>
<a name="l01117"></a>01117 <span class="stringliteral">    $file =~ s!.*[/\\]!!;               # remove directory</span>
<a name="l01118"></a>01118 <span class="stringliteral">    $file =~ s/[^-_.a-zA-Z0-9 ]/_/g;    # no illegal characters</span>
<a name="l01119"></a>01119 <span class="stringliteral">    $file =~ s/^\./_/;                  # no initial dot</span>
<a name="l01120"></a>01120 <span class="stringliteral">    $file = &quot;newfile.txt&quot; unless $file; # no blank names</span>
<a name="l01121"></a>01121 <span class="stringliteral">    return $file;</span>
<a name="l01122"></a>01122 <span class="stringliteral">}</span>
<a name="l01123"></a>01123 <span class="stringliteral"></span>
<a name="l01124"></a>01124 <span class="stringliteral">##################################################</span>
<a name="l01125"></a>01125 <span class="stringliteral">#</span>
<a name="l01126"></a>01126 <span class="stringliteral"># Get a unique name (in case it already exists)</span>
<a name="l01127"></a>01127 <span class="stringliteral">#</span>
<a name="l01128"></a>01128 <span class="stringliteral">sub uniqueName {</span>
<a name="l01129"></a>01129 <span class="stringliteral">    my $dir = shift; my $name = shift;</span>
<a name="l01130"></a>01130 <span class="stringliteral">    return $name unless (-e &quot;$dir/$name&quot;);</span>
<a name="l01131"></a>01131 <span class="stringliteral">    my $type = &quot;&quot;; my $n = 1;</span>
<a name="l01132"></a>01132 <span class="stringliteral">    $type = $1 if ($name =~ s/(\.[^.]*)$//);</span>
<a name="l01133"></a>01133 <span class="stringliteral">    $n = $1 if ($name =~ s/_(\d+)$/_/);</span>
<a name="l01134"></a>01134 <span class="stringliteral">    while (-e &quot;$dir/${name}_$n$type&quot;) {$n++}</span>
<a name="l01135"></a>01135 <span class="stringliteral">    return &quot;${name}_$n$type&quot;;</span>
<a name="l01136"></a>01136 <span class="stringliteral">}</span>
<a name="l01137"></a>01137 <span class="stringliteral"></span>
<a name="l01138"></a>01138 <span class="stringliteral">##################################################</span>
<a name="l01139"></a>01139 <span class="stringliteral">#</span>
<a name="l01140"></a>01140 <span class="stringliteral"># Verify that a name can be added to the current</span>
<a name="l01141"></a>01141 <span class="stringliteral"># directory.</span>
<a name="l01142"></a>01142 <span class="stringliteral">#</span>
<a name="l01143"></a>01143 <span class="stringliteral">sub verifyName {</span>
<a name="l01144"></a>01144 <span class="stringliteral">    my $self = shift; my $name = shift; my $object = shift;</span>
<a name="l01145"></a>01145 <span class="stringliteral">    if ($name) {</span>
<a name="l01146"></a>01146 <span class="stringliteral">        unless ($name =~ m!/!) {</span>
<a name="l01147"></a>01147 <span class="stringliteral">            unless ($name =~ m!^\.!) {</span>
<a name="l01148"></a>01148 <span class="stringliteral">                unless ($name =~ m![^-_.a-zA-Z0-9 ]!) {</span>
<a name="l01149"></a>01149 <span class="stringliteral">                    my $file = &quot;$self-&gt;{courseRoot}/$self-&gt;{pwd}/$name&quot;;</span>
<a name="l01150"></a>01150 <span class="stringliteral">                    return $file unless (-e $file);</span>
<a name="l01151"></a>01151 <span class="stringliteral">                    $self-&gt;addbadmessage(&quot;A file with that name already exists&quot;);</span>
<a name="l01152"></a>01152 <span class="stringliteral">                } else {$self-&gt;addbadmessage(&quot;Your $object name contains illegal characters&quot;)}</span>
<a name="l01153"></a>01153 <span class="stringliteral">            } else {$self-&gt;addbadmessage(&quot;Your $object name may not begin with a dot&quot;)}</span>
<a name="l01154"></a>01154 <span class="stringliteral">        } else {$self-&gt;addbadmessage(&quot;Your $object name may not contain a path component&quot;)}</span>
<a name="l01155"></a>01155 <span class="stringliteral">    } else {$self-&gt;addbadmessage(&quot;You must specify a $object name&quot;)}</span>
<a name="l01156"></a>01156 <span class="stringliteral">    return</span>
<a name="l01157"></a>01157 <span class="stringliteral">}</span>
<a name="l01158"></a>01158 <span class="stringliteral"></span>
<a name="l01159"></a>01159 <span class="stringliteral">##################################################</span>
<a name="l01160"></a>01160 <span class="stringliteral">#</span>
<a name="l01161"></a>01161 <span class="stringliteral"># Verify that a file path is valid</span>
<a name="l01162"></a>01162 <span class="stringliteral">#</span>
<a name="l01163"></a>01163 <span class="stringliteral">sub verifyPath {</span>
<a name="l01164"></a>01164 <span class="stringliteral">    my $self = shift; my $path = shift; my $name = shift;</span>
<a name="l01165"></a>01165 <span class="stringliteral"></span>
<a name="l01166"></a>01166 <span class="stringliteral">    if ($path) {</span>
<a name="l01167"></a>01167 <span class="stringliteral">        unless ($path =~ m![^-_.a-zA-Z0-9 /]!) {</span>
<a name="l01168"></a>01168 <span class="stringliteral">            unless ($path =~ m!^/!) {</span>
<a name="l01169"></a>01169 <span class="stringliteral">                $path = $self-&gt;checkPWD($self-&gt;{pwd}.&#39;</span>/<span class="stringliteral">&#39;.$path,1);</span>
<a name="l01170"></a>01170 <span class="stringliteral">                if ($path) {</span>
<a name="l01171"></a>01171 <span class="stringliteral">                    $path = $self-&gt;{courseRoot}.&#39;</span>/<span class="stringliteral">&#39;.$path;</span>
<a name="l01172"></a>01172 <span class="stringliteral">                    $path .= &#39;</span>/<span class="stringliteral">&#39;.$name if -d $path &amp;&amp; $name;</span>
<a name="l01173"></a>01173 <span class="stringliteral">                    return $path unless (-e $path);</span>
<a name="l01174"></a>01174 <span class="stringliteral">                    $self-&gt;addbadmessage(&quot;A file with that name already exists&quot;);</span>
<a name="l01175"></a>01175 <span class="stringliteral">                } else {$self-&gt;addbadmessage(&quot;You have specified an illegal path&quot;)}</span>
<a name="l01176"></a>01176 <span class="stringliteral">            } else {$self-&gt;addbadmessage(&quot;You can not specify an absolute path&quot;)}</span>
<a name="l01177"></a>01177 <span class="stringliteral">        } else {$self-&gt;addbadmessage(&quot;Your file name contains illegal characters&quot;)}</span>
<a name="l01178"></a>01178 <span class="stringliteral">    } else {$self-&gt;addbadmessage(&quot;You must specify a file name&quot;)}</span>
<a name="l01179"></a>01179 <span class="stringliteral">    return</span>
<a name="l01180"></a>01180 <span class="stringliteral">}</span>
<a name="l01181"></a>01181 <span class="stringliteral"></span>
<a name="l01182"></a>01182 <span class="stringliteral">##################################################</span>
<a name="l01183"></a>01183 <span class="stringliteral">#</span>
<a name="l01184"></a>01184 <span class="stringliteral"># Get the value of a parameter flag</span>
<a name="l01185"></a>01185 <span class="stringliteral">#</span>
<a name="l01186"></a>01186 <span class="stringliteral">sub getFlag {</span>
<a name="l01187"></a>01187 <span class="stringliteral">  my $self = shift; my $flag = shift;</span>
<a name="l01188"></a>01188 <span class="stringliteral">  my $default = shift; $default = 0 unless defined $default;</span>
<a name="l01189"></a>01189 <span class="stringliteral">  my $value = $self-&gt;r-&gt;param($flag);</span>
<a name="l01190"></a>01190 <span class="stringliteral">  $value = $default unless defined $value;</span>
<a name="l01191"></a>01191 <span class="stringliteral">  return $value;</span>
<a name="l01192"></a>01192 <span class="stringliteral">}</span>
<a name="l01193"></a>01193 <span class="stringliteral"></span>
<a name="l01194"></a>01194 <span class="stringliteral">##################################################</span>
<a name="l01195"></a>01195 <span class="stringliteral">#</span>
<a name="l01196"></a>01196 <span class="stringliteral"># Make HTML symbols printable</span>
<a name="l01197"></a>01197 <span class="stringliteral">#</span>
<a name="l01198"></a>01198 <span class="stringliteral">sub showHTML {</span>
<a name="l01199"></a>01199 <span class="stringliteral">    my $string = shift;</span>
<a name="l01200"></a>01200 <span class="stringliteral">    return &#39;</span><span class="stringliteral">&#39; unless defined $string;</span>
<a name="l01201"></a>01201 <span class="stringliteral">    $string =~ s/&amp;/\&amp;amp;/g;</span>
<a name="l01202"></a>01202 <span class="stringliteral">    $string =~ s/&lt;/\&amp;lt;/g;</span>
<a name="l01203"></a>01203 <span class="stringliteral">    $string =~ s/&gt;/\&amp;gt;/g;</span>
<a name="l01204"></a>01204 <span class="stringliteral">    $string;</span>
<a name="l01205"></a>01205 <span class="stringliteral">}</span>
<a name="l01206"></a>01206 <span class="stringliteral"></span>
<a name="l01207"></a>01207 <span class="stringliteral">##################################################</span>
<a name="l01208"></a>01208 <span class="stringliteral">#</span>
<a name="l01209"></a>01209 <span class="stringliteral"># Check if a string is plain text</span>
<a name="l01210"></a>01210 <span class="stringliteral"># (i.e., doesn&#39;</span>t contain four non-regular
<a name="l01211"></a>01211 <span class="preprocessor"># characters in a row.)</span>
<a name="l01212"></a>01212 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01213"></a>01213 <span class="preprocessor"></span>sub isText {
<a name="l01214"></a>01214     my $string = shift;
<a name="l01215"></a>01215     <span class="keywordflow">return</span> $string !~ m/[^\s\x20-\x7E]{4}/;
<a name="l01216"></a>01216 }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218 <span class="preprocessor">##################################################</span>
<a name="l01219"></a>01219 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01220"></a>01220 <span class="preprocessor"></span><span class="preprocessor">#  Convert spaces to &amp;nbsp;, but only REAL spaces</span>
<a name="l01221"></a>01221 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01222"></a>01222 <span class="preprocessor"></span>sub sp2nbsp {
<a name="l01223"></a>01223     my $s = shift;
<a name="l01224"></a>01224     $s =~ s/ /\&amp;nbsp;/g;
<a name="l01225"></a>01225     <span class="keywordflow">return</span> $s;
<a name="l01226"></a>01226 }
<a name="l01227"></a>01227 
<a name="l01228"></a>01228 <span class="preprocessor">##################################################</span>
<a name="l01229"></a>01229 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01230"></a>01230 <span class="preprocessor"></span><span class="preprocessor">#  Hack to convert multiple spaces in the file</span>
<a name="l01231"></a>01231 <span class="preprocessor"></span><span class="preprocessor">#  selection box into &amp;nbsp; so that the columns</span>
<a name="l01232"></a>01232 <span class="preprocessor"></span><span class="preprocessor">#  will allign properly in fixed-width fonts.</span>
<a name="l01233"></a>01233 <span class="preprocessor"></span><span class="preprocessor">#  We have to do it agter the fact, since CGI::</span>
<a name="l01234"></a>01234 <span class="preprocessor"></span><span class="preprocessor">#  is being &quot;helpful&quot; by turning &amp; in the labels</span>
<a name="l01235"></a>01235 <span class="preprocessor"></span><span class="preprocessor">#  into &amp;amp; for us.  So we have to convert</span>
<a name="l01236"></a>01236 <span class="preprocessor"></span><span class="preprocessor">#  after the &lt;SELECT&gt; is created (ugh).</span>
<a name="l01237"></a>01237 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01238"></a>01238 <span class="preprocessor"></span>sub fixSpaces {
<a name="l01239"></a>01239     my $s = shift;
<a name="l01240"></a>01240     $s =~ s!(&lt;option[^&gt;]*&gt;)(.*?)(&lt;/option&gt;)!$1.sp2nbsp($2).$3!gei;
<a name="l01241"></a>01241     <span class="keywordflow">return</span> $s;
<a name="l01242"></a>01242 }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244 <span class="preprocessor">##################################################</span>
<a name="l01245"></a>01245 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01246"></a>01246 <span class="preprocessor"></span><span class="preprocessor">#  Interpret command return errors</span>
<a name="l01247"></a>01247 <span class="preprocessor"></span><span class="preprocessor">#</span>
<a name="l01248"></a>01248 <span class="preprocessor"></span>sub systemError {
<a name="l01249"></a>01249   my $status = shift;
<a name="l01250"></a>01250   <span class="keywordflow">return</span> <span class="stringliteral">&quot;error: $!&quot;</span> <span class="keywordflow">if</span> $status == 0xFF00;
<a name="l01251"></a>01251   <span class="keywordflow">return</span> <span class="stringliteral">&quot;exit status &quot;</span>.($status &gt;&gt; 8) <span class="keywordflow">if</span> ($status &amp; 0xFF) == 0;
<a name="l01252"></a>01252   <span class="keywordflow">return</span> <span class="stringliteral">&quot;signal &quot;</span>.($status &amp;= ~0x80);
<a name="l01253"></a>01253 }
<a name="l01254"></a>01254 
<a name="l01255"></a>01255 <span class="preprocessor">##################################################</span>
<a name="l01256"></a>01256 <span class="preprocessor"></span>
<a name="l01257"></a>01257 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:34 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
