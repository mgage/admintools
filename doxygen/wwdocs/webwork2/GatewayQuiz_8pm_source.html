<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: GatewayQuiz.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>GatewayQuiz.pm</h1><a href="GatewayQuiz_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright © 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/GatewayQuiz.pm,v 1.54 2008/07/01 13:12:56 glarose Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 <span class="keyword">package </span>WeBWorK::ContentGenerator::GatewayQuiz;
<a name="l00018"></a>00018 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator.html">WeBWorK::ContentGenerator</a>);
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 =head1 NAME
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html">WeBWorK::ContentGenerator::GatewayQuiz</a> - display a quiz of problems on one page,
<a name="l00023"></a>00023 deal with versioning sets
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 =cut
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 use strict;
<a name="l00028"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1GatewayQuiz.html">00028</a> use warnings;
<a name="l00029"></a>00029 <span class="preprocessor">#use CGI qw(-nosticky );</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00031"></a>00031 use File::Path qw(rmtree);
<a name="l00032"></a>00032 use <a class="code" href="classWeBWorK_1_1Form.html">WeBWorK::Form</a>;
<a name="l00033"></a>00033 use <a class="code" href="classWeBWorK_1_1PG.html">WeBWorK::PG</a>;
<a name="l00034"></a>00034 use WeBWorK::PG::ImageGenerator;
<a name="l00035"></a>00035 use WeBWorK::PG::IO;
<a name="l00036"></a>00036 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(writeLog writeCourseLog encodeAnswers decodeAnswers
<a name="l00037"></a>00037     ref2string makeTempDirectory path_is_subdir sortByName before after
<a name="l00038"></a>00038     between);  # use the <a class="code" href="classWeBWorK_1_1ContentGenerator.html">ContentGenerator</a> formatDateTime, not the version in <a class="code" href="classWeBWorK_1_1Utils.html">Utils</a>
<a name="l00039"></a>00039 use <a class="code" href="classWeBWorK_1_1DB_1_1Utils.html">WeBWorK::DB::Utils</a> qw(global2user user2global);
<a name="l00040"></a>00040 use <a class="code" href="classWeBWorK_1_1Utils_1_1Tasks.html">WeBWorK::Utils::Tasks</a> qw(fake_set fake_set_version fake_problem);
<a name="l00041"></a>00041 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00042"></a>00042 use <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">WeBWorK::ContentGenerator::Instructor</a> qw(assignSetVersionToUser);
<a name="l00043"></a>00043 use PGrandom;
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor"># template method</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>sub templateName {
<a name="l00047"></a>00047     <span class="keywordflow">return</span> <span class="stringliteral">&quot;gateway&quot;</span>;
<a name="l00048"></a>00048 }
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="preprocessor">################################################################################</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span><span class="preprocessor"># &quot;can&quot; methods</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055 <span class="preprocessor"># Subroutines to determine if a user &quot;can&quot; perform an action. Each subroutine is</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor"># called with the following arguments:</span>
<a name="l00057"></a>00057 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="preprocessor">#     ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem)</span>
<a name="l00059"></a>00059 <span class="preprocessor"></span>
<a name="l00060"></a>00060 <span class="preprocessor"># *** The &quot;can&quot; routines are taken from Problem.pm, with small modifications</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor"># *** to look at number of attempts per version, not per set, and to allow</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span><span class="preprocessor"># *** showing of correct answers after all attempts at a version are used</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span>
<a name="l00064"></a>00064 sub can_showOldAnswers {
<a name="l00065"></a>00065     my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem, $tmplSet ) = @_;
<a name="l00066"></a>00066     my $authz = $self-&gt;r-&gt;authz;
<a name="l00067"></a>00067 <span class="preprocessor"># we&#39;d like to use &quot;! $Set-&gt;hide_work()&quot;, but that hides students&#39; work </span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor"># as they&#39;re working on the set, which isn&#39;t quite right.  so use instead:</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>    <span class="keywordflow">return</span>( before( $Set-&gt;due_date() ) || 
<a name="l00070"></a>00070         
<a name="l00071"></a>00071         $authz-&gt;hasPermissions($User-&gt;user_id,<span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
<a name="l00072"></a>00072         ( $Set-&gt;hide_work() eq <span class="charliteral">&#39;N&#39;</span> || 
<a name="l00073"></a>00073           ( $Set-&gt;hide_work() eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp; time &gt; $tmplSet-&gt;answer_date ) ) );
<a name="l00074"></a>00074 }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="preprocessor"># gateway change here: add $submitAnswers as an optional additional argument</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#   to be included if it&#39;s defined</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span>sub can_showCorrectAnswers {
<a name="l00079"></a>00079     my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem, 
<a name="l00080"></a>00080         $tmplSet, $submitAnswers) = @_;
<a name="l00081"></a>00081     my $authz = $self-&gt;r-&gt;authz;
<a name="l00082"></a>00082     
<a name="l00083"></a>00083 <span class="preprocessor"># gateway change here to allow correct answers to be viewed after all attempts</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span><span class="preprocessor">#   at a version are exhausted as well as if it&#39;s after the answer date</span>
<a name="l00085"></a>00085 <span class="preprocessor"></span><span class="preprocessor"># $addOne allows us to count the current submission</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span>    my $addOne = defined( $submitAnswers ) ? $submitAnswers : 0;
<a name="l00087"></a>00087     my $maxAttempts = $Set-&gt;attempts_per_version() || 0;
<a name="l00088"></a>00088     my $attemptsUsed = $Problem-&gt;num_correct + $Problem-&gt;num_incorrect + 
<a name="l00089"></a>00089         $addOne || 0;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="preprocessor"># this is complicated by trying to address hiding scores by problem---that</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">#    is, if $set-&gt;hide_score_by_problem and $set-&gt;hide_score are both set, </span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">#    then we should allow scores to be shown, but not show the score on </span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">#    any individual problem.  to deal with this, we make </span>
<a name="l00095"></a>00095 <span class="preprocessor"></span><span class="preprocessor">#    can_showCorrectAnswers give the least restrictive view of hiding, and </span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="preprocessor">#    then filter scores for the problems themselves later</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>    my $canShowScores = ( $Set-&gt;hide_score eq <span class="charliteral">&#39;N&#39;</span> ||
<a name="l00098"></a>00098                   $Set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;Y&#39;</span> ||
<a name="l00099"></a>00099                   ( $Set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp;
<a name="l00100"></a>00100                 after($tmplSet-&gt;answer_date) ) );
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     <span class="keywordflow">return</span> ( ( ( after( $Set-&gt;answer_date ) || 
<a name="l00103"></a>00103              ( $attemptsUsed &gt;= $maxAttempts &amp;&amp; 
<a name="l00104"></a>00104                $Set-&gt;due_date() == $Set-&gt;answer_date() ) ) ||
<a name="l00105"></a>00105            $authz-&gt;hasPermissions($User-&gt;user_id, 
<a name="l00106"></a>00106                 <span class="stringliteral">&quot;show_correct_answers_before_answer_date&quot;</span>) ) &amp;&amp;
<a name="l00107"></a>00107          ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
<a name="l00108"></a>00108            $canShowScores ) );
<a name="l00109"></a>00109 }
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 sub can_showHints {
<a name="l00112"></a>00112 <span class="preprocessor">    #my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem) = @_;</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>    
<a name="l00114"></a>00114     <span class="keywordflow">return</span> 1;
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="preprocessor"># gateway change here: add $submitAnswers as an optional additional argument</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span><span class="preprocessor">#   to be included if it&#39;s defined</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span>sub can_showSolutions {
<a name="l00120"></a>00120     my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem, 
<a name="l00121"></a>00121         $tmplSet, $submitAnswers) = @_;
<a name="l00122"></a>00122     my $authz = $self-&gt;r-&gt;authz;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124 <span class="preprocessor"># this is the same as can_showCorrectAnswers    </span>
<a name="l00125"></a>00125 <span class="preprocessor"></span><span class="preprocessor"># gateway change here to allow correct answers to be viewed after all attempts</span>
<a name="l00126"></a>00126 <span class="preprocessor"></span><span class="preprocessor">#   at a version are exhausted as well as if it&#39;s after the answer date</span>
<a name="l00127"></a>00127 <span class="preprocessor"></span><span class="preprocessor"># $addOne allows us to count the current submission</span>
<a name="l00128"></a>00128 <span class="preprocessor"></span>    my $addOne = defined( $submitAnswers ) ? $submitAnswers : 0;
<a name="l00129"></a>00129     my $attempts_per_version = $Set-&gt;attempts_per_version() || 0;
<a name="l00130"></a>00130     my $attemptsUsed = $Problem-&gt;num_correct+$Problem-&gt;num_incorrect+$addOne || 0;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132 <span class="preprocessor"># this is complicated by trying to address hiding scores by problem---that</span>
<a name="l00133"></a>00133 <span class="preprocessor"></span><span class="preprocessor">#    is, if $set-&gt;hide_score_by_problem and $set-&gt;hide_score are both set, </span>
<a name="l00134"></a>00134 <span class="preprocessor"></span><span class="preprocessor">#    then we should allow scores to be shown, but not show the score on </span>
<a name="l00135"></a>00135 <span class="preprocessor"></span><span class="preprocessor">#    any individual problem.  to deal with this, we make can_showSolutions </span>
<a name="l00136"></a>00136 <span class="preprocessor"></span><span class="preprocessor">#    give the least restrictive view of hiding, and then filter scores for </span>
<a name="l00137"></a>00137 <span class="preprocessor"></span><span class="preprocessor">#    the problems themselves later</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>    my $canShowScores = ( $Set-&gt;hide_score eq <span class="charliteral">&#39;N&#39;</span> ||
<a name="l00139"></a>00139                   $Set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;Y&#39;</span> ||
<a name="l00140"></a>00140                   ( $Set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp;
<a name="l00141"></a>00141                 after($tmplSet-&gt;answer_date) ) );
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     <span class="keywordflow">return</span> ( ( ( after( $Set-&gt;answer_date ) || 
<a name="l00144"></a>00144              ( $attemptsUsed &gt;= $attempts_per_version &amp;&amp; 
<a name="l00145"></a>00145                $Set-&gt;due_date() == $Set-&gt;answer_date() ) ) ||
<a name="l00146"></a>00146            $authz-&gt;hasPermissions($User-&gt;user_id, 
<a name="l00147"></a>00147                 <span class="stringliteral">&quot;show_correct_answers_before_answer_date&quot;</span>) ) &amp;&amp;
<a name="l00148"></a>00148          ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
<a name="l00149"></a>00149            $canShowScores ) );
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 
<a name="l00152"></a>00152 <span class="preprocessor"># gateway change here: add $submitAnswers as an optional additional argument</span>
<a name="l00153"></a>00153 <span class="preprocessor"></span><span class="preprocessor">#   to be included if it&#39;s defined</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span><span class="preprocessor"># we also allow for a version_last_attempt_time which is the time the set was</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span><span class="preprocessor">#   submitted; if that&#39;s present we use that instead of the current time to </span>
<a name="l00156"></a>00156 <span class="preprocessor"></span><span class="preprocessor">#   decide if we can record the answers.  this deals with the time between the </span>
<a name="l00157"></a>00157 <span class="preprocessor"></span><span class="preprocessor">#   submission time and the proctor authorization.</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>sub can_recordAnswers {
<a name="l00159"></a>00159     my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem, 
<a name="l00160"></a>00160         $tmplSet, $submitAnswers) = @_;
<a name="l00161"></a>00161     my $authz = $self-&gt;r-&gt;authz;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <span class="preprocessor"># easy first case: never record answers for undefined sets</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span>    <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> ( $Set-&gt;set_id eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> );
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     my $timeNow = ( defined($self-&gt;{timeNow}) ) ? $self-&gt;{timeNow} : time();
<a name="l00167"></a>00167 <span class="preprocessor">   # get the sag time after the due date in which we&#39;ll still grade the test</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span>    my $grace = $self-&gt;{ce}-&gt;{gatewayGracePeriod};
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     my $submitTime = ( defined($Set-&gt;version_last_attempt_time()) &amp;&amp;
<a name="l00171"></a>00171                $Set-&gt;version_last_attempt_time() ) ? 
<a name="l00172"></a>00172                $Set-&gt;version_last_attempt_time() : $timeNow;
<a name="l00173"></a>00173 
<a name="l00174"></a>00174     <span class="keywordflow">if</span> ($User-&gt;user_id ne $EffectiveUser-&gt;user_id) {
<a name="l00175"></a>00175         my $recordAsOther = $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_when_acting_as_student&quot;</span>);
<a name="l00176"></a>00176         my $recordVersionsAsOther = $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_set_version_answers_when_acting_as_student&quot;</span>);
<a name="l00177"></a>00177 
<a name="l00178"></a>00178         <span class="keywordflow">if</span> ( $recordAsOther ) {
<a name="l00179"></a>00179             <span class="keywordflow">return</span> $recordAsOther;
<a name="l00180"></a>00180         } elsif ( ! $recordVersionsAsOther ) {
<a name="l00181"></a>00181             <span class="keywordflow">return</span> $recordVersionsAsOther;
<a name="l00182"></a>00182         }
<a name="l00183"></a>00183 <span class="preprocessor">        ## if we&#39;re not allowed to record answers as another user,</span>
<a name="l00184"></a>00184 <span class="preprocessor"></span><span class="preprocessor">        ##    return that permission.  if we&#39;re allowed to record</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span><span class="preprocessor">        ##    only set version answers, then we allow that between</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span><span class="preprocessor">        ##    the open and close dates, and so drop out of this</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span><span class="preprocessor">        ##    conditional to the usual one.</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span><span class="preprocessor">        ## it isn&#39;t clear if this is the correct behavior, but I</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span><span class="preprocessor">        ##    think it&#39;s probably reasonable.</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span>    }
<a name="l00191"></a>00191 
<a name="l00192"></a>00192     <span class="keywordflow">if</span> (before($Set-&gt;open_date, $submitTime)) {
<a name="l00193"></a>00193 <span class="preprocessor">        #    warn(&quot;case 0\n&quot;);</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>        <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_before_open_date&quot;</span>);
<a name="l00195"></a>00195     } elsif (between($Set-&gt;open_date, ($Set-&gt;due_date + $grace), $submitTime)) {
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 <span class="preprocessor"># gateway change here; we look at maximum attempts per version, not for the set,</span>
<a name="l00198"></a>00198 <span class="preprocessor"></span><span class="preprocessor">#   to determine the number of attempts allowed</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span><span class="preprocessor"># $addOne allows us to count the current submission</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>        my $addOne = ( defined( $submitAnswers ) &amp;&amp; $submitAnswers ) ? 
<a name="l00201"></a>00201         1 : 0;
<a name="l00202"></a>00202         my $attempts_per_version = $Set-&gt;attempts_per_version() || 0;
<a name="l00203"></a>00203         my $attempts_used = $Problem-&gt;num_correct+$Problem-&gt;num_incorrect+$addOne;
<a name="l00204"></a>00204         <span class="keywordflow">if</span> ($attempts_per_version == -1 or $attempts_used &lt; $attempts_per_version) {
<a name="l00205"></a>00205             <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_open_date_with_attempts&quot;</span>);
<a name="l00206"></a>00206         } <span class="keywordflow">else</span> {
<a name="l00207"></a>00207             <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_open_date_without_attempts&quot;</span>);
<a name="l00208"></a>00208         }
<a name="l00209"></a>00209     } elsif (between(($Set-&gt;due_date + $grace), $Set-&gt;answer_date, $submitTime)) {
<a name="l00210"></a>00210         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_due_date&quot;</span>);
<a name="l00211"></a>00211     } elsif (after($Set-&gt;answer_date, $submitTime)) {
<a name="l00212"></a>00212         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;record_answers_after_answer_date&quot;</span>);
<a name="l00213"></a>00213     }
<a name="l00214"></a>00214 }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216 <span class="preprocessor"># gateway change here: add $submitAnswers as an optional additional argument</span>
<a name="l00217"></a>00217 <span class="preprocessor"></span><span class="preprocessor">#   to be included if it&#39;s defined</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span><span class="preprocessor"># we also allow for a version_last_attempt_time which is the time the set was</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span><span class="preprocessor">#   submitted; if that&#39;s present we use that instead of the current time to </span>
<a name="l00220"></a>00220 <span class="preprocessor"></span><span class="preprocessor">#   decide if we can check the answers.  this deals with the time between the </span>
<a name="l00221"></a>00221 <span class="preprocessor"></span><span class="preprocessor">#   submission time and the proctor authorization.</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>sub can_checkAnswers {
<a name="l00223"></a>00223     my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem,
<a name="l00224"></a>00224         $tmplSet, $submitAnswers) = @_;
<a name="l00225"></a>00225     my $authz = $self-&gt;r-&gt;authz;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227     my $timeNow = ( defined($self-&gt;{timeNow}) ) ? $self-&gt;{timeNow} : time();
<a name="l00228"></a>00228 <span class="preprocessor">   # get the sag time after the due date in which we&#39;ll still grade the test</span>
<a name="l00229"></a>00229 <span class="preprocessor"></span>    my $grace = $self-&gt;{ce}-&gt;{gatewayGracePeriod};
<a name="l00230"></a>00230     
<a name="l00231"></a>00231     my $submitTime = ( defined($Set-&gt;version_last_attempt_time()) &amp;&amp;
<a name="l00232"></a>00232                $Set-&gt;version_last_attempt_time() ) ? 
<a name="l00233"></a>00233                $Set-&gt;version_last_attempt_time() : $timeNow;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235 <span class="preprocessor">    # this is further complicated by trying to address hiding scores by </span>
<a name="l00236"></a>00236 <span class="preprocessor"></span><span class="preprocessor">    #    problem---that is, if $set-&gt;hide_score_by_problem and </span>
<a name="l00237"></a>00237 <span class="preprocessor"></span><span class="preprocessor">    #    $set-&gt;hide_score are both set, then we should allow scores to </span>
<a name="l00238"></a>00238 <span class="preprocessor"></span><span class="preprocessor">    #    be shown, but not show the score on any individual problem.  </span>
<a name="l00239"></a>00239 <span class="preprocessor"></span><span class="preprocessor">    #    to deal with this, we use the least restrictive view of hiding </span>
<a name="l00240"></a>00240 <span class="preprocessor"></span><span class="preprocessor">    #    here, and then filter for the problems themselves later</span>
<a name="l00241"></a>00241 <span class="preprocessor"></span>    my $canShowScores = ( $Set-&gt;hide_score eq <span class="charliteral">&#39;N&#39;</span> ||
<a name="l00242"></a>00242                   $Set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;Y&#39;</span> ||
<a name="l00243"></a>00243                   ( $Set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp;
<a name="l00244"></a>00244                 after($tmplSet-&gt;answer_date) ) );
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (before($Set-&gt;open_date, $submitTime)) {
<a name="l00247"></a>00247         <span class="keywordflow">return</span> $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_before_open_date&quot;</span>);
<a name="l00248"></a>00248     } elsif (between($Set-&gt;open_date, ($Set-&gt;due_date + $grace), $submitTime)) {
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 <span class="preprocessor"># gateway change here; we look at maximum attempts per version, not for the set,</span>
<a name="l00251"></a>00251 <span class="preprocessor"></span><span class="preprocessor">#   to determine the number of attempts allowed</span>
<a name="l00252"></a>00252 <span class="preprocessor"></span><span class="preprocessor"># $addOne allows us to count the current submission</span>
<a name="l00253"></a>00253 <span class="preprocessor"></span>        my $addOne = (defined( $submitAnswers ) &amp;&amp; $submitAnswers) ? 
<a name="l00254"></a>00254         1 : 0;
<a name="l00255"></a>00255         my $attempts_per_version = $Set-&gt;attempts_per_version()||0;
<a name="l00256"></a>00256         my $attempts_used = $Problem-&gt;num_correct+$Problem-&gt;num_incorrect+$addOne;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <span class="keywordflow">if</span> ($attempts_per_version == -1 or $attempts_used &lt; $attempts_per_version) {
<a name="l00259"></a>00259             <span class="keywordflow">return</span> ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_open_date_with_attempts&quot;</span>) &amp;&amp;
<a name="l00260"></a>00260                  ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
<a name="l00261"></a>00261                    $canShowScores ) );
<a name="l00262"></a>00262         } <span class="keywordflow">else</span> {
<a name="l00263"></a>00263             <span class="keywordflow">return</span> ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_open_date_without_attempts&quot;</span>) &amp;&amp; 
<a name="l00264"></a>00264                  ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
<a name="l00265"></a>00265                    $canShowScores ) );
<a name="l00266"></a>00266         }
<a name="l00267"></a>00267     } elsif (between(($Set-&gt;due_date + $grace), $Set-&gt;answer_date, $submitTime)) {
<a name="l00268"></a>00268         <span class="keywordflow">return</span> ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_due_date&quot;</span>)  &amp;&amp;
<a name="l00269"></a>00269              ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
<a name="l00270"></a>00270                $canShowScores ) );
<a name="l00271"></a>00271     } elsif (after($Set-&gt;answer_date, $submitTime)) {
<a name="l00272"></a>00272         <span class="keywordflow">return</span> ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;check_answers_after_answer_date&quot;</span>) &amp;&amp;
<a name="l00273"></a>00273              ( $authz-&gt;hasPermissions($User-&gt;user_id, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
<a name="l00274"></a>00274                $canShowScores ) );
<a name="l00275"></a>00275     }
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278 sub can_showScore {
<a name="l00279"></a>00279     my ($self, $User, $PermissionLevel, $EffectiveUser, $Set, $Problem,
<a name="l00280"></a>00280         $tmplSet, $submitAnswers) = @_;
<a name="l00281"></a>00281     my $authz = $self-&gt;r-&gt;authz;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     my $timeNow = ( defined($self-&gt;{timeNow}) ) ? $self-&gt;{timeNow} : time();
<a name="l00284"></a>00284 
<a name="l00285"></a>00285 <span class="preprocessor">    # address hiding scores by problem</span>
<a name="l00286"></a>00286 <span class="preprocessor"></span>    my $canShowScores = ( $Set-&gt;hide_score eq <span class="charliteral">&#39;N&#39;</span> ||
<a name="l00287"></a>00287                   $Set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;Y&#39;</span> ||
<a name="l00288"></a>00288                   ( $Set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp;
<a name="l00289"></a>00289                 after($tmplSet-&gt;answer_date) ) );
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">return</span>( $authz-&gt;hasPermissions($User-&gt;user_id,<span class="stringliteral">&quot;view_hidden_work&quot;</span>) ||
<a name="l00292"></a>00292         $canShowScores );
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="preprocessor">################################################################################</span>
<a name="l00296"></a>00296 <span class="preprocessor"></span><span class="preprocessor"># output utilities</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00298"></a>00298 <span class="preprocessor"></span>
<a name="l00299"></a>00299 <span class="preprocessor"># subroutine is modified from that in Problem.pm to produce a different </span>
<a name="l00300"></a>00300 <span class="preprocessor"></span><span class="preprocessor">#    table format</span>
<a name="l00301"></a>00301 <span class="preprocessor"></span>sub attemptResults {
<a name="l00302"></a>00302     my $self = shift;
<a name="l00303"></a>00303     my $pg = shift;
<a name="l00304"></a>00304     my $showAttemptAnswers = shift;
<a name="l00305"></a>00305     my $showCorrectAnswers = shift;
<a name="l00306"></a>00306     my $showAttemptResults = $showAttemptAnswers &amp;&amp; shift;
<a name="l00307"></a>00307     my $showSummary = shift;
<a name="l00308"></a>00308     my $showAttemptPreview = shift || 0;
<a name="l00309"></a>00309     
<a name="l00310"></a>00310     my $r = $self-&gt;{r};
<a name="l00311"></a>00311     my $setName = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l00312"></a>00312     my $ce = $self-&gt;{ce};
<a name="l00313"></a>00313     my $root = $ce-&gt;{webworkURLs}-&gt;{root};
<a name="l00314"></a>00314     my $courseName = $ce-&gt;{courseName};
<a name="l00315"></a>00315     my @links = (<span class="stringliteral">&quot;Homework Sets&quot;</span> , <span class="stringliteral">&quot;$root/$courseName&quot;</span>, <span class="stringliteral">&quot;navUp&quot;</span>);
<a name="l00316"></a>00316     my $tail = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00317"></a>00317     
<a name="l00318"></a>00318     my $problemResult = $pg-&gt;{result}; # the overall result of the problem
<a name="l00319"></a>00319     my @answerNames = @{ $pg-&gt;{flags}-&gt;{ANSWER_ENTRY_ORDER} };
<a name="l00320"></a>00320     
<a name="l00321"></a>00321     my $showMessages = $showAttemptAnswers &amp;&amp; grep { $pg-&gt;{answers}-&gt;{$_}-&gt;{ans_message} } @answerNames;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323 <span class="preprocessor">  # present in ver 1.10; why is this checked here?</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span><span class="preprocessor">    #   return CGI::p(CGI::font({-color=&gt;&quot;red&quot;}, &quot;This problem is not available because the homework set that contains it is not yet open.&quot;))</span>
<a name="l00325"></a>00325 <span class="preprocessor"></span><span class="preprocessor">    #   unless $self-&gt;{isOpen};</span>
<a name="l00326"></a>00326 <span class="preprocessor"></span>
<a name="l00327"></a>00327     my $basename = <span class="stringliteral">&quot;equation-&quot;</span> . $self-&gt;{<span class="keyword">set</span>}-&gt;psvn. <span class="stringliteral">&quot;.&quot;</span> . $self-&gt;{problem}-&gt;problem_id . <span class="stringliteral">&quot;-preview&quot;</span>;
<a name="l00328"></a>00328 
<a name="l00329"></a>00329 <span class="preprocessor">    # to make grabbing these options easier, we&#39;ll pull them out now...</span>
<a name="l00330"></a>00330 <span class="preprocessor"></span>    my %imagesModeOptions = %{$ce-&gt;{pg}-&gt;{displayModeOptions}-&gt;{images}};
<a name="l00331"></a>00331     
<a name="l00332"></a>00332     my $imgGen = WeBWorK::PG::ImageGenerator-&gt;new(
<a name="l00333"></a>00333         tempDir         =&gt; $ce-&gt;{webworkDirs}-&gt;{tmp},
<a name="l00334"></a>00334         latex           =&gt; $ce-&gt;{externalPrograms}-&gt;{latex},
<a name="l00335"></a>00335         dvipng          =&gt; $ce-&gt;{externalPrograms}-&gt;{dvipng},
<a name="l00336"></a>00336         useCache        =&gt; 1,
<a name="l00337"></a>00337         cacheDir        =&gt; $ce-&gt;{webworkDirs}-&gt;{equationCache},
<a name="l00338"></a>00338         cacheURL        =&gt; $ce-&gt;{webworkURLs}-&gt;{equationCache},
<a name="l00339"></a>00339         cacheDB         =&gt; $ce-&gt;{webworkFiles}-&gt;{equationCacheDB},
<a name="l00340"></a>00340         dvipng_align    =&gt; $imagesModeOptions{dvipng_align},
<a name="l00341"></a>00341         dvipng_depth_db =&gt; $imagesModeOptions{dvipng_depth_db},
<a name="l00342"></a>00342     );
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     my %resultsData = ();
<a name="l00345"></a>00345     $resultsData{<span class="stringliteral">&#39;Entered&#39;</span>}  = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;Your answer parses as:&quot;</span>);
<a name="l00346"></a>00346     $resultsData{<span class="stringliteral">&#39;Preview&#39;</span>}  = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;Your answer previews as:&quot;</span>);
<a name="l00347"></a>00347     $resultsData{<span class="stringliteral">&#39;Correct&#39;</span>}  = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;The correct answer is:&quot;</span>);
<a name="l00348"></a>00348     $resultsData{<span class="stringliteral">&#39;Results&#39;</span>}  = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;Result:&quot;</span>);
<a name="l00349"></a>00349     $resultsData{<span class="stringliteral">&#39;Messages&#39;</span>} = CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;label&quot;</span>}, <span class="stringliteral">&quot;Messages:&quot;</span>);
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     my %resultsRows = ();
<a name="l00352"></a>00352     <span class="keywordflow">foreach</span> ( qw( Entered Preview Correct Results Messages ) ) {
<a name="l00353"></a>00353         $resultsRows{$_} = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00354"></a>00354     }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     my $numCorrect = 0;
<a name="l00357"></a>00357     my $numAns = 0;
<a name="l00358"></a>00358     <span class="keywordflow">foreach</span> my $name (@answerNames) {
<a name="l00359"></a>00359         my $answerResult  = $pg-&gt;{answers}-&gt;{$name};
<a name="l00360"></a>00360         my $studentAnswer = $answerResult-&gt;{student_ans}; # original_student_ans
<a name="l00361"></a>00361         my $preview       = ($showAttemptPreview
<a name="l00362"></a>00362                                 ? $self-&gt;previewAnswer($answerResult, $imgGen)
<a name="l00363"></a>00363                                 : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00364"></a>00364         my $correctAnswer = $answerResult-&gt;{correct_ans};
<a name="l00365"></a>00365         my $answerScore   = $answerResult-&gt;{score};
<a name="l00366"></a>00366         my $answerMessage = $showMessages ? $answerResult-&gt;{ans_message} : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00367"></a>00367 <span class="preprocessor">        #FIXME  --Can we be sure that $answerScore is an integer-- could the problem give partial credit?</span>
<a name="l00368"></a>00368 <span class="preprocessor"></span>        $numCorrect += $answerScore &gt; 0;
<a name="l00369"></a>00369         my $resultString = $answerScore == 1 ? <span class="stringliteral">&quot;correct&quot;</span> : <span class="stringliteral">&quot;incorrect&quot;</span>;
<a name="l00370"></a>00370         
<a name="l00371"></a>00371 <span class="preprocessor">        # get rid of the goofy prefix on the answer names (supposedly, the format</span>
<a name="l00372"></a>00372 <span class="preprocessor"></span><span class="preprocessor">        # of the answer names is changeable. this only fixes it for &quot;AnSwEr&quot;</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span><span class="preprocessor">        #$name =~ s/^AnSwEr//;</span>
<a name="l00374"></a>00374 <span class="preprocessor"></span>        
<a name="l00375"></a>00375         my $pre = $numAns ? CGI::td(<span class="stringliteral">&quot;&amp;nbsp;&quot;</span>) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377         $resultsRows{<span class="stringliteral">&#39;Entered&#39;</span>} .= $showAttemptAnswers ? 
<a name="l00378"></a>00378             CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Entered&#39;</span>} . 
<a name="l00379"></a>00379                  CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($studentAnswer))) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00380"></a>00380         $resultsData{<span class="stringliteral">&#39;Entered&#39;</span>} = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00381"></a>00381         $resultsRows{<span class="stringliteral">&#39;Preview&#39;</span>} .= $showAttemptPreview ? 
<a name="l00382"></a>00382             CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Preview&#39;</span>} . 
<a name="l00383"></a>00383                  CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($preview)) ) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00384"></a>00384         $resultsData{<span class="stringliteral">&#39;Preview&#39;</span>} = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00385"></a>00385         $resultsRows{<span class="stringliteral">&#39;Correct&#39;</span>} .= $showCorrectAnswers ? 
<a name="l00386"></a>00386             CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Correct&#39;</span>} . 
<a name="l00387"></a>00387                  CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($correctAnswer)) ) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00388"></a>00388         $resultsData{<span class="stringliteral">&#39;Correct&#39;</span>} = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00389"></a>00389         $resultsRows{<span class="stringliteral">&#39;Results&#39;</span>} .= $showAttemptResults ? 
<a name="l00390"></a>00390             CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Results&#39;</span>} . 
<a name="l00391"></a>00391                  CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($resultString)) )  : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00392"></a>00392         $resultsData{<span class="stringliteral">&#39;Results&#39;</span>} = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00393"></a>00393         $resultsRows{<span class="stringliteral">&#39;Messages&#39;</span>} .= $showMessages ? 
<a name="l00394"></a>00394             CGI::Tr( $pre . $resultsData{<span class="stringliteral">&#39;Messages&#39;</span>} . 
<a name="l00395"></a>00395                  CGI::td({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;output&quot;</span>}, $self-&gt;nbsp($answerMessage)) ) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         $numAns++;
<a name="l00398"></a>00398     }
<a name="l00399"></a>00399     
<a name="l00400"></a>00400 <span class="preprocessor">    # render equation images</span>
<a name="l00401"></a>00401 <span class="preprocessor"></span>    $imgGen-&gt;render(refresh =&gt; 1);
<a name="l00402"></a>00402     
<a name="l00403"></a>00403 <span class="preprocessor">#   my $numIncorrectNoun = scalar @answerNames == 1 ? &quot;question&quot; : &quot;questions&quot;;</span>
<a name="l00404"></a>00404 <span class="preprocessor"></span>    my $scorePercent = sprintf(<span class="stringliteral">&quot;%.0f%%&quot;</span>, $problemResult-&gt;{score} * 100);
<a name="l00405"></a>00405 <span class="preprocessor">#   FIXME  -- I left the old code in in case we have to back out.</span>
<a name="l00406"></a>00406 <span class="preprocessor"></span><span class="preprocessor">#   my $summary = &quot;On this attempt, you answered $numCorrect out of &quot;</span>
<a name="l00407"></a>00407 <span class="preprocessor"></span><span class="preprocessor">#       . scalar @answerNames . &quot; $numIncorrectNoun correct, for a score of $scorePercent.&quot;;</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span>
<a name="l00409"></a>00409     my $summary = <span class="stringliteral">&quot;&quot;</span>; 
<a name="l00410"></a>00410     <span class="keywordflow">if</span> (scalar @answerNames == 1) {
<a name="l00411"></a>00411             <span class="keywordflow">if</span> ($numCorrect == scalar @answerNames) {
<a name="l00412"></a>00412                 $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwCorrect&quot;</span>},<span class="stringliteral">&quot;This answer is correct.&quot;</span>);
<a name="l00413"></a>00413              } <span class="keywordflow">else</span> {
<a name="l00414"></a>00414                  $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwIncorrect&quot;</span>},<span class="stringliteral">&quot;This answer is NOT correct.&quot;</span>);
<a name="l00415"></a>00415              }
<a name="l00416"></a>00416     } <span class="keywordflow">else</span> {
<a name="l00417"></a>00417             <span class="keywordflow">if</span> ($numCorrect == scalar @answerNames) {
<a name="l00418"></a>00418                 $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwCorrect&quot;</span>},<span class="stringliteral">&quot;All of these answers are correct.&quot;</span>);
<a name="l00419"></a>00419              } <span class="keywordflow">else</span> {
<a name="l00420"></a>00420                  $summary .= CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwIncorrect&quot;</span>},<span class="stringliteral">&quot;At least one of these answers is NOT correct.&quot;</span>);
<a name="l00421"></a>00421              }
<a name="l00422"></a>00422     }
<a name="l00423"></a>00423     
<a name="l00424"></a>00424     <span class="keywordflow">return</span>
<a name="l00425"></a>00425 <span class="preprocessor">#       CGI::table({-class=&gt;&quot;attemptResults&quot;}, $resultsRows{&#39;Entered&#39;}, </span>
<a name="l00426"></a>00426 <span class="preprocessor"></span>        CGI::table({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwAttemptResults&quot;</span>}, $resultsRows{<span class="stringliteral">&#39;Entered&#39;</span>}, 
<a name="l00427"></a>00427                $resultsRows{<span class="stringliteral">&#39;Preview&#39;</span>}, $resultsRows{<span class="stringliteral">&#39;Correct&#39;</span>}, 
<a name="l00428"></a>00428                $resultsRows{<span class="stringliteral">&#39;Results&#39;</span>}, $resultsRows{<span class="stringliteral">&#39;Messages&#39;</span>}) .
<a name="l00429"></a>00429         ($showSummary ? CGI::p({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;attemptResultsSummary&#39;</span>},$summary) : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00430"></a>00430 <span class="preprocessor">#       CGI::table({-class=&gt;&quot;attemptResults&quot;}, CGI::Tr(\@tableRows))</span>
<a name="l00431"></a>00431 <span class="preprocessor"></span><span class="preprocessor">#       . ($showSummary ? CGI::p({class=&gt;&#39;emphasis&#39;},$summary) : &quot;&quot;);</span>
<a name="l00432"></a>00432 <span class="preprocessor"></span>}
<a name="l00433"></a>00433 
<a name="l00434"></a>00434 <span class="preprocessor"># *BeginPPM* ###################################################################</span>
<a name="l00435"></a>00435 <span class="preprocessor"></span><span class="preprocessor"># this code taken from Problem.pm; excerpted section ends at *EndPPM*</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span><span class="preprocessor"># modifications are flagged with comments *GW*</span>
<a name="l00437"></a>00437 <span class="preprocessor"></span>
<a name="l00438"></a>00438 sub previewAnswer {
<a name="l00439"></a>00439     my ($self, $answerResult, $imgGen) = @_;
<a name="l00440"></a>00440     my $ce            = $self-&gt;r-&gt;ce;
<a name="l00441"></a>00441     my $EffectiveUser = $self-&gt;{effectiveUser};
<a name="l00442"></a>00442     my $set           = $self-&gt;{<span class="keyword">set</span>};
<a name="l00443"></a>00443     my $problem       = $self-&gt;{problem};
<a name="l00444"></a>00444     my $displayMode   = $self-&gt;{displayMode};
<a name="l00445"></a>00445     
<a name="l00446"></a>00446 <span class="preprocessor">    # note: right now, we have to do things completely differently when we are</span>
<a name="l00447"></a>00447 <span class="preprocessor"></span><span class="preprocessor">    # rendering math from INSIDE the translator and from OUTSIDE the translator.</span>
<a name="l00448"></a>00448 <span class="preprocessor"></span><span class="preprocessor">    # so we&#39;ll just deal with each case explicitly here. there&#39;s some code</span>
<a name="l00449"></a>00449 <span class="preprocessor"></span><span class="preprocessor">    # duplication that can be dealt with later by abstracting out tth/dvipng/etc.</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span>    
<a name="l00451"></a>00451     my $tex = $answerResult-&gt;{preview_latex_string};
<a name="l00452"></a>00452     
<a name="l00453"></a>00453     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span> unless defined $tex and $tex ne <span class="stringliteral">&quot;&quot;</span>;
<a name="l00454"></a>00454     
<a name="l00455"></a>00455     <span class="keywordflow">if</span> ($displayMode eq <span class="stringliteral">&quot;plainText&quot;</span>) {
<a name="l00456"></a>00456         <span class="keywordflow">return</span> $tex;
<a name="l00457"></a>00457     } elsif ($displayMode eq <span class="stringliteral">&quot;formattedText&quot;</span>) {
<a name="l00458"></a>00458         my $tthCommand = $ce-&gt;{externalPrograms}-&gt;{tth}
<a name="l00459"></a>00459             . <span class="stringliteral">&quot; -L -f5 -r 2&gt; /dev/null &lt;&lt;END_OF_INPUT; echo &gt; /dev/null\n&quot;</span>
<a name="l00460"></a>00460             . <span class="stringliteral">&quot;\\(&quot;</span>.$tex.<span class="stringliteral">&quot;\\)\n&quot;</span>
<a name="l00461"></a>00461             . <span class="stringliteral">&quot;END_OF_INPUT\n&quot;</span>;
<a name="l00462"></a>00462         
<a name="l00463"></a>00463 <span class="preprocessor">        # call tth</span>
<a name="l00464"></a>00464 <span class="preprocessor"></span>        my $result = `$tthCommand`;
<a name="l00465"></a>00465         <span class="keywordflow">if</span> ($?) {
<a name="l00466"></a>00466             <span class="keywordflow">return</span> <span class="stringliteral">&quot;&lt;b&gt;[tth failed: $? $@]&lt;/b&gt;&quot;</span>;
<a name="l00467"></a>00467         } <span class="keywordflow">else</span> {
<a name="l00468"></a>00468             <span class="keywordflow">return</span> $result;
<a name="l00469"></a>00469         }
<a name="l00470"></a>00470     } elsif ($displayMode eq <span class="stringliteral">&quot;images&quot;</span>) {
<a name="l00471"></a>00471         $imgGen-&gt;add($tex);
<a name="l00472"></a>00472     } elsif ($displayMode eq <span class="stringliteral">&quot;MathJax&quot;</span>) {
<a name="l00473"></a>00473         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;span class=&quot;MathJax_Preview&quot;&gt;[math]&lt;/span&gt;&lt;script type=&quot;math/tex; mode=display&quot;&gt;&#39;</span>.$tex.<span class="stringliteral">&#39;&lt;/script&gt;&#39;</span>;
<a name="l00474"></a>00474     } elsif ($displayMode eq <span class="stringliteral">&quot;jsMath&quot;</span>) {
<a name="l00475"></a>00475         $tex =~ s/&amp;/&amp;amp;/g; $tex =~ s/&lt;/&amp;lt;/g; $tex =~ s/&gt;/&amp;gt;/g;
<a name="l00476"></a>00476         <span class="keywordflow">return</span> <span class="stringliteral">&#39;&lt;SPAN CLASS=&quot;math&quot;&gt;\\displaystyle{&#39;</span>.$tex.<span class="stringliteral">&#39;}&lt;/SPAN&gt;&#39;</span>;
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480 <span class="preprocessor"># *EndPPM ######################################################################</span>
<a name="l00481"></a>00481 <span class="preprocessor"></span>
<a name="l00482"></a>00482 <span class="preprocessor">################################################################################</span>
<a name="l00483"></a>00483 <span class="preprocessor"></span><span class="preprocessor"># Template escape implementations</span>
<a name="l00484"></a>00484 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00485"></a>00485 <span class="preprocessor"></span>
<a name="l00486"></a>00486 <span class="preprocessor"># FIXME need to make $Set and $set be used consistently</span>
<a name="l00487"></a>00487 <span class="preprocessor"></span>
<a name="l00488"></a>00488 sub pre_header_initialize {
<a name="l00489"></a>00489     my ($self)     = @_;
<a name="l00490"></a>00490 
<a name="l00491"></a>00491     my $r = $self-&gt;r;
<a name="l00492"></a>00492     my $ce = $r-&gt;ce;
<a name="l00493"></a>00493     my $db = $r-&gt;db;
<a name="l00494"></a>00494     my $authz = $r-&gt;authz;
<a name="l00495"></a>00495     my $urlpath = $r-&gt;urlpath;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497     my $setName = $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l00498"></a>00498     my $userName = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00499"></a>00499     my $effectiveUserName = $r-&gt;param(<span class="stringliteral">&#39;effectiveUser&#39;</span>);
<a name="l00500"></a>00500     my $key = $r-&gt;param(<span class="stringliteral">&#39;key&#39;</span>);
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 <span class="preprocessor">    # should we allow a new version to be created when</span>
<a name="l00503"></a>00503 <span class="preprocessor"></span><span class="preprocessor">    #    acting as a user?</span>
<a name="l00504"></a>00504 <span class="preprocessor"></span>    my $verCreateOK = ( defined( $r-&gt;param(<span class="stringliteral">&#39;createnew_ok&#39;</span>) ) ) ?
<a name="l00505"></a>00505         $r-&gt;param(<span class="stringliteral">&#39;createnew_ok&#39;</span>) : 0;
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 <span class="preprocessor">    # user checks</span>
<a name="l00508"></a>00508 <span class="preprocessor"></span>    my $User = $db-&gt;getUser($userName);
<a name="l00509"></a>00509     die <span class="stringliteral">&quot;record for user $userName (real user) does not exist.&quot;</span> 
<a name="l00510"></a>00510         unless defined $User;
<a name="l00511"></a>00511     my $EffectiveUser = $db-&gt;getUser($effectiveUserName);
<a name="l00512"></a>00512     die <span class="stringliteral">&quot;record for user $effectiveUserName (effective user) does &quot;</span> .
<a name="l00513"></a>00513         <span class="stringliteral">&quot;not exist.&quot;</span> unless defined $EffectiveUser;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     my $PermissionLevel = $db-&gt;getPermissionLevel($userName);
<a name="l00516"></a>00516     die <span class="stringliteral">&quot;permission level record for $userName does not exist (but the &quot;</span> .
<a name="l00517"></a>00517         <span class="stringliteral">&quot;user does? odd...)&quot;</span> unless defined($PermissionLevel);
<a name="l00518"></a>00518     my $permissionLevel = $PermissionLevel-&gt;permission;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520 <span class="preprocessor"># we could be coming in with $setName = the versioned or nonversioned set</span>
<a name="l00521"></a>00521 <span class="preprocessor"></span><span class="preprocessor"># deal with that first</span>
<a name="l00522"></a>00522 <span class="preprocessor"></span>    my $requestedVersion = ( $setName =~ /,v(\d+)$/ ) ? $1 : 0;
<a name="l00523"></a>00523     $setName =~ s/,v\d+$<span class="comment">//;</span>
<a name="l00524"></a>00524 <span class="preprocessor"># note that if we&#39;re already working with a version we want to be sure to stick</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span><span class="preprocessor"># with that version.  we do this after we&#39;ve validated that the user is</span>
<a name="l00526"></a>00526 <span class="preprocessor"></span><span class="preprocessor"># assigned the set, below</span>
<a name="l00527"></a>00527 <span class="preprocessor"></span>
<a name="l00528"></a>00528 <span class="preprocessor">###################################</span>
<a name="l00529"></a>00529 <span class="preprocessor"></span><span class="preprocessor"># gateway set and problem collection</span>
<a name="l00530"></a>00530 <span class="preprocessor"></span><span class="preprocessor">###################################</span>
<a name="l00531"></a>00531 <span class="preprocessor"></span>
<a name="l00532"></a>00532 <span class="preprocessor"># we need the template (user) set, the merged set-version, and a </span>
<a name="l00533"></a>00533 <span class="preprocessor"></span><span class="preprocessor">#    problem from the set to be able to test whether we&#39;re creating a </span>
<a name="l00534"></a>00534 <span class="preprocessor"></span><span class="preprocessor">#    new set version.  assemble these</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span>    my ( $tmplSet, $set, $Problem ) = ( 0, 0, 0 );
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 <span class="preprocessor"># if the set comes in as &quot;Undefined_Set&quot;, then we&#39;re trying/editing a </span>
<a name="l00538"></a>00538 <span class="preprocessor"></span><span class="preprocessor">#    single problem in a set, and so create a fake set with which to work</span>
<a name="l00539"></a>00539 <span class="preprocessor"></span><span class="preprocessor">#    if the user has the authorization to do that.</span>
<a name="l00540"></a>00540 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $setName eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> ) {
<a name="l00541"></a>00541 
<a name="l00542"></a>00542 <span class="preprocessor">        # make sure these are defined</span>
<a name="l00543"></a>00543 <span class="preprocessor"></span>        $requestedVersion = 1;
<a name="l00544"></a>00544         $self-&gt;{assignment_type} = <span class="stringliteral">&#39;gateway&#39;</span>;
<a name="l00545"></a>00545 
<a name="l00546"></a>00546         <span class="keywordflow">if</span> ( ! $authz-&gt;hasPermissions($userName,
<a name="l00547"></a>00547                           <span class="stringliteral">&quot;modify_problem_sets&quot;</span>) ) {
<a name="l00548"></a>00548             $self-&gt;{invalidSet} = <span class="stringliteral">&quot;You do not have the &quot;</span> .
<a name="l00549"></a>00549                 <span class="stringliteral">&quot;authorization level required to view/&quot;</span> .
<a name="l00550"></a>00550                 <span class="stringliteral">&quot;edit undefined sets.&quot;</span>;
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="preprocessor">            # define these so that we can drop through</span>
<a name="l00553"></a>00553 <span class="preprocessor"></span><span class="preprocessor">            #    to report the error in body()</span>
<a name="l00554"></a>00554 <span class="preprocessor"></span>            $tmplSet = fake_set( $db );
<a name="l00555"></a>00555             $set     = fake_set_version( $db );
<a name="l00556"></a>00556             $Problem = fake_problem( $db );
<a name="l00557"></a>00557         } <span class="keywordflow">else</span> {
<a name="l00558"></a>00558 <span class="preprocessor">    # in this case we&#39;re creating a fake set from the input, so</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span><span class="preprocessor">    #    the input must include a source file.</span>
<a name="l00560"></a>00560 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( ! $r-&gt;param(<span class="stringliteral">&quot;sourceFilePath&quot;</span>) ) {
<a name="l00561"></a>00561                 $self-&gt;{invalidSet} = <span class="stringliteral">&quot;An Undefined_Set &quot;</span> .
<a name="l00562"></a>00562                     <span class="stringliteral">&quot;was requested, but no source &quot;</span> .
<a name="l00563"></a>00563                     <span class="stringliteral">&quot;file for the contained problem &quot;</span> .
<a name="l00564"></a>00564                     <span class="stringliteral">&quot;was provided.&quot;</span>;
<a name="l00565"></a>00565 
<a name="l00566"></a>00566 <span class="preprocessor">                # define these so that we can drop through</span>
<a name="l00567"></a>00567 <span class="preprocessor"></span><span class="preprocessor">                #    to report the error in body()</span>
<a name="l00568"></a>00568 <span class="preprocessor"></span>                $tmplSet = fake_set( $db );
<a name="l00569"></a>00569                 $set     = fake_set_version( $db );
<a name="l00570"></a>00570                 $Problem = fake_problem( $db );
<a name="l00571"></a>00571 
<a name="l00572"></a>00572             } <span class="keywordflow">else</span> {
<a name="l00573"></a>00573                 my $sourceFPath = $r-&gt;param(<span class="stringliteral">&quot;sourceFilePath&quot;</span>);
<a name="l00574"></a>00574                 die(<span class="stringliteral">&quot;sourceFilePath is unsafe!&quot;</span>) unless
<a name="l00575"></a>00575                     path_is_subdir($sourceFPath,
<a name="l00576"></a>00576                         $ce-&gt;{courseDirs}-&gt;{templates},
<a name="l00577"></a>00577                         1);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579                 $tmplSet = fake_set( $db );
<a name="l00580"></a>00580                 $set     = fake_set_version( $db );
<a name="l00581"></a>00581                 $Problem = fake_problem( $db );
<a name="l00582"></a>00582 
<a name="l00583"></a>00583                 $tmplSet-&gt;assignment_type( <span class="stringliteral">&quot;gateway&quot;</span> );
<a name="l00584"></a>00584                 $tmplSet-&gt;attempts_per_version( 0 );
<a name="l00585"></a>00585                 $tmplSet-&gt;time_interval( 0 );
<a name="l00586"></a>00586                 $tmplSet-&gt;versions_per_interval(1);
<a name="l00587"></a>00587                 $tmplSet-&gt;version_time_limit( 0 );
<a name="l00588"></a>00588                 $tmplSet-&gt;version_creation_time( time() );
<a name="l00589"></a>00589                 $tmplSet-&gt;problem_randorder( 0 );
<a name="l00590"></a>00590                 $tmplSet-&gt;problems_per_page( 1 );
<a name="l00591"></a>00591                 $tmplSet-&gt;hide_score(<span class="charliteral">&#39;N&#39;</span>);
<a name="l00592"></a>00592                 $tmplSet-&gt;hide_score_by_problem(<span class="charliteral">&#39;N&#39;</span>);
<a name="l00593"></a>00593                 $tmplSet-&gt;hide_work(<span class="charliteral">&#39;N&#39;</span>);
<a name="l00594"></a>00594                 $tmplSet-&gt;time_limit_cap(<span class="charliteral">&#39;0&#39;</span>);
<a name="l00595"></a>00595                 $tmplSet-&gt;restrict_ip(<span class="stringliteral">&#39;No&#39;</span>);
<a name="l00596"></a>00596 
<a name="l00597"></a>00597                 $set-&gt;assignment_type( <span class="stringliteral">&quot;gateway&quot;</span> );
<a name="l00598"></a>00598                 $set-&gt;time_interval( 0 );
<a name="l00599"></a>00599                 $set-&gt;versions_per_interval(1);
<a name="l00600"></a>00600                 $set-&gt;version_time_limit( 0 );
<a name="l00601"></a>00601                 $set-&gt;version_creation_time( time() );
<a name="l00602"></a>00602                 $set-&gt;time_limit_cap(<span class="charliteral">&#39;0&#39;</span>);
<a name="l00603"></a>00603 
<a name="l00604"></a>00604                 $Problem-&gt;problem_id(1);
<a name="l00605"></a>00605                 $Problem-&gt;source_file($sourceFPath);
<a name="l00606"></a>00606                 $Problem-&gt;user_id($effectiveUserName);
<a name="l00607"></a>00607                 $Problem-&gt;value(1);
<a name="l00608"></a>00608                 $Problem-&gt;problem_seed( $r-&gt;param(<span class="stringliteral">&quot;problemSeed&quot;</span>) ) <span class="keywordflow">if</span> ( $r-&gt;param(<span class="stringliteral">&quot;problemSeed&quot;</span>) );
<a name="l00609"></a>00609             }
<a name="l00610"></a>00610         }
<a name="l00611"></a>00611     } <span class="keywordflow">else</span> {
<a name="l00612"></a>00612 
<a name="l00613"></a>00613 <span class="preprocessor"># get template set: the non-versioned set that&#39;s assigned to the user</span>
<a name="l00614"></a>00614 <span class="preprocessor"></span><span class="preprocessor">#    if this fails/failed in authz-&gt;checkSet, then $self-&gt;{invalidSet} is</span>
<a name="l00615"></a>00615 <span class="preprocessor"></span><span class="preprocessor">#    set</span>
<a name="l00616"></a>00616 <span class="preprocessor"></span>        $tmplSet = $db-&gt;getMergedSet( $effectiveUserName, $setName );
<a name="l00617"></a>00617 
<a name="l00618"></a>00618 <span class="preprocessor">    # now we know that we&#39;re in a gateway test, save the assignment test </span>
<a name="l00619"></a>00619 <span class="preprocessor"></span><span class="preprocessor">    #    for the processing of proctor keys for graded proctored tests; </span>
<a name="l00620"></a>00620 <span class="preprocessor"></span><span class="preprocessor">    #    if we failed to get the set from the database, we store a fake </span>
<a name="l00621"></a>00621 <span class="preprocessor"></span><span class="preprocessor">    #    value here to be able to continue</span>
<a name="l00622"></a>00622 <span class="preprocessor"></span>        $self-&gt;{<span class="stringliteral">&#39;assignment_type&#39;</span>} = $tmplSet-&gt;assignment_type() ||
<a name="l00623"></a>00623             <span class="stringliteral">&#39;gateway&#39;</span>;
<a name="l00624"></a>00624 
<a name="l00625"></a>00625 <span class="preprocessor">    # next, get the latest (current) version of the set if we don&#39;t have a </span>
<a name="l00626"></a>00626 <span class="preprocessor"></span><span class="preprocessor">    #     requested version number</span>
<a name="l00627"></a>00627 <span class="preprocessor"></span>        my @allVersionIds = $db-&gt;listSetVersions($effectiveUserName,
<a name="l00628"></a>00628                              $setName);
<a name="l00629"></a>00629         my $latestVersion = (@allVersionIds ? $allVersionIds[-1] : 0);
<a name="l00630"></a>00630 
<a name="l00631"></a>00631 <span class="preprocessor">    # double check that any requested version makes sense</span>
<a name="l00632"></a>00632 <span class="preprocessor"></span>        $requestedVersion = $latestVersion 
<a name="l00633"></a>00633           <span class="keywordflow">if</span> ( $requestedVersion !~ /^\d+$/ ||
<a name="l00634"></a>00634                $requestedVersion &gt; $latestVersion ||
<a name="l00635"></a>00635                $requestedVersion &lt; 0 );
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         die(<span class="stringliteral">&quot;No requested version when returning to problem?!&quot;</span>) 
<a name="l00638"></a>00638             if ( ( $r-&gt;param(&quot;previewAnswers&quot;) ||
<a name="l00639"></a>00639                    $r-&gt;param(&quot;checkAnswers&quot;) ||
<a name="l00640"></a>00640                    $r-&gt;param(&quot;submitAnswers&quot;) ||
<a name="l00641"></a>00641                    $r-&gt;param(&quot;newPage&quot;) ) &amp;&amp; ! $requestedVersion );
<a name="l00642"></a>00642 
<a name="l00643"></a>00643     <span class="preprocessor"># to test for a proctored test, we need the set version, not the </span>
<a name="l00644"></a>00644 <span class="preprocessor"></span><span class="preprocessor">    #    template, to allow a finished proctored test to be checked as an </span>
<a name="l00645"></a>00645 <span class="preprocessor"></span><span class="preprocessor">    #    unproctored test.  so we get the versioned set here</span>
<a name="l00646"></a>00646 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $requestedVersion ) {
<a name="l00647"></a>00647 <span class="preprocessor">    # if a specific set version was requested, it was stored in the $authz</span>
<a name="l00648"></a>00648 <span class="preprocessor"></span><span class="preprocessor">    #    object when we did the set check</span>
<a name="l00649"></a>00649 <span class="preprocessor"></span>            $set = $db-&gt;getMergedSetVersion($effectiveUserName,
<a name="l00650"></a>00650                             $setName,
<a name="l00651"></a>00651                             $requestedVersion);
<a name="l00652"></a>00652         } elsif ( $latestVersion ) {
<a name="l00653"></a>00653 <span class="preprocessor">    # otherwise, if there&#39;s a current version, which we take to be the </span>
<a name="l00654"></a>00654 <span class="preprocessor"></span><span class="preprocessor">    #    latest version taken, we use that</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span>            $set = $db-&gt;getMergedSetVersion($effectiveUserName,
<a name="l00656"></a>00656                             $setName,
<a name="l00657"></a>00657                             $latestVersion);
<a name="l00658"></a>00658         } <span class="keywordflow">else</span> {
<a name="l00659"></a>00659 <span class="preprocessor">    # and if neither of those work, get a dummy set so that we have </span>
<a name="l00660"></a>00660 <span class="preprocessor"></span><span class="preprocessor">    #    something to work with</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span>            my $userSetClass = $ce-&gt;{dbLayout}-&gt;{set_version}-&gt;{record};
<a name="l00662"></a>00662 <span class="preprocessor"># FIXME RETURN TO: should this be global2version?</span>
<a name="l00663"></a>00663 <span class="preprocessor"></span>            $set = global2user($userSetClass, 
<a name="l00664"></a>00664                        $db-&gt;getGlobalSet($setName));
<a name="l00665"></a>00665             die <span class="stringliteral">&quot;set  $setName  not found.&quot;</span>  unless $set;
<a name="l00666"></a>00666             $set-&gt;user_id($effectiveUserName);
<a name="l00667"></a>00667             $set-&gt;psvn(<span class="stringliteral">&#39;000&#39;</span>);
<a name="l00668"></a>00668             $set-&gt;set_id(<span class="stringliteral">&quot;$setName&quot;</span>);  # redundant?
<a name="l00669"></a>00669             $set-&gt;version_id(0);
<a name="l00670"></a>00670         }
<a name="l00671"></a>00671     }
<a name="l00672"></a>00672     my $setVersionNumber = ($set) ? $set-&gt;version_id() : 0;
<a name="l00673"></a>00673 
<a name="l00674"></a>00674 <span class="preprocessor">    #################################</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span><span class="preprocessor">    # assemble gateway parameters</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span><span class="preprocessor">    #################################</span>
<a name="l00677"></a>00677 <span class="preprocessor"></span>
<a name="l00678"></a>00678 <span class="preprocessor">    # we get the open/close dates for the gateway from the template set.</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span><span class="preprocessor">    #    note $isOpen/Closed give the open/close dates for the gateway</span>
<a name="l00680"></a>00680 <span class="preprocessor"></span><span class="preprocessor">    #    as a whole (that is, the merged user|global set).  because the</span>
<a name="l00681"></a>00681 <span class="preprocessor"></span><span class="preprocessor">    #    set could be bad (if $self-&gt;{invalidSet}), we check -&gt;open_date</span>
<a name="l00682"></a>00682 <span class="preprocessor"></span><span class="preprocessor">    #    before actually testing the date</span>
<a name="l00683"></a>00683 <span class="preprocessor"></span>    my $isOpen = $tmplSet &amp;&amp; $tmplSet-&gt;open_date &amp;&amp; 
<a name="l00684"></a>00684         ( after($tmplSet-&gt;open_date()) || 
<a name="l00685"></a>00685           $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;view_unopened_sets&quot;</span>) );
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 <span class="preprocessor">    # FIXME for $isClosed, &quot;record_answers_after_due_date&quot; isn&#39;t quite</span>
<a name="l00688"></a>00688 <span class="preprocessor"></span><span class="preprocessor">    #    the right description, but it seems reasonable</span>
<a name="l00689"></a>00689 <span class="preprocessor"></span>    my $isClosed = $tmplSet &amp;&amp; $tmplSet-&gt;due_date &amp;&amp;
<a name="l00690"></a>00690         ( after($tmplSet-&gt;due_date()) &amp;&amp;
<a name="l00691"></a>00691           ! $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;record_answers_after_due_date&quot;</span>) );
<a name="l00692"></a>00692 
<a name="l00693"></a>00693 <span class="preprocessor">    # to determine if we need a new version, we need to know whether this </span>
<a name="l00694"></a>00694 <span class="preprocessor"></span><span class="preprocessor">    #    version exceeds the number of attempts per version.  (among other</span>
<a name="l00695"></a>00695 <span class="preprocessor"></span><span class="preprocessor">    #    things,) the number of attempts is a property of the problem, so </span>
<a name="l00696"></a>00696 <span class="preprocessor"></span><span class="preprocessor">    #    get a problem to check that.  note that for a gateway/quiz all </span>
<a name="l00697"></a>00697 <span class="preprocessor"></span><span class="preprocessor">    #    problems will have the same number of attempts.  This means that </span>
<a name="l00698"></a>00698 <span class="preprocessor"></span><span class="preprocessor">    #    if the set doesn&#39;t have any problems we&#39;re up a creek, so check </span>
<a name="l00699"></a>00699 <span class="preprocessor"></span><span class="preprocessor">    #    for that here and bail if it&#39;s the case</span>
<a name="l00700"></a>00700 <span class="preprocessor"></span>    my @setPNum = $setName eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> ? ( 1 ) :
<a name="l00701"></a>00701         $db-&gt;listUserProblems($EffectiveUser-&gt;user_id, $setName);
<a name="l00702"></a>00702     die(<span class="stringliteral">&quot;Set $setName contains no problems.&quot;</span>) if ( ! @setPNum );
<a name="l00703"></a>00703 
<a name="l00704"></a>00704     <span class="preprocessor"># if we assigned a fake problem above, $Problem is already defined.</span>
<a name="l00705"></a>00705 <span class="preprocessor"></span><span class="preprocessor">    #    otherwise, we get the Problem, or define it to be undefined if</span>
<a name="l00706"></a>00706 <span class="preprocessor"></span><span class="preprocessor">    #    the set hasn&#39;t been versioned to the user yet--this gets fixed</span>
<a name="l00707"></a>00707 <span class="preprocessor"></span><span class="preprocessor">    #    when we assign the setVersion</span>
<a name="l00708"></a>00708 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! $Problem ) {
<a name="l00709"></a>00709         $Problem = $setVersionNumber ?
<a name="l00710"></a>00710             $db-&gt;getMergedProblemVersion($EffectiveUser-&gt;user_id,
<a name="l00711"></a>00711                 $setName, $setVersionNumber, $setPNum[0]) :
<a name="l00712"></a>00712                 undef;
<a name="l00713"></a>00713     }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715 <span class="preprocessor">    # note that having $maxAttemptsPerVersion set to an infinite/0 value is</span>
<a name="l00716"></a>00716 <span class="preprocessor"></span><span class="preprocessor">    #    nonsensical; if we did that, why have versions? (might want to do it for one individual?)</span>
<a name="l00717"></a>00717 <span class="preprocessor"></span>    my $maxAttemptsPerVersion = $tmplSet-&gt;attempts_per_version() || 0;
<a name="l00718"></a>00718     my $timeInterval          = $tmplSet-&gt;time_interval() || 0;
<a name="l00719"></a>00719     my $versionsPerInterval   = $tmplSet-&gt;versions_per_interval() || 0;
<a name="l00720"></a>00720     my $timeLimit             = $tmplSet-&gt;version_time_limit() || 0;
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 <span class="preprocessor">    # what happens if someone didn&#39;t set one of these?  I think this can</span>
<a name="l00723"></a>00723 <span class="preprocessor"></span><span class="preprocessor">    # happen if we&#39;re handed a malformed set, where the values in the</span>
<a name="l00724"></a>00724 <span class="preprocessor"></span><span class="preprocessor">    # database are null.</span>
<a name="l00725"></a>00725 <span class="preprocessor"></span>    $timeInterval = 0 <span class="keywordflow">if</span> (! defined($timeInterval) || $timeInterval eq <span class="stringliteral">&#39;&#39;</span>);
<a name="l00726"></a>00726     $versionsPerInterval = 0 <span class="keywordflow">if</span> (! defined($versionsPerInterval) ||
<a name="l00727"></a>00727                      $versionsPerInterval eq <span class="stringliteral">&#39;&#39;</span>);
<a name="l00728"></a>00728 
<a name="l00729"></a>00729 <span class="preprocessor">    # every problem in the set must have the same submission characteristics</span>
<a name="l00730"></a>00730 <span class="preprocessor"></span>    my $currentNumAttempts    = ( defined($Problem) &amp;&amp; 
<a name="l00731"></a>00731                       $Problem-&gt;num_correct() ne <span class="stringliteral">&#39;&#39;</span> ) ? 
<a name="l00732"></a>00732                       $Problem-&gt;num_correct() +
<a name="l00733"></a>00733                       $Problem-&gt;num_incorrect() : 0;
<a name="l00734"></a>00734 
<a name="l00735"></a>00735 <span class="preprocessor">    # $maxAttempts turns into the maximum number of versions we can create;</span>
<a name="l00736"></a>00736 <span class="preprocessor"></span><span class="preprocessor">    #    if $Problem isn&#39;t defined, we can&#39;t have made any attempts, so it</span>
<a name="l00737"></a>00737 <span class="preprocessor"></span><span class="preprocessor">    #    doesn&#39;t matter</span>
<a name="l00738"></a>00738 <span class="preprocessor"></span>    my $maxAttempts           = ( defined($Problem) &amp;&amp; 
<a name="l00739"></a>00739                       defined($Problem-&gt;max_attempts()) &amp;&amp;
<a name="l00740"></a>00740                       $Problem-&gt;max_attempts() ) ? 
<a name="l00741"></a>00741                       $Problem-&gt;max_attempts() : -1;
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 <span class="preprocessor">    # finding the number of versions per time interval is a little harder.</span>
<a name="l00744"></a>00744 <span class="preprocessor"></span><span class="preprocessor">    #    we interpret the time interval as a rolling interval: that is,</span>
<a name="l00745"></a>00745 <span class="preprocessor"></span><span class="preprocessor">    #    if we allow two sets per day, that&#39;s two sets in any 24 hour</span>
<a name="l00746"></a>00746 <span class="preprocessor"></span><span class="preprocessor">    #    period.  this is probably not what we really want, but it&#39;s</span>
<a name="l00747"></a>00747 <span class="preprocessor"></span><span class="preprocessor">    #    more extensible to a limitation like &quot;one version per hour&quot;,</span>
<a name="l00748"></a>00748 <span class="preprocessor"></span><span class="preprocessor">    #    and we can set it to two sets per 12 hours for most &quot;2ce daily&quot;</span>
<a name="l00749"></a>00749 <span class="preprocessor"></span><span class="preprocessor">    #    type applications</span>
<a name="l00750"></a>00750 <span class="preprocessor"></span>    my $timeNow = time();
<a name="l00751"></a>00751     my $grace = $ce-&gt;{gatewayGracePeriod};
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     my $currentNumVersions = 0;  # <span class="keyword">this</span> is the number of versions in the
<a name="l00754"></a>00754 <span class="preprocessor">                                 #    time interval</span>
<a name="l00755"></a>00755 <span class="preprocessor"></span>    my $totalNumVersions = 0;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757 <span class="preprocessor">    # we don&#39;t need to check this if $self-&gt;{invalidSet} is already set,</span>
<a name="l00758"></a>00758 <span class="preprocessor"></span><span class="preprocessor">    #    or if we&#39;re working with an Undefined_Set</span>
<a name="l00759"></a>00759 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $setVersionNumber &amp;&amp; ! $self-&gt;{invalidSet} &amp;&amp;
<a name="l00760"></a>00760          $setName ne <span class="stringliteral">&quot;Undefined_Set&quot;</span> ) {
<a name="l00761"></a>00761         my @setVersionIDs = $db-&gt;listSetVersions($effectiveUserName, $setName);
<a name="l00762"></a>00762         my @setVersions = $db-&gt;getSetVersions(map {[$effectiveUserName, $setName,, $_]} @setVersionIDs);
<a name="l00763"></a>00763         <span class="keywordflow">foreach</span> ( @setVersions ) {
<a name="l00764"></a>00764             $totalNumVersions++;
<a name="l00765"></a>00765             $currentNumVersions++
<a name="l00766"></a>00766                 <span class="keywordflow">if</span> ( ! $timeInterval ||
<a name="l00767"></a>00767                  $_-&gt;version_creation_time() &gt; ($timeNow - $timeInterval) );
<a name="l00768"></a>00768         }
<a name="l00769"></a>00769     }
<a name="l00770"></a>00770 
<a name="l00771"></a>00771 <span class="preprocessor">    ####################################</span>
<a name="l00772"></a>00772 <span class="preprocessor"></span><span class="preprocessor">    # new version creation conditional</span>
<a name="l00773"></a>00773 <span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<a name="l00774"></a>00774 <span class="preprocessor"></span>
<a name="l00775"></a>00775     my $versionIsOpen = 0;  # can we <span class="keywordflow">do</span> anything to <span class="keyword">this</span> version?
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 <span class="preprocessor">    # recall $isOpen = timeNow &gt; openDate [for the merged userset] and </span>
<a name="l00778"></a>00778 <span class="preprocessor"></span><span class="preprocessor">    #    $isClosed = timeNow &gt; dueDate [for the merged userset]</span>
<a name="l00779"></a>00779 <span class="preprocessor"></span><span class="preprocessor">    #    again, if $self-&gt;{invalidSet} is already set, we don&#39;t need to </span>
<a name="l00780"></a>00780 <span class="preprocessor"></span><span class="preprocessor">    #    to check this</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $isOpen &amp;&amp; ! $isClosed &amp;&amp; ! $self-&gt;{invalidSet} ) {
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 <span class="preprocessor">    # if no specific version is requested, we can create a new one if </span>
<a name="l00784"></a>00784 <span class="preprocessor"></span><span class="preprocessor">    #    need be</span>
<a name="l00785"></a>00785 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( ! $requestedVersion ) {
<a name="l00786"></a>00786             <span class="keywordflow">if</span> ( ( $maxAttempts == -1 ||
<a name="l00787"></a>00787                    $totalNumVersions &lt; $maxAttempts )
<a name="l00788"></a>00788                  &amp;&amp;
<a name="l00789"></a>00789                  ( $setVersionNumber == 0 ||
<a name="l00790"></a>00790                    (
<a name="l00791"></a>00791                  ( $currentNumAttempts&gt;=$maxAttemptsPerVersion
<a name="l00792"></a>00792                    ||
<a name="l00793"></a>00793                    $timeNow &gt;= $set-&gt;due_date + $grace )
<a name="l00794"></a>00794                  &amp;&amp;
<a name="l00795"></a>00795                  ( ! $versionsPerInterval 
<a name="l00796"></a>00796                    ||
<a name="l00797"></a>00797                    $currentNumVersions &lt; $versionsPerInterval )
<a name="l00798"></a>00798                  )
<a name="l00799"></a>00799                  )
<a name="l00800"></a>00800                  &amp;&amp;
<a name="l00801"></a>00801                  ( $effectiveUserName eq $userName ||
<a name="l00802"></a>00802                     ( $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;record_answers_when_acting_as_student&quot;</span>) ||
<a name="l00803"></a>00803                   ( $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;create_new_set_version_when_acting_as_student&quot;</span>) &amp;&amp; $verCreateOK ) ) )
<a name="l00804"></a>00804 
<a name="l00805"></a>00805                ) {
<a name="l00806"></a>00806 <span class="preprocessor">                # assign set, get the right name, version </span>
<a name="l00807"></a>00807 <span class="preprocessor"></span><span class="preprocessor">                #    number, etc., and redefine the $set </span>
<a name="l00808"></a>00808 <span class="preprocessor"></span><span class="preprocessor">                #    and $Problem we&#39;re working with</span>
<a name="l00809"></a>00809 <span class="preprocessor"></span>                my $setTmpl = $db-&gt;getUserSet($effectiveUserName,$setName);
<a name="l00810"></a>00810                 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html#aa844361e81ea9f247686fb1d63251d16">WeBWorK::ContentGenerator::Instructor::assignSetVersionToUser</a>($self, $effectiveUserName, $setTmpl);
<a name="l00811"></a>00811                 $setVersionNumber++;
<a name="l00812"></a>00812 
<a name="l00813"></a>00813 <span class="preprocessor">                # get a clean version of the set to save,</span>
<a name="l00814"></a>00814 <span class="preprocessor"></span><span class="preprocessor">                #    and the merged version to use in the </span>
<a name="l00815"></a>00815 <span class="preprocessor"></span><span class="preprocessor">                #    rest of the routine</span>
<a name="l00816"></a>00816 <span class="preprocessor"></span>                my $cleanSet = $db-&gt;getSetVersion(
<a name="l00817"></a>00817                     $effectiveUserName, $setName,
<a name="l00818"></a>00818                     $setVersionNumber);
<a name="l00819"></a>00819                 $set = $db-&gt;getMergedSetVersion(
<a name="l00820"></a>00820                     $effectiveUserName, $setName,
<a name="l00821"></a>00821                     $setVersionNumber );
<a name="l00822"></a>00822 
<a name="l00823"></a>00823                 $Problem = $db-&gt;getMergedProblemVersion(
<a name="l00824"></a>00824                     $effectiveUserName, $setName, 
<a name="l00825"></a>00825                     $setVersionNumber, 1);
<a name="l00826"></a>00826 
<a name="l00827"></a>00827 <span class="preprocessor">                # because we&#39;re creating this on the fly, </span>
<a name="l00828"></a>00828 <span class="preprocessor"></span><span class="preprocessor">                #    it should be visible</span>
<a name="l00829"></a>00829 <span class="preprocessor"></span>                $set-&gt;visible(1);
<a name="l00830"></a>00830 <span class="preprocessor">                # set up creation time, open and due dates</span>
<a name="l00831"></a>00831 <span class="preprocessor"></span>                my $ansOffset = $set-&gt;answer_date() - 
<a name="l00832"></a>00832                     $set-&gt;due_date();
<a name="l00833"></a>00833                 $set-&gt;version_creation_time( $timeNow );
<a name="l00834"></a>00834                 $set-&gt;open_date( $timeNow );
<a name="l00835"></a>00835 <span class="preprocessor">                # figure out the due date, taking into account</span>
<a name="l00836"></a>00836 <span class="preprocessor"></span><span class="preprocessor">                #    any time limit cap</span>
<a name="l00837"></a>00837 <span class="preprocessor"></span>                my $dueTime = 
<a name="l00838"></a>00838                     ( $set-&gt;time_limit_cap &amp;&amp;
<a name="l00839"></a>00839                       $timeNow+$timeLimit &gt; $set-&gt;due_date ) ?
<a name="l00840"></a>00840                       $set-&gt;due_date : $timeNow+$timeLimit;
<a name="l00841"></a>00841                 $set-&gt;due_date( $dueTime );
<a name="l00842"></a>00842                 $set-&gt;answer_date($set-&gt;due_date + $ansOffset);
<a name="l00843"></a>00843                 $set-&gt;version_last_attempt_time( 0 );
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 <span class="preprocessor">                # put this new info into the database.  we </span>
<a name="l00846"></a>00846 <span class="preprocessor"></span><span class="preprocessor">                #    put back that data which we need for the</span>
<a name="l00847"></a>00847 <span class="preprocessor"></span><span class="preprocessor">                #    version, and leave blank any information</span>
<a name="l00848"></a>00848 <span class="preprocessor"></span><span class="preprocessor">                #    that we&#39;d like to inherit from the user</span>
<a name="l00849"></a>00849 <span class="preprocessor"></span><span class="preprocessor">                #    set or global set.  we set the data which</span>
<a name="l00850"></a>00850 <span class="preprocessor"></span><span class="preprocessor">                #    determines if a set is open, because we</span>
<a name="l00851"></a>00851 <span class="preprocessor"></span><span class="preprocessor">                #    don&#39;t want the set version to reopen after</span>
<a name="l00852"></a>00852 <span class="preprocessor"></span><span class="preprocessor">                #    it&#39;s complete</span>
<a name="l00853"></a>00853 <span class="preprocessor"></span>                $cleanSet-&gt;version_creation_time( $set-&gt;version_creation_time );
<a name="l00854"></a>00854                 $cleanSet-&gt;open_date( $set-&gt;open_date );
<a name="l00855"></a>00855                 $cleanSet-&gt;due_date( $set-&gt;due_date );
<a name="l00856"></a>00856                 $cleanSet-&gt;answer_date( $set-&gt;answer_date );
<a name="l00857"></a>00857                 $cleanSet-&gt;version_last_attempt_time( $set-&gt;version_last_attempt_time );
<a name="l00858"></a>00858                 $cleanSet-&gt;version_time_limit( $set-&gt;version_time_limit );
<a name="l00859"></a>00859                 $cleanSet-&gt;attempts_per_version( $set-&gt;attempts_per_version );
<a name="l00860"></a>00860                 $cleanSet-&gt;assignment_type( $set-&gt;assignment_type );
<a name="l00861"></a>00861                 $db-&gt;putSetVersion( $cleanSet );
<a name="l00862"></a>00862 
<a name="l00863"></a>00863 <span class="preprocessor">                # we have a new set version, so it&#39;s open</span>
<a name="l00864"></a>00864 <span class="preprocessor"></span>                $versionIsOpen = 1;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866 <span class="preprocessor">                # also reset the number of attempts for this </span>
<a name="l00867"></a>00867 <span class="preprocessor"></span><span class="preprocessor">                #    set to zero</span>
<a name="l00868"></a>00868 <span class="preprocessor"></span>                $currentNumAttempts = 0;
<a name="l00869"></a>00869 
<a name="l00870"></a>00870             } elsif ( $maxAttempts != -1 &amp;&amp; 
<a name="l00871"></a>00871                   $totalNumVersions &gt; $maxAttempts ) {
<a name="l00872"></a>00872                 $self-&gt;{invalidSet} = <span class="stringliteral">&quot;No new versions of &quot;</span> .
<a name="l00873"></a>00873                     <span class="stringliteral">&quot;this assignment are available,\n&quot;</span> .
<a name="l00874"></a>00874                     <span class="stringliteral">&quot;because you have already taken the &quot;</span> .
<a name="l00875"></a>00875                     <span class="stringliteral">&quot;maximum number\nallowed.&quot;</span>;
<a name="l00876"></a>00876 
<a name="l00877"></a>00877             } elsif ( $effectiveUserName ne $userName &amp;&amp;
<a name="l00878"></a>00878                   $authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;create_new_set_version_when_acting_as_student&quot;</span>) ) {
<a name="l00879"></a>00879                 $self-&gt;{invalidSet} = <span class="stringliteral">&quot;User &quot;</span> .
<a name="l00880"></a>00880                     <span class="stringliteral">&quot;$effectiveUserName is being acted &quot;</span> .
<a name="l00881"></a>00881                     <span class="stringliteral">&quot;as.  If you continue, you will &quot;</span> .
<a name="l00882"></a>00882                     <span class="stringliteral">&quot;create a new version of this set &quot;</span> .
<a name="l00883"></a>00883                     <span class="stringliteral">&quot;for that user, which will count &quot;</span> .
<a name="l00884"></a>00884                     <span class="stringliteral">&quot;against their allowed maximum &quot;</span> .
<a name="l00885"></a>00885                     <span class="stringliteral">&quot;number of versions for the current &quot;</span> .
<a name="l00886"></a>00886                     <span class="stringliteral">&quot;time interval.  IN GENERAL, THIS &quot;</span> .
<a name="l00887"></a>00887                     <span class="stringliteral">&quot;IS NOT WHAT YOU WANT TO DO.  &quot;</span> .
<a name="l00888"></a>00888                     <span class="stringliteral">&quot;Please be sure that you want to &quot;</span> .
<a name="l00889"></a>00889                     <span class="stringliteral">&quot;do this before clicking the \&quot;&quot;</span> .
<a name="l00890"></a>00890                     <span class="stringliteral">&quot;Create new set version\&quot; link &quot;</span> .
<a name="l00891"></a>00891                     <span class="stringliteral">&quot;below.  Alternately, PRESS THE &quot;</span> .
<a name="l00892"></a>00892                     <span class="stringliteral">&quot;\&quot;BACK\&quot; BUTTON and continue.&quot;</span>;
<a name="l00893"></a>00893                 $self-&gt;{invalidVersionCreation} = 1;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895             } elsif ( $effectiveUserName ne $userName ) {
<a name="l00896"></a>00896                 $self-&gt;{invalidSet} = <span class="stringliteral">&quot;User &quot;</span> .
<a name="l00897"></a>00897                     <span class="stringliteral">&quot;$effectiveUserName is being acted &quot;</span> .
<a name="l00898"></a>00898                     <span class="stringliteral">&quot;as.  When acting as another user, &quot;</span> .
<a name="l00899"></a>00899                     <span class="stringliteral">&quot;new versions of the set cannot be &quot;</span> .
<a name="l00900"></a>00900                     <span class="stringliteral">&quot;created.&quot;</span>;
<a name="l00901"></a>00901                 $self-&gt;{invalidVersionCreation} = 2;
<a name="l00902"></a>00902 
<a name="l00903"></a>00903             } elsif ($currentNumAttempts &lt; $maxAttemptsPerVersion &amp;&amp;
<a name="l00904"></a>00904                  $timeNow &lt; $set-&gt;due_date() + $grace ) {
<a name="l00905"></a>00905                 <span class="keywordflow">if</span> ( between($set-&gt;open_date(), 
<a name="l00906"></a>00906                          $set-&gt;due_date() + $grace, 
<a name="l00907"></a>00907                          $timeNow) ) {
<a name="l00908"></a>00908                     $versionIsOpen = 1;
<a name="l00909"></a>00909                 } <span class="keywordflow">else</span> {
<a name="l00910"></a>00910                     $versionIsOpen = 0;  # redundant
<a name="l00911"></a>00911                     $self-&gt;{invalidSet} = <span class="stringliteral">&quot;No new &quot;</span> .
<a name="l00912"></a>00912                         <span class="stringliteral">&quot; versions of this assignment&quot;</span> .
<a name="l00913"></a>00913                         <span class="stringliteral">&quot; are available,\nbecause the&quot;</span> .
<a name="l00914"></a>00914                         <span class="stringliteral">&quot; set is not open or its time&quot;</span> .
<a name="l00915"></a>00915                         <span class="stringliteral">&quot; limit has expired.\n&quot;</span>;
<a name="l00916"></a>00916                 }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918             } elsif ($versionsPerInterval &amp;&amp; 
<a name="l00919"></a>00919                  ($currentNumVersions &gt;= $versionsPerInterval)){
<a name="l00920"></a>00920                 $self-&gt;{invalidSet} = <span class="stringliteral">&quot;You have already taken&quot;</span> .
<a name="l00921"></a>00921                     <span class="stringliteral">&quot; all available versions of this\n&quot;</span> .
<a name="l00922"></a>00922                     <span class="stringliteral">&quot;test in the current time interval.  &quot;</span> .
<a name="l00923"></a>00923                     <span class="stringliteral">&quot;You may take the\ntest again after &quot;</span> .
<a name="l00924"></a>00924                     <span class="stringliteral">&quot;the time interval has expired.&quot;</span>;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926             }
<a name="l00927"></a>00927 
<a name="l00928"></a>00928         } <span class="keywordflow">else</span> {
<a name="l00929"></a>00929 <span class="preprocessor">        # (we&#39;re still in the $isOpen &amp;&amp; ! $isClosed conditional here)</span>
<a name="l00930"></a>00930 <span class="preprocessor"></span><span class="preprocessor">        #    if a specific version is requested, then we only check to </span>
<a name="l00931"></a>00931 <span class="preprocessor"></span><span class="preprocessor">        #    see if it&#39;s open</span>
<a name="l00932"></a>00932 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( 
<a name="l00933"></a>00933                  ( $currentNumAttempts &lt; $maxAttemptsPerVersion )
<a name="l00934"></a>00934                  &amp;&amp; 
<a name="l00935"></a>00935                  ( $effectiveUserName eq $userName ||
<a name="l00936"></a>00936                    $authz-&gt;hasPermissions($userName,
<a name="l00937"></a>00937                               <span class="stringliteral">&quot;record_set_version_answers_when_acting_as_student&quot;</span>) )
<a name="l00938"></a>00938                ) {
<a name="l00939"></a>00939                 <span class="keywordflow">if</span> ( between($set-&gt;open_date(), 
<a name="l00940"></a>00940                          $set-&gt;due_date() + $grace,
<a name="l00941"></a>00941                          $timeNow) ) {
<a name="l00942"></a>00942                     $versionIsOpen = 1;
<a name="l00943"></a>00943                 } <span class="keywordflow">else</span> {
<a name="l00944"></a>00944                     $versionIsOpen = 0;  # redundant
<a name="l00945"></a>00945                 }
<a name="l00946"></a>00946             }
<a name="l00947"></a>00947         }
<a name="l00948"></a>00948 
<a name="l00949"></a>00949 <span class="preprocessor">    # closed set, with attempt at a new one</span>
<a name="l00950"></a>00950 <span class="preprocessor"></span>    } elsif ( ! $self-&gt;{invalidSet} &amp;&amp; ! $requestedVersion ) {
<a name="l00951"></a>00951         $self-&gt;{invalidSet} = <span class="stringliteral">&quot;This set is closed.  No new set &quot;</span> .
<a name="l00952"></a>00952             <span class="stringliteral">&quot;versions may be taken.&quot;</span>;
<a name="l00953"></a>00953     }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955 
<a name="l00956"></a>00956 <span class="preprocessor">    ####################################</span>
<a name="l00957"></a>00957 <span class="preprocessor"></span><span class="preprocessor">    # save problem and user data</span>
<a name="l00958"></a>00958 <span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<a name="l00959"></a>00959 <span class="preprocessor"></span>
<a name="l00960"></a>00960     my $psvn = $set-&gt;psvn();
<a name="l00961"></a>00961     $self-&gt;{tmplSet} = $tmplSet;
<a name="l00962"></a>00962     $self-&gt;{<span class="keyword">set</span>} = $set;
<a name="l00963"></a>00963     $self-&gt;{problem} = $Problem;
<a name="l00964"></a>00964     $self-&gt;{requestedVersion} = $requestedVersion;
<a name="l00965"></a>00965 
<a name="l00966"></a>00966     $self-&gt;{userName} = $userName;
<a name="l00967"></a>00967     $self-&gt;{effectiveUserName} = $effectiveUserName;
<a name="l00968"></a>00968     $self-&gt;{user} = $User;
<a name="l00969"></a>00969     $self-&gt;{effectiveUser}   = $EffectiveUser;
<a name="l00970"></a>00970     $self-&gt;{permissionLevel} = $permissionLevel;
<a name="l00971"></a>00971 
<a name="l00972"></a>00972     $self-&gt;{isOpen} = $isOpen;
<a name="l00973"></a>00973     $self-&gt;{isClosed} = $isClosed;
<a name="l00974"></a>00974     $self-&gt;{versionIsOpen} = $versionIsOpen;
<a name="l00975"></a>00975 
<a name="l00976"></a>00976     $self-&gt;{timeNow} = $timeNow;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978 <span class="preprocessor">    ####################################</span>
<a name="l00979"></a>00979 <span class="preprocessor"></span><span class="preprocessor">    # form processing</span>
<a name="l00980"></a>00980 <span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<a name="l00981"></a>00981 <span class="preprocessor"></span>
<a name="l00982"></a>00982 <span class="preprocessor">    # this is the same as the following, but doesn&#39;t appear in Problem.pm</span>
<a name="l00983"></a>00983 <span class="preprocessor"></span>    my $newPage = $r-&gt;param(<span class="stringliteral">&quot;newPage&quot;</span>);
<a name="l00984"></a>00984     $self-&gt;{newPage} = $newPage;
<a name="l00985"></a>00985 
<a name="l00986"></a>00986 <span class="preprocessor">    # also get the current page, if it&#39;s given</span>
<a name="l00987"></a>00987 <span class="preprocessor"></span>    my $currentPage = $r-&gt;param(<span class="stringliteral">&quot;currentPage&quot;</span>) || 1;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989 <span class="preprocessor">    # this is a hack manage previewing a page.  we set previewAnswers to </span>
<a name="l00990"></a>00990 <span class="preprocessor"></span><span class="preprocessor">    # yes if either of the following are true:</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span><span class="preprocessor">    #  1. the &quot;previewAnswers&quot; input is set (the &quot;preview&quot; button was</span>
<a name="l00992"></a>00992 <span class="preprocessor"></span><span class="preprocessor">    #     clicked), or </span>
<a name="l00993"></a>00993 <span class="preprocessor"></span><span class="preprocessor">    #  2. the &quot;previewHack&quot; input is set (a preview link was used)</span>
<a name="l00994"></a>00994 <span class="preprocessor"></span>    my $prevOr = $r-&gt;param(<span class="stringliteral">&#39;previewAnswers&#39;</span>) || $r-&gt;param(<span class="stringliteral">&#39;previewHack&#39;</span>);
<a name="l00995"></a>00995     $r-&gt;param(<span class="stringliteral">&#39;previewAnswers&#39;</span>, $prevOr) <span class="keywordflow">if</span> ( defined( $prevOr ) );
<a name="l00996"></a>00996 
<a name="l00997"></a>00997 <span class="preprocessor">        # [This section lifted from Problem.pm] ##############################</span>
<a name="l00998"></a>00998 <span class="preprocessor"></span>
<a name="l00999"></a>00999 <span class="preprocessor">    # set options from form fields (see comment at top of file for names)</span>
<a name="l01000"></a>01000 <span class="preprocessor"></span>    my $displayMode      = $r-&gt;param(<span class="stringliteral">&quot;displayMode&quot;</span>) || 
<a name="l01001"></a>01001         $ce-&gt;{pg}-&gt;{options}-&gt;{displayMode};
<a name="l01002"></a>01002     my $redisplay        = $r-&gt;param(<span class="stringliteral">&quot;redisplay&quot;</span>);
<a name="l01003"></a>01003     my $submitAnswers    = $r-&gt;param(<span class="stringliteral">&quot;submitAnswers&quot;</span>);
<a name="l01004"></a>01004     my $checkAnswers     = $r-&gt;param(<span class="stringliteral">&quot;checkAnswers&quot;</span>);
<a name="l01005"></a>01005     my $previewAnswers   = $r-&gt;param(<span class="stringliteral">&quot;previewAnswers&quot;</span>);
<a name="l01006"></a>01006 
<a name="l01007"></a>01007     my $formFields = { <a class="code" href="classWeBWorK_1_1Form.html">WeBWorK::Form</a>-&gt;new_from_paramable($r)-&gt;Vars };
<a name="l01008"></a>01008 
<a name="l01009"></a>01009     $self-&gt;{displayMode}    = $displayMode;
<a name="l01010"></a>01010     $self-&gt;{redisplay}      = $redisplay;
<a name="l01011"></a>01011     $self-&gt;{submitAnswers}  = $submitAnswers;
<a name="l01012"></a>01012     $self-&gt;{checkAnswers}   = $checkAnswers;
<a name="l01013"></a>01013     $self-&gt;{previewAnswers} = $previewAnswers;
<a name="l01014"></a>01014     $self-&gt;{formFields}     = $formFields;
<a name="l01015"></a>01015 
<a name="l01016"></a>01016 <span class="preprocessor">    # now that we&#39;ve set all the necessary variables quit out if the set or </span>
<a name="l01017"></a>01017 <span class="preprocessor"></span><span class="preprocessor">    #    problem is invalid</span>
<a name="l01018"></a>01018 <span class="preprocessor"></span>
<a name="l01019"></a>01019     <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{invalidSet} || $self-&gt;{invalidProblem};
<a name="l01020"></a>01020 
<a name="l01021"></a>01021 <span class="preprocessor">    # [End lifted section] ###############################################</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span>
<a name="l01023"></a>01023 <span class="preprocessor">    ####################################</span>
<a name="l01024"></a>01024 <span class="preprocessor"></span><span class="preprocessor">    # permissions</span>
<a name="l01025"></a>01025 <span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<a name="l01026"></a>01026 <span class="preprocessor"></span>
<a name="l01027"></a>01027 <span class="preprocessor">    # bail without doing anything if the set isn&#39;t yet open for this user</span>
<a name="l01028"></a>01028 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ! ( $self-&gt;{isOpen} ||
<a name="l01029"></a>01029          $authz-&gt;hasPermissions($userName,<span class="stringliteral">&quot;view_unopened_sets&quot;</span>) ) ) {
<a name="l01030"></a>01030         $self-&gt;{invalidSet} = <span class="stringliteral">&quot;This set is not yet open.&quot;</span>;
<a name="l01031"></a>01031         <span class="keywordflow">return</span>;
<a name="l01032"></a>01032     }
<a name="l01033"></a>01033 
<a name="l01034"></a>01034 <span class="preprocessor">    # what does the user want to do?</span>
<a name="l01035"></a>01035 <span class="preprocessor"></span>    my %want = 
<a name="l01036"></a>01036         (showOldAnswers     =&gt; $r-&gt;param(<span class="stringliteral">&quot;showOldAnswers&quot;</span>) || 
<a name="l01037"></a>01037                    $ce-&gt;{pg}-&gt;{options}-&gt;{showOldAnswers},
<a name="l01038"></a>01038          showCorrectAnswers =&gt; ($r-&gt;param(<span class="stringliteral">&quot;showCorrectAnswers&quot;</span>) || 
<a name="l01039"></a>01039                                $ce-&gt;{pg}-&gt;{options}-&gt;{showCorrectAnswers}) &amp;&amp;
<a name="l01040"></a>01040                                    ($submitAnswers || $checkAnswers),
<a name="l01041"></a>01041          showHints          =&gt; $r-&gt;param(<span class="stringliteral">&quot;showHints&quot;</span>) || 
<a name="l01042"></a>01042                            $ce-&gt;{pg}-&gt;{options}-&gt;{showHints},
<a name="l01043"></a>01043          showSolutions      =&gt; ($r-&gt;param(<span class="stringliteral">&quot;showSolutions&quot;</span>) || 
<a name="l01044"></a>01044                            $ce-&gt;{pg}-&gt;{options}-&gt;{showSolutions}) &amp;&amp;
<a name="l01045"></a>01045                                    ($submitAnswers || $checkAnswers),
<a name="l01046"></a>01046          recordAnswers      =&gt; $submitAnswers,
<a name="l01047"></a>01047 <span class="preprocessor">    # we also want to check answers if we were checking answers and are</span>
<a name="l01048"></a>01048 <span class="preprocessor"></span><span class="preprocessor">    #    switching between pages</span>
<a name="l01049"></a>01049 <span class="preprocessor"></span>         checkAnswers       =&gt; $checkAnswers,
<a name="l01050"></a>01050          );
<a name="l01051"></a>01051 
<a name="l01052"></a>01052 <span class="preprocessor">    # are certain options enforced?</span>
<a name="l01053"></a>01053 <span class="preprocessor"></span>    my %must = 
<a name="l01054"></a>01054         (showOldAnswers     =&gt; 0,
<a name="l01055"></a>01055          showCorrectAnswers =&gt; 0,
<a name="l01056"></a>01056          showHints          =&gt; 0,
<a name="l01057"></a>01057          showSolutions      =&gt; 0,
<a name="l01058"></a>01058          recordAnswers      =&gt; ! $authz-&gt;hasPermissions($userName, 
<a name="l01059"></a>01059                                 <span class="stringliteral">&quot;avoid_recording_answers&quot;</span>),
<a name="l01060"></a>01060          checkAnswers       =&gt; 0,
<a name="l01061"></a>01061          );
<a name="l01062"></a>01062 
<a name="l01063"></a>01063 <span class="preprocessor">    # does the user have permission to use certain options?</span>
<a name="l01064"></a>01064 <span class="preprocessor"></span>    my @args = ($User, $PermissionLevel, $EffectiveUser, $set, $Problem, 
<a name="l01065"></a>01065             $tmplSet);
<a name="l01066"></a>01066     my $sAns = ( $submitAnswers ? 1 : 0 );
<a name="l01067"></a>01067     my %can = 
<a name="l01068"></a>01068         (showOldAnswers     =&gt; $self-&gt;can_showOldAnswers(@args), 
<a name="l01069"></a>01069          showCorrectAnswers =&gt; $self-&gt;can_showCorrectAnswers(@args, $sAns),
<a name="l01070"></a>01070          showHints          =&gt; $self-&gt;can_showHints(@args),
<a name="l01071"></a>01071          showSolutions      =&gt; $self-&gt;can_showSolutions(@args, $sAns),
<a name="l01072"></a>01072          recordAnswers      =&gt; $self-&gt;can_recordAnswers(@args),
<a name="l01073"></a>01073          checkAnswers       =&gt; $self-&gt;can_checkAnswers(@args),
<a name="l01074"></a>01074          recordAnswersNextTime =&gt; $self-&gt;can_recordAnswers(@args, $sAns),
<a name="l01075"></a>01075          checkAnswersNextTime  =&gt; $self-&gt;can_checkAnswers(@args, $sAns),
<a name="l01076"></a>01076          showScore          =&gt; $self-&gt;can_showScore(@args),
<a name="l01077"></a>01077          );
<a name="l01078"></a>01078 
<a name="l01079"></a>01079 <span class="preprocessor">    # final values for options</span>
<a name="l01080"></a>01080 <span class="preprocessor"></span>    my %will;
<a name="l01081"></a>01081     <span class="keywordflow">foreach</span> (keys %must) {
<a name="l01082"></a>01082         $will{$_} = $can{$_} &amp;&amp; ($must{$_} || $want{$_}) ;
<a name="l01083"></a>01083     }
<a name="l01084"></a>01084 
<a name="l01085"></a>01085 <span class="preprocessor">    ##### store fields #####</span>
<a name="l01086"></a>01086 <span class="preprocessor"></span>
<a name="l01087"></a>01087 <span class="preprocessor">## FIXME: the following is present in Problem.pm, but missing here.  how do we </span>
<a name="l01088"></a>01088 <span class="preprocessor"></span><span class="preprocessor">##   deal with it in the context of multiple problems with possible hints?</span>
<a name="l01089"></a>01089 <span class="preprocessor"></span><span class="preprocessor">## ##### fix hint/solution options #####</span>
<a name="l01090"></a>01090 <span class="preprocessor"></span><span class="preprocessor">## $can{showHints}     &amp;&amp;= $pg-&gt;{flags}-&gt;{hintExists}  </span>
<a name="l01091"></a>01091 <span class="preprocessor"></span><span class="preprocessor">##                     &amp;&amp;= $pg-&gt;{flags}-&gt;{showHintLimit}&lt;=$pg-&gt;{state}-&gt;{num_of_incorrect_ans};</span>
<a name="l01092"></a>01092 <span class="preprocessor"></span><span class="preprocessor">##    $can{showSolutions} &amp;&amp;= $pg-&gt;{flags}-&gt;{solutionExists};</span>
<a name="l01093"></a>01093 <span class="preprocessor"></span>    
<a name="l01094"></a>01094     $self-&gt;{want} = \%want;
<a name="l01095"></a>01095     $self-&gt;{must} = \%must;
<a name="l01096"></a>01096     $self-&gt;{can}  = \%can;
<a name="l01097"></a>01097     $self-&gt;{will} = \%will;
<a name="l01098"></a>01098 
<a name="l01099"></a>01099 
<a name="l01100"></a>01100 <span class="preprocessor">    ####################################</span>
<a name="l01101"></a>01101 <span class="preprocessor"></span><span class="preprocessor">    # set up problem numbering and multipage variables</span>
<a name="l01102"></a>01102 <span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<a name="l01103"></a>01103 <span class="preprocessor"></span>
<a name="l01104"></a>01104     my @problemNumbers;
<a name="l01105"></a>01105     <span class="keywordflow">if</span> ( $setName eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> ) {
<a name="l01106"></a>01106         @problemNumbers = ( 1 );
<a name="l01107"></a>01107     } <span class="keywordflow">else</span> {
<a name="l01108"></a>01108         @problemNumbers = $db-&gt;listProblemVersions($effectiveUserName,
<a name="l01109"></a>01109                                $setName,
<a name="l01110"></a>01110                                $setVersionNumber);
<a name="l01111"></a>01111     }
<a name="l01112"></a>01112 
<a name="l01113"></a>01113 <span class="preprocessor">    # to speed up processing of long (multi-page) tests, we want to only </span>
<a name="l01114"></a>01114 <span class="preprocessor"></span><span class="preprocessor">    #    translate those problems that are being submitted or are currently </span>
<a name="l01115"></a>01115 <span class="preprocessor"></span><span class="preprocessor">    #    being displayed.  so work out here which problems are on the </span>
<a name="l01116"></a>01116 <span class="preprocessor"></span><span class="preprocessor">    #    current page.</span>
<a name="l01117"></a>01117 <span class="preprocessor"></span>    my ( $numPages, $pageNumber, $numProbPerPage ) = ( 1, 0, 0 );
<a name="l01118"></a>01118     my ( $startProb, $endProb ) = ( 0, $#problemNumbers );
<a name="l01119"></a>01119 
<a name="l01120"></a>01120 <span class="preprocessor">    # update startProb and endProb for multipage tests</span>
<a name="l01121"></a>01121 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( defined($set-&gt;problems_per_page) &amp;&amp; $set-&gt;problems_per_page ) {
<a name="l01122"></a>01122         $numProbPerPage = $set-&gt;problems_per_page;
<a name="l01123"></a>01123         $pageNumber = ($newPage) ? $newPage : $currentPage;
<a name="l01124"></a>01124 
<a name="l01125"></a>01125         $numPages = scalar(@problemNumbers)/$numProbPerPage;
<a name="l01126"></a>01126         $numPages = int($numPages) + 1 <span class="keywordflow">if</span> (<span class="keywordtype">int</span>($numPages) != $numPages);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128         $startProb = ($pageNumber - 1)*$numProbPerPage;
<a name="l01129"></a>01129         $startProb = 0 <span class="keywordflow">if</span> ( $startProb &lt; 0 || 
<a name="l01130"></a>01130                     $startProb &gt; $#problemNumbers );
<a name="l01131"></a>01131         $endProb = ($startProb + $numProbPerPage &gt; $#problemNumbers) ? 
<a name="l01132"></a>01132             $#problemNumbers : $startProb + $numProbPerPage - 1;
<a name="l01133"></a>01133     }
<a name="l01134"></a>01134 
<a name="l01135"></a>01135 
<a name="l01136"></a>01136 <span class="preprocessor">    # set up problem list for randomly ordered tests</span>
<a name="l01137"></a>01137 <span class="preprocessor"></span>    my @probOrder = (0..$#problemNumbers);
<a name="l01138"></a>01138 
<a name="l01139"></a>01139 <span class="preprocessor">    # there&#39;s a routine to do this somewhere, I think...</span>
<a name="l01140"></a>01140 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $set-&gt;problem_randorder ) {
<a name="l01141"></a>01141         my @newOrder = ();
<a name="l01142"></a>01142 <span class="preprocessor">    # we need to keep the random order the same each time the set is loaded!</span>
<a name="l01143"></a>01143 <span class="preprocessor"></span><span class="preprocessor">    #    this requires either saving the order in the set definition, or </span>
<a name="l01144"></a>01144 <span class="preprocessor"></span><span class="preprocessor">    #    being sure that the random seed that we use is the same each time </span>
<a name="l01145"></a>01145 <span class="preprocessor"></span><span class="preprocessor">    #    the same set is called.  we&#39;ll do the latter by setting the seed </span>
<a name="l01146"></a>01146 <span class="preprocessor"></span><span class="preprocessor">    #    to the psvn of the problem set.  we use a local PGrandom object </span>
<a name="l01147"></a>01147 <span class="preprocessor"></span><span class="preprocessor">    #    to avoid mucking with the system seed.</span>
<a name="l01148"></a>01148 <span class="preprocessor"></span>        my $pgrand = PGrandom-&gt;new();
<a name="l01149"></a>01149         $pgrand-&gt;srand( $set-&gt;psvn );
<a name="l01150"></a>01150         <span class="keywordflow">while</span> ( @probOrder ) { 
<a name="l01151"></a>01151             my $i = int($pgrand-&gt;rand(scalar(@probOrder)));
<a name="l01152"></a>01152             push( @newOrder, $probOrder[$i] );
<a name="l01153"></a>01153             splice(@probOrder, $i, 1);
<a name="l01154"></a>01154         }
<a name="l01155"></a>01155         @probOrder = @newOrder;
<a name="l01156"></a>01156     }
<a name="l01157"></a>01157 <span class="preprocessor">    # now $probOrder[i] = the problem number, numbered from zero, that&#39;s </span>
<a name="l01158"></a>01158 <span class="preprocessor"></span><span class="preprocessor">    #    displayed in the ith position on the test</span>
<a name="l01159"></a>01159 <span class="preprocessor"></span>
<a name="l01160"></a>01160 <span class="preprocessor">    # make a list of those problems we&#39;re displaying</span>
<a name="l01161"></a>01161 <span class="preprocessor"></span>    my @probsToDisplay = ();
<a name="l01162"></a>01162     <span class="keywordflow">for</span> ( my $i=0; $i&lt;@probOrder; $i++ ) {
<a name="l01163"></a>01163         push(@probsToDisplay, $probOrder[$i]) 
<a name="l01164"></a>01164             <span class="keywordflow">if</span> ( $i &gt;= $startProb &amp;&amp; $i &lt;= $endProb );
<a name="l01165"></a>01165     }
<a name="l01166"></a>01166 
<a name="l01167"></a>01167 <span class="preprocessor">    ####################################</span>
<a name="l01168"></a>01168 <span class="preprocessor"></span><span class="preprocessor">    # process problems</span>
<a name="l01169"></a>01169 <span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<a name="l01170"></a>01170 <span class="preprocessor"></span>
<a name="l01171"></a>01171     my @problems = ();
<a name="l01172"></a>01172     my @pg_results = ();
<a name="l01173"></a>01173 <span class="preprocessor">    # pg errors are stored here; initialize it to empty to start</span>
<a name="l01174"></a>01174 <span class="preprocessor"></span>    $self-&gt;{errors} = [ ];
<a name="l01175"></a>01175 
<a name="l01176"></a>01176 <span class="preprocessor">    # process the problems as needed</span>
<a name="l01177"></a>01177 <span class="preprocessor"></span>    my @mergedProblems;
<a name="l01178"></a>01178     <span class="keywordflow">if</span> ( $setName eq <span class="stringliteral">&quot;Undefined_Set&quot;</span> ) {
<a name="l01179"></a>01179         @mergedProblems = ( $Problem );
<a name="l01180"></a>01180     } <span class="keywordflow">else</span> {
<a name="l01181"></a>01181         @mergedProblems = $db-&gt;getAllMergedProblemVersions($effectiveUserName, $setName, $setVersionNumber);
<a name="l01182"></a>01182     }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184     <span class="keywordflow">foreach</span> my $problemNumber (sort {$a&lt;=&gt;$b } @problemNumbers) {
<a name="l01185"></a>01185 
<a name="l01186"></a>01186 <span class="preprocessor">        # pIndex numbers from zero</span>
<a name="l01187"></a>01187 <span class="preprocessor"></span>        my $pIndex = $problemNumber - 1;
<a name="l01188"></a>01188         <span class="keywordflow">if</span> ( ! defined( $mergedProblems[$pIndex] ) ) {
<a name="l01189"></a>01189             $self-&gt;{invalidSet} = <span class="stringliteral">&quot;One or more of the problems &quot;</span> .
<a name="l01190"></a>01190                 <span class="stringliteral">&quot;in this set have not been assigned to you.&quot;</span>;
<a name="l01191"></a>01191             <span class="keywordflow">return</span>;
<a name="l01192"></a>01192         }
<a name="l01193"></a>01193         my $ProblemN = $mergedProblems[$pIndex];
<a name="l01194"></a>01194 
<a name="l01195"></a>01195 <span class="preprocessor">        # sticky answers are set up here</span>
<a name="l01196"></a>01196 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( not ( $submitAnswers or $previewAnswers or $checkAnswers or
<a name="l01197"></a>01197                $newPage ) and $will{showOldAnswers} ) {
<a name="l01198"></a>01198 
<a name="l01199"></a>01199             my %oldAnswers = decodeAnswers( $ProblemN-&gt;last_answer);
<a name="l01200"></a>01200             $formFields-&gt;{$_} = $oldAnswers{$_} <span class="keywordflow">foreach</span> ( keys %oldAnswers );
<a name="l01201"></a>01201         }
<a name="l01202"></a>01202         push( @problems, $ProblemN );
<a name="l01203"></a>01203 
<a name="l01204"></a>01204 <span class="preprocessor">        # if we don&#39;t have to translate this problem, just save the </span>
<a name="l01205"></a>01205 <span class="preprocessor"></span><span class="preprocessor">        #    problem number</span>
<a name="l01206"></a>01206 <span class="preprocessor"></span>        my $pg = $problemNumber;
<a name="l01207"></a>01207 <span class="preprocessor">        # this is the actual translation of each problem.  errors are </span>
<a name="l01208"></a>01208 <span class="preprocessor"></span><span class="preprocessor">        #    stored in @{$self-&gt;{errors}} in each case</span>
<a name="l01209"></a>01209 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( (grep /^$pIndex$/, @probsToDisplay) || $submitAnswers ) {
<a name="l01210"></a>01210             $pg = $self-&gt;getProblemHTML($self-&gt;{effectiveUser},
<a name="l01211"></a>01211                             $set, $formFields,
<a name="l01212"></a>01212                             $ProblemN);
<a name="l01213"></a>01213         }
<a name="l01214"></a>01214         push(@pg_results, $pg);
<a name="l01215"></a>01215     }
<a name="l01216"></a>01216     $self-&gt;{ra_problems} = \@problems;
<a name="l01217"></a>01217     $self-&gt;{ra_pg_results}=\@pg_results;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     $self-&gt;{startProb} = $startProb;
<a name="l01220"></a>01220     $self-&gt;{endProb} = $endProb;
<a name="l01221"></a>01221     $self-&gt;{numPages} = $numPages;
<a name="l01222"></a>01222     $self-&gt;{pageNumber} = $pageNumber;
<a name="l01223"></a>01223     $self-&gt;{ra_probOrder} = \@probOrder;
<a name="l01224"></a>01224 }
<a name="l01225"></a>01225 
<a name="l01226"></a>01226 sub path {
<a name="l01227"></a>01227     my ( $self, $args ) = @_;
<a name="l01228"></a>01228 
<a name="l01229"></a>01229     my $r = $self-&gt;{r};
<a name="l01230"></a>01230     my $setName = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l01231"></a>01231     my $ce = $self-&gt;{ce};
<a name="l01232"></a>01232     my $root = $ce-&gt;{webworkURLs}-&gt;{root};
<a name="l01233"></a>01233     my $courseName = $ce-&gt;{courseName};
<a name="l01234"></a>01234  
<a name="l01235"></a>01235     <span class="keywordflow">return</span> $self-&gt;pathMacro( $args, <span class="stringliteral">&quot;Home&quot;</span> =&gt; <span class="stringliteral">&quot;$root&quot;</span>, 
<a name="l01236"></a>01236                  $courseName =&gt; <span class="stringliteral">&quot;$root/$courseName&quot;</span>,
<a name="l01237"></a>01237                  $setName =&gt; <span class="stringliteral">&quot;&quot;</span> );
<a name="l01238"></a>01238 }
<a name="l01239"></a>01239 
<a name="l01240"></a>01240 sub nav {
<a name="l01241"></a>01241     my ($self, $args) = @_;
<a name="l01242"></a>01242     
<a name="l01243"></a>01243     my $r = $self-&gt;{r};
<a name="l01244"></a>01244     my $setName = $r-&gt;urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
<a name="l01245"></a>01245     my $ce = $self-&gt;{ce};
<a name="l01246"></a>01246     my $root = $ce-&gt;{webworkURLs}-&gt;{root};
<a name="l01247"></a>01247     my $courseName = $ce-&gt;{courseName};
<a name="l01248"></a>01248     my @links = (<span class="stringliteral">&quot;Problem Sets&quot;</span> , <span class="stringliteral">&quot;$root/$courseName&quot;</span>, <span class="stringliteral">&quot;navUp&quot;</span>);
<a name="l01249"></a>01249     my $tail = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01250"></a>01250     
<a name="l01251"></a>01251     <span class="keywordflow">return</span> $self-&gt;navMacro($args, $tail, @links);
<a name="l01252"></a>01252 }
<a name="l01253"></a>01253 
<a name="l01254"></a>01254 sub options {
<a name="l01255"></a>01255     my ($self) = @_;
<a name="l01256"></a>01256 <span class="preprocessor">    #warn &quot;doing options in GatewayQuiz&quot;;</span>
<a name="l01257"></a>01257 <span class="preprocessor"></span>    
<a name="l01258"></a>01258 <span class="preprocessor">    # don&#39;t show options if we don&#39;t have anything to show</span>
<a name="l01259"></a>01259 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="keywordflow">if</span> $self-&gt;{invalidSet} or $self-&gt;{invalidProblem};
<a name="l01260"></a>01260     <span class="keywordflow">return</span> unless $self-&gt;{isOpen};
<a name="l01261"></a>01261     
<a name="l01262"></a>01262     my $displayMode = $self-&gt;{displayMode};
<a name="l01263"></a>01263     my %can = %{ $self-&gt;{can} };
<a name="l01264"></a>01264     
<a name="l01265"></a>01265     my @options_to_show = <span class="stringliteral">&quot;displayMode&quot;</span>;
<a name="l01266"></a>01266     push @options_to_show, <span class="stringliteral">&quot;showOldAnswers&quot;</span> <span class="keywordflow">if</span> $can{showOldAnswers};
<a name="l01267"></a>01267     push @options_to_show, <span class="stringliteral">&quot;showHints&quot;</span> <span class="keywordflow">if</span> $can{showHints};
<a name="l01268"></a>01268     push @options_to_show, <span class="stringliteral">&quot;showSolutions&quot;</span> <span class="keywordflow">if</span> $can{showSolutions};
<a name="l01269"></a>01269     
<a name="l01270"></a>01270     <span class="keywordflow">return</span> $self-&gt;optionsMacro(
<a name="l01271"></a>01271         options_to_show =&gt; \@options_to_show,
<a name="l01272"></a>01272     );
<a name="l01273"></a>01273 }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275 sub body {
<a name="l01276"></a>01276     my $self = shift();
<a name="l01277"></a>01277     my $r = $self-&gt;r;
<a name="l01278"></a>01278     my $ce = $r-&gt;ce;
<a name="l01279"></a>01279     my $db = $r-&gt;db;
<a name="l01280"></a>01280     my $authz = $r-&gt;authz;
<a name="l01281"></a>01281     my $urlpath = $r-&gt;urlpath;
<a name="l01282"></a>01282     my $user = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l01283"></a>01283     my $effectiveUser = $r-&gt;param(<span class="stringliteral">&#39;effectiveUser&#39;</span>);
<a name="l01284"></a>01284 
<a name="l01285"></a>01285 <span class="preprocessor">    # report everything with the same time that we started with</span>
<a name="l01286"></a>01286 <span class="preprocessor"></span>    my $timeNow = $self-&gt;{timeNow};
<a name="l01287"></a>01287     my $grace = $ce-&gt;{gatewayGracePeriod};
<a name="l01288"></a>01288 
<a name="l01289"></a>01289 <span class="preprocessor">    #########################################</span>
<a name="l01290"></a>01290 <span class="preprocessor"></span><span class="preprocessor">    # preliminary error checking and output</span>
<a name="l01291"></a>01291 <span class="preprocessor"></span><span class="preprocessor">    #########################################</span>
<a name="l01292"></a>01292 <span class="preprocessor"></span>
<a name="l01293"></a>01293 <span class="preprocessor">    # if $self-&gt;{invalidSet} is set, then we have an error and should</span>
<a name="l01294"></a>01294 <span class="preprocessor"></span><span class="preprocessor">    #    just bail with the appropriate error message</span>
<a name="l01295"></a>01295 <span class="preprocessor"></span>
<a name="l01296"></a>01296     <span class="keywordflow">if</span> ($self-&gt;{invalidSet} || $self-&gt;{invalidProblem}) {
<a name="l01297"></a>01297 <span class="preprocessor">        # delete any proctor keys that are floating around</span>
<a name="l01298"></a>01298 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $self-&gt;{<span class="stringliteral">&#39;assignment_type&#39;</span>} eq <span class="stringliteral">&#39;proctored_gateway&#39;</span> ) {
<a name="l01299"></a>01299             my $proctorID = $r-&gt;param(<span class="stringliteral">&#39;proctor_user&#39;</span>);
<a name="l01300"></a>01300             <span class="keywordflow">if</span> ( $proctorID ) {
<a name="l01301"></a>01301                 eval{ $db-&gt;deleteKey(<span class="stringliteral">&quot;$effectiveUser,$proctorID&quot;</span>); };
<a name="l01302"></a>01302                 eval{ $db-&gt;deleteKey(<span class="stringliteral">&quot;$effectiveUser,$proctorID,g&quot;</span>); };
<a name="l01303"></a>01303             }
<a name="l01304"></a>01304         }
<a name="l01305"></a>01305 
<a name="l01306"></a>01306         my $newlink = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01307"></a>01307         my $usernote = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01308"></a>01308         <span class="keywordflow">if</span> ( defined( $self-&gt;{invalidVersionCreation} ) &amp;&amp;
<a name="l01309"></a>01309              $self-&gt;{invalidVersionCreation} == 1 ) {
<a name="l01310"></a>01310             my $gwpage = $urlpath-&gt;newFromModule($urlpath-&gt;module,$r,
<a name="l01311"></a>01311                 courseID=&gt;$urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>),
<a name="l01312"></a>01312                 setID=&gt;$urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>));
<a name="l01313"></a>01313             my $link = $self-&gt;systemLink( $gwpage,
<a name="l01314"></a>01314                 params=&gt;{effectiveUser =&gt; $effectiveUser,
<a name="l01315"></a>01315                      user =&gt; $user,
<a name="l01316"></a>01316                      createnew_ok =&gt; 1} );
<a name="l01317"></a>01317             $newlink = CGI::p(CGI::a({href=&gt;$link},
<a name="l01318"></a>01318                 <span class="stringliteral">&quot;Create new set version.&quot;</span>));
<a name="l01319"></a>01319             $usernote = <span class="stringliteral">&quot; (acted as by $user)&quot;</span>;
<a name="l01320"></a>01320         } elsif ( defined( $self-&gt;{invalidVersionCreation} ) &amp;&amp;
<a name="l01321"></a>01321               $self-&gt;{invalidVersionCreation} == 2 ) {
<a name="l01322"></a>01322             $usernote = <span class="stringliteral">&quot; (acted as by $user)&quot;</span>;
<a name="l01323"></a>01323         }
<a name="l01324"></a>01324 
<a name="l01325"></a>01325         <span class="keywordflow">return</span> CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;ResultsWithError&quot;</span>},
<a name="l01326"></a>01326                 CGI::p(<span class="stringliteral">&quot;The selected problem set (&quot;</span> . 
<a name="l01327"></a>01327                        $urlpath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>) . <span class="stringliteral">&quot;) is not &quot;</span> .
<a name="l01328"></a>01328                        <span class="stringliteral">&quot;a valid set for $effectiveUser&quot;</span> .
<a name="l01329"></a>01329                        <span class="stringliteral">&quot;$usernote:&quot;</span>),
<a name="l01330"></a>01330                 CGI::p($self-&gt;{invalidSet}),
<a name="l01331"></a>01331                 $newlink);
<a name="l01332"></a>01332     }
<a name="l01333"></a>01333 
<a name="l01334"></a>01334     my $tmplSet = $self-&gt;{tmplSet};
<a name="l01335"></a>01335     my $set = $self-&gt;{<span class="keyword">set</span>};
<a name="l01336"></a>01336     my $Problem = $self-&gt;{problem};
<a name="l01337"></a>01337     my $permissionLevel = $self-&gt;{permissionLevel};
<a name="l01338"></a>01338     my $submitAnswers = $self-&gt;{submitAnswers};
<a name="l01339"></a>01339     my $checkAnswers = $self-&gt;{checkAnswers};
<a name="l01340"></a>01340     my $previewAnswers = $self-&gt;{previewAnswers};
<a name="l01341"></a>01341     my $newPage = $self-&gt;{newPage};
<a name="l01342"></a>01342     my %want = %{ $self-&gt;{want} };
<a name="l01343"></a>01343     my %can = %{ $self-&gt;{can} };
<a name="l01344"></a>01344     my %must = %{ $self-&gt;{must} };
<a name="l01345"></a>01345     my %will = %{ $self-&gt;{will} };
<a name="l01346"></a>01346 
<a name="l01347"></a>01347     my @problems = @{ $self-&gt;{ra_problems} };
<a name="l01348"></a>01348     my @pg_results = @{ $self-&gt;{ra_pg_results} };
<a name="l01349"></a>01349     my @pg_errors = @{ $self-&gt;{errors} };
<a name="l01350"></a>01350     my $requestedVersion = $self-&gt;{requestedVersion};
<a name="l01351"></a>01351 
<a name="l01352"></a>01352     my $startProb = $self-&gt;{startProb};
<a name="l01353"></a>01353     my $endProb = $self-&gt;{endProb};
<a name="l01354"></a>01354     my $numPages = $self-&gt;{numPages};
<a name="l01355"></a>01355     my $pageNumber = $self-&gt;{pageNumber};
<a name="l01356"></a>01356     my @probOrder = @{$self-&gt;{ra_probOrder}};
<a name="l01357"></a>01357 
<a name="l01358"></a>01358     my $setName  = $set-&gt;set_id;
<a name="l01359"></a>01359     my $versionNumber = $set-&gt;version_id;
<a name="l01360"></a>01360     my $setVName = <span class="stringliteral">&quot;$setName,v$versionNumber&quot;</span>;
<a name="l01361"></a>01361     my $numProbPerPage = $set-&gt;problems_per_page;
<a name="l01362"></a>01362 
<a name="l01363"></a>01363 <span class="preprocessor">    # translation errors -- we use the same output routine as Problem.pm, </span>
<a name="l01364"></a>01364 <span class="preprocessor"></span><span class="preprocessor">    #    but play around to allow for errors on multiple translations </span>
<a name="l01365"></a>01365 <span class="preprocessor"></span><span class="preprocessor">    #    because we have an array of problems to deal with.</span>
<a name="l01366"></a>01366 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( @pg_errors ) {
<a name="l01367"></a>01367         my $errorNum = 1;
<a name="l01368"></a>01368         my ( $message, $context ) = ( <span class="stringliteral">&#39;&#39;</span>, <span class="stringliteral">&#39;&#39;</span> );
<a name="l01369"></a>01369         <span class="keywordflow">foreach</span> ( @pg_errors ) {
<a name="l01370"></a>01370 
<a name="l01371"></a>01371             $message .= <span class="stringliteral">&quot;$errorNum. &quot;</span> <span class="keywordflow">if</span> ( @pg_errors &gt; 1 );
<a name="l01372"></a>01372             $message .= $_-&gt;{message} . CGI::br() . <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01373"></a>01373 
<a name="l01374"></a>01374             $context .= CGI::p((@pg_errors &gt; 1? <span class="stringliteral">&quot;$errorNum.&quot;</span>: <span class="stringliteral">&#39;&#39;</span>) . 
<a name="l01375"></a>01375                        $_-&gt;{context} ) . <span class="stringliteral">&quot;\n\n&quot;</span> . 
<a name="l01376"></a>01376                        CGI::hr() . <span class="stringliteral">&quot;\n\n&quot;</span>;
<a name="l01377"></a>01377         }
<a name="l01378"></a>01378         <span class="keywordflow">return</span> $self-&gt;errorOutput( $message, $context );
<a name="l01379"></a>01379     }
<a name="l01380"></a>01380 
<a name="l01381"></a>01381 <span class="preprocessor">    ####################################</span>
<a name="l01382"></a>01382 <span class="preprocessor"></span><span class="preprocessor">    # answer processing</span>
<a name="l01383"></a>01383 <span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<a name="l01384"></a>01384 <span class="preprocessor"></span>
<a name="l01385"></a>01385     debug(<span class="stringliteral">&quot;begin answer processing&quot;</span>); 
<a name="l01386"></a>01386 
<a name="l01387"></a>01387     my @scoreRecordedMessage = (<span class="stringliteral">&#39;&#39;</span>) x scalar(@problems);
<a name="l01388"></a>01388 
<a name="l01389"></a>01389 <span class="preprocessor">    ####################################</span>
<a name="l01390"></a>01390 <span class="preprocessor"></span><span class="preprocessor">    # save results to database as appropriate</span>
<a name="l01391"></a>01391 <span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<a name="l01392"></a>01392 <span class="preprocessor"></span>
<a name="l01393"></a>01393     <span class="keywordflow">if</span> ( $submitAnswers || ( ($previewAnswers || $newPage) &amp;&amp;
<a name="l01394"></a>01394                  $can{recordAnswers} ) ) {
<a name="l01395"></a>01395 <span class="preprocessor">        # if we&#39;re submitting answers, we have to save the problems</span>
<a name="l01396"></a>01396 <span class="preprocessor"></span><span class="preprocessor">        #    to the database.</span>
<a name="l01397"></a>01397 <span class="preprocessor"></span><span class="preprocessor">        # if we&#39;re previewing or switching pages and can still</span>
<a name="l01398"></a>01398 <span class="preprocessor"></span><span class="preprocessor">        #    record answers, we save the last answer for future </span>
<a name="l01399"></a>01399 <span class="preprocessor"></span><span class="preprocessor">        #    reference</span>
<a name="l01400"></a>01400 <span class="preprocessor"></span>
<a name="l01401"></a>01401 <span class="preprocessor">        # first, if we&#39;re submitting answers for a proctored exam, </span>
<a name="l01402"></a>01402 <span class="preprocessor"></span><span class="preprocessor">        #    we want to delete the proctor keys that authorized </span>
<a name="l01403"></a>01403 <span class="preprocessor"></span><span class="preprocessor">        #    that grading, so that it isn&#39;t possible to just log </span>
<a name="l01404"></a>01404 <span class="preprocessor"></span><span class="preprocessor">        #    in and take another proctored test without getting </span>
<a name="l01405"></a>01405 <span class="preprocessor"></span><span class="preprocessor">        #    reauthorized</span>
<a name="l01406"></a>01406 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $submitAnswers &amp;&amp; 
<a name="l01407"></a>01407              $self-&gt;{<span class="stringliteral">&#39;assignment_type&#39;</span>} eq <span class="stringliteral">&#39;proctored_gateway&#39;</span> ) {
<a name="l01408"></a>01408             my $proctorID = $r-&gt;param(<span class="stringliteral">&#39;proctor_user&#39;</span>);
<a name="l01409"></a>01409 
<a name="l01410"></a>01410 <span class="preprocessor">            # if we don&#39;t have attempts left, delete all</span>
<a name="l01411"></a>01411 <span class="preprocessor"></span><span class="preprocessor">            #    proctor keys for this user</span>
<a name="l01412"></a>01412 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $set-&gt;attempts_per_version - 1 -
<a name="l01413"></a>01413                  $Problem-&gt;num_correct - $Problem-&gt;num_incorrect 
<a name="l01414"></a>01414                  &lt;= 0 ) {   
<a name="l01415"></a>01415                 eval{ $db-&gt;deleteAllProctorKeys( $effectiveUser ); };
<a name="l01416"></a>01416             } <span class="keywordflow">else</span> {
<a name="l01417"></a>01417 <span class="preprocessor">                # otherwise, delete only the grading key</span>
<a name="l01418"></a>01418 <span class="preprocessor"></span>                eval{ $db-&gt;deleteKey(<span class="stringliteral">&quot;$effectiveUser,$proctorID,g&quot;</span>); };
<a name="l01419"></a>01419 <span class="preprocessor">                # in this case we may have a past, login, </span>
<a name="l01420"></a>01420 <span class="preprocessor"></span><span class="preprocessor">                #    proctor key that we can keep so that </span>
<a name="l01421"></a>01421 <span class="preprocessor"></span><span class="preprocessor">                #    we don&#39;t have to get another login to</span>
<a name="l01422"></a>01422 <span class="preprocessor"></span><span class="preprocessor">                #    continue working the test</span>
<a name="l01423"></a>01423 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( $r-&gt;param(<span class="stringliteral">&quot;past_proctor_user&quot;</span>) &amp;&amp;
<a name="l01424"></a>01424                      $r-&gt;param(<span class="stringliteral">&quot;past_proctor_key&quot;</span>) ) {
<a name="l01425"></a>01425                     $r-&gt;param(<span class="stringliteral">&quot;proctor_user&quot;</span>, $r-&gt;param(<span class="stringliteral">&quot;past_proctor_user&quot;</span>));
<a name="l01426"></a>01426                     $r-&gt;param(<span class="stringliteral">&quot;proctor_key&quot;</span>, $r-&gt;param(<span class="stringliteral">&quot;past_proctor_key&quot;</span>));
<a name="l01427"></a>01427                 }
<a name="l01428"></a>01428             }
<a name="l01429"></a>01429 <span class="preprocessor">            # this is unsubtle, but we&#39;d rather not have bogus </span>
<a name="l01430"></a>01430 <span class="preprocessor"></span><span class="preprocessor">            #    keys sitting around</span>
<a name="l01431"></a>01431 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $@ ) {
<a name="l01432"></a>01432                 die(<span class="stringliteral">&quot;ERROR RESETTING PROCTOR GRADING KEY(S): $@\n&quot;</span>);
<a name="l01433"></a>01433             }
<a name="l01434"></a>01434 
<a name="l01435"></a>01435         }
<a name="l01436"></a>01436 
<a name="l01437"></a>01437         my @pureProblems = $db-&gt;getAllProblemVersions($effectiveUser,
<a name="l01438"></a>01438                                   $setName,
<a name="l01439"></a>01439                                   $versionNumber);
<a name="l01440"></a>01440         <span class="keywordflow">foreach</span> my $i ( 0 .. $#problems ) {  # process each problem
<a name="l01441"></a>01441 <span class="preprocessor">            # this code is essentially that from Problem.pm</span>
<a name="l01442"></a>01442 <span class="preprocessor"></span>            my $pureProblem = $pureProblems[$i];
<a name="l01443"></a>01443 
<a name="l01444"></a>01444 <span class="preprocessor">            # store answers in problem for sticky answers later</span>
<a name="l01445"></a>01445 <span class="preprocessor"></span>            my %answersToStore;
<a name="l01446"></a>01446 
<a name="l01447"></a>01447 <span class="preprocessor">            # we have to be a little careful about getting the</span>
<a name="l01448"></a>01448 <span class="preprocessor"></span><span class="preprocessor">            #    answers that we&#39;re saving, because we don&#39;t have</span>
<a name="l01449"></a>01449 <span class="preprocessor"></span><span class="preprocessor">            #    a pg_results object for all problems if we&#39;re not </span>
<a name="l01450"></a>01450 <span class="preprocessor"></span><span class="preprocessor">            #    submitting</span>
<a name="l01451"></a>01451 <span class="preprocessor"></span>            my %answerHash = ();
<a name="l01452"></a>01452             my @answer_order = ();
<a name="l01453"></a>01453             <span class="keywordflow">if</span> ( ref( $pg_results[$i] ) ) {
<a name="l01454"></a>01454                 %answerHash = %{$pg_results[$i]-&gt;{answers}};
<a name="l01455"></a>01455                 $answersToStore{$_} = $self-&gt;{formFields}-&gt;{$_} 
<a name="l01456"></a>01456                     <span class="keywordflow">foreach</span> (keys %answerHash);
<a name="l01457"></a>01457 <span class="preprocessor">                # check for extra answers that slipped </span>
<a name="l01458"></a>01458 <span class="preprocessor"></span><span class="preprocessor">                #    by---e.g. for matrices, and get them </span>
<a name="l01459"></a>01459 <span class="preprocessor"></span><span class="preprocessor">                #    from the original input form</span>
<a name="l01460"></a>01460 <span class="preprocessor"></span>                my @extra_answer_names = 
<a name="l01461"></a>01461                     @{ $pg_results[$i]-&gt;{flags}-&gt;{KEPT_EXTRA_ANSWERS} };
<a name="l01462"></a>01462                 $answersToStore{$_} = 
<a name="l01463"></a>01463                     $self-&gt;{formFields}-&gt;{$_} <span class="keywordflow">foreach</span> (@extra_answer_names);
<a name="l01464"></a>01464                 @answer_order = 
<a name="l01465"></a>01465                     ( @{$pg_results[$i]-&gt;{flags}-&gt;{ANSWER_ENTRY_ORDER}}, 
<a name="l01466"></a>01466                       @extra_answer_names );
<a name="l01467"></a>01467             } <span class="keywordflow">else</span> {
<a name="l01468"></a>01468                 my $prefix = sprintf(<span class="stringliteral">&#39;Q%04d_&#39;</span>,$i+1);
<a name="l01469"></a>01469                 my @fields = sort grep {/^$prefix/} (keys %{$self-&gt;{formFields}});
<a name="l01470"></a>01470                 %answersToStore = map {$_ =&gt; $self-&gt;{formFields}-&gt;{$_}} @fields;
<a name="l01471"></a>01471                 @answer_order = @fields;
<a name="l01472"></a>01472             }
<a name="l01473"></a>01473             my $answerString = encodeAnswers( %answersToStore, 
<a name="l01474"></a>01474                               @answer_order );
<a name="l01475"></a>01475 <span class="preprocessor">            # and get the last answer </span>
<a name="l01476"></a>01476 <span class="preprocessor"></span>            $problems[$i]-&gt;last_answer( $answerString );
<a name="l01477"></a>01477             $pureProblem-&gt;last_answer( $answerString );
<a name="l01478"></a>01478 
<a name="l01479"></a>01479 <span class="preprocessor">            # next, store the state in the database if that makes </span>
<a name="l01480"></a>01480 <span class="preprocessor"></span><span class="preprocessor">            #    sense</span>
<a name="l01481"></a>01481 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $submitAnswers &amp;&amp; $will{recordAnswers} ) {
<a name="l01482"></a>01482   $problems[$i]-&gt;status($pg_results[$i]-&gt;{state}-&gt;{recorded_score});
<a name="l01483"></a>01483   $problems[$i]-&gt;attempted(1);
<a name="l01484"></a>01484   $problems[$i]-&gt;num_correct($pg_results[$i]-&gt;{state}-&gt;{num_of_correct_ans});
<a name="l01485"></a>01485   $problems[$i]-&gt;num_incorrect($pg_results[$i]-&gt;{state}-&gt;{num_of_incorrect_ans});
<a name="l01486"></a>01486   $pureProblem-&gt;status($pg_results[$i]-&gt;{state}-&gt;{recorded_score});
<a name="l01487"></a>01487   $pureProblem-&gt;attempted(1);
<a name="l01488"></a>01488   $pureProblem-&gt;num_correct($pg_results[$i]-&gt;{state}-&gt;{num_of_correct_ans});
<a name="l01489"></a>01489   $pureProblem-&gt;num_incorrect($pg_results[$i]-&gt;{state}-&gt;{num_of_incorrect_ans});
<a name="l01490"></a>01490 
<a name="l01491"></a>01491                 <span class="keywordflow">if</span> ( $db-&gt;putProblemVersion( $pureProblem ) ) {
<a name="l01492"></a>01492                     $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
<a name="l01493"></a>01493                         <span class="stringliteral">&quot;score on this problem was &quot;</span> .
<a name="l01494"></a>01494                         <span class="stringliteral">&quot;recorded.&quot;</span>;
<a name="l01495"></a>01495                 } <span class="keywordflow">else</span> {
<a name="l01496"></a>01496                     $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
<a name="l01497"></a>01497                         <span class="stringliteral">&quot;score was not recorded &quot;</span> .
<a name="l01498"></a>01498                         <span class="stringliteral">&quot;because there was a failure &quot;</span> .
<a name="l01499"></a>01499                         <span class="stringliteral">&quot;in storing the problem &quot;</span> .
<a name="l01500"></a>01500                         <span class="stringliteral">&quot;record to the database.&quot;</span>;
<a name="l01501"></a>01501                 }
<a name="l01502"></a>01502 <span class="preprocessor">                # write the transaction log</span>
<a name="l01503"></a>01503 <span class="preprocessor"></span>                writeLog( $self-&gt;{ce}, <span class="stringliteral">&quot;transaction&quot;</span>,
<a name="l01504"></a>01504                       $problems[$i]-&gt;problem_id . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01505"></a>01505                       $problems[$i]-&gt;set_id . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01506"></a>01506                       $problems[$i]-&gt;user_id . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01507"></a>01507                       $problems[$i]-&gt;source_file . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01508"></a>01508                       $problems[$i]-&gt;value . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01509"></a>01509                       $problems[$i]-&gt;max_attempts . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01510"></a>01510                       $problems[$i]-&gt;problem_seed . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01511"></a>01511                       $problems[$i]-&gt;status . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01512"></a>01512                       $problems[$i]-&gt;attempted . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01513"></a>01513                       $problems[$i]-&gt;last_answer . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01514"></a>01514                       $problems[$i]-&gt;num_correct . <span class="stringliteral">&quot;\t&quot;</span> .
<a name="l01515"></a>01515                       $problems[$i]-&gt;num_incorrect
<a name="l01516"></a>01516                       );
<a name="l01517"></a>01517             } elsif ( $submitAnswers ) {
<a name="l01518"></a>01518 <span class="preprocessor">                # this is the case where we submitted answers</span>
<a name="l01519"></a>01519 <span class="preprocessor"></span><span class="preprocessor">                #    but can&#39;t save them; report an error </span>
<a name="l01520"></a>01520 <span class="preprocessor"></span><span class="preprocessor">                #    message</span>
<a name="l01521"></a>01521 <span class="preprocessor"></span>
<a name="l01522"></a>01522                 <span class="keywordflow">if</span> ($self-&gt;{isClosed}) {
<a name="l01523"></a>01523                     $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
<a name="l01524"></a>01524                         <span class="stringliteral">&quot;score was not recorded &quot;</span> .
<a name="l01525"></a>01525                         <span class="stringliteral">&quot;because this problem set &quot;</span> .
<a name="l01526"></a>01526                         <span class="stringliteral">&quot;version is not open.&quot;</span>;
<a name="l01527"></a>01527                 } elsif ( $problems[$i]-&gt;num_correct + 
<a name="l01528"></a>01528                       $problems[$i]-&gt;num_incorrect &gt;= 
<a name="l01529"></a>01529                       $set-&gt;attempts_per_version ) {
<a name="l01530"></a>01530                     $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
<a name="l01531"></a>01531                         <span class="stringliteral">&quot;score was not recorded &quot;</span> .
<a name="l01532"></a>01532                         <span class="stringliteral">&quot;because you have no &quot;</span> .
<a name="l01533"></a>01533                         <span class="stringliteral">&quot;attempts remaining on this &quot;</span> .
<a name="l01534"></a>01534                         <span class="stringliteral">&quot;set version.&quot;</span>;
<a name="l01535"></a>01535                 } elsif ( ! $self-&gt;{versionIsOpen} ) {
<a name="l01536"></a>01536                     my $endTime = ( $set-&gt;version_last_attempt_time ) ? $set-&gt;version_last_attempt_time : $timeNow;
<a name="l01537"></a>01537                     if ($endTime &gt; $set-&gt;due_date &amp;&amp; 
<a name="l01538"></a>01538                         $endTime &lt; $set-&gt;due_date + $grace){
<a name="l01539"></a>01539                         $endTime = $set-&gt;due_date;
<a name="l01540"></a>01540                     }
<a name="l01541"></a>01541                     my $elapsed = 
<a name="l01542"></a>01542                         int(($endTime - $set-&gt;open_date)/0.6 + 0.5)/100;
<a name="l01543"></a>01543 <span class="preprocessor">                    # we assume that allowed is an even </span>
<a name="l01544"></a>01544 <span class="preprocessor"></span><span class="preprocessor">                    #    number of minutes</span>
<a name="l01545"></a>01545 <span class="preprocessor"></span>                    my $allowed = ($set-&gt;due_date - $set-&gt;open_date)/60;
<a name="l01546"></a>01546                     $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
<a name="l01547"></a>01547                         <span class="stringliteral">&quot;score was not recorded &quot;</span> .
<a name="l01548"></a>01548                         <span class="stringliteral">&quot;because you have exceeded &quot;</span> .
<a name="l01549"></a>01549                         <span class="stringliteral">&quot;the time limit for this &quot;</span> .
<a name="l01550"></a>01550                         <span class="stringliteral">&quot;test. (Time taken: $elapsed &quot;</span> .
<a name="l01551"></a>01551                         <span class="stringliteral">&quot;min; allowed: $allowed min.)&quot;</span>;
<a name="l01552"></a>01552                 } <span class="keywordflow">else</span> {
<a name="l01553"></a>01553                     $scoreRecordedMessage[$i] = <span class="stringliteral">&quot;Your &quot;</span> .
<a name="l01554"></a>01554                         <span class="stringliteral">&quot;score was not recorded.&quot;</span>;
<a name="l01555"></a>01555                 }
<a name="l01556"></a>01556             } <span class="keywordflow">else</span> {
<a name="l01557"></a>01557 <span class="preprocessor">                # finally, we must be previewing or switching</span>
<a name="l01558"></a>01558 <span class="preprocessor"></span><span class="preprocessor">                #    pages.  save only the last answer for the</span>
<a name="l01559"></a>01559 <span class="preprocessor"></span><span class="preprocessor">                #    problems</span>
<a name="l01560"></a>01560 <span class="preprocessor"></span>                $db-&gt;putProblemVersion( $pureProblem );
<a name="l01561"></a>01561             }
<a name="l01562"></a>01562         } # end loop through problems
<a name="l01563"></a>01563 
<a name="l01564"></a>01564 <span class="preprocessor">        ## finally, log student answers if we&#39;re submitting, </span>
<a name="l01565"></a>01565 <span class="preprocessor"></span><span class="preprocessor">        ##    previewing, or changing pages, provided that we can </span>
<a name="l01566"></a>01566 <span class="preprocessor"></span><span class="preprocessor">        ##    record answers.  note that this will log an overtime </span>
<a name="l01567"></a>01567 <span class="preprocessor"></span><span class="preprocessor">        ##    submission (or any case where someone submits the </span>
<a name="l01568"></a>01568 <span class="preprocessor"></span><span class="preprocessor">        ##    test, or spoofs a request to submit a test)</span>
<a name="l01569"></a>01569 <span class="preprocessor"></span>
<a name="l01570"></a>01570         my $answer_log = 
<a name="l01571"></a>01571             $self-&gt;{ce}-&gt;{courseFiles}-&gt;{logs}-&gt;{<span class="stringliteral">&#39;answer_log&#39;</span>};
<a name="l01572"></a>01572 
<a name="l01573"></a>01573 <span class="preprocessor">        # this is carried over from Problem.pm</span>
<a name="l01574"></a>01574 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( defined( $answer_log ) ) {
<a name="l01575"></a>01575             <span class="keywordflow">foreach</span> my $i ( 0 .. $#problems ) {
<a name="l01576"></a>01576                 my $answerString = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01577"></a>01577                 my $scores = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01578"></a>01578 <span class="preprocessor">                # note that we store these answers in the </span>
<a name="l01579"></a>01579 <span class="preprocessor"></span><span class="preprocessor">                #    order that they are presented, not the </span>
<a name="l01580"></a>01580 <span class="preprocessor"></span><span class="preprocessor">                #    actual problem order</span>
<a name="l01581"></a>01581 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( ref( $pg_results[$probOrder[$i]] ) ) {
<a name="l01582"></a>01582                     my %answerHash = %{ $pg_results[$probOrder[$i]]-&gt;{answers} };
<a name="l01583"></a>01583                     <span class="keywordflow">foreach</span> ( sortByName(undef, keys %answerHash) ) {
<a name="l01584"></a>01584                         my $sAns = defined($answerHash{$_}-&gt;{original_student_ans}) ? $answerHash{$_}-&gt;{original_student_ans} : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01585"></a>01585                         $answerString .= $sAns . <span class="stringliteral">&quot;\t&quot;</span>;
<a name="l01586"></a>01586                         $scores .= $answerHash{$_}-&gt;{score}&gt;=1 ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;0&quot;</span> <span class="keywordflow">if</span> ( $submitAnswers );
<a name="l01587"></a>01587                     }
<a name="l01588"></a>01588                 } <span class="keywordflow">else</span> {
<a name="l01589"></a>01589                     my $prefix = sprintf(<span class="stringliteral">&#39;Q%04d_&#39;</span>, ($probOrder[$i]+1));
<a name="l01590"></a>01590                     my @fields = sort grep {/^$prefix/} (keys %{$self-&gt;{formFields}});
<a name="l01591"></a>01591                     <span class="keywordflow">foreach</span> ( @fields ) {
<a name="l01592"></a>01592                         $answerString .= $self-&gt;{formFields}-&gt;{$_} . <span class="stringliteral">&quot;\t&quot;</span>;
<a name="l01593"></a>01593                         $scores .= $self-&gt;{formFields}-&gt;{<span class="stringliteral">&quot;probstatus&quot;</span> . ($probOrder[$i]+1)} &gt;= 1 ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;0&quot;</span> <span class="keywordflow">if</span> ( $submitAnswers );
<a name="l01594"></a>01594                     }
<a name="l01595"></a>01595                 }
<a name="l01596"></a>01596                 $answerString =~ s/\t+$/\t/;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598                 my $answerPrefix;
<a name="l01599"></a>01599                 <span class="keywordflow">if</span> ( $submitAnswers ) { 
<a name="l01600"></a>01600                     $answerPrefix = <span class="stringliteral">&quot;[submit] &quot;</span>;  
<a name="l01601"></a>01601                 } elsif ( $previewAnswers ) { 
<a name="l01602"></a>01602                     $answerPrefix = <span class="stringliteral">&quot;[preview] &quot;</span>; 
<a name="l01603"></a>01603                 } <span class="keywordflow">else</span> { 
<a name="l01604"></a>01604                     $answerPrefix = <span class="stringliteral">&quot;[newPage] &quot;</span>; 
<a name="l01605"></a>01605                 }
<a name="l01606"></a>01606 
<a name="l01607"></a>01607                 <span class="keywordflow">if</span> ( ! $answerString || 
<a name="l01608"></a>01608                      $answerString =~ /^\t$/ ) {
<a name="l01609"></a>01609                     $answerString = <span class="stringliteral">&quot;$answerPrefix&quot;</span> . 
<a name="l01610"></a>01610                         <span class="stringliteral">&quot;No answer entered\t&quot;</span>;
<a name="l01611"></a>01611                 } <span class="keywordflow">else</span> {
<a name="l01612"></a>01612                     $answerString = <span class="stringliteral">&quot;$answerPrefix&quot;</span> .
<a name="l01613"></a>01613                         <span class="stringliteral">&quot;$answerString&quot;</span>;
<a name="l01614"></a>01614                 }
<a name="l01615"></a>01615 
<a name="l01616"></a>01616                 writeCourseLog( $self-&gt;{ce}, <span class="stringliteral">&quot;answer_log&quot;</span>,
<a name="l01617"></a>01617                         join(<span class="stringliteral">&quot;&quot;</span>, <span class="charliteral">&#39;|&#39;</span>, 
<a name="l01618"></a>01618                              $problems[$i]-&gt;user_id,
<a name="l01619"></a>01619                              <span class="charliteral">&#39;|&#39;</span>, $setVName,
<a name="l01620"></a>01620                              <span class="charliteral">&#39;|&#39;</span>, ($i+1), <span class="charliteral">&#39;|&#39;</span>, $scores, 
<a name="l01621"></a>01621                              <span class="stringliteral">&quot;\t$timeNow\t&quot;</span>,
<a name="l01622"></a>01622                              <span class="stringliteral">&quot;$answerString&quot;</span>), 
<a name="l01623"></a>01623                         );
<a name="l01624"></a>01624             }
<a name="l01625"></a>01625         }
<a name="l01626"></a>01626     }
<a name="l01627"></a>01627     debug(<span class="stringliteral">&quot;end answer processing&quot;</span>);
<a name="l01628"></a>01628 
<a name="l01629"></a>01629 <span class="preprocessor">    # additional set-level database manipulation: we want to save the time </span>
<a name="l01630"></a>01630 <span class="preprocessor"></span><span class="preprocessor">    #    that a set was submitted, and for proctored tests we want to reset </span>
<a name="l01631"></a>01631 <span class="preprocessor"></span><span class="preprocessor">    #    the assignment type after a set is submitted for the last time so </span>
<a name="l01632"></a>01632 <span class="preprocessor"></span><span class="preprocessor">    #    that it&#39;s possible to look at it later without getting proctor </span>
<a name="l01633"></a>01633 <span class="preprocessor"></span><span class="preprocessor">    #    authorization</span>
<a name="l01634"></a>01634 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( ( $submitAnswers &amp;&amp; 
<a name="l01635"></a>01635            ( $will{recordAnswers} || 
<a name="l01636"></a>01636          ( ! $set-&gt;version_last_attempt_time() &amp;&amp;
<a name="l01637"></a>01637            $timeNow &gt; $set-&gt;due_date + $grace ) ) ) ||
<a name="l01638"></a>01638          ( ! $can{recordAnswersNextTime} &amp;&amp; 
<a name="l01639"></a>01639            $set-&gt;assignment_type() eq <span class="stringliteral">&#39;proctored_gateway&#39;</span> ) ) {
<a name="l01640"></a>01640 
<a name="l01641"></a>01641         my $setName = $set-&gt;set_id();
<a name="l01642"></a>01642 
<a name="l01643"></a>01643 <span class="preprocessor">    # save the submission time if we&#39;re recording the answer, or if the </span>
<a name="l01644"></a>01644 <span class="preprocessor"></span><span class="preprocessor">    #     first submission occurs after the due_date</span>
<a name="l01645"></a>01645 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $submitAnswers &amp;&amp; 
<a name="l01646"></a>01646              ( $will{recordAnswers} || 
<a name="l01647"></a>01647                ( ! $set-&gt;version_last_attempt_time() &amp;&amp;
<a name="l01648"></a>01648              $timeNow &gt; $set-&gt;due_date + $grace ) ) ) {
<a name="l01649"></a>01649             $set-&gt;version_last_attempt_time( $timeNow );
<a name="l01650"></a>01650         }
<a name="l01651"></a>01651         <span class="keywordflow">if</span> ( ! $can{recordAnswersNextTime} &amp;&amp; 
<a name="l01652"></a>01652              $set-&gt;assignment_type() eq <span class="stringliteral">&#39;proctored_gateway&#39;</span> ) {
<a name="l01653"></a>01653             $set-&gt;assignment_type( <span class="stringliteral">&#39;gateway&#39;</span> );
<a name="l01654"></a>01654         }
<a name="l01655"></a>01655 <span class="preprocessor">    # again, we save only parameters that are determine access to the</span>
<a name="l01656"></a>01656 <span class="preprocessor"></span><span class="preprocessor">    #    set version</span>
<a name="l01657"></a>01657 <span class="preprocessor"></span>        my $cleanSet = $db-&gt;getSetVersion($effectiveUser,
<a name="l01658"></a>01658                         $setName,
<a name="l01659"></a>01659                         $versionNumber);
<a name="l01660"></a>01660         $cleanSet-&gt;assignment_type( $set-&gt;assignment_type );
<a name="l01661"></a>01661         $cleanSet-&gt;version_last_attempt_time( $set-&gt;version_last_attempt_time );
<a name="l01662"></a>01662         $db-&gt;putSetVersion( $cleanSet );
<a name="l01663"></a>01663     }
<a name="l01664"></a>01664 
<a name="l01665"></a>01665 
<a name="l01666"></a>01666 <span class="preprocessor">    ####################################</span>
<a name="l01667"></a>01667 <span class="preprocessor"></span><span class="preprocessor">    # output</span>
<a name="l01668"></a>01668 <span class="preprocessor"></span><span class="preprocessor">    ####################################</span>
<a name="l01669"></a>01669 <span class="preprocessor"></span>
<a name="l01670"></a>01670 <span class="preprocessor">    # some convenient output variables</span>
<a name="l01671"></a>01671 <span class="preprocessor"></span>    my $canShowProblemScores = $can{showScore} &amp;&amp; 
<a name="l01672"></a>01672         ($set-&gt;hide_score eq <span class="charliteral">&#39;N&#39;</span> || $set-&gt;hide_score_by_problem eq <span class="charliteral">&#39;N&#39;</span> ||
<a name="l01673"></a>01673          $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_hidden_work&quot;</span>));
<a name="l01674"></a>01674     my $canShowWork = $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_hidden_work&quot;</span>) || ($set-&gt;hide_work eq <span class="charliteral">&#39;N&#39;</span> || ($set-&gt;hide_work eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span> &amp;&amp; $timeNow&gt;$tmplSet-&gt;answer_date));
<a name="l01675"></a>01675 
<a name="l01676"></a>01676 <span class="preprocessor">    # for nicer answer checking on multi-page tests, we want to keep </span>
<a name="l01677"></a>01677 <span class="preprocessor"></span><span class="preprocessor">    #    track of any changes that someone made to a different page, </span>
<a name="l01678"></a>01678 <span class="preprocessor"></span><span class="preprocessor">    #    and what their score was.  we use @probStatus to do this.  we </span>
<a name="l01679"></a>01679 <span class="preprocessor"></span><span class="preprocessor">    #    initialize this to any known scores, and then update this when </span>
<a name="l01680"></a>01680 <span class="preprocessor"></span><span class="preprocessor">    #    calculating the score for checked or submitted tests</span>
<a name="l01681"></a>01681 <span class="preprocessor"></span>    my @probStatus = ();
<a name="l01682"></a>01682 <span class="preprocessor">    # we also figure out recorded score for the set, if any, and score </span>
<a name="l01683"></a>01683 <span class="preprocessor"></span><span class="preprocessor">    #    on this attempt</span>
<a name="l01684"></a>01684 <span class="preprocessor"></span>    my $recordedScore = 0;
<a name="l01685"></a>01685     my $totPossible = 0;
<a name="l01686"></a>01686     <span class="keywordflow">foreach</span> ( @problems ) {
<a name="l01687"></a>01687         my $pv = ( $_-&gt;value() ) ? $_-&gt;value() : 1;
<a name="l01688"></a>01688         $totPossible += $pv;
<a name="l01689"></a>01689         $recordedScore += $_-&gt;status*$pv <span class="keywordflow">if</span> (defined($_-&gt;status));
<a name="l01690"></a>01690         push( @probStatus, ($r-&gt;param(<span class="stringliteral">&quot;probstatus&quot;</span> . $_-&gt;problem_id) ||
<a name="l01691"></a>01691                     $_-&gt;status || 0) );
<a name="l01692"></a>01692     }
<a name="l01693"></a>01693 
<a name="l01694"></a>01694 <span class="preprocessor">    # to get the attempt score, we have to figure out what the score on </span>
<a name="l01695"></a>01695 <span class="preprocessor"></span><span class="preprocessor">    #    each part of each problem is, and multiply the total for the </span>
<a name="l01696"></a>01696 <span class="preprocessor"></span><span class="preprocessor">    #    problem by the weight (value) of the problem.  to make things </span>
<a name="l01697"></a>01697 <span class="preprocessor"></span><span class="preprocessor">    #    even more interesting, we are avoiding translating all of the </span>
<a name="l01698"></a>01698 <span class="preprocessor"></span><span class="preprocessor">    #    problems when checking answers</span>
<a name="l01699"></a>01699 <span class="preprocessor"></span>    my $attemptScore = 0;
<a name="l01700"></a>01700 
<a name="l01701"></a>01701     <span class="keywordflow">if</span> ( $submitAnswers || $checkAnswers ) {
<a name="l01702"></a>01702         my $i=0;
<a name="l01703"></a>01703         <span class="keywordflow">foreach</span> my $pg ( @pg_results ) {
<a name="l01704"></a>01704             my $pValue = $problems[$i]-&gt;value() ? $problems[$i]-&gt;value() : 1;
<a name="l01705"></a>01705             my $pScore = 0;
<a name="l01706"></a>01706             my $numParts = 0;
<a name="l01707"></a>01707             <span class="keywordflow">if</span> ( ref( $pg ) ) {  # then we have a pg <span class="keywordtype">object</span>
<a name="l01708"></a>01708                 <span class="keywordflow">foreach</span> (@{$pg-&gt;{flags}-&gt;{ANSWER_ENTRY_ORDER}}){
<a name="l01709"></a>01709                     $pScore += $pg-&gt;{answers}-&gt;{$_}-&gt;{score};
<a name="l01710"></a>01710                     $numParts++;
<a name="l01711"></a>01711                 }
<a name="l01712"></a>01712                 $probStatus[$i] = $pScore/($numParts&gt;0 ? $numParts : 1);
<a name="l01713"></a>01713 
<a name="l01714"></a>01714             } <span class="keywordflow">else</span> {
<a name="l01715"></a>01715 <span class="preprocessor">                # if we don&#39;t have a pg object, use any known </span>
<a name="l01716"></a>01716 <span class="preprocessor"></span><span class="preprocessor">                #    problem status (this defaults to zero)</span>
<a name="l01717"></a>01717 <span class="preprocessor"></span>                $pScore = $probStatus[$i];
<a name="l01718"></a>01718             }
<a name="l01719"></a>01719             $attemptScore += $pScore*$pValue/($numParts &gt; 0 ? $numParts : 1);
<a name="l01720"></a>01720             $i++;
<a name="l01721"></a>01721         }
<a name="l01722"></a>01722     }
<a name="l01723"></a>01723 
<a name="l01724"></a>01724 <span class="preprocessor">    # we want to print elapsed and allowed times; allowed is easy</span>
<a name="l01725"></a>01725 <span class="preprocessor"></span>    my $allowed = sprintf( <span class="stringliteral">&quot;%.0f&quot;</span>, 10*($set-&gt;due_date - $set-&gt;open_date)/6 )/100;
<a name="l01726"></a>01726 <span class="preprocessor">    # elapsed is a little harder; we&#39;re counting to the last submission </span>
<a name="l01727"></a>01727 <span class="preprocessor"></span><span class="preprocessor">    #    time, or to the current time if the test hasn&#39;t been submitted, </span>
<a name="l01728"></a>01728 <span class="preprocessor"></span><span class="preprocessor">    #    and if the submission fell in the grace period round it to the </span>
<a name="l01729"></a>01729 <span class="preprocessor"></span><span class="preprocessor">    #    due_date</span>
<a name="l01730"></a>01730 <span class="preprocessor"></span>    my $exceededAllowedTime = 0;
<a name="l01731"></a>01731     my $endTime = ( $set-&gt;version_last_attempt_time ) ? 
<a name="l01732"></a>01732         $set-&gt;version_last_attempt_time : $timeNow;
<a name="l01733"></a>01733     if ( $endTime &gt; $set-&gt;due_date &amp;&amp; $endTime &lt; $set-&gt;due_date + $grace ) {
<a name="l01734"></a>01734         $endTime = $set-&gt;due_date;
<a name="l01735"></a>01735     } elsif ( $endTime &gt; $set-&gt;due_date ) {
<a name="l01736"></a>01736         $exceededAllowedTime = 1;
<a name="l01737"></a>01737     }
<a name="l01738"></a>01738     my $elapsedTime = int(($endTime - $set-&gt;open_date)/0.6 + 0.5)/100;
<a name="l01739"></a>01739 
<a name="l01740"></a>01740 <span class="preprocessor">    # also get number of remaining attempts (important for sets with </span>
<a name="l01741"></a>01741 <span class="preprocessor"></span><span class="preprocessor">    #    multiple attempts per version)</span>
<a name="l01742"></a>01742 <span class="preprocessor"></span>    my $numLeft = ($set-&gt;attempts_per_version ||0 )- $Problem-&gt;num_correct - 
<a name="l01743"></a>01743         $Problem-&gt;num_incorrect - 
<a name="l01744"></a>01744         ($submitAnswers &amp;&amp; $will{recordAnswers} ? 1 : 0);
<a name="l01745"></a>01745     my $attemptNumber = $Problem-&gt;num_correct + $Problem-&gt;num_incorrect;
<a name="l01746"></a>01746 
<a name="l01747"></a>01747 <span class="preprocessor">    # a handy noun for when referring to a test</span>
<a name="l01748"></a>01748 <span class="preprocessor"></span>    my $testNoun = (( $set-&gt;attempts_per_version || 0 ) &gt; 1) ? <span class="stringliteral">&quot;submission&quot;</span> : <span class="stringliteral">&quot;test&quot;</span>;
<a name="l01749"></a>01749     my $testNounNum = ( ( $set-&gt;attempts_per_version ||0 ) &gt; 1 ) ? 
<a name="l01750"></a>01750         <span class="stringliteral">&quot;submission (test &quot;</span> : <span class="stringliteral">&quot;test (&quot;</span>;
<a name="l01751"></a>01751 
<a name="l01752"></a>01752 <span class="preprocessor">    ##### start output of test headers: </span>
<a name="l01753"></a>01753 <span class="preprocessor"></span><span class="preprocessor">    ##### display information about recorded and checked scores</span>
<a name="l01754"></a>01754 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $submitAnswers ) {
<a name="l01755"></a>01755 <span class="preprocessor">        # the distinction between $can{recordAnswers} and ! $can{} has </span>
<a name="l01756"></a>01756 <span class="preprocessor"></span><span class="preprocessor">        #    been dealt with above and recorded in @scoreRecordedMessage</span>
<a name="l01757"></a>01757 <span class="preprocessor"></span>        my $divClass = <span class="stringliteral">&#39;ResultsWithoutError&#39;</span>;
<a name="l01758"></a>01758         my $recdMsg = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01759"></a>01759         <span class="keywordflow">foreach</span> ( @scoreRecordedMessage ) {
<a name="l01760"></a>01760             <span class="keywordflow">if</span> ($_ ne <span class="stringliteral">&#39;Your score on this problem was recorded.&#39;</span>) {
<a name="l01761"></a>01761                 $recdMsg = $_;
<a name="l01762"></a>01762                 $divClass = <span class="stringliteral">&#39;ResultsWithError&#39;</span>;
<a name="l01763"></a>01763                 last;
<a name="l01764"></a>01764             }
<a name="l01765"></a>01765         }
<a name="l01766"></a>01766         print CGI::start_div({<span class="keyword">class</span>=&gt;$divClass});
<a name="l01767"></a>01767 
<a name="l01768"></a>01768         <span class="keywordflow">if</span> ( $recdMsg ) {
<a name="l01769"></a>01769 <span class="preprocessor">            # then there was an error when saving the results</span>
<a name="l01770"></a>01770 <span class="preprocessor"></span>            print CGI::strong(<span class="stringliteral">&quot;Your score on this $testNounNum &quot;</span>,
<a name="l01771"></a>01771                       <span class="stringliteral">&quot;$versionNumber) was NOT recorded.  &quot;</span>,
<a name="l01772"></a>01772                       $recdMsg), CGI::br();
<a name="l01773"></a>01773         } <span class="keywordflow">else</span> {
<a name="l01774"></a>01774 <span class="preprocessor">            # no error; print recorded message</span>
<a name="l01775"></a>01775 <span class="preprocessor"></span>            print CGI::strong(<span class="stringliteral">&quot;Your score on this $testNounNum &quot;</span>,
<a name="l01776"></a>01776                       <span class="stringliteral">&quot;$versionNumber) WAS recorded.&quot;</span>), 
<a name="l01777"></a>01777             CGI::br();
<a name="l01778"></a>01778 
<a name="l01779"></a>01779 <span class="preprocessor">            # and show the score if we&#39;re allowed to do that</span>
<a name="l01780"></a>01780 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ( $can{showScore} ) {
<a name="l01781"></a>01781                 print CGI::strong(<span class="stringliteral">&quot;Your score on this &quot;</span> .
<a name="l01782"></a>01782                           <span class="stringliteral">&quot;$testNoun is &quot;</span>, 
<a name="l01783"></a>01783                           <span class="stringliteral">&quot;$attemptScore/$totPossible.&quot;</span>);
<a name="l01784"></a>01784             } <span class="keywordflow">else</span> {
<a name="l01785"></a>01785                 my $when = 
<a name="l01786"></a>01786                     ($set-&gt;hide_score eq <span class="stringliteral">&#39;BeforeAnswerDate&#39;</span>)
<a name="l01787"></a>01787                     ? <span class="stringliteral">&#39; until &#39;</span> . ($self-&gt;formatDateTime($set-&gt;answer_date) )
<a name="l01788"></a>01788                     : <span class="stringliteral">&#39;&#39;</span>;
<a name="l01789"></a>01789                 print CGI::br() . 
<a name="l01790"></a>01790                     <span class="stringliteral">&quot;(Your score on this $testNoun &quot;</span> .
<a name="l01791"></a>01791                     <span class="stringliteral">&quot;is not available$when.)&quot;</span>;
<a name="l01792"></a>01792             }
<a name="l01793"></a>01793         }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795 <span class="preprocessor">        # finally, if there is another, recorded message, print that </span>
<a name="l01796"></a>01796 <span class="preprocessor"></span><span class="preprocessor">        #    too so that we know what&#39;s going on</span>
<a name="l01797"></a>01797 <span class="preprocessor"></span>        print CGI::end_div();
<a name="l01798"></a>01798         <span class="keywordflow">if</span> ( $set-&gt;attempts_per_version &gt; 1 &amp;&amp; $attemptNumber &gt; 1 &amp;&amp;
<a name="l01799"></a>01799              $recordedScore != $attemptScore &amp;&amp; $can{showScore} ) {
<a name="l01800"></a>01800             print CGI::start_div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;gwMessage&#39;</span>});
<a name="l01801"></a>01801             print <span class="stringliteral">&quot;The recorded score for this test is &quot;</span>,
<a name="l01802"></a>01802                 <span class="stringliteral">&quot;$recordedScore/$totPossible.&quot;</span>;
<a name="l01803"></a>01803             print CGI::end_div();
<a name="l01804"></a>01804         }
<a name="l01805"></a>01805 
<a name="l01806"></a>01806     } elsif ( $checkAnswers ) {
<a name="l01807"></a>01807         <span class="keywordflow">if</span> ( $can{showScore} ) {
<a name="l01808"></a>01808             print CGI::start_div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;gwMessage&#39;</span>});
<a name="l01809"></a>01809             print CGI::strong(<span class="stringliteral">&quot;Your score on this (checked, not &quot;</span>,
<a name="l01810"></a>01810                       <span class="stringliteral">&quot;recorded) submission is &quot;</span>,
<a name="l01811"></a>01811                       <span class="stringliteral">&quot;$attemptScore/$totPossible.&quot;</span>), 
<a name="l01812"></a>01812                 CGI::br();
<a name="l01813"></a>01813             print <span class="stringliteral">&quot;The recorded score for this test is &quot;</span> .
<a name="l01814"></a>01814                 <span class="stringliteral">&quot;$recordedScore/$totPossible.  &quot;</span>;
<a name="l01815"></a>01815             print CGI::end_div();
<a name="l01816"></a>01816         }
<a name="l01817"></a>01817     }
<a name="l01818"></a>01818 
<a name="l01819"></a>01819 <span class="preprocessor">    ##### remaining output of test headers:</span>
<a name="l01820"></a>01820 <span class="preprocessor"></span><span class="preprocessor">    ##### display timer or information about elapsed time, &quot;printme&quot; link,</span>
<a name="l01821"></a>01821 <span class="preprocessor"></span><span class="preprocessor">    ##### and information about any recorded score if not submitAnswers or </span>
<a name="l01822"></a>01822 <span class="preprocessor"></span><span class="preprocessor">    ##### checkAnswers</span>
<a name="l01823"></a>01823 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( $can{recordAnswersNextTime} ) {
<a name="l01824"></a>01824 
<a name="l01825"></a>01825 <span class="preprocessor">        # print timer</span>
<a name="l01826"></a>01826 <span class="preprocessor"></span><span class="preprocessor">        # FIXME: in the long run, we want to allow a test to not be</span>
<a name="l01827"></a>01827 <span class="preprocessor"></span><span class="preprocessor">        #    timed.  This does not allow for that possibility</span>
<a name="l01828"></a>01828 <span class="preprocessor"></span>        my $timeLeft = $set-&gt;due_date() - $timeNow;  # <span class="keyword">this</span> is in secs
<a name="l01829"></a>01829         print CGI::div({-<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;gwTimer&quot;</span>},<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01830"></a>01830         print CGI::startform({-name=&gt;<span class="stringliteral">&quot;gwTimeData&quot;</span>, -method=&gt;<span class="stringliteral">&quot;POST&quot;</span>,
<a name="l01831"></a>01831                       -action=&gt;$r-&gt;uri});
<a name="l01832"></a>01832         print CGI::hidden({-name=&gt;<span class="stringliteral">&quot;serverTime&quot;</span>, -value=&gt;$timeNow}), 
<a name="l01833"></a>01833             <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01834"></a>01834         print CGI::hidden({-name=&gt;<span class="stringliteral">&quot;serverDueTime&quot;</span>, 
<a name="l01835"></a>01835                    -value=&gt;$set-&gt;due_date()}), <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01836"></a>01836         print CGI::endform();
<a name="l01837"></a>01837 
<a name="l01838"></a>01838         <span class="keywordflow">if</span> ( $timeLeft &lt; 1 &amp;&amp; $timeLeft &gt; 0 &amp;&amp;
<a name="l01839"></a>01839              ! $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;record_answers_when_acting_as_student&quot;</span>)) {
<a name="l01840"></a>01840             print CGI::span({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;resultsWithError&quot;</span>}, 
<a name="l01841"></a>01841                     CGI::b(<span class="stringliteral">&quot;You have less than 1 minute &quot;</span>,
<a name="l01842"></a>01842                            <span class="stringliteral">&quot;to complete this test.\n&quot;</span>));
<a name="l01843"></a>01843         } elsif ( $timeLeft &lt;= 0 &amp;&amp;
<a name="l01844"></a>01844               ! $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;record_answers_when_acting_as_student&quot;</span>) ) {
<a name="l01845"></a>01845             print CGI::span({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;resultsWithError&quot;</span>}, 
<a name="l01846"></a>01846                     CGI::b(<span class="stringliteral">&quot;You are out of time.  &quot;</span>,
<a name="l01847"></a>01847                            <span class="stringliteral">&quot;Press grade now!\n&quot;</span>));
<a name="l01848"></a>01848         }
<a name="l01849"></a>01849 <span class="preprocessor">        # if there are multiple attempts per version, indicate the </span>
<a name="l01850"></a>01850 <span class="preprocessor"></span><span class="preprocessor">        #    number remaining, and if we&#39;ve submitted a multiple </span>
<a name="l01851"></a>01851 <span class="preprocessor"></span><span class="preprocessor">        #    attempt multi-page test, show the score on the previous</span>
<a name="l01852"></a>01852 <span class="preprocessor"></span><span class="preprocessor">        #    submission</span>
<a name="l01853"></a>01853 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ( $set-&gt;attempts_per_version &gt; 1 ) {
<a name="l01854"></a>01854             print CGI::em(<span class="stringliteral">&quot;You have $numLeft attempt(s) remaining &quot;</span>,
<a name="l01855"></a>01855                       <span class="stringliteral">&quot;on this test.&quot;</span>);
<a name="l01856"></a>01856             <span class="keywordflow">if</span> ( $numLeft &lt; $set-&gt;attempts_per_version &amp;&amp;
<a name="l01857"></a>01857                  $numPages &gt; 1 &amp;&amp;
<a name="l01858"></a>01858                  $can{showScore} ) {
<a name="l01859"></a>01859                 print CGI::start_div({-<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&quot;gwScoreSummary&quot;</span>}),
<a name="l01860"></a>01860                     CGI::strong({},<span class="stringliteral">&quot;Score summary for &quot;</span> .
<a name="l01861"></a>01861                             <span class="stringliteral">&quot;last submit:&quot;</span>);
<a name="l01862"></a>01862                 print CGI::start_table({<span class="stringliteral">&quot;border&quot;</span>=&gt;0,
<a name="l01863"></a>01863                             <span class="stringliteral">&quot;cellpadding&quot;</span>=&gt;0,
<a name="l01864"></a>01864                             <span class="stringliteral">&quot;cellspacing&quot;</span>=&gt;0});
<a name="l01865"></a>01865                 print CGI::Tr({},CGI::th({-align=&gt;<span class="stringliteral">&quot;left&quot;</span>},
<a name="l01866"></a>01866                              [<span class="stringliteral">&quot;Prob&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,<span class="stringliteral">&quot;Status&quot;</span>,<span class="stringliteral">&quot;&quot;</span>,
<a name="l01867"></a>01867                               <span class="stringliteral">&quot;Result&quot;</span>]));
<a name="l01868"></a>01868                 <span class="keywordflow">for</span> ( my $i=0; $i&lt;@probStatus; $i++ ) {
<a name="l01869"></a>01869                     print CGI::Tr({},
<a name="l01870"></a>01870                         CGI::td({},[($i+1),<span class="stringliteral">&quot;&quot;</span>,<span class="keywordtype">int</span>(100*$probStatus[$probOrder[$i]]+0.5) . <span class="stringliteral">&quot;%&quot;</span>,<span class="stringliteral">&quot;&quot;</span>, $probStatus[$probOrder[$i]] == 1 ? <span class="stringliteral">&quot;Correct&quot;</span> : <span class="stringliteral">&quot;Incorrect&quot;</span>]));
<a name="l01871"></a>01871                 }
<a name="l01872"></a>01872                 print CGI::end_table(), CGI::end_div();
<a name="l01873"></a>01873             }
<a name="l01874"></a>01874         }
<a name="l01875"></a>01875     } <span class="keywordflow">else</span> {
<a name="l01876"></a>01876         print CGI::start_div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;gwMessage&#39;</span>});
<a name="l01877"></a>01877 
<a name="l01878"></a>01878         <span class="keywordflow">if</span> ( ! $checkAnswers &amp;&amp; ! $submitAnswers ) {
<a name="l01879"></a>01879 
<a name="l01880"></a>01880             <span class="keywordflow">if</span> ( $can{showScore} ) {
<a name="l01881"></a>01881                 my $scMsg = <span class="stringliteral">&quot;Your recorded score on this &quot;</span> .
<a name="l01882"></a>01882                     <span class="stringliteral">&quot;(test number $versionNumber) is &quot;</span> .
<a name="l01883"></a>01883                     <span class="stringliteral">&quot;$recordedScore/$totPossible&quot;</span>;
<a name="l01884"></a>01884                 <span class="keywordflow">if</span> ( $exceededAllowedTime &amp;&amp; 
<a name="l01885"></a>01885                      $recordedScore == 0 ) {
<a name="l01886"></a>01886                     $scMsg .= <span class="stringliteral">&quot;, because you exceeded &quot;</span> .
<a name="l01887"></a>01887                         <span class="stringliteral">&quot;the allowed time.&quot;</span>;
<a name="l01888"></a>01888                 } <span class="keywordflow">else</span> {
<a name="l01889"></a>01889                     $scMsg .= <span class="stringliteral">&quot;.  &quot;</span>;
<a name="l01890"></a>01890                 }
<a name="l01891"></a>01891                 print CGI::strong($scMsg), CGI::br();
<a name="l01892"></a>01892             }
<a name="l01893"></a>01893         }
<a name="l01894"></a>01894 
<a name="l01895"></a>01895         <span class="keywordflow">if</span> ( $set-&gt;version_last_attempt_time ) {
<a name="l01896"></a>01896             print <span class="stringliteral">&quot;Time taken on test: $elapsedTime min &quot;</span> .
<a name="l01897"></a>01897                 <span class="stringliteral">&quot;($allowed min allowed).&quot;</span>;
<a name="l01898"></a>01898         } elsif ( $exceededAllowedTime &amp;&amp; $recordedScore != 0 ) {
<a name="l01899"></a>01899             print <span class="stringliteral">&quot;(This test is overtime because it was not &quot;</span> .
<a name="l01900"></a>01900                 <span class="stringliteral">&quot;submitted in the allowed time.)&quot;</span>;
<a name="l01901"></a>01901         }
<a name="l01902"></a>01902         print CGI::end_div();
<a name="l01903"></a>01903 
<a name="l01904"></a>01904         <span class="keywordflow">if</span> ( $canShowWork &amp;&amp; $set-&gt;set_id ne <span class="stringliteral">&quot;Undefined_Set&quot;</span> ) {
<a name="l01905"></a>01905             print <span class="stringliteral">&quot;The test (which is number $versionNumber) may &quot;</span> .
<a name="l01906"></a>01906                 <span class="stringliteral">&quot;no longer be submitted for a grade&quot;</span>;
<a name="l01907"></a>01907             print <span class="stringliteral">&quot;&quot;</span> . (($can{showScore}) ? <span class="stringliteral">&quot;, but you may still &quot;</span> .
<a name="l01908"></a>01908                     <span class="stringliteral">&quot;check your answers.&quot;</span> : <span class="stringliteral">&quot;.&quot;</span>) ;
<a name="l01909"></a>01909 
<a name="l01910"></a>01910 <span class="preprocessor">            # print a &quot;printme&quot; link if we&#39;re allowed to see our </span>
<a name="l01911"></a>01911 <span class="preprocessor"></span><span class="preprocessor">            #    work</span>
<a name="l01912"></a>01912 <span class="preprocessor"></span>            my $link = $ce-&gt;{webworkURLs}-&gt;{root} . <span class="charliteral">&#39;/&#39;</span> . 
<a name="l01913"></a>01913                 $ce-&gt;{courseName} . <span class="stringliteral">&#39;/hardcopy/&#39;</span> . 
<a name="l01914"></a>01914                 $set-&gt;set_id . <span class="stringliteral">&#39;,v&#39;</span> . $set-&gt;version_id . <span class="stringliteral">&#39;/?&#39;</span> . 
<a name="l01915"></a>01915                 $self-&gt;url_authen_args;
<a name="l01916"></a>01916             my $printmsg = CGI::div({-<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;gwPrintMe&#39;</span>}, 
<a name="l01917"></a>01917                         CGI::a({-href=&gt;$link}, 
<a name="l01918"></a>01918                                <span class="stringliteral">&quot;Print Test&quot;</span>));
<a name="l01919"></a>01919             print $printmsg;
<a name="l01920"></a>01920         }
<a name="l01921"></a>01921     }
<a name="l01922"></a>01922 
<a name="l01923"></a>01923 <span class="preprocessor">    # this is a hack to get a URL that won&#39;t require a proctor login if </span>
<a name="l01924"></a>01924 <span class="preprocessor"></span><span class="preprocessor">    #    we&#39;ve submitted a proctored test for the last time.  above we&#39;ve </span>
<a name="l01925"></a>01925 <span class="preprocessor"></span><span class="preprocessor">    #    reset the assignment_type in this case, so we&#39;ll use that to </span>
<a name="l01926"></a>01926 <span class="preprocessor"></span><span class="preprocessor">    #    decide if we should give a path to an unproctored test.</span>
<a name="l01927"></a>01927 <span class="preprocessor"></span>    my $action = $r-&gt;uri();
<a name="l01928"></a>01928     $action =~ s/proctored_quiz_mode/quiz_mode/ 
<a name="l01929"></a>01929         <span class="keywordflow">if</span> ( $set-&gt;assignment_type() eq <span class="stringliteral">&#39;gateway&#39;</span> );
<a name="l01930"></a>01930 <span class="preprocessor">    # we also want to be sure that if we&#39;re in a set, the &#39;action&#39; in the </span>
<a name="l01931"></a>01931 <span class="preprocessor"></span><span class="preprocessor">    #    form points us to the same set.  </span>
<a name="l01932"></a>01932 <span class="preprocessor"></span>    my $setname = $set-&gt;set_id;
<a name="l01933"></a>01933     my $setvnum = $set-&gt;version_id;
<a name="l01934"></a>01934     $action =~ s/(quiz_mode\/$setname)\/?$/$1,v$setvnum\<span class="comment">//;  #&quot;</span>
<a name="l01935"></a>01935 
<a name="l01936"></a>01936     # now, we print out the rest of the page <span class="keywordflow">if</span> we<span class="stringliteral">&#39;re not hiding submitted</span>
<a name="l01937"></a>01937 <span class="stringliteral">    #    answers</span>
<a name="l01938"></a>01938 <span class="stringliteral">    if ( ! $can{recordAnswersNextTime} &amp;&amp; ! $canShowWork ) {</span>
<a name="l01939"></a>01939 <span class="stringliteral">        my $when = ( $set-&gt;hide_work eq &#39;</span>BeforeAnswerDate<span class="stringliteral">&#39; ) </span>
<a name="l01940"></a>01940 <span class="stringliteral">            ? &#39;</span> until <span class="stringliteral">&#39; . ($self-&gt;formatDateTime($set-&gt;answer_date))</span>
<a name="l01941"></a>01941 <span class="stringliteral">            : &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l01942"></a>01942 <span class="stringliteral">        print CGI::start_div({class=&gt;&quot;gwProblem&quot;});</span>
<a name="l01943"></a>01943 <span class="stringliteral">        print CGI::strong(&quot;Completed results for this assignment are &quot; .</span>
<a name="l01944"></a>01944 <span class="stringliteral">                  &quot;not available$when.&quot;);</span>
<a name="l01945"></a>01945 <span class="stringliteral">        print CGI::end_div();</span>
<a name="l01946"></a>01946 <span class="stringliteral"></span>
<a name="l01947"></a>01947 <span class="stringliteral">    # else: we&#39;</span>re not hiding answers
<a name="l01948"></a>01948     } <span class="keywordflow">else</span> {
<a name="l01949"></a>01949 
<a name="l01950"></a>01950         print CGI::startform({-name=&gt;<span class="stringliteral">&quot;gwquiz&quot;</span>, -method=&gt;<span class="stringliteral">&quot;POST&quot;</span>, 
<a name="l01951"></a>01951                       -action=&gt;$action}), 
<a name="l01952"></a>01952             $self-&gt;hidden_authen_fields, 
<a name="l01953"></a>01953             $self-&gt;hidden_proctor_authen_fields;
<a name="l01954"></a>01954 
<a name="l01955"></a>01955     # hacks to use a javascript link to trigger previews and jump to 
<a name="l01956"></a>01956     #    subsequent pages of a multipage test
<a name="l01957"></a>01957         print CGI::hidden({-name=&gt;<span class="stringliteral">&#39;previewHack&#39;</span>, -value=&gt;<span class="stringliteral">&#39;&#39;</span>}), 
<a name="l01958"></a>01958             CGI::br();
<a name="l01959"></a>01959         <span class="keywordflow">if</span> ( $numProbPerPage &amp;&amp; $numPages &gt; 1 ) { 
<a name="l01960"></a>01960             print CGI::hidden({-name=&gt;<span class="stringliteral">&#39;newPage&#39;</span>, -value=&gt;<span class="stringliteral">&#39;&#39;</span>});
<a name="l01961"></a>01961             print CGI::hidden({-name=&gt;<span class="stringliteral">&#39;currentPage&#39;</span>,
<a name="l01962"></a>01962                        -value=&gt;$pageNumber});
<a name="l01963"></a>01963         }
<a name="l01964"></a>01964 
<a name="l01965"></a>01965 <span class="preprocessor">    # the link for a preview; for a multipage test, this also needs to </span>
<a name="l01966"></a>01966 <span class="preprocessor"></span><span class="preprocessor">    #    keep track of what page we&#39;re on</span>
<a name="l01967"></a>01967 <span class="preprocessor"></span>        my $jsprevlink = <span class="stringliteral">&#39;javascript:document.gwquiz.previewHack.value=&quot;1&quot;;&#39;</span>;
<a name="l01968"></a>01968         $jsprevlink .= <span class="stringliteral">&quot;document.gwquiz.newPage.value=\&quot;$pageNumber\&quot;;&quot;</span>
<a name="l01969"></a>01969             <span class="keywordflow">if</span> ( $numProbPerPage &amp;&amp; $numPages &gt; 1 );
<a name="l01970"></a>01970         $jsprevlink .= <span class="stringliteral">&#39;document.gwquiz.submit();&#39;</span>;
<a name="l01971"></a>01971 
<a name="l01972"></a>01972 <span class="preprocessor">    # set up links between problems and, for multi-page tests, pages</span>
<a name="l01973"></a>01973 <span class="preprocessor"></span>        my $jumpLinks = <span class="stringliteral">&#39;&#39;</span>;
<a name="l01974"></a>01974         my $probRow = [ CGI::b(<span class="stringliteral">&quot;Problem&quot;</span>) ];
<a name="l01975"></a>01975         <span class="keywordflow">for</span> my $i ( 0 .. $#pg_results ) {
<a name="l01976"></a>01976         
<a name="l01977"></a>01977             my $pn = $i + 1;
<a name="l01978"></a>01978             <span class="keywordflow">if</span> ( $i &gt;= $startProb &amp;&amp; $i &lt;= $endProb ) {
<a name="l01979"></a>01979                 push(@$probRow, CGI::b(<span class="stringliteral">&quot; [ &quot;</span>)) if ($i == $startProb);
<a name="l01980"></a>01980                 push( @$probRow, &quot; &amp;nbsp;&quot; . 
<a name="l01981"></a>01981                       CGI::a({-href=&gt;<span class="stringliteral">&quot;.&quot;</span>, 
<a name="l01982"></a>01982                           -onclick=&gt;<span class="stringliteral">&quot;jumpTo($pn);return false;&quot;</span>},
<a name="l01983"></a>01983                          <span class="stringliteral">&quot;$pn&quot;</span>) . <span class="stringliteral">&quot;&amp;nbsp; &quot;</span> );
<a name="l01984"></a>01984                 push(@$probRow, CGI::b(<span class="stringliteral">&quot; ] &quot;</span>)) if ($i == $endProb);
<a name="l01985"></a>01985             } elsif ( ! ($i % $numProbPerPage) ) {
<a name="l01986"></a>01986                 push(@$probRow, <span class="stringliteral">&quot; &amp;nbsp;&amp;nbsp; &quot;</span>, 
<a name="l01987"></a>01987                      <span class="stringliteral">&quot; &amp;nbsp;&amp;nbsp; &quot;</span>, <span class="stringliteral">&quot; &amp;nbsp;&amp;nbsp; &quot;</span>);
<a name="l01988"></a>01988             }
<a name="l01989"></a>01989         }
<a name="l01990"></a>01990         <span class="keywordflow">if</span> ( $numProbPerPage &amp;&amp; $numPages &gt; 1 ) {
<a name="l01991"></a>01991             my $pageRow = [ CGI::td([ CGI::b(<span class="stringliteral">&#39;Jump to: &#39;</span>), 
<a name="l01992"></a>01992                           CGI::b(<span class="stringliteral">&#39;Page &#39;</span>),
<a name="l01993"></a>01993                           CGI::b(<span class="stringliteral">&#39; [ &#39;</span> ) ]) ];
<a name="l01994"></a>01994             <span class="keywordflow">for</span> my $i ( 1 .. $numPages ) {
<a name="l01995"></a>01995                 my $pn = ( $i == $pageNumber ) ? $i : 
<a name="l01996"></a>01996                     CGI::a({-href=&gt;<span class="stringliteral">&#39;javascript:&#39;</span> .
<a name="l01997"></a>01997                         <span class="stringliteral">&quot;document.gwquiz.newPage.value=\&quot;$i\&quot;;&quot;</span> .
<a name="l01998"></a>01998                         <span class="stringliteral">&#39;document.gwquiz.submit();&#39;</span>}, 
<a name="l01999"></a>01999                        <span class="stringliteral">&quot;&amp;nbsp;$i&amp;nbsp;&quot;</span>);
<a name="l02000"></a>02000 
<a name="l02001"></a>02001                 my $colspan =  0;
<a name="l02002"></a>02002                 <span class="keywordflow">if</span> ( $i == $pageNumber ) {
<a name="l02003"></a>02003                     $colspan = 
<a name="l02004"></a>02004                         ($#pg_results - ($i-1)*$numProbPerPage &gt; $numProbPerPage) ?
<a name="l02005"></a>02005                         $numProbPerPage : 
<a name="l02006"></a>02006                         $#pg_results - ($i-1)*$numProbPerPage + 1;
<a name="l02007"></a>02007                 } <span class="keywordflow">else</span> {
<a name="l02008"></a>02008                     $colspan = 1;
<a name="l02009"></a>02009                 }
<a name="l02010"></a>02010                 push( @$pageRow, CGI::td({-colspan=&gt;$colspan, 
<a name="l02011"></a>02011                               -align=&gt;<span class="stringliteral">&#39;center&#39;</span>}, 
<a name="l02012"></a>02012                              $pn) );
<a name="l02013"></a>02013                 push( @$pageRow, CGI::td( [CGI::b(<span class="stringliteral">&#39; ] &#39;</span>), 
<a name="l02014"></a>02014                                CGI::b(<span class="stringliteral">&#39; [ &#39;</span>)] ) )
<a name="l02015"></a>02015                     if ( $i != $numPages );
<a name="l02016"></a>02016             }
<a name="l02017"></a>02017             push( @$pageRow, CGI::td(CGI::b(&#39; ] &#39;)) );
<a name="l02018"></a>02018             unshift( @$probRow, &#39; &amp;nbsp; &#39; );
<a name="l02019"></a>02019             $jumpLinks = CGI::table( CGI::Tr(@$pageRow), 
<a name="l02020"></a>02020                          CGI::Tr( CGI::td($probRow) ) );
<a name="l02021"></a>02021         } else {
<a name="l02022"></a>02022             unshift( @$probRow, CGI::b(<span class="stringliteral">&#39;Jump to: &#39;</span>) );
<a name="l02023"></a>02023             $jumpLinks = CGI::table( CGI::Tr( CGI::td($probRow) ) );
<a name="l02024"></a>02024         }
<a name="l02025"></a>02025     
<a name="l02026"></a>02026         print $jumpLinks,<span class="stringliteral">&quot;\n&quot;</span>;
<a name="l02027"></a>02027 
<a name="l02028"></a>02028 <span class="preprocessor">    # print out problems and attempt results, as appropriate</span>
<a name="l02029"></a>02029 <span class="preprocessor"></span><span class="preprocessor">    # note: args to attemptResults are (self,) $pg, $showAttemptAnswers,</span>
<a name="l02030"></a>02030 <span class="preprocessor"></span><span class="preprocessor">    #    $showCorrectAnswers, $showAttemptResults (and-ed with </span>
<a name="l02031"></a>02031 <span class="preprocessor"></span><span class="preprocessor">    #    $showAttemptAnswers), $showSummary, $showAttemptPreview (or-ed </span>
<a name="l02032"></a>02032 <span class="preprocessor"></span><span class="preprocessor">    #    with zero)</span>
<a name="l02033"></a>02033 <span class="preprocessor"></span>        my $problemNumber = 0;
<a name="l02034"></a>02034 
<a name="l02035"></a>02035         <span class="keywordflow">foreach</span> my $i ( 0 .. $#pg_results ) {
<a name="l02036"></a>02036             my $pg = $pg_results[$probOrder[$i]];
<a name="l02037"></a>02037             $problemNumber++;
<a name="l02038"></a>02038 
<a name="l02039"></a>02039             <span class="keywordflow">if</span> ( $i &gt;= $startProb &amp;&amp; $i &lt;= $endProb ) { 
<a name="l02040"></a>02040                 
<a name="l02041"></a>02041                 my $recordMessage = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02042"></a>02042                 my $resultsTable = <span class="stringliteral">&#39;&#39;</span>;
<a name="l02043"></a>02043 
<a name="l02044"></a>02044                 <span class="keywordflow">if</span> ($pg-&gt;{flags}-&gt;{showPartialCorrectAnswers}&gt;=0 &amp;&amp; $submitAnswers){
<a name="l02045"></a>02045                     <span class="keywordflow">if</span> ( $scoreRecordedMessage[$probOrder[$i]] ne 
<a name="l02046"></a>02046                          <span class="stringliteral">&quot;Your score on this problem was recorded.&quot;</span> ) {
<a name="l02047"></a>02047                         $recordMessage = CGI::span({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;resultsWithError&quot;</span>},
<a name="l02048"></a>02048                                        <span class="stringliteral">&quot;ANSWERS NOT RECORDED --&quot;</span>, 
<a name="l02049"></a>02049                                        $scoreRecordedMessage[$probOrder[$i]]);
<a name="l02050"></a>02050 
<a name="l02051"></a>02051                     }
<a name="l02052"></a>02052                     $resultsTable = 
<a name="l02053"></a>02053                         $self-&gt;attemptResults($pg, 1, $will{showCorrectAnswers},
<a name="l02054"></a>02054                                   $pg-&gt;{flags}-&gt;{showPartialCorrectAnswers} &amp;&amp; $canShowProblemScores,
<a name="l02055"></a>02055                                   $canShowProblemScores, 1);
<a name="l02056"></a>02056                     
<a name="l02057"></a>02057                 } elsif ( $checkAnswers ) {
<a name="l02058"></a>02058                     $recordMessage = CGI::span({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;resultsWithError&quot;</span>},
<a name="l02059"></a>02059                                    <span class="stringliteral">&quot;ANSWERS ONLY CHECKED -- &quot;</span>, 
<a name="l02060"></a>02060                                    <span class="stringliteral">&quot;ANSWERS NOT RECORDED&quot;</span>);
<a name="l02061"></a>02061                     
<a name="l02062"></a>02062                     $resultsTable = 
<a name="l02063"></a>02063                         $self-&gt;attemptResults($pg, 1, $will{showCorrectAnswers},
<a name="l02064"></a>02064                                   $pg-&gt;{flags}-&gt;{showPartialCorrectAnswers} &amp;&amp; $canShowProblemScores,
<a name="l02065"></a>02065                                   $canShowProblemScores, 1);
<a name="l02066"></a>02066 
<a name="l02067"></a>02067                 } elsif ( $previewAnswers ) {
<a name="l02068"></a>02068                     $recordMessage = 
<a name="l02069"></a>02069                         CGI::span({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;resultsWithError&quot;</span>},
<a name="l02070"></a>02070                               <span class="stringliteral">&quot;PREVIEW ONLY -- ANSWERS NOT RECORDED&quot;</span>);
<a name="l02071"></a>02071                     $resultsTable = $self-&gt;attemptResults($pg, 1, 0, 0, 0, 1);
<a name="l02072"></a>02072  
<a name="l02073"></a>02073                 }       
<a name="l02074"></a>02074                 
<a name="l02075"></a>02075                 print CGI::start_div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwProblem&quot;</span>});
<a name="l02076"></a>02076                 my $i1 = $i+1;
<a name="l02077"></a>02077                 my $pv = $problems[$probOrder[$i]]-&gt;value() ? $problems[$probOrder[$i]]-&gt;value() : 1;
<a name="l02078"></a>02078                 my $points = ($pv &gt; 1) ? 
<a name="l02079"></a>02079                     <span class="stringliteral">&quot; (&quot;</span> . $pv . <span class="stringliteral">&quot; points)&quot;</span> : 
<a name="l02080"></a>02080                     <span class="stringliteral">&quot; (1 point)&quot;</span>;
<a name="l02081"></a>02081                 print CGI::a({-name=&gt;<span class="stringliteral">&quot;#$i1&quot;</span>},<span class="stringliteral">&quot;&quot;</span>);
<a name="l02082"></a>02082                 print CGI::strong(<span class="stringliteral">&quot;Problem $problemNumber.&quot;</span>), 
<a name="l02083"></a>02083                     <span class="stringliteral">&quot;$points\n&quot;</span>, $recordMessage;
<a name="l02084"></a>02084                 print CGI::p($pg-&gt;{body_text}),
<a name="l02085"></a>02085                 CGI::p($pg-&gt;{result}-&gt;{msg} ? 
<a name="l02086"></a>02086                        CGI::b(<span class="stringliteral">&quot;Note: &quot;</span>) : <span class="stringliteral">&quot;&quot;</span>, 
<a name="l02087"></a>02087                        CGI::i($pg-&gt;{result}-&gt;{msg}));
<a name="l02088"></a>02088                 print CGI::p({<span class="keyword">class</span>=&gt;<span class="stringliteral">&quot;gwPreview&quot;</span>}, 
<a name="l02089"></a>02089                          CGI::a({-href=&gt;<span class="stringliteral">&quot;$jsprevlink&quot;</span>}, 
<a name="l02090"></a>02090                             <span class="stringliteral">&quot;preview problems&quot;</span>));
<a name="l02091"></a>02091 
<a name="l02092"></a>02092                 print $resultsTable <span class="keywordflow">if</span> $resultsTable; 
<a name="l02093"></a>02093 
<a name="l02094"></a>02094                 print CGI::end_div();
<a name="l02095"></a>02095 <span class="preprocessor">                # finally, store the problem status for </span>
<a name="l02096"></a>02096 <span class="preprocessor"></span><span class="preprocessor">                #    continued attempts recording</span>
<a name="l02097"></a>02097 <span class="preprocessor"></span>                my $pNum = $probOrder[$i] + 1;
<a name="l02098"></a>02098                 print CGI::hidden({-name=&gt;<span class="stringliteral">&quot;probstatus$pNum&quot;</span>,
<a name="l02099"></a>02099                            -value=&gt;$probStatus[$probOrder[$i]]});
<a name="l02100"></a>02100 
<a name="l02101"></a>02101                 print <span class="stringliteral">&quot;\n&quot;</span>, CGI::hr(), <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l02102"></a>02102             } <span class="keywordflow">else</span> {
<a name="l02103"></a>02103                 my $i1 = $i+1;
<a name="l02104"></a>02104 <span class="preprocessor">                # keep the jump to anchors so that jumping to </span>
<a name="l02105"></a>02105 <span class="preprocessor"></span><span class="preprocessor">                #    problem number 6 still works, even if </span>
<a name="l02106"></a>02106 <span class="preprocessor"></span><span class="preprocessor">                #    we&#39;re viewing only problems 5-7, etc.</span>
<a name="l02107"></a>02107 <span class="preprocessor"></span>                print CGI::a({-name=&gt;<span class="stringliteral">&quot;#$i1&quot;</span>},<span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l02108"></a>02108 <span class="preprocessor">                # and print out hidden fields with the current </span>
<a name="l02109"></a>02109 <span class="preprocessor"></span><span class="preprocessor">                #    last answers</span>
<a name="l02110"></a>02110 <span class="preprocessor"></span>                my $curr_prefix = <span class="charliteral">&#39;Q&#39;</span> . sprintf(<span class="stringliteral">&quot;%04d&quot;</span>, $probOrder[$i]+1) . <span class="charliteral">&#39;_&#39;</span>;
<a name="l02111"></a>02111                 my @curr_fields = grep /^$curr_prefix/, keys %{$self-&gt;{formFields}};
<a name="l02112"></a>02112                 <span class="keywordflow">foreach</span> my $curr_field ( @curr_fields ) {
<a name="l02113"></a>02113                     print CGI::hidden({-name=&gt;$curr_field, 
<a name="l02114"></a>02114                                -value=&gt;$self-&gt;{formFields}-&gt;{$curr_field}});
<a name="l02115"></a>02115                 }
<a name="l02116"></a>02116 <span class="preprocessor">                # finally, store the problem status for </span>
<a name="l02117"></a>02117 <span class="preprocessor"></span><span class="preprocessor">                #    continued attempts recording</span>
<a name="l02118"></a>02118 <span class="preprocessor"></span>                my $pNum = $probOrder[$i] + 1;
<a name="l02119"></a>02119                 print CGI::hidden({-name=&gt;<span class="stringliteral">&quot;probstatus$pNum&quot;</span>,
<a name="l02120"></a>02120                            -value=&gt;$probStatus[$probOrder[$i]]});
<a name="l02121"></a>02121 <span class="preprocessor">#       my $probid = &#39;Q&#39; . sprintf(&quot;%04d&quot;, $probOrder[$i]+1) . &quot;_AnSwEr1&quot;;</span>
<a name="l02122"></a>02122 <span class="preprocessor"></span><span class="preprocessor">#       my $probval = $self-&gt;{formFields}-&gt;{$probid};</span>
<a name="l02123"></a>02123 <span class="preprocessor"></span><span class="preprocessor">#       print CGI::hidden({-name=&gt;$probid, -value=&gt;$probval}), &quot;\n&quot;;</span>
<a name="l02124"></a>02124 <span class="preprocessor"></span>            }
<a name="l02125"></a>02125         }
<a name="l02126"></a>02126         print CGI::p($jumpLinks, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02127"></a>02127         print <span class="stringliteral">&quot;\n&quot;</span>,CGI::hr(), <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l02128"></a>02128 
<a name="l02129"></a>02129         <span class="keywordflow">if</span> ($can{showCorrectAnswers}) {
<a name="l02130"></a>02130             print CGI::checkbox(-name   =&gt;<span class="stringliteral">&quot;showCorrectAnswers&quot;</span>,
<a name="l02131"></a>02131 #               -checked =&gt; $will{showCorrectAnswers},
<a name="l02132"></a>02132                         -checked=&gt;$want{showCorrectAnswers},
<a name="l02133"></a>02133                         -label  =&gt;<span class="stringliteral">&quot;Show correct answers&quot;</span>,
<a name="l02134"></a>02134                         );
<a name="l02135"></a>02135         }
<a name="l02136"></a>02136 <span class="preprocessor">#     if ($can{showHints}) {</span>
<a name="l02137"></a>02137 <span class="preprocessor"></span><span class="preprocessor">#   print CGI::div({style=&gt;&quot;color:red&quot;},</span>
<a name="l02138"></a>02138 <span class="preprocessor"></span><span class="preprocessor">#              CGI::checkbox(-name    =&gt; &quot;showHints&quot;,</span>
<a name="l02139"></a>02139 <span class="preprocessor"></span><span class="preprocessor">#                    -checked =&gt; $will{showHints},</span>
<a name="l02140"></a>02140 <span class="preprocessor"></span><span class="preprocessor">#                    -label   =&gt; &quot;Show Hints&quot;,</span>
<a name="l02141"></a>02141 <span class="preprocessor"></span><span class="preprocessor">#                    )</span>
<a name="l02142"></a>02142 <span class="preprocessor"></span><span class="preprocessor">#              );</span>
<a name="l02143"></a>02143 <span class="preprocessor"></span><span class="preprocessor">#     }</span>
<a name="l02144"></a>02144 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ($can{showSolutions}) {
<a name="l02145"></a>02145             print CGI::checkbox(-name    =&gt; <span class="stringliteral">&quot;showSolutions&quot;</span>,
<a name="l02146"></a>02146                         -checked =&gt; $will{showSolutions},
<a name="l02147"></a>02147                         -label   =&gt; <span class="stringliteral">&quot;Show Solutions&quot;</span>,
<a name="l02148"></a>02148                         );
<a name="l02149"></a>02149         }
<a name="l02150"></a>02150 
<a name="l02151"></a>02151         <span class="keywordflow">if</span> ($can{showCorrectAnswers} or $can{showHints} or 
<a name="l02152"></a>02152             $can{showSolutions}) {
<a name="l02153"></a>02153             print CGI::br();
<a name="l02154"></a>02154         }
<a name="l02155"></a>02155 
<a name="l02156"></a>02156         print CGI::p( CGI::submit( -name=&gt;<span class="stringliteral">&quot;previewAnswers&quot;</span>, 
<a name="l02157"></a>02157                        -label=&gt;<span class="stringliteral">&quot;Preview Test&quot;</span> ),
<a name="l02158"></a>02158                   ($can{recordAnswersNextTime} ? 
<a name="l02159"></a>02159                    CGI::submit( -name=&gt;<span class="stringliteral">&quot;submitAnswers&quot;</span>,
<a name="l02160"></a>02160                         -label=&gt;<span class="stringliteral">&quot;Grade Test&quot;</span> ) : <span class="stringliteral">&quot; &quot;</span>),
<a name="l02161"></a>02161                   ($can{checkAnswersNextTime} &amp;&amp; ! $can{recordAnswersNextTime} ?
<a name="l02162"></a>02162                    CGI::submit( -name=&gt;<span class="stringliteral">&quot;checkAnswers&quot;</span>,
<a name="l02163"></a>02163                         -label=&gt;<span class="stringliteral">&quot;Check Test&quot;</span> ) : <span class="stringliteral">&quot; &quot;</span>),
<a name="l02164"></a>02164                   ($numProbPerPage &amp;&amp; $numPages &gt; 1 &amp;&amp; 
<a name="l02165"></a>02165                    $can{recordAnswersNextTime} ? CGI::br() . 
<a name="l02166"></a>02166                    CGI::em(<span class="stringliteral">&quot;Note: grading the test grades &quot;</span> . 
<a name="l02167"></a>02167                        CGI::b(<span class="stringliteral">&quot;all&quot;</span>) . <span class="stringliteral">&quot; problems, not just those &quot;</span> . 
<a name="l02168"></a>02168                        <span class="stringliteral">&quot;on this page.&quot;</span>) : <span class="stringliteral">&quot; &quot;</span>) );
<a name="l02169"></a>02169 
<a name="l02170"></a>02170 <span class="preprocessor">        ## save the source file, etc., if we&#39;re trying an undefined</span>
<a name="l02171"></a>02171 <span class="preprocessor"></span><span class="preprocessor">        ##    set</span>
<a name="l02172"></a>02172 <span class="preprocessor"></span><span class="preprocessor">        # print( CGI::hidden(</span>
<a name="l02173"></a>02173 <span class="preprocessor"></span><span class="preprocessor">        #          -name   =&gt; &#39;sourceFilePath&#39;,</span>
<a name="l02174"></a>02174 <span class="preprocessor"></span><span class="preprocessor">        #          -value  =&gt;  $self-&gt;{problem}-&gt;{source_file}</span>
<a name="l02175"></a>02175 <span class="preprocessor"></span><span class="preprocessor">        #         ))  if defined($self-&gt;{problem}-&gt;{source_file});</span>
<a name="l02176"></a>02176 <span class="preprocessor"></span>        print( CGI::hidden(
<a name="l02177"></a>02177                    -name   =&gt; <span class="stringliteral">&#39;sourceFilePath&#39;</span>,
<a name="l02178"></a>02178                    -value  =&gt;  $r-&gt;param(<span class="stringliteral">&quot;sourceFilePath&quot;</span>)
<a name="l02179"></a>02179                   ))  if defined($r-&gt;param(&quot;sourceFilePath&quot;));
<a name="l02180"></a>02180         print( CGI::hidden(
<a name="l02181"></a>02181                    -name   =&gt; &#39;problemSeed&#39;,
<a name="l02182"></a>02182                    -value  =&gt;  $r-&gt;param(&quot;problemSeed&quot;)
<a name="l02183"></a>02183                   ))  if defined($r-&gt;param(&quot;problemSeed&quot;));
<a name="l02184"></a>02184 
<a name="l02185"></a>02185         print CGI::endform();
<a name="l02186"></a>02186     }
<a name="l02187"></a>02187 
<a name="l02188"></a>02188     <span class="preprocessor"># finally, put in a show answers option if appropriate</span>
<a name="l02189"></a>02189 <span class="preprocessor"></span><span class="preprocessor">    # print answer inspection button</span>
<a name="l02190"></a>02190 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;view_answers&quot;</span>)) {
<a name="l02191"></a>02191         my $pastAnswersPage = $urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::ShowAnswers&quot;</span>, $r, courseID =&gt; $ce-&gt;{courseName});
<a name="l02192"></a>02192         my $showPastAnswersURL = $self-&gt;systemLink($pastAnswersPage, authen =&gt; 0); # no authen info <span class="keywordflow">for</span> form action
<a name="l02193"></a>02193         print <span class="stringliteral">&quot;\n&quot;</span>, CGI::start_form(-method=&gt;<span class="stringliteral">&quot;POST&quot;</span>,-action=&gt;$showPastAnswersURL,-target=&gt;<span class="stringliteral">&quot;WW_Info&quot;</span>),<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02194"></a>02194             $self-&gt;hidden_authen_fields,<span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02195"></a>02195             CGI::hidden(-name =&gt; <span class="stringliteral">&#39;courseID&#39;</span>,  -value=&gt;$ce-&gt;{courseName}), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02196"></a>02196             CGI::hidden(-name =&gt; <span class="stringliteral">&#39;problemID&#39;</span>, -value=&gt;($startProb+1)), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02197"></a>02197             CGI::hidden(-name =&gt; <span class="stringliteral">&#39;setID&#39;</span>,  -value=&gt;$setVName), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02198"></a>02198             CGI::hidden(-name =&gt; <span class="stringliteral">&#39;studentUser&#39;</span>,    -value=&gt;$effectiveUser), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02199"></a>02199             CGI::p( {-align=&gt;<span class="stringliteral">&quot;left&quot;</span>},
<a name="l02200"></a>02200                 CGI::submit(-name =&gt; <span class="stringliteral">&#39;action&#39;</span>,  -value=&gt;<span class="stringliteral">&#39;Show Past Answers&#39;</span>)
<a name="l02201"></a>02201                 ), <span class="stringliteral">&quot;\n&quot;</span>,
<a name="l02202"></a>02202             CGI::endform();
<a name="l02203"></a>02203     }
<a name="l02204"></a>02204 
<a name="l02205"></a>02205 <span class="preprocessor"># debugging verbiage</span>
<a name="l02206"></a>02206 <span class="preprocessor"></span><span class="preprocessor">#     if ( $can{checkAnswersNextTime} ) {</span>
<a name="l02207"></a>02207 <span class="preprocessor"></span><span class="preprocessor">#   print &quot;Can check answers next time\n&quot;;</span>
<a name="l02208"></a>02208 <span class="preprocessor"></span><span class="preprocessor">#     } else {</span>
<a name="l02209"></a>02209 <span class="preprocessor"></span><span class="preprocessor">#   print &quot;Can NOT check answers next time\n&quot;;</span>
<a name="l02210"></a>02210 <span class="preprocessor"></span><span class="preprocessor">#     }</span>
<a name="l02211"></a>02211 <span class="preprocessor"></span><span class="preprocessor">#     if ( $can{recordAnswersNextTime} ) {</span>
<a name="l02212"></a>02212 <span class="preprocessor"></span><span class="preprocessor">#   print &quot;Can record answers next time\n&quot;;</span>
<a name="l02213"></a>02213 <span class="preprocessor"></span><span class="preprocessor">#     } else {</span>
<a name="l02214"></a>02214 <span class="preprocessor"></span><span class="preprocessor">#   print &quot;Can NOT record answers next time\n&quot;;</span>
<a name="l02215"></a>02215 <span class="preprocessor"></span><span class="preprocessor">#     }</span>
<a name="l02216"></a>02216 <span class="preprocessor"></span>
<a name="l02217"></a>02217 <span class="preprocessor">  # we exclude the feedback form from gateway tests.  they can use the feedback</span>
<a name="l02218"></a>02218 <span class="preprocessor"></span><span class="preprocessor">  #   button on the preceding or following pages</span>
<a name="l02219"></a>02219 <span class="preprocessor"></span><span class="preprocessor">#     my $ce = $r-&gt;ce;</span>
<a name="l02220"></a>02220 <span class="preprocessor"></span><span class="preprocessor">#     my $root = $ce-&gt;{webworkURLs}-&gt;{root};</span>
<a name="l02221"></a>02221 <span class="preprocessor"></span><span class="preprocessor">#     my $courseName = $ce-&gt;{courseName};</span>
<a name="l02222"></a>02222 <span class="preprocessor"></span><span class="preprocessor">#     my $feedbackURL = &quot;$root/$courseName/feedback/&quot;;</span>
<a name="l02223"></a>02223 <span class="preprocessor"></span><span class="preprocessor">#     print CGI::startform(&quot;POST&quot;, $feedbackURL),</span>
<a name="l02224"></a>02224 <span class="preprocessor"></span><span class="preprocessor">#           $self-&gt;hidden_authen_fields,</span>
<a name="l02225"></a>02225 <span class="preprocessor"></span><span class="preprocessor">#           CGI::hidden(&quot;module&quot;, __PACKAGE__),</span>
<a name="l02226"></a>02226 <span class="preprocessor"></span><span class="preprocessor">#           CGI::hidden(&quot;set&quot;,    $self-&gt;{set}-&gt;set_id),</span>
<a name="l02227"></a>02227 <span class="preprocessor"></span><span class="preprocessor">#           CGI::p({-align=&gt;&quot;right&quot;},</span>
<a name="l02228"></a>02228 <span class="preprocessor"></span><span class="preprocessor">#        CGI::submit(-name=&gt;&quot;feedbackForm&quot;, -label=&gt;&quot;Send Feedback&quot;)</span>
<a name="l02229"></a>02229 <span class="preprocessor"></span><span class="preprocessor">#        ),</span>
<a name="l02230"></a>02230 <span class="preprocessor"></span><span class="preprocessor">#     CGI::endform();</span>
<a name="l02231"></a>02231 <span class="preprocessor"></span>    
<a name="l02232"></a>02232     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l02233"></a>02233 
<a name="l02234"></a>02234 }
<a name="l02235"></a>02235 
<a name="l02236"></a>02236 
<a name="l02237"></a>02237 <span class="preprocessor">###########################################################################</span>
<a name="l02238"></a>02238 <span class="preprocessor"></span><span class="preprocessor"># Evaluation utilities</span>
<a name="l02239"></a>02239 <span class="preprocessor"></span><span class="preprocessor">############################################################################</span>
<a name="l02240"></a>02240 <span class="preprocessor"></span>
<a name="l02241"></a>02241 sub getProblemHTML {
<a name="l02242"></a>02242     my ( $self, $EffectiveUser, $set, $formFields,
<a name="l02243"></a>02243          $mergedProblem, $pgFile ) = @_;
<a name="l02244"></a>02244 <span class="preprocessor"># in:  $EffectiveUser is the effective user we&#39;re working as, $set is the</span>
<a name="l02245"></a>02245 <span class="preprocessor"></span><span class="preprocessor">#      merged set version, %$formFields the form fields from the input form</span>
<a name="l02246"></a>02246 <span class="preprocessor"></span><span class="preprocessor">#      that we need to worry about putting into the HTML we&#39;re generating,</span>
<a name="l02247"></a>02247 <span class="preprocessor"></span><span class="preprocessor">#      and $mergedProblem and $pgFile are what we&#39;d expect.</span>
<a name="l02248"></a>02248 <span class="preprocessor"></span><span class="preprocessor">#      $pgFile is optional</span>
<a name="l02249"></a>02249 <span class="preprocessor"></span><span class="preprocessor"># out: the translated problem is returned</span>
<a name="l02250"></a>02250 <span class="preprocessor"></span>
<a name="l02251"></a>02251     my $r = $self-&gt;r;
<a name="l02252"></a>02252     my $ce = $r-&gt;ce;
<a name="l02253"></a>02253     my $db = $r-&gt;db;
<a name="l02254"></a>02254     my $key =  $r-&gt;param(<span class="stringliteral">&#39;key&#39;</span>);
<a name="l02255"></a>02255     my $setName = $set-&gt;set_id;
<a name="l02256"></a>02256     my $setVersionNumber = $set-&gt;version_id;
<a name="l02257"></a>02257     my $permissionLevel = $self-&gt;{permissionLevel};
<a name="l02258"></a>02258     my $psvn = $set-&gt;psvn();
<a name="l02259"></a>02259 
<a name="l02260"></a>02260     <span class="keywordflow">if</span> ( defined($mergedProblem) &amp;&amp; $mergedProblem-&gt;problem_id ) {
<a name="l02261"></a>02261 <span class="preprocessor"># nothing needs to be done</span>
<a name="l02262"></a>02262 <span class="preprocessor"></span>
<a name="l02263"></a>02263     } elsif ($pgFile) {
<a name="l02264"></a>02264         $mergedProblem = 
<a name="l02265"></a>02265             <a class="code" href="classWeBWorK_1_1DB_1_1Record_1_1ProblemVersion.html">WeBWorK::DB::Record::ProblemVersion</a>-&gt;new(
<a name="l02266"></a>02266                     set_id =&gt; $setName,
<a name="l02267"></a>02267                     version_id =&gt; $setVersionNumber,
<a name="l02268"></a>02268                     problem_id =&gt; 0,
<a name="l02269"></a>02269                     login_id =&gt; $EffectiveUser-&gt;user_id,
<a name="l02270"></a>02270                     source_file =&gt; $pgFile,
<a name="l02271"></a>02271             # the rest of Problem<span class="stringliteral">&#39;s fields are not needed, i think</span>
<a name="l02272"></a>02272 <span class="stringliteral">                                 );</span>
<a name="l02273"></a>02273 <span class="stringliteral">    }</span>
<a name="l02274"></a>02274 <span class="stringliteral"># figure out if we&#39;</span>re allowed to <span class="keyword">get</span> solutions and call PG-&gt;new accordingly.
<a name="l02275"></a>02275     my $showCorrectAnswers = $self-&gt;{will}-&gt;{showCorrectAnswers};
<a name="l02276"></a>02276     my $showHints          = $self-&gt;{will}-&gt;{showHints};
<a name="l02277"></a>02277     my $showSolutions      = $self-&gt;{will}-&gt;{showSolutions};
<a name="l02278"></a>02278     my $processAnswers     = $self-&gt;{will}-&gt;{checkAnswers};
<a name="l02279"></a>02279 
<a name="l02280"></a>02280 <span class="preprocessor"># FIXME  I&#39;m not sure that problem_id is what we want here  FIXME</span>
<a name="l02281"></a>02281 <span class="preprocessor"></span>    my $problemNumber = $mergedProblem-&gt;problem_id;
<a name="l02282"></a>02282 
<a name="l02283"></a>02283     my $pg = 
<a name="l02284"></a>02284         <a class="code" href="classWeBWorK_1_1PG.html">WeBWorK::PG</a>-&gt;new(
<a name="l02285"></a>02285              $ce,
<a name="l02286"></a>02286              $EffectiveUser,
<a name="l02287"></a>02287              $key,
<a name="l02288"></a>02288              $set,
<a name="l02289"></a>02289              $mergedProblem,
<a name="l02290"></a>02290              $psvn,
<a name="l02291"></a>02291              $formFields, 
<a name="l02292"></a>02292              { # translation options
<a name="l02293"></a>02293                  displayMode     =&gt; $self-&gt;{displayMode},
<a name="l02294"></a>02294                  showHints       =&gt; $showHints,
<a name="l02295"></a>02295                  showSolutions   =&gt; $showSolutions,
<a name="l02296"></a>02296                  refreshMath2img =&gt; $showHints || $showSolutions,
<a name="l02297"></a>02297                  processAnswers  =&gt; 1,
<a name="l02298"></a>02298                  QUIZ_PREFIX     =&gt; <span class="charliteral">&#39;Q&#39;</span> . 
<a name="l02299"></a>02299                  sprintf(<span class="stringliteral">&quot;%04d&quot;</span>,$problemNumber) . <span class="charliteral">&#39;_&#39;</span>,
<a name="l02300"></a>02300                  },
<a name="l02301"></a>02301                  );
<a name="l02302"></a>02302     
<a name="l02303"></a>02303 <span class="preprocessor"># FIXME  is problem_id the correct thing in the following two stanzas?</span>
<a name="l02304"></a>02304 <span class="preprocessor"></span><span class="preprocessor"># FIXME  the original version had &quot;problem number&quot;, which is what we want.</span>
<a name="l02305"></a>02305 <span class="preprocessor"></span><span class="preprocessor"># FIXME  I think problem_id will work, too</span>
<a name="l02306"></a>02306 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($pg-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#a95e724764fdc1755f19e100da83c6225">warnings</a>} ne <span class="stringliteral">&quot;&quot;</span>) {
<a name="l02307"></a>02307         push @{$self-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#a95e724764fdc1755f19e100da83c6225">warnings</a>}}, {
<a name="l02308"></a>02308             <span class="keyword">set</span>     =&gt; <span class="stringliteral">&quot;$setName,v$setVersionNumber&quot;</span>,
<a name="l02309"></a>02309             problem =&gt; $mergedProblem-&gt;problem_id,
<a name="l02310"></a>02310             <a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a> =&gt; $pg-&gt;{<a class="code" href="classWeBWorK_1_1ContentGenerator.html#a95e724764fdc1755f19e100da83c6225">warnings</a>},
<a name="l02311"></a>02311         };
<a name="l02312"></a>02312     }
<a name="l02313"></a>02313 
<a name="l02314"></a>02314     <span class="keywordflow">if</span> ($pg-&gt;{flags}-&gt;{error_flag}) {
<a name="l02315"></a>02315         push @{$self-&gt;{errors}}, {
<a name="l02316"></a>02316             <span class="keyword">set</span>     =&gt; <span class="stringliteral">&quot;$setName,v$setVersionNumber&quot;</span>,
<a name="l02317"></a>02317             problem =&gt; $mergedProblem-&gt;problem_id,
<a name="l02318"></a>02318             <a class="code" href="classWeBWorK_1_1ContentGenerator.html#a265ffdacc7577cf63e2ad7519dbdb0a2">message</a> =&gt; $pg-&gt;{errors},
<a name="l02319"></a>02319             context =&gt; $pg-&gt;{body_text},
<a name="l02320"></a>02320         };
<a name="l02321"></a>02321 <span class="preprocessor">    # if there was an error, body_text contains</span>
<a name="l02322"></a>02322 <span class="preprocessor"></span><span class="preprocessor">    # the error context, not TeX code</span>
<a name="l02323"></a>02323 <span class="preprocessor"></span>        $pg-&gt;{body_text} = undef;
<a name="l02324"></a>02324     }
<a name="l02325"></a>02325 
<a name="l02326"></a>02326     <span class="keywordflow">return</span>    $pg;
<a name="l02327"></a>02327 }
<a name="l02328"></a>02328 
<a name="l02329"></a>02329 <span class="preprocessor">##### output utilities #####</span>
<a name="l02330"></a>02330 <span class="preprocessor"></span>sub problemListRow($$$) {
<a name="l02331"></a>02331     my $self = shift;
<a name="l02332"></a>02332     my $set = shift;
<a name="l02333"></a>02333     my $Problem = shift;
<a name="l02334"></a>02334     
<a name="l02335"></a>02335     my $name = $Problem-&gt;problem_id;
<a name="l02336"></a>02336     my $interactiveURL = <span class="stringliteral">&quot;$name/?&quot;</span> . $self-&gt;url_authen_args;
<a name="l02337"></a>02337     my $interactive = CGI::a({-href=&gt;$interactiveURL}, <span class="stringliteral">&quot;Problem $name&quot;</span>);
<a name="l02338"></a>02338     my $attempts = $Problem-&gt;num_correct + $Problem-&gt;num_incorrect;
<a name="l02339"></a>02339     my $remaining = $Problem-&gt;max_attempts &lt; 0
<a name="l02340"></a>02340         ? <span class="stringliteral">&quot;unlimited&quot;</span>
<a name="l02341"></a>02341         : $Problem-&gt;max_attempts - $attempts;
<a name="l02342"></a>02342     my $status = sprintf(<span class="stringliteral">&quot;%.0f%%&quot;</span>, $Problem-&gt;status * 100); # round to whole number
<a name="l02343"></a>02343     
<a name="l02344"></a>02344     <span class="keywordflow">return</span> CGI::Tr(CGI::td({-nowrap=&gt;1}, [
<a name="l02345"></a>02345         $interactive,
<a name="l02346"></a>02346         $attempts,
<a name="l02347"></a>02347         $remaining,
<a name="l02348"></a>02348         $status,
<a name="l02349"></a>02349     ]));
<a name="l02350"></a>02350 }
<a name="l02351"></a>02351 <span class="preprocessor"># sub nbsp {</span>
<a name="l02352"></a>02352 <span class="preprocessor"></span><span class="preprocessor">#   my $str = shift;</span>
<a name="l02353"></a>02353 <span class="preprocessor"></span><span class="preprocessor">#   ($str) ? $str : &#39;&amp;nbsp;&#39;;  # returns non-breaking space for empty strings</span>
<a name="l02354"></a>02354 <span class="preprocessor"></span><span class="preprocessor"># }</span>
<a name="l02355"></a>02355 <span class="preprocessor"></span>
<a name="l02356"></a>02356 <span class="preprocessor">##### logging subroutine ####</span>
<a name="l02357"></a>02357 <span class="preprocessor"></span>
<a name="l02358"></a>02358 
<a name="l02359"></a>02359 
<a name="l02360"></a>02360 
<a name="l02361"></a>02361 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:34 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
