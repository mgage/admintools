<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: GetLibrarySetProblems.pm Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    </ul>
  </div>
<h1>GetLibrarySetProblems.pm</h1><a href="GetLibrarySetProblems_8pm.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">################################################################################</span>
<a name="l00002"></a>00002 <span class="preprocessor"></span><span class="preprocessor"># WeBWorK Online Homework Delivery System</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor"># Copyright Â© 2000-2007 The WeBWorK Project, http://openwebwork.sf.net/</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span><span class="preprocessor"># $CVSHeader: webwork2/lib/WeBWorK/ContentGenerator/Instructor/SetMaker.pm,v 1.85 2008/07/01 13:18:52 glarose Exp $</span>
<a name="l00005"></a>00005 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00006"></a>00006 <span class="preprocessor"></span><span class="preprocessor"># This program is free software; you can redistribute it and/or modify it under</span>
<a name="l00007"></a>00007 <span class="preprocessor"></span><span class="preprocessor"># the terms of either: (a) the GNU General Public License as published by the</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span><span class="preprocessor"># Free Software Foundation; either version 2, or (at your option) any later</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># version, or (b) the &quot;Artistic License&quot; which comes with this package.</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor"># </span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor"># This program is distributed in the hope that it will be useful, but WITHOUT</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor"># ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># FOR A PARTICULAR PURPOSE.  See either the GNU General Public License or the</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor"># Artistic License for more details.</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">################################################################################</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="keyword">package </span>WeBWorK::ContentGenerator::Instructor::GetLibrarySetProblems;
<a name="l00019"></a>00019 use base qw(<a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor.html">WeBWorK::ContentGenerator::Instructor</a>);
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 =head1 NAME
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1GetLibrarySetProblems.html">WeBWorK::ContentGenerator::Instructor::GetLibrarySetProblems</a> - Make homework sets.
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 =cut
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 use strict;
<a name="l00028"></a>00028 use warnings;
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#use CGI qw(-nosticky);</span>
<a name="l00032"></a>00032 <span class="preprocessor"></span>use <a class="code" href="classWeBWorK_1_1CGI.html">WeBWorK::CGI</a>;
<a name="l00033"></a>00033 use <a class="code" href="classWeBWorK_1_1Debug.html">WeBWorK::Debug</a>;
<a name="l00034"></a>00034 use <a class="code" href="classWeBWorK_1_1Form.html">WeBWorK::Form</a>;
<a name="l00035"></a>00035 use <a class="code" href="classWeBWorK_1_1Utils.html">WeBWorK::Utils</a> qw(readDirectory max sortByName);
<a name="l00036"></a>00036 use <a class="code" href="classWeBWorK_1_1Utils_1_1Tasks.html">WeBWorK::Utils::Tasks</a> qw(renderProblems);
<a name="l00037"></a>00037 use File::Find;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 require <a class="code" href="classWeBWorK_1_1Utils_1_1ListingDB.html">WeBWorK::Utils::ListingDB</a>;
<a name="l00040"></a><a class="code" href="classWeBWorK_1_1ContentGenerator_1_1Instructor_1_1GetLibrarySetProblems.html">00040</a> 
<a name="l00041"></a>00041 use constant SHOW_HINTS_DEFAULT =&gt; 0;
<a name="l00042"></a>00042 use constant SHOW_SOLUTIONS_DEFAULT =&gt; 0;
<a name="l00043"></a>00043 use constant MAX_SHOW_DEFAULT =&gt; 20;
<a name="l00044"></a>00044 use constant NO_LOCAL_SET_STRING =&gt; <span class="stringliteral">&#39;No sets in this course yet&#39;</span>;
<a name="l00045"></a>00045 use constant SELECT_SET_STRING =&gt; <span class="stringliteral">&#39;Select a Set from this Course&#39;</span>;
<a name="l00046"></a>00046 use constant SELECT_LOCAL_STRING =&gt; <span class="stringliteral">&#39;Select a Problem Collection&#39;</span>;
<a name="l00047"></a>00047 use constant MY_PROBLEMS =&gt; <span class="stringliteral">&#39;  My Problems  &#39;</span>;
<a name="l00048"></a>00048 use constant MAIN_PROBLEMS =&gt; <span class="stringliteral">&#39;  Unclassified Problems  &#39;</span>;
<a name="l00049"></a>00049 use constant CREATE_SET_BUTTON =&gt; <span class="stringliteral">&#39;Create New Set&#39;</span>;
<a name="l00050"></a>00050 use constant ALL_CHAPTERS =&gt; <span class="stringliteral">&#39;All Chapters&#39;</span>;
<a name="l00051"></a>00051 use constant ALL_SUBJECTS =&gt; <span class="stringliteral">&#39;All Subjects&#39;</span>;
<a name="l00052"></a>00052 use constant ALL_SECTIONS =&gt; <span class="stringliteral">&#39;All Sections&#39;</span>;
<a name="l00053"></a>00053 use constant ALL_TEXTBOOKS =&gt; <span class="stringliteral">&#39;All Textbooks&#39;</span>;
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 use constant LIB2_DATA =&gt; {
<a name="l00056"></a>00056   <span class="stringliteral">&#39;dbchapter&#39;</span> =&gt; {name =&gt; <span class="stringliteral">&#39;library_chapters&#39;</span>, all =&gt; <span class="stringliteral">&#39;All Chapters&#39;</span>},
<a name="l00057"></a>00057   <span class="stringliteral">&#39;dbsection&#39;</span> =&gt;  {name =&gt; <span class="stringliteral">&#39;library_sections&#39;</span>, all =&gt;<span class="stringliteral">&#39;All Sections&#39;</span> },
<a name="l00058"></a>00058   <span class="stringliteral">&#39;dbsubject&#39;</span> =&gt;  {name =&gt; <span class="stringliteral">&#39;library_subjects&#39;</span>, all =&gt; <span class="stringliteral">&#39;All Subjects&#39;</span> },
<a name="l00059"></a>00059   <span class="stringliteral">&#39;textbook&#39;</span> =&gt;  {name =&gt; <span class="stringliteral">&#39;library_textbook&#39;</span>, all =&gt;  <span class="stringliteral">&#39;All Textbooks&#39;</span>},
<a name="l00060"></a>00060   <span class="stringliteral">&#39;textchapter&#39;</span> =&gt; {name =&gt; <span class="stringliteral">&#39;library_textchapter&#39;</span>, all =&gt; <span class="stringliteral">&#39;All Chapters&#39;</span>},
<a name="l00061"></a>00061   <span class="stringliteral">&#39;textsection&#39;</span> =&gt; {name =&gt; <span class="stringliteral">&#39;library_textsection&#39;</span>, all =&gt; <span class="stringliteral">&#39;All Sections&#39;</span>},
<a name="l00062"></a>00062   <span class="stringliteral">&#39;keywords&#39;</span> =&gt;  {name =&gt; <span class="stringliteral">&#39;library_keywords&#39;</span>, all =&gt; <span class="stringliteral">&#39;&#39;</span> },
<a name="l00063"></a>00063   };
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="preprocessor">## Flags for operations on files</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00067"></a>00067 use constant ADDED =&gt; 1;
<a name="l00068"></a>00068 use constant HIDDEN =&gt; (1 &lt;&lt; 1);
<a name="l00069"></a>00069 use constant SUCCESS =&gt; (1 &lt;&lt; 2);
<a name="l00070"></a>00070 use constant DELETED =&gt; (1 &lt;&lt; 3);
<a name="l00071"></a>00071 use constant MOVED =&gt; (1 &lt;&lt; 4);
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 <span class="preprocessor">##  for additional problib buttons</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span>my %problib;    ## filled in in global.conf
<a name="l00075"></a>00075 my %ignoredir = (
<a name="l00076"></a>00076     <span class="charliteral">&#39;.&#39;</span> =&gt; 1, <span class="stringliteral">&#39;..&#39;</span> =&gt; 1, <span class="stringliteral">&#39;Library&#39;</span> =&gt; 1, <span class="stringliteral">&#39;CVS&#39;</span> =&gt; 1, <span class="stringliteral">&#39;tmpEdit&#39;</span> =&gt; 1,
<a name="l00077"></a>00077     <span class="stringliteral">&#39;headers&#39;</span> =&gt; 1, <span class="stringliteral">&#39;macros&#39;</span> =&gt; 1, <span class="stringliteral">&#39;email&#39;</span> =&gt; 1, <span class="stringliteral">&#39;.svn&#39;</span> =&gt; 1,
<a name="l00078"></a>00078 );
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 sub prepare_activity_entry {
<a name="l00081"></a>00081     my $self=shift;
<a name="l00082"></a>00082     my $r = $self-&gt;r;
<a name="l00083"></a>00083     my $user = $self-&gt;r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>) || <span class="stringliteral">&#39;NO_USER&#39;</span>;
<a name="l00084"></a>00084     <span class="keywordflow">return</span>(<span class="stringliteral">&quot;In SetMaker2 as user $user&quot;</span>);
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 <span class="preprocessor">## This is for searching the disk for directories containing pg files.</span>
<a name="l00088"></a>00088 <span class="preprocessor"></span><span class="preprocessor">## to make the recursion work, this returns an array where the first </span>
<a name="l00089"></a>00089 <span class="preprocessor"></span><span class="preprocessor">## item is the number of pg files in the directory.  The second is a</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span><span class="preprocessor">## list of directories which contain pg files.</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span><span class="preprocessor">##</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span><span class="preprocessor">## If a directory contains only one pg file and the directory name</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="preprocessor">## is the same as the file name, then the directory is considered</span>
<a name="l00094"></a>00094 <span class="preprocessor"></span><span class="preprocessor">## to be part of the parent directory (it is probably in a separate</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span><span class="preprocessor">## directory only because it has auxiliary files that want to be</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="preprocessor">## kept together with the pg file).</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span><span class="preprocessor">##</span>
<a name="l00098"></a>00098 <span class="preprocessor"></span><span class="preprocessor">## If a directory has a file named &quot;=library-ignore&quot;, it is never</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span><span class="preprocessor">## included in the directory menu.  If a directory contains a file</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span><span class="preprocessor">## called &quot;=library-combine-up&quot;, then its pg are included with those</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="preprocessor">## in the parent directory (and the directory does not appear in the</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span><span class="preprocessor">## menu).  If it has a file called &quot;=library-no-combine&quot; then it is</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="preprocessor">## always listed as a separate directory even if it contains only one</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span><span class="preprocessor">## pg file.</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span>
<a name="l00106"></a>00106 sub get_library_sets {
<a name="l00107"></a>00107     my $top = shift; my $dir = shift;
<a name="l00108"></a>00108 <span class="preprocessor">    # ignore directories that give us an error</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>    my @lis = eval { readDirectory($dir) };
<a name="l00110"></a>00110     <span class="keywordflow">if</span> ($@) {
<a name="l00111"></a>00111         warn $@;
<a name="l00112"></a>00112         <span class="keywordflow">return</span> (0);
<a name="l00113"></a>00113     }
<a name="l00114"></a>00114     <span class="keywordflow">return</span> (0) <span class="keywordflow">if</span> grep /^=library-ignore$/, @lis;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     my @pgfiles = grep { m/\.pg$/ and (not m/(Header|-text)\.pg$/) and -f &quot;$dir/$_&quot;} @lis;
<a name="l00117"></a>00117     my $pgcount = scalar(@pgfiles);
<a name="l00118"></a>00118     my $pgname = $dir; $pgname =~ s!.*/!!; $pgname .= &#39;.pg&#39;;
<a name="l00119"></a>00119     my $combineUp = ($pgcount == 1 &amp;&amp; $pgname eq $pgfiles[0] &amp;&amp; !(grep /^=library-no-combine$/, @lis));
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     my @pgdirs;
<a name="l00122"></a>00122     my @dirs = grep {!$ignoredir{$_} and -d <span class="stringliteral">&quot;$dir/$_&quot;</span>} @lis;
<a name="l00123"></a>00123     <span class="keywordflow">if</span> ($top == 1) {@dirs = grep {!$problib{$_}} @dirs}
<a name="l00124"></a>00124     <span class="keywordflow">foreach</span> my $subdir (@dirs) {
<a name="l00125"></a>00125         my @results = get_library_sets(0, <span class="stringliteral">&quot;$dir/$subdir&quot;</span>);
<a name="l00126"></a>00126         $pgcount += shift @results; push(@pgdirs,@results);
<a name="l00127"></a>00127     }
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="keywordflow">return</span> ($pgcount, @pgdirs) <span class="keywordflow">if</span> $top || $combineUp || grep /^=library-combine-up$/, @lis;
<a name="l00130"></a>00130     <span class="keywordflow">return</span> (0,@pgdirs,$dir);
<a name="l00131"></a>00131 }
<a name="l00132"></a>00132 
<a name="l00133"></a>00133 sub get_library_pgs {
<a name="l00134"></a>00134     my $top = shift; my $base = shift; my $dir = shift;
<a name="l00135"></a>00135     my @lis = readDirectory(<span class="stringliteral">&quot;$base/$dir&quot;</span>);
<a name="l00136"></a>00136     <span class="keywordflow">return</span> () <span class="keywordflow">if</span> grep /^=library-ignore$/, @lis;
<a name="l00137"></a>00137     <span class="keywordflow">return</span> () <span class="keywordflow">if</span> !$top &amp;&amp; grep /^=library-no-combine$/, @lis;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     my @pgs = grep { m/\.pg$/ and (not m/(Header|-text)\.pg$/) and -f &quot;$base/$dir/$_&quot;} @lis;
<a name="l00140"></a>00140     my $others = scalar(grep { (!m/\.pg$/ || m/(Header|-text)\.pg$/) &amp;&amp;
<a name="l00141"></a>00141                                 !m/(\.(tmp|bak)|~)$/ &amp;&amp; -f <span class="stringliteral">&quot;$base/$dir/$_&quot;</span> } @lis);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     my @dirs = grep {!$ignoredir{$_} and -d <span class="stringliteral">&quot;$base/$dir/$_&quot;</span>} @lis;
<a name="l00144"></a>00144     <span class="keywordflow">if</span> ($top == 1) {@dirs = grep {!$problib{$_}} @dirs}
<a name="l00145"></a>00145     <span class="keywordflow">foreach</span> my $subdir (@dirs) {push(@pgs, get_library_pgs(0,<span class="stringliteral">&quot;$base/$dir&quot;</span>,$subdir))}
<a name="l00146"></a>00146 
<a name="l00147"></a>00147     <span class="keywordflow">return</span> () unless $top || (scalar(@pgs) == 1 &amp;&amp; $others) || grep /^=library-combine-up$/, @lis;
<a name="l00148"></a>00148     <span class="keywordflow">return</span> (map {<span class="stringliteral">&quot;$dir/$_&quot;</span>} @pgs);
<a name="l00149"></a>00149 }
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 sub list_pg_files {
<a name="l00152"></a>00152     my ($templates,$dir) = @_;
<a name="l00153"></a>00153     my $top = ($dir eq <span class="charliteral">&#39;.&#39;</span>)? 1 : 2;
<a name="l00154"></a>00154     my @pgs = get_library_pgs($top,$templates,$dir);
<a name="l00155"></a>00155     <span class="keywordflow">return</span> sortByName(undef,@pgs);
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="preprocessor">## Search for set definition files</span>
<a name="l00159"></a>00159 <span class="preprocessor"></span>
<a name="l00160"></a>00160 sub get_set_defs {
<a name="l00161"></a>00161     my $topdir = shift;
<a name="l00162"></a>00162     my @found_set_defs;
<a name="l00163"></a>00163 <span class="preprocessor">    # get_set_defs_wanted is a closure over @found_set_defs</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span>    my $get_set_defs_wanted = sub {
<a name="l00165"></a>00165 <span class="preprocessor">        #my $fn = $_;</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span><span class="preprocessor">        #my $fdir = $File::Find::dir;</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span><span class="preprocessor">        #return() if($fn !~ /^set.*\.def$/);</span>
<a name="l00168"></a>00168 <span class="preprocessor"></span><span class="preprocessor">        ##return() if(not -T $fn);</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span><span class="preprocessor">        #push @found_set_defs, &quot;$fdir/$fn&quot;;</span>
<a name="l00170"></a>00170 <span class="preprocessor"></span>        push @found_set_defs, $_ <span class="keywordflow">if</span> m|/<span class="keyword">set</span>[^/]*\.def$|;
<a name="l00171"></a>00171     };
<a name="l00172"></a>00172     find({ wanted =&gt; $get_set_defs_wanted, follow_fast=&gt;1, no_chdir=&gt;1}, $topdir);
<a name="l00173"></a>00173     map { $_ =~ s|^$topdir/?|| } @found_set_defs;
<a name="l00174"></a>00174     <span class="keywordflow">return</span> @found_set_defs;
<a name="l00175"></a>00175 }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177 <span class="preprocessor">## Try to make reading of set defs more flexible.  Additional strategies</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span><span class="preprocessor">## for fixing a path can be added here.</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span>
<a name="l00180"></a>00180 sub munge_pg_file_path {
<a name="l00181"></a>00181     my $self = shift;
<a name="l00182"></a>00182     my $pg_path = shift;
<a name="l00183"></a>00183     my $path_to_set_def = shift;
<a name="l00184"></a>00184     my $end_path = $pg_path;
<a name="l00185"></a>00185 <span class="preprocessor">    # if the path is ok, don&#39;t fix it</span>
<a name="l00186"></a>00186 <span class="preprocessor"></span>    <span class="keywordflow">return</span>($pg_path) <span class="keywordflow">if</span>(-e $self-&gt;r-&gt;ce-&gt;{courseDirs}{templates}.<span class="stringliteral">&quot;/$pg_path&quot;</span>);
<a name="l00187"></a>00187 <span class="preprocessor">    # if we have followed a link into a self contained course to get</span>
<a name="l00188"></a>00188 <span class="preprocessor"></span><span class="preprocessor">    # to the set.def file, we need to insert the start of the path to</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span><span class="preprocessor">    # the set.def file</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span>    $end_path = <span class="stringliteral">&quot;$path_to_set_def/$pg_path&quot;</span>;
<a name="l00191"></a>00191     <span class="keywordflow">return</span>($end_path) <span class="keywordflow">if</span>(-e $self-&gt;r-&gt;ce-&gt;{courseDirs}{templates}.<span class="stringliteral">&quot;/$end_path&quot;</span>);
<a name="l00192"></a>00192 <span class="preprocessor">    # if we got this far, this path is bad, but we let it produce</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span><span class="preprocessor">    # an error so the user knows there is a troublesome path in the</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span><span class="preprocessor">    # set.def file.</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>    <span class="keywordflow">return</span>($pg_path);
<a name="l00196"></a>00196 }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198 <span class="preprocessor">## Read a set definition file.  This could be abstracted since it happens</span>
<a name="l00199"></a>00199 <span class="preprocessor"></span><span class="preprocessor">## elsewhere.  Here we don&#39;t have to process so much of the file.</span>
<a name="l00200"></a>00200 <span class="preprocessor"></span>
<a name="l00201"></a>00201 sub read_set_def {
<a name="l00202"></a>00202     my $self = shift;
<a name="l00203"></a>00203     my $r = $self-&gt;r;
<a name="l00204"></a>00204     my $filePathOrig = shift;
<a name="l00205"></a>00205     my $filePath = $r-&gt;ce-&gt;{courseDirs}{templates}.<span class="stringliteral">&quot;/$filePathOrig&quot;</span>;
<a name="l00206"></a>00206     $filePathOrig =~ s/<span class="keyword">set</span>.*\.def$<span class="comment">//;</span>
<a name="l00207"></a>00207     $filePathOrig =~ s|/$||;
<a name="l00208"></a>00208     $filePathOrig = <span class="stringliteral">&quot;.&quot;</span> <span class="keywordflow">if</span> ($filePathOrig !~ /\S/);
<a name="l00209"></a>00209     my @pg_files = ();
<a name="l00210"></a>00210     my ($line, $got_to_pgs, $name, @rest) = (<span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00211"></a>00211     <span class="keywordflow">if</span> ( open (SETFILENAME, <span class="stringliteral">&quot;$filePath&quot;</span>) )    {
<a name="l00212"></a>00212         <span class="keywordflow">while</span>($line = &lt;SETFILENAME&gt;) {
<a name="l00213"></a>00213             chomp($line);
<a name="l00214"></a>00214             $line =~ s|(#.*)||; # don<span class="stringliteral">&#39;t read past comments</span>
<a name="l00215"></a>00215 <span class="stringliteral">            if($got_to_pgs) {</span>
<a name="l00216"></a>00216 <span class="stringliteral">                unless ($line =~ /\S/) {next;} # skip blank lines</span>
<a name="l00217"></a>00217 <span class="stringliteral">                ($name,@rest) = split (/\s*,\s*/,$line);</span>
<a name="l00218"></a>00218 <span class="stringliteral">                $name =~ s/\s*//g;</span>
<a name="l00219"></a>00219 <span class="stringliteral">                push @pg_files, $name;</span>
<a name="l00220"></a>00220 <span class="stringliteral">            } else {</span>
<a name="l00221"></a>00221 <span class="stringliteral">                $got_to_pgs = 1 if ($line =~ /problemList\s*=/);</span>
<a name="l00222"></a>00222 <span class="stringliteral">            }</span>
<a name="l00223"></a>00223 <span class="stringliteral">        }</span>
<a name="l00224"></a>00224 <span class="stringliteral">    } else {</span>
<a name="l00225"></a>00225 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;Cannot open $filePath&quot;);</span>
<a name="l00226"></a>00226 <span class="stringliteral">    }</span>
<a name="l00227"></a>00227 <span class="stringliteral">    # This is where we would potentially munge the pg file paths</span>
<a name="l00228"></a>00228 <span class="stringliteral">    # One possibility</span>
<a name="l00229"></a>00229 <span class="stringliteral">    @pg_files = map { $self-&gt;munge_pg_file_path($_, $filePathOrig) } @pg_files;</span>
<a name="l00230"></a>00230 <span class="stringliteral">    return(@pg_files);</span>
<a name="l00231"></a>00231 <span class="stringliteral">}</span>
<a name="l00232"></a>00232 <span class="stringliteral"></span>
<a name="l00233"></a>00233 <span class="stringliteral">## go through past page getting a list of identifiers for the problems</span>
<a name="l00234"></a>00234 <span class="stringliteral">## and whether or not they are selected, and whether or not they should</span>
<a name="l00235"></a>00235 <span class="stringliteral">## be hidden</span>
<a name="l00236"></a>00236 <span class="stringliteral"></span>
<a name="l00237"></a>00237 <span class="stringliteral">sub get_past_problem_files {</span>
<a name="l00238"></a>00238 <span class="stringliteral">    my $r = shift;</span>
<a name="l00239"></a>00239 <span class="stringliteral">    my @found=();</span>
<a name="l00240"></a>00240 <span class="stringliteral">    my $count =1;</span>
<a name="l00241"></a>00241 <span class="stringliteral">    while (defined($r-&gt;param(&quot;filetrial$count&quot;))) {</span>
<a name="l00242"></a>00242 <span class="stringliteral">        my $val = 0;</span>
<a name="l00243"></a>00243 <span class="stringliteral">        $val |= ADDED if($r-&gt;param(&quot;trial$count&quot;));</span>
<a name="l00244"></a>00244 <span class="stringliteral">        $val |= HIDDEN if($r-&gt;param(&quot;hideme$count&quot;));</span>
<a name="l00245"></a>00245 <span class="stringliteral">        $val |= MOVED if($r-&gt;param(&quot;moved$count&quot;));</span>
<a name="l00246"></a>00246 <span class="stringliteral">        push @found, [$r-&gt;param(&quot;filetrial$count&quot;), $val];          </span>
<a name="l00247"></a>00247 <span class="stringliteral">        $count++;</span>
<a name="l00248"></a>00248 <span class="stringliteral">    }</span>
<a name="l00249"></a>00249 <span class="stringliteral">    $count = 1;</span>
<a name="l00250"></a>00250 <span class="stringliteral">    while (defined($r-&gt;param(&quot;mysetfiletrial$count&quot;))) {</span>
<a name="l00251"></a>00251 <span class="stringliteral">      my $val = 0;</span>
<a name="l00252"></a>00252 <span class="stringliteral">      $val |= DELETED if($r-&gt;param(&quot;deleted$count&quot;));</span>
<a name="l00253"></a>00253 <span class="stringliteral">      push @found, [$r-&gt;param(&quot;mysetfiletrial$count&quot;), $val];</span>
<a name="l00254"></a>00254 <span class="stringliteral">      $count++;</span>
<a name="l00255"></a>00255 <span class="stringliteral">    }</span>
<a name="l00256"></a>00256 <span class="stringliteral">    return(\@found);</span>
<a name="l00257"></a>00257 <span class="stringliteral">}</span>
<a name="l00258"></a>00258 <span class="stringliteral"></span>
<a name="l00259"></a>00259 <span class="stringliteral"></span>
<a name="l00260"></a>00260 <span class="stringliteral">sub make_data_row {</span>
<a name="l00261"></a>00261 <span class="stringliteral">    my $self = shift;</span>
<a name="l00262"></a>00262 <span class="stringliteral">    my $sourceFileName = shift;</span>
<a name="l00263"></a>00263 <span class="stringliteral">    my $pg = shift;</span>
<a name="l00264"></a>00264 <span class="stringliteral">    my $cnt = shift;</span>
<a name="l00265"></a>00265 <span class="stringliteral">    my $mark = shift || 0;</span>
<a name="l00266"></a>00266 <span class="stringliteral"></span>
<a name="l00267"></a>00267 <span class="stringliteral">    $sourceFileName =~ s|^./||; # clean up top ugliness</span>
<a name="l00268"></a>00268 <span class="stringliteral"></span>
<a name="l00269"></a>00269 <span class="stringliteral">    my $urlpath = $self-&gt;r-&gt;urlpath;</span>
<a name="l00270"></a>00270 <span class="stringliteral">    my $db = $self-&gt;r-&gt;db;</span>
<a name="l00271"></a>00271 <span class="stringliteral"></span>
<a name="l00272"></a>00272 <span class="stringliteral">    ## to set up edit and try links elegantly we want to know if</span>
<a name="l00273"></a>00273 <span class="stringliteral">    ##    any target set is a gateway assignment or not</span>
<a name="l00274"></a>00274 <span class="stringliteral">    my $localSet = $self-&gt;r-&gt;param(&#39;</span>local_sets<span class="stringliteral">&#39;);</span>
<a name="l00275"></a>00275 <span class="stringliteral">    my $setRecord;</span>
<a name="l00276"></a>00276 <span class="stringliteral">    if ( defined($localSet) &amp;&amp; $localSet ne SELECT_SET_STRING &amp;&amp;</span>
<a name="l00277"></a>00277 <span class="stringliteral">         $localSet ne NO_LOCAL_SET_STRING ) {</span>
<a name="l00278"></a>00278 <span class="stringliteral">        $setRecord = $db-&gt;getGlobalSet( $localSet );</span>
<a name="l00279"></a>00279 <span class="stringliteral">    }</span>
<a name="l00280"></a>00280 <span class="stringliteral">    my $isGatewaySet = ( defined($setRecord) &amp;&amp; </span>
<a name="l00281"></a>00281 <span class="stringliteral">                 $setRecord-&gt;assignment_type =~ /gateway/ );</span>
<a name="l00282"></a>00282 <span class="stringliteral"></span>
<a name="l00283"></a>00283 <span class="stringliteral">    my $problem_output = $pg-&gt;{flags}-&gt;{error_flag} ?</span>
<a name="l00284"></a>00284 <span class="stringliteral">        CGI::div({class=&gt;&quot;ResultsWithError&quot;}, CGI::em(&quot;This problem produced an error&quot;))</span>
<a name="l00285"></a>00285 <span class="stringliteral">        : CGI::div({class=&gt;&quot;RenderSolo&quot;}, $pg-&gt;{body_text});</span>
<a name="l00286"></a>00286 <span class="stringliteral">    $problem_output .= $pg-&gt;{flags}-&gt;{comment} if($pg-&gt;{flags}-&gt;{comment});</span>
<a name="l00287"></a>00287 <span class="stringliteral"></span>
<a name="l00288"></a>00288 <span class="stringliteral"></span>
<a name="l00289"></a>00289 <span class="stringliteral">    #if($self-&gt;{r}-&gt;param(&#39;</span>browse_which<span class="stringliteral">&#39;) ne &#39;</span>browse_npl_library<span class="stringliteral">&#39;) {</span>
<a name="l00290"></a>00290 <span class="stringliteral">    my $problem_seed = $self-&gt;{&#39;</span>problem_seed<span class="stringliteral">&#39;} || 1234;</span>
<a name="l00291"></a>00291 <span class="stringliteral">    my $edit_link = CGI::a({href=&gt;$self-&gt;systemLink(</span>
<a name="l00292"></a>00292 <span class="stringliteral">         $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::Instructor::PGProblemEditor&quot;,</span>
<a name="l00293"></a>00293 <span class="stringliteral">              courseID =&gt;$urlpath-&gt;arg(&quot;courseID&quot;),</span>
<a name="l00294"></a>00294 <span class="stringliteral">              setID=&gt;&quot;Undefined_Set&quot;,</span>
<a name="l00295"></a>00295 <span class="stringliteral">              problemID=&gt;&quot;1&quot;),</span>
<a name="l00296"></a>00296 <span class="stringliteral">            params=&gt;{sourceFilePath =&gt; &quot;$sourceFileName&quot;, problemSeed=&gt; $problem_seed}</span>
<a name="l00297"></a>00297 <span class="stringliteral">          ), target=&gt;&quot;WW_Editor&quot;}, &quot;Edit it&quot; );</span>
<a name="l00298"></a>00298 <span class="stringliteral">    </span>
<a name="l00299"></a>00299 <span class="stringliteral">    my $displayMode = $self-&gt;r-&gt;param(&quot;mydisplayMode&quot;);</span>
<a name="l00300"></a>00300 <span class="stringliteral">    $displayMode = $self-&gt;r-&gt;ce-&gt;{pg}-&gt;{options}-&gt;{displayMode}</span>
<a name="l00301"></a>00301 <span class="stringliteral">        if not defined $displayMode or $displayMode eq &quot;None&quot;;</span>
<a name="l00302"></a>00302 <span class="stringliteral">    my $module = ( $isGatewaySet ) ? &quot;GatewayQuiz&quot; : &quot;Problem&quot;;</span>
<a name="l00303"></a>00303 <span class="stringliteral">    my %pathArgs = ( courseID =&gt;$urlpath-&gt;arg(&quot;courseID&quot;),</span>
<a name="l00304"></a>00304 <span class="stringliteral">            setID=&gt;&quot;Undefined_Set&quot; );</span>
<a name="l00305"></a>00305 <span class="stringliteral">    $pathArgs{problemID} = &quot;1&quot; if ( ! $isGatewaySet );</span>
<a name="l00306"></a>00306 <span class="stringliteral"></span>
<a name="l00307"></a>00307 <span class="stringliteral">    my $try_link = CGI::a({href=&gt;$self-&gt;systemLink(</span>
<a name="l00308"></a>00308 <span class="stringliteral">        $urlpath-&gt;newFromModule(&quot;WeBWorK::ContentGenerator::$module&quot;,</span>
<a name="l00309"></a>00309 <span class="stringliteral">            %pathArgs ),</span>
<a name="l00310"></a>00310 <span class="stringliteral">            params =&gt;{</span>
<a name="l00311"></a>00311 <span class="stringliteral">                effectiveUser =&gt; scalar($self-&gt;r-&gt;param(&#39;</span>user<span class="stringliteral">&#39;)),</span>
<a name="l00312"></a>00312 <span class="stringliteral">                editMode =&gt; &quot;SetMaker&quot;,</span>
<a name="l00313"></a>00313 <span class="stringliteral">                problemSeed=&gt; $problem_seed,</span>
<a name="l00314"></a>00314 <span class="stringliteral">                sourceFilePath =&gt; &quot;$sourceFileName&quot;,</span>
<a name="l00315"></a>00315 <span class="stringliteral">                displayMode =&gt; $displayMode,</span>
<a name="l00316"></a>00316 <span class="stringliteral">            }</span>
<a name="l00317"></a>00317 <span class="stringliteral">        ), target=&gt;&quot;WW_View&quot;}, &quot;Try it&quot;);</span>
<a name="l00318"></a>00318 <span class="stringliteral"></span>
<a name="l00319"></a>00319 <span class="stringliteral">    my %add_box_data = ( -id=&gt;&quot;trial$cnt&quot;, -class=&gt;&quot;add_problem_checkbox&quot; ,-name=&gt;&quot;trial$cnt&quot;,-value=&gt;1,-label=&gt;&quot;Add this problem to the target set on the next update&quot;);</span>
<a name="l00320"></a>00320 <span class="stringliteral">    #allow for a move command from one problem set to anoter</span>
<a name="l00321"></a>00321 <span class="stringliteral">    my $move_box_data;</span>
<a name="l00322"></a>00322 <span class="stringliteral">    if($self-&gt;r-&gt;param(&#39;</span>edit_mysets_set<span class="stringliteral">&#39;)){</span>
<a name="l00323"></a>00323 <span class="stringliteral">      $move_box_data = CGI::checkbox( -id=&gt;&quot;moved$cnt&quot; ,-name=&gt;&quot;moved$cnt&quot;,-value=&gt;1,,-override=&gt;1,-label=&gt;&quot;Move this problem from this set to the target set on the next update&quot;);</span>
<a name="l00324"></a>00324 <span class="stringliteral">    }</span>
<a name="l00325"></a>00325 <span class="stringliteral">    else{</span>
<a name="l00326"></a>00326 <span class="stringliteral">      $move_box_data = &quot;&quot;;</span>
<a name="l00327"></a>00327 <span class="stringliteral">    }</span>
<a name="l00328"></a>00328 <span class="stringliteral">    if($mark &amp; SUCCESS) {</span>
<a name="l00329"></a>00329 <span class="stringliteral">        $add_box_data{ -label } .= &quot; (just added this problem)&quot;;</span>
<a name="l00330"></a>00330 <span class="stringliteral">    } elsif($mark &amp; ADDED) {</span>
<a name="l00331"></a>00331 <span class="stringliteral">        $add_box_data{ -checked } = 1;</span>
<a name="l00332"></a>00332 <span class="stringliteral">    }</span>
<a name="l00333"></a>00333 <span class="stringliteral"></span>
<a name="l00334"></a>00334 <span class="stringliteral">    if(!($self-&gt;{isInSet}{$sourceFileName})){</span>
<a name="l00335"></a>00335 <span class="stringliteral"></span>
<a name="l00336"></a>00336 <span class="stringliteral">    print CGI::div({-class=&gt;&quot;problem libraryProblem&quot;, -align=&gt;&quot;left&quot;, -draggable=&gt;&quot;true&quot;, -href=&gt;&quot;#&quot;, -id=&gt;&quot;$cnt&quot;},</span>
<a name="l00337"></a>00337 <span class="stringliteral">        CGI::p({},&quot;File name: $sourceFileName &quot;), </span>
<a name="l00338"></a>00338 <span class="stringliteral">        CGI::p({}, $edit_link, &quot; &quot;, $try_link),</span>
<a name="l00339"></a>00339 <span class="stringliteral">        CGI::p(CGI::checkbox(-id=&gt;&quot;hideme$cnt&quot;, -name=&gt;&quot;hideme$cnt&quot;,-value=&gt;1,-label=&gt;&quot;Don&#39;</span>t show <span class="keyword">this</span> problem on the next update<span class="stringliteral">&quot;,-override=&gt;1)),</span>
<a name="l00340"></a>00340 <span class="stringliteral">        CGI::p(CGI::checkbox((%add_box_data),-override=&gt;1)),</span>
<a name="l00341"></a>00341 <span class="stringliteral">        CGI::p($move_box_data),</span>
<a name="l00342"></a>00342 <span class="stringliteral">        CGI::hidden(-id=&gt;&quot;</span>filetrial$cnt<span class="stringliteral">&quot;, -name=&gt;&quot;</span>filetrial$cnt<span class="stringliteral">&quot;, -default=&gt;$sourceFileName,-override=&gt;1).</span>
<a name="l00343"></a>00343 <span class="stringliteral">        CGI::p($problem_output)</span>
<a name="l00344"></a>00344 <span class="stringliteral">      );</span>
<a name="l00345"></a>00345 <span class="stringliteral">    }</span>
<a name="l00346"></a>00346 <span class="stringliteral">    else{</span>
<a name="l00347"></a>00347 <span class="stringliteral">      print CGI::div({-class=&gt;&quot;</span>problem libraryProblem used<span class="stringliteral">&quot;, -align=&gt;&quot;</span>left<span class="stringliteral">&quot;, -draggable=&gt;&quot;</span><span class="keyword">true</span><span class="stringliteral">&quot;, -href=&gt;&quot;</span>#<span class="stringliteral">&quot;, -id=&gt;&quot;</span>$cnt<span class="stringliteral">&quot;},</span>
<a name="l00348"></a>00348 <span class="stringliteral">        CGI::p({},&quot;</span><a class="code" href="classWeBWorK_1_1File.html">File</a> name: $sourceFileName <span class="stringliteral">&quot;), </span>
<a name="l00349"></a>00349 <span class="stringliteral">        CGI::p({}, $edit_link, &quot;</span> <span class="stringliteral">&quot;, $try_link),</span>
<a name="l00350"></a>00350 <span class="stringliteral">        CGI::p(CGI::checkbox(-id=&gt;&quot;</span>hideme$cnt<span class="stringliteral">&quot;, -name=&gt;&quot;</span>hideme$cnt<span class="stringliteral">&quot;,-value=&gt;1,-label=&gt;&quot;</span>Don<span class="stringliteral">&#39;t show this problem on the next update&quot;,-override=&gt;1)),</span>
<a name="l00351"></a>00351 <span class="stringliteral">        CGI::p(CGI::checkbox((%add_box_data),-override=&gt;1)),</span>
<a name="l00352"></a>00352 <span class="stringliteral">        CGI::p($move_box_data),</span>
<a name="l00353"></a>00353 <span class="stringliteral">        CGI::hidden(-id=&gt;&quot;filetrial$cnt&quot;, -name=&gt;&quot;filetrial$cnt&quot;, -default=&gt;$sourceFileName,-override=&gt;1).</span>
<a name="l00354"></a>00354 <span class="stringliteral">        CGI::p($problem_output),</span>
<a name="l00355"></a>00355 <span class="stringliteral">        CGI::b(&quot;(This problem is in the target set)&quot;)</span>
<a name="l00356"></a>00356 <span class="stringliteral">      );</span>
<a name="l00357"></a>00357 <span class="stringliteral">    }</span>
<a name="l00358"></a>00358 <span class="stringliteral">}</span>
<a name="l00359"></a>00359 <span class="stringliteral"></span>
<a name="l00360"></a>00360 <span class="stringliteral"></span>
<a name="l00361"></a>00361 <span class="stringliteral">sub clear_default {</span>
<a name="l00362"></a>00362 <span class="stringliteral">    my $r = shift;</span>
<a name="l00363"></a>00363 <span class="stringliteral">    my $param = shift;</span>
<a name="l00364"></a>00364 <span class="stringliteral">    my $default = shift;</span>
<a name="l00365"></a>00365 <span class="stringliteral">    my $newvalue = $r-&gt;param($param) || &#39;</span><span class="stringliteral">&#39;;</span>
<a name="l00366"></a>00366 <span class="stringliteral">    $newvalue = &#39;</span><span class="stringliteral">&#39; if($newvalue eq $default);</span>
<a name="l00367"></a>00367 <span class="stringliteral">    $r-&gt;param($param, $newvalue);</span>
<a name="l00368"></a>00368 <span class="stringliteral">}</span>
<a name="l00369"></a>00369 <span class="stringliteral"></span>
<a name="l00370"></a>00370 <span class="stringliteral">sub pre_header_initialize {</span>
<a name="l00371"></a>00371 <span class="stringliteral">    my ($self) = @_;</span>
<a name="l00372"></a>00372 <span class="stringliteral">    my $r = $self-&gt;r;</span>
<a name="l00373"></a>00373 <span class="stringliteral">    ## For all cases, lets set some things</span>
<a name="l00374"></a>00374 <span class="stringliteral">    $self-&gt;{error}=0;</span>
<a name="l00375"></a>00375 <span class="stringliteral">    my $ce = $r-&gt;ce;</span>
<a name="l00376"></a>00376 <span class="stringliteral">    my $db = $r-&gt;db;</span>
<a name="l00377"></a>00377 <span class="stringliteral">    my $maxShown = $r-&gt;param(&#39;</span>max_shown<span class="stringliteral">&#39;) || MAX_SHOW_DEFAULT;</span>
<a name="l00378"></a>00378 <span class="stringliteral">    $maxShown = 10000000 if($maxShown eq &#39;</span>All<span class="stringliteral">&#39;); # let&#39;</span>s hope there aren<span class="stringliteral">&#39;t more</span>
<a name="l00379"></a>00379 <span class="stringliteral">    my $library_basic = $r-&gt;param(&#39;</span>library_is_basic<span class="stringliteral">&#39;) || 1;</span>
<a name="l00380"></a>00380 <span class="stringliteral">    $self-&gt;{problem_seed} = $r-&gt;param(&#39;</span>problem_seed<span class="stringliteral">&#39;) || 1234;</span>
<a name="l00381"></a>00381 <span class="stringliteral">    ## Fix some parameters</span>
<a name="l00382"></a>00382 <span class="stringliteral">    for my $key (keys(%{ LIB2_DATA() })) {</span>
<a name="l00383"></a>00383 <span class="stringliteral">        clear_default($r, LIB2_DATA-&gt;{$key}-&gt;{name}, LIB2_DATA-&gt;{$key}-&gt;{all} );</span>
<a name="l00384"></a>00384 <span class="stringliteral">    }</span>
<a name="l00385"></a>00385 <span class="stringliteral">    ##  Grab library sets to display from parameters list.  We will modify this</span>
<a name="l00386"></a>00386 <span class="stringliteral">    ##  as we go through the if/else tree</span>
<a name="l00387"></a>00387 <span class="stringliteral">    $self-&gt;{current_library_set} =  $r-&gt;param(&#39;</span>library_sets<span class="stringliteral">&#39;);</span>
<a name="l00388"></a>00388 <span class="stringliteral">    $self-&gt;{current_myset_set} = $r-&gt;param(&#39;</span>myset_sets<span class="stringliteral">&#39;);</span>
<a name="l00389"></a>00389 <span class="stringliteral">    if (not defined($self-&gt;{current_myset_set}) </span>
<a name="l00390"></a>00390 <span class="stringliteral">        or $self-&gt;{current_myset_set} eq &quot;Select a Homework Set&quot;</span>
<a name="l00391"></a>00391 <span class="stringliteral">        or $self-&gt;{current_myset_set} eq NO_LOCAL_SET_STRING) {</span>
<a name="l00392"></a>00392 <span class="stringliteral">      my @all_db_sets = $db-&gt;listGlobalSets;</span>
<a name="l00393"></a>00393 <span class="stringliteral">        @all_db_sets = sortByName(undef, @all_db_sets);</span>
<a name="l00394"></a>00394 <span class="stringliteral">        $self-&gt;{current_myset_set} = shift(@all_db_sets);</span>
<a name="l00395"></a>00395 <span class="stringliteral">      }</span>
<a name="l00396"></a>00396 <span class="stringliteral">    </span>
<a name="l00397"></a>00397 <span class="stringliteral">    ##  These directories will have individual buttons</span>
<a name="l00398"></a>00398 <span class="stringliteral">    %problib = %{$ce-&gt;{courseFiles}{problibs}} if $ce-&gt;{courseFiles}{problibs};</span>
<a name="l00399"></a>00399 <span class="stringliteral"></span>
<a name="l00400"></a>00400 <span class="stringliteral">    my $userName = $r-&gt;param(&#39;</span>user<span class="stringliteral">&#39;);</span>
<a name="l00401"></a>00401 <span class="stringliteral">    my $user = $db-&gt;getUser($userName); # checked </span>
<a name="l00402"></a>00402 <span class="stringliteral">    die &quot;record for user $userName (real user) does not exist.&quot; </span>
<a name="l00403"></a>00403 <span class="stringliteral">        unless defined $user;</span>
<a name="l00404"></a>00404 <span class="stringliteral">    my $authz = $r-&gt;authz;</span>
<a name="l00405"></a>00405 <span class="stringliteral">    unless ($authz-&gt;hasPermissions($userName, &quot;modify_problem_sets&quot;)) {</span>
<a name="l00406"></a>00406 <span class="stringliteral">        return(&quot;&quot;); # Error message already produced in the body</span>
<a name="l00407"></a>00407 <span class="stringliteral">    }</span>
<a name="l00408"></a>00408 <span class="stringliteral"></span>
<a name="l00409"></a>00409 <span class="stringliteral">    ## Now one action we have to deal with here</span>
<a name="l00410"></a>00410 <span class="stringliteral">    if ($r-&gt;param(&#39;</span>edit_local<span class="stringliteral">&#39;)) {</span>
<a name="l00411"></a>00411 <span class="stringliteral">        my $urlpath = $r-&gt;urlpath;</span>
<a name="l00412"></a>00412 <span class="stringliteral">        my $db = $r-&gt;db;</span>
<a name="l00413"></a>00413 <span class="stringliteral">        my $checkset = $db-&gt;getGlobalSet($r-&gt;param(&#39;</span>local_sets<span class="stringliteral">&#39;));</span>
<a name="l00414"></a>00414 <span class="stringliteral">        if (not defined($checkset)) {</span>
<a name="l00415"></a>00415 <span class="stringliteral">            $self-&gt;{error} = 1;</span>
<a name="l00416"></a>00416 <span class="stringliteral">            $self-&gt;addbadmessage(&#39;</span>You need to select a <span class="stringliteral">&quot;Target Set&quot;</span> before you can edit it.<span class="stringliteral">&#39;);</span>
<a name="l00417"></a>00417 <span class="stringliteral">        } else {</span>
<a name="l00418"></a>00418 <span class="stringliteral">            my $page = $urlpath-&gt;newFromModule(&#39;</span>WeBWorK::ContentGenerator::Instructor::ProblemSetDetail<span class="stringliteral">&#39;, setID=&gt;$r-&gt;param(&#39;</span>local_sets<span class="stringliteral">&#39;), courseID=&gt;$urlpath-&gt;arg(&quot;courseID&quot;));</span>
<a name="l00419"></a>00419 <span class="stringliteral">            my $url = $self-&gt;systemLink($page);</span>
<a name="l00420"></a>00420 <span class="stringliteral">            $self-&gt;reply_with_redirect($url);</span>
<a name="l00421"></a>00421 <span class="stringliteral">        }</span>
<a name="l00422"></a>00422 <span class="stringliteral">    }</span>
<a name="l00423"></a>00423 <span class="stringliteral"></span>
<a name="l00424"></a>00424 <span class="stringliteral">    ## Next, lots of set up so that errors can be reported with message()</span>
<a name="l00425"></a>00425 <span class="stringliteral"></span>
<a name="l00426"></a>00426 <span class="stringliteral">    ############# List of problems we have already printed</span>
<a name="l00427"></a>00427 <span class="stringliteral"></span>
<a name="l00428"></a>00428 <span class="stringliteral">    $self-&gt;{past_problems} = get_past_problem_files($r);</span>
<a name="l00429"></a>00429 <span class="stringliteral">    # if we don&#39;</span>t end up reusing problems, <span class="keyword">this</span> will be wiped out
<a name="l00430"></a>00430 <span class="preprocessor">    # if we do redisplay the same problems, we must adjust this accordingly</span>
<a name="l00431"></a>00431 <span class="preprocessor"></span>    my @past_marks = map {$_-&gt;[1]} @{$self-&gt;{past_problems}};
<a name="l00432"></a>00432     my $none_shown = scalar(@{$self-&gt;{past_problems}})==0;
<a name="l00433"></a>00433     my @pg_files=();
<a name="l00434"></a>00434     my @myset_files=();
<a name="l00435"></a>00435     my $use_previous_problems = 1;
<a name="l00436"></a>00436     my $first_shown = $r-&gt;param(<span class="stringliteral">&#39;first_shown&#39;</span>) || 0;
<a name="l00437"></a>00437     my $last_shown = $r-&gt;param(<span class="stringliteral">&#39;last_shown&#39;</span>); 
<a name="l00438"></a>00438     <span class="keywordflow">if</span> (not defined($last_shown)) {
<a name="l00439"></a>00439         $last_shown = -1; 
<a name="l00440"></a>00440     }
<a name="l00441"></a>00441     my @all_past_list = (); # these are include requested, but not shown
<a name="l00442"></a>00442     my $j = 0;
<a name="l00443"></a>00443     <span class="keywordflow">while</span> (defined($r-&gt;param(<span class="stringliteral">&quot;all_past_list$j&quot;</span>))) {
<a name="l00444"></a>00444         push @all_past_list, $r-&gt;param(<span class="stringliteral">&quot;all_past_list$j&quot;</span>);
<a name="l00445"></a>00445         $j++;
<a name="l00446"></a>00446     }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 <span class="preprocessor">    ############# Default of which problem selector to display</span>
<a name="l00449"></a>00449 <span class="preprocessor"></span>
<a name="l00450"></a>00450     my $browse_which = $r-&gt;param(<span class="stringliteral">&#39;browse_which&#39;</span>) || <span class="stringliteral">&#39;browse_npl_library&#39;</span>;
<a name="l00451"></a>00451     my $gridded = $r-&gt;param(<span class="stringliteral">&#39;gridify&#39;</span>) || <span class="stringliteral">&#39;false&#39;</span>;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 <span class="preprocessor">    ## check for problem lib buttons</span>
<a name="l00456"></a>00456 <span class="preprocessor"></span>    my $browse_lib = <span class="stringliteral">&#39;&#39;</span>;
<a name="l00457"></a>00457     <span class="keywordflow">foreach</span> my $lib (keys %problib) {
<a name="l00458"></a>00458         <span class="keywordflow">if</span> ($r-&gt;param(<span class="stringliteral">&quot;browse_$lib&quot;</span>)) {
<a name="l00459"></a>00459             $browse_lib = <span class="stringliteral">&quot;browse_$lib&quot;</span>;
<a name="l00460"></a>00460             last;
<a name="l00461"></a>00461         }
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 
<a name="l00465"></a>00465 <span class="preprocessor">    ########### Start the logic through if elsif elsif ...</span>
<a name="l00466"></a>00466 <span class="preprocessor"></span>    debug(<span class="stringliteral">&quot;browse_lib&quot;</span>, $r-&gt;param(<span class="stringliteral">&quot;$browse_lib&quot;</span>));
<a name="l00467"></a>00467     debug(<span class="stringliteral">&quot;browse_npl_library&quot;</span>, $r-&gt;param(<span class="stringliteral">&quot;browse_npl_library&quot;</span>));
<a name="l00468"></a>00468     debug(<span class="stringliteral">&quot;edit_mysets&quot;</span>, $r-&gt;param(<span class="stringliteral">&quot;edit_mysets&quot;</span>));
<a name="l00469"></a>00469     debug(<span class="stringliteral">&quot;browse_setdefs&quot;</span>, $r-&gt;param(<span class="stringliteral">&quot;browse_setdefs&quot;</span>));
<a name="l00470"></a>00470 <span class="preprocessor">    ##### Asked to browse certain problems</span>
<a name="l00471"></a>00471 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($browse_lib ne <span class="stringliteral">&#39;&#39;</span>) {
<a name="l00472"></a>00472         $browse_which = $browse_lib;
<a name="l00473"></a>00473         $self-&gt;{current_library_set} = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00474"></a>00474         $use_previous_problems = 0; @pg_files = (); ## clear old problems
<a name="l00475"></a>00475     } elsif ($r-&gt;param(<span class="stringliteral">&#39;browse_npl_library&#39;</span>)) {
<a name="l00476"></a>00476         $browse_which = <span class="stringliteral">&#39;browse_npl_library&#39;</span>;
<a name="l00477"></a>00477         $self-&gt;{current_library_set} = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00478"></a>00478         $use_previous_problems = 0; @pg_files = (); ## clear old problems
<a name="l00479"></a>00479     } elsif ($r-&gt;param(<span class="stringliteral">&#39;browse_local&#39;</span>)) {
<a name="l00480"></a>00480         $browse_which = <span class="stringliteral">&#39;browse_local&#39;</span>;
<a name="l00481"></a>00481 <span class="preprocessor">        #$self-&gt;{current_library_set} = &quot;&quot;;</span>
<a name="l00482"></a>00482 <span class="preprocessor"></span>        $use_previous_problems = 0; @pg_files = (); ## clear old problems
<a name="l00483"></a>00483     } elsif ($r-&gt;param(<span class="stringliteral">&#39;edit_mysets&#39;</span>)) {
<a name="l00484"></a>00484         $browse_which = <span class="stringliteral">&#39;edit_mysets&#39;</span>;
<a name="l00485"></a>00485         $self-&gt;{current_library_set} = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00486"></a>00486         $use_previous_problems = 0; @pg_files = (); ## clear old problems
<a name="l00487"></a>00487     } elsif ($r-&gt;param(<span class="stringliteral">&#39;browse_setdefs&#39;</span>)) {
<a name="l00488"></a>00488         $browse_which = <span class="stringliteral">&#39;browse_setdefs&#39;</span>;
<a name="l00489"></a>00489         $self-&gt;{current_library_set} = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00490"></a>00490         $use_previous_problems = 0; @pg_files = (); ## clear old problems
<a name="l00491"></a>00491 
<a name="l00492"></a>00492 <span class="preprocessor">        ##### Change the seed value</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span>
<a name="l00494"></a>00494     } elsif ($r-&gt;param(<span class="stringliteral">&#39;rerandomize&#39;</span>)) {
<a name="l00495"></a>00495         $self-&gt;{problem_seed}= 1+$self-&gt;{problem_seed};
<a name="l00496"></a>00496 <span class="preprocessor">        #$r-&gt;param(&#39;problem_seed&#39;, $problem_seed);</span>
<a name="l00497"></a>00497 <span class="preprocessor"></span>        $self-&gt;addbadmessage(<span class="stringliteral">&#39;Changing the problem seed for display, but there are no problems showing.&#39;</span>) <span class="keywordflow">if</span> $none_shown;
<a name="l00498"></a>00498 
<a name="l00499"></a>00499 <span class="preprocessor">        ##### Clear the display</span>
<a name="l00500"></a>00500 <span class="preprocessor"></span>
<a name="l00501"></a>00501     } elsif ($r-&gt;param(<span class="stringliteral">&#39;cleardisplay&#39;</span>)) {
<a name="l00502"></a>00502         @pg_files = ();
<a name="l00503"></a>00503         $use_previous_problems=0;
<a name="l00504"></a>00504         $self-&gt;addbadmessage(<span class="stringliteral">&#39;The display was already cleared.&#39;</span>) <span class="keywordflow">if</span> $none_shown;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506 <span class="preprocessor">        ##### View problems selected from the local list</span>
<a name="l00507"></a>00507 <span class="preprocessor"></span>
<a name="l00508"></a>00508     } elsif ($r-&gt;param(<span class="stringliteral">&#39;view_local_set&#39;</span>)) {
<a name="l00509"></a>00509 
<a name="l00510"></a>00510         my $set_to_display = $self-&gt;{current_library_set};
<a name="l00511"></a>00511         <span class="keywordflow">if</span> (not defined($set_to_display) or $set_to_display eq SELECT_LOCAL_STRING or $set_to_display eq <span class="stringliteral">&quot;Found no directories containing problems&quot;</span>) {
<a name="l00512"></a>00512             $self-&gt;addbadmessage(<span class="stringliteral">&#39;You need to select a set to view.&#39;</span>);
<a name="l00513"></a>00513         } <span class="keywordflow">else</span> {
<a name="l00514"></a>00514             $set_to_display = <span class="charliteral">&#39;.&#39;</span> <span class="keywordflow">if</span> $set_to_display eq MY_PROBLEMS;
<a name="l00515"></a>00515             $set_to_display = substr($browse_which,7) if $set_to_display eq MAIN_PROBLEMS;
<a name="l00516"></a>00516             @pg_files = list_pg_files($ce-&gt;{courseDirs}-&gt;{templates},
<a name="l00517"></a>00517                 <span class="stringliteral">&quot;$set_to_display&quot;</span>);
<a name="l00518"></a>00518             $use_previous_problems=0;
<a name="l00519"></a>00519         }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 <span class="preprocessor">        ##### View problems selected from the a set in this course</span>
<a name="l00522"></a>00522 <span class="preprocessor"></span>  } elsif ($r-&gt;param(<span class="stringliteral">&#39;edit_mysets_set&#39;</span>)){
<a name="l00523"></a>00523   
<a name="l00524"></a>00524     my $set_to_display = $self-&gt;{current_library_set};
<a name="l00525"></a>00525           debug(<span class="stringliteral">&quot;set_to_display is $set_to_display&quot;</span>);
<a name="l00526"></a>00526           <span class="keywordflow">if</span> (not defined($set_to_display) 
<a name="l00527"></a>00527                 or $set_to_display eq <span class="stringliteral">&quot;Select a Homework Set&quot;</span>
<a name="l00528"></a>00528                 or $set_to_display eq NO_LOCAL_SET_STRING) {
<a name="l00529"></a>00529             $self-&gt;addbadmessage(<span class="stringliteral">&quot;You need to select a set from this course to view.&quot;</span>);
<a name="l00530"></a>00530           } <span class="keywordflow">else</span> {
<a name="l00531"></a>00531 <span class="preprocessor">            # DBFIXME don&#39;t use ID list, use an iterator</span>
<a name="l00532"></a>00532 <span class="preprocessor"></span>            my @problemList = $db-&gt;listGlobalProblems($set_to_display);
<a name="l00533"></a>00533             my $problem;
<a name="l00534"></a>00534             @pg_files=();
<a name="l00535"></a>00535             <span class="keywordflow">for</span> $problem (@problemList) {
<a name="l00536"></a>00536                 my $problemRecord = $db-&gt;getGlobalProblem($set_to_display, $problem); # checked
<a name="l00537"></a>00537                 die <span class="stringliteral">&quot;global $problem for set $set_to_display not found.&quot;</span> unless
<a name="l00538"></a>00538                     $problemRecord;
<a name="l00539"></a>00539                 push @pg_files, $problemRecord-&gt;source_file;
<a name="l00540"></a>00540   
<a name="l00541"></a>00541             }
<a name="l00542"></a>00542             @pg_files = sortByName(undef,@pg_files);
<a name="l00543"></a>00543             $use_previous_problems=0;
<a name="l00544"></a>00544           }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546 <span class="preprocessor">        ##### View from the library database</span>
<a name="l00547"></a>00547 <span class="preprocessor"></span> 
<a name="l00548"></a>00548     } elsif ($r-&gt;param(<span class="stringliteral">&#39;lib_view&#39;</span>)) {
<a name="l00549"></a>00549         @pg_files=();
<a name="l00550"></a>00550         my @dbsearch = <a class="code" href="classWeBWorK_1_1Utils_1_1ListingDB.html#a3caa8853d828a97533f464888257fa7a">WeBWorK::Utils::ListingDB::getSectionListings</a>($r);
<a name="l00551"></a>00551         my ($result, $tolibpath);
<a name="l00552"></a>00552         <span class="keywordflow">for</span> $result (@dbsearch) {
<a name="l00553"></a>00553             $tolibpath = <span class="stringliteral">&quot;Library/$result-&gt;{path}/$result-&gt;{filename}&quot;</span>;
<a name="l00554"></a>00554             
<a name="l00555"></a>00555 <span class="preprocessor">            ## Too clunky!!!!</span>
<a name="l00556"></a>00556 <span class="preprocessor"></span>            push @pg_files, $tolibpath;
<a name="l00557"></a>00557         }
<a name="l00558"></a>00558         $use_previous_problems=0; 
<a name="l00559"></a>00559 
<a name="l00560"></a>00560 <span class="preprocessor">        ##### View a set from a set*.def</span>
<a name="l00561"></a>00561 <span class="preprocessor"></span>
<a name="l00562"></a>00562     } elsif ($r-&gt;param(<span class="stringliteral">&#39;view_setdef_set&#39;</span>)) {
<a name="l00563"></a>00563 
<a name="l00564"></a>00564         my $set_to_display = $self-&gt;{current_library_set};
<a name="l00565"></a>00565         debug(<span class="stringliteral">&quot;set_to_display is $set_to_display&quot;</span>);
<a name="l00566"></a>00566         <span class="keywordflow">if</span> (not defined($set_to_display) 
<a name="l00567"></a>00567                 or $set_to_display eq <span class="stringliteral">&quot;Select a Set Definition File&quot;</span>
<a name="l00568"></a>00568                 or $set_to_display eq NO_LOCAL_SET_STRING) {
<a name="l00569"></a>00569             $self-&gt;addbadmessage(<span class="stringliteral">&quot;You need to select a set definition file to view.&quot;</span>);
<a name="l00570"></a>00570         } <span class="keywordflow">else</span> {
<a name="l00571"></a>00571             @pg_files= $self-&gt;read_set_def($set_to_display);
<a name="l00572"></a>00572         }
<a name="l00573"></a>00573         $use_previous_problems=0; 
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="preprocessor">        ##### Edit the current local homework set</span>
<a name="l00576"></a>00576 <span class="preprocessor"></span>
<a name="l00577"></a>00577     } elsif ($r-&gt;param(<span class="stringliteral">&#39;edit_local&#39;</span>)) { ## Jump to <span class="keyword">set</span> edit page
<a name="l00578"></a>00578 
<a name="l00579"></a>00579         ; # already handled
<a name="l00580"></a>00580 
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 <span class="preprocessor">        ##### Make a new local homework set</span>
<a name="l00583"></a>00583 <span class="preprocessor"></span>
<a name="l00584"></a>00584     } elsif ($r-&gt;param(<span class="stringliteral">&#39;new_local_set&#39;</span>)) {
<a name="l00585"></a>00585         <span class="keywordflow">if</span> ($r-&gt;param(<span class="stringliteral">&#39;new_set_name&#39;</span>) !~ /^[\w .-]*$/) {
<a name="l00586"></a>00586             $self-&gt;addbadmessage(<span class="stringliteral">&quot;The name &quot;</span>.$r-&gt;param(<span class="stringliteral">&#39;new_set_name&#39;</span>).<span class="stringliteral">&quot; is not a valid set name.  Use only letters, digits, -, _, and .&quot;</span>);
<a name="l00587"></a>00587         } <span class="keywordflow">else</span> {
<a name="l00588"></a>00588             my $newSetName = $r-&gt;param(<span class="stringliteral">&#39;new_set_name&#39;</span>);
<a name="l00589"></a>00589 <span class="preprocessor">            # if we want to munge the input set name, do it here</span>
<a name="l00590"></a>00590 <span class="preprocessor"></span>            $newSetName =~ s/\s/_/g;
<a name="l00591"></a>00591             debug(<span class="stringliteral">&quot;local_sets was &quot;</span>, $r-&gt;param(<span class="stringliteral">&#39;local_sets&#39;</span>));
<a name="l00592"></a>00592             $r-&gt;param(<span class="stringliteral">&#39;local_sets&#39;</span>,$newSetName);  ## use of two parameter param
<a name="l00593"></a>00593             debug(<span class="stringliteral">&quot;new value of local_sets is &quot;</span>, $r-&gt;param(<span class="stringliteral">&#39;local_sets&#39;</span>));
<a name="l00594"></a>00594             my $newSetRecord     = $db-&gt;getGlobalSet($newSetName);
<a name="l00595"></a>00595             <span class="keywordflow">if</span> (defined($newSetRecord)) {
<a name="l00596"></a>00596                 $self-&gt;addbadmessage(<span class="stringliteral">&quot;The set name $newSetName is already in use.  </span>
<a name="l00597"></a>00597 <span class="stringliteral">                Pick a different name if you would like to start a new set.&quot;</span>);
<a name="l00598"></a>00598             } <span class="keywordflow">else</span> {            # Do it!
<a name="l00599"></a>00599 <span class="preprocessor">                # DBFIXME use $db-&gt;newGlobalSet</span>
<a name="l00600"></a>00600 <span class="preprocessor"></span>                $newSetRecord = $db-&gt;{<span class="keyword">set</span>}-&gt;{record}-&gt;new();
<a name="l00601"></a>00601                 $newSetRecord-&gt;set_id($newSetName);
<a name="l00602"></a>00602                 $newSetRecord-&gt;set_header(<span class="stringliteral">&quot;defaultHeader&quot;</span>);
<a name="l00603"></a>00603                 $newSetRecord-&gt;hardcopy_header(<span class="stringliteral">&quot;defaultHeader&quot;</span>);
<a name="l00604"></a>00604                 $newSetRecord-&gt;open_date(time()+60*60*24*7); # in one week
<a name="l00605"></a>00605                 $newSetRecord-&gt;due_date(time()+60*60*24*7*2); # in two weeks
<a name="l00606"></a>00606                 $newSetRecord-&gt;answer_date(time()+60*60*24*7*3); # in three weeks
<a name="l00607"></a>00607                 eval {$db-&gt;addGlobalSet($newSetRecord)};
<a name="l00608"></a>00608                 <span class="keywordflow">if</span> ($@) {
<a name="l00609"></a>00609                     $self-&gt;addbadmessage(<span class="stringliteral">&quot;Problem creating set $newSetName&lt;br&gt; $@&quot;</span>);
<a name="l00610"></a>00610                 } <span class="keywordflow">else</span> {
<a name="l00611"></a>00611                     $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Set $newSetName has been created.&quot;</span>);
<a name="l00612"></a>00612                     my $selfassign = $r-&gt;param(<span class="stringliteral">&#39;selfassign&#39;</span>) || <span class="stringliteral">&quot;&quot;</span>;
<a name="l00613"></a>00613                     $selfassign = <span class="stringliteral">&quot;&quot;</span> <span class="keywordflow">if</span>($selfassign =~ /<span class="keyword">false</span>/i); # deal with javascript <span class="keyword">false</span>
<a name="l00614"></a>00614                     <span class="keywordflow">if</span>($selfassign) {
<a name="l00615"></a>00615                         $self-&gt;assignSetToUser($userName, $newSetRecord);
<a name="l00616"></a>00616                         $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Set $newSetName was assigned to $userName.&quot;</span>);
<a name="l00617"></a>00617                     }
<a name="l00618"></a>00618                 }
<a name="l00619"></a>00619             }
<a name="l00620"></a>00620         }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 <span class="preprocessor">        ##### Add selected problems to the current local set</span>
<a name="l00623"></a>00623 <span class="preprocessor"></span>
<a name="l00624"></a>00624     } elsif ($r-&gt;param(<span class="stringliteral">&#39;update&#39;</span>)) {
<a name="l00625"></a>00625       $self-&gt;addgoodmessage(<span class="stringliteral">&quot;the update param exists&quot;</span>);
<a name="l00626"></a>00626 <span class="preprocessor">        ## first handle problems to be added before we hide them</span>
<a name="l00627"></a>00627 <span class="preprocessor"></span>        my($localSet, @selected);
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         my @add_pg_files = grep {(($_-&gt;[1] &amp; ADDED)) != 0 } @{$self-&gt;{past_problems}}; 
<a name="l00630"></a>00630         my @add_selected = map {$_-&gt;[0]} @add_pg_files;
<a name="l00631"></a>00631         
<a name="l00632"></a>00632         my @delete_pg_files = grep {(($_-&gt;[1] &amp; DELETED)) != 0} @{$self-&gt;{past_problems}};
<a name="l00633"></a>00633         my @delete_selected = map {$_-&gt;[0]} @delete_pg_files;
<a name="l00634"></a>00634         
<a name="l00635"></a>00635         my @move_pg_files = grep {(($_-&gt;[1] &amp; MOVED)) != 0} @{$self-&gt;{past_problems}};
<a name="l00636"></a>00636         my @move_selected = map {$_-&gt;[0]} @move_pg_files;
<a name="l00637"></a>00637 
<a name="l00638"></a>00638         my @action_files = grep {$_-&gt;[1] &gt; 0 } @{$self-&gt;{past_problems}};
<a name="l00639"></a>00639 <span class="preprocessor">        # There are now good reasons to do an update without selecting anything.</span>
<a name="l00640"></a>00640 <span class="preprocessor"></span><span class="preprocessor">        #if(scalar(@action_files) == 0) {</span>
<a name="l00641"></a>00641 <span class="preprocessor"></span><span class="preprocessor">        #    $self-&gt;addbadmessage(&#39;Update requested, but no problems were marked.&#39;);</span>
<a name="l00642"></a>00642 <span class="preprocessor"></span><span class="preprocessor">        #}</span>
<a name="l00643"></a>00643 <span class="preprocessor"></span>
<a name="l00644"></a>00644         <span class="keywordflow">if</span> (scalar(@add_selected)&gt;0) {  # <span class="keywordflow">if</span> some are to be added, they need a place to go
<a name="l00645"></a>00645             $localSet = $r-&gt;param(<span class="stringliteral">&#39;myset_sets&#39;</span>);
<a name="l00646"></a>00646             <span class="keywordflow">if</span> (not defined($localSet) or 
<a name="l00647"></a>00647                     $localSet eq SELECT_SET_STRING or 
<a name="l00648"></a>00648                     $localSet eq NO_LOCAL_SET_STRING) {
<a name="l00649"></a>00649                 $self-&gt;addbadmessage(<span class="stringliteral">&#39;You are trying to add problems to something, </span>
<a name="l00650"></a>00650 <span class="stringliteral">                but you did not select a &quot;Target Set&quot; name as a target.&#39;</span>);
<a name="l00651"></a>00651             } <span class="keywordflow">else</span> {
<a name="l00652"></a>00652                 my $newSetRecord  = $db-&gt;getGlobalSet($localSet);
<a name="l00653"></a>00653                 <span class="keywordflow">if</span> (not defined($newSetRecord)) {
<a name="l00654"></a>00654                     $self-&gt;addbadmessage(<span class="stringliteral">&quot;You are trying to add problems to $localSet, </span>
<a name="l00655"></a>00655 <span class="stringliteral">                    but that set does not seem to exist!  I bet you used your \&quot;Back\&quot; button.&quot;</span>);
<a name="l00656"></a>00656                 } <span class="keywordflow">else</span> {
<a name="l00657"></a>00657                     my $addcount = add_selected($self, $db, $localSet);
<a name="l00658"></a>00658                     <span class="keywordflow">if</span>($addcount &gt; 0) {
<a name="l00659"></a>00659                         $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Added $addcount problem&quot;</span>.(($addcount&gt;1)?<span class="charliteral">&#39;s&#39;</span>:<span class="stringliteral">&#39;&#39;</span>).
<a name="l00660"></a>00660                             <span class="stringliteral">&quot; to $localSet.&quot;</span>);
<a name="l00661"></a>00661                     }
<a name="l00662"></a>00662                 }
<a name="l00663"></a>00663             }
<a name="l00664"></a>00664         }
<a name="l00665"></a>00665         <span class="keywordflow">if</span> (scalar(@delete_selected)&gt;0) {   # <span class="keywordflow">if</span> some are to be added, they need a place to go
<a name="l00666"></a>00666             $localSet = $r-&gt;param(<span class="stringliteral">&#39;myset_sets&#39;</span>);
<a name="l00667"></a>00667             <span class="keywordflow">if</span> (not defined($localSet) or 
<a name="l00668"></a>00668                     $localSet eq SELECT_SET_STRING or 
<a name="l00669"></a>00669                     $localSet eq NO_LOCAL_SET_STRING) {
<a name="l00670"></a>00670                 $self-&gt;addbadmessage(<span class="stringliteral">&#39;You are trying to add problems to something, </span>
<a name="l00671"></a>00671 <span class="stringliteral">                but you did not select a &quot;Target Set&quot; name as a target.&#39;</span>);
<a name="l00672"></a>00672             } <span class="keywordflow">else</span> {
<a name="l00673"></a>00673                 my $newSetRecord  = $db-&gt;getGlobalSet($localSet);
<a name="l00674"></a>00674                 <span class="keywordflow">if</span> (not defined($newSetRecord)) {
<a name="l00675"></a>00675                     $self-&gt;addbadmessage(<span class="stringliteral">&quot;You are trying to delete problems to $localSet, </span>
<a name="l00676"></a>00676 <span class="stringliteral">                    but that set does not seem to exist!  I bet you used your \&quot;Back\&quot; button.&quot;</span>);
<a name="l00677"></a>00677                 } <span class="keywordflow">else</span> {
<a name="l00678"></a>00678                     my $deletecount = delete_selected($self, $db, $localSet);
<a name="l00679"></a>00679                     <span class="keywordflow">if</span>($deletecount &gt; 0) {
<a name="l00680"></a>00680                         $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Deleted $deletecount problem&quot;</span>.(($deletecount&gt;1)?<span class="charliteral">&#39;s&#39;</span>:<span class="stringliteral">&#39;&#39;</span>).
<a name="l00681"></a>00681                             <span class="stringliteral">&quot; to $localSet.&quot;</span>);
<a name="l00682"></a>00682                     }
<a name="l00683"></a>00683                 }
<a name="l00684"></a>00684             }
<a name="l00685"></a>00685         }
<a name="l00686"></a>00686         <span class="keywordflow">if</span> (scalar(@move_selected)&gt;0) { # <span class="keywordflow">if</span> some are to be added, they need a place to go
<a name="l00687"></a>00687             $localSet = $r-&gt;param(<span class="stringliteral">&#39;myset_sets&#39;</span>);
<a name="l00688"></a>00688             my $otherSet = $self-&gt;{current_library_set};
<a name="l00689"></a>00689             <span class="keywordflow">if</span> (not defined($localSet) or not defined($otherSet) or
<a name="l00690"></a>00690                     $localSet eq SELECT_SET_STRING or 
<a name="l00691"></a>00691                     $localSet eq NO_LOCAL_SET_STRING) {
<a name="l00692"></a>00692                 $self-&gt;addbadmessage(<span class="stringliteral">&#39;You are trying to add problems to something, </span>
<a name="l00693"></a>00693 <span class="stringliteral">                but you did not select a &quot;Target Set&quot; name as a target.&#39;</span>);
<a name="l00694"></a>00694             } <span class="keywordflow">else</span> {
<a name="l00695"></a>00695                 my $newSetRecord  = $db-&gt;getGlobalSet($localSet);
<a name="l00696"></a>00696                 my $otherNewSetRecord = $db-&gt;getGlobalSet($otherSet);
<a name="l00697"></a>00697                 <span class="keywordflow">if</span> (not defined($newSetRecord) or not defined($otherNewSetRecord)) {
<a name="l00698"></a>00698                     $self-&gt;addbadmessage(<span class="stringliteral">&quot;You are trying to move problems from $otherSet to $localSet, </span>
<a name="l00699"></a>00699 <span class="stringliteral">                    but that set does not seem to exist!  I bet you used your \&quot;Back\&quot; button.&quot;</span>);
<a name="l00700"></a>00700                 } <span class="keywordflow">else</span> {
<a name="l00701"></a>00701                     my $addcount = add_selected($self, $db, $localSet);
<a name="l00702"></a>00702                     my $deletecount = delete_selected($self, $db, $otherSet);
<a name="l00703"></a>00703                     <span class="keywordflow">if</span>($addcount &gt; 0 &amp;&amp; $deletecount &gt; 0) {
<a name="l00704"></a>00704                         $self-&gt;addgoodmessage(<span class="stringliteral">&quot;Moved $addcount problem&quot;</span>.(($addcount&gt;1)?<span class="charliteral">&#39;s&#39;</span>:<span class="stringliteral">&#39;&#39;</span>).
<a name="l00705"></a>00705                             <span class="stringliteral">&quot; from $otherSet to $localSet.&quot;</span>);
<a name="l00706"></a>00706                     }
<a name="l00707"></a>00707                 }
<a name="l00708"></a>00708             }
<a name="l00709"></a>00709         }
<a name="l00710"></a>00710 <span class="preprocessor">        ## now handle problems to be hidden</span>
<a name="l00711"></a>00711 <span class="preprocessor"></span>
<a name="l00712"></a>00712 <span class="preprocessor">        ## only keep the ones which are not hidden</span>
<a name="l00713"></a>00713 <span class="preprocessor"></span>        @pg_files = grep {($_-&gt;[1] &amp; HIDDEN) ==0 } @{$self-&gt;{past_problems}};
<a name="l00714"></a>00714         @pg_files = grep {(($_-&gt;[1] &amp; DELETED)) != 0 } @pg_files;
<a name="l00715"></a>00715         @past_marks = map {$_-&gt;[1]} @pg_files;
<a name="l00716"></a>00716         @pg_files = map {$_-&gt;[0]} @pg_files;
<a name="l00717"></a>00717         @all_past_list = (@all_past_list[0..($first_shown-1)],
<a name="l00718"></a>00718                     @pg_files,
<a name="l00719"></a>00719                     @all_past_list[($last_shown+1)..(scalar(@all_past_list)-1)]);
<a name="l00720"></a>00720         $last_shown = $first_shown+$maxShown -1; debug(<span class="stringliteral">&quot;last_shown 3: &quot;</span>, $last_shown);
<a name="l00721"></a>00721         $last_shown = (scalar(@all_past_list)-1) <span class="keywordflow">if</span>($last_shown&gt;=scalar(@all_past_list)); debug(<span class="stringliteral">&quot;last_shown 4: &quot;</span>, $last_shown);
<a name="l00722"></a>00722         
<a name="l00723"></a>00723 <span class="preprocessor">        #want to reorder in addition to anything else</span>
<a name="l00724"></a>00724 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ($r-&gt;param(<span class="stringliteral">&#39;isReordered&#39;</span>)){
<a name="l00725"></a>00725 <span class="preprocessor">    #this might work, i&#39;m not sure if this is the right ID</span>
<a name="l00726"></a>00726 <span class="preprocessor"></span>      reorderProblems($self, $db, $r-&gt;param(<span class="stringliteral">&#39;myset_sets&#39;</span>), $r);
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     } elsif ($r-&gt;param(<span class="stringliteral">&#39;next_page&#39;</span>)) {
<a name="l00730"></a>00730         $first_shown = $last_shown+1;
<a name="l00731"></a>00731         $last_shown = $first_shown+$maxShown-1; debug(<span class="stringliteral">&quot;last_shown 5: &quot;</span>, $last_shown);
<a name="l00732"></a>00732         $last_shown = (scalar(@all_past_list)-1) <span class="keywordflow">if</span>($last_shown&gt;=scalar(@all_past_list)); debug(<span class="stringliteral">&quot;last_shown 6: &quot;</span>, $last_shown);
<a name="l00733"></a>00733         $self-&gt;addgoodmessage(<span class="stringliteral">&quot;It sees the next_page parameter, last shown is: $last_shown and first shown is: $first_shown&quot;</span>);
<a name="l00734"></a>00734         @past_marks = ();
<a name="l00735"></a>00735     } elsif ($r-&gt;param(<span class="stringliteral">&#39;prev_page&#39;</span>)) {
<a name="l00736"></a>00736         $last_shown = $first_shown-1; 
<a name="l00737"></a>00737         $first_shown = $last_shown - $maxShown+1;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739         $first_shown = 0 <span class="keywordflow">if</span>($first_shown&lt;0);
<a name="l00740"></a>00740         @past_marks = ();
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     } elsif ($r-&gt;param(<span class="stringliteral">&#39;select_all&#39;</span>)) {
<a name="l00743"></a>00743         @past_marks = map {1} @past_marks;
<a name="l00744"></a>00744     } elsif ($r-&gt;param(<span class="stringliteral">&#39;library_basic&#39;</span>)) {
<a name="l00745"></a>00745         $library_basic = 1;
<a name="l00746"></a>00746         <span class="keywordflow">for</span> my $jj (qw(textchapter textsection textbook)) {
<a name="l00747"></a>00747             $r-&gt;param(<span class="stringliteral">&#39;library_&#39;</span>.$jj,<span class="stringliteral">&#39;&#39;</span>);
<a name="l00748"></a>00748         }
<a name="l00749"></a>00749     } elsif ($r-&gt;param(<span class="stringliteral">&#39;library_advanced&#39;</span>)) {
<a name="l00750"></a>00750         $library_basic = 2;
<a name="l00751"></a>00751     } elsif ($r-&gt;param(<span class="stringliteral">&#39;library_reset&#39;</span>)) {
<a name="l00752"></a>00752         <span class="keywordflow">for</span> my $jj (qw(chapters sections subjects textbook keywords)) {
<a name="l00753"></a>00753             $r-&gt;param(<span class="stringliteral">&#39;library_&#39;</span>.$jj,<span class="stringliteral">&#39;&#39;</span>);
<a name="l00754"></a>00754         }
<a name="l00755"></a>00755     } elsif ($r-&gt;param(<span class="stringliteral">&#39;select_none&#39;</span>)) {
<a name="l00756"></a>00756         @past_marks = ();
<a name="l00757"></a>00757     } <span class="keywordflow">else</span> {
<a name="l00758"></a>00758 <span class="preprocessor">        #nothing</span>
<a name="l00759"></a>00759 <span class="preprocessor"></span>    }               ##### end of the <span class="keywordflow">if</span> elsif ...
<a name="l00760"></a>00760 
<a name="l00761"></a>00761   #I<span class="stringliteral">&#39;m worried this will break something</span>
<a name="l00762"></a>00762 <span class="stringliteral">  my $default_set = $self-&gt;{current_myset_set};</span>
<a name="l00763"></a>00763 <span class="stringliteral">      #debug(&quot;set_to_display is $default_set&quot;);</span>
<a name="l00764"></a>00764 <span class="stringliteral">      if (not defined($default_set) </span>
<a name="l00765"></a>00765 <span class="stringliteral">        or $default_set eq &quot;Select a Homework Set&quot;</span>
<a name="l00766"></a>00766 <span class="stringliteral">        or $default_set eq NO_LOCAL_SET_STRING) {</span>
<a name="l00767"></a>00767 <span class="stringliteral">        $self-&gt;addbadmessage(&quot;You need to select a set from this course to view.&quot;);</span>
<a name="l00768"></a>00768 <span class="stringliteral">    } else {</span>
<a name="l00769"></a>00769 <span class="stringliteral">        # DBFIXME don&#39;</span>t use ID list, use an iterator
<a name="l00770"></a>00770         my @problemList = $db-&gt;listGlobalProblems($default_set);
<a name="l00771"></a>00771         my $problem;
<a name="l00772"></a>00772         @myset_files=();
<a name="l00773"></a>00773         <span class="keywordflow">for</span> $problem (@problemList) {
<a name="l00774"></a>00774             my $problemRecord = $db-&gt;getGlobalProblem($default_set, $problem); # checked
<a name="l00775"></a>00775             die <span class="stringliteral">&quot;global $problem for set $default_set not found.&quot;</span> unless
<a name="l00776"></a>00776                 $problemRecord;
<a name="l00777"></a>00777             push @myset_files, $problemRecord-&gt;source_file;
<a name="l00778"></a>00778   
<a name="l00779"></a>00779         }
<a name="l00780"></a>00780 <span class="preprocessor">      #@myset_files = sortByName(undef,@myset_files);</span>
<a name="l00781"></a>00781 <span class="preprocessor"></span>    }
<a name="l00782"></a>00782  
<a name="l00783"></a>00783 <span class="preprocessor">    ############# List of local sets</span>
<a name="l00784"></a>00784 <span class="preprocessor"></span>
<a name="l00785"></a>00785 <span class="preprocessor">    # DBFIXME sorting in database, please!</span>
<a name="l00786"></a>00786 <span class="preprocessor"></span>    my @all_db_sets = $db-&gt;listGlobalSets;
<a name="l00787"></a>00787     @all_db_sets = sortByName(undef, @all_db_sets);
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     <span class="keywordflow">if</span> ($use_previous_problems) {
<a name="l00790"></a>00790         @pg_files = @all_past_list;
<a name="l00791"></a>00791     } <span class="keywordflow">else</span> {
<a name="l00792"></a>00792         $first_shown = 0;
<a name="l00793"></a>00793         $last_shown = scalar(@pg_files)&lt;$maxShown ? scalar(@pg_files) : $maxShown; 
<a name="l00794"></a>00794         $last_shown--;      # to make it an array index
<a name="l00795"></a>00795         @past_marks = ();
<a name="l00796"></a>00796     }
<a name="l00797"></a>00797 <span class="preprocessor">    ############# Now store data in self for retreival by body</span>
<a name="l00798"></a>00798 <span class="preprocessor"></span>    $self-&gt;{first_shown} = $first_shown;
<a name="l00799"></a>00799     $self-&gt;{last_shown} = $last_shown;
<a name="l00800"></a>00800     $self-&gt;{browse_which} = $browse_which;
<a name="l00801"></a>00801     $self-&gt;{gridded} = $gridded;
<a name="l00802"></a>00802 <span class="preprocessor">    #$self-&gt;{problem_seed} = $problem_seed;</span>
<a name="l00803"></a>00803 <span class="preprocessor"></span>    $self-&gt;{pg_files} = \@pg_files;
<a name="l00804"></a>00804     $self-&gt;{myset_files} = \@myset_files;
<a name="l00805"></a>00805     $self-&gt;{past_marks} = \@past_marks;
<a name="l00806"></a>00806     $self-&gt;{all_db_sets} = \@all_db_sets;
<a name="l00807"></a>00807     $self-&gt;{library_basic} = $library_basic;
<a name="l00808"></a>00808     debug(<span class="stringliteral">&quot;past_marks is &quot;</span>, join(<span class="stringliteral">&quot; &quot;</span>, @{$self-&gt;{past_marks}}));
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811 
<a name="l00812"></a>00812 sub title {
<a name="l00813"></a>00813     <span class="keywordflow">return</span> <span class="stringliteral">&quot;Library Browser v2&quot;</span>;
<a name="l00814"></a>00814 }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816 <span class="preprocessor"># hide view options panel since it distracts from SetMaker&#39;s built-in view options</span>
<a name="l00817"></a>00817 <span class="preprocessor"></span>sub options {
<a name="l00818"></a>00818     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00819"></a>00819 }
<a name="l00820"></a>00820 
<a name="l00821"></a>00821 sub head {
<a name="l00822"></a>00822   <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l00823"></a>00823 }
<a name="l00824"></a>00824 
<a name="l00825"></a>00825 sub body {
<a name="l00826"></a>00826     my ($self) = @_;
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     my $r = $self-&gt;r;
<a name="l00829"></a>00829     my $ce = $r-&gt;ce;        # course environment
<a name="l00830"></a>00830     my $db = $r-&gt;db;        # database
<a name="l00831"></a>00831     my $j;          # garden variety counter
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     my $userName = $r-&gt;param(<span class="stringliteral">&#39;user&#39;</span>);
<a name="l00834"></a>00834 
<a name="l00835"></a>00835     my $user = $db-&gt;getUser($userName); # checked
<a name="l00836"></a>00836     die <span class="stringliteral">&quot;record for user $userName (real user) does not exist.&quot;</span>
<a name="l00837"></a>00837         unless defined $user;
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 <span class="preprocessor">    ### Check that this is a professor</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span>    my $authz = $r-&gt;authz;
<a name="l00841"></a>00841     unless ($authz-&gt;hasPermissions($userName, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>)) {
<a name="l00842"></a>00842         print <span class="stringliteral">&quot;User $userName returned &quot;</span> . 
<a name="l00843"></a>00843             $authz-&gt;hasPermissions($user, <span class="stringliteral">&quot;modify_problem_sets&quot;</span>) . 
<a name="l00844"></a>00844     <span class="stringliteral">&quot; for permission&quot;</span>;
<a name="l00845"></a>00845         <span class="keywordflow">return</span>(CGI::div({<span class="keyword">class</span>=&gt;<span class="stringliteral">&#39;ResultsWithError&#39;</span>},
<a name="l00846"></a>00846         CGI::em(<span class="stringliteral">&quot;You are not authorized to access the Instructor tools.&quot;</span>)));
<a name="l00847"></a>00847     }
<a name="l00848"></a>00848 
<a name="l00849"></a>00849     my $showHints = $r-&gt;param(<span class="stringliteral">&#39;showHints&#39;</span>);
<a name="l00850"></a>00850     my $showSolutions = $r-&gt;param(<span class="stringliteral">&#39;showSolutions&#39;</span>);
<a name="l00851"></a>00851     
<a name="l00852"></a>00852 <span class="preprocessor">    ##########  Extract information computed in pre_header_initialize</span>
<a name="l00853"></a>00853 <span class="preprocessor"></span>
<a name="l00854"></a>00854     my $first_shown = $self-&gt;{first_shown};
<a name="l00855"></a>00855     my $last_shown = $self-&gt;{last_shown}; 
<a name="l00856"></a>00856     my $browse_which = $self-&gt;{browse_which};
<a name="l00857"></a>00857     my $gridded = $self-&gt;{gridded};
<a name="l00858"></a>00858     my $problem_seed = $self-&gt;{problem_seed}||1234;
<a name="l00859"></a>00859     my @pg_files = @{$self-&gt;{pg_files}};
<a name="l00860"></a>00860     my @myset_files =@{$self-&gt;{myset_files}};
<a name="l00861"></a>00861     my @all_db_sets = @{$self-&gt;{all_db_sets}};
<a name="l00862"></a>00862 
<a name="l00863"></a>00863   my $displayModePlaceholder;
<a name="l00864"></a>00864     <span class="keywordflow">if</span> (not defined($r-&gt;param(<span class="stringliteral">&#39;mydisplayMode&#39;</span>))){
<a name="l00865"></a>00865       $displayModePlaceholder = <span class="stringliteral">&quot;images&quot;</span>;
<a name="l00866"></a>00866     }
<a name="l00867"></a>00867     <span class="keywordflow">else</span>{
<a name="l00868"></a>00868       $displayModePlaceholder = $r-&gt;param(<span class="stringliteral">&#39;mydisplayMode&#39;</span>);
<a name="l00869"></a>00869     }
<a name="l00870"></a>00870 
<a name="l00871"></a>00871     my @pg_html;
<a name="l00872"></a>00872     <span class="keywordflow">if</span> ($last_shown &gt;= $first_shown) {
<a name="l00873"></a>00873         @pg_html = renderProblems(
<a name="l00874"></a>00874             r=&gt; $r,
<a name="l00875"></a>00875             user =&gt; $user,
<a name="l00876"></a>00876             problem_list =&gt; [@pg_files[$first_shown..$last_shown]],
<a name="l00877"></a>00877             displayMode =&gt; $displayModePlaceholder,
<a name="l00878"></a>00878             showHints =&gt; $showHints,
<a name="l00879"></a>00879             showSolutions =&gt; $showSolutions,
<a name="l00880"></a>00880         );
<a name="l00881"></a>00881     }
<a name="l00882"></a>00882     my @myset_html;
<a name="l00883"></a>00883 
<a name="l00884"></a>00884   @myset_html = renderProblems(
<a name="l00885"></a>00885       r=&gt; $r,
<a name="l00886"></a>00886       user =&gt; $user,
<a name="l00887"></a>00887         problem_list =&gt; [@myset_files],
<a name="l00888"></a>00888         displayMode =&gt; $displayModePlaceholder,
<a name="l00889"></a>00889         showHints =&gt; $showHints,
<a name="l00890"></a>00890         showSolutions =&gt; $showSolutions,
<a name="l00891"></a>00891   );
<a name="l00892"></a>00892 
<a name="l00893"></a>00893     my %isInSet;
<a name="l00894"></a>00894     my $setName = $r-&gt;param(<span class="stringliteral">&quot;myset_sets&quot;</span>);
<a name="l00895"></a>00895     <span class="keywordflow">if</span> ($setName) {
<a name="l00896"></a>00896 <span class="preprocessor">        # DBFIXME where clause, iterator</span>
<a name="l00897"></a>00897 <span class="preprocessor"></span><span class="preprocessor">        # DBFIXME maybe instead of hashing here, query when checking source files?</span>
<a name="l00898"></a>00898 <span class="preprocessor"></span><span class="preprocessor">        # DBFIXME definitely don&#39;t need to be making full record objects</span>
<a name="l00899"></a>00899 <span class="preprocessor"></span><span class="preprocessor">        # DBFIXME SELECT source_file FROM whatever_problem WHERE set_id=? GROUP BY source_file ORDER BY NULL;</span>
<a name="l00900"></a>00900 <span class="preprocessor"></span><span class="preprocessor">        # DBFIXME (and stick result directly into hash)</span>
<a name="l00901"></a>00901 <span class="preprocessor"></span>        <span class="keywordflow">foreach</span> my $problem ($db-&gt;listGlobalProblems($setName)) {
<a name="l00902"></a>00902             my $problemRecord = $db-&gt;getGlobalProblem($setName, $problem);
<a name="l00903"></a>00903             $isInSet{$problemRecord-&gt;source_file} = 1;
<a name="l00904"></a>00904         }
<a name="l00905"></a>00905     }
<a name="l00906"></a>00906     $self-&gt;{isInSet} = \%isInSet;
<a name="l00907"></a>00907   my $jj;
<a name="l00908"></a>00908  
<a name="l00909"></a>00909           
<a name="l00910"></a>00910 <span class="preprocessor">            #some work for the moved controls</span>
<a name="l00911"></a>00911 <span class="preprocessor"></span>                my $list_of_local_sets = $self-&gt;{all_db_sets};
<a name="l00912"></a>00912                 my $have_local_sets = scalar(@$list_of_local_sets);
<a name="l00913"></a>00913                 my $library_selected = $self-&gt;{current_library_set};
<a name="l00914"></a>00914                 my $set_selected = $r-&gt;param(<span class="stringliteral">&#39;local_sets&#39;</span>);
<a name="l00915"></a>00915             
<a name="l00916"></a>00916                 <span class="keywordflow">if</span>($have_local_sets ==0) {
<a name="l00917"></a>00917                     $list_of_local_sets = [NO_LOCAL_SET_STRING];
<a name="l00918"></a>00918                 } elsif (not defined($set_selected) or $set_selected eq <span class="stringliteral">&quot;&quot;</span>
<a name="l00919"></a>00919                     or $set_selected eq SELECT_SET_STRING) {
<a name="l00920"></a>00920                     unshift @{$list_of_local_sets}, SELECT_SET_STRING;
<a name="l00921"></a>00921                     $set_selected = SELECT_SET_STRING;
<a name="l00922"></a>00922                 }
<a name="l00923"></a>00923             
<a name="l00924"></a>00924 <span class="preprocessor">                # Tidy this list up since it is used in two different places</span>
<a name="l00925"></a>00925 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ($list_of_local_sets-&gt;[0] eq SELECT_SET_STRING) {
<a name="l00926"></a>00926                     shift @{$list_of_local_sets};
<a name="l00927"></a>00927                 }
<a name="l00928"></a>00928 
<a name="l00929"></a>00929           print <span class="stringliteral">&#39;&lt;div id=&quot;setmaker_library_box&quot; class=&quot;setmaker_library&quot;&gt;&#39;</span>;
<a name="l00930"></a>00930                   print <span class="stringliteral">&#39;&lt;h1&gt;Library&lt;/h1&gt;&#39;</span>;
<a name="l00931"></a>00931                   print <span class="stringliteral">&#39;&lt;div class=&quot;setSelector&quot;&gt;&#39;</span>;
<a name="l00932"></a>00932                   print <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l00933"></a>00933                   print <span class="stringliteral">&#39;&lt;div id=&quot;setmaker_library_data&quot;&gt;&#39;</span>;
<a name="l00934"></a>00934 <span class="preprocessor">                    #hidden inputs for memeory</span>
<a name="l00935"></a>00935 <span class="preprocessor"></span><span class="preprocessor">                    #remember gridify</span>
<a name="l00936"></a>00936 <span class="preprocessor"></span>                    print CGI::hidden(-<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&#39;pastGridded&#39;</span>, -name=&gt;<span class="stringliteral">&#39;gridify&#39;</span>, -value=&gt;$gridded, -<span class="keyword">override</span>=&gt;1);
<a name="l00937"></a>00937                     print CGI::hidden(-<span class="keywordtype">id</span>=&gt;<span class="stringliteral">&#39;isReordered&#39;</span>, -name=&gt;<span class="stringliteral">&#39;isReordered&#39;</span>, -vale=&gt;0 ,-<span class="keyword">override</span>=&gt;0);
<a name="l00938"></a>00938             print CGI::hidden(-name=&gt;<span class="stringliteral">&#39;browse_which&#39;</span>, -value=&gt;$browse_which,-<span class="keyword">override</span>=&gt;1),
<a name="l00939"></a>00939               CGI::hidden(-name=&gt;<span class="stringliteral">&#39;problem_seed&#39;</span>, -value=&gt;$problem_seed, -<span class="keyword">override</span>=&gt;1);
<a name="l00940"></a>00940             <span class="keywordflow">for</span> ($j = 0 ; $j &lt; scalar(@pg_files) ; $j++) {
<a name="l00941"></a>00941                 print CGI::hidden(-name=&gt;<span class="stringliteral">&quot;all_past_list$j&quot;</span>, -value=&gt;$pg_files[$j],-<span class="keyword">override</span>=&gt;1);
<a name="l00942"></a>00942             }
<a name="l00943"></a>00943             print CGI::hidden(-name=&gt;<span class="stringliteral">&#39;first_shown&#39;</span>, -value=&gt;$first_shown,-<span class="keyword">override</span>=&gt;1);
<a name="l00944"></a>00944             print CGI::hidden(-name=&gt;<span class="stringliteral">&#39;last_shown&#39;</span>, -value=&gt;$last_shown, -<span class="keyword">override</span>=&gt;1);
<a name="l00945"></a>00945           print <span class="stringliteral">&#39;&lt;div id=&quot;setmaker_library_problems&quot; class=&quot;problemList&quot;&gt;&#39;</span>;
<a name="l00946"></a>00946 <span class="preprocessor">            ########## Now print problems</span>
<a name="l00947"></a>00947 <span class="preprocessor"></span>              <span class="keywordflow">for</span> ($jj=0; $jj&lt;scalar(@pg_html); $jj++) { 
<a name="l00948"></a>00948                   $pg_files[$jj] =~ s|^$ce-&gt;{courseDirs}-&gt;{templates}/?||;
<a name="l00949"></a>00949                   $self-&gt;make_data_row($pg_files[$jj+$first_shown], $pg_html[$jj], $jj+1,         $self-&gt;{past_marks}-&gt;[$jj]); 
<a name="l00950"></a>00950               }
<a name="l00951"></a>00951           print <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l00952"></a>00952           print <span class="stringliteral">&#39;&lt;p&gt;&lt;button type=&quot;button&quot; onclick=&quot;increaseLibAcross();&quot;&gt;+&lt;/button&gt;&lt;span id=&quot;libAcross&quot;&gt;4&lt;/span&gt;&lt;button type=&quot;button&quot; onclick=&quot;decreaseLibAcross();&quot;&gt;-&lt;/button&gt;&lt;span&gt; problems across&lt;/span&gt;&lt;/p&gt;&#39;</span>;
<a name="l00953"></a>00953 <span class="preprocessor">            ########## Finish things off</span>
<a name="l00954"></a>00954 <span class="preprocessor"></span>            my ($next_button, $prev_button) = (<span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00955"></a>00955             <span class="keywordflow">if</span> ($first_shown &gt; 0) {
<a name="l00956"></a>00956 <span class="preprocessor">                #$prev_button = CGI::submit(-name=&gt;&quot;prev_page&quot;, -style=&gt;&quot;width:15ex&quot;, -value=&gt;&quot;Previous page&quot;);</span>
<a name="l00957"></a>00957 <span class="preprocessor"></span>                my $urlpath = $r-&gt;urlpath;
<a name="l00958"></a>00958             my $getProblemPath = $self-&gt;systemLink($urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::GetLibrarySetProblems&quot;</span>, courseID =&gt;$urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>)));
<a name="l00959"></a>00959               $prev_button = <span class="stringliteral">&quot;&lt;span&gt;&lt;button type=&#39;button&#39; onclick=&#39;viewProblems(\&quot;prev_page\&quot; ,\&quot;mainform\&quot;, \&quot;&quot;</span>.$getProblemPath.<span class="stringliteral">&quot;\&quot;, \&quot;prev_spinner\&quot;);&#39;&gt;Previous page&lt;/button&gt;&lt;img id=&#39;prev_spinner&#39; style=&#39;display:none;&#39; src=&#39;/webwork2_files/images/ajax-loader-small.gif&#39;&gt;&lt;/img&gt;&lt;/span&gt;&quot;</span>;
<a name="l00960"></a>00960             }
<a name="l00961"></a>00961             <span class="keywordflow">if</span> ((1+$last_shown)&lt;scalar(@pg_files)) {
<a name="l00962"></a>00962 <span class="preprocessor">                #$next_button = CGI::submit(-name=&gt;&quot;next_page&quot;, -style=&gt;&quot;width:15ex&quot;, -value=&gt;&quot;Next page&quot;);</span>
<a name="l00963"></a>00963 <span class="preprocessor"></span>                my $urlpath = $r-&gt;urlpath;
<a name="l00964"></a>00964             my $getProblemPath = $self-&gt;systemLink($urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::GetLibrarySetProblems&quot;</span>, courseID =&gt;$urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>)));
<a name="l00965"></a>00965               $next_button = <span class="stringliteral">&quot;&lt;span&gt;&lt;button type=&#39;button&#39; onclick=&#39;viewProblems(\&quot;next_page\&quot; ,\&quot;mainform\&quot;, \&quot;&quot;</span>.$getProblemPath.<span class="stringliteral">&quot;\&quot;, \&quot;next_spinner\&quot;);&#39;&gt;Next page&lt;/button&gt;&lt;img id=&#39;next_spinner&#39; style=&#39;display:none;&#39; src=&#39;/webwork2_files/images/ajax-loader-small.gif&#39;&gt;&lt;/img&gt;&lt;/span&gt;&quot;</span>;
<a name="l00966"></a>00966             }
<a name="l00967"></a>00967             <span class="keywordflow">if</span> (scalar(@pg_files)&gt;0) {
<a name="l00968"></a>00968               my $urlpath = $r-&gt;urlpath;
<a name="l00969"></a>00969             my $getProblemPath = $self-&gt;systemLink($urlpath-&gt;newFromModule(<span class="stringliteral">&quot;WeBWorK::ContentGenerator::Instructor::SetMaker2&quot;</span>, courseID =&gt;$urlpath-&gt;arg(<span class="stringliteral">&quot;courseID&quot;</span>)));
<a name="l00970"></a>00970                 print CGI::p(($first_shown+1).<span class="stringliteral">&quot;-&quot;</span>.($last_shown+1).<span class="stringliteral">&quot; of &quot;</span>.scalar(@pg_files).<span class="stringliteral">&quot; shown.&quot;</span>, $prev_button, <span class="stringliteral">&quot; &quot;</span>, $next_button,
<a name="l00971"></a>00971                   <span class="stringliteral">&#39;&lt;span&gt;&lt;button type=&quot;button&quot; style=&quot;float:right;&quot; onclick=&quot;saveChanges(\&#39;mainform\&#39;, \&#39;&#39;</span>.$getProblemPath.<span class="charliteral">&#39;\&#39;</span>, \<span class="stringliteral">&#39;save_changes_spinner2\&#39;);&quot;&gt;save changes&lt;/button&gt;&lt;img id=&quot;save_changes_spinner2&quot; style=&quot;display:none;float:right;&quot; src=&quot;/webwork2_files/images/ajax-loader-small.gif&quot;&gt;&lt;/img&gt;&lt;/span&gt;&#39;</span>);
<a name="l00972"></a>00972             }
<a name="l00973"></a>00973 <span class="preprocessor">            #close setmaker_library_data</span>
<a name="l00974"></a>00974 <span class="preprocessor"></span>            print <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l00975"></a>00975 <span class="preprocessor">            #close setmaker_library</span>
<a name="l00976"></a>00976 <span class="preprocessor"></span>          print <span class="stringliteral">&#39;&lt;/div&gt;&#39;</span>;
<a name="l00977"></a>00977     
<a name="l00978"></a>00978 
<a name="l00979"></a>00979     <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;  
<a name="l00980"></a>00980 }
<a name="l00981"></a>00981 
<a name="l00982"></a>00982 =head1 AUTHOR
<a name="l00983"></a>00983 
<a name="l00984"></a>00984 Written by John Jones, jj (at) asu.edu.
<a name="l00985"></a>00985 Edited by David Gage
<a name="l00986"></a>00986 
<a name="l00987"></a>00987 =cut
<a name="l00988"></a>00988 
<a name="l00989"></a>00989 1;
</pre></div></div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:34 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
