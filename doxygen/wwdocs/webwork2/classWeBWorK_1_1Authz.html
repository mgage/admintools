<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>WeBWorK2: WeBWorK::Authz Class Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li class="current"><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="annotated.html"><span>Class&nbsp;List</span></a></li>
      <li><a href="classes.html"><span>Class&nbsp;Index</span></a></li>
      <li><a href="hierarchy.html"><span>Class&nbsp;Hierarchy</span></a></li>
      <li><a href="functions.html"><span>Class&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="classWeBWorK.html">WeBWorK</a>::<a class="el" href="classWeBWorK_1_1Authz.html">Authz</a>
  </div>
</div>
<div class="contents">
<h1>WeBWorK::Authz Class Reference</h1><!-- doxytag: class="WeBWorK::Authz" --><!-- doxytag: inherits="WeBWorK" --><div class="dynheader">
Inheritance diagram for WeBWorK::Authz:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1Authz__inherit__graph.png" border="0" usemap="#WeBWorK_1_1Authz_inherit__map" alt="Inheritance graph"/></div>
<map name="WeBWorK_1_1Authz_inherit__map" id="WeBWorK_1_1Authz_inherit__map">
<area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="27,5,109,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>
<div class="dynheader">
Collaboration diagram for WeBWorK::Authz:</div>
<div class="dynsection">
<div class="center"><img src="classWeBWorK_1_1Authz__coll__graph.png" border="0" usemap="#WeBWorK_1_1Authz_coll__map" alt="Collaboration graph"/></div>
<map name="WeBWorK_1_1Authz_coll__map" id="WeBWorK_1_1Authz_coll__map">
<area shape="rect" href="classWeBWorK.html" title="WeBWorK" alt="" coords="27,5,109,32"/></map>
<center><span class="legend">[<a target="top" href="graph_legend.html">legend</a>]</span></center></div>

<p><a href="classWeBWorK_1_1Authz-members.html">List of all members.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Avaliable Methods</h2></td></tr>
<tr><td colspan="2"><p><a class="anchor" id="amgrp9be22fb8347fa3884856571d2a5f020b"></a> </p>
<br/><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authz.html#a73af02280f612a3fc57e42510f25d04a">hasPermissions</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authz.html#ade695dacc679fe4f43e5af5967c084ff">checkSet</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authz.html#a38e749b37b555a7e0a2cfaf9659aac86">setCachedUser</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authz.html#aa8e748e84844b496f4f4aacd6896d9fb">invalidIPAddress</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">public method&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="classWeBWorK_1_1Authz.html#a7d5889be7ea4270e9bd421594ac39ae0">new</a> ()</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<h2><a class="anchor" id="NAME">
NAME</a></h2>
<p><a class="el" href="classWeBWorK_1_1Authz.html">WeBWorK::Authz</a> - check user permissions.</p>
<h2><a class="anchor" id="SYNOPSIS">
SYNOPSIS</a></h2>
<pre> # create new authorizer -- $r is a <a class="el" href="classWeBWorK_1_1Request.html">WeBWorK::Request</a> object.
 my $authz = new <a class="el" href="classWeBWorK_1_1Authz.html">WeBWorK::Authz</a>($r);</pre><pre> # tell authorizer to cache permission level of user spammy.
 $authz-&gt;setCachedUser("spammy");</pre><pre> # this call will use the cached data.
 if ($authz-&gt;hasPermissions("spammy", "eat_breakfast")) {
 	eat_breakfast();
 }</pre><pre> # this call will not use the cached data, and will cause a database lookup.
 if ($authz-&gt;hasPermissions("hammy", "go_to_bed")) {
 	go_to_bed();
 }</pre><h2><a class="anchor" id="DESCRIPTION">
DESCRIPTION</a></h2>
<p><a class="el" href="classWeBWorK_1_1Authen.html">WeBWorK::Authen</a> determines if a user is authorized to perform a specific activity, based on the user's PermissionLevel record in the <a class="el" href="classWeBWorK.html">WeBWorK</a> database and the contents of the %permissionLevels hash in the course environment.</p>
<h3><a class="anchor" id="Format_of_the_">
%permissionLevels_hash Format of the %permissionLevels hash</a></h3>
<p>%permissionLevels maps text strings describing activities to numeric permission levels. The definitive list of activities is contained in the default version of %permissionLevels, in the file <em>conf/global.conf.dist</em>. </p>
<p>A user is able to engage in an activity if their permission level is greater than or equal to the level associated with the activity. If the level associated with an activity is undefiend, then no user is permitted to perform the activity, regardless of their permission level.</p>
<h2><a class="anchor" id="CONSTRUCTOR">
CONSTRUCTOR</a></h2>
<ul>
<li>
<p class="startli"><a class="anchor" id="item_WeBWorK__Authz__gt_new__r_"></a><b><a class="el" href="classWeBWorK_1_1Authz.html">WeBWorK::Authz</a>-&gt;new($r)</b> </p>
<p class="endli">Creates a new authorizer instance. $r is a <a class="el" href="classWeBWorK_1_1Request.html">WeBWorK::Request</a> object. It must already have its </p>
<div class="fragment"><pre class="fragment">ce
</pre></div><p> and </p>
<div class="fragment"><pre class="fragment">db
</pre></div><p> fields set.  </p>
</li>
</ul>
<h2><a class="anchor" id="METHODS">
METHODS</a></h2>
<ul>
<li>
<p class="startli"><a class="anchor" id="item_setCachedUser__userID_"></a><b>setCachedUser($userID)</b> </p>
<p class="endli">Caches the PermissionLevel of the user $userID in an existing authorizer. If a user's PermissionLevel is cached, it will be used whenever <a class="el" href="classWeBWorK_1_1Authz.html#a73af02280f612a3fc57e42510f25d04a">hasPermissions()</a> is called on the same user. Only one user can be cached at a time. This is used by <a class="el" href="classWeBWorK.html">WeBWorK</a> to cache the "real" user.  </p>
</li>
</ul>
<p>Checks the %permissionLevels hash in the course environment to determine if the user $userID has permission to engage in the activity $activity. If the user's permission level is greater than or equal to the level associated with $activty, a true value is returned. Otherwise, a false value is returned. </p>
<p>If $userID has been cached using the <a class="el" href="classWeBWorK_1_1Authz.html#a38e749b37b555a7e0a2cfaf9659aac86">setCachedUser()</a> call, the cached data is used. Otherwise, the user's PermissionLevel is looked up in the <a class="el" href="classWeBWorK.html">WeBWorK</a> database. </p>
<p>If the user does not have a PermissionLevel record, the permission level record is empty, or the activity does not appear in %permissionLevels, <a class="el" href="classWeBWorK_1_1Authz.html#a73af02280f612a3fc57e42510f25d04a">hasPermissions()</a> assumes that the user does not have permission.</p>
<h2><a class="anchor" id="AUTHOR">
AUTHOR</a></h2>
<p>Written by Dennis Lambe, malsyned at math.rochester.edu. Modified by Sam Hathaway, sh002i at math.rochester.edu. </p>

<p>Definition at line <a class="el" href="Authz_8pm_source.html#l00091">91</a> of file <a class="el" href="Authz_8pm_source.html">Authz.pm</a>.</p>
<hr/><h2>Member Function Documentation</h2>
<a class="anchor" id="ade695dacc679fe4f43e5af5967c084ff"></a><!-- doxytag: member="WeBWorK::Authz::checkSet" ref="ade695dacc679fe4f43e5af5967c084ff" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authz::checkSet </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-checkSet' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-checkSet-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-checkSet-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-checkSet-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in checkSet: 137</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authz.html#ade695dacc679fe4f43e5af5967c084ff">checkSet</a> { 
    my $self = shift;
    my $r = $self-&gt;{r};
    my $ce = $r-&gt;ce;
    my $db = $r-&gt;db;
    my $urlPath = $r-&gt;urlpath;

    my $node_name = $urlPath-&gt;type;

<span class="preprocessor">    # first check to see if we have to worried about set-level access</span>
<span class="preprocessor"></span><span class="preprocessor">    #    restrictions</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> 0 unless (grep {/^$node_name$/} 
             (qw(problem_list problem_detail gateway_quiz
                 proctored_gateway_quiz)));

<span class="preprocessor">    # to check set restrictions we need a set and a user</span>
<span class="preprocessor"></span>    my $setName = $urlPath-&gt;arg(<span class="stringliteral">&quot;setID&quot;</span>);
    my $userName = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
    my $effectiveUserName = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>);

<span class="preprocessor">    # if there is no input userName, then the content generator will </span>
<span class="preprocessor"></span><span class="preprocessor">    #    be forcing a login, so just bail </span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> ( ! $userName || ! $effectiveUserName );

<span class="preprocessor">    # do we have a cached set that we can use?</span>
<span class="preprocessor"></span>    my $set = $self-&gt;{merged_set};

    <span class="keywordflow">if</span> ( $setName =~ /,v(\d+)$/ ) {
        my $verNum = $1;
        $setName =~ s/,v\d+$<span class="comment">//;</span>

        <span class="keywordflow">if</span> ( $set &amp;&amp; $set-&gt;set_id eq $setName &amp;&amp; 
             $set-&gt;user_id eq $effectiveUserName &amp;&amp;
             $set-&gt;version_id eq $verNum ) {
<span class="preprocessor">            # then we can just use this set and skip the rest</span>
<span class="preprocessor"></span>
        } elsif ( $setName eq <span class="stringliteral">&#39;Undefined_Set&#39;</span> and 
              $self-&gt;hasPermissions($userName, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>) ) {
<span class="preprocessor">                # this is the case of previewing a problem</span>
<span class="preprocessor"></span><span class="preprocessor">                #    from a &#39;try it&#39; link</span>
<span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">if</span> ($db-&gt;existsSetVersion($effectiveUserName,$setName,$verNum)) {
                $set = $db-&gt;getMergedSetVersion($effectiveUserName,$setName,$verNum);
            } <span class="keywordflow">else</span> {
                <span class="keywordflow">return</span> <span class="stringliteral">&quot;Requested version ($verNum) of set &quot;</span> .
                    <span class="stringliteral">&quot;&#39;$setName&#39; is not assigned to user &quot;</span> .
                    <span class="stringliteral">&quot;$effectiveUserName.&quot;</span>;
            }
        }
        <span class="keywordflow">if</span> ( ! $set ) {
            <span class="keywordflow">return</span> <span class="stringliteral">&quot;Requested set &#39;$setName&#39; could not be found &quot;</span> .
                <span class="stringliteral">&quot;in the database for user $effectiveUserName.&quot;</span>;
        }
    } <span class="keywordflow">else</span> {

        <span class="keywordflow">if</span> ( $set &amp;&amp; $set-&gt;set_id eq $setName &amp;&amp;
             $set-&gt;user_id eq $effectiveUserName ) {
<span class="preprocessor">            # then we can just use this set, and skip the rest</span>
<span class="preprocessor"></span>
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">if</span> ( $db-&gt;existsUserSet($effectiveUserName,$setName) ) {
                $set = $db-&gt;getMergedSet($effectiveUserName,$setName);
            } elsif ( $setName eq <span class="stringliteral">&#39;Undefined_Set&#39;</span> and 
                $self-&gt;hasPermissions($userName, <span class="stringliteral">&quot;access_instructor_tools&quot;</span>) ) {
<span class="preprocessor">                # this is the weird case of the library</span>
<span class="preprocessor"></span><span class="preprocessor">                #   browser, when we don&#39;t actually have</span>
<span class="preprocessor"></span><span class="preprocessor">                #   a set to look at, but this only happens among</span>
<span class="preprocessor"></span><span class="preprocessor">                #   instructor tool users.</span>
<span class="preprocessor"></span>                <span class="keywordflow">return</span> 0;
            } <span class="keywordflow">else</span> {
                <span class="keywordflow">return</span> <span class="stringliteral">&quot;Requested set &#39;$setName&#39; is not &quot;</span> .
                    <span class="stringliteral">&quot;assigned to user $effectiveUserName.&quot;</span>;
            }
        }
        <span class="keywordflow">if</span> ( ! $set ) {
            <span class="keywordflow">return</span> <span class="stringliteral">&quot;Requested set &#39;$setName&#39; could not be found &quot;</span> .
                <span class="stringliteral">&quot;in the database for user $effectiveUserName.&quot;</span>;
        }
    }
<span class="preprocessor">    # cache the set for future use as needed.  this should probably </span>
<span class="preprocessor"></span><span class="preprocessor">    #    be more sophisticated than this</span>
<span class="preprocessor"></span>    $self-&gt;{merged_set} = $set;

<span class="preprocessor">    # now we know that the set is assigned to the appropriate user; </span>
<span class="preprocessor"></span><span class="preprocessor">    #    check to see if we&#39;re trying to access a set that&#39;s not open</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> ( before($set-&gt;open_date) &amp;&amp; 
         ! $self-&gt;hasPermissions($userName, <span class="stringliteral">&quot;view_unopened_sets&quot;</span>) ) {
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Requested set &#39;$setName&#39; is not yet open.&quot;</span>;
    } 

<span class="preprocessor">    # also check to make sure that the set is visible, or that we&#39;re</span>
<span class="preprocessor"></span><span class="preprocessor">    #    allowed to view hidden sets</span>
<span class="preprocessor"></span><span class="preprocessor">    # (do we need to worry about visible not being set at this point?)</span>
<span class="preprocessor"></span>    my $visible = ( $set &amp;&amp; $set-&gt;visible ne <span class="charliteral">&#39;0&#39;</span> &amp;&amp; 
              $set-&gt;visible ne <span class="charliteral">&#39;1&#39;</span> ) ? 1 : $set-&gt;visible;
    if ( ! $visible &amp;&amp; 
         ! $self-&gt;hasPermissions($userName, <span class="stringliteral">&quot;view_hidden_sets&quot;</span>) ) { 
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Requested set &#39;$setName&#39; is not available yet.&quot;</span>;
    }

<span class="preprocessor">    # check to be sure that gateways are being sent to the correct</span>
<span class="preprocessor"></span><span class="preprocessor">    #    content generator</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (defined($set-&gt;assignment_type) &amp;&amp; 
        $set-&gt;assignment_type =~ /gateway/ &amp;&amp; 
        ($node_name eq <span class="stringliteral">&#39;problem_list&#39;</span> || $node_name eq <span class="stringliteral">&#39;problem_detail&#39;</span>)) {
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Requested set &#39;$setName&#39; is a test/quiz assignment &quot;</span> . 
            <span class="stringliteral">&quot;but the regular homework assignment content &quot;</span> .
            <span class="stringliteral">&quot;generator $node_name was called.  Try re-entering &quot;</span> .
            <span class="stringliteral">&quot;the set from the problem sets listing page.&quot;</span>;
    } elsif ( (! defined($set-&gt;assignment_type) ||
           $set-&gt;assignment_type eq <span class="stringliteral">&#39;homework&#39;</span>) &amp;&amp;
          $node_name =~ /gateway/ ) {
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Requested set &#39;$setName&#39; is a homework assignment &quot;</span> . 
            <span class="stringliteral">&quot;but the gateway/quiz content &quot;</span> .
            <span class="stringliteral">&quot;generator $node_name was called.  Try re-entering &quot;</span> .
            <span class="stringliteral">&quot;the set from the problem sets listing page.&quot;</span>;
    }
        
<span class="preprocessor">    # and check that if we&#39;re entering a proctored assignment that we </span>
<span class="preprocessor"></span><span class="preprocessor">    #    have a valid proctor login; this is necessary to make sure that</span>
<span class="preprocessor"></span><span class="preprocessor">    #    someone doesn&#39;t use the unproctored url path to obtain access</span>
<span class="preprocessor"></span><span class="preprocessor">    #    to a proctored assignment.</span>
<span class="preprocessor"></span>    <span class="keywordflow">if</span> (defined($set-&gt;assignment_type) &amp;&amp; 
        $set-&gt;assignment_type =~ /proctored/ &amp;&amp;
        ! <a class="code" href="classWeBWorK_1_1Authen_1_1Proctor.html">WeBWorK::Authen::Proctor</a>-&gt;new($r,$ce,$db)-&gt;verify() ) {
        <span class="keywordflow">return</span> <span class="stringliteral">&quot;Requested set &#39;$setName&#39; is a proctored test/quiz &quot;</span> .
            <span class="stringliteral">&quot;assignment, but no valid proctor authorization &quot;</span> .
            <span class="stringliteral">&quot;has been obtained.&quot;</span>;
    }

<span class="preprocessor">    # and whether there are ip restrictions that we need to check</span>
<span class="preprocessor"></span>    my $badIP = $self-&gt;invalidIPAddress($set);
    <span class="keywordflow">return</span> $badIP <span class="keywordflow">if</span> $badIP;

    <span class="keywordflow">return</span> 0;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a73af02280f612a3fc57e42510f25d04a"></a><!-- doxytag: member="WeBWorK::Authz::hasPermissions" ref="a73af02280f612a3fc57e42510f25d04a" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authz::hasPermissions </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-hasPermissions' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-hasPermissions-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-hasPermissions-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-hasPermissions-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in hasPermissions: 73</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authz.html#a73af02280f612a3fc57e42510f25d04a">hasPermissions</a> {
    <span class="keywordflow">if</span> (@_ != 3) {
        shift @_; # <span class="keyword">get</span> rid of <span class="keyword">self</span>
        my $nargs = @_;
        croak <span class="stringliteral">&quot;hasPermissions called with $nargs arguments instead of the expected 2: &#39;@_&#39;&quot;</span>
    }
    
    my ($self, $userID, $activity) = @_;
    my $r = $self-&gt;{r};
    my $ce = $r-&gt;ce;
    my $db = $r-&gt;db;
    
<span class="preprocessor">    # this may need to be changed if we get other permission level data sources</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> 0 unless defined $db;
    
<span class="preprocessor">    # this may need to be changed if we want to control what unauthenticated users</span>
<span class="preprocessor"></span><span class="preprocessor">    # can do with the permissions system</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> 0 unless defined $userID and $userID ne <span class="stringliteral">&quot;&quot;</span>;
    
    my $PermissionLevel;
    
    my $cachedUserID = $self-&gt;{userID};
    <span class="keywordflow">if</span> (defined $cachedUserID and $cachedUserID ne <span class="stringliteral">&quot;&quot;</span> and $cachedUserID eq $userID) {
<span class="preprocessor">        # this is the same user -- we can skip the database call</span>
<span class="preprocessor"></span>        $PermissionLevel = $self-&gt;{PermissionLevel};
    } <span class="keywordflow">else</span> {
<span class="preprocessor">        # a different user, or no user was defined before</span>
<span class="preprocessor"></span><span class="preprocessor">        #my $prettyCachedUserID = defined $cachedUserID ? &quot;&#39;$cachedUserID&#39;&quot; : &quot;undefined&quot;;</span>
<span class="preprocessor"></span><span class="preprocessor">        #warn &quot;hasPermissions called with user &#39;$userID&#39;, but cached user is $prettyCachedUserID. Accessing database.\n&quot;;</span>
<span class="preprocessor"></span>        $PermissionLevel = $db-&gt;getPermissionLevel($userID); # checked
    }
    
    my $permission_level;
    
    <span class="keywordflow">if</span> (defined $PermissionLevel) {
        $permission_level = $PermissionLevel-&gt;permission;
    } <span class="keywordflow">else</span> {
<span class="preprocessor">        # uh, oh. this user has no permission level record!</span>
<span class="preprocessor"></span>        warn <span class="stringliteral">&quot;User &#39;$userID&#39; has no PermissionLevel record -- assuming no permission.&quot;</span>;
        <span class="keywordflow">return</span> 0;
    }
    
    unless (defined $permission_level and $permission_level ne <span class="stringliteral">&quot;&quot;</span>) {
        warn <span class="stringliteral">&quot;User &#39;$userID&#39; has empty permission level -- assuming no permission.&quot;</span>;
        <span class="keywordflow">return</span> 0;
    }
    
    my $userRoles = $ce-&gt;{userRoles};
    my $permissionLevels = $ce-&gt;{permissionLevels};
    
    <span class="keywordflow">if</span> (exists $permissionLevels-&gt;{$activity}) {
        my $activity_role = $permissionLevels-&gt;{$activity};
        <span class="keywordflow">if</span> (defined $activity_role) {
            <span class="keywordflow">if</span> (exists $userRoles-&gt;{$activity_role}) {
                my $role_permlevel = $userRoles-&gt;{$activity_role};
                <span class="keywordflow">if</span> (defined $role_permlevel) {
                    <span class="keywordflow">return</span> $permission_level &gt;= $role_permlevel;
                } <span class="keywordflow">else</span> {
                    warn <span class="stringliteral">&quot;Role &#39;$activity_role&#39; has undefined permisison level -- assuming no permission.&quot;</span>;
                    <span class="keywordflow">return</span> 0;
                }
            } <span class="keywordflow">else</span> {
                warn <span class="stringliteral">&quot;Role &#39;$activity_role&#39; for activity &#39;$activity&#39; not found in \%userRoles -- assuming no permission.&quot;</span>;
                <span class="keywordflow">return</span> 0;
            }
        } <span class="keywordflow">else</span> {
            <span class="keywordflow">return</span> 0; # undefiend $activity_role, no one has permission to perform $activity
        }
    } <span class="keywordflow">else</span> {
        warn <span class="stringliteral">&quot;Activity &#39;$activity&#39; not found in \%permissionLevels -- assuming no permission.&quot;</span>;
        <span class="keywordflow">return</span> 0;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="aa8e748e84844b496f4f4aacd6896d9fb"></a><!-- doxytag: member="WeBWorK::Authz::invalidIPAddress" ref="aa8e748e84844b496f4f4aacd6896d9fb" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authz::invalidIPAddress </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-invalidIPAddress' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-invalidIPAddress-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-invalidIPAddress-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-invalidIPAddress-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in invalidIPAddress: 92</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authz.html#aa8e748e84844b496f4f4aacd6896d9fb">invalidIPAddress</a> { 
<span class="preprocessor"># this exists as a separate routine because we need to check multiple</span>
<span class="preprocessor"></span><span class="preprocessor">#    sets in Hardcopy; having this routine to check the set allows us to do</span>
<span class="preprocessor"></span><span class="preprocessor">#    that for all sets individually there.</span>
<span class="preprocessor"></span>
    my $self = shift;
    my $set = shift;

    my $r = $self-&gt;{r};
    my $db = $r-&gt;db;
    my $urlPath = $r-&gt;urlpath;
<span class="preprocessor">#   my $setName = $urlPath-&gt;arg(&quot;setID&quot;);  # not always defined</span>
<span class="preprocessor"></span>    my $setName = $set-&gt;set_id;
    my $userName = $r-&gt;param(<span class="stringliteral">&quot;user&quot;</span>);
    my $effectiveUserName = $r-&gt;param(<span class="stringliteral">&quot;effectiveUser&quot;</span>);

    <span class="keywordflow">return</span> 0 <span class="keywordflow">if</span> ($set-&gt;restrict_ip eq <span class="stringliteral">&#39;&#39;</span> || $set-&gt;restrict_ip eq <span class="stringliteral">&#39;No&#39;</span> ||
             $self-&gt;hasPermissions($userName,<span class="stringliteral">&#39;view_ip_restricted_sets&#39;</span>));

    my $clientIP = <span class="keyword">new</span> Net::IP($r-&gt;connection-&gt;remote_ip);
<span class="preprocessor">    # make sure that we&#39;re using the non-versioned set name</span>
<span class="preprocessor"></span>    $setName =~ s/,v\d+$<span class="comment">//;</span>

    my $restrictType = $set-&gt;restrict_ip;
    my @restrictLocations = $db-&gt;getAllMergedSetLocations($effectiveUserName,$setName);
    my @locationIDs = ( map {$_-&gt;location_id} @restrictLocations );
    my @restrictAddresses = ( map {$db-&gt;listLocationAddresses($_)} @locationIDs );

<span class="preprocessor">    # if there are no addresses in the locations, return an error that</span>
<span class="preprocessor"></span><span class="preprocessor">    #    says this</span>
<span class="preprocessor"></span>    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Client ip address &quot;</span> . $clientIP-&gt;ip() . <span class="stringliteral">&quot; is not allowed to &quot;</span> .
        <span class="stringliteral">&quot;work this assignment, because the assignment has ip address &quot;</span> .
        <span class="stringliteral">&quot;restrictions and there are no allowed locations associated &quot;</span> .
        <span class="stringliteral">&quot;with the restriction.  Contact your professor to have this &quot;</span> .
        <span class="stringliteral">&quot;problem resolved.&quot;</span> <span class="keywordflow">if</span> ( ! @restrictAddresses );

<span class="preprocessor">    # build a set of IP objects to match against</span>
<span class="preprocessor"></span>    my @restrictIPs = ( map {<span class="keyword">new</span> Net::IP($_)} @restrictAddresses );

<span class="preprocessor">    # and check the clientAddress against these: is $clientIP</span>
<span class="preprocessor"></span><span class="preprocessor">    #    in @restrictIPs?</span>
<span class="preprocessor"></span>    my $inRestrict = 0;
    <span class="keywordflow">foreach</span> my $rIP ( @restrictIPs ) {
        <span class="keywordflow">if</span> ($rIP-&gt;overlaps($clientIP) == $IP_B_IN_A_OVERLAP ||
            $rIP-&gt;overlaps($clientIP) == $IP_IDENTICAL) {
            $inRestrict = $rIP-&gt;ip();
            last;
        }
    }

<span class="preprocessor">    # this is slightly complicated by having to check relax_restrict_ip</span>
<span class="preprocessor"></span>    my $badIP = <span class="stringliteral">&#39;&#39;</span>;
    <span class="keywordflow">if</span> ( $restrictType eq <span class="stringliteral">&#39;RestrictTo&#39;</span> &amp;&amp; ! $inRestrict ) {
        $badIP = <span class="stringliteral">&quot;Client ip address &quot;</span> . $clientIP-&gt;ip() . 
            <span class="stringliteral">&quot; is not in the list of addresses from &quot;</span> .
            <span class="stringliteral">&quot;which this assignment may be worked.&quot;</span>;
    } elsif ( $restrictType eq <span class="stringliteral">&#39;DenyFrom&#39;</span> &amp;&amp; $inRestrict ) {
        $badIP = <span class="stringliteral">&quot;Client ip address &quot;</span> . $clientIP-&gt;ip() . 
            <span class="stringliteral">&quot; is in the list of addresses from &quot;</span> .
            <span class="stringliteral">&quot;which this assignment may not be worked.&quot;</span>;     
    } <span class="keywordflow">else</span> {
        <span class="keywordflow">return</span> 0;
    }

<span class="preprocessor">    # if we&#39;re here, we failed the IP check, and so need to consider</span>
<span class="preprocessor"></span><span class="preprocessor">    #    if ip restrictions were relaxed.  the set we were passed in </span>
<span class="preprocessor"></span><span class="preprocessor">    #    is either the merged userset or the merged versioned userset,</span>
<span class="preprocessor"></span><span class="preprocessor">    #    depending on whether the set is versioned or not</span>
<span class="preprocessor"></span>
    my $relaxRestrict = $set-&gt;relax_restrict_ip;
    <span class="keywordflow">return</span> $badIP <span class="keywordflow">if</span> ( $relaxRestrict eq <span class="stringliteral">&#39;No&#39;</span> );

    <span class="keywordflow">if</span> ( $set-&gt;assignment_type =~ /gateway/ ) {
        <span class="keywordflow">if</span> ( $relaxRestrict eq <span class="stringliteral">&#39;AfterAnswerDate&#39;</span> ) {
<span class="preprocessor">            # in this case we need to go and get the userset,</span>
<span class="preprocessor"></span><span class="preprocessor">            #    not the versioned set (which we already have)</span>
<span class="preprocessor"></span><span class="preprocessor">            #    drat!</span>
<span class="preprocessor"></span>            my $userset = $db-&gt;getMergedSet($set-&gt;user_id,$setName);
            <span class="keywordflow">return</span>( ! $userset || before($userset-&gt;answer_date) 
                ? $badIP : 0 );
        } <span class="keywordflow">else</span> {
<span class="preprocessor">            # this is easier; just look at the current answer date</span>
<span class="preprocessor"></span>            <span class="keywordflow">return</span>( before($set-&gt;answer_date) ? $badIP : 0 );
        }
    } <span class="keywordflow">else</span> {
<span class="preprocessor">        # the set isn&#39;t versioned, so assume that $relaxRestrict</span>
<span class="preprocessor"></span><span class="preprocessor">        #    is &#39;AfterAnswerDate&#39;, regardless of what it actually</span>
<span class="preprocessor"></span><span class="preprocessor">        #    is; &#39;AfterVersionAnswerDate&#39; doesn&#39;t make sense in </span>
<span class="preprocessor"></span><span class="preprocessor">        #    this case</span>
<span class="preprocessor"></span>        <span class="keywordflow">return</span>( before($set-&gt;answer_date) ? $badIP : 0 );
    }
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a7d5889be7ea4270e9bd421594ac39ae0"></a><!-- doxytag: member="WeBWorK::Authz::new" ref="a7d5889be7ea4270e9bd421594ac39ae0" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authz::new </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-new' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-new-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-new-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-new-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in new: 10</span>
<span class="preprocessor"></span>sub <span class="keyword">new</span> {
    my ($invocant, $r) = @_;
    my $class = ref($invocant) || $invocant;
    my $self = {
        r =&gt; $r,
    };
    
    bless $self, $class;
    <span class="keywordflow">return</span> $self;
}
</pre></div>  
</div>
 
</div>
</div>
<a class="anchor" id="a38e749b37b555a7e0a2cfaf9659aac86"></a><!-- doxytag: member="WeBWorK::Authz::setCachedUser" ref="a38e749b37b555a7e0a2cfaf9659aac86" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">public method WeBWorK::Authz::setCachedUser </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Undocumented Method  
<div id='codesection-setCachedUser' class='dynheader closed' style='cursor:pointer;' onclick='return toggleVisibility(this)'>
	<img id='codesection-setCachedUser-trigger' src='closed.png' style='display:inline'><b>Code:</b>
</div>
<div id='codesection-setCachedUser-summary' class='dyncontent' style='display:block;font-size:small;'>click to view</div>
<div id='codesection-setCachedUser-content' class='dyncontent' style='display: none;'>
 <div class="fragment"><pre class="fragment"><span class="preprocessor"># Number of lines of code in setCachedUser: 19</span>
<span class="preprocessor"></span>sub <a class="code" href="classWeBWorK_1_1Authz.html#a38e749b37b555a7e0a2cfaf9659aac86">setCachedUser</a> {
    my ($self, $userID) = @_;
    my $r = $self-&gt;{r};
    my $db = $r-&gt;db;
    
    <span class="keyword">delete</span> $self-&gt;{userID};
    <span class="keyword">delete</span> $self-&gt;{PermissionLevel};
    
    <span class="keywordflow">if</span> (defined $userID) {
        $self-&gt;{userID} = $userID;
        my $PermissionLevel = $db-&gt;getPermissionLevel($userID); # checked
        <span class="keywordflow">if</span> (defined $PermissionLevel) {
<span class="preprocessor">            # store permission level record in database to avoid later database calls</span>
<span class="preprocessor"></span>            $self-&gt;{PermissionLevel} = $PermissionLevel;
        }
    } <span class="keywordflow">else</span> {
        warn <span class="stringliteral">&quot;setCachedUser() called with userID undefined.&quot;</span>;
    }
}
</pre></div>  
</div>
 
</div>
</div>
<hr/>The documentation for this class was generated from the following file:<ul>
<li><a class="el" href="Authz_8pm_source.html">Authz.pm</a></li>
</ul>
</div>
<hr class="footer"/><address style="text-align: right;"><small>Generated on Fri Jun 8 22:55:46 2012 for WeBWorK2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
